var __extends=this&&this.__extends||function(){var i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};return function(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}}(),M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,SView,SView,SView,SView,SView,SView,SView,SView,SView,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,SView,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,SView,SView,SView,SView,SView,SView,SView,SView,SView,SView,SView,SView,M3D,M3D,SView,SView,M3D,SView,SView,SView,SView,SView,SView,SView,SView,SView,SView,SView,M3D,M3D,M3D,M3D,M3D,M3D,SView,SView,SView,SView,SView,SView,SView,SView,M3D,M3D,M3D,M3D,M3D,SView,SView,SView,SView,SView,M3D,SView,SView,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,SView,SView,M3D,SView,M3D,SView,SView,SView,M3D,M3D,M3D,SView,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,M3D,SView,SView,SView,SView,SView,SView;!function(r){var e=function(){function e(){this.renderContext=null}return e.prototype.Apply=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this.OnExecute(e[0])},e.prototype.IsFinish=function(){return this.bKeepingFinished},e.prototype.SetFinish=function(e){this.bKeepingFinished=e},e.prototype.OnExecute=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];e[0]instanceof r.SceneNode||(e[0],r.Model)},e.prototype.GetRenderContext=function(){return this.renderContext},e.prototype.SetRenderContext=function(e){this.renderContext=e},e}();r.Action=e}(M3D||(M3D={})),function(i){var e=function(){function e(){this.compareName=null}return e.prototype.onExecute=function(e){this.compareName},e}();i.CompareByName=e;var t=function(r){function e(e){var t=r.call(this)||this;return t.result=[],t.resultModel=[],t.scene=null,t.compare=null,t.compareModel=null,t.scene=e,t}return __extends(e,r),e.prototype.SetCompare=function(e){this.compare=e},e.prototype.SetCompareModel=function(e){this.compareModel=e},e.prototype.Restart=function(){this.result=[],this.resultModel=[]},e.prototype.OnExecute=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=e[0];r instanceof i.SceneNode?null!==this.compare&&this.compare(r,this)&&(this.result.push(r),this.SetFinish(!0)):r instanceof i.Model&&null!==this.compareModel&&this.compareModel(r,this)&&(this.resultModel.push(r),this.SetFinish(!0))},e}(i.Action);i.SearchAction=t}(M3D||(M3D={})),function(i){var e=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.SetActionFun=function(e){this.callback=e},t.prototype.SetActionFunModel=function(e){this.callbackModel=e},t.prototype.SetActionData=function(e){this.pData=e},t.prototype.OnExecute=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=e[0];r instanceof i.SceneNode?null!==this.callback&&void 0!==this.callback&&this.callback(this.pData,e[0]):r instanceof i.Model&&null!==this.callbackModel&&void 0!==this.callbackModel&&this.callbackModel(this.pData,e[0])},t}(i.Action);i.CallBackAction=e}(M3D||(M3D={})),function(r){var e;function t(e,t,r){return e<t?t:r<e?r:e}(e=r.Intersection||(r.Intersection={}))[e.OUTSIDE=0]="OUTSIDE",e[e.INTERSECTS=1]="INTERSECTS",e[e.INSIDE=2]="INSIDE",r.INT_MAX=2147483647,r.PI=3.141592653589793,r.EPSILON=1e-6,r.DEGTORAD=r.PI/180,r.RADTODEG=1/r.DEGTORAD,r.DEGTORAD_2=r.PI/360,r.MIN_NEARCLIP=.01,r.MAX_FOV=160,r.CONVERSION_BUFFER_LENGTH=256,r.MATRIX_CONVERSION_BUFFER_LENGTH=256,r.HALF_PI=.5*r.PI,r.MIN_INT=2147483648,r.MAX_INT=2147483647,r.MIN_UNSIGNED=0,r.MAX_UNSIGNED=4294967295,r.LARGE_EPSILON=5e-5,r.LARGE_VALUE=1e8,r.INFINITY=r.LARGE_VALUE,r.HPOINT_EPSILON=1e-5,r.Equals=function(e,t){return e+r.EPSILON>=t&&e-r.EPSILON<=t},r.Clamp=t,r.Acos=function(e){return r.RADTODEG*Math.acos(t(e,-1,1))},r.Min=function(e,t){return e<t?e:t},r.Max=function(e,t){return t<e?e:t},r.Abs=function(e){return 0<=e?e:-e},r.Tan=function(e){return Math.tan(e*r.DEGTORAD)},r.Asin=function(e){return r.RADTODEG*Math.asin(t(e,-1,1))},r.Atan2=function(e,t){return r.RADTODEG*Math.atan2(e,t)},r.Sin=function(e){return Math.sin(e*r.DEGTORAD)},r.Cos=function(e){return Math.cos(e*r.DEGTORAD)},r.Lerp=function(e,t,r){return e*(1-r)+t*r}}(M3D||(M3D={})),function(m){var t=function(){function e(){this.cameraRay=new m.Ray,this.modelRay=new m.Ray,this.modelMatrix=new m.Matrix3x4,this.intersectPnts=[],this.framePickFrustum=new m.Frustum}return e.prototype.GetCameraRay=function(){return this.cameraRay},e.prototype.GetModelRay=function(){return this.modelRay},e.prototype.SetModelMatrix=function(e){this.modelMatrix=e},e.prototype.GetFramePickFrustum=function(){return this.framePickFrustum},e}();m.RayPickActionData=t;var i=function(){function r(){this.currentShapeType=-1,this.currentGeoType=-1,this.currentColorType=-1,this.pickShapeTyeArray=[],this.pickGeoTyeArray=[];for(var e=0;e<r.PICKTYPENUM;e++)this.pickGeoTyeArray.push(!1);for(e=0;e<r.PICKTYPENUM;e++)this.pickShapeTyeArray.push(!1)}return r.prototype.GetPickShapeType=function(){return this.currentShapeType},r.prototype.GetPickGeoType=function(){return this.currentGeoType},r.prototype.SetPickShapeType=function(e){if(e!==this.currentShapeType){for(var t=this.pickShapeTyeArray.length=0;t<r.PICKTYPENUM;t++)this.pickShapeTyeArray.push(!1);for(t=this.pickGeoTyeArray.length=0;t<r.PICKTYPENUM;t++)this.pickGeoTyeArray.push(!0);e===m.ShapeType.SHAPE_MODEL?(this.pickShapeTyeArray[m.ShapeType.SHAPE_MODEL]=!0,this.pickShapeTyeArray[m.ShapeType.SHAPE_BODY]=!0,this.pickShapeTyeArray[m.ShapeType.SHAPE_FACE]=!0,this.pickShapeTyeArray[m.ShapeType.SHAPE_TRIMESH]=!0,this.pickShapeTyeArray[m.ShapeType.SHAPE_EDGE]=!0,this.pickShapeTyeArray[m.ShapeType.SHAPE_POINT]=!0,this.pickShapeTyeArray[m.ShapeType.SHAPE_IMAGE_MODEL]=!0,this.pickShapeTyeArray[m.ShapeType.SHAPE_LIGHT_DIRECTIONAL]=!0,this.pickShapeTyeArray[m.ShapeType.SHAPE_ANNOTATION_NOTE]=!0,this.pickShapeTyeArray[m.ShapeType.SHAPE_TEXT_NOTE]=!0,this.pickShapeTyeArray[m.ShapeType.SHAPE_VOICE_NOTE]=!0,this.pickShapeTyeArray[m.ShapeType.SHAPE_SEQUENCE_NUMBER_NOTE]=!0,this.pickShapeTyeArray[m.ShapeType.SHAPE_NOTE_BASE]=!0,this.pickShapeTyeArray[m.ShapeType.SHAPE_THREED_GESTURE_NOTE]=!0,this.pickShapeTyeArray[m.ShapeType.SHAPE_COMMON_NOTE]=!0,this.pickShapeTyeArray[m.ShapeType.SHAPE_COMPONENTNAME_NOTE]=!0,this.pickShapeTyeArray[m.ShapeType.CURVE_LINE]=!0,this.pickShapeTyeArray[m.ShapeType.CURVE_NURBSCURVE]=!0,this.pickShapeTyeArray[m.ShapeType.CURVE_PARABOLA]=!0,this.pickShapeTyeArray[m.ShapeType.CURVE_POLYLINE]=!0):e===m.ShapeType.SHAPE_NOTCONTAIN_IMAGEMODEL?(this.pickShapeTyeArray[m.ShapeType.SHAPE_MODEL]=!0,this.pickShapeTyeArray[m.ShapeType.SHAPE_BODY]=!0,this.pickShapeTyeArray[m.ShapeType.SHAPE_FACE]=!0,this.pickShapeTyeArray[m.ShapeType.SHAPE_TRIMESH]=!0,this.pickShapeTyeArray[m.ShapeType.SHAPE_EDGE]=!0,this.pickShapeTyeArray[m.ShapeType.SHAPE_POINT]=!0):e===m.ShapeType.SHAPE_BODY?(this.pickShapeTyeArray[m.ShapeType.SHAPE_MODEL]=!0,this.pickShapeTyeArray[m.ShapeType.SHAPE_BODY]=!0,this.pickShapeTyeArray[m.ShapeType.SHAPE_FACE]=!0,this.pickShapeTyeArray[m.ShapeType.SHAPE_TRIMESH]=!0):e===m.ShapeType.SHAPE_FACE?(this.pickShapeTyeArray[m.ShapeType.SHAPE_MODEL]=!0,this.pickShapeTyeArray[m.ShapeType.SHAPE_BODY]=!0,this.pickShapeTyeArray[m.ShapeType.SHAPE_FACE]=!0,this.pickShapeTyeArray[m.ShapeType.SHAPE_TRIMESH]=!0):e===m.ShapeType.SHAPE_EDGE?(this.pickShapeTyeArray[m.ShapeType.SHAPE_MODEL]=!0,this.pickShapeTyeArray[m.ShapeType.SHAPE_BODY]=!0,this.pickShapeTyeArray[m.ShapeType.SHAPE_FACE]=!0,this.pickShapeTyeArray[m.ShapeType.SHAPE_EDGE]=!0,this.pickShapeTyeArray[m.ShapeType.SHAPE_TRIMESH]=!0,this.pickShapeTyeArray[m.ShapeType.CURVE_REF_POLYLINE]=!0):e===m.ShapeType.SHAPE_POINT?(this.pickShapeTyeArray[m.ShapeType.SHAPE_MODEL]=!0,this.pickShapeTyeArray[m.ShapeType.SHAPE_BODY]=!0,this.pickShapeTyeArray[m.ShapeType.SHAPE_FACE]=!0,this.pickShapeTyeArray[m.ShapeType.SHAPE_EDGE]=!0,this.pickShapeTyeArray[m.ShapeType.SHAPE_POINT]=!0,this.pickShapeTyeArray[m.ShapeType.SHAPE_TRIMESH]=!0):e===m.ShapeType.SHAPE_HANDLE?(this.pickShapeTyeArray[m.ShapeType.SHAPE_AXIS_HANDLE]=!0,this.pickShapeTyeArray[m.ShapeType.SHAPE_ROTATE_HANDLE]=!0,this.pickShapeTyeArray[m.ShapeType.SHAPE_SCALE_HANDLE]=!0):e===m.ShapeType.SHAPE_MEASURE_BASE?(this.pickShapeTyeArray[m.ShapeType.SHAPE_MEASURE_BASE]=!0,this.pickShapeTyeArray[m.ShapeType.SHAPE_MEASURE_DISTANCE]=!0,this.pickShapeTyeArray[m.ShapeType.SHAPE_MEASURE_ANGLE]=!0,this.pickShapeTyeArray[m.ShapeType.SHAPE_MEASURE_PROPERTY]=!0,this.pickShapeTyeArray[m.ShapeType.SHAPE_MEASURE_DIAMETRE]=!0):e===m.ShapeType.SHAPE_ANNOTATION_NOTE?(this.pickShapeTyeArray[m.ShapeType.SHAPE_TEXT_NOTE]=!0,this.pickShapeTyeArray[m.ShapeType.SHAPE_VOICE_NOTE]=!0,this.pickShapeTyeArray[m.ShapeType.SHAPE_SEQUENCE_NUMBER_NOTE]=!0,this.pickShapeTyeArray[m.ShapeType.SHAPE_NOTE_BASE]=!0,this.pickShapeTyeArray[m.ShapeType.SHAPE_THREED_GESTURE_NOTE]=!0,this.pickShapeTyeArray[m.ShapeType.SHAPE_ANNOTATION_NOTE]=!0,this.pickShapeTyeArray[m.ShapeType.SHAPE_COMMON_NOTE]=!0,this.pickShapeTyeArray[m.ShapeType.SHAPE_COMPONENTNAME_NOTE]=!0):e==m.ShapeType.SHAPE_GEOMETRY?(this.pickShapeTyeArray[m.ShapeType.SHAPE_POINT]=!0,this.pickShapeTyeArray[m.ShapeType.CURVE_LINE]=!0,this.pickShapeTyeArray[m.ShapeType.CURVE_POLYLINE]=!0,this.pickShapeTyeArray[m.ShapeType.CURVE_NURBSCURVE]=!0):this.pickShapeTyeArray[e]=!0,this.currentShapeType=e}},r.prototype.SetPickGeoType=function(e){if(e!==this.currentGeoType){for(var t=this.pickGeoTyeArray.length=0;t<r.PICKTYPENUM;t++)this.pickGeoTyeArray.push(!1);if(e===m.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_LINE)this.pickShapeTyeArray[m.ShapeType.SHAPE_MODEL]=!0,this.pickShapeTyeArray[m.ShapeType.SHAPE_BODY]=!0,this.pickShapeTyeArray[m.ShapeType.SHAPE_FACE]=!0,this.pickShapeTyeArray[m.ShapeType.SHAPE_EDGE]=!0,this.pickGeoTyeArray[m.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_LINE]=!0;else if(e===m.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_ELLIPSE)this.pickShapeTyeArray[m.ShapeType.SHAPE_MODEL]=!0,this.pickShapeTyeArray[m.ShapeType.SHAPE_BODY]=!0,this.pickShapeTyeArray[m.ShapeType.SHAPE_FACE]=!0,this.pickShapeTyeArray[m.ShapeType.SHAPE_EDGE]=!0,this.pickGeoTyeArray[m.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_ELLIPSE]=!0;else if(e===m.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_PLANEFACE)this.pickShapeTyeArray[m.ShapeType.SHAPE_FACE]=!0,this.pickGeoTyeArray[m.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_PLANEFACE]=!0;else if(e===m.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_REVOLUTIONFACE_CYLINDERFACE_CONICALFACE)this.pickShapeTyeArray[m.ShapeType.SHAPE_FACE]=!0,this.pickGeoTyeArray[m.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_REVOLUTIONFACE]=!0,this.pickGeoTyeArray[m.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_CYLINDERFACE]=!0,this.pickGeoTyeArray[m.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_CONICALFACE]=!0;else for(t=this.pickGeoTyeArray.length=0;t<r.PICKTYPENUM;t++)this.pickGeoTyeArray.push(!0)}},r.prototype.CanPickShape=function(e){return this.pickShapeTyeArray[e]},r.prototype.CanPickGeo=function(e){return this.pickGeoTyeArray[e]},r.prototype.CanPickColor=function(e){return!0},r.PICKTYPENUM=600,r}();m.PickTypeFilter=i;var e=function(r){function f(e){var t=r.call(this)||this;return t.isPickAll=!1,t.framePickType=1,t.framePickShapesArrary=[],t.pickShapesMap=[],t.multiPickShapesMap=[],t.fRadius=900,t.sceneManager=null,t.state=null,t.pickTypeFilter=new i,t.camera=null,t.m_pickAsGroupIntersectPnts=[],t.SetScene(e),t.Init(),t}return __extends(f,r),f.prototype.AddIntersectPnt=function(e){this.state.intersectPnts.push(e)},f.prototype.UpdataIntersecPnts=function(e){for(var t=0;t<this.state.intersectPnts.length;t++){var r=e.Multiply(this.state.intersectPnts[t]);this.state.intersectPnts[t]=r}},f.prototype.UpdateGroupPickPnts=function(){this.m_pickAsGroupIntersectPnts=this.state.intersectPnts},f.prototype.UpdataModelRay=function(e){this.state.SetModelMatrix(e);var t=this.state.modelMatrix.Inverse();this.state.modelRay=this.state.cameraRay.Transformed(t)},f.prototype.GetNearPickShape=function(){for(var e=this.pickShapesMap.length,t=f.MAXVALUE,r=0,i=0,n=0;n<this.pickShapesMap.length;n++){(l=this.pickShapesMap[n][0])&&console.log("shape Type"+l.GetType()),i=l.GetType()===m.ShapeType.IMAGEMODEL_SHAPE?1:0;for(var o=this.pickShapesMap[n][1],a=o.length,s=0;s<a;s++)this.PointVisiable(o[s])&&(r=this.state.cameraRay.origin.Sub(o[s]).Length()-1e6*i)<t&&(t=r,e=n,this.SetNearestPickPoint(o[s]))}if(e===this.pickShapesMap.length)return null;var l,h=null;if(null===(l=this.pickShapesMap[e][0]))return h;var u=this.pickTypeFilter.GetPickShapeType();if(l.GetType()===m.ShapeType.SHAPE_FACE)if(u===m.ShapeType.SHAPE_FACE)h=l;else if(u===m.ShapeType.SHAPE_BODY){h=l.GetBody()}else if(u===m.ShapeType.SHAPE_MODEL||u==m.ShapeType.IMAGEMODEL_SHAPE){h=l.GetBody().GetModel()}else h=null;else if(l.GetType()==m.ShapeType.SHAPE_EDGE)if(u==m.ShapeType.SHAPE_EDGE)h=l;else if(u==m.ShapeType.SHAPE_MODEL||u==m.ShapeType.SHAPE_NOTCONTAIN_IMAGEMODEL){h=l.GetBody().GetModel()}else h=null;else h=l;return h},f.prototype.GetNearPickPoint=function(e){for(var t=this.pickShapesMap.length,r=f.MAXVALUE,i=0,n=0,o=0;o<this.pickShapesMap.length;o++)for(var a=this.pickShapesMap[o][1],s=a.length,l=0;l<s;l++)this.PointVisiable(a[l])&&(i=this.state.cameraRay.origin.Sub(a[l]).Length())<r&&(r=i,t=o,n=l);var h=new m.Vector3;return t!==this.pickShapesMap.length&&(h=this.pickShapesMap[t][1][n],e.copyFrom(h),!0)},f.prototype.BeginPickAsGroup=function(e){this.state.intersectPnts=[],this.m_pickAsGroupIntersectPnts=[],this.m_pickAsGrroup=!0},f.prototype.EndPickAsGroup=function(e,t){if(this.m_pickAsGrroup=!1,0<this.m_pickAsGroupIntersectPnts.length){var r=[];r.push(e),r.push(this.m_pickAsGroupIntersectPnts),this.pickShapesMap.push(r)}},f.prototype.PointVisiable=function(e){for(var t=!0,r=0,i=this.sceneManager.GetSection().GetPlaneList();r<i.length;r++){var n=i[r].GetEquation();if(n[0]*e.x+n[1]*e.y+n[2]*e.z+n[3]<0)return t=!1}return t},f.prototype.SetRay=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];switch(e.length){case 1:this.SetPoint(e[0]);break;case 2:this.SetPoint(new m.Vector2(e[0],e[1]))}},f.prototype.SetPoint=function(e){this.SetPickAll(!1),this.SetScreentPoint(e);var t=this.GetCamera();this.state.cameraRay=t.GetViewPort().GetScreenRay(e.x,e.y)},f.prototype.Intersect=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];switch(e.length){case 1:if(e[0]instanceof m.BoundingBox)return this.state.modelRay.HitDistance(e[0])!==m.INFINITY;if(e[0]instanceof m.Vector3){var r=this.state.modelRay.Project(e[0]),i=this.GetCamera().GetViewPort(),n=e[0].Clone();r=this.state.modelMatrix.Multiply(r),n=this.state.modelMatrix.Multiply(n);var o=i.WorldToScreenPoint(r),a=i.WorldToScreenPoint(n),s=o.Sub(a).LengthSquared();return this.fRadius>=s}break;case 3:if(e[0].Equals(e[1]))return e[2].copyFrom(e[0]),this.Intersect(e[2]);var l=new m.Ray(e[0],e[1].Sub(e[0])),h=l.ClosestPoint(this.state.modelRay);h.Sub(e[0]).DotProduct(l.direction)<0?h.copyFrom(e[0]):e[1].Sub(h).DotProduct(l.direction)<0&&h.copyFrom(e[1]);r=this.state.modelRay.Project(h),i=this.GetCamera().GetViewPort(),n=h.Clone();r=this.state.modelMatrix.Multiply(r),n=this.state.modelMatrix.Multiply(h);o=i.WorldToScreenPoint(r),a=i.WorldToScreenPoint(n);if(!i.rect.IsInside(a))return!1;s=o.Sub(a).LengthSquared();return this.fRadius>=s&&(e[2].copyFrom(h.Add(this.state.modelRay.direction.Multiply(-.01))),!0)}},f.prototype.IsintersectRayAndTriangle=function(e,t,r,i){return f.ISintersectRayAndTriangle(e,t,r,this.state.modelRay,i)},f.ISintersectRayAndTriangle=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(3===e.length){var r=0,i=0,n=f.v1,o=f.v2;(d=f.v0).copyFromXYZ(e[0][0],e[0][1],e[0][2]),n.copyFromXYZ(e[0][3],e[0][4],e[0][5]),o.copyFromXYZ(e[0][6],e[0][7],e[0][8]),(c=f.dir).copyFrom(e[1].direction);var a=f.E1;n.SubFill(d,a);var s=f.E2;o.SubFill(d,s);var l=f.P;c.CrossProductFill(s,l);var h=a.DotProduct(l),u=f.T;if(0<h?e[1].origin.SubFill(d,u):(d.SubFill(e[1].origin,u),h=-h),h<f.MINVALUE)return e[2].copyFrom(d.AddED(n).AddED(o).MultiplyED(1/3)),!1;if((r=u.DotProduct(l))<0||h<r)return!1;var p=f.Q;return u.CrossProductFill(a,p),(i=c.DotProduct(p))<0||h<r+i?!1:(s.DotProduct(p),S=1/h,r*=S,i*=S,e[2].copyFrom(d.MultiplyED(1-r-i).AddED(n.MultiplyED(r)).AddED(o.MultiplyED(i))),!0)}if(5===e.length){var c;r=void 0,i=void 0;(c=f.dir).copyFrom(e[3].direction);var d=e[0];n=e[1],o=e[2],a=f.E1;n.SubFill(d,a);s=f.E2;o.SubFill(d,s);l=f.P;c.CrossProductFill(s,l);h=a.DotProduct(l),u=f.T;if(0<h?e[3].origin.SubFill(e[0],u):(e[0].SubFill(e[3].origin,u),h=-h),h<f.MINVALUE)return e[4].copyFrom(e[0].Add(e[1]).AddED(e[2]).MultiplyED(1/3)),!1;if((r=(u=f.T).DotProduct(l))<0||h<r)return!1;var S;p=f.Q;return u.CrossProductFill(a,p),(i=c.DotProduct(p))<0||h<r+i?!1:(s.DotProduct(p),S=1/h,r*=S,i*=S,e[4].copyFrom(e[0].Multiply(1-r-i).AddED(e[1].Multiply(r).AddED(e[2].Multiply(i)))),!0)}},f.IsRayHitBox=function(e,t){return e.HitDistance(t)!==m.INFINITY},f.RayIntersectBoxPnt=function(e,t,r){var i=[],n=t.max,o=t.min,a=[];a[0]=n.x,a[1]=n.y,a[2]=n.z,a[3]=o.x,a[4]=n.y,a[5]=n.z,a[6]=o.x,a[7]=o.y,a[8]=n.z,a[9]=n.x,a[10]=o.y,a[11]=n.z,a[12]=n.x,a[13]=o.y,a[14]=o.z,a[15]=n.x,a[16]=n.y,a[17]=o.z,a[18]=o.x,a[19]=n.y,a[20]=o.z,a[21]=o.x,a[22]=o.y,a[23]=o.z;for(var s=new m.Vector3,l=0;l<12;l++)for(var h=0;h<3;h++){var u=3*m.BoundingBox.triIndex()[l][h];s.x=a[u],s.y=a[u+1],s.z=a[u+2],i.push(s)}for(l=r.length=0;l<i.length/3;l++){var p=new m.Vector3;f.ISintersectRayAndTriangle(i[3*l],i[3*l+1],i[3*l+2],e,p)&&r.push(p)}return 0<r.length},f.GetScreenDis=function(e,t,r){var i=-1;if(r){var n=r.GetCamera().GetViewPort(),o=n.WorldToScreenPoint(e),a=n.WorldToScreenPoint(t);i=o.Sub(a).Length()}return i},f.PickFeaturePnt=function(e,t,r){return!1},f.prototype.RayPick=function(e){this.state.intersectPnts.length=0,e.RayPick(this)},f.prototype.SetRadius=function(e){},f.prototype.AddShape=function(e){if(0<this.state.intersectPnts.length){for(var t=[],r=this.state.intersectPnts.length,i=0;i<r;i++){var n=this.state.modelMatrix.Multiply(this.state.intersectPnts[i]);t.push(n)}var o=null;(o=[]).push(e),o.push(t),this.pickShapesMap.push(o),this.state.intersectPnts.length=0}},f.prototype.GetPickShapeType=function(){return this.pickTypeFilter.GetPickShapeType()},f.prototype.GetPickGeoType=function(){return this.pickTypeFilter.GetPickGeoType()},f.prototype.SetPickShapeType=function(e){this.pickTypeFilter.SetPickShapeType(e)},f.prototype.SetPickGeoType=function(e){this.pickTypeFilter.SetPickGeoType(e)},f.prototype.CanPickShape=function(e){return this.pickTypeFilter.CanPickShape(e)},f.prototype.CanPickGeo=function(e){return this.pickTypeFilter.CanPickGeo(e)},f.prototype.CanPickColor=function(e){return this.pickTypeFilter.CanPickColor(e)},f.prototype.SetCamera=function(e){this.camera=e},f.prototype.GetCamera=function(){return this.camera},f.prototype.GetData=function(){return this.state},f.prototype.SetPickRadius=function(e){this.fRadius=e*e},f.prototype.GetScreenDis=function(e,t){var r=this.GetCamera().GetViewPort(),i=r.WorldToScreenPoint(e),n=r.WorldToScreenPoint(t);return i.Sub(n).Length()},f.prototype.OnExecute=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=e[0];r instanceof m.SceneNode?r.RayPick(this):r instanceof m.Model&&r.RayPick(this)},f.prototype.SetScene=function(e){null!==e&&(this.sceneManager=e,this.SetCamera(this.sceneManager.GetCamera()))},f.prototype.GetScene=function(){return this.sceneManager},f.prototype.Init=function(){if(this.state=new t,this.fRadius=900,this.sceneManager){this.GetCamera().GetViewPort().rect.Width(),this.GetCamera().GetViewPort().rect.Height();var e=m.Parameters.Instance().screenPPI;this.fRadius=.1*e*e*.1,600<this.fRadius&&(this.fRadius=600)}f.v0=new m.Vector3,f.v1=new m.Vector3,f.v2=new m.Vector3,f.dir=new m.Vector3,f.E1=new m.Vector3,f.E2=new m.Vector3,f.P=new m.Vector3,f.det=new m.Vector3,f.Q=new m.Vector3,f.T=new m.Vector3},f.prototype.SetFramePickType=function(e){this.framePickType=e},f.prototype.SetPickAll=function(e){this.isPickAll=e,this.isPickAll&&this.SetFramePickType(1)},f.prototype.IsPickAll=function(){return this.isPickAll},f.prototype.SetFramePickSection=function(e,t){this.SetPickAll(!0);var r=new m.Vector2(e.x,t.y),i=new m.Vector2(t.x,e.y),n=this.GetCamera(),o=n.GetViewPort(),a=n.GetNearClip(),s=n.GetFarClip(),l=o.ScreenToWorldPoint(i.x,i.y,a),h=o.ScreenToWorldPoint(t.x,t.y,a),u=o.ScreenToWorldPoint(r.x,r.y,a),p=o.ScreenToWorldPoint(e.x,e.y,a),c=o.ScreenToWorldPoint(i.x,i.y,s),d=o.ScreenToWorldPoint(t.x,t.y,s),S=o.ScreenToWorldPoint(r.x,r.y,s),f=o.ScreenToWorldPoint(e.x,e.y,s);this.GetData().GetFramePickFrustum().Define(l,h,u,p,c,d,S,f)},f.prototype.FramePick=function(e){e.FramePick(this)},f.prototype.FrustumIntersetWithWorldBox=function(e){var t=!1;return e.Defined()&&(1==this.framePickType?this.GetData().framePickFrustum.IsInside(e.Center())===m.INSIDE&&(t=!0):2===this.framePickType&&this.GetData().framePickFrustum.IsInsideFast(e)===m.INSIDE&&(t=!0)),t},f.prototype.AddToFramePickCollection=function(e){e&&this.framePickShapesArrary.push(e)},f.prototype.GetFramePickShapes=function(){return this.framePickShapesArrary},f.prototype.GetScreentPoint=function(){return this.m_screentPoint},f.prototype.SetScreentPoint=function(e){this.m_screentPoint=e},f.prototype.SetInterctType=function(e){this.interctType=e},f.prototype.GetInterctType=function(){return this.interctType},f.prototype.GetUseclipPlane=function(){return this.useclipPlane},f.prototype.SetUseclipPlane=function(e){this.useclipPlane=e},f.prototype.SetNearestPickPoint=function(e){this.nearShapePoint=e},f.prototype.GetNearestPickPoint=function(){return this.nearShapePoint},f.v0=null,f.v1=null,f.v2=null,f.dir=null,f.E1=null,f.E2=null,f.P=null,f.det=null,f.Q=null,f.T=null,f.MINVALUE=Number.MIN_VALUE,f.MAXVALUE=m.MAX_INT,f}(m.Action);m.RayPickAction=e}(M3D||(M3D={})),function(s){var w=function(){function e(){this.bColorMask=!1,this.bDepthMask=!0}return e.prototype.IsColorMask=function(){return this.bColorMask},e.prototype.SetColorMask=function(e){this.bColorMask=e},e.prototype.SetRenderGroupType=function(e){this.renderGroupType=e},e.prototype.GetRenderGroupType=function(){return this.renderGroupType},e}();s.RenderTech=w;var D=function(){function r(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];0===e.length?this.type=r.RGT_SOLID:1===e.length&&(this.type=e[0])}return r.prototype.RenderableType=function(e){this.type=e},r.prototype.GetType=function(){return this.type},r.RGT_EDGELINE=8,r.RGT_TRILINE=2,r.RGT_SOLID=1,r.RGT_BOX=4,r.RGT_TRANSPARENT=16,r.RGT_TRANSLATEEDGE=32,r.RGT_EDGELINEINTOP=64,r.RGT_INTOP=128,r.RGT_PMI=256,r.RGT_POINT=512,r.RGT_NOTE=1024,r.RGT_ANNOTATION=1536,r.RGT_MEASURE=2048,r.RGT_HANDLER=4096,r.RGT_SOLID_TRAN=r.RGT_SOLID|r.RGT_TRANSPARENT,r.RGT_SHADOW=4608,r}();s.RenderableType=D;var i=function(){function e(){this.renderTypes=e.RENDERDATA_NORMALEFFCT}return e.prototype.Contain=function(e){return(this.renderTypes&e)===e},e.prototype.GetRenderTypes=function(){return this.renderTypes},e.prototype.SetRenderTypes=function(e){this.renderTypes=e},e.prototype.Open=function(e){var t=this.GetRenderTypes();this.SetRenderTypes(t|e)},e.prototype.Close=function(e){var t=this.GetRenderTypes();this.SetRenderTypes(t&(65535&e^65535))},e.RENDERDATA_NORMALEFFCT=D.RGT_POINT|D.RGT_SOLID|D.RGT_INTOP|D.RGT_TRANSPARENT|D.RGT_NOTE|D.RGT_MEASURE|D.RGT_HANDLER|D.RGT_EDGELINE,e.RENDERDATA_OPACITYEDGE=D.RGT_SOLID|D.RGT_INTOP|D.RGT_TRANSPARENT|D.RGT_EDGELINE,e.RENDERDATA_SECTION=D.RGT_SOLID|D.RGT_INTOP|D.RGT_TRANSPARENT,e.RENDERDATA_SOLIDEDGE=D.RGT_POINT|D.RGT_SOLID|D.RGT_INTOP|D.RGT_TRANSPARENT|D.RGT_TRILINE,e.RENDERDATA_LINE=D.RGT_POINT|D.RGT_INTOP|D.RGT_TRANSPARENT|D.RGT_TRILINE,e.RENDERDATA_TRIANDSOLID=D.RGT_POINT|D.RGT_SOLID|D.RGT_INTOP|D.RGT_TRANSPARENT|D.RGT_TRILINE,e.RENDERDATA_RENDERTRISOLIDBOX=D.RGT_POINT|D.RGT_SOLID|D.RGT_INTOP|D.RGT_TRANSPARENT|D.RGT_TRILINE|D.RGT_BOX,e}();s.RenderableTypeGroup=i;var n=function(){function e(){this.renderQueueTechs=[]}return e.prototype.GetData=function(){return this.renderQueueTechs},e.prototype.InitialOpacityLineEffect=function(){var e=new w,t=new D(D.RGT_EDGELINE);e.SetRenderGroupType(t);var r=new w,i=new D(D.RGT_TRILINE);r.SetRenderGroupType(i);var n=new w,o=new D(D.RGT_SOLID);n.SetRenderGroupType(o),n.SetColorMask(!0);var a=new w,s=new D(D.RGT_TRANSPARENT);a.SetRenderGroupType(s),n.SetColorMask(!0);var l=new w,h=new D(D.RGT_INTOP);l.SetRenderGroupType(h),n.SetColorMask(!0),this.renderQueueTechs.push(n),this.renderQueueTechs.push(a),this.renderQueueTechs.push(l),this.renderQueueTechs.push(e),this.renderQueueTechs.push(r)},e.prototype.InitialNormalEffect=function(){var e=new w,t=new D(D.RGT_SHADOW);e.SetRenderGroupType(t);var r=new w,i=new D(D.RGT_EDGELINE);r.SetRenderGroupType(i);var n=new w,o=new D(D.RGT_TRILINE);n.SetRenderGroupType(o);var a=new w,s=new D(D.RGT_SOLID);a.SetRenderGroupType(s);var l=new w,h=new D(D.RGT_TRANSPARENT);l.SetRenderGroupType(h);var u=new w,p=new D(D.RGT_INTOP);u.SetRenderGroupType(p);var c=new w,d=new D(D.RGT_EDGELINEINTOP);c.SetRenderGroupType(d);var S=new w,f=new D(D.RGT_PMI);S.SetRenderGroupType(f);var m=new w,y=new D(D.RGT_BOX);m.SetRenderGroupType(y);var T=new w,M=new D(D.RGT_NOTE);T.SetRenderGroupType(M);var g=new w,v=new D(D.RGT_ANNOTATION);g.SetRenderGroupType(v);var C=new w,_=new D(D.RGT_MEASURE);C.SetRenderGroupType(_);var A=new w,E=new D(D.RGT_HANDLER);A.SetRenderGroupType(E);var G=new w,P=new D(D.RGT_POINT);G.SetRenderGroupType(P),this.renderQueueTechs.push(e),this.renderQueueTechs.push(r),this.renderQueueTechs.push(c),this.renderQueueTechs.push(n),this.renderQueueTechs.push(a),this.renderQueueTechs.push(S),this.renderQueueTechs.push(m),this.renderQueueTechs.push(l),this.renderQueueTechs.push(G),this.renderQueueTechs.push(u),this.renderQueueTechs.push(T),this.renderQueueTechs.push(g),this.renderQueueTechs.push(C),this.renderQueueTechs.push(A)},e.prototype.InitialSectionEffect=function(){},e}();s.RenderQueuePriority=n;var e=function(){function r(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this.renderQueuePriority=new n,this.renderableTypeFilter=new i,0===e.length?this.effectType=r.RENDER_NORMALEFFCT:1===e.length&&(this.effectType=e[0])}return r.prototype.GetRenderQueuePriority=function(){return this.renderQueuePriority},r.prototype.SetRenderQueuePriority=function(e){this.renderQueuePriority=e},r.prototype.GetRenderableTypeFilter=function(){return this.renderableTypeFilter},r.prototype.SetRenderableTypeFilter=function(e){this.renderableTypeFilter=e},r.RENDER_NORMALEFFCT=0,r.RENDER_OPACITYEDGE=256,r.RENDER_SECTION=512,r}();s.RenderEffect=e;var o=function(){function e(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this.renderTech=null,this.rednerType=null,this.renderableArray=[],0===e.length||1===e.length&&(this.rednerType=e[0])}return e.prototype.Push=function(e){this.renderableArray.push(e)},e.prototype.Clear=function(){this.renderableArray.length=0},e.prototype.Concat=function(e){this.renderableArray=this.renderableArray.concat(e)},e.prototype.GetType=function(){return this.rednerType},e.prototype.setType=function(e){this.rednerType=e},e.prototype.GetRenderableArray=function(){return this.renderableArray},e.prototype.SetRenderableArray=function(e){this.renderableArray=e},e.prototype.SetRenderTech=function(e){this.renderTech=e},e.prototype.GetRenderTech=function(){return this.renderTech},e}();s.RenderQueue=o;var t=function(i){function a(e){var t=i.call(this)||this;t.clipPlane=new Array(5),t.enableClip=new Array(5),t.pCamera=null,t.renderMgr=null,t.glworldMatrix=new s.Matrix4,t.worldMatrix=new s.Matrix3x4,t.renderEffect=null,t.backgroundColor=null,t.axisNode=null,t.section=null,t.priTypePassGroup=new o,t.delaySolidPassGroup=new o,t.delayTranPassGroup=new o,t.renderQueueGroup=new s.Dictionary,t.draggerRenderQueueGroup=new s.Dictionary,t.workingRenderQueueGroup=new s.Dictionary,t.scene=null,t.delayOnceDrawList=new o,t.m_hudImages=[],t.m_vecPoint=[],t.m_vecLine=[],t.m_vecCurve=[],t.delayDrawOnceCount=0,t.selectBox=new s.BoundingBox,t._currentRenderImageQueueIndex=0,t._renderImageboards=[],t.m_delayDrawFlag=!1,t.m_delayDrawList=[],t.mergeEdgeCache=null,t.m_mergeFaceCache=null,t.InitRenderQueueGroup(t.renderQueueGroup),t.InitRenderQueueGroup(t.draggerRenderQueueGroup),t.SetWorkingRenderQueueGroup(t.renderQueueGroup),t.renderMgr=e,t.shaderManager=null,t.m_bReverseClip=!1;for(var r=0;r<5;r++)t.clipPlane[r]=new s.Vector4,t.enableClip[r]=0;return t.InitRenderEffects(),t.Reset(),t}return __extends(a,i),a.prototype.InitRenderQueueGroup=function(e){var t=null,r=null;t=new D(D.RGT_SHADOW),r=new o(t),e.add(D.RGT_SHADOW,r),t=new D(D.RGT_TRANSPARENT),r=new o(t),e.add(D.RGT_TRANSPARENT,r),t=new D(D.RGT_SOLID),r=new o(t),e.add(D.RGT_SOLID,r),t=new D(D.RGT_INTOP),r=new o(t),e.add(D.RGT_INTOP,r),t=new D(D.RGT_EDGELINE),r=new o(t),e.add(D.RGT_EDGELINE,r),t=new D(D.RGT_TRILINE),r=new o(t),e.add(D.RGT_TRILINE,r),t=new D(D.RGT_EDGELINEINTOP),r=new o(t),e.add(D.RGT_EDGELINEINTOP,r),t=new D(D.RGT_PMI),r=new o(t),e.add(D.RGT_PMI,r),t=new D(D.RGT_BOX),r=new o(t),e.add(D.RGT_BOX,r),t=new D(D.RGT_NOTE),r=new o(t),e.add(D.RGT_NOTE,r),t=new D(D.RGT_ANNOTATION),r=new o(t),e.add(D.RGT_ANNOTATION,r),t=new D(D.RGT_MEASURE),r=new o(t),e.add(D.RGT_MEASURE,r),t=new D(D.RGT_HANDLER),r=new o(t),e.add(D.RGT_HANDLER,r),t=new D(D.RGT_POINT),r=new o(t),e.add(D.RGT_POINT,r)},a.prototype.Reset=function(){this.priTypeCache=-1,this.minfps=15,this.fps=this.minfps,this.delayDrawFlag=!1,this.delayDrawOnceCount=0},a.prototype.Apply=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];1==e.length&&i.prototype.OnExecute.call(this,e[0])},a.prototype.GetRenderManager=function(){return this.renderMgr},a.prototype.Begin=function(){this.GetRenderImageBoards().length=0,this.renderQueueGroup.forEach(function(e,t){t.Clear()}),this.draggerRenderQueueGroup.forEach(function(e,t){t.Clear()}),this.SetAxisNode(null),this.SetBackGroundNode(null),this.ClearRenderBox(),this.SetHandlerGroupNode(null),this.SetWorkingRenderQueueGroup(this.renderQueueGroup),this.BeginPrepareDelayDraw(),this.currentRenderImageQueueIndex=0,this.m_hudImages.length=0},a.prototype.Execute=function(){s.GLShapeDrawer.InitialGL(this),s.Parameters.Instance().m_BackTransparent||s.GLShapeDrawer.DrawBackGround(this.GetBackGroundNode(),this),s.GLShapeDrawer.DrawRenderPassGroup(this),this.ProcessDelayDraw(),s.GLShapeDrawer.DrawAxis(this.GetAxisNode(),this)},a.prototype.AddFaceToDrawQueue=function(e){var t=this.GetRenderEffect().GetRenderableTypeFilter();e.SetRenderWorldMatrix(this.GetGLWorldMatrix()),t.Contain(D.RGT_SOLID)&&(this.delayDrawFlag?this.AddToDelayDraw(e):this.PrepareFaceMesh(e))},a.prototype.AddToDelayDraw=function(e){this.m_delayDrawList.push(e)},a.prototype.End=function(){this.SetSceneBoxChanged(!1)},a.prototype.UpdataRenderPara=function(e){},a.prototype.PushRenderable=function(e,t){if(this.priTypeCache!==t){var r=this.workingRenderQueueGroup.get(t);void 0!==r&&(r.Push(e),this.priTypeCache=t,this.priTypePassGroup=r)}else this.priTypePassGroup.Push(e)},a.prototype.ShowRotationCenter=function(){return!0},a.prototype.GetRenderEffect=function(){return this.renderEffect},a.prototype.SetRenderEffect=function(e){this.renderEffect=e},a.prototype.SetWorldMatrix=function(e){this.worldMatrix=e},a.prototype.GetWorldMatrix=function(){return this.worldMatrix},a.prototype.SetGLWorldMatrix=function(e){this.glworldMatrix=e},a.prototype.GetGLWorldMatrix=function(){return this.glworldMatrix},a.prototype.Merge=function(e){var t=!1,r=e.GetDrawColor();return e.IsVisible()?(null!==this.mergeEdgeCache&&r.Equals(this.mergeEdgeCache.GetDrawColor())?(this.mergeEdgeCache.MergeRenderPolyLine(e),t=!0):(this.mergeEdgeCache=e,this.mergeEdgeCache.SetRenderPolyLine(e)),t):!(this.mergeEdgeCache=null)},a.prototype.MergeFace=function(e){var t=!1,r=e.GetDrawColor();if(!e.IsVisible())return t=!(this.m_mergeFaceCache=null);if(null===this.m_mergeFaceCache||!r.Equals(this.m_mergeFaceCache.GetRenderColor())||e.IsSelected()!==this.m_mergeFaceCache.IsSelected()||e.GetBody().GetFaces().lastIndexOf(e)<=e.GetBody().GetFaces().length-1){if(e.GetRenderMeshData()){var i=(this.m_mergeFaceCache=e).GetRenderMeshData().GetRefMesh();i.IsDirty()&&i.UpdateHardWareBuffer(this),this.m_mergeFaceCache.SetRenderMesh(e.GetRenderMeshData())}}else this.m_mergeFaceCache.MergeRenderMesh(e.GetMesh()),t=!0;return t},a.prototype.PrepareRenderEdges=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(e[0]instanceof s.Body)e[0];else if(e[0]instanceof s.Face)e[0];else if(e[0]instanceof s.Edge){var r=e[0];if(this.Merge(r))return;r.SetRenderWorldMatrix(this.GetGLWorldMatrix()),this.PushRenderable(r,D.RGT_EDGELINE)}},a.prototype.PrepareRenderFace=function(e){this.ISFaceHasDrawData(e)?this.MergeFace(e)&&e.SetRenderMeshData(null):e.SetRenderMeshData(null)},a.prototype.PrepareRenderPMIS=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(e[0]instanceof s.Model);else if(e[0]instanceof s.Map)for(var r=0,i=e[0].Values();r<i.length;r++){i[r].FindVisiableObject(this)}},a.prototype.PrepareRenderBox=function(e){e.GetWorldBoundingBox().Defined()&&this.MergeRenderBox(e.GetWorldBoundingBox())},a.prototype.PrepareRenderAnnotation=function(e){this.PushRenderable(e,D.RGT_ANNOTATION)},a.prototype.PushSolidToDelayRenderQueue=function(e){this.delaySolidPassGroup.Push(e)},a.prototype.PushTranToDelayRenderQueue=function(e){this.delayTranPassGroup.Push(e)},a.prototype.ProcessOnceDelayDraw=function(e){var t=!1,r=e.GetRenderableArray();if(0<r.length){if(0==this.delayDrawOnceCount&&(this.delayDrawOnceCount=r.length),this.delayOnceDrawList.Clear(),r.length>this.delayDrawOnceCount){this.delayOnceDrawList.Clear();var i=r.splice(r.length-this.delayDrawOnceCount);this.delayOnceDrawList.Concat(i)}else{this.delayOnceDrawList.Clear();i=r.splice(0);this.delayOnceDrawList.Concat(i)}s.GLShapeDrawer.ApplyCamera(this),s.GLShapeDrawer.DrawSolidRenderPassGroup(this,this.delayOnceDrawList),t=!0}return t},a.prototype.PrepareRenderNote=function(e){this.PushRenderable(e,D.RGT_NOTE)},a.prototype.PrepareRenderImage=function(e){var t=this.currentRenderImageQueueIndex;0===t?this._renderImageboards.push(e):2===t&&this.m_hudImages.push(e)},a.prototype.PreapareRenderPoint=function(e){this.PushRenderable(e,D.RGT_POINT),e&&this.m_vecPoint.push(e)},a.prototype.PrepareRenderMeasure=function(e){},a.prototype.StartMergeFace=function(){this.m_mergeFaceCache=null},a.prototype.FinishMergeFace=function(){},a.prototype.StartMergeEdge=function(){this.mergeEdgeCache=null},a.prototype.FinishMergeEdge=function(){},a.prototype.GetSceneBoxChanged=function(){return this.isSceneBoxChanged},a.prototype.GetCamera=function(){return this.pCamera},a.prototype.SetCamera=function(e){this.pCamera=e},a.prototype.GetLights=function(){return null},a.prototype.AddLight=function(e){},a.prototype.Optimize=function(){var e=this.GetRenderManager().GetEventFPS();e<10?this.GetRenderManager().GetCullerHelper().AddCullerRatio(e):20<e&&this.GetRenderManager().GetCullerHelper().ReduceCullerRatio(e)},a.prototype.SetLights=function(e){},a.prototype.ClearRenderBox=function(){this.selectBox.Clear()},a.prototype.MergeRenderBox=function(e){e.Defined()&&this.selectBox.Merge(e)},a.prototype.GetRenderBox=function(){return this.selectBox},a.prototype.SetBackGroundNode=function(e){this.backgroundColor=e},a.prototype.GetBackGroundNode=function(){return this.backgroundColor},a.prototype.SetFPSNode=function(e){},a.prototype.SetAxisNode=function(e){this.axisNode=e},a.prototype.GetAxisNode=function(){return this.axisNode},a.prototype.GetCullerHelper=function(){return this.renderMgr.GetCullerHelper()},a.prototype.GetRenderQueueGroup=function(){return this.renderQueueGroup},a.prototype.SetFPS=function(e){this.fps=e},a.prototype.GetFPS=function(){return this.fps},a.prototype.SetScene=function(e){this.scene=e},a.prototype.GetScene=function(){return this.scene},a.prototype.GetShaderMananger=function(){return null===this.shaderManager&&(this.shaderManager=new s.ShaderManager(this.GetRenderContext().GetGLRenderContext()),this.shaderManager.SetCurrentAction(this)),this.shaderManager},a.prototype.ClearGLResource=function(){},a.prototype.ResizeFBOs=function(e,t){},a.prototype.ClearDelayDraw=function(){this.delaySolidPassGroup.Clear(),this.delayTranPassGroup.Clear()},a.prototype.SetDelayDraw=function(e){this.delayDrawFlag=e},a.prototype.IsDelayDraw=function(){return this.delayDrawFlag},a.prototype.ProcessDelayDraw=function(){var e=!1;return e=(e=e||this.ProcessOnceDelayDraw(this.delaySolidPassGroup))||this.ProcessOnceDelayDraw(this.delayTranPassGroup)},a.prototype.BeginPrepareDelayDraw=function(){this.delaySolidPassGroup.Clear(),this.delayTranPassGroup.Clear(),this.delayDrawOnceCount=0},a.prototype.ISFaceHasDrawData=function(e){var t=e.GetMesh();return null!==t&&(e.SetRenderMeshData(t),!0)},a.prototype.PrepareFaceMesh=function(e){e.RecesiveShadow()&&this.PushRenderable(e,D.RGT_SHADOW);var t=!1;if(e.GetMaterial()){var r=e.GetMaterial();if(r.GetMaterialType()===s.MaterialType.MaterialType_Phong||r.GetMaterialType()===s.MaterialType.MaterialType_MatCap){e.GetColorAlpha()<1&&(this.PushRenderable(e,D.RGT_TRANSPARENT),t=!0)}else if(r.GetMaterialType()===s.MaterialType.MaterialType_Pbr){e.GetColorAlpha()<1&&(this.PushRenderable(e,D.RGT_TRANSPARENT),t=!0)}}else e.GetDrawColor().IsTransparent()&&(this.PushRenderable(e,D.RGT_TRANSPARENT),t=!0);t||this.PushRenderable(e,D.RGT_SOLID),!s.Parameters.Instance().IsShowBox&&e.IsHightlight()&&this.PushRenderable(e,D.RGT_INTOP)},a.prototype.PrepareFaceDelayDraw=function(e){e.GetDrawColor().IsTransparent()?this.delayTranPassGroup.Push(e):this.delaySolidPassGroup.Push(e)},a.prototype.FacePrepareLineMesh=function(e){this.PushRenderable(e,D.RGT_TRILINE)},a.prototype.FacePrepareEdgeLine=function(e){},a.prototype.PrepareRenderInTop=function(e){},a.prototype.GetSection=function(){return this.section},a.prototype.SetSection=function(e){this.section=e},a.prototype.GetWorkingRenderQueueGroup=function(){return this.workingRenderQueueGroup},a.prototype.SetWorkingRenderQueueGroup=function(e){this.priTypeCache=0,this.workingRenderQueueGroup=e},a.prototype.GetDraggerRenderQueueGroup=function(){return this.draggerRenderQueueGroup},a.prototype.SetHandlerGroupNode=function(e){this.handlerGroupNode=e},a.prototype.PrepareRenderSection=function(e){this.SetSection(e)},a.prototype.InitRenderEffects=function(){var e=a.light=new s.Light,t=new s.Color(1,1,1,1),r=new s.Color(1,1,1,1),i=new s.Color(0,0,0,1),n=new s.Vector4(0,0,10,0),o=(new s.Vector3(0,0,-1),new s.Color(.01,.1,.01,1));e.SetAmbient(t),e.SetDiffuse(r),e.SetSpecular(i),e.SetPosition(n),e.SetLightModelAmbient(o),e.SetSpecularIntensity(1),e.TurnOn()},a.prototype.SetSceneBoxChanged=function(e){this.isSceneBoxChanged=e},a.prototype.ReleaseRenderEffects=function(){},a.prototype.GetRenderImageBoards=function(){return this._renderImageboards},Object.defineProperty(a.prototype,"currentRenderImageQueueIndex",{get:function(){return this._currentRenderImageQueueIndex},set:function(e){this._currentRenderImageQueueIndex=e},enumerable:!0,configurable:!0}),a.prototype.GetHudImages=function(){return this.m_hudImages},a.prototype.SetHudImages=function(e){this.m_hudImages=e},a.prototype.GetPoints=function(){return this.m_vecPoint},a.prototype.GetLinePoints=function(){return this.m_vecLine},a.prototype.GetCurvePoints=function(){return this.m_vecCurve},a.prototype.ClearPreapareRenderPoint=function(){this.m_vecPoint.length=0},a.prototype.ClearPreapareRenderLine=function(){this.m_vecLine.length=0},a.prototype.PrepareRenderLine=function(e){e&&this.m_vecLine.push(e)},a.prototype.ClearPreapareCurve=function(){this.m_vecCurve.length=0},a.prototype.PrepareRenderCurve=function(e){e&&this.m_vecCurve.push(e)},a}(s.Action);s.RenderAction=t}(M3D||(M3D={})),function(e){var t=function(){};e.function_buffer=t;var r=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.callback=null,e}return __extends(e,t),e.prototype.SetActionFun=function(e){this.callback=e},e.prototype.OnExecute=function(e,t,r,i,n){void 0===e&&(e=null),void 0===t&&(t=null),void 0===r&&(r=null),void 0===i&&(i=null),void 0===n&&(n=null)},e}(e.Action);e.AniCallbackFun=r}(M3D||(M3D={})),function(e){var t,r,i;e.INTERPOLATOR_PIVOT="Pivot",e.INTERPOLATOR_POS="Pos",e.INTERPOLATOR_QUATROT="QuatRot",e.INTERPOLATOR_SCALE="Scale",e.INTERPOLATOR_VISIBLE="Visible",e.INTERPOLATOR_COLOR="Color",e.INTERPOLATOR_ATTSWITCH="AttSwitch",e.INTERPOLATOR_SOUND="Sound",e.INTERPOLATOR_IMAGE="Image",e.INTERPOLATOR_NORMAL="Normal",e.TARGETOBJECTTYPE_INS="PLCID",e.TARGETOBJECTTYPE_CAM="CAMERA",e.TARGETOBJECTTYPE_PMI="PMI",e.TARGETOBJECTTYPE_CLIP="CLIP",e.TARGETOBJECTTYPE_SOUND="SOUND",e.TARGETOBJECTTYPE_IMAGE="IMAGE",e.TARGETOBJECTTYPE_FOLDER="FOLDER",e.TARGETOBJECTTYPE_ZOOM="ZOOM",e.TARGETOBJECTTYPE_GROUP="GROUPID",e.TARGETOBJECTTYPE_ARROW="ARROW",e.ANIMATION_D_TOL=.9,e.ANIMATION_D_TOL2=1e-5,(t=e.HANIRotationType||(e.HANIRotationType={}))[t.HANIAxisRotation=0]="HANIAxisRotation",t[t.HANIQuatSlerpRotation=1]="HANIQuatSlerpRotation",t[t.HANIQuatSquadRotation=2]="HANIQuatSquadRotation",t[t.HANIEulerRotation=3]="HANIEulerRotation",(r=e.HANIKeyframeType||(e.HANIKeyframeType={}))[r.HANIChannel=0]="HANIChannel",r[r.HANIRotation=1]="HANIRotation",r[r.HANIString=2]="HANIString",r[r.HANI3String=3]="HANI3String",(i=e.TargetObjectType||(e.TargetObjectType={}))[i.TARGETOBJECT_TYPE_INS=0]="TARGETOBJECT_TYPE_INS",i[i.TARGETOBJECT_TYPE_CAM=1]="TARGETOBJECT_TYPE_CAM",i[i.TARGETOBJECT_TYPE_PMI=2]="TARGETOBJECT_TYPE_PMI",i[i.TARGETOBJECT_TYPE_CLIP=3]="TARGETOBJECT_TYPE_CLIP",i[i.TARGETOBJECT_TYPE_SOUND=4]="TARGETOBJECT_TYPE_SOUND",i[i.TARGETOBJECT_TYPE_IMAGE=5]="TARGETOBJECT_TYPE_IMAGE"}(M3D||(M3D={})),function(p){var e=function(){function s(){}return s.GetNode=function(e,t){var r=s.AniDecPathToM3DHexPath(e);return t.GetSceneManager().GetNode(r)},s.GetModel=function(e,t){var r=null,i=s.AniDecPathToM3DHexPath(e),n=t.GetSceneManager().GetNode(i);return n&&n instanceof p.Model&&(r=n),r},s.GetMeasure=function(e,t){var r=null,i=t.GetSceneManager();if(!i)return r;var n=i.GetMeasureGroup();if(!n)return r;for(var o=n.Size(),a=0;a<o;a++){var s=n.GetChild(a);if(s){var l=s.GetShape();if(l){var h=l;if(h&&h.GetCreateID()===e){r=h;break}}}}return r},s.GetAnnotation=function(e,t){var r=null,i=t.GetSceneManager();if(!i)return r;var n=i.GetAnnotationGroup();if(!n)return r;for(var o=n.Size(),a=0;a<o;a++){var s=n.GetChild(a);if(s){var l=s.GetShape();if(l){var h=l;if(h.GetCreateID()==e){r=h;break}}}}return r},s.SetModelColor=function(e,t){t&&(0<=e.r?t.SetColor(e):t.ResetColor())},s.SetModelColorAlpha=function(e,t){null!==t&&t.SetAlpha(e,!0)},s.SetModelTransform=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(e[0]instanceof Float32Array){var r=new p.Matrix4(e[0]);r.TransposeED();var i=new p.Matrix3x4(r);s.SetModelTransform(i,e[1])}else e[0]instanceof p.Matrix3x4&&e[1]instanceof p.Model&&e[1].SetPlaceMatrix(e[0])},s.SetModelRotate=function(e,t){var r=s.GetModelNode(t);r&&r.SetRotation(e)},s.SetModelPosition=function(e,t){var r=s.GetModelNode(t);r&&r.SetPosition(e)},s.SetModelScale=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if("number"==typeof e[0])(r=s.GetModelNode(e[1]))&&r.SetScale(new p.Vector3(e[0],e[0],e[0]));else if(e[0]instanceof p.Vector3){var r;(r=s.GetModelNode(e[1]))&&r.SetScale(e[0])}},s.SetModelVisible=function(e,t){t&&t.SetVisible(e)},s.GetModelPlcMatrix=function(e){var t=null,r=null;return e&&((r=(t=e.GetPlaceMatrix().ToMatrix3x4()).ToMatrix4()).data[15]=t.Scale().x),r.Clone()},s.GetCamera=function(e){return e.GetSceneManager().GetCamera()},s.SetCameraTransform=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(e[0]instanceof Float32Array){var r=new p.Matrix4(e[0]);r.TransposeED();var i=new p.Matrix3x4(r);s.SetCameraTransform(i,e[1])}else if(e[0]instanceof p.Matrix3x4)null!==e[1]&&e[1].SetTransform(e[0].Translation(),e[0].Rotation());else{for(var n=new Float32Array(16),o=0;o<4;o++)for(var a=0;a<4;a++)n[4*o+a]=e[0][o][a];s.SetCameraTransform(n,e[1])}},s.GetCameraTransform=function(e){return e.GetView().Clone().Inverse()},s.GetCameraZoom=function(e){var t=1;return e&&(t=e.GetZoom()),t},s.AdjustCameraZoom=function(e,t,r,i,n){var o=null;null!==t&&(o=t.GetOrthoSize());var a=r/o.x,s=i/o.y;if(n/=s<a?a:s,!this.IsPC()){var l=2*e.GetSceneManager().GetRenderManager().GetWindowWidth(),h=2*e.GetSceneManager().GetRenderManager().GetWindowHeight();n=s<a?n*l/o.x:n*h/o.y}return n<=0&&(n=1),n},s.IsPC=function(){for(var e=navigator.userAgent,t=["Android","iPhone","SymbianOS","Windows Phone","iPad","iPod"],r=!0,i=0;i<t.length;i++)if(0<e.indexOf(t[i])){r=!1;break}return r},s.GetPMI=function(e,t){},s.prototype.GetViewSize=function(e){var t=e.GetSceneManager().GetCamera(),r=new p.Vector2;return null!==t&&(r=t.GetOrthoSize().Clone()),r},s.SetCameraRotate=function(e,t){t&&t.SetRotation(e)},s.SetCameraPosition=function(e,t){t&&t.SetPosition(e)},s.SetCameraZoom=function(e,t){t&&t.SetZoom(e)},s.GetCameraTarget=function(e){var t=e.GetSceneManager().GetCamera();if(null!==t){t.GetZoom();var r=e.GetSceneManager().GetSceneBox().Center().Clone(),i=new p.Plane(t.GetWorldDirection(),r);return i.Project(t.GetWorldPosition()),i.Project(t.GetWorldPosition())}},s.GetSectionPlane=function(e,t){var r=null,i=t.GetSceneManager();if(null==i)return r;var n=i.GetSection();if(null==n)return r;var o=Number(e);if(!(r=n.GetPlaneById(o)))for(var a=t.GetModel().GetSectionPlaneList(),s=0;s<a.length;s++){var l=a[s];l.GetID()===o&&(r=l,n.AddPlane(r))}return r},s.GetCameraFocal=function(e){var t=1;return e&&(t=.8*e.GetSceneManager().GetSceneBox().Length()),t},s.AniDecPathToM3DHexPath=function(e){if(!e)return"";var t=e.indexOf("PATH|");0<=t&&t<e.length&&(e=e.substr(t+5));var r=e.split("\\"),i=r.length,n=[],o=!1;-1!==e.indexOf("\\")&&(o=!0,n="0"===r[0]?[]:["0"]);for(var a=0;a<i;a++)n.push(r[a]);var s=n.join("|").split("|"),l=[];l="0"===s[0]?[]:["0"];for(var h=0;h<s.length;h++){var u=void 0;u=o?parseInt(s[h],10).toString(16):s[h],l.push(u)}return p.MAINGROUP+"|PATH|"+l.join("|")},s.GetModelNode=function(e){var t=null;if(e){var r=e.GetSceneNode().GetParent();r&&r instanceof p.ModelNode&&(t=r)}return t},s.GetPlaceMatrix=function(e){if(e){var t=s.GetModelNode(e);if(t)return t.GetPlcMatrix()}return p.Matrix3x4.IDENTITY()},s.AddTrochoid=function(e,t,r){var i=new p.Model;i.SetName(t),i.AddLineData(e),i.SetFaceMaterial(r.GetSceneManager().GetResourceManager().GetOrCreateMaterial("m3d_default_material",p.MaterialType.MaterialType_Base)),r.GetSceneManager().GetHandlerGroup().AddSVLTool(i,t)},s.RemoveTrochoid=function(e,t){var r=t.GetSceneManager().GetHandlerGroup(),i=r.GetSVLTool(e);i&&(r.RemoveSVLTool(e),i=null)},s.UniTanslationToMtxTanslation=function(e,t,r){var i=p.ArrayMaker.MakeNumArray(4,4);t.ToMatrix(i);var n=[r.x,r.y,r.z],o=[e.x,e.y,e.z];return p.MatrixOperation.UniTanslationToMtxTanslation(o,i,n),new p.Vector3(n[0],n[1],n[2])},s}();p.AnimationHelper=e}(M3D||(M3D={})),function(f){var e=function(){function i(){this.CamaraMtx=f.ArrayMaker.MakeNumArray(4,4),this.ClipPos=f.ArrayMaker.MakeNumArray(3),this.pAnimationPlayCBList=new f.AnimationPlayCBList}return i.prototype.PlayEnd=function(){this.pAnimationPlayCBList&&this.pAnimationPlayCBList.InvokePlayEndCB()},i.prototype.CameraTranslation=function(e,t,r){this.CamaraMtx[3][0]=r[3][0],this.CamaraMtx[3][1]=r[3][1],this.CamaraMtx[3][2]=r[3][2]},i.prototype.CameraRotation=function(e,t,r){for(var i=0;i<3;i++)for(var n=0;n<3;n++)this.CamaraMtx[i][n]=r[i][n];this.CamaraMtx[0][3]=this.CamaraMtx[1][3]=this.CamaraMtx[2][3]=0,this.CamaraMtx[3][3]=1},i.prototype.GetCamera=function(e,t,r){},i.prototype.GetCameraTargetPnt=function(e,t){},i.prototype.GetFocalDistance=function(e,t){var r=1;if(t){t.GetSceneManager().GetSceneBox();r=.8*t.GetSceneManager().GetSceneBox().Length()}return r},i.prototype.CamaraTargetPntToPosition=function(e,t,r,i,n){var o=this.GetFocalDistance(e,n),a=f.ArrayMaker.MakeNumArray(3);a[0]=-r[2][0],a[1]=-r[2][1],a[2]=-r[2][2],i[0]=t[0]-a[0]*o,i[1]=t[1]-a[1]*o,i[2]=t[2]-a[2]*o},i.prototype.CameraScale=function(e,t,r,i,n){var o=f.ArrayMaker.MakeNumArray(3);if(o[0]=r[3][0],o[1]=r[3][1],o[2]=r[3][2],f.MatrixOperation.MatrixInversion(this.CamaraMtx),i===f.HBhvCameraType.CameraTarget){var a=f.ArrayMaker.MakeNumArray(3),s=f.ArrayMaker.MakeNumArray(3);a[0]=this.CamaraMtx[3][0],a[1]=this.CamaraMtx[3][1],a[2]=this.CamaraMtx[3][2],this.CamaraTargetPntToPosition(e,a,this.CamaraMtx,s,n),this.CamaraMtx[3][0]=s[0],this.CamaraMtx[3][1]=s[1],this.CamaraMtx[3][2]=s[2]}this.SetCamera(e,o,this.CamaraMtx,n)},i.prototype.PlayCamera=function(e,t,r,i,n,o){switch(t){case 0:this.CameraTranslation(e,r,i);break;case 1:this.CameraRotation(e,r,i);break;case 2:this.CameraScale(e,r,i,n,o)}return!0},i.prototype.ModelTanslation=function(e,t,r){for(var i=f.ArrayMaker.MakeNumArray(4,4),n=0;n<4;n++)for(var o=0;o<4;o++)i[n][o]=r[n][o];this.CalculatelTanslationMtx(e,t,i),this.SetModelPlcMtx(e,i)},i.prototype.GetModelPlcMtx=function(e,t){var r;r=i.SAPlcPathToDispPlcPath(e),this.pAnimationPlayCBList&&this.pAnimationPlayCBList.InvokeGetModelPlcMtxCB(r,t)},i.prototype.CalculatelTanslationMtx=function(e,t,r){var i=f.ArrayMaker.MakeNumArray(4,4);this.GetModelPlcMtx(e,i);for(var n=f.ArrayMaker.MakeNumArray(4,4),o=0;o<4;o++)for(var a=0;a<4;a++)n[o][a]=i[o][a];n[3][0]=n[3][1]=n[3][2]=0;var s=[[1,0,0,0],[0,1,0,0],[0,0,1,0],[t[0],t[1],t[2],1]],l=f.ArrayMaker.MakeNumArray(4,4);for(o=0;o<4;o++)for(a=0;a<4;a++)l[o][a]=s[o][a];f.MatrixOperation.MatrixInversion(l,4);var h=f.ArrayMaker.MakeNumArray(4,4),u=f.ArrayMaker.MakeNumArray(4,4);f.MatrixOperation.Multiply(l,n,h),f.MatrixOperation.Multiply(h,s,u),f.MatrixOperation.Multiply(u,r,h);for(o=0;o<4;o++)for(a=0;a<4;a++)r[o][a]=h[o][a]},i.prototype.CalculatelRotationMtx=function(e,t,r){var i=f.ArrayMaker.MakeNumArray(4,4);this.GetModelPlcMtx(e,i);var n=[];f.MatrixOperation.getTransform(i,[],[],n,[]);var o=f.ArrayMaker.MakeNumArray(4,4),a=[];a.push([n[0],0,0,0]),a.push([0,n[1],0,0]),a.push([0,0,n[2],0]),a.push([0,0,0,1]),f.MatrixOperation.Multiply(a,r,o),o[3][0]=r[3][0],o[3][1]=r[3][1],o[3][2]=r[3][2];var s=f.ArrayMaker.MakeNumArray(3);s[0]=t[0]*i[0][0]+t[1]*i[1][0]+t[2]*i[2][0]+i[3][0],s[1]=t[0]*i[0][1]+t[1]*i[1][1]+t[2]*i[2][1]+i[3][1],s[2]=t[0]*i[0][2]+t[1]*i[1][2]+t[2]*i[2][2]+i[3][2],s[0]=s[0]-t[0],s[1]=s[1]-t[1],s[2]=s[2]-t[2];for(var l=[[1,0,0,0],[0,1,0,0],[0,0,1,0],[s[0],s[1],s[2],1]],h=[[1,0,0,0],[0,1,0,0],[0,0,1,0],[t[0],t[1],t[2],1]],u=f.ArrayMaker.MakeNumArray(4,4),p=0;p<4;p++)for(var c=0;c<4;c++)u[p][c]=h[p][c];f.MatrixOperation.MatrixInversion(u);var d=f.ArrayMaker.MakeNumArray(4,4),S=f.ArrayMaker.MakeNumArray(4,4);f.MatrixOperation.Multiply(u,o,d),f.MatrixOperation.Multiply(d,h,S),f.MatrixOperation.Multiply(S,l,d);for(p=0;p<4;p++)for(c=0;c<4;c++)r[p][c]=d[p][c]},i.prototype.SetModelPlcMtx=function(e,t){var r;r=i.SAPlcPathToDispPlcPath(e),this.pAnimationPlayCBList&&this.pAnimationPlayCBList.InvokeSetModelPlcMtxCB(r,t)},i.prototype.UpdateView=function(e){},i.prototype.PlayBegin=function(){this.pAnimationPlayCBList&&this.pAnimationPlayCBList.InvokePlayBeginCB()},i.SAPlcPathToDispPlcPath=function(e,t){var r;void 0===t&&(t=!0);var i=0,n="";if(!e||256<=e.length)return null;for(var o=e.split("\\"),a=0;a<o.length;++a)r=o[a],i=parseInt(r),i&=16777215,n=""==n?i.toString(16):n+"|"+i.toString(16);return n=0<n.length&&"0"==n[0]?t?"PATH"+n:"":t?"PATH|0|"+n:n},i.prototype.SetTargetState=function(e){for(var t=0;t<e.length;t++){var r;e[t].Type!=f.TargetObjectType.TARGETOBJECT_TYPE_INS&&e[t].Type!=f.TargetObjectType.TARGETOBJECT_TYPE_PMI||(r=i.SAPlcPathToDispPlcPath(e[t].InsPath),e[t].InsPath=r)}this.pAnimationPlayCBList&&this.pAnimationPlayCBList.InvokeSetTargetStateCB(e)},i.prototype.ModelRotation=function(e,t,r){for(var i=f.ArrayMaker.MakeNumArray(4,4),n=0;n<4;n++)for(var o=0;o<4;o++)i[n][o]=r[n][o];this.CalculatelRotationMtx(e,t,i),this.SetModelPlcMtx(e,i)},i.prototype.Play=function(e,t,r,i){switch(e){case 0:this.ModelTanslation(t,r,i);break;case 1:this.ModelRotation(t,r,i)}return!0},i.prototype.SetCamera=function(e,t,r,i){if(i.AnimationGetPlayCamera()){var n=i.GetSimulationMgr(),o=void 0;null!==n&&(o=n.Version);var a=t[0],s=t[1],l=t[2],h=1,u=i.GetSceneManager().GetCamera();h=1.15<=parseFloat(o)&&0<t[1]&&0<t[2]?f.AnimationHelper.AdjustCameraZoom(i,u,s,l,a):1/a,f.AnimationHelper.SetCameraTransform(r,u),f.AnimationHelper.SetCameraZoom(h,u)}},i.prototype.PlayVisible=function(e,t,r,i,n){this.pAnimationPlayCBList.InvokePlayVisibleCB(e,t,r,i,n)},i.prototype.PlayColor=function(e,t,r,i){this.pAnimationPlayCBList.InvokePlayColorCB(e,t,[r.x,r.y,r.z,1],i)},i.prototype.PlayClipPlane=function(e,t,r,i,n,o){switch(e){case 0:this.ClipPos[0]=n[0],this.ClipPos[1]=n[1],this.ClipPos[2]=n[2];break;case 1:this.ClipNormal||(this.ClipNormal=new f.Vector3),this.ClipNormal.x=i[0],this.ClipNormal.y=i[1],this.ClipNormal.z=i[2];break;case 2:if(this.pAnimationPlayCBList){var a=[this.ClipNormal.x,this.ClipNormal.y,this.ClipNormal.z];this.pAnimationPlayCBList.InvokePlayClipPlaneCB(t,r,a,this.ClipPos,o)}}},i.prototype.PlayAnimationImage=function(e,t,r,i,n){this.pAnimationPlayCBList&&this.pAnimationPlayCBList.InvokePlayImageCB(e,t,r,i,n)},i}();f.AnimationPlayApi=e}(M3D||(M3D={})),function(e){var t=function(){function e(){this.vecUpdateViewCB=[],this.vecPlayBeginCB=[],this.vecPlayEndCB=[],this.vecGetModelPlcMtxCB=[],this.vecSetModelPlcMtxCB=[],this.vecGetCameraCB=[],this.vecSetCameraCB=[],this.vecGetCameraTargetPntCB=[],this.vecPlayVisibleCB=[],this.vecPlayColorCB=[],this.vecPlayImageCB=[],this.vecPlayClipPlaneCB=[],this.vecSetTargetStateCB=[]}return e.prototype.SetCBTran=function(e,t,r,i,n,o,a,s,l,h,u,p,c){this.AddUpdateViewCB(e),this.AddPlayBeginCB(t),this.AddPlayEndCB(r),this.AddGetModelPlcMtxCB(i),this.AddSetModelPlcMtxCB(n),this.AddGetCameraCB(o),this.AddSetCameraCB(a),this.AddGetCameraTargetPntCB(s),this.AddPlayVisibleCB(l),this.AddPlayColorCB(h),this.AddPlayImageCB(u),this.AddPlayClipPlaneCB(p),this.AddSetTargetStateCB(c)},e.prototype.AddUpdateViewCB=function(e){for(var t=0;t!=this.vecUpdateViewCB.length;++t)if(this.vecUpdateViewCB[t].functor&&this.vecUpdateViewCB[t].functor.obj_ptr==e.functor.obj_ptr)return;this.vecUpdateViewCB.push(e)},e.prototype.RemoveUpdateViewCB=function(e){for(var t=0;t!=this.vecUpdateViewCB.length;++t)if(this.vecUpdateViewCB[t].functor&&this.vecUpdateViewCB[t].functor.obj_ptr==e.functor.obj_ptr){this.vecUpdateViewCB.splice(t,1);break}},e.prototype.InvokeUpdateViewCB=function(e){for(var t=0;t<this.vecUpdateViewCB.length;t++)this.vecUpdateViewCB[t]&&this.vecUpdateViewCB[t].onExecute(e)},e.prototype.AddPlayBeginCB=function(e){for(var t=0;t!=this.vecPlayBeginCB.length;++t)if(this.vecUpdateViewCB[t].functor&&this.vecUpdateViewCB[t].functor.obj_ptr==e.functor.obj_ptr)return;this.vecPlayBeginCB.push(e)},e.prototype.RemovePlayBeginCB=function(e){for(var t=0;t!=this.vecPlayBeginCB.length;++t)if(this.vecUpdateViewCB[t].functor&&this.vecUpdateViewCB[t].functor.obj_ptr==e.functor.obj_ptr){this.vecPlayBeginCB.splice(t,1);break}},e.prototype.InvokePlayBeginCB=function(){for(var e=0;e<this.vecPlayBeginCB.length;e++)this.vecPlayBeginCB[e]&&this.vecPlayBeginCB[e].onExecute()},e.prototype.AddPlayEndCB=function(e){for(var t=0;t!=this.vecPlayEndCB.length;++t)if(this.vecUpdateViewCB[t].functor&&this.vecUpdateViewCB[t].functor.obj_ptr==e.functor.obj_ptr)return;this.vecPlayEndCB.push(e)},e.prototype.RemovePlayEndCB=function(e){for(var t=0;t!=this.vecPlayEndCB.length;++t)if(this.vecUpdateViewCB[t].functor&&this.vecUpdateViewCB[t].functor.obj_ptr==e.functor.obj_ptr){this.vecPlayEndCB.splice(t,1);break}},e.prototype.InvokePlayEndCB=function(){for(var e=0;e<this.vecPlayEndCB.length;e++)this.vecPlayEndCB[e]&&this.vecPlayEndCB[e].onExecute()},e.prototype.AddGetModelPlcMtxCB=function(e){for(var t=0;t!=this.vecGetModelPlcMtxCB.length;++t)if(this.vecUpdateViewCB[t].functor&&this.vecUpdateViewCB[t].functor.obj_ptr==e.functor.obj_ptr)return;this.vecGetModelPlcMtxCB.push(e)},e.prototype.RemoveGetModelPlcMtxCB=function(e){for(var t=0;t!=this.vecGetModelPlcMtxCB.length;++t)if(this.vecUpdateViewCB[t].functor&&this.vecUpdateViewCB[t].functor.obj_ptr==e.functor.obj_ptr){this.vecGetModelPlcMtxCB.splice(t,1);break}},e.prototype.InvokeGetModelPlcMtxCB=function(e,t){for(var r=0;r<this.vecGetModelPlcMtxCB.length;r++)this.vecGetModelPlcMtxCB[r]&&this.vecGetModelPlcMtxCB[r].onExecute(e,t)},e.prototype.AddSetModelPlcMtxCB=function(e){for(var t=0;t!=this.vecSetModelPlcMtxCB.length;++t)if(this.vecUpdateViewCB[t].functor&&this.vecUpdateViewCB[t].functor.obj_ptr==e.functor.obj_ptr)return;this.vecSetModelPlcMtxCB.push(e)},e.prototype.RemoveSetModelPlcMtxCB=function(e){for(var t=0;t!=this.vecSetModelPlcMtxCB.length;++t)if(this.vecUpdateViewCB[t].functor&&this.vecUpdateViewCB[t].functor.obj_ptr==e.functor.obj_ptr){this.vecSetModelPlcMtxCB.splice(t,1);break}},e.prototype.InvokeSetModelPlcMtxCB=function(e,t){for(var r=0;r<this.vecSetModelPlcMtxCB.length;r++)this.vecSetModelPlcMtxCB[r]&&this.vecSetModelPlcMtxCB[r].onExecute(e,t)},e.prototype.AddGetCameraCB=function(e){for(var t=0;t!=this.vecGetCameraCB.length;++t)if(this.vecUpdateViewCB[t].functor&&this.vecUpdateViewCB[t].functor.obj_ptr==e.functor.obj_ptr)return;this.vecGetCameraCB.push(e)},e.prototype.RemoveGetCameraCB=function(e){for(var t=0;t!=this.vecGetCameraCB.length;++t)if(this.vecUpdateViewCB[t].functor&&this.vecUpdateViewCB[t].functor.obj_ptr==e.functor.obj_ptr){this.vecGetCameraCB.splice(t,1);break}},e.prototype.InvokeGetCameraCB=function(e,t,r){for(var i=0;i<this.vecGetCameraCB.length;i++)this.vecGetCameraCB[i]&&this.vecGetCameraCB[i].onExecute(e,t,r)},e.prototype.AddSetCameraCB=function(e){for(var t=0;t!=this.vecSetCameraCB.length;++t)if(this.vecUpdateViewCB[t].functor&&this.vecUpdateViewCB[t].functor.obj_ptr==e.functor.obj_ptr)return;this.vecSetCameraCB.push(e)},e.prototype.RemoveSetCameraCB=function(e){for(var t=0;t!=this.vecSetCameraCB.length;++t)if(this.vecUpdateViewCB[t].functor&&this.vecUpdateViewCB[t].functor.obj_ptr==e.functor.obj_ptr){this.vecSetCameraCB.splice(t,1);break}},e.prototype.InvokeSetCameraCB=function(e,t,r){for(var i=0;i<this.vecSetCameraCB.length;i++)this.vecSetCameraCB[i]&&this.vecSetCameraCB[i].onExecute(e,t,r)},e.prototype.AddGetCameraTargetPntCB=function(e){for(var t=0;t!=this.vecGetCameraTargetPntCB.length;++t)if(this.vecUpdateViewCB[t].functor&&this.vecUpdateViewCB[t].functor.obj_ptr==e.functor.obj_ptr)return;this.vecGetCameraTargetPntCB.push(e)},e.prototype.RemoveGetCameraTargetPntCB=function(e){for(var t=0;t!=this.vecGetCameraTargetPntCB.length;++t)if(this.vecUpdateViewCB[t].functor&&this.vecUpdateViewCB[t].functor.obj_ptr==e.functor.obj_ptr){this.vecGetCameraTargetPntCB.splice(t,1);break}},e.prototype.InvokeGetCameraTargetPntCB=function(e,t){for(var r=0;r<this.vecGetCameraTargetPntCB.length;r++)this.vecGetCameraTargetPntCB[r]&&this.vecGetCameraTargetPntCB[r].onExecute(e,t)},e.prototype.AddPlayVisibleCB=function(e){for(var t=0;t!=this.vecPlayVisibleCB.length;++t)if(this.vecUpdateViewCB[t].functor&&this.vecUpdateViewCB[t].functor.obj_ptr==e.functor.obj_ptr)return;this.vecPlayVisibleCB.push(e)},e.prototype.RemovePlayVisibleCB=function(e){for(var t=0;t!=this.vecPlayVisibleCB.length;++t)if(this.vecUpdateViewCB[t].functor&&this.vecUpdateViewCB[t].functor.obj_ptr==e.functor.obj_ptr){this.vecPlayVisibleCB.splice(t,1);break}},e.prototype.InvokePlayVisibleCB=function(e,t,r,i,n){for(var o=0;o<this.vecPlayVisibleCB.length;o++)this.vecPlayVisibleCB[o]&&this.vecPlayVisibleCB[o].onExecute(e,t,r,i,n)},e.prototype.AddPlayColorCB=function(e){for(var t=0;t!=this.vecPlayColorCB.length;++t)if(this.vecUpdateViewCB[t].functor&&this.vecUpdateViewCB[t].functor.obj_ptr==e.functor.obj_ptr)return;this.vecPlayColorCB.push(e)},e.prototype.RemovePlayColorCB=function(e){for(var t=0;t!=this.vecPlayColorCB.length;++t)if(this.vecUpdateViewCB[t].functor&&this.vecUpdateViewCB[t].functor.obj_ptr==e.functor.obj_ptr){this.vecPlayColorCB.splice(t,1);break}},e.prototype.InvokePlayColorCB=function(e,t,r,i){for(var n=0;n<this.vecPlayColorCB.length;n++)this.vecPlayColorCB[n]&&this.vecPlayColorCB[n].onExecute(e,t,r,i)},e.prototype.AddPlayImageCB=function(e){for(var t=0;t!=this.vecPlayImageCB.length;++t)if(this.vecUpdateViewCB[t].functor&&this.vecUpdateViewCB[t].functor.obj_ptr==e.functor.obj_ptr)return;this.vecPlayImageCB.push(e)},e.prototype.RemovePlayImageCB=function(e){for(var t=0;t!=this.vecPlayImageCB.length;++t)if(this.vecUpdateViewCB[t].functor&&this.vecUpdateViewCB[t].functor.obj_ptr==e.functor.obj_ptr){this.vecPlayImageCB.splice(t,1);break}},e.prototype.InvokePlayImageCB=function(e,t,r,i,n){for(var o=0;o<this.vecPlayImageCB.length;o++)this.vecPlayImageCB[o]&&this.vecPlayImageCB[o].onExecute(e,t,r,i,n)},e.prototype.AddPlayClipPlaneCB=function(e){for(var t=0;t!=this.vecPlayClipPlaneCB.length;++t)if(this.vecUpdateViewCB[t].functor&&this.vecUpdateViewCB[t].functor.obj_ptr==e.functor.obj_ptr)return;this.vecPlayClipPlaneCB.push(e)},e.prototype.RemovePlayClipPlaneCB=function(e){for(var t=0;t!=this.vecPlayClipPlaneCB.length;++t)if(this.vecUpdateViewCB[t].functor&&this.vecUpdateViewCB[t].functor.obj_ptr==e.functor.obj_ptr){this.vecPlayClipPlaneCB.splice(t,1);break}},e.prototype.InvokePlayClipPlaneCB=function(e,t,r,i,n){for(var o=0;o<this.vecPlayClipPlaneCB.length;o++)this.vecPlayClipPlaneCB[o]&&this.vecPlayClipPlaneCB[o].onExecute(e,t,r,i,n)},e.prototype.AddSetTargetStateCB=function(e){for(var t=0;t!=this.vecSetTargetStateCB.length;++t)if(this.vecUpdateViewCB[t].functor&&this.vecUpdateViewCB[t].functor.obj_ptr==e.functor.obj_ptr)return;this.vecSetTargetStateCB.push(e)},e.prototype.RemoveSetTargetStateCB=function(e){for(var t=0;t!=this.vecSetTargetStateCB.length;++t)if(this.vecUpdateViewCB[t].functor&&this.vecUpdateViewCB[t].functor.obj_ptr==e.functor.obj_ptr){this.vecSetTargetStateCB.splice(t,1);break}},e.prototype.InvokeSetTargetStateCB=function(e){for(var t=0;t<this.vecSetTargetStateCB.length;t++)this.vecSetTargetStateCB[t]&&this.vecSetTargetStateCB[t].onExecute(e)},e}();e.AnimationPlayCBList=t}(M3D||(M3D={})),function(e){var t=function(){};(M3D||(M3D={})).AnimationPlayFun=t}(),function(P){var t=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.onExecute=function(e,t,r,i,n){void 0===e&&(e=null),void 0===t&&(t=null),void 0===r&&(r=null),void 0===i&&(i=null),void 0===n&&(n=null)},t}(P.AniCallbackFun);P.UpdateViewCB=t;var r=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.onExecute=function(e,t,r,i,n){void 0===e&&(e=null),void 0===t&&(t=null),void 0===r&&(r=null),void 0===i&&(i=null),void 0===n&&(n=null),P.Parameters.Instance().isShowAniTrochoid&&this.ShowAniTrochoid()},t.prototype.ShowAniTrochoid=function(){var e=P.SimulationAnimationManager.Instance(),t=e.view;if(t){var r=e.GetCurrentSA();if(null!=r){var i=t.GetSceneManager();if(null!=i){var n=i.GetHandlerGroup();if(null!=n){var o="AnimationTrochoid",a=n.GetSVLTool(o);a&&(n.RemoveSVLTool(o),a=null),(a=new P.Model).SetName(o),a.SetFaceMaterial(i.GetResourceManager().GetOrCreateMaterial("m3d_default_material",P.MaterialType.MaterialType_Base));for(var s=0,l=r.AnimationList;s<l.length;s++){var h=l[s];if("位置"===h.GetName()){var u=[],p=[];this.GetLineVertexAndIndex(h,u,p),0<u.length&&a.AddLineData(u),u.splice(0,u.length),p.splice(0,p.length)}}n.AddSVLTool(a,o)}}}}},t.prototype.GetModelBoundingBoxCenter=function(e){var t=new P.BoundingBox;if(e){var r=e.GetModelShape();if(r)for(var i=r.GetBodys(),n=0;n<i.length;n++)for(var o=i[n].GetFaces(),a=0;a<o.length;a++){var s=o[a],l=new P.BoundingBox,h=s.GetMesh();null!=h&&h.GetBoundingBox().Defined()&&l.copyFrom(h.GetBoundingBox()),t.Merge(l)}return t.Center().Clone()}return P.BoundingBox.NO_BOX().Center().Clone()},t.prototype.GetLineVertexAndIndex=function(e,t,r){var i=e.GetTimeline(),n=i.GetTimelineArrayLength();0<n&&i.GetTimelineArray();var o=P.SimulationAnimationManager.Instance();if(o){var a=e.GetTarget();if(a&&"PLCID"===a.GetType()){var s=a.GetResolvedPath(),l=new P.Vector3(0,0,0),h=P.AnimationPlayApi.SAPlcPathToDispPlcPath(s),u=o.view.GetModelBySVLPath(h);null!=u&&(l=this.GetModelBoundingBoxCenter(u).Clone());for(var p=e.GetInterpolatorList(),c=0;c<n;c++){for(var d=new P.Vector3(0,0,0),S=new P.Vector3(0,0,0),f=new P.Quaternion(0,0,0,1),m=0,y=p;m<y.length;m++){var T=y[m],M=T.GetArrayLength();0<M&&c<M&&("Pivot"===T.GetType()?d=T.GetAt(c).cp.Clone():"QuatRot"===T.GetType()?f=T.GetAt(c).quat.Clone():"Pos"===T.GetType()&&(S=T.GetAt(c).cp.Clone()))}S=P.AnimationHelper.UniTanslationToMtxTanslation(d,f,S);var g=new P.Vector3(S.x,S.y,S.z),v=new P.Quaternion(f.w,f.x,f.y,f.z);g=new P.Matrix3x4(g,v,1).Multiply(l);var C=s,_=C.lastIndexOf("\\");if(-1<_){C=C.substr(0,_);var A=P.AnimationPlayApi.SAPlcPathToDispPlcPath(C),E=o.view.GetModelBySVLPath(A);if(null!=E)g=E.GetWorldTransform().ToMatrix3x4().Multiply(g)}t.push(g)}for(var G=0;G<t.length-1;G++)r.push(G),r.push(G+1)}}},t}(P.AniCallbackFun);P.PlayBeginCB=r;var i=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.onExecute=function(e,t,r,i,n){void 0===e&&(e=null),void 0===t&&(t=null),void 0===r&&(r=null),void 0===i&&(i=null),void 0===n&&(n=null),P.Parameters.Instance().isShowAniTrochoid&&this.PlayEndCallBack()},t.prototype.PlayEndCallBack=function(){var e=P.SimulationAnimationManager.Instance().view;P.AnimationHelper.RemoveTrochoid("AnimationTrochoid",e)},t}(P.AniCallbackFun);P.PlayEndCB=i;var n=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.onExecute=function(e,t,r,i,n){void 0===e&&(e=null),void 0===t&&(t=null),void 0===r&&(r=null),void 0===i&&(i=null),void 0===n&&(n=null);var o=P.AnimationHelper.GetModel(e,P.SimulationAnimationManager.Instance().view);if(o)for(var a=P.AnimationHelper.GetModelPlcMatrix(o).Data(),s=0;s<4;++s)for(var l=0;l<4;++l)t[l][s]=a[4*s+l]},t}(P.AniCallbackFun);P.GetModelPlcMtxCB=n;var o=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.onExecute=function(e,t,r,i,n){void 0===e&&(e=null),void 0===t&&(t=null),void 0===r&&(r=null),void 0===i&&(i=null),void 0===n&&(n=null);var o=e;if(o){var a=o.indexOf("|");o=o.substr(a+1);var s=P.AnimationHelper.GetNode(o,P.SimulationAnimationManager.Instance().view),l=new P.Matrix3x4(t[0][0],t[1][0],t[2][0],t[3][0],t[0][1],t[1][1],t[2][1],t[3][1],t[0][2],t[1][2],t[2][2],t[3][2]);if(s)s.SetPlaceMatrix(l.ToMatrix4()),P.SimulationAnimationManager.Instance().view.GetSceneManager().UpdateSceneByModel(s)}},t}(P.AniCallbackFun);P.SetModelPlcMtxCB=o;var a=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.onExecute=function(e,t,r,i,n){void 0===e&&(e=null),void 0===t&&(t=null),void 0===r&&(r=null),void 0===i&&(i=null),void 0===n&&(n=null)},t}(P.AniCallbackFun);P.GetCameraCB=a;var s=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.onExecute=function(e,t,r,i,n){void 0===e&&(e=null),void 0===t&&(t=null),void 0===r&&(r=null),void 0===i&&(i=null),void 0===n&&(n=null)},t}(P.AniCallbackFun);P.SetCameraCB=s;var l=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.onExecute=function(e,t,r,i,n){void 0===e&&(e=null),void 0===t&&(t=null),void 0===r&&(r=null),void 0===i&&(i=null),void 0===n&&(n=null)},t}(P.AniCallbackFun);P.GetCameraTargetPntCB=l;var h=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.onExecute=function(e,t,r,i,n){void 0===e&&(e=null),void 0===t&&(t=null),void 0===r&&(r=null),void 0===i&&(i=null),void 0===n&&(n=null);var o=e,a=t,s=r,l=i,h=n;if(0<=o.indexOf("ZOOM"));else if(0<=a.indexOf("PMI")){var u=a.substr(4,a.length),p=Number(u),c=P.AnimationHelper.GetMeasure(p,h);c?(c.SetVisible(s),c.SetAlpha(l)):(c=P.AnimationHelper.GetAnnotation(p,h))&&(c.SetVisible(s),c.SetAlpha(l))}else if(0===a.length){var d=P.AnimationHelper.GetModel(o,h);d&&(P.AnimationHelper.SetModelVisible(s,d),P.AnimationHelper.SetModelColorAlpha(1-l,d))}return!0},t}(P.AniCallbackFun);P.PlayVisibleCB=h;var u=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.onExecute=function(e,t,r,i,n){void 0===e&&(e=null),void 0===t&&(t=null),void 0===r&&(r=null),void 0===i&&(i=null),void 0===n&&(n=null);var o=e,a=t,s=r,l=i;if(a&&4<a.length){a.substr(4,a.length)}var h=P.AnimationHelper.GetModel(o,l);if(!h)return!1;var u=new P.Color(s[0],s[1],s[2],1-s[3]),p=h.GetAlpha();if(u.a=p,u.r<0)return h.ResetColor(),!0;var c=l.GetSceneManager();if(c&&c.GetResourceManager()){var d=h.GetFaceMaterial();if(d){if(c.GetResourceManager().IsMaterialUsed(c.GetModel(),h.GetFaceMaterial(),h)){var S=null;(S=c.GetResourceManager().CopyMaterial(S,h.GetFaceMaterial()))&&(h.SetFaceMaterial(S),d=S)}switch(d.GetMaterialType()){case P.MaterialType.MaterialType_Phong:d.SetDiffuse(u);break;case P.MaterialType.MaterialType_Pbr:d.SetAlbedoColor(u);break;case P.MaterialType.MaterialType_MatCap:d.SetDiffuse(u)}}else{var f,m=h.GetAlpha();if(f=c.GetResourceManager().IsMaterialExisted(u,m))h.SetFaceMaterial(f);else{var y="material_phong_uuid_"+P.IDCreator.GetUUID(),T=c.GetResourceManager().GetOrCreateMaterial(y,P.MaterialType.MaterialType_Phong);T.SetDiffuse(u),T.Opacity(m),h.SetFaceMaterial(T)}}}return!0},t}(P.AniCallbackFun);P.PlayColorCB=u;var p=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.onExecute=function(e,t,r,i,n){void 0===e&&(e=null),void 0===t&&(t=null),void 0===r&&(r=null),void 0===i&&(i=null),void 0===n&&(n=null);var o=e,a=r,s=i,l=n;o.indexOf("\\")&&(o=o.replace("\\","/"));var h=P.SimulationAnimationManager.Instance(),u=h.GetCurrentSA(),p=h.view,c=p.GetSceneManager().GetScreenUILayerGroup().GetHudModelByName(o);if(!u.IsPlayImage())return c&&p.GetSceneManager().GetScreenUILayerGroup().RemoveHudModel(c),!0;if(l){if(c){var d=p.GetSceneManager().GetRenderManager().GetWindowWidth(),S=p.GetSceneManager().GetRenderManager().GetWindowHeight(),f=d/S,m=S/s[0],y=f/s[1];y<=1&&(m*=y);var T=m*s[2],M=new P.Vector3(0,0,0);M.x=a[0],M.y=a[1];o.substr(o.indexOf("\\")+1,o.length-1-o.indexOf("\\"));(c=c).SetImageSize(M,new P.Vector2(T,m)),c.SetVisible(!0),p.GetSceneManager().GetScreenUILayerGroup().AddHudModel(c)}}else c&&(c.SetImageSize(new P.Vector3(0,0,0),new P.Vector2(0,0)),c.SetVisible(!1))},t}(P.AniCallbackFun);P.PlayImageCB=p;var c=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.onExecute=function(e,t,r,i,n){void 0===e&&(e=null),void 0===t&&(t=null),void 0===r&&(r=null),void 0===i&&(i=null),void 0===n&&(n=null);var o=e,a=i,s=r,l=n,h=P.SimulationAnimationManager.Instance().view;if(h){var u=P.AnimationHelper.GetSectionPlane(o,h);if(u){var p=new P.Vector3(a[0],a[1],a[2]),c=new P.Vector3(s[0],s[1],s[2]);u.SetEnable(l);var d=-c.DotProduct(p),S=new P.Plane(c,d),f=h.GetSceneManager().GetSection().GetDrawRection().Projected(S);u.SetDrawPlane(f),u.SetPlaneParam(c.x,c.y,c.z,d)}}},t}(P.AniCallbackFun);P.PlayClipPlaneCB=c;var d=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.onExecute=function(e,t,r,i,n){void 0===e&&(e=null),void 0===t&&(t=null),void 0===r&&(r=null),void 0===i&&(i=null),void 0===n&&(n=null);var o=e,a=[],s=P.SimulationAnimationManager.Instance(),l=s.view;if(l){for(var h=0;h<o.length;++h)o[h].Type==P.TargetObjectType.TARGETOBJECT_TYPE_INS&&0==o[h].bVisible&&a.push(o[h]);for(h=0;h<o.length;++h){var u=o[h];if(1===u.Type){var p=P.AnimationHelper.GetCamera(l);if(p){var c="1.0";s&&(c=s.GetCurrentSA().GetVersion());var d=u.Scale[0],S=u.Scale[1],f=u.Scale[2],m=1;1.15<=Number(c)&&0<u.Scale[1]&&0<u.Scale[2]?P.AnimationHelper.AdjustCameraZoom(l,p,S,f,d):m=d;var y=[];P.MatrixOperation.FromQuat(u.Quat,y),y[3][0]=u.Pos[0],y[3][1]=u.Pos[1],y[3][2]=u.Pos[2],y[0][3]=y[1][3]=y[2][3]=0,y[3][3]=1,P.AnimationHelper.SetCameraTransform(y,p),P.AnimationHelper.SetCameraZoom(m,p)}}else if(0===u.Type){var T=o[h],M=T.InsPath;if(!M)continue;var g=P.AnimationHelper.GetModel(M,l);if(g){var v=new P.Vector3(o[h].Pos[0],o[h].Pos[1],o[h].Pos[2]),C=new P.Quaternion(o[h].Quat[3],o[h].Quat[0],o[h].Quat[1],o[h].Quat[2]),_=new P.Vector3(o[h].Scale[0],o[h].Scale[1],o[h].Scale[2]),A=new P.Matrix4(v,C,_);if(g.SetPlaceMatrix(A),g.SetVisible(T.bVisible,!1),0<=T.Color[0]){var E=new P.Color(T.Color[0],T.Color[1],T.Color[2],1-T.Trans);g.SetColor(E,!1)}}}else if(2===u.Type)o[h].EntId}}},t}(P.AniCallbackFun);P.SetTargetStateCB=d;var e=function(){function e(){}return e.prototype.SetAnimationPlayCB=function(){this.SetAniPlayCB(new t,new r,new i,new n,new o,new a,new s,new l,new h,new u,new p,new c,new d)},e.prototype.SetAniPlayCB=function(e,t,r,i,n,o,a,s,l,h,u,p,c){var d=P.SimulationAnimationManager.Instance();if(d&&!this.pAnimationPlayCBList){if(this.pAnimationPlayCBList=d.GetAnimationPlayCBList(),null==this.pAnimationPlayCBList)return;this.pAnimationPlayCBList.SetCBTran(e,t,r,i,n,o,a,s,l,h,u,p,c)}},e.prototype.ReSetCBTran=function(){this.SetAnimationPlayCB()},e}();P.AnimationRelated=e}(M3D||(M3D={})),function(P){var l,e;(e=l=P.AnimationPlayMode||(P.AnimationPlayMode={}))[e.PLAY_MODE_NONE=0]="PLAY_MODE_NONE",e[e.PLAY_MODE_PROCESS=1]="PLAY_MODE_PROCESS",e[e.PLAY_MODE_FROCURPROCESS=2]="PLAY_MODE_FROCURPROCESS",e[e.PLAY_MODE_PROCESSMANAGER=3]="PLAY_MODE_PROCESSMANAGER",e[e.PLAY_MODE_FROCURPROCESSMANAGER=4]="PLAY_MODE_FROCURPROCESSMANAGER",e[e.PLAY_MODE_ALL=5]="PLAY_MODE_ALL",e[e.PLAY_MODE_RANDOM=6]="PLAY_MODE_RANDOM";var t=function(){function s(e){this.ProcessManagerList=[],this.CurProcessManagerID=-1,this.Name=e||"动画过程管理器",this.pSA=null,this.PlayMode=l.PLAY_MODE_NONE,this.pBehaviorManagerChgCam=null,this.nChgCamTickNum=10,this.bIsPause=!1,this.TickCount=0}return s.prototype.GetTickCount=function(){return this.TickCount},s.prototype.CaculateTickCount=function(){for(var e=this.TickCount=0;e<this.ProcessManagerList.length;++e)this.ProcessManagerList[e].SetPreTickCount(this.TickCount),console.log(e+" PreTick:"+this.TickCount),this.ProcessManagerList[e].CaculateTickCount(),this.TickCount+=this.ProcessManagerList[e].GetTickCount(),console.log(" TickCount:"+this.TickCount)},s.prototype.GetCurPercentage=function(){if(0!=this.TickCount){var e=this.GetCurrentProcess();if(e){var t=e.GetBehaviorManager();if(t)return(t.GetCurrentTick()-t.GetFirstTick()+e.GetPreTickCount())/this.TickCount}}return 0},s.ProcessXMLData=function(e,t){var r;r=t?t.CreateAnimationStepManager():new s("");var i=e.getAttribute("Name");i&&""!==i||(i="DefaultName"),r.Name=i;var n=e.getAttribute("CurProcessManagerID");n||(n=0);for(var o=0;o<e.childNodes.length;++o){var a=e.childNodes[o];if(1===a.nodeType)switch(a.nodeName){case"ProcessManager":P.ProcessManager.ProcessXMLData(a,r);break;case"ChildAnimation":P.ChildAnimation.ProcessXMLData(a,r)}}r.CurProcessManagerID=n,r.SetCurProcessManagerByID(n,!1)},s.prototype.PlayFinishCB=function(e){if(this.PlayMode!=l.PLAY_MODE_RANDOM){var t=this.GetCurrentProcessManager();if(t){var r=t.GetCurrentProcess();if(r)if(this.PlayMode==l.PLAY_MODE_FROCURPROCESS||this.PlayMode==l.PLAY_MODE_PROCESSMANAGER||this.PlayMode==l.PLAY_MODE_FROCURPROCESSMANAGER||this.PlayMode==l.PLAY_MODE_ALL)if((r=this.pSA.GetReversePlay()?t.GetPreProcess(r):t.GetNextProcess(r))?t.SetCurProcessByID(r.GetID()):(r=null,this.PlayMode!=l.PLAY_MODE_FROCURPROCESSMANAGER&&this.PlayMode!=l.PLAY_MODE_ALL||((t=this.pSA.GetReversePlay()?this.GetPreProcessManager(t):this.GetNextProcessManager(t))?(this.pSA.GetReversePlay()?t.SetCurProcessByIdx(t.GetProcessCount()-1):t.SetCurProcessByIdx(0),r=t.GetCurrentProcess()):t=null,r||(r=this.pSA.GetReversePlay()?this.GetPreProcess(r):this.GetNextProcess(r))&&(t=r.GetProcessManager()).SetCurProcessByID(r.GetID()))),r){var i=r.GetBehaviorManager();i&&(this.pSA.GetReversePlay()?(i.RewindReverse(),i.ContinueReverse()):(i.Rewind(),i.Continue()),this.bIsPause=!1)}else this.pSA.GetContinuousPlay()?this.PlayMode==l.PLAY_MODE_FROCURPROCESS||this.PlayMode==l.PLAY_MODE_PROCESSMANAGER?this.Play(l.PLAY_MODE_PROCESSMANAGER,this.pSA.GetReversePlay()):this.Play(l.PLAY_MODE_ALL,this.pSA.GetReversePlay()):this.Stop();else this.pSA.GetContinuousPlay()?this.Play(this.PlayMode,this.pSA.GetReversePlay()):this.Stop()}}},s.prototype.AddProcessManager=function(){for(var e,t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];return 2==t.length?((e=this.FindProcessManagerByID(t[0]))&&0<t[0]?(e.SetName(t[1]),e.DeleteAllProcess()):(e=-1==t[0]?new P.ProcessManager(this.RegisterProcessManagerID(),t[1]):new P.ProcessManager(t[0],t[1]),this.AddProcessManager(e)),e):1!=t.length?this.AddProcessManager(-1,""):void(null!=t[0]&&(this.ProcessManagerList.push(t[0]),this.CurProcessManagerID=t[0].GetID(),t[0].SetAnimationStepManager(this)))},s.prototype.RegisterProcessManagerID=function(){for(var e=0,t=0;t<this.ProcessManagerList.length;++t)this.ProcessManagerList[t].GetID()>=e&&(e=this.ProcessManagerList[t].GetID()+1);return e},s.prototype.EndChangeCamera=function(){if(this.pBehaviorManagerChgCam){var e=this.pBehaviorManagerChgCam.GetSimulationAnimationManager();e&&(this.pBehaviorManagerChgCam.DeleteAllAnimations(),this.GetCurrentProcess()&&this.GetCurrentProcess().GetBehaviorManager()&&e.SetCurSAByID(this.GetCurrentProcess().GetBehaviorManager().GetID()))}},s.prototype.Stop=function(){this.PlayMode=l.PLAY_MODE_NONE,this.pSA.IsPlaying()&&this.pSA.StopAll(),this.pSA.SetReversePlay(!1),this.EndChangeCamera()},s.prototype.GetCurrentProcessManager=function(){return-1!=this.CurProcessManagerID?this.FindProcessManagerByID(this.CurProcessManagerID):null},s.prototype.GetPreProcessManager=function(e){var t=null,r=this.GetProcessManagerIdxByID(e.GetID());return 0<r&&(t=this.GetProcessManagerByIdx(r-1)),t},s.prototype.IsAtPlayFirst=function(){var e=!1,t=this.GetCurrentProcessManager(),r=this.GetCurrentProcess();if(!t||!r)return!1;var i=r.GetBehaviorManager();return!!i&&(i.ScheduleAllAnimations(!0),(e=i.GetCurrentTick()<=i.GetFirstTick())&&this.GetPlayMode()!=l.PLAY_MODE_PROCESS&&(e=!t.GetPreProcess(r)),!e||this.GetPlayMode()!=l.PLAY_MODE_FROCURPROCESSMANAGER&&this.GetPlayMode()!=l.PLAY_MODE_ALL||(e=!this.GetPreProcessManager(t)),e)},s.prototype.IsAtPlayEnd=function(){var e=!1,t=this.GetCurrentProcessManager(),r=this.GetCurrentProcess();if(!t||!r)return!1;var i=r.GetBehaviorManager();return!!i&&(i.ScheduleAllAnimations(!0),(e=i.GetCurrentTick()>=i.GetLastTick())&&this.GetPlayMode()!=l.PLAY_MODE_PROCESS&&(e=!t.GetNextProcess(r)),!e||this.GetPlayMode()!=l.PLAY_MODE_FROCURPROCESSMANAGER&&this.GetPlayMode()!=l.PLAY_MODE_ALL||(e=!this.GetNextProcessManager(t)),e)},s.prototype.GetNextProcessManager=function(e){var t=null,r=this.GetProcessManagerIdxByID(e.GetID());return r<this.GetProcessManagerCount()-1&&(t=this.GetProcessManagerByIdx(r+1)),t},s.prototype.GetCurProcessManagerID=function(){return this.CurProcessManagerID},s.prototype.SetCurProcessManagerByIdx=function(e,t,r,i){void 0===t&&(t=!0),void 0===r&&(r=!1),void 0===i&&(i=!1);var n=this.GetProcessManagerByIdx(e);if(n&&this.CurProcessManagerID!=n.GetID()){this.CurProcessManagerID=n.GetID();var o=this.GetCurrentProcess();o&&o.UpdateView(t,r,i),t&&this.UpdateViewWithProcessManager(e)}this.pSA&&this.GetCurrentProcess()&&this.pSA.SetCurSAByID(this.GetCurrentProcess().GetBehaviorManagerID())},s.prototype.StartChangeCamera=function(e,t){var r=!1;if(!e)return r;var i,n,o=this.pSA.RegisterBehaviorManagerID();this.pBehaviorManagerChgCam?this.pBehaviorManagerChgCam.DeleteAllAnimations():this.pBehaviorManagerChgCam=this.pSA.AddSimAni(o);var a=new P.Vector3(0,0,0);if(i="CAMERA",i=":SCENE/TARGET","Camera",null==(n=P.HBhvUtility.AddAnimation(this.pBehaviorManagerChgCam,"Camera",i,a,null)))return!1;var s=this.pSA.GetAnimationPlayApi();if(s){var l,h,u,p,c,d,S=e.GetCamera(p,c,d);if(!S){i=P.TARGETOBJECTTYPE_CAM,i+=":SCENE/TARGET";var f=this.pSA.FindInitTargetObjectByPath(i);f&&(p=f.GetPos(),c=f.GetQuat(),d=f.GetScale(),S=!0)}if(S){var m=[1,1,1],y=P.ArrayMaker.MakeNumArray(4,4),T=P.ArrayMaker.MakeNumArray(3);s.GetCamera(i,m,y),s.GetCameraTargetPnt(i,T),y[3][0]=T[0],y[3][1]=T[1],y[3][2]=T[2];for(var M=P.ArrayMaker.MakeNumArray(4,4),g=0;g<4;++g)for(var v=0;v<4;++v)M[g][v]=y[g][v];P.MatrixOperation.MatrixInversion(M),l=new P.Vector3(M[3][0],M[3][1],M[3][2]),h=P.Quaternion.MatrixToQuaternion(M),u=new P.Vector3(m[0],m[1],m[2]),P.HBhvUtility.AddCameraKeyframe(this.pBehaviorManagerChgCam,n,0,new P.Vector3(0,0,0),l,h,u,!0);var C=d.x;if(0<d.y&&0<d.z){var _=d.y/m[1],A=d.z/m[2];C/=A<_?_:A}d=new P.Vector3(C,m[1],m[2]);var E=P.ArrayMaker.MakeNumArray(4,4),G=P.ArrayMaker.MakeNumArray(4,4);c.ToMatrix(E),E[3][0]=p.x,E[3][1]=p.y,E[3][2]=p.z;for(g=0;g<4;++g)for(v=0;v<4;++v)G[g][v]=E[g][v];P.MatrixOperation.MatrixInversion(G),p=new P.Vector3(G[3][0],G[3][1],G[3][2]),c=P.Quaternion.MatrixToQuaternion(G),P.HBhvUtility.AddCameraKeyframe(this.pBehaviorManagerChgCam,n,this.nChgCamTickNum,new P.Vector3(0,0,0),p,c,d,!0),t?(this.pBehaviorManagerChgCam.SetCurrentTick(0),this.pBehaviorManagerChgCam.Continue(),r=!0,this.bIsPause=!1):(this.pBehaviorManagerChgCam.RewindReverse(),this.EndChangeCamera(),r=!1)}else this.EndChangeCamera(),r=!1}return r},s.prototype.Rewind=function(e,t){if(this.IsPlaying()&&this.Stop(),this.pSA.SetReversePlay(t),e==l.PLAY_MODE_ALL)if(this.pSA.GetReversePlay()){for(var r=this.GetCurrentProcessManager();r;)r.SetCurProcessByIdx(r.GetProcessCount()-1),r=this.GetNextProcessManager(r);this.SetCurProcessManagerByIdx(this.GetProcessManagerCount()-1)}else{for(r=this.GetCurrentProcessManager();r;)r.SetCurProcessByIdx(0),r=this.GetPreProcessManager(r);this.SetCurProcessManagerByIdx(0)}else if(e==l.PLAY_MODE_PROCESSMANAGER||e==l.PLAY_MODE_FROCURPROCESSMANAGER||e==l.PLAY_MODE_FROCURPROCESS){(i=this.GetCurrentProcessManager())&&(t?i.SetCurProcessByIdx(i.GetProcessCount()-1):i.SetCurProcessByIdx(0))}else if(e==l.PLAY_MODE_PROCESS){var i,n=null,o=null;(i=this.GetCurrentProcessManager())&&(n=i.GetCurrentProcess())&&(o=n.GetBehaviorManager()),o&&(t?o.RewindReverse():o.Rewind())}var a=this.GetCurrentProcess();a&&a.UpdateView(!0,!0)},s.prototype.Pause=function(){if(this.bIsPause=!0,this.pSA.IsPlaying()){var e=this.pSA.GetCurrentSA();e&&e.Stop(),this.EndChangeCamera()}},s.prototype.PlayNextProcess=function(){var e=this.GetCurrentProcessManager();if(e){var t=e.GetNextProcess(e.GetCurrentProcess());if(t||(e=this.GetNextProcessManager(e))&&(this.pSA.GetReversePlay()?e.SetCurProcessByIdx(e.GetProcessCount()-1):e.SetCurProcessByIdx(0),t=e.GetCurrentProcess()),t){e.SetCurProcessByID(t.GetID());var r=t.GetBehaviorManager();r&&(this.pSA.GetReversePlay()?(r.RewindReverse(),r.ContinueReverse()):(r.Rewind(),r.Continue()),this.bIsPause=!1)}else this.pSA.GetContinuousPlay()&&(this.PlayMode==l.PLAY_MODE_FROCURPROCESS||this.PlayMode==l.PLAY_MODE_PROCESSMANAGER?this.Play(l.PLAY_MODE_PROCESSMANAGER,this.pSA.GetReversePlay()):this.Play(l.PLAY_MODE_ALL,this.pSA.GetReversePlay()))}},s.prototype.PlayPreProcess=function(){var e=this.GetCurrentProcessManager();if(e){var t=e.GetPreProcess(e.GetCurrentProcess());if(t||(e=this.GetPreProcessManager(e))&&(this.pSA.GetReversePlay()?e.SetCurProcessByIdx(0):e.SetCurProcessByIdx(e.GetProcessCount()-1),t=e.GetCurrentProcess()),t){e.SetCurProcessByID(t.GetID());var r=t.GetBehaviorManager();r&&(this.pSA.GetReversePlay()?(r.RewindReverse(),r.ContinueReverse()):(r.Rewind(),r.Continue()),this.bIsPause=!1)}else this.pSA.GetContinuousPlay()&&(this.PlayMode==l.PLAY_MODE_FROCURPROCESS||this.PlayMode==l.PLAY_MODE_PROCESSMANAGER?this.Play(l.PLAY_MODE_PROCESSMANAGER,this.pSA.GetReversePlay()):this.Play(l.PLAY_MODE_ALL,this.pSA.GetReversePlay()))}},s.prototype.Play=function(e,t,r){if(void 0===t&&(t=!1),void 0===r&&(r=!1),this.pSA&&this.pSA.HasAnimations())if(this.IsPlaying()&&this.Stop(),this.pSA.SetReversePlay(t),this.PlayMode=e,this.bIsPause){var i=this.pSA.GetCurrentSA();i&&(t?i.ContinueReverse():i.Continue()),this.bIsPause=!1}else{var n,o;if((t?this.IsAtPlayFirst():this.IsAtPlayEnd())&&!r)this.Rewind(e,t),this.pSA.SetReversePlay(t),this.PlayMode=e;else if(this.PlayMode==l.PLAY_MODE_ALL)if(this.pSA.GetReversePlay()){for(var a=this.GetCurrentProcessManager();a;)a.SetCurProcessByIdx(a.GetProcessCount()-1),a=this.GetNextProcessManager(a);this.SetCurProcessManagerByIdx(this.GetProcessManagerCount()-1)}else{for(a=this.GetCurrentProcessManager();a;)a.SetCurProcessByIdx(0),a=this.GetPreProcessManager(a);this.SetCurProcessManagerByIdx(0)}else if(this.PlayMode==l.PLAY_MODE_PROCESSMANAGER||this.PlayMode==l.PLAY_MODE_FROCURPROCESSMANAGER){var s;(s=this.GetCurrentProcessManager())&&(this.pSA.GetReversePlay()?s.SetCurProcessByIdx(s.GetProcessCount()-1):s.SetCurProcessByIdx(0))}(s=this.GetCurrentProcessManager())&&((n=s.GetCurrentProcess())||(this.PlayMode!=l.PLAY_MODE_PROCESSMANAGER&&this.PlayMode!=l.PLAY_MODE_FROCURPROCESSMANAGER&&this.PlayMode!=l.PLAY_MODE_ALL||(n=this.pSA.GetReversePlay()?this.GetPreProcess(n):this.GetNextProcess(n)),n&&(s=n.GetProcessManager()).SetCurProcessByID(n.GetID(),!1)),n&&(o=n.GetBehaviorManager())),o?(n.UpdateView(!0,!1,!1),this.StartChangeCamera(n,!0)||(this.pSA.GetReversePlay()?o.ContinueReverse():o.Continue())):this.PlayMode=l.PLAY_MODE_NONE}},s.prototype.GetPreProcess=function(e){var t,r=this.GetCurrentProcessManager();if(r)for(e&&(t=r.GetPreProcess(e));!t&&(r=this.GetPreProcessManager(r));)0<r.GetProcessCount()&&(t=r.GetProcessByIdx(r.GetProcessCount()-1));return t},s.prototype.GetNextProcess=function(e){var t,r=this.GetCurrentProcessManager();if(r)for(e&&(t=r.GetNextProcess(e));!t&&(r=this.GetNextProcessManager(r));)0<r.GetProcessCount()&&(t=r.GetProcessByIdx(0));return t},s.prototype.IsPlaying=function(){var e=!1;return this.PlayMode==l.PLAY_MODE_NONE||this.bIsPause||(e=!0),e},s.prototype.SetCurProcessManagerByID=function(e,t,r,i){if(void 0===t&&(t=!0),void 0===r&&(r=!1),void 0===i&&(i=!1),this.CurProcessManagerID!=e){this.CurProcessManagerID=e;var n=this.GetCurrentProcess();n&&n.UpdateView(t,r,i)}this.pSA&&this.GetCurrentProcess()&&this.pSA.SetCurSAByID(this.GetCurrentProcess().GetBehaviorManagerID())},s.prototype.GetCurrentProcess=function(){if(-1!=this.CurProcessManagerID){var e=this.FindProcessManagerByID(this.CurProcessManagerID);if(e)return e.GetCurrentProcess()}return null},s.prototype.FindProcessManagerByID=function(e){for(var t=0;t<this.ProcessManagerList.length;++t)if(this.ProcessManagerList[t].GetID()==e)return this.ProcessManagerList[t];return null},s.prototype.GetProcessManagerIdxByID=function(e){for(var t=0;t<this.ProcessManagerList.length;++t)if(e==this.ProcessManagerList[t].GetID())return t;return-1},s.prototype.GetProcessManagerByIdx=function(e){var t;return 0<this.ProcessManagerList.length&&e<this.ProcessManagerList.length&&(t=this.ProcessManagerList[e]),t},s.prototype.UpdateViewWithProcessManager=function(e){var t=this.GetSimulationAnimationManager(),r=t.IsCameraPlay();if(t.SetCameraPlay(!1),!t.IsPlaying()){for(var i=0;i<e;i++){if(s=this.GetProcessManagerByIdx(i))for(var n=0;n<s.GetProcessCount();n++){if(o=s.GetProcessByIdx(n))(a=o.GetBehaviorManager())&&a.RewindReverse()}}for(i=this.GetProcessManagerCount()-1;e<i;i--){if(s=this.GetProcessManagerByIdx(i))for(n=s.GetProcessCount()-1;0<=n;n--){var o,a;if(o=s.GetProcessByIdx(n))(a=o.GetBehaviorManager())&&a.Rewind()}}var s;if(s=this.GetProcessManagerByIdx(e)){var l=s.GetProcessIdxByID(s.GetCurProcessID());s.UpdateViewWithProcess(l)}}t.SetCameraPlay(r)},s.prototype.GetBehaviorActionChgCam=function(){return this.pBehaviorManagerChgCam},s.prototype.GetSimulationAnimationManager=function(){return this.pSA},s.prototype.SetSimulationAnimationManager=function(e){this.pSA=e},s.prototype.GetName=function(){return this.Name},s.prototype.SetName=function(e){null!=e&&(this.Name=e)},s.prototype.DeleteAllProcessManager=function(){this.ProcessManagerList=[],this.CurProcessManagerID=-1},s.prototype.GetProcessManagerCount=function(){return this.ProcessManagerList.length},s.prototype.GetPlayMode=function(){return this.PlayMode},s.prototype.SetPlayMode=function(e){this.PlayMode=e},s.prototype.GetProcessManagerList=function(){return this.ProcessManagerList},s}();P.AnimationStepManager=t}(M3D||(M3D={})),function(e){var t=function(){function e(){}return e.MakeNumArray=function(e,t){if(void 0===t&&(t=1),e<=0||t<=0)return null;for(var r=[],i=0;i<t;++i){for(var n=[],o=0;o<e;++o)n.push(0);r.push(n)}return r},e}();e.ArrayMaker=t}(M3D||(M3D={})),function(p){var e=function(){function u(e,t){void 0===e&&(e=0),void 0===t&&(t=null),this.ProcessList=[],this.ChildProcessManagerList=[],this.ID=e,this.ProcessList=[],this.CurProcessID=-1,this.Name=t||"过程"+(e+1).toString(),this.Desc="",this.pAnimationStepManager=null,this.TickCount=0,this.PreTickCount=0}return u.prototype.SetPreTickCount=function(e){this.PreTickCount=e},u.prototype.GetPreTickCount=function(){return this.PreTickCount},u.prototype.GetTickCount=function(){return this.TickCount},u.prototype.CaculateTickCount=function(){for(var e=this.TickCount=0;e<this.ProcessList.length;++e)this.ProcessList[e].SetPreTickCount(this.PreTickCount+this.TickCount),this.ProcessList[e].CaculateTickCount(),this.TickCount+=this.ProcessList[e].GetTickCount()},u.prototype.GetType=function(){return"CProcessManager"},u.prototype.GetID=function(){return this.ID},u.prototype.GetCurrentProcess=function(){return-1!=this.CurProcessID?this.FindProcessByID(this.CurProcessID):null},u.prototype.GetProcessCount=function(){return this.ProcessList.length},u.prototype.GetAnimationStepManager=function(){return this.pAnimationStepManager},u.prototype.FindProcessByID=function(e){for(var t=0;t<this.ProcessList.length;++t)if(this.ProcessList[t].GetID()==e)return this.ProcessList[t];return null},u.prototype.GetProcessByIdx=function(e){var t;return 0<this.ProcessList.length&&this.ProcessList.length>e&&(t=this.ProcessList[e]),t},u.prototype.GetProcessIdxByID=function(e){for(var t=0;t<this.ProcessList.length;++t)if(this.ProcessList[t].GetID()==e)return t;return-1},u.prototype.GetCurProcessID=function(){return this.CurProcessID},u.prototype.AddChildProcessManager=function(e){e&&(this.ChildProcessManagerList.push(e),e.SetParentProcessManager(this))},u.prototype.GetParentProcessManager=function(){return this.parentProcessManager},u.prototype.SetParentProcessManager=function(e){this.parentProcessManager=e},u.prototype.UpdateViewWithProcess=function(e){var t=this.pAnimationStepManager.GetSimulationAnimationManager(),r=t.IsCameraPlay();if(t.SetCameraPlay(!1),!t.IsPlaying()){for(var i=0;i<e;i++){if(n=this.GetProcessByIdx(i))(o=n.GetBehaviorManager())&&o.RewindReverse()}for(i=this.GetProcessCount()-1;e<i;i--){if(n=this.GetProcessByIdx(i))(o=n.GetBehaviorManager())&&o.Rewind()}var n,o;if(n=this.GetProcessByIdx(e))(o=n.GetBehaviorManager())&&(t.GetReversePlay()&&this.pAnimationStepManager.GetPlayMode()!=p.AnimationPlayMode.PLAY_MODE_NONE?o.RewindReverse():o.Rewind())}t.SetCameraPlay(r)},u.prototype.GetPreProcess=function(e){var t=null,r=this.GetProcessIdxByID(e.GetID());return 0<r&&(t=this.GetProcessByIdx(r-1)),t},u.prototype.GetNextProcess=function(e){if(!e)return null;var t=null,r=this.GetProcessIdxByID(e.GetID());return r<this.GetProcessCount()-1&&(t=this.GetProcessByIdx(r+1)),t},u.prototype.SetCurProcessByIdx=function(e,t,r,i){void 0===t&&(t=!0),void 0===r&&(r=!1),void 0===i&&(i=!1);var n=this.pAnimationStepManager.GetSimulationAnimationManager(),o=this.GetProcessByIdx(e);if(o){if(this.CurProcessID!=o.GetID()){if(this.CurProcessID=o.GetID(),this.GetAnimationStepManager())if(this.GetAnimationStepManager().GetCurProcessManagerID()!=this.ID)this.GetAnimationStepManager().SetCurProcessManagerByID(this.ID,t,r,i);else{var a=this.GetCurrentProcess();if(a&&a.UpdateView(t,r,i),t){var s=this.GetAnimationStepManager().GetProcessManagerIdxByID(this.ID);this.GetAnimationStepManager().UpdateViewWithProcessManager(s)}r&&this.GetAnimationStepManager().StartChangeCamera(o,i)}}else this.GetAnimationStepManager().GetCurProcessManagerID()!=this.ID&&this.GetAnimationStepManager().SetCurProcessManagerByID(this.ID,t,r,i);n.SetCurSAByID(o.GetBehaviorManagerID())}},u.prototype.SetCurProcessByID=function(e,t,r,i){void 0===t&&(t=!0),void 0===r&&(r=!1),void 0===i&&(i=!1);var n=this.pAnimationStepManager.GetSimulationAnimationManager();if(this.CurProcessID!=e){if(this.CurProcessID=e,this.GetAnimationStepManager())if(this.GetAnimationStepManager().GetCurProcessManagerID()!=this.ID)this.GetAnimationStepManager().SetCurProcessManagerByID(this.ID,t,r,i);else{var o=this.GetCurrentProcess();o&&o.UpdateView(t,r,i)}}else this.GetAnimationStepManager().GetCurProcessManagerID()!=this.ID&&this.GetAnimationStepManager().SetCurProcessManagerByID(this.ID,t,r,i);var a=this.GetCurrentProcess();a&&n.SetCurSAByID(a.GetBehaviorManagerID())},u.prototype.SetName=function(e){e&&(this.Name=e)},u.prototype.DeleteAllProcess=function(){this.ProcessList=[],this.CurProcessID=-1},u.prototype.SetAnimationStepManager=function(e){this.pAnimationStepManager=e},u.ProcessXMLData=function(e,t,r){var i=e.getAttribute("ID");i||(i=0);var n=e.getAttribute("Name");n||(n="Process"+(i+1));var o=e.getAttribute("Desc");o||(o="");var a=e.getAttribute("CurProcessID");a||(a=0);for(var s=t.AddProcessManager(i,n),l=0;l<e.childNodes.length;++l){var h=e.childNodes[l];if(1===h.nodeType)switch(h.nodeName){case"Process":p.Process.ProcessXMLData(h,s);break;case"ProcessManager":u.ProcessXMLData(h,t,s);break;case"ChildAnimation":p.ChildAnimation.ProcessXMLData(h,t,s)}}return r&&(r.AddChildProcessManager(s),s.SetParentProcessManager(r)),s.SetCurProcessByID(a,!1),s.SetDesc(o),s},u.prototype.AddProcess=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(1==e.length){null!=(r=e[0])&&(this.ProcessList.push(r),this.CurProcessID=r.GetID(),r.SetProcessManager(this))}else{if(2!=e.length){var r,i=e[0],n=e[1],o=e[2];if((r=this.FindProcessByID(i))&&0<i)r.SetName(n),r.DeleteAllTargetObject(),this.pAnimationStepManager&&this.pAnimationStepManager.GetSimulationAnimationManager()&&this.pAnimationStepManager.GetSimulationAnimationManager().FindSimAniByID(r.GetBehaviorManagerID())&&this.pAnimationStepManager.GetSimulationAnimationManager().FindSimAniByID(r.GetBehaviorManagerID()).DeleteAllAnimations();else{var a,s=0;this.pAnimationStepManager&&this.pAnimationStepManager.GetSimulationAnimationManager()&&(o?(s=this.pAnimationStepManager.GetSimulationAnimationManager().RegisterBehaviorManagerID(),a=this.pAnimationStepManager.GetSimulationAnimationManager().AddSimAni(s)):s=this.pAnimationStepManager.GetSimulationAnimationManager().GetCurSAID()),r=-1==i?new p.Process(this.RegisterProcessID(),s,n):new p.Process(i,s,n),a&&a.SetName(r.GetName()),this.AddProcess(r)}return r}if(e[0]&&e[1]){this.GetProcessIdxByID(e[1].GetID());this.CurProcessID=e[0].GetID(),e[0].SetProcessManager(this),e[0].Reference()}}},u.prototype.RegisterProcessID=function(){for(var e=0,t=0;t<this.ProcessList.length;++t)this.ProcessList[t].GetID()>=e&&(e=this.ProcessList[t].GetID()+1);return e},u.prototype.GetProcessList=function(){return this.ProcessList},u.prototype.GetName=function(){return this.Name},u.prototype.SetDesc=function(e){this.Desc=e},u.prototype.GetDesc=function(){return this.Desc},u}();p.ProcessManager=e}(M3D||(M3D={})),function(c){var e=function(l){function p(e,t,r){var i=l.call(this,t,r)||this;return i.m_iReferenceProcessManagerID=e,i.m_pReferenceProcessManager=null,i}return __extends(p,l),p.prototype.GetReferenceProcessManager=function(){return this.m_pReferenceProcessManager},p.prototype.AddProcess=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(3===e.length){var r=e[0],i=e[1],n=e[2],o=null,a=null;if(this.pAnimationStepManager&&(a=this.pAnimationStepManager.GetSimulationAnimationManager()),!a)return o;if(!this.m_pReferenceProcessManager)return o;var s=this.m_pReferenceProcessManager.AddProcess(r,i,n);return s&&((o=this.FindProcessByID(r))&&0<r?(o.SetName(i),o.DeleteAllTargetObject(),a&&a.FindSimAniByID(o.GetBehaviorManagerID()).DeleteAllAnimations()):(o=-1==r?new c.ChildAnimationProcess(this.RegisterProcessID(),s.GetID(),i):new c.ChildAnimationProcess(r,s.GetID(),i))&&(l.prototype.AddProcess.call(this,o),o.SetReferenceProcess(s,!0))),o}1===e.length?l.prototype.AddProcess.call(this,e[0]):2===e.length&&l.prototype.AddProcess.call(this,e[0],e[1])},p.prototype.AddChildProcessManager=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(2===e.length){var r=e[0],i=e[1],n=null;if((n=this.GetAnimationStepManager().FindProcessManagerByID(r))&&0<r)n.SetName(i),n.DeleteAllProcess();else{var o=this.m_pReferenceProcessManager.GetAnimationStepManager().AddProcessManager(-1,i);if(this.m_pReferenceProcessManager.AddChildProcessManager(o),o){var a=r;-1==a&&(a=this.GetAnimationStepManager().RegisterProcessManagerID()),(n=new p(o.GetID(),a,i)).SetReferenceProcessManager(o),l.prototype.AddChildProcessManager.call(this,n),this.GetAnimationStepManager().AddProcessManager(n)}}return n}1===e.length&&l.prototype.AddChildProcessManager.call(this,e[0])},p.ProcessXMLData=function(e,t,r){var i=e.getAttribute("ID");i||(i=0);var n=e.getAttribute("Name");n||(n="Process"+(i+1));var o=e.getAttribute("Desc");o||(o="");var a=e.getAttribute("CurProcessID");a||(a=0);var s=e.getAttribute("RefProcessManager");s||(s=0);var l=null;l=new p(s,0===i?t.RegisterProcessManagerID():i,n),r&&(t=r.GetAnimationStepManager()),t.AddProcessManager(l);for(var h=0;h<e.childNodes.length;++h){var u=e.childNodes[h];if(1===u.nodeType)switch(u.nodeName){case"Process":c.Process.ProcessXMLData(u,l);break;case"ProcessManager":c.ProcessManager.ProcessXMLData(u,t,l);break;case"ChildAnimation":c.ChildAnimation.ProcessXMLData(u,t,l);break;case"ChildAnimationProcess":c.ChildAnimationProcess.ProcessXMLData(u,l)}}return r&&(r.AddChildProcessManager(l),l.SetParentProcessManager(r)),l.SetCurProcessByID(a,!1),l.SetDesc(o),l.Load(),l},p.prototype.GetChildAnimation=function(){for(var e=null,t=this.GetParentProcessManager();t;){if(t instanceof c.ChildAnimation){e=t;break}t=t.GetParentProcessManager()}return e},p.prototype.GetType=function(){return"ChildAnimationProcessManager"},p.prototype.SetReferenceProcessManager=function(e){this.m_pReferenceProcessManager&&this.m_pReferenceProcessManager!=e&&(this.m_pReferenceProcessManager=null),this.m_pReferenceProcessManager!=e&&(this.m_iReferenceProcessManagerID=e.GetID(),this.m_pReferenceProcessManager=e),this.m_pReferenceProcessManager&&"ChildAnimationProcessManager"===this.m_pReferenceProcessManager.GetType()&&(this.m_pReferenceProcessManager=this.m_pReferenceProcessManager.GetReferenceProcessManager(),this.m_iReferenceProcessManagerID=this.m_pReferenceProcessManager.GetID())},p.prototype.IsLoaded=function(){return!!this.m_pReferenceProcessManager},p.prototype.Load=function(){var e=this.GetChildAnimation();if(!e)return this.IsLoaded();if(!e.IsLoaded())return e.Load();var t=e.GetReferenceSAManager();t&&(this.m_pReferenceProcessManager=t.GetAnimationStepManager().FindProcessManagerByID(this.m_iReferenceProcessManagerID));for(var r=0;r<this.ChildProcessManagerList.length;r++)this.ChildProcessManagerList[r].Load();for(r=0;r<this.ProcessList.length;r++)this.ProcessList[r].Load();return this.IsLoaded()},p}(c.ProcessManager);c.ChildAnimationProcessManager=e}(M3D||(M3D={})),function(d){var e=function(s){function c(e,t,r,i){var n=s.call(this,r,i)||this;return e&&(n.m_InstancePlcPath=e),t&&(n.m_strSAFile=t),n.m_pReferenceSAManager=null,n.m_bEdited=!1,n}return __extends(c,s),c.prototype.GetInstancePlcPath=function(){return this.m_InstancePlcPath},c.prototype.GetSAFileName=function(){return this.m_strSAFile},c.prototype.SetSAFileName=function(e){e&&(this.m_strSAFile=e)},c.prototype.GetReferenceSAManager=function(){return this.m_pReferenceSAManager},c.prototype.Reference=function(){},c.prototype.Release=function(){},c.prototype.DeleteProcess=function(e){this.SetEdited(!0)},c.prototype.DeleteAllProcess=function(){this.SetEdited(!0),s.prototype.DeleteAllProcess.call(this)},c.prototype.GetType=function(){return"ChildAnimation"},c.prototype.MoveProcess=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return e[0]instanceof d.Process&&(e[1],d.Process),void this.SetEdited(!0)},c.prototype.EraseProcess=function(e){this.SetEdited(!0)},c.prototype.MoveProcessToFirst=function(e,t){this.SetEdited(!0)},c.prototype.AddProcess=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];2==e.length?(s.prototype.AddProcess.call(this,e[0],e[1]),this.SetEdited(!0)):1==e.length?s.prototype.AddProcess.call(this,e[0]):s.prototype.AddProcess.call(this,e[0],e[1],e[2])},c.prototype.DeleteAllChildProcessManager=function(e){},c.prototype.DeleteChildProcessManager=function(e,t){},c.prototype.AddChildProcessManager=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(2===e.length){var r=e[0],i=e[1],n=null;if((n=this.GetAnimationStepManager().FindProcessManagerByID(r))&&0<r)n.SetName(i),n.DeleteAllProcess();else{var o=this.m_pReferenceSAManager.GetAnimationStepManager().AddProcessManager(-1,i);if(o){var a=r;-1==a&&(a=this.GetAnimationStepManager().RegisterProcessManagerID()),(n=new d.ChildAnimationProcessManager(o.GetID(),a,i)).SetReferenceProcessManager(o),s.prototype.AddChildProcessManager.call(this,n),this.GetAnimationStepManager().AddProcessManager(n)}}return n}this.SetEdited(!0),s.prototype.AddChildProcessManager.call(this,e[0])},c.prototype.MoveChildProcessManager=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];e[0],d.ProcessManager},c.prototype.MoveChildProcessManagerToFirst=function(e,t){},c.ProcessXMLData=function(e,t,r){var i=e.getAttribute("ID");i||(i=0);var n=e.getAttribute("Name");n||(n="Process"+(i+1));var o=e.getAttribute("Desc");o||(o="");var a=e.getAttribute("CurProcessID");a||(a=0);var s=e.getAttribute("Instance");s||(s="");var l=e.getAttribute("RefSAFile");l||(l="");var h=null;h=new c(s,l,0===i?t.RegisterProcessManagerID():i,n),r&&(t=r.GetAnimationStepManager()),t.AddProcessManager(h);for(var u=0;u<e.childNodes.length;++u){var p=e.childNodes[u];if(1===p.nodeType)switch(p.nodeName){case"Process":d.Process.ProcessXMLData(p,h);break;case"ProcessManager":d.ProcessManager.ProcessXMLData(p,t,h);break;case"ChildAnimation":c.ProcessXMLData(p,t,h);break;case"ChildAnimationProcessManager":d.ChildAnimationProcessManager.ProcessXMLData(p,t,h)}}return r&&(r.AddChildProcessManager(h),h.SetParentProcessManager(r)),h.SetCurProcessByID(a,!1),h.SetDesc(o),h.Load(),h},c.prototype.IsLoaded=function(){return!!this.m_pReferenceSAManager},c.prototype.SetReferenceSAManager=function(e){this.m_pReferenceSAManager&&this.m_pReferenceSAManager!=e&&(this.m_pReferenceSAManager=null),this.m_pReferenceSAManager!=e&&(this.m_pReferenceSAManager=e)},c.prototype.Load=function(){if(this.IsLoaded())return!0;var e=this.GetAnimationStepManager().GetSimulationAnimationManager(),t=this.m_strSAFile,r=e.FindChildSAManagerBySAFileName(t);if(!r){var i="ChildrenAnimation/";(r=new d.SimulationAnimationManager).SetTempFilePath(i);var n,o=i+t;n=e.pChildSAManagerStr[o],r.ProcessXMLData(n),e.AddChildSAManager(r)}this.m_pReferenceSAManager=r;for(var a=0;a<this.ChildProcessManagerList.length;a++)this.ChildProcessManagerList[a]instanceof c?this.ChildProcessManagerList[a].Load():this.ChildProcessManagerList[a]instanceof d.ChildAnimationProcessManager&&this.ChildProcessManagerList[a].Load();return this.SetEdited(!1),this.IsLoaded()},c.prototype.SaveAs=function(e){},c.prototype.SetEdited=function(e){if(this.m_bEdited=e){var t=this.GetParentChildAnimation();t&&t.SetEdited(e)}},c.prototype.GetParentChildAnimation=function(){var e=null;return this.parentProcessManager&&"ChildAnimation"===this.parentProcessManager.GetType()&&(e=this.parentProcessManager),e},c}(d.ProcessManager);d.ChildAnimation=e}(M3D||(M3D={})),function(G){var e=function(){function e(e,t,r){this.TargetObjectList=new Array,this.ID=e,this.Name=r||"Step "+(e+1).toString(),this.Desc="",this.nBehaviorManagerID=t,this.TickCount=0,this.PreTickCount=0,this.pProcessManager=null,this.m_bRecCam=!0,this.m_bRecIns=!0,this.m_bRecOnlySelIns=!0}return e.prototype.IsRecCam=function(){return this.m_bRecCam},e.prototype.SetIsRecCam=function(e){this.m_bRecCam=e},e.prototype.IsRecIns=function(){return this.m_bRecIns},e.prototype.SetIsRecIns=function(e){this.m_bRecIns=e},e.prototype.IsRecOnlySelIns=function(){return this.m_bRecOnlySelIns},e.prototype.SetIsRecOnlySelIns=function(e){this.m_bRecOnlySelIns=e},e.prototype.SetPreTickCount=function(e){this.PreTickCount=e},e.prototype.GetPreTickCount=function(){return this.PreTickCount},e.prototype.GetTickCount=function(){return this.TickCount},e.prototype.CaculateTickCount=function(){var e=this.GetBehaviorManager();this.TickCount=e?e.GetTickCount():0},e.prototype.SetBehaviorManagerID=function(e){this.nBehaviorManagerID=e},e.ProcessXMLData=function(e,t){var r=e.getAttribute("ID");r||(r=0);var i=e.getAttribute("Name");i||(i="Step"+(r+1));var n=e.getAttribute("Desc");n||(n="");var o=!0;e.getAttribute("RecCam")&&(o=1===e.getAttribute("RecCam"));var a=!0;e.getAttribute("RecIns")&&(a=1===e.getAttribute("RecIns"));var s=!0;e.getAttribute("RecIns")&&(s=1===e.getAttribute("RecIns"));var l=e.getAttribute("BehavivorManagerID");l||(l=0);var h=t.AddProcess(r,i,!1);h.SetBehaviorManagerID(l),h.SetIsRecCam(o),h.SetIsRecIns(a),h.SetIsRecOnlySelIns(s),h.SetDesc(n);for(var u=0;u<e.childNodes.length;++u){var p=e.childNodes[u];if(1===p.nodeType)switch(p.nodeName){case"ProcessTargetObject":G.ProcessTargetObject.ProcessXMLData(p,h)}}return h},e.prototype.GetID=function(){return this.ID},e.prototype.SetID=function(e){this.ID=e},e.prototype.GetBehaviorManagerID=function(){return this.nBehaviorManagerID},e.prototype.GetBehaviorManager=function(){var e;return this.pProcessManager&&this.pProcessManager.GetAnimationStepManager()&&this.pProcessManager.GetAnimationStepManager().GetSimulationAnimationManager()&&(e=this.pProcessManager.GetAnimationStepManager().GetSimulationAnimationManager().FindSimAniByID(this.nBehaviorManagerID)),e},e.prototype.FindTargetObjectByID=function(e){for(var t=0;t<this.TargetObjectList.length;++t)if(e==this.TargetObjectList[t].GetTargetKey())return this.TargetObjectList[t];return null},e.prototype.GetType=function(){return"Process"},e.prototype.SetProcessManager=function(e){this.pProcessManager=e},e.prototype.GetName=function(){return this.Name},e.prototype.GetProcessManager=function(){return this.pProcessManager},e.prototype.TargetObject2StructInfo=function(e,t){if(e){if(t.Name=e.GetName(),t.ID=e.GetTargetKey(),t.Path=e.GetPath(),"PLCID"==e.GetType())t.InsPath=e.GetResolvedPath(),t.EntId=0;else if("PMI"==e.GetType()){var r=e.GetInsPathAndPMIIdByResolvedPath(t.InsPath);t.EntId=parseFloat(r)}t.Pos[0]=e.GetPos().x,t.Pos[1]=e.GetPos().y,t.Pos[2]=e.GetPos().z,t.Quat[0]=e.GetQuat().x,t.Quat[1]=e.GetQuat().y,t.Quat[2]=e.GetQuat().z,t.Quat[3]=e.GetQuat().w,t.Scale[0]=e.GetScale().x,t.Scale[1]=e.GetScale().y,t.Scale[2]=e.GetScale().z,t.bVisible=e.GetVisible(),t.Trans=e.GetTrans(),"PLCID"==e.GetType()?t.Type=G.TargetObjectType.TARGETOBJECT_TYPE_INS:"CAMERA"==e.GetType()?t.Type=G.TargetObjectType.TARGETOBJECT_TYPE_CAM:"PMI"==e.GetType()?t.Type=G.TargetObjectType.TARGETOBJECT_TYPE_PMI:"IMAGE"==e.GetType()&&(t.Type=G.TargetObjectType.TARGETOBJECT_TYPE_IMAGE)}},e.prototype.UpdateView=function(e,t,r){void 0===e&&(e=!0),void 0===t&&(t=!1),void 0===r&&(r=!1);var i=this.GetProcessManager().GetAnimationStepManager();if(i){var n=this.GetProcessManager().GetAnimationStepManager().GetSimulationAnimationManager(),o=n.IsCameraPlay();n.SetCameraPlay(!1);var a=!1;n.IsPlaying()&&(i.Pause(),a=!0);for(var s,l=new Array,h=n.GetInitTargetObjectList(),u=0;u<h.length;u++){if("PLCID"!==(s=h[u]).GetType()||this.m_bRecIns){var p,c=s.GetCameraType();if(!(c==G.HBhvCameraType.NoCamera&&!e||c!=G.HBhvCameraType.NoCamera&&!t||c!=G.HBhvCameraType.NoCamera&&t&&r))if(p=this.FindTargetObjectByID(s.GetTargetKey())){var d=new G.TargetObjectInfo;this.TargetObject2StructInfo(p,d),l.push(d)}else{d=new G.TargetObjectInfo;this.TargetObject2StructInfo(s,d),l.push(d)}}}for(var S=0;S<this.TargetObjectList.length;S++){var f=this.TargetObjectList[S];if("IMAGE"===f.GetType()){var m=new G.TargetObjectInfo;this.TargetObject2StructInfo(f,m),l.push(d)}}if(n.GetAnimationPlayApi()&&e){if(G.M3DTOOLS.VersionCompare(n.GetVersion(),"2.6")<=0){for(var y=[],T=0;T<l.length;T++){0===(g=l[T]).Type&&!1===g.bVisible&&y.push(g)}for(var M=0;M<l.length;M++){var g;if(0===(g=l[M]).Type){for(var v=!1,C=g.InsPath,_=0;_<y.length;_++){var A=y[_].InsPath;if(A!==C&&A===C.substr(0,A.length)&&"\\"===C.substr(A.length,1)){v=!0;break}}v&&n.GetVersion()&&(g.bVisible=!1)}}}n.GetAnimationPlayApi().SetTargetState(l)}for(u=0;u<l.length;u++)delete l[u];if(l=[],e||t){t&&!r&&n.SetCameraPlay(!0);var E=this.GetBehaviorManager();E&&(n.GetReversePlay()&&i.GetPlayMode()!=G.AnimationPlayMode.PLAY_MODE_NONE?E.RewindReverse():E.Rewind())}n.SetCameraPlay(o),t&&r&&this.m_bRecCam?i.StartChangeCamera(this,!0):a&&i.Play(i.GetPlayMode())}},e.prototype.GetSimulationAnimationManager=function(){var e;return this.GetProcessManager()&&(e=this.GetProcessManager().GetAnimationStepManager()),e?e.GetSimulationAnimationManager():null},e.prototype.GetCamera=function(e,t,r){var i=!1;e=new G.Vector3(0,0,0),t=new G.Quaternion(0,0,0,0),new G.Vector3(0,0,0);var n=this.GetBehaviorManager();if(n){var o;o=G.TARGETOBJECTTYPE_CAM,o+=":SCENE/TARGET";var a=n.FindAnimation(o,G.INTERPOLATOR_POS);if(a&&a.GetTimeline()&&0<a.GetTimeline().GetTimelineArrayLength()){var s=0;this.GetSimulationAnimationManager().GetReversePlay()&&(s=a.GetTimeline().GetTimelineArrayLength()-1);for(var l=a.GetInterpolatorList(),h=0;h<l.length;++h)l[h].GetType()==G.INTERPOLATOR_POS?e=l[h].GetAt(s).cp:l[h].GetType()==G.INTERPOLATOR_QUATROT?t=l[h].GetAt(s).quat:l[h].GetType()==G.INTERPOLATOR_SCALE&&l[h].GetAt(s).cp;var u=G.ArrayMaker.MakeNumArray(4,4);t.ToMatrix(u),u[3][0]=e.x,u[3][1]=e.y,u[3][2]=e.z,G.MatrixOperation.MatrixInversion(u),t=G.Quaternion.MatrixToQuaternion(u),e.x=u[3][0],e.y=u[3][1],e.z=u[3][2],i=!0}}if(!i){var p=this.GetCameraTargetObject(!1);p&&(e=p.GetPos(),t=p.GetQuat(),p.GetScale(),i=!0)}return i},e.prototype.GetCameraTargetObject=function(e){var t;G.TARGETOBJECTTYPE_CAM,t=":SCENE/TARGET";var r=this.FindTargetObjectByPath(t);return!r&&e&&(r=this.CreateTargetObjectByPath("Camera",t)),r},e.prototype.FindTargetObjectByPath=function(e){for(var t=0;t<this.TargetObjectList.length;++t){var r=this.TargetObjectList[t];if(r.IsEqual(e))return r}return null},e.prototype.CreateTargetObjectByPath=function(e,t){var r;return(r=this.FindTargetObjectByPath(t))||(r=new G.ProcessTargetObject(this,e,t),this.AddTargetObject(r)),r},e.prototype.AddTargetObject=function(e){this.TargetObjectList.push(e)},e.prototype.SetName=function(e){e&&(this.Name=e,this.GetBehaviorManager()&&this.GetBehaviorManager().SetName(e))},e.prototype.DeleteAllTargetObject=function(){this.TargetObjectList=[]},e.prototype.SetDesc=function(e){this.Desc=e},e.prototype.GetDesc=function(){return this.Desc},e}();G.Process=e}(M3D||(M3D={})),function(f){var e=function(n){function h(e,t,r){var i=n.call(this,e,-1,r)||this;return i.m_iReferenceProcessID=t,i.m_pReferenceProcess=null,i}return __extends(h,n),h.prototype.SetName=function(e){this.Name=e,this.m_pReferenceProcess&&this.m_pReferenceProcess.SetName(e)},h.prototype.SetDesc=function(e){e&&(this.Desc=e,this.m_pReferenceProcess&&this.m_pReferenceProcess.SetDesc(e))},h.ProcessXMLData=function(e,t){var r=e.getAttribute("ID");r||(r=0);var i=e.getAttribute("Name");i||(i="Step"+(r+1));var n=e.getAttribute("Desc");n||(n="");var o=e.getAttribute("RefProcess");o||(o=0);var a=new h(r,o,i);t.AddProcess(a),a.GetBehaviorManager()&&(i=a.GetBehaviorManager().GetName())&&""!=i&&a.SetName(i),a.SetDesc(n);for(var s=0;s<e.childNodes.length;++s){var l=e.childNodes[s];if(1===l.nodeType)switch(l.nodeName){case"ProcessTargetObject":f.ProcessTargetObject.ProcessXMLData(l,a)}}return a},h.prototype.GetBehaviorManager=function(){var e;return this.pProcessManager&&this.pProcessManager.GetAnimationStepManager()&&this.pProcessManager.GetAnimationStepManager().GetSimulationAnimationManager()&&(e=this.pProcessManager.GetAnimationStepManager().GetSimulationAnimationManager().FindSimAniByID(this.nBehaviorManagerID)),e},h.prototype.GetChildAnimation=function(){var e=null;return this.pProcessManager&&(e=this.pProcessManager.GetChildAnimation()),e},h.prototype.UpdateTargetList=function(e){},h.prototype.TargetObject2ReferenceProcessStructInfo=function(e,t){var r=null;if(e&&e.GetType()===f.TARGETOBJECTTYPE_INS){var i=e.GetResolvedPath();i!=t&&0==i.indexOf(t)&&(r=new f.TargetObjectInfo,i="PLCID:"+i.substr(t.length+1),r.Path=i,r.Name=e.GetName(),r.ID=e.GetTargetKey(),r.Pos[0]=e.GetPos().x,r.Pos[1]=e.GetPos().y,r.Pos[2]=e.GetPos().z,r.Quat[0]=e.GetQuat().x,r.Quat[1]=e.GetQuat().y,r.Quat[2]=e.GetQuat().z,r.Quat[3]=e.GetQuat().w,r.Scale[0]=e.GetScale().x,r.Scale[1]=e.GetScale().y,r.Scale[2]=e.GetScale().z,r.bVisible=e.GetVisible(),r.Trans=e.GetTrans(),e.GetType()===f.TARGETOBJECTTYPE_INS?r.Type=f.TargetObjectType.TARGETOBJECT_TYPE_INS:e.GetType()===f.TARGETOBJECTTYPE_CAM?r.Type=f.TargetObjectType.TARGETOBJECT_TYPE_CAM:e.GetType()===f.TARGETOBJECTTYPE_PMI?r.Type=f.TargetObjectType.TARGETOBJECT_TYPE_PMI:e.GetType()===f.TARGETOBJECTTYPE_IMAGE&&(r.Type=f.TargetObjectType.TARGETOBJECT_TYPE_IMAGE))}return r},h.prototype.UpdateView=function(e,t,r){e&&!this.IsLoad()&&this.Load();var i=this.GetProcessManager().GetAnimationStepManager();if(i){var n=this.GetProcessManager().GetAnimationStepManager().GetSimulationAnimationManager(),o=n.IsCameraPlay();n.SetCameraPlay(!1),n.IsPlaying()&&n.StopAll();for(var a,s=new Array,l=n.GetInitTargetObjectList(),h=0;h<l.length;h++){var u=(a=l[h]).GetCameraType();if(!(u==f.HBhvCameraType.NoCamera&&!e||u!=f.HBhvCameraType.NoCamera&&!t||u!=f.HBhvCameraType.NoCamera&&t&&r)){var p=null;if(0<this.TargetObjectList.length){if(p=this.FindTargetObjectByID(a.GetTargetKey())){var c=new f.TargetObjectInfo;this.TargetObject2StructInfo(p,c),s.push(c)}}else if(this.m_pReferenceProcess&&(p=this.m_pReferenceProcess.FindTargetObjectByID(a.GetTargetKey()))){c=new f.TargetObjectInfo;this.TargetObject2StructInfo(p,c),c.InsPath=this.pProcessManager.GetChildAnimation().GetInstancePlcPath(),c.InsPath=c.InsPath+"\\",c.InsPath=c.InsPath+p.GetResolvedPath(),s.push(c)}if(!p){c=new f.TargetObjectInfo;this.TargetObject2StructInfo(a,c),s.push(c)}}}n.GetAnimationPlayApi()&&0<s.length&&e&&n.GetAnimationPlayApi().SetTargetState(s);for(var d=0;d<s.length;d++)delete s[d];if(s=[],e||t){t&&!r&&n.SetCameraPlay(!0);var S=this.GetBehaviorManager();S&&i.GetPlayMode()!=f.AnimationPlayMode.PLAY_MODE_NONE&&(n.GetReversePlay()?S.RewindReverse():S.Rewind())}n.SetCameraPlay(o),t&&r&&i.StartChangeCamera(this,!0)}},h.prototype.SetReferenceProcess=function(e,t){if(this.m_pReferenceProcess&&this.m_pReferenceProcess!=e&&(this.m_pReferenceProcess=null),this.m_pReferenceProcess!=e&&(this.m_iReferenceProcessID=e.GetID(),this.m_pReferenceProcess=e),t){var r=this.GetSimulationAnimationManager();if(!r)return;var i=this.GetBehaviorManager();i&&(r.DeleteSimAni(i),this.SetBehaviorManagerID(null)),this.m_pReferenceProcess&&r&&("ChildAnimationProcess"===this.m_pReferenceProcess.GetType()&&(this.m_pReferenceProcess=this.m_pReferenceProcess.GetReferenceProcess(),this.m_iReferenceProcessID=this.m_pReferenceProcess.GetID()),i=new f.ChildAnimationHbhvBehaviorManager(r.RegisterBehaviorManagerID(),this.m_pReferenceProcess.GetBehaviorManager(),this.GetChildAnimation().GetInstancePlcPath()),this.nBehaviorManagerID=i.GetID(),r.AddSimAni(i))}},h.prototype.Load=function(){if(!this.pProcessManager.IsLoaded())return this.pProcessManager.Load();if(this.pProcessManager&&(this.m_pReferenceProcess=this.pProcessManager.GetReferenceProcessManager().FindProcessByID(this.m_iReferenceProcessID),this.m_pReferenceProcess)){var e=this.GetSimulationAnimationManager(),t=new f.ChildAnimationHbhvBehaviorManager(e.RegisterBehaviorManagerID(),this.m_pReferenceProcess.GetBehaviorManager(),this.GetChildAnimation().GetInstancePlcPath());e.AddSimAni(t),this.nBehaviorManagerID=t.GetID()}return!0},h.prototype.IsLoad=function(){return!!this.m_pReferenceProcess},h.prototype.GetType=function(){return"ChildAnimationProcess"},h.prototype.GetReferenceProcess=function(){return this.m_pReferenceProcess},h.prototype.SetReferenceProcessID=function(e){this.m_iReferenceProcessID=e},h.prototype.GetReferenceProcessID=function(){return this.m_iReferenceProcessID},h}(f.Process);f.ChildAnimationProcess=e}(M3D||(M3D={})),function(e){var n,t;(t=n=e.HTCStyle||(e.HTCStyle={}))[t.HTCS_Invalid=0]="HTCS_Invalid",t[t.HTCS_Once=1]="HTCS_Once",t[t.HTCS_Periodic=2]="HTCS_Periodic",t[t.HTCS_PeriodicSkip=3]="HTCS_PeriodicSkip";var r=function(){function e(e,t,r,i){void 0===e&&(e=.1),void 0===t&&(t=n.HTCS_Invalid),void 0===r&&(r=null),void 0===i&&(i=null),this.mt_interval=e,this.mt_style=t,this.mt_next_request=0,this.mt_priority=0}return e.prototype.SetInterval=function(e){this.mt_interval=e},e.prototype.SetStyle=function(e){this.mt_style=e},e.prototype.SetNextRequest=function(e){this.mt_next_request=e},e.prototype.GetNextRequest=function(){return this.mt_next_request},e.prototype.GetPriority=function(){return this.mt_priority},e.prototype.GetInterval=function(){return this.mt_interval},e.prototype.GetStyle=function(){return this.mt_style},e.prototype.Tick=function(e,t){return!0},e}();e.HTClient=r}(M3D||(M3D={})),function(p){var e;(e=p.AnimationType||(p.AnimationType={}))[e.AT_PART=0]="AT_PART",e[e.AT_GROUP=1]="AT_GROUP";var t=function(s){function e(e,t,r,i,n,o){void 0===t&&(t=10),void 0===r&&(r=0),void 0===i&&(i=""),void 0===n&&(n=""),void 0===o&&(o="");var a=s.call(this)||this;return i&&(a.Name=i),a.Tps=0<t?t:10,a.AnimationList=[],a.ScheduledAnimationList=[],a.TargetObjectList=[],a.Delay=r,a.StartTime=0,a.CurrentTick=0,a.PreTick=0,a.bPlaying=!1,a.LastTick=0,a.FirstTick=0,a.bRenderEveryFrame=!1,a.bUpdateCamera=!0,a.bContinuousPlay=!1,a.bCameraUpdated=!1,a.bInfinitePlay=!1,a.bMerge=!1,a.bShellSelectionActive=!1,a.bReversePlay=!1,a.ID=e,a.ReferenceCount=0,a.bPlaybackIsInterrupted=!1,a.bPlayRangeSign=!1,a.fPlayBeginTick=0,a.fPlayEndTick=0,a.fCollisionTime=0,a.Company=o,a.Version=n,a}return __extends(e,s),e.ProcessXMLData=function(e,t){for(var r=e.getAttribute("ID"),i=e.getAttribute("Name"),n=e.getAttribute("TicksPerSecond"),o=e.getAttribute("Delay"),a=e.getAttribute("Version"),s=e.getAttribute("Company"),l=t.AddSimAni(r,n,o,i,a,s),h=0;h<e.childNodes.length;++h){var u=e.childNodes[h];if(1===u.nodeType)switch(u.nodeName){case"TargetObject":p.HBhvTargetObject.ProcessXMLData(u,l);break;case"Animation":p.HBhvAnimation.ProcessXMLData(u,l)}}return l},e.prototype.AddAnimation=function(e){this.AnimationList.push(e)},e.prototype.GetTickCount=function(){for(var e,t,r=0;r<this.AnimationList.length;++r)if(0==r)e=this.AnimationList[r].GetFirstTick(),t=this.AnimationList[r].GetLastTick();else{var i=this.AnimationList[r].GetFirstTick(),n=t=this.AnimationList[r].GetLastTick();i<e&&(e=i),t<n&&(t=n)}return t-e},e.prototype.GetID=function(){return this.ID},e.prototype.SetName=function(e){this.Name=e},e.prototype.GetName=function(){return this.Name},e.prototype.SetTicksPerSecond=function(e){this.Tps=e},e.prototype.DeleteAllAnimations=function(){},e.prototype.CreateTargetObjectByPath=function(e,t){var r;return(r=this.FindTargetObjectByPath(t))||(r=new p.HBhvTargetObject(this,e,t),this.AddTargetObject(r)),r},e.prototype.GetTargetObjectByKey=function(e){for(var t=0;t<this.TargetObjectList.length;++t)if(this.TargetObjectList[t].GetTargetKey()==e)return this.TargetObjectList[t];return null},e.prototype.IsReversePlay=function(){return this.bReversePlay},e.prototype.FindTargetObjectByPath=function(e){for(var t=0;t<this.TargetObjectList.length;++t)if(this.TargetObjectList[t].IsEqual(e))return this.TargetObjectList[t];return null},e.prototype.AddTargetObject=function(e){this.TargetObjectList.push(e)},e.prototype.RegisterTargetObjectKey=function(){for(var e=0,t=0;t<this.TargetObjectList.length;++t)this.TargetObjectList[t].GetTargetKey()>=e&&(e=this.TargetObjectList[t].GetTargetKey()+1);return e},e.prototype.GetSimulationAnimationManager=function(){return this.pSimulationAnimationManager},e.prototype.SetSimulationAnimationManager=function(e){this.pSimulationAnimationManager=e},e.prototype.IsPlaying=function(){return this.bPlaying},e.prototype.HasAnimations=function(){return 0!=this.AnimationList.length},e.prototype.Clone=function(e){e.SetName(this.Name),e.fPlayBeginTick=this.fPlayBeginTick,e.fPlayEndTick=this.fPlayEndTick,e.bInfinitePlay=this.bInfinitePlay,e.bContinuousPlay=this.bContinuousPlay;for(var t=0;t<this.TargetObjectList.length;t++){var r=this.TargetObjectList[t];e.CreateTargetObjectByPath(r.Name,r.Path)}for(t=0;t<this.AnimationList.length;t++){if(!(r=this.AnimationList[t]).GetParentAnimation()){var i=r.Clone(e);i&&(i.SetBehaviorManager(e),i.SetTargetByPath(r.GetName(),r.GetTarget().Path),i.GetTarget()&&r.GetTarget()&&i.GetTarget().SetPivot(r.GetTarget().GetPivot()),e.AddAnimation(i))}}return e},e.prototype.GetType=function(){return"HBhvBehaviorManager"},e.prototype.ContinueReverse=function(){this.pSimulationAnimationManager.SetCurSAByID(this.ID),this.GetAnimationPlayApi()&&this.GetAnimationPlayApi().PlayBegin(),this.bPlaybackIsInterrupted=!1,this.bReversePlay=!0,this.IsAtStartTick()||this.GetLastTick()<this.GetCurrentTick()?this.RewindReverse():this.IsAtFinalTick()&&(this.IsPlaying()&&this.Stop(),this.ScheduleAllAnimations(!0),this.ExecuteAnimations(this.GetCurrentTick(),0)),this.Play(),this.StartTime-=(this.GetLastTick()-this.GetCurrentTick())/this.GetTicksPerSecond()},e.prototype.SetCurrentTickByTime=function(e){this.bReversePlay?this.CurrentTick=this.GetLastTick()-(e-this.StartTime)*this.GetTicksPerSecond():this.CurrentTick=(e-this.StartTime)*this.GetTicksPerSecond()},e.prototype.SetCurrentTickByPercentage=function(e){this.ScheduledAnimationList.length<0&&this.ScheduleAllAnimations(!0);var t=this.GetLastTick()-this.GetFirstTick();0===t&&(t=1),this.CurrentTick=e/100*t+this.GetFirstTick()},e.prototype.GetCurrentTickByPercentage=function(){if(0<this.LastTick&&0<this.CurrentTick&&this.CurrentTick>=this.LastTick)return 100;this.ScheduledAnimationList.length<=0&&(this.ScheduleAllAnimations(!0),this.FirstTick=this.GetFirstTick()),this.LastTick=this.GetLastTick();var e=this.LastTick-this.FirstTick;return e<=0?0:(this.CurrentTick-this.FirstTick)/e*100},e.prototype.Tick=function(e,t){if(this.PreTick=this.CurrentTick,this.bReversePlay)if(this.CurrentTick<=this.FirstTick&&!this.bInfinitePlay){if(!this.bContinuousPlay)return this.CurrentTick=this.FirstTick,this.Stop(),this.pSimulationAnimationManager.GetAnimationStepManager(),!0;this.ScheduleAllAnimations(),this.CurrentTick=this.GetLastTick(),this.ExecuteAnimations(this.CurrentTick,0);r=new Date;this.StartTime=r.getTime()/1e3,this.StartTime-=(this.GetLastTick()-this.GetCurrentTick())/this.GetTicksPerSecond()}else this.bRenderEveryFrame?this.CurrentTick--:this.SetCurrentTickByTime(t);else if(this.CurrentTick>=this.LastTick&&!this.bInfinitePlay){if(!this.bContinuousPlay)return this.CurrentTick=this.LastTick,this.Stop(),this.pSimulationAnimationManager.GetAnimationStepManager()&&this.pSimulationAnimationManager.GetAnimationStepManager().PlayFinishCB(this),!0;this.ScheduleAllAnimations(),this.CurrentTick=this.GetFirstTick(),this.ExecuteAnimations(this.CurrentTick,0);var r=new Date;this.StartTime=r.getTime()/1e3,this.StartTime-=this.GetCurrentTick()/this.GetTicksPerSecond()}else this.bRenderEveryFrame?this.CurrentTick++:this.SetCurrentTickByTime(t);return this.ExecuteAnimations(this.GetCurrentTick(),-1),!0},e.prototype.FindAnimation=function(e,t,r){void 0===r&&(r=!1);for(var i=0;i<this.AnimationList.length;++i)if(null==t){if(!this.AnimationList[i].GetInterpolator()&&this.AnimationList[i].GetTarget().IsEqual(e))return this.AnimationList[i]}else if(this.AnimationList[i].GetTarget().IsEqual(e)){var n=!1;if(!r&&this.AnimationList[i].GetInterpolator(t))n=!0;else if(r){var o=this.AnimationList[i].GetInterpolator();o&&o.GetType()==t&&(n=!0)}if(n)return this.AnimationList[i]}return null},e.prototype.Stop=function(e){void 0===e&&(e=!1),this.bPlaybackIsInterrupted=e,this.IsPlaying()&&this.GetAnimationPlayApi()&&(p.HTManager.GetHTManager().UnRegisterClient(this),this.bPlaying=!1,this.bCameraUpdated=!1,this.GetAnimationPlayApi().PlayEnd(),this.SetReversePlay(!1))},e.prototype.GetAnimationPlayApi=function(){return this.pSimulationAnimationManager.GetAnimationPlayApi()},e.prototype.SetReversePlay=function(e){this.bReversePlay=e},e.prototype.ScheduleAllAnimations=function(e){void 0===e&&(e=!1),this.ScheduledAnimationList=[];for(var t=0;t<this.AnimationList.length;++t)e&&this.AnimationList[t].GetTimeline().SetCurrentRelativeTick(0),this.AnimationList[t].GetDefaultActive()&&this.ScheduleAnimation(this.AnimationList[t],0)},e.prototype.GetCurrentTick=function(){return this.CurrentTick},e.prototype.ScheduleAnimation=function(e,t){var r=e.GetTimeline();0!=e.GetLoop()?r.SetStartTick(t+e.GetDelay()-r.GetCurrentRelativeTick()):r.SetStartTick(t+e.GetDelay()),e.Reset(),e.SetDefaultActive(!0),e.SetExecuteOnce(!1);for(var i=0;i<this.ScheduledAnimationList.length;++i)this.ScheduledAnimationList[i]===e&&this.ScheduledAnimationList.splice(i,1);this.ScheduledAnimationList.push(e)},e.prototype.Reset=function(){},e.prototype.GetPreTick=function(){return this.PreTick},e.prototype.CameraUpdated=function(){this.bCameraUpdated=!0},e.prototype.IsCameraPlay=function(){return this.pSimulationAnimationManager.IsCameraPlay()},e.prototype.TransferCamera=function(e,t,r,i,n){return this.IsCameraPlay()&&this.GetAnimationPlayApi()&&this.GetAnimationPlayApi().PlayCamera(e,t,r,i,n,this.GetView()),!0},e.prototype.IsPlayPosRot=function(){return this.pSimulationAnimationManager.IsPlayPosRot()},e.prototype.Transfer=function(e,t,r,i){return this.IsPlayPosRot()&&this.GetAnimationPlayApi()&&this.GetAnimationPlayApi().Play(e,t,r,i),!0},e.prototype.Continue=function(){this.pSimulationAnimationManager.SetCurSAByID(this.ID),this.GetAnimationPlayApi()&&this.GetAnimationPlayApi().PlayBegin(),this.bPlaybackIsInterrupted=!1,this.bReversePlay=!1,this.IsAtFinalTick()||this.GetFirstTick()>this.GetCurrentTick()?this.Rewind():this.IsAtStartTick()&&(this.IsPlaying()&&this.Stop(),this.ScheduleAllAnimations(!0),this.ExecuteAnimations(this.GetCurrentTick(),0)),this.Play(),this.StartTime-=this.GetCurrentTick()/this.GetTicksPerSecond()},e.prototype.Play=function(){if(this.pSimulationAnimationManager.SetCurSAByID(this.ID),this.bPlaybackIsInterrupted=!1,!this.IsPlaying()){this.ScheduleAllAnimations(!0);var e=new Date;this.StartTime=e.getTime()/1e3,this.SetInterval(.01),this.SetStyle(p.HTCStyle.HTCS_PeriodicSkip),this.SetNextRequest(this.StartTime+.01),this.bPlaying=!0,this.LastTick=this.GetLastTick(),this.FirstTick=this.GetFirstTick(),p.HTManager.GetHTManager().RegisterClient(this),this.PreTick=this.CurrentTick,this.fCollisionTime=this.CurrentTick*this.GetTicksPerSecond()}},e.prototype.IsAtStartTick=function(){return this.GetFirstTick()>=this.GetCurrentTick()},e.prototype.Rewind=function(){this.IsPlaying()&&this.Stop(),this.ScheduleAllAnimations(!0),this.SetCurrentTick(this.GetFirstTick()),this.ExecuteAnimations(this.GetCurrentTick(),0)},e.prototype.SetCurrentTick=function(e){this.IsPlaying()&&(this.StartTime+=(this.CurrentTick-e)/this.GetTicksPerSecond()),this.CurrentTick=e},e.prototype.GetTicksPerSecond=function(){return this.pSimulationAnimationManager?this.Tps*this.pSimulationAnimationManager.GetPlaySpeed():this.Tps},e.prototype.IsAtFinalTick=function(){return this.GetLastTick()<=this.GetCurrentTick()&&0<this.GetCurrentTick()},e.prototype.GetFirstTick=function(){var e=p.INT_MAX;if(0==this.ScheduledAnimationList.length)return 0;for(var t=0;t<this.ScheduledAnimationList.length;++t)if(!this.ScheduledAnimationList[t].GetParentAnimation()){var r=this.ScheduledAnimationList[t].GetFirstTick();-1!=r&&r<e&&(e=r)}return this.bPlayRangeSign&&(e=this.GetPlayBeginTick()),e},e.prototype.GetPlayBeginTick=function(){return this.fPlayBeginTick},e.prototype.GetLastTick=function(){for(var e=0,t=0;t<this.ScheduledAnimationList.length;++t)if(!this.ScheduledAnimationList[t].GetParentAnimation()){var r=this.ScheduledAnimationList[t].GetTimeline().GetLastTick();-1!=r&&e<r&&(e=r)}return this.bPlayRangeSign&&(e=this.GetPlayEndTick()),e},e.prototype.GetPlayEndTick=function(){return this.fPlayEndTick},e.prototype.ExecuteAnimations=function(e,t){var r=[];this.Reset(),this.bCameraUpdated=!1;for(var i=0;i<this.ScheduledAnimationList.length;++i){var n=!1;this.ScheduledAnimationList[i].GetParentAnimation()||(-1<t?this.ScheduledAnimationList[i].Animate(e,t):n=this.ScheduledAnimationList[i].Animate(e),(n&&!this.ScheduledAnimationList[i].GetLoop()||this.ScheduledAnimationList[i].ExecuteOnce())&&(this.ScheduledAnimationList[i].SetExecuteOnce(!1),r.push(this.ScheduledAnimationList[i]),this.ScheduledAnimationList[i].SetCurrentlyRunning(!1)))}r=[],this.GetAnimationPlayApi()&&this.GetAnimationPlayApi().UpdateView(this)},e.prototype.RewindReverse=function(){this.IsPlaying()&&this.Stop(),this.ScheduleAllAnimations(!0),this.SetCurrentTick(this.GetLastTick()),this.ExecuteAnimations(this.GetCurrentTick(),0)},e.prototype.IsPlayVisiable=function(){return this.pSimulationAnimationManager.IsPlayVisible()},e.prototype.IsPlayColor=function(){return this.pSimulationAnimationManager.IsPlayColor()},e.prototype.IsPlayClip=function(){return this.pSimulationAnimationManager.IsPlayClip()},e.prototype.IsPlayImage=function(){return this.pSimulationAnimationManager.IsPlayImage()},e.prototype.GetVersion=function(){return this.Version},e.prototype.GetView=function(){return this.GetSimulationAnimationManager()?this.GetSimulationAnimationManager().GetView():null},e.prototype.DeleteAllAnimation=function(){this.IsPlaying()&&this.Stop(),this.CurrentTick=0,this.LastTick=0,this.FirstTick=0,this.fPlayBeginTick=0,this.fPlayEndTick=0},e.prototype.TransferVisible=function(e,t,r,i){(this.GetAnimationPlayApi()&&-1===e.indexOf("ZOOM")&&this.IsPlayVisiable()||-1!==e.indexOf("ZOOM")&&this.IsCameraPlay())&&this.GetAnimationPlayApi().PlayVisible(e,t,r,i,this.GetView())},e.prototype.TransferColor=function(e,t,r){this.IsPlayColor()&&this.GetAnimationPlayApi()&&this.GetAnimationPlayApi().PlayColor(e,t,r,this.GetView())},e.prototype.TransferClipPlane=function(e,t,r,i,n,o){return this.IsPlayClip()&&this.GetAnimationPlayApi()&&this.GetAnimationPlayApi().PlayClipPlane(e,t,r,i,n,o),!0},e.prototype.TransferImage=function(e,t,r,i,n){return this.IsPlayImage()&&this.GetAnimationPlayApi()&&this.GetAnimationPlayApi().PlayAnimationImage(e,t,r,i,n),!0},e}(p.HTClient);p.HBhvBehaviorManager=t}(M3D||(M3D={})),function(S){var e=function(d){function e(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=this;if(6===e.length){var i=e[0],n=e[1],o=e[2],a=e[3],s=e[4],l=e[5];(r=d.call(this,i,n,o,a,s,l)||this).m_pReferenceBehaviorManager=null}else if(3===e.length){i=e[0];var h=e[1],u=e[2];if((r=d.call(this,i)||this).m_pReferenceBehaviorManager=h,r.m_pReferenceBehaviorManager&&"ChildAnimationHbhvBehaviorManager"===r.m_pReferenceBehaviorManager.GetType()&&(r.m_pReferenceBehaviorManager=r.m_pReferenceBehaviorManager.GetReferenceBehaviorManager()),r.m_pReferenceBehaviorManager&&(r.m_pReferenceBehaviorManager.Clone(r),r.SetName(h.GetName()),u))for(var p=0;p<r.TargetObjectList.length;p++)if(r.TargetObjectList[p].GetType()===S.TARGETOBJECTTYPE_INS){var c="";c=r.TargetObjectList[p].GetType(),c+=":",c+=u,c+="\\",c+=r.TargetObjectList[p].GetResolvedPath(),r.TargetObjectList[p].SetPath(c)}}return r}return __extends(e,d),e.prototype.GetReferenceBehaviorManager=function(){return this.m_pReferenceBehaviorManager},e.prototype.GetType=function(){return"ChildAnimationHbhvBehaviorManager"},e}(S.HBhvBehaviorManager);S.ChildAnimationHbhvBehaviorManager=e}(M3D||(M3D={})),function(r){var e=function(){function e(e,t){void 0===e&&(e=null),void 0===t&&(t=null),this.pTarget=0,this.pAnimation=e,this.Name=t||"",this.pArray=[]}return e.prototype.GetArrayLength=function(){return this.pArray.length},e.prototype.GetArray=function(){return this.pArray},e.prototype.GetAt=function(e){return this.pArray[e]},e.prototype.SetAnimation=function(e){this.pAnimation=e},e.prototype.GetAnimation=function(){return this.pAnimation},e.prototype.Interpolate=function(e,t){},e.prototype.GetType=function(){return""},e.prototype.Evaluate=function(e,t,r){},e.prototype.GetTranslationFromMatrix=function(){var e,t;return e=this.GetAnimation().GetTarget().GetPivot(),t=new r.Vector3(-e.x,-e.y,-e.z),new r.Vector3(t.x+e.x,t.y+e.y,t.z+e.z)},e.prototype.Reset=function(){},e.prototype.Clone=function(){return null},e.prototype.SetInstancedInterpolator=function(e){this.pInterpolatorInstance=e},e.prototype.Append=function(e){this.pArray.push(e)},e}();r.HBhvInterpolator=e}(M3D||(M3D={})),function(c){var e=function(r){function p(e,t){return void 0===e&&(e=null),void 0===t&&(t=null),r.call(this,e,t)||this}return __extends(p,r),p.prototype.GetType=function(){return"Normal"},p.prototype.CreateInstance=function(e){var t=new c.HBhvInterpolatorPosition(e);return t.SetInstancedInterpolator(this),t},p.prototype.Insert=function(e,t){void 0===t&&(t=0);var r=new c.HKeyframeChannelLinear;r.cp=e,this.pArray.splice(t,0,r)},p.prototype.Replace=function(e,t){var r=new c.HKeyframeChannelLinear;r.cp=e,this.pArray.length>t&&this.pArray.splice(t,1,r)},p.prototype.Serialize=function(e){},p.ProcessXMLData=function(e,t){var r=e.getAttribute("Name");r||(r="");var i=/([\-+]?[0-9]+\.?[0-9]*([eE][\-+]?[0-9]+)?)+[\s]+([\-+]?[0-9]*\.?[0-9]+([eE][\-+]?[0-9]+)?)+[\s]+([\-+]?[0-9]*\.?[0-9]+([eE][\-+]?[0-9]+)?)+(\])+/,n=new p(t,r),o=e.textContent;o+=" ";for(var a=0,s=0;!((s=o.indexOf("]"))<=0||s>=o.length);){var l,h=o.substr(0,s+1);if(o=o.substr(s+1),h=h.trim()){var u=i.exec(h);u&&(l=new c.Vector3(parseFloat(u[1]),parseFloat(u[3]),parseFloat(u[5])),n.Insert(l,a++))}}t.AddInterpolator(n)},p.prototype.Interpolate=function(e,t){if(this.pAnimation){var r;r=this.CalculatePos(e,t,r);var i;i=this.pAnimation.GetTarget().GetResolvedPath();var n;n=this.pAnimation.GetName();var o=[];o[0]=r.x,o[1]=r.y,o[2]=r.z;var a=this.pAnimation.GetClipPos(),s=[a.x,a.y,a.z],l=!0;(this.pAnimation.GetCurrentTick()<=this.pAnimation.GetFirstTick()||e>=this.GetArrayLength()-1)&&(l=!1),this.pAnimation.GetBehaviorManager().TransferClipPlane(1,i,n,o,s,l)}},p.prototype.CalculatePos=function(e,t,r){var i=this.GetArrayLength();if(!(i<=0)){var n=this.GetArray();return i-1<=e?n[i-1].cp:n[e].Interpolate(n,e,t,i)}},p.prototype.Clone=function(){var e=null;if(!(e=new p))return e;e.SetInstancedInterpolator(null);for(var t=0;t<this.GetArrayLength();t++){var r=this.pArray[t].Clone();e.Append(r)}return e},p}(c.HBhvInterpolator);c.HBhvInterpolatorNormal=e}(M3D||(M3D={})),function(C){var e=function(r){function v(e,t){return void 0===e&&(e=null),void 0===t&&(t=null),r.call(this,e,t)||this}return __extends(v,r),v.prototype.GetType=function(){return"Clip"},v.prototype.CreateInstance=function(e){var t=new C.HBhvInterpolatorPosition(e);return t.SetInstancedInterpolator(this),t},v.prototype.InsertLinear=function(e,t,r,i){void 0===i&&(i=0);var n=new C.HKeyframeChannelClip;n.cp=e,n.clipNormal=t,n.bVisible=r,this.pArray.splice(i,0,n)},v.prototype.ReplaceLinear=function(e,t,r,i){var n=new C.HKeyframeChannelClip;n.cp=e,n.clipNormal=r,n.bVisible=i,this.pArray.length>t&&this.pArray.splice(t,1,n)},v.prototype.Serialize=function(e){},v.prototype.XMLCallback=function(e,t){var r=e.getAttribute("Name");r||(r="");var i=/([\-+]?[0-9]+\.?[0-9]*([eE][\-+]?[0-9]+)?)+[\s]+([\-+]?[0-9]*\.?[0-9]+([eE][\-+]?[0-9]+)?)+[\s]+([\-+]?[0-9]*\.?[0-9]+([eE][\-+]?[0-9]+)?)+(\])+/,n=new v(t,r),o=e.textContent;o+=" ";for(var a=0,s=0;!((s=o.indexOf("]"))<=0||s>=o.length);){var l=o.substr(0,s+1);o=o.substr(s+1);var h=(l=l.trim()).split(""),u=new C.Vector3,p=new C.Vector3,c=C.HANIChannelType.HANILinear,d=!1,S=!1,f=!1;if(l){var m=h.indexOf("[");0<=m&&m<h.length&&(h=h.slice(m+1));for(var y=0;y<h.length;++y){if("0"<=h[y]&&h[y]<="9"||"-"==h[y]){if(d)break;h=h.join("").trim().split("");var T=i.exec(h.join(""));T&&(u=new C.Vector3(parseFloat(T[1]),parseFloat(T[3]),parseFloat(T[5])));break}switch(h[y]){case"l":c=C.HANIChannelType.HANILinear;continue;case"b":c=C.HANIChannelType.HANIHermiteSpline;continue;case"d":c=C.HANIChannelType.HANIDiscrete;continue;case"e":S=!0;continue;case"f":c=C.HANIChannelType.HANIFollowPath,"l"==h[y+1]&&(f=!0,h[y+1]=" ");continue;case"*":d=!0,c=C.HANIChannelType.HANIHermiteSpline;continue}h[y]=" "}if(c==C.HANIChannelType.HANIFollowPath){var M=new C.HKeyframeChannelFollowPath;M.bLinear=f,M.cp=u;var g=n.pArray.splice(a,n.pArray.length-a,M);n.pArray=n.pArray.concat(g)}else c==C.HANIChannelType.HANILinear?n.InsertLinear(u,p,!1,a):c==C.HANIChannelType.HANIHermiteSpline&&n.pArray[a].SetConstant(d);n.pArray[a].SetEaseInOut(S),a++}}t.AddInterpolator(n),t.GetTimeline()&&t.GetInterpolator(C.INTERPOLATOR_POS)&&t.GetTimeline().AddTLRange()},v}(C.HBhvInterpolator);C.HBhvInterpolatorClip=e}(M3D||(M3D={})),function(S){var e=function(i){function d(e,t){void 0===e&&(e=null),void 0===t&&(t=null);var r=i.call(this,e,t)||this;return r.ColorComponent="",r.GeomType="",r.SetGeomType("everything"),r.SetColorComponent("diffuse"),r}return __extends(d,i),d.prototype.SetGeomType=function(e){this.GeomType=e},d.prototype.GetGeomType=function(){return this.GeomType},d.prototype.SetColorComponent=function(e){this.ColorComponent=e},d.prototype.GetColorComponent=function(){return this.ColorComponent},d.prototype.GetType=function(){return"Color"},d.ProcessXMLData=function(e,t){var r=e.getAttribute("Name");r||(r="");var i=/([\-+]?[0-9]+\.?[0-9]*([eE][\-+]?[0-9]+)?)+[\s]+([\-+]?[0-9]*\.?[0-9]+([eE][\-+]?[0-9]+)?)+[\s]+([\-+]?[0-9]*\.?[0-9]+([eE][\-+]?[0-9]+)?)+(\])+/,n=new d(t,r),o=e.getAttribute("GeomType");o?n.SetGeomType(o):n.SetGeomType("everything");var a=e.getAttribute("Type");a?n.SetGeomType(a):n.SetGeomType("diffuse");var s=e.textContent;s+=" ";for(var l=0,h=0;!((h=s.indexOf("]"))<=0||h>=s.length);){var u,p=s.substr(0,h+1);if(s=s.substr(h+1),p=p.trim()){var c=i.exec(p);c&&(u=new S.Vector3(parseFloat(c[1]),parseFloat(c[3]),parseFloat(c[5])),n.Insert(u,l++))}}t.AddInterpolator(n)},d.prototype.Insert=function(e,t){void 0===t&&(t=0);var r=new S.HKeyframeChannelLinear;r.cp=e;var i=this.pArray.splice(t,this.pArray.length-t,r);this.pArray=this.pArray.concat(i)},d.prototype.CalculatePos=function(e,t){var r=new S.Vector3,i=this.GetArray(),n=this.GetArrayLength();return n-1<=e?r.copyFrom(this.pArray[n-1].cp):r.copyFrom(this.pArray[e].Interpolate(i,e,t,n)),r},d.prototype.Interpolate=function(e,t){var r=new S.Vector3;r=this.CalculatePos(e,t);var i="";i=this.GetAnimation().GetTarget().GetResolvedPath();var n=new S.Vector3;n.copyFrom(r),this.GetAnimation().GetTarget().GetType(),S.TARGETOBJECTTYPE_PMI,-1===n.x&&-1===n.y&&-1===n.z||!(n[0]<0||n[1]<0||n[2]<0)||(n.x+=1,n.y+=1,n.z+=1),i=S.AnimationPlayApi.SAPlcPathToDispPlcPath(i),this.GetAnimation().GetBehaviorManager().TransferColor(i,name,n)},d.prototype.Clone=function(){var e=null;if(!(e=new d))return e;e.SetInstancedInterpolator(null);for(var t=0;t<this.GetArrayLength();t++){var r=this.pArray[t].Clone();e.Append(r)}return e},d}(S.HBhvInterpolator);S.HBhvInterpolatorColor=e}(M3D||(M3D={})),function(c){var e=function(r){function p(e,t){return void 0===e&&(e=null),void 0===t&&(t=null),r.call(this,e,t)||this}return __extends(p,r),p.prototype.GetType=function(){return c.INTERPOLATOR_PIVOT},p.ProcessXMLData=function(e,t){var r=e.getAttribute("Name");r||(r="");var i=/(\[d)+[\s]+([\-+]?[0-9]+\.?[0-9]*([eE][\-+]?[0-9]+)?)+[\s]+([\-+]?[0-9]*\.?[0-9]+([eE][\-+]?[0-9]+)?)+[\s]+([\-+]?[0-9]*\.?[0-9]+([eE][\-+]?[0-9]+)?)+(\])+/,n=new p(t,r),o=e.textContent;o+=" ";for(var a=0,s=0;!((s=o.indexOf("]"))<=0||s>=o.length);){var l,h=o.substr(0,s+1);if(o=o.substr(s+1),h=h.trim()){var u=i.exec(h);u&&(l=new c.Vector3(parseFloat(u[2]),parseFloat(u[4]),parseFloat(u[6])),n.Insert(l,a++))}}t.AddInterpolator(n),t.GetTimeline()&&t.GetInterpolator(c.INTERPOLATOR_PIVOT)&&t.GetTimeline().AddTLRange()},p.prototype.Insert=function(e,t){var r=new c.HKeyframeChannelDiscrete;r.cp=e;var i=this.pArray.splice(t,this.pArray.length-t,r);this.pArray=this.pArray.concat(i)},p.prototype.CalculatePos=function(e,t){var r=new c.Vector3,i=this.GetArray(),n=this.GetArrayLength();return n-1<=e?r.copyFrom(i[n-1].cp):0==t||1==t?r.copyFrom(i[e].cp):r.copyFrom(i[e+1].cp),r},p.prototype.Interpolate=function(e,t){var r;r=this.CalculatePos(e,t),this.GetAnimation().GetTarget().SetPivot(r.x,r.y,r.z)},p.prototype.Replace=function(e,t){var r=new c.HKeyframeChannelDiscrete;r.cp=e,this.pArray.length>t&&(this.pArray[t]=r)},p.prototype.Clone=function(){var e=null;if(!(e=new p))return e;e.SetInstancedInterpolator(null);for(var t=0;t<this.GetArrayLength();t++){var r=this.pArray[t].Clone();e.Append(r)}return e},p}(c.HBhvInterpolator);c.HBhvInterpolatorPivot=e}(M3D||(M3D={})),function(I){var e=function(r){function g(e,t){return void 0===e&&(e=null),void 0===t&&(t=null),r.call(this,e,t)||this}return __extends(g,r),g.prototype.GetType=function(){return"Pos"},g.ProcessXMLData=function(e,t){var r=e.getAttribute("Name");r||(r="");var i=/([\-+]?[0-9]+\.?[0-9]*([eE][\-+]?[0-9]+)?)+[\s]+([\-+]?[0-9]*\.?[0-9]+([eE][\-+]?[0-9]+)?)+[\s]+([\-+]?[0-9]*\.?[0-9]+([eE][\-+]?[0-9]+)?)+(\])+/,n=new g(t,r),o=e.textContent;o+=" ";for(var a=0,s=0;!((s=o.indexOf("]"))<=0||s>=o.length);){var l=o.substr(0,s+1);o=o.substr(s+1);var h=(l=l.trim()).split(""),u=new I.Vector3,p=I.HANIChannelType.HANILinear,c=!1,d=!1,S=!1;if(l){var f=h.indexOf("[");0<=f&&f<h.length&&(h=h.slice(f+1));for(var m=0;m<h.length;++m){if("0"<=h[m]&&h[m]<="9"||"-"==h[m]){if(c)break;h=h.join("").trim().split("");var y=i.exec(h.join(""));y&&(u=new I.Vector3(parseFloat(y[1]),parseFloat(y[3]),parseFloat(y[5])));break}switch(h[m]){case"l":p=I.HANIChannelType.HANILinear;continue;case"b":p=I.HANIChannelType.HANIHermiteSpline;continue;case"d":p=I.HANIChannelType.HANIDiscrete;continue;case"e":d=!0;continue;case"f":p=I.HANIChannelType.HANIFollowPath,"l"==h[m+1]&&(S=!0,h[m+1]=" ");continue;case"*":c=!0,p=I.HANIChannelType.HANIHermiteSpline;continue}h[m]=" "}if(p==I.HANIChannelType.HANIFollowPath){var T=new I.HKeyframeChannelFollowPath;T.bLinear=S,T.cp=u;var M=n.pArray.splice(a,n.pArray.length-a,T);n.pArray=n.pArray.concat(M)}else p==I.HANIChannelType.HANILinear?n.InsertLinear(u,a):p==I.HANIChannelType.HANIHermiteSpline?n.InsertCurve(u,a):p==I.HANIChannelType.HANIDiscrete&&n.InsertDiscrete(u,a);n.pArray[a].SetConstant(c),n.pArray[a].SetEaseInOut(d),a++}}t.AddInterpolator(n),t.GetTimeline()&&t.GetInterpolator(I.INTERPOLATOR_POS)&&t.GetTimeline().AddTLRange()},g.prototype.InsertLinear=function(e,t){void 0===t&&(t=0);var r=new I.HKeyframeChannelLinear;r.cp=e;var i=this.pArray.splice(t,this.pArray.length-t,r);this.pArray=this.pArray.concat(i)},g.prototype.InsertCurve=function(e,t){void 0===t&&(t=0);var r=new I.HKeyframeChannelCurve;r.cp=e;var i=this.pArray.splice(t,this.pArray.length-t,r);this.pArray=this.pArray.concat(i)},g.prototype.InsertDiscrete=function(e,t){void 0===t&&(t=0);var r=new I.HKeyframeChannelDiscrete;r.cp=e;var i=this.pArray.splice(t,this.pArray.length-t,r);this.pArray=this.pArray.concat(i)},g.prototype.Reset=function(){this.CalculateAllTangents()},g.prototype.CalculateAllTangents=function(){for(var e=this.GetArray(),t=this.GetArrayLength(),r=0;r<t-1;r++)if(e[r].channeltype==I.HANIChannelType.HANIFollowPath||e[r].channeltype==I.HANIChannelType.HANIHermiteSpline){var i,n,o=void 0,a=void 0;i=e[r].cp,n=e[r+1].cp,o=0<r?e[r-1].channeltype==I.HANIChannelType.HANILinear?i:e[r-1].cp:i,a=r<t-2?e[r+1].channeltype==I.HANIChannelType.HANILinear?n:e[r+2].cp:n,e[r].CalculateCurveFactor(this.GetAnimation().GetTimeline(),r),e[r].CalculateHermiteTangents(o,n,a)}},g.prototype.SetTarget=function(){this.pTarget=this.GetAnimation().GetTarget().GetTargetKey()},g.prototype.CalculatePos=function(e,t){var r,i=this.GetArray(),n=this.GetArrayLength();if(!this.GetAnimation().GetCurrentlyRunning()&&i[0].bConstant&&(i[0].cp=this.GetTranslationFromMatrix()),n-1<=e)r=this.pArray[n-1].cp;else{var o=this.pArray[e];null==o&&console.log("NOT CORRECT"),this.pArray[e].bEaseInOut&&(t=I.HUtility.EaseInEaseOut(t,.49,.02,.49));var a=this.pAnimation.GetTarget().GetPrePivot(),s=this.pAnimation.GetTarget().GetPivot();if(a.Equal(s))r=this.pArray[e].cp.Equal(this.pArray[e+1].cp)?this.pArray[e].cp:this.pArray[e].Interpolate(i,e,t,n);else{var l=null;e<n-1?t<1?(l=i[e],i[e+1]):l=i[e+1]:l=i[n-1];var h=I.ArrayMaker.MakeNumArray(4,4),u=I.ArrayMaker.MakeNumArray(3),p=I.ArrayMaker.MakeNumArray(3);p[0]=a.x,p[1]=a.y,p[2]=a.z,u[0]=l.cp.x,u[1]=l.cp.y,u[2]=l.cp.z,this.GetAnimation().GetTarget().GetPreQuat().ToMatrix(h),I.MatrixOperation.UniTanslationToMtxTanslation(p,h,u);var c=I.ArrayMaker.MakeNumArray(3);c[0]=s.x,c[1]=s.y,c[2]=s.z,h[3][0]=u[0],h[3][1]=u[1],h[3][2]=u[2],u[0]=c[0]*h[0][0]+c[1]*h[1][0]+c[2]*h[2][0]+h[3][0],u[1]=c[0]*h[0][1]+c[1]*h[1][1]+c[2]*h[2][1]+h[3][1],u[2]=c[0]*h[0][2]+c[1]*h[1][2]+c[2]*h[2][2]+h[3][2],u[0]=u[0]-c[0],u[1]=u[1]-c[1],u[2]=u[2]-c[2];var d=new I.Vector3(l.cp);l.cp.x=u[0],l.cp.y=u[1],l.cp.z=u[2],r=this.pArray[e].Interpolate(i,e,t,n),l.cp.copyFrom(d)}}return r},g.prototype.Evaluate=function(e,t,r){r[0]=!0,r[1]=this.CalculatePos(e,t)},g.prototype.CalculatePosCamera=function(e,t){var r=this.GetArray(),i=this.GetArrayLength(),n=!1,o=new I.Vector3,a=!1,s=new I.Quaternion,l=!1,h=new I.Vector3;if(e<i-1){var u=this.GetAnimation().GetTimeline().GetTimelineArray(),p=this.pAnimation.GetTarget().GetPrePivot(),c=this.pAnimation.GetTarget().GetPivot();if(e<i-1)if(t<1){var d=null,S=null;d=r[e],S=r[e+1];var f=new I.Vector3(d.cp),m=new I.Vector3(S.cp);d.cp=I.HBhvUtility.MtxTanslationToUniTanslation(new I.Vector3(p),this.GetAnimation().GetTarget().GetPreQuat(),d.cp),S.cp=I.HBhvUtility.MtxTanslationToUniTanslation(new I.Vector3(c),this.GetAnimation().GetTarget().GetQuat(),S.cp);var y=[n,o,a,s,l,h];this.GetAnimation().Evaluate(this.GetAnimation().GetCurrentTick(),y),n=y[0],o=y[1],a=y[2],s=y[3],l=y[4],h=y[5];var T=!1,M=new I.Vector3,g=!1,v=new I.Quaternion,C=!1,_=new I.Vector3,A=!1,E=new I.Vector3,G=!1,P=new I.Quaternion,w=!1,D=new I.Vector3,x=u[e];if(y=[T,M,g,v,C,_],this.GetAnimation().Evaluate(x,y),T=y[0],M=y[1],g=y[2],v=y[3],C=y[4],_=y[5],x=u[e+1],y=[A,E,G,P,w,D],this.GetAnimation().Evaluate(x,y),A=y[0],E=y[1],G=y[2],P=y[3],w=y[4],D=y[5],!_.Equal(D)){var R=D.x/h.x;o.x=M.x+(o.x-M.x)*R,o.y=M.y+(o.y-M.y)*R,o.z=M.z+(o.z-M.z)*R}d.cp=new I.Vector3(f),S.cp=new I.Vector3(m),o=I.HBhvUtility.UniTanslationToMtxTanslation(new I.Vector3(c),s,o)}else o=r[e+1].cp}else o=r[i-1].cp;return o},g.prototype.InterpolateCamera=function(e,t){void 0===t&&(t=!1);for(var r,i=I.ArrayMaker.MakeNumArray(4,4),n=0;n<4;n++)for(var o=0;o<4;o++)i[n][o]=0;i[0][0]=1,i[1][1]=1,i[2][2]=1,i[3][3]=1,i[3][0]=e.x,i[3][1]=e.y,i[3][2]=e.z,r=this.pAnimation.GetTarget().GetResolvedPath();var a=this.pAnimation.GetTarget().GetPivot(),s=I.ArrayMaker.MakeNumArray(3);s[0]=a.x,s[1]=a.y,s[2]=a.z,this.GetAnimation().GetBehaviorManager().TransferCamera(r,0,s,i,this.GetAnimation().GetTarget().GetCameraType()),t||this.GetAnimation().GetBehaviorManager().CameraUpdated()},g.prototype.InterpolateCamera2=function(e,t){void 0===t&&(t=!1),t||this.GetAnimation().GetBehaviorManager().CameraUpdated()},g.prototype.Interpolate=function(e,t){var r;-1==this.pTarget&&this.SetTarget();var i,n=this.GetAnimation();if(null!=n)if(r=this.CalculatePos(e,t),i=this.pAnimation.GetTarget().GetResolvedPath(),n.GetTarget().GetCameraType()!==I.HBhvCameraType.NoCamera){if(r=this.CalculatePosCamera(e,t),!n.GetBehaviorManager().IsCameraPlay())return;n.GetTarget().GetCameraType()===I.HBhvCameraType.CameraTargetFree||n.GetTarget().GetCameraType()===I.HBhvCameraType.CameraPositionFree||n.GetTarget().GetCameraType()===I.HBhvCameraType.CameraPositionTarget?this.InterpolateCamera2(r):this.InterpolateCamera(r)}else if("CLIP"===n.GetTarget().GetType()){var o=I.ArrayMaker.MakeNumArray(3),a=I.ArrayMaker.MakeNumArray(3);o[0]=r.x,o[1]=r.y,o[2]=r.z;var s;s=this.pAnimation.GetName(),n.GetBehaviorManager().TransferClipPlane(0,i,s,a,o,!0)}else if("IMAGE"===n.GetTarget().GetType())n.SetImgPos(r);else{var l=I.ArrayMaker.MakeNumArray(3),h=I.ArrayMaker.MakeNumArray(4,4);h[0][0]=1,h[1][1]=1,h[2][2]=1,h[3][3]=1,h[3][0]=r.x,h[3][1]=r.y,h[3][2]=r.z;var u=this.pAnimation.GetTarget().GetPivot();l[0]=u.x,l[1]=u.y,l[2]=u.z,n.GetBehaviorManager().Transfer(0,i,l,h),n.GetTarget().FlagForCollision()}},g.prototype.ReplaceLinear=function(e,t){var r=new I.HKeyframeChannelLinear;r.cp=e,this.pArray.length>t&&(this.pArray[t]=r)},g.prototype.ReplaceCurve=function(e,t){var r=new I.HKeyframeChannelCurve;r.cp=e,this.pArray.length>t&&(this.pArray[t]=r)},g.prototype.Clone=function(){var e=null;if(!(e=new g))return e;e.SetInstancedInterpolator(null);for(var t=0;t<this.GetArrayLength();t++){var r=this.pArray[t].Clone();e.Append(r)}return e},g}(I.HBhvInterpolator);I.HBhvInterpolatorPosition=e}(M3D||(M3D={})),function(T){var e=function(r){function y(e,t){return void 0===e&&(e=null),void 0===t&&(t=null),r.call(this,e,t)||this}return __extends(y,r),y.prototype.GetType=function(){return"QuatRot"},y.ProcessXMLData=function(e,t){var r=e.getAttribute("Name");r||(r="");var i=/([\-+]?[0-9]+\.?[0-9]*([eE][\-+]?[0-9]+)?)+[\s]+([\-+]?[0-9]*\.?[0-9]+([eE][\-+]?[0-9]+)?)+[\s]+([\-+]?[0-9]*\.?[0-9]+([eE][\-+]?[0-9]+)?)+[\s]+([\-+]?[0-9]*\.?[0-9]+([eE][\-+]?[0-9]+)?)+(\])+/,n=new y(t,r),o=e.textContent;o+=" ";for(var a=0,s=0;!((s=o.indexOf("]"))<=0||s>=o.length);){var l=o.substr(0,s+1);o=o.substr(s+1);var h=(l=l.trim()).split(""),u=new T.Quaternion,p=(T.HANIChannelType.HANILinear,!1),c=!1,d=!1;if(l){var S=h.indexOf("[");0<=S&&S<h.length&&(h=h.splice(S+1),l=l.substr(S+1));for(var f=0;f<h.length;++f){if("0"<=h[f]&&h[f]<="9"||"-"==h[f]){if(p)break;h=h.join("").trim().split("");var m=i.exec(h.join(""));m&&(u=new T.Quaternion(parseFloat(m[7]),parseFloat(m[1]),parseFloat(m[3]),parseFloat(m[5])));break}switch(h[f]){case"l":d=!0;continue;case"r":c=!0;continue;case"*":p=!0;continue}h[f]=" "}n.Insert(u,a),n.pArray[a].SetRelative(c),n.pArray[a].bLinear=d,n.pArray[a].ExtraSpins=0,n.pArray[a].SetConstant(p),a++}}t.AddInterpolator(n),t.GetTimeline()&&t.GetInterpolator(T.INTERPOLATOR_QUATROT)&&t.GetTimeline().AddTLRange()},y.prototype.Insert=function(e,t){void 0===t&&(t=0);var r=new T.HKeyframeQuatSquad;r.quat=e;var i=this.pArray.splice(t,this.pArray.length-t,r);this.pArray=this.pArray.concat(i)},y.prototype.Evaluate=function(e,t,r){r[2]=!0,r[3]=this.CalculateQuat(e,t)},y.prototype.SetTarget=function(){this.pTarget=this.GetAnimation().GetTarget().GetTargetKey()},y.prototype.InterpolateCamera=function(e,t){void 0===t&&(t=!1);var r=T.ArrayMaker.MakeNumArray(4,4);e.ToMatrix(r);for(var i=T.ArrayMaker.MakeNumArray(4,4),n=0;n<4;n++)for(var o=0;o<4;o++)i[n][o]=r[n][o];var a,s=this.pAnimation.GetTarget().GetPivot(),l=T.ArrayMaker.MakeNumArray(3);l[0]=s.x,l[1]=s.y,l[2]=s.z,a=this.pAnimation.GetTarget().GetResolvedPath(),this.GetAnimation().GetBehaviorManager().TransferCamera(a,1,l,i,this.GetAnimation().GetTarget().GetCameraType())},y.prototype.Interpolate=function(e,t){var r;if(-1==this.pTarget&&this.SetTarget(),r=this.CalculateQuat(e,t),this.GetAnimation().GetTarget().GetCameraType()!=T.HBhvCameraType.NoCamera){if(!this.GetAnimation().GetBehaviorManager().IsCameraPlay())return;this.GetAnimation().GetTarget().GetCameraType()==T.HBhvCameraType.CameraTargetFree||this.GetAnimation().GetTarget().GetCameraType()==T.HBhvCameraType.CameraPositionFree||this.GetAnimation().GetTarget().GetCameraType()==T.HBhvCameraType.CameraPositionTarget?this.InterpolateCamera2(r):this.InterpolateCamera(r)}else{var i=T.ArrayMaker.MakeNumArray(4,4);r.ToMatrix(i);var n=this.GetAnimation().GetTarget().GetPivot(),o=T.ArrayMaker.MakeNumArray(3);o[0]=n.x,o[1]=n.y,o[2]=n.z;var a;a=this.pAnimation.GetTarget().GetResolvedPath(),this.GetAnimation().GetBehaviorManager().Transfer(1,a,o,i)}this.GetAnimation().GetTarget().FlagForCollision()},y.prototype.CalculateQuat=function(e,t){var r,i,n,o,a,s,l=new T.Quaternion,h=this.GetArray(),u=this.GetArrayLength();if(u-1<=e)l=h[u-1].quat;else if(i=h[e].quat,n=h[e+1].quat,r=0<e?h[e-1].quat:i,o=e<u-2?h[e+2].quat:n,h[e].ExtraSpins)l=T.Quaternion.QslerpNoInvertExtraSpins(i,n,t,h[e].ExtraSpins);else if(h[e].bLinear){var p=T.ArrayMaker.MakeNumArray(4),c=T.ArrayMaker.MakeNumArray(4),d=T.ArrayMaker.MakeNumArray(4);p[0]=i.x,p[1]=i.y,p[2]=i.z,p[3]=i.w,c[0]=n.x,c[1]=n.y,c[2]=n.z,c[3]=n.w,T.HUtility.TransitionQuaternion(p,c,t,d),l.x=d[0],l.y=d[1],l.z=d[2],l.w=d[3]}else a=T.Quaternion.Qspline(r,i,n),s=T.Quaternion.Qspline(i,n,o),l=T.Quaternion.Qsquad(i,n,a,s,t);return l},y.prototype.Replace=function(e,t){var r=new T.HKeyframeQuatSquad;r.quat=e,this.pArray.length>t&&(this.pArray[t]=r)},y.prototype.ReplaceLinear=function(e,t){var r=new T.HKeyframeQuatSquad;r.quat=e,r.bLinear=!0,this.pArray.length>t&&(this.pArray[t]=r)},y.prototype.InsertLinear=function(e,t){void 0===t&&(t=0);var r=new T.HKeyframeQuatSquad;if(r.quat=e,r.bLinear=!0,t>=this.pArray.length)this.pArray.push(r);else{var i=this.pArray.splice(t,this.pArray.length-t,r);this.pArray=this.pArray.concat(i)}},y.prototype.InterpolateCamera2=function(e,t){void 0===t&&(t=!1)},y.prototype.AdjustQuaternions=function(){for(var e,t=this.GetArray(),r=this.GetArrayLength(),i=T.ArrayMaker.MakeNumArray(4),n=T.ArrayMaker.MakeNumArray(4),o=0;o<r-1;o++){i[0]=t[o].quat.x,i[1]=t[o].quat.y,i[2]=t[o].quat.z,i[3]=t[o].quat.w,n[0]=t[o+1].quat.x,n[1]=t[o+1].quat.y,n[2]=t[o+1].quat.z,n[3]=t[o+1].quat.w;var a;a=(i[0]-n[0])*(i[0]-n[0])+(i[1]-n[1])*(i[1]-n[1])+(i[2]-n[2])*(i[2]-n[2])+(i[3]-n[3])*(i[3]-n[3]),(i[0]+n[0])*(i[0]+n[0])+(i[1]+n[1])*(i[1]+n[1])+(i[2]+n[2])*(i[2]+n[2])+(i[3]+n[3])*(i[3]+n[3])<a&&(e=new T.Quaternion(-n[3],-n[0],-n[1],-n[2]),t[o+1].bLinear?this.ReplaceLinear(e,o+1):this.Replace(e,o+1))}},y.prototype.Clone=function(){var e=null;if(!(e=new y))return e;e.SetInstancedInterpolator(null);for(var t=0;t<this.GetArrayLength();t++){var r=this.pArray[t].Clone();e.Append(r)}return e},y}(T.HBhvInterpolator);T.HBhvInterpolatorQuatSquad=e}(M3D||(M3D={})),function(c){var e=function(r){function p(e,t){return void 0===e&&(e=null),void 0===t&&(t=null),r.call(this,e,t)||this}return __extends(p,r),p.prototype.GetType=function(){return"Scale"},p.ProcessXMLData=function(e,t){var r=e.getAttribute("Name");r||(r="");var i=/([\-+]?[0-9]+\.?[0-9]*([eE][\-+]?[0-9]+)?)+[\s]+([\-+]?[0-9]*\.?[0-9]+([eE][\-+]?[0-9]+)?)+[\s]+([\-+]?[0-9]*\.?[0-9]+([eE][\-+]?[0-9]+)?)+(\])+/,n=new p(t,r),o=e.textContent;o+=" ";for(var a=0,s=0;!((s=o.indexOf("]"))<=0||s>=o.length);){var l,h=o.substr(0,s+1);if(o=o.substr(s+1),h=h.trim()){var u=i.exec(h);u&&(l=new c.Vector3(parseFloat(u[1]),parseFloat(u[3]),parseFloat(u[5])),n.Insert(l,a++))}}t.AddInterpolator(n),t.GetTimeline()&&t.GetInterpolator(c.INTERPOLATOR_SCALE)&&t.GetTimeline().AddTLRange()},p.prototype.Insert=function(e,t){void 0===t&&(t=0);var r=new c.HKeyframeChannelLinear;r.cp=e;var i=this.pArray.splice(t,this.pArray.length-t,r);this.pArray=this.pArray.concat(i)},p.prototype.CalculatePos=function(e,t){var r=new c.Vector3,i=this.GetArray(),n=this.GetArrayLength();return!this.GetAnimation().GetCurrentlyRunning()&&i[0].bConstant&&(i[0].cp=this.GetTranslationFromMatrix()),n-1<=e?r.copyFrom(this.pArray[n-1].cp):(r.copyFrom(this.pArray[e].Interpolate(i,e,t,n)),r.y=this.pArray[e].cp.y,r.z=this.pArray[e].cp.z),r},p.prototype.Interpolate=function(e,t){var r;-1===this.pTarget&&this.SetTarget();var i=this.GetAnimation();if(null!==i){if(r=this.CalculatePos(e,t),0!==this.GetAnimation().GetTarget().GetCameraType()){if(!this.GetAnimation().GetBehaviorManager().IsCameraPlay())return;i.GetTarget().GetCameraType()===c.HBhvCameraType.CameraTargetFree||i.GetTarget().GetCameraType()===c.HBhvCameraType.CameraPositionFree||i.GetTarget().GetCameraType()===c.HBhvCameraType.CameraPositionTarget?this.InterpolateCamera2(r):this.InterpolateCamera(r)}else{if("IMAGE"!==i.GetTarget().GetType())return;this.GetAnimation().SetImgScale(r)}this.GetAnimation().GetTarget().FlagForCollision()}},p.prototype.SetTarget=function(){this.pTarget=this.GetAnimation().GetTarget().GetTargetKey()},p.prototype.InterpolateCamera=function(e,t){void 0===t&&(t=!1);for(var r=c.ArrayMaker.MakeNumArray(4,4),i=0;i<4;i++)for(var n=0;n<4;n++)r[i][n]=0;r[3][0]=e.x,r[3][1]=e.y,r[3][2]=e.z;var o=this.pAnimation.GetTarget().GetPivot(),a=[o.x,o.y,o.z],s=this.pAnimation.GetTarget().GetResolvedPath();this.GetAnimation().GetBehaviorManager().TransferCamera(s,2,a,r,this.GetAnimation().GetTarget().GetCameraType()),t||this.GetAnimation().GetBehaviorManager().CameraUpdated()},p.prototype.InterpolateCamera2=function(e,t){void 0===t&&(t=!1)},p.prototype.Evaluate=function(e,t,r){r[4]=!0,r[5]=this.CalculatePos(e,t)},p.prototype.Clone=function(){var e=null;if(!(e=new p))return e;e.SetInstancedInterpolator(null);for(var t=0;t<this.GetArrayLength();t++){var r=this.pArray[t].Clone();e.Append(r)}return e},p}(c.HBhvInterpolator);c.HBhvInterpolatorScale=e}(M3D||(M3D={})),function(f){var e=function(r){function h(e,t){return void 0===e&&(e=null),void 0===t&&(t=null),r.call(this,e,t)||this}return __extends(h,r),h.prototype.GetType=function(){return"Visible"},h.ProcessXMLData=function(e,t){var r=e.getAttribute("Name");r||(r="");for(var i=new h(t,r),n=0,o=e.textContent,a=(o=o.trim()).split(" "),s=0;s<a.length;s++){var l=a[s];i.Insert(l,n++)}t.AddInterpolator(i)},h.prototype.Insert=function(e,t){void 0===t&&(t=0);var r=new f.HKeyframeString;r.target=e;var i=this.pArray.splice(t,this.pArray.length-t,r);this.pArray=this.pArray.concat(i)},h.prototype.Interpolate=function(e,t){.99999<t&&(e++,t=0);var r=this.GetArray(),i=this.GetArrayLength(),n="";n=this.GetAnimation().GetTarget().GetResolvedPath();var o=!0,a="";-1===this.pTarget&&this.SetTarget();var s="",l=0;if(this.GetAnimation().GetTarget().GetType()!==f.TARGETOBJECTTYPE_CLIP){if(this.GetAnimation().GetTarget().GetType()===f.TARGETOBJECTTYPE_ZOOM)a=this.pAnimation.GetName(),"off"===(s=0===e&&Math.abs(t)<1e-5?"off":e<i?r[e].GetTarget():r[i-1].GetTarget())?o=!1:"on"===s&&(o=!0),n=f.AnimationPlayApi.SAPlcPathToDispPlcPath(n),this.GetAnimation().GetBehaviorManager().TransferVisible(n,a,o,l);else if(this.pAnimation.GetTarget().GetType()===f.TARGETOBJECTTYPE_IMAGE){s=e<i-1?r[e].GetTarget():r[i-1].GetTarget(),o=!(this.pAnimation.GetCurrentTick()<this.pAnimation.GetFirstTick())&&"off"!==s,a=this.pAnimation.GetName();S=[];var h=[],u=this.pAnimation.GetImgPos(),p=this.pAnimation.GetImgScale();S[0]=u.x,S[1]=u.y,S[2]=u.z,h[0]=p.x,h[1]=p.y,h[2]=p.z,this.pAnimation.GetBehaviorManager().TransferImage(n,a,S,h,o)}if(i-1<=e)"off"===(s=r[i-1].GetTarget())?o=!1:"on"===s&&(o=!0);else{d="";if((s=r[e].GetTarget())===(d=r[e+1].GetTarget())){if(this.GetAnimation().GetBehaviorManager().IsPlaying())return;o="off"!==s}else"off"===s?0===t?o=!1:(o=!0,l=1-t):"on"===s&&(1===t?o=!1:(o=!0,l=t))}if(this.GetAnimation().GetTarget().GetType()===f.TARGETOBJECTTYPE_PMI){var c;c=this.GetAnimation().GetTarget().GetInsPathAndPMIIdByResolvedPath(n),a=f.TARGETOBJECTTYPE_PMI,a+=":",a+=c}n=f.AnimationPlayApi.SAPlcPathToDispPlcPath(n),this.GetAnimation().GetBehaviorManager().TransferVisible(n,a,o,l)}else{if(e<i-1){var d="";d=r[e+1].GetTarget(),o="on"===(s=r[e].GetTarget())||"on"===d}else o=!1;this.pAnimation.GetCurrentTick()<this.pAnimation.GetFirstTick()&&(o=!1);var S=[];this.pAnimation.GetBehaviorManager().TransferClipPlane(2,n,a,[],S,o)}},h.prototype.SetTarget=function(){this.pTarget=this.GetAnimation().GetTarget().GetTargetKey()},h.prototype.Clone=function(){var e=null;if(!(e=new h))return e;e.SetInstancedInterpolator(null);for(var t=0;t<this.GetArrayLength();t++){var r=this.pArray[t].Clone();e.Append(r)}return e},h}(f.HBhvInterpolator);f.HBhvInterpolatorVisible=e}(M3D||(M3D={})),function(m){var e=function(){function e(){}return e.MtxTanslationToUniTanslation=function(e,t,r){new m.Vector3(0,0,0);var i=m.ArrayMaker.MakeNumArray(4,4);t.ToMatrix(i);var n=m.ArrayMaker.MakeNumArray(3);n[0]=r.x,n[1]=r.y,n[2]=r.z;var o=m.ArrayMaker.MakeNumArray(3);return o[0]=e.x,o[1]=e.y,o[2]=e.z,m.MatrixOperation.MtxTanslationToUniTanslation(o,i,n),new m.Vector3(n[0],n[1],n[2])},e.UniTanslationToMtxTanslation=function(e,t,r){new m.Vector3(0,0,0);var i=m.ArrayMaker.MakeNumArray(4,4);t.ToMatrix(i);var n=m.ArrayMaker.MakeNumArray(3);n[0]=r.x,n[1]=r.y,n[2]=r.z;var o=m.ArrayMaker.MakeNumArray(3);return o[0]=e.x,o[1]=e.y,o[2]=e.z,m.MatrixOperation.UniTanslationToMtxTanslation(o,i,n),new m.Vector3(n[0],n[1],n[2])},e.AddAnimation=function(e,t,r,i,n){if(null==e)return null;var o=new m.HBhvAnimation(t,e,n);return r&&(r==m.TARGETOBJECTTYPE_FOLDER?o.SetTargetByPath("",r):o.SetTargetByPath(t,r),i&&o.GetTarget().SetPivot(i.x,i.y,i.z)),n&&n.AddChildAnimation(o),e.AddAnimation(o),o},e.AddCameraKeyframe=function(e,t,r,i,n,o,a,s){var l,h,u;if(!t.GetTimeline()){var p=new m.HBhvTimeline;t.SetTimeline(p)}for(var c=t.GetInterpolatorList(),d=0;d<c.length;++d)c[d].GetType()==m.INTERPOLATOR_PIVOT&&(l=c[d]),c[d].GetType()==m.INTERPOLATOR_POS&&(h=c[d]),c[d].GetType()==m.INTERPOLATOR_QUATROT&&(u=c[d]),c[d].GetType(),m.INTERPOLATOR_SCALE;l||(l=new m.HBhvInterpolatorPivot,t.AddInterpolator(l)),h||(h=new m.HBhvInterpolatorPosition,t.AddInterpolator(h)),u||(u=new m.HBhvInterpolatorQuatSquad,t.AddInterpolator(u));var S=t.GetTimeline().AddKeyframe(r),f=S[0];f<=0&&(f=0),S[1]?(l.Replace(i,f),s?(h.ReplaceLinear(n,f),u.ReplaceLinear(o,f)):(h.ReplaceCurve(n,f),u.Replace(o,f))):(l.Insert(i,f),s?(h.InsertLinear(n,f),u.InsertLinear(o,f)):(h.InsertCurve(n,f),u.Insert(o,f)))},e}();m.HBhvUtility=e}(M3D||(M3D={})),function(e){var t=function(){function e(){}return e.prototype.SetConstant=function(e){this.bConstant=e},e.prototype.SetEaseInOut=function(e){this.bEaseInOut=e},e.prototype.SetRelative=function(e){this.bRelative=e},e.prototype.Clone=function(){new e;return this},e}();e.HKeyframe=t}(M3D||(M3D={})),function(n){var e;(e=n.HANIChannelType||(n.HANIChannelType={}))[e.HANILinear=0]="HANILinear",e[e.HANIHermiteSpline=1]="HANIHermiteSpline",e[e.HANIBezierSpline=2]="HANIBezierSpline",e[e.HANIFollowPath=3]="HANIFollowPath",e[e.HANIDiscrete=4]="HANIDiscrete";var t=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.Interpolate=function(e,t,r,i){return new n.Vector3},t}(n.HKeyframe);n.HKeyframeChannel=t}(M3D||(M3D={})),function(u){var e=function(n){function e(e,t,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===r&&(r=0);var i=n.call(this)||this;return i.channeltype=u.HANIChannelType.HANIHermiteSpline,i.cp=new u.Vector3(e,t,r),i.tangent1=new u.Vector3,i.tangent2=new u.Vector3,i}return __extends(e,n),e.prototype.CalculateCurveFactor=function(e,t){var r,i,n,o=e.GetTimelineArray(),a=e.GetTimelineArrayLength();r=0<t&&t<a?o[t]-o[t-1]:0,i=t<a-1?o[t+1]-o[t]:0,n=t<a-2?o[t+2]-o[t+1]:0,this.factor1=2*i/(r+i),this.factor2=2*i/(i+n)},e.prototype.CalculateHermiteTangents=function(e,t,r,i){void 0===i&&(i=.5);var n=this.cp;i=.5,this.tangent1=new u.Vector3(i*(t.x-e.x),i*(t.y-e.y),i*(t.z-e.z)),this.tangent2=new u.Vector3(i*(r.x-n.x),i*(r.y-n.y),i*(r.z-n.z)),this.tangent1=new u.Vector3(this.factor1*this.tangent1.x,this.factor1*this.tangent1.y,this.factor1*this.tangent1.z),this.tangent2=new u.Vector3(this.factor2*this.tangent2.x,this.factor2*this.tangent2.y,this.factor2*this.tangent2.z)},e.prototype.Interpolate=function(e,t,r,i){var n,o;return n=e[t].cp,o=e[t+1].cp,0<t?e[t-1].cp:n,t<i-2?e[t+2].cp:o,this.InterpolateHermiteSpline(r,n,o)},e.prototype.InterpolateHermiteSpline=function(e,t,r){var i=new u.Vector3,n=e*e,o=e*e*e,a=2*o-3*n+1,s=-2*o+3*n,l=o-2*n+e,h=o-n;return i.x=a*t.x+s*r.x+l*this.tangent1.x+h*this.tangent2.x,i.y=a*t.y+s*r.y+l*this.tangent1.y+h*this.tangent2.y,i.z=a*t.z+s*r.z+l*this.tangent1.z+h*this.tangent2.z,i},e}(u.HKeyframeChannel);u.HKeyframeChannelCurve=e}(M3D||(M3D={})),function(o){var e=function(n){function e(e,t,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===r&&(r=0);var i=n.call(this)||this;return i.channeltype=o.HANIChannelType.HANIDiscrete,i.cp=new o.Vector3(e,t,r),i}return __extends(e,n),e}(o.HKeyframeChannel);o.HKeyframeChannelDiscrete=e}(M3D||(M3D={})),function(r){var e=function(t){function e(){var e=t.call(this)||this;return e.channeltype=r.HANIChannelType.HANIFollowPath,e.bLinear=!1,e.tmatrix=r.ArrayMaker.MakeNumArray(16),e.tmatrix2=r.ArrayMaker.MakeNumArray(16),e}return __extends(e,t),e}(r.HKeyframeChannelCurve);r.HKeyframeChannelFollowPath=e}(M3D||(M3D={})),function(h){var e=function(a){function e(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=a.call(this)||this;if(0<e.length){var i=e[0],n=e[1],o=e[2];r.channeltype=h.HANIChannelType.HANILinear,r.cp=i,r.clipNormal=n,r.bVisible=o}return r}return __extends(e,a),e.prototype.Clone=function(){new e;return this},e.prototype.CalculateCurveFactor=function(e,t){var r=0,i=0,n=0,o=e.GetTimelineArray(),a=e.GetTimelineArrayLength();r=0<t&&t<a?o[t]-o[t-1]:0,i=t<a-1?o[t+1]-o[t]:0,n=t<a-2?o[t+2]-o[t+1]:0,this.factor1=2*i/(r+i),this.factor2=2*i/(i+n)},e.prototype.CalculateHermiteTangents=function(e,t,r,i){void 0===i&&(i=.5);var n=this.cp;i=.5,this.tangent1=new h.Vector3(i*(t.x-e.x),i*(t.y-e.y),i*(t.z-e.z)),this.tangent2=new h.Vector3(i*(r.x-n.x),i*(r.y-n.y),i*(r.z-n.z)),this.tangent1=new h.Vector3(this.factor1*this.tangent1.x,this.factor1*this.tangent1.y,this.factor1*this.tangent1.z),this.tangent2=new h.Vector3(this.factor2*this.tangent2.x,this.factor2*this.tangent2.y,this.factor2*this.tangent2.z)},e.prototype.InterpolateHermiteSpline=function(e,t,r){var i=e*e,n=e*e*e,o=2*n-3*i+1,a=-2*n+3*i,s=n-2*i+e,l=n-i;return new h.Vector3(o*t.x+a*r.x+s*this.tangent1.x+l*this.tangent2.x,o*t.y+a*r.y+s*this.tangent1.y+l*this.tangent2.y,o*t.z+a*r.z+s*this.tangent1.z+l*this.tangent2.z)},e.prototype.CalculateCurveLength=function(e){for(var t,r=0,i=this.cp,n=this.curvelength=0;n<100;n++,r+=.01){var o;o=this.InterpolateHermiteSpline(r,this.cp,e),t=new h.Vector3(o.x-i.x,o.y-i.y,o.z-i.z),this.curvelength+=Math.sqrt(t.x*t.x+t.y*t.y+t.z*t.z),i=o}},e.prototype.Interpolate=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(7===e.length){var r=e[0],i=e[1],n=e[2],o=e[3],a=e[4],s=e[5],l=e[6],h=void 0,u=void 0;h=r[i].cp,u=r[i+1].cp,0<i?r[i-1].m_cp:h,i<o-2?r[i+2].cp:u,a=this.InterpolateHermiteSpline(n,h,u),h=r[i].clipNormal,u=r[i+1].clipNormal,0<i?r[i-1].clipNormal:h,i<o-2?r[i+2].clipNormal:u,s=this.InterpolateHermiteSpline(n,h,u),l=r[i].bVisible;var p=[];return p.push(a,s,l),p}},e}(h.HKeyframeChannel);h.HKeyframeChannelClip=e}(M3D||(M3D={})),function(o){var e=function(n){function e(e,t,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===r&&(r=0);var i=n.call(this)||this;return i.channeltype=o.HANIChannelType.HANILinear,i.cp=new o.Vector3(e,t,r),i}return __extends(e,n),e.prototype.Interpolate=function(e,t,r,i){var n;return n=new o.Vector3(e[t+1].cp.x-e[t].cp.x,e[t+1].cp.y-e[t].cp.y,e[t+1].cp.z-e[t].cp.z),new o.Vector3(e[t].cp.x+n.x*r,e[t].cp.y+n.y*r,e[t].cp.z+n.z*r)},e}(o.HKeyframeChannel);o.HKeyframeChannelLinear=e}(M3D||(M3D={})),function(e){var t=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t}(e.HKeyframe);e.HKeyframeRotation=t}(M3D||(M3D={})),function(e){var t=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t}(e.HKeyframeRotation);e.HKeyframeQuatSquad=t}(M3D||(M3D={})),function(e){var t=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.SetTarget=function(e){this.target=e},t.prototype.GetTarget=function(){return this.target},t}(e.HKeyframe);e.HKeyframeString=t}(M3D||(M3D={})),function(s){var e=function(){function e(e){this.output_hz=e,this.interval=1/e,this.current_bucket=0}return e.GetHTManager=function(){return e.pHTManager||(e.pHTManager=new e(100)),e.pHTManager},e.prototype.UnRegisterClient=function(e){var t;if(this.active_clients){for(var r=0;r<this.active_clients.length;++r)if(this.active_clients[r]==e){this.active_clients.splice(r,1);break}for(r=0;r<this.spillover.length;++r)if(this.spillover[r]==e){this.spillover.splice(r,1);break}t=this.actual_time+2,this.recently_deleted_clients.push(e),this.recently_deleted_expirations.push(t)}},e.prototype.Tick=function(e){var t,r,i;for(null==this.buckets&&this.Init(e),this.actual_time=e;this.request_time+this.interval<this.actual_time;){for(;0!=this.buckets[this.current_bucket].length;){var n=this.buckets[this.current_bucket][0];this.buckets[this.current_bucket].splice(0,1);for(var o=!1,a=0;a<this.active_clients.length;++a)if(this.active_clients[a]==n){o=!0;break}if(o)switch(t=n.GetInterval(),n.GetStyle()){case s.HTCStyle.HTCS_PeriodicSkip:n.Tick(this.request_time,this.actual_time)&&this.ScheduleNextTick(n,this.actual_time+t)}}if(this.current_bucket++,this.request_time+=this.interval,this.current_bucket==this.output_hz){for(;0<this.spillover.length&&!(1<=(r=(n=this.spillover[0]).GetNextRequest())-this.request_time);)this.spillover.splice(0,1),this.ScheduleNextTick(n,r);for(this.current_bucket=0;0<this.recently_deleted_expirations.length&&((i=this.recently_deleted_expirations[0])&&0!=i&&i<this.actual_time);)this.recently_deleted_clients.splice(0,1),this.recently_deleted_expirations.splice(0,1)}}},e.prototype.RegisterClient=function(e){var t;for(null==this.buckets&&this.Init(e.GetNextRequest()),t=0;t<this.active_clients.length;++t)if(this.active_clients[t]===e)return;for(t=0;t<this.recently_deleted_clients.length;++t)if(this.recently_deleted_clients[t]===e){for(var r=0;r<this.output_hz;r++)for(var i=0;i<this.buckets[r].length;++i)if(this.buckets[r][i]==e){this.buckets[r].splice(i,1);break}for(i=0;i<this.spillover.length;++i)if(this.spillover[i]===e){this.spillover.splice(i,1);break}break}this.active_clients.push(e),this.ScheduleNextTick(e,e.GetNextRequest())},e.prototype.ScheduleNextTick=function(e,t){var r,i,n;if(t<this.request_time&&(t=this.request_time+this.interval),e.SetNextRequest(t),1<=t-this.request_time)if(0<this.spillover.length&&(r=this.spillover[0]),null==r||t<r.GetNextRequest()){(a=new Array).push(e);for(var o=0;o<this.spillover.length;++o)a.push(this.spillover[o]);this.spillover=a}else for(o=0;o<this.spillover.length;++o){if(o+1==this.spillover.length){this.spillover.push(e);break}if(t<this.spillover[o+1].GetNextRequest()){var a=this.spillover.splice(o+1,this.spillover.length-o-1,e);this.spillover=this.spillover.concat(a);break}}else(n=(t-this.request_time)*this.output_hz)<=0&&(n=1),i=(this.current_bucket+n)%this.output_hz,i-=i%1,0==e.GetPriority()?((a=new Array).push(e),a=a.concat(this.buckets[i]),this.buckets[i]=a):this.buckets[i].push(e)},e.prototype.Init=function(e){var t;if(null==this.buckets)for(this.buckets=new Array,t=0;t<this.output_hz;t++)this.buckets.push(new Array);null==this.spillover&&(this.spillover=Array()),null==this.active_clients&&(this.active_clients=Array()),null==this.recently_deleted_clients&&(this.recently_deleted_clients=Array()),null==this.recently_deleted_expirations&&(this.recently_deleted_expirations=Array()),this.request_time=this.actual_time=e},e}();s.HTManager=e}(M3D||(M3D={})),function(e){var t=function(){function a(){}return a.PA=function(e,t,r){return e*e*.5*t/r},a.PB=function(e,t,r){return a.PA(r,t,r)+(e-r)*t},a.PC=function(e,t,r,i,n){return a.PB(r+i,t,r)+(e-(r+i))*t*(1-.5*(e-(r+i))/n)},a.EaseInEaseOut=function(e,t,r,i){var n,o=2/(t+2*r+i);return 1<(n=e<=t?a.PA(e,o,t):t<=e&&e<=t+r?a.PB(e,o,t):a.PC(e,o,t,r,i))&&(n=1),n},a.ComputeDoublePrecisionVectorLength=function(e){return Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2])},a.TransitionQuaternion=function(e,t,r,i){var n,o,a,s,l,h=3.1415926;if(1e-5<1+(o=e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3])){l=1e-5<1-o?(n=Math.acos(o),a=Math.sin(n),s=Math.sin((1-r)*n)/a,Math.sin(r*n)/a):(s=1-r,r);for(var u=0;u<4;u++)i[u]=s*e[u]+l*t[u]}else{i[0]=-e[1],i[1]=e[0],i[2]=-e[3],i[3]=e[2],s=Math.sin((1-r)*h/2),l=Math.sin(r*h/2);for(u=0;u<3;u++)i[u]=s*e[u]+l*i[u]}},a}();e.HUtility=t}(M3D||(M3D={})),function(S){var e=function(){function u(){}return u.MtxTanslationToUniTanslation=function(e,t,r){t[3][0]=r[0],t[3][1]=r[1],t[3][2]=r[2],r[0]=e[0]*t[0][0]+e[1]*t[1][0]+e[2]*t[2][0]+t[3][0],r[1]=e[0]*t[0][1]+e[1]*t[1][1]+e[2]*t[2][1]+t[3][1],r[2]=e[0]*t[0][2]+e[1]*t[1][2]+e[2]*t[2][2]+t[3][2],r[0]=r[0]-e[0],r[1]=r[1]-e[1],r[2]=r[2]-e[2]},u.MatrixInversion=function(e,t){var r,i,n;void 0===t&&(t=4);var o,a,s,l,h=S.ArrayMaker.MakeNumArray(4,4),u=S.ArrayMaker.MakeNumArray(4,4);S.ArrayMaker.MakeNumArray(4);for(var p=0;p<4;++p)for(var c=0;c<4;++c)u[p][c]=e[p][c];for(a=0;a<t;a++)for(s=0;s<t;s++)h[a][s]=0;for(a=0;a<t;a++)h[a][a]=1;for(s=0;s<t;s++){for(r=u[o=s][s],a=s+1;a<t;a++)Math.abs(r)<Math.abs(u[a][s])&&(r=u[o=a][s]);if(Math.abs(r)<1e-6)return;if(o!=s){var d=u[s];u[s]=u[o],u[o]=d,d=h[s],h[s]=h[o],h[o]=d}for(n=u[s],a=s+1;a<t;a++)n[a]/=r;for(n=h[s],a=0;a<t;a++)n[a]/=r;for(a=0;a<t;a++)if(a!=s){for(i=u[a][s],l=s+1;l<t;l++)u[a][l]-=u[s][l]*i;for(l=0;l<t;l++)h[a][l]-=h[s][l]*i}}for(a=0;a<t;a++)for(s=0;s<t;s++)e[a][s]=h[a][s]},u.Multiply=function(e,t,r,i,n,o){var a,s,l;for(void 0===i&&(i=4),void 0===n&&(n=4),void 0===o&&(o=4),a=0;a<i;a++)for(s=0;s<o;s++)for(l=r[a][s]=0;l<n;l++)r[a][s]+=e[a][l]*t[l][s]},u.UniTanslationToMtxTanslation=function(e,t,r){t[3][0]=t[3][1]=t[3][2]=0;for(var i=[[1,0,0,0],[0,1,0,0],[0,0,1,0],[r[0],r[1],r[2],1]],n=[[1,0,0,0],[0,1,0,0],[0,0,1,0],[e[0],e[1],e[2],1]],o=S.ArrayMaker.MakeNumArray(4,4),a=0;a<4;a++)for(var s=0;s<4;s++)o[a][s]=n[a][s];u.MatrixInversion(o,4);var l=S.ArrayMaker.MakeNumArray(4,4),h=S.ArrayMaker.MakeNumArray(4,4);u.Multiply(o,t,l),u.Multiply(l,n,h),u.Multiply(h,i,l),r[0]=l[3][0],r[1]=l[3][1],r[2]=l[3][2]},u.FromQuat=function(e,t){var r,i,n,o,a,s,l,h,u,p,c,d,S;r=2/(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]+e[3]*e[3]),i=e[0]*r,n=e[1]*r,o=e[2]*r,a=e[3]*i,s=e[3]*n,l=e[3]*o,h=e[0]*i,u=e[0]*n,p=e[0]*o,c=e[1]*n,d=e[1]*o,S=e[2]*o},u.getTransform=function(e,t,r,i,n){var o=new S.Matrix4(e[0][0],e[0][1],e[0][2],e[0][3],e[1][0],e[1][1],e[1][2],e[1][3],e[2][0],e[2][1],e[2][2],e[2][3],e[3][0],e[3][1],e[3][2],e[3][3]),a=(o=o.Transpose()).Rotation();r.push(a.x),r.push(a.y),r.push(a.z),r.push(a.w);var s=o.Scale();i.push(s.x),i.push(s.y),i.push(s.z)},u}();S.MatrixOperation=e}(M3D||(M3D={})),function(m){var e=function(){function f(e,t,r){void 0===r&&(r=null),this.Name=e||"",this.InstanceOf="",this.Loop=0,this.pParentAnimation=r,this.pTimeline=null,this.pInstancedAnimation=null,this.pBehaviorManager=t,this.Delay=0,this.InterpolatorList=[],this.ChildAnimationList=[],this.bCurrentlyRunning=!1,this.bDefaultActive=!0,this.Target=null,this.bExecuteOnce=!1,this.bExpanded=!1,this.bLocked=!1,this.clipPos=new m.Vector3(0,0,0),this.imgPos=new m.Vector3(0,0,0),this.imgScale=new m.Vector3(0,0,0),this.pGroupAnimation=null}return f.prototype.SetTimeline=function(e){this.pTimeline=e,this.pTimeline&&this.pTimeline.SetAnimation(this)},f.prototype.SetClipPos=function(e){this.clipPos.x=e.x,this.clipPos.y=e.y,this.clipPos.z=e.z},f.prototype.GetClipPos=function(){return this.clipPos},f.prototype.SetImgPos=function(e){this.imgPos.x=e.x,this.imgPos.y=e.y,this.imgPos.z=e.z},f.prototype.GetImgPos=function(){return this.imgPos},f.prototype.SetImgScale=function(e){this.imgScale.x=e.x,this.imgScale.y=e.y,this.imgScale.z=e.z},f.prototype.GetImgScale=function(){return this.imgScale},f.prototype.AddChildAnimation=function(e){this.ChildAnimationList.push(e),e.pParentAnimation=this},f.ProcessXMLData=function(e,t){var r,i=e.getAttribute("Delay"),n=e.getAttribute("Target"),o=e.getAttribute("TargetID"),a=e.getAttribute("Name"),s=e.getAttribute("Expand"),l=e.getAttribute("InstanceOf"),h=0;if(!l||""===l){if((h=e.getAttribute("Loop"))||(h=0),!t)return null;if(t instanceof f){var u=t;(r=new f(a,u.pBehaviorManager,u)).Loop=h,r.Delay=i,r.bExpanded=0!=s,u.AddChildAnimation(r),u.pBehaviorManager.AddAnimation(r)}else if(t instanceof m.HBhvBehaviorManager){var p=t;(r=new f(a,p,null)).Loop=h,r.Delay=i,r.bExpanded=0!=s,p.AddAnimation(r)}if(r){var c=!1;e.getAttribute("Active")||(c=!0),r.bDefaultActive=c,n&&""!=n?r.SetTargetByPath("",n):r.SetTargetByKey(o)}}for(var d=0;d<e.childNodes.length;++d){var S=e.childNodes[d];if(1===S.nodeType)switch(S.nodeName){case"Animation":f.ProcessXMLData(S,r);break;case"Timeline":m.HBhvTimeline.ProcessXMLData(S,r);break;case"PivotInterpolator":m.HBhvInterpolatorPivot.ProcessXMLData(S,r);break;case"PosInterpolator":m.HBhvInterpolatorPosition.ProcessXMLData(S,r);break;case"QuatRotInterpolator":m.HBhvInterpolatorQuatSquad.ProcessXMLData(S,r);break;case"ScaleInterpolator":m.HBhvInterpolatorScale.ProcessXMLData(S,r);break;case"VisibleInterpolator":m.HBhvInterpolatorVisible.ProcessXMLData(S,r);break;case"ColorInterpolator":m.HBhvInterpolatorColor.ProcessXMLData(S,r);break;case"NormalInterpolator":m.HBhvInterpolatorNormal.ProcessXMLData(S,r)}}return r},f.prototype.SetDefaultActive=function(e){this.bDefaultActive=e},f.prototype.GetDefaultActive=function(){return this.bDefaultActive},f.prototype.GetLoop=function(){return this.Loop},f.prototype.GetLastTick=function(){return this.GetTimeline()&&0<this.GetTimeline().GetTimelineArrayLength()?this.GetTimeline().GetTimelineArray()[this.GetTimeline().GetTimelineArrayLength()-1]:0},f.prototype.AddInterpolator=function(e){this.InterpolatorList.push(e),e&&e.SetAnimation(this)},f.prototype.ExecuteOnce=function(){return this.bExecuteOnce},f.prototype.SetExecuteOnce=function(e){this.bExecuteOnce=e},f.prototype.GetDelay=function(){return this.Delay},f.prototype.Reset=function(){for(var e=0;e<this.InterpolatorList.length;++e){if("QuatRot"==this.InterpolatorList[e].GetType())this.InterpolatorList[e].AdjustQuaternions();this.InterpolatorList[e].Reset()}this.bCurrentlyRunning=!1},f.prototype.GetFirstTick=function(){return this.GetTimeline()&&0<this.GetTimeline().GetTimelineArrayLength()?this.GetTimeline().GetTimelineArray()[0]:0},f.prototype.Animate=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(1==e.length){this.pTimeline.SetCheckRelativeFrame(!0);for(var r=this.AnimateInternal(e[0]),i=0;i<this.ChildAnimationList.length;++i)this.ChildAnimationList[i].GetDefaultActive()&&this.ChildAnimationList[i].Animate(e[0],this.GetTimeline().GetStartTick());return r}if(2!=e.length)return!1;this.pTimeline.SetStartTick(e[1]),this.pTimeline.SetCheckRelativeFrame(!1);for(r=this.AnimateInternal(e[0]),i=0;i<this.ChildAnimationList.length;++i)this.ChildAnimationList[i].GetDefaultActive()&&this.ChildAnimationList[i].Animate(e[0],e[1]);return r},f.prototype.GetTarget=function(){return this.Target},f.prototype.GetBehaviorManager=function(){return this.pBehaviorManager},f.prototype.SetBehaviorManager=function(e){this.pBehaviorManager=e},f.prototype.GetTimeline=function(){return this.pTimeline},f.prototype.GetParentAnimation=function(){return this.pParentAnimation},f.prototype.Evaluate=function(e,t){var r,i,n=this.pTimeline.Evaluate(e,r,i);if(r=n[1],i=n[2],n[0]){i<0&&(i=0);for(var o=0;o<this.InterpolatorList.length;++o)this.InterpolatorList[o].Evaluate(r,i,t)}},f.prototype.Clone=function(e){var t=null;if(!(t=new f(this.Name,e)))return t;t.bExpanded=this.bExpanded,t.bLocked=this.bLocked,t.Loop=this.Loop;var r=this.pTimeline.Clone();r&&t.SetTimeline(r);for(var i=0;i<this.ChildAnimationList.length;i++){if((o=this.ChildAnimationList[i])&&o.GetTarget()){var n=o.Clone(e);n&&(n.SetBehaviorManager(e),n.SetTargetByPath(o.GetName(),o.GetTarget().Path),t.AddChildAnimation(n),e.AddAnimation(n))}}for(i=0;i<this.InterpolatorList.length;i++){var o;if(o=this.InterpolatorList[i]){var a=o.Clone();a&&t.AddInterpolator(a)}}return r.AddTLRange(),t},f.prototype.GetName=function(){return this.Name},f.prototype.GetCurrentTick=function(){return this.pBehaviorManager.GetCurrentTick()},f.prototype.GetCurrentlyRunning=function(){return this.bCurrentlyRunning},f.prototype.AnimateInternal=function(e){var t,r;if(this.GetTarget()&&"GROUPID"==this.GetTarget().GetType())return!1;if(this.GetBehaviorManager()&&this.GetBehaviorManager().IsPlaying()&&0==this.GetLoop()){var i=this.GetBehaviorManager().GetCurrentTick(),n=this.GetBehaviorManager().GetPreTick();if(i>this.GetLastTick()&&n>this.GetLastTick()||i<this.GetFirstTick()&&n<this.GetFirstTick())return!1}var o=this.pTimeline.Evaluate(e,t,r);if(t=o[1],r=o[2],o[0]){r<0&&(r=0);var a=this.GetTimeline().GetTimelineArrayLength(),s=0,l=0;a-1<=t?s=l=a-1:r<1?l=(s=t)+1:s=l=t+1;for(var h=0;h<this.InterpolatorList.length;++h)if("Pivot"==this.InterpolatorList[h].GetType()){var u=new m.Vector3(this.InterpolatorList[h].GetAt(s).cp);this.GetTarget().SetPrePivot(u),u=new m.Vector3(this.InterpolatorList[h].GetAt(l).cp),this.GetTarget().SetPivot(u)}else if("QuatRot"==this.InterpolatorList[h].GetType()){var p=this.InterpolatorList[h].GetAt(s).quat;this.GetTarget().SetPreQuat(p.x,p.y,p.z,p.w),p=this.InterpolatorList[h].GetAt(l).quat,this.GetTarget().SetQuat(p.x,p.y,p.z,p.w)}for(h=0;h<this.InterpolatorList.length;++h)this.InterpolatorList[h].Interpolate(t,r);if(this.SetCurrentlyRunning(!0),!this.GetBehaviorManager().IsReversePlay()&&t==a)return!0}return!1},f.prototype.SetCurrentlyRunning=function(e){this.bCurrentlyRunning=e},f.prototype.GetInterpolator=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(1!=e.length)return 0<this.InterpolatorList.length?this.InterpolatorList[0]:null;for(var r=0;r<this.InterpolatorList.length;++r)if(this.InterpolatorList[r].GetType()===e[0])return this.InterpolatorList[r];return null},f.prototype.GetInterpolatorList=function(){return this.InterpolatorList},f.prototype.SetTargetByPath=function(e,t){this.Target=t?this.pBehaviorManager.CreateTargetObjectByPath(e,t):null},f.prototype.SetTargetByKey=function(e){this.Target=-1!=e?this.pBehaviorManager.GetTargetObjectByKey(e):null},f.prototype.SetParentAnimation=function(e){this.pParentAnimation=e},f.prototype.IsAnimationInterval=function(e,t){var r=!0;if(null==this.pTimeline)return r;if(!(e<this.pTimeline.GetTimelineArrayLength()&&t<this.pTimeline.GetTimelineArrayLength()))return r;var i=this.GetTimeline().GetTimelineArrayLength();if(i<=e||i<=t)return!1;for(var n=!0,o=0;o<this.InterpolatorList.length;++o)e<this.InterpolatorList[o].GetArrayLength()&&(n=this.IsAniIntervalByHKeyFrame(this.InterpolatorList[o],e,t),r=r&&n);return this.InterpolatorList.length<=0&&(r=!1),r},f.prototype.IsAniIntervalByHKeyFrame=function(e,t,r){var i=!1,n=null,o=null;if(!e)return!1;var a=e.GetArray();if(0<=t&&t<e.GetArrayLength()&&(n=a[t]),!(0<=r&&r<e.GetArrayLength()))return i;o=a[r];var s=n.type,l=-1;if(s==m.HANIKeyframeType.HANIChannel&&(l=n.channeltype),s==m.HANIKeyframeType.HANIRotation&&(l=n.rotationtype,n.bLinear),s!=m.HANIKeyframeType.HANIChannel||l!=m.HANIChannelType.HANILinear&&l!=m.HANIChannelType.HANIHermiteSpline&&l!=m.HANIChannelType.HANIDiscrete&&l!=m.HANIChannelType.HANIFollowPath){if(s==m.HANIKeyframeType.HANIRotation&&l==m.HANIRotationType.HANIQuatSquadRotation){var h=e.GetAt(t).quat,u=e.GetAt(r).quat;h.Equal(u,m.ANIMATION_D_TOL2)&&(i=!0)}else if(s==m.HANIKeyframeType.HANIString){if(e.GetType()==m.INTERPOLATOR_VISIBLE)e.GetAt(t).target==e.GetAt(r).target&&(i=!0)}}else{var p=n.cp,c=o.cp;e.GetType()===m.INTERPOLATOR_POS||e.GetType()===m.INTERPOLATOR_PIVOT?p.Equal(c,m.ANIMATION_D_TOL)&&(i=!0):e.GetType()!=m.INTERPOLATOR_COLOR&&e.GetType()!=m.INTERPOLATOR_NORMAL&&e.GetType()!=m.INTERPOLATOR_SCALE||p.Equal(c,m.ANIMATION_D_TOL2)&&(i=!0)}return i},f.prototype.ResetFirstLastTickByChild=function(){var e=0,t=0;if(this.GetTimeline()){for(var r=!1,i=0;i<this.ChildAnimationList.length;++i)this.ChildAnimationList[i].GetTimeline()&&0<this.ChildAnimationList[i].GetTimeline().GetTimelineArrayLength()&&(r=!0,0==i?(e=this.ChildAnimationList[i].GetFirstTick(),t=this.ChildAnimationList[i].GetLastTick()):(e>this.ChildAnimationList[i].GetFirstTick()&&(e=this.ChildAnimationList[i].GetFirstTick()),t<this.ChildAnimationList[i].GetLastTick()&&(t=this.ChildAnimationList[i].GetLastTick())));var n=this.GetTimeline().GetTimelineArrayLength();if(e!=t)if(2<=n){for(i=2;i<n;i++)this.GetTimeline().DeleteKeyframe(this.GetTimeline().GetTimelineArray()[i]);this.GetTimeline().GetTimelineArray()[0]=e,this.GetTimeline().GetTimelineArray()[1]=t,this.pParentAnimation&&this.pParentAnimation.ResetFirstLastTickByChild()}else 1==n?this.GetTimeline().GetTimelineArray()[0]=e:this.GetTimeline().AddKeyframe(e),this.GetTimeline().AddKeyframe(t);else if(r)if(n<=0)this.GetTimeline().AddKeyframe(e);else{for(i=1;i<n;i++)this.GetTimeline().DeleteKeyframe(this.GetTimeline().GetTimelineArray()[i]);this.GetTimeline().GetTimelineArray()[0]=e}else this.GetTimeline().DeleteAllKeyframe(),this.pParentAnimation&&this.pParentAnimation.ResetFirstLastTickByChild()}},f}();m.HBhvAnimation=e}(M3D||(M3D={})),function(u){var h,e;(e=h=u.HBhvCameraType||(u.HBhvCameraType={}))[e.NoCamera=0]="NoCamera",e[e.CameraTarget=1]="CameraTarget",e[e.CameraPosition=2]="CameraPosition",e[e.CameraTargetFree=3]="CameraTargetFree",e[e.CameraPositionFree=4]="CameraPositionFree",e[e.CameraPositionTarget=5]="CameraPositionTarget";var t=function(){function o(e,t,r,i){void 0===i&&(i=null),this.pBehaviorManager=e,this.bSerializeFromKey=!0,this.Name=t||"",this.Path=r||"",this.Pivot=new u.Vector3,i&&this.Pivot.copyFrom(i),this.Quat=new u.Quaternion(1,0,0,0),this.PrePivot=new u.Vector3(0,0,0),this.PreQuat=new u.Quaternion(1,0,0,0),this.CameraType=h.NoCamera,this.Path=r;var n=[this.ResolvedPath,this.Type,this.CameraType];o.ResolveTarget(this.Path,n),this.ResolvedPath=n[0],this.Type=n[1],this.CameraType=n[2],this.bHasMoved=!1,this.bCollision=!1,this.key=0,this.pBehaviorManager&&(this.key=this.pBehaviorManager.RegisterTargetObjectKey()),this.eTargetType=u.AnimationType.AT_PART}return o.ResolveTarget=function(e,t){var r,i,n,o;e&&(o=e),n=h.NoCamera;var a=o.indexOf(":");if(i=o.substr(0,a),o=(l=o.substr(a+1))||"",i==u.TARGETOBJECTTYPE_INS||i==u.TARGETOBJECTTYPE_PMI||i==u.TARGETOBJECTTYPE_CLIP||i==u.TARGETOBJECTTYPE_FOLDER||i==u.TARGETOBJECTTYPE_SOUND||i==u.TARGETOBJECTTYPE_IMAGE||"TID"==i||"ANIM"==i||"SSR"==i)return r=o,t[0]=r,t[1]=i,void(t[2]=n);var s,l;l.indexOf("/");l.substr(0,a-1),"CAMERA"!==(s=l.substr(a))&&"TARGET"!==s&&"POSITION"!==s&&"TARGETFREE"!==s&&"POSITIONFREE"!==s&&"POSITIONTARGET"!==s||(n="POSITION"===s?h.CameraPosition:"TARGET"===s?h.CameraTarget:"TARGETFREE"===s?h.CameraTargetFree:"POSITIONFREE"===s?h.CameraPositionFree:"POSITIONTARGET"===s?h.CameraPositionTarget:h.NoCamera,r=o,t[0]=r,t[1]=i,t[2]=n)},o.prototype.GetType=function(){return this.Type},o.prototype.GetTargetKey=function(){return-1===this.key&&this.CameraType!==h.NoCamera&&(this.key=0),this.key},o.prototype.IsEqual=function(e){return this.Path===e},o.prototype.SetPivot=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];1==e.length?this.Pivot.copyFrom(e[0]):3==e.length&&(this.Pivot=new u.Vector3(e[0],e[1],e[2]))},o.prototype.SetPreQuat=function(e,t,r,i){this.PreQuat=new u.Quaternion(i,e,t,r)},o.prototype.SetQuat=function(e,t,r,i){this.Quat=new u.Quaternion(i,e,t,r)},o.prototype.SetPrePivot=function(e){this.PrePivot=e},o.ProcessXMLData=function(e,t){var r,i=e.getAttribute("ID"),n=e.getAttribute("Name"),o=e.getAttribute("Path"),a=e.getAttribute("Pivot");if(a){var s=/(\[)+([\-+]?[0-9]+\.?[0-9]*([eE][\-+]?[0-9]+)?)+[\s]+([\-+]?[0-9]*\.?[0-9]+([eE][\-+]?[0-9]+)?)+[\s]+([\-+]?[0-9]*\.?[0-9]+([eE][\-+]?[0-9]+)?)+(\])+/.exec(a);r=s?new u.Vector3(parseFloat(s[2]),parseFloat(s[4]),parseFloat(s[6])):new u.Vector3}else r=new u.Vector3;var l;l=e.getAttribute("Collision");var h=t.CreateTargetObjectByPath(n,o);h.Pivot=r,h.bCollision=l,h.Quat=new u.Quaternion(1,0,0,0),h.PrePivot=new u.Vector3(0,0,0),h.PreQuat=new u.Quaternion(1,0,0,0),h.key=i},o.prototype.GetPivot=function(){return this.Pivot},o.prototype.GetPrePivot=function(){return this.PrePivot},o.prototype.GetPreQuat=function(){return this.PreQuat},o.prototype.GetResolvedPath=function(){return this.ResolvedPath},o.prototype.GetCameraType=function(){return this.CameraType},o.prototype.GetQuat=function(){return this.Quat},o.prototype.FlagForCollision=function(){this.bHasMoved=!0},o.prototype.SetPath=function(e){this.Path=e;var t=[this.ResolvedPath,this.Type,this.CameraType];o.ResolveTarget(e,t),this.ResolvedPath=t[0],this.Type=t[1],this.CameraType=t[2]},o.prototype.GetInsPathAndPMIIdByResolvedPath=function(e){var t="";if(this.GetType()===u.TARGETOBJECTTYPE_PMI||this.GetType()===u.TARGETOBJECTTYPE_ARROW){for(var r,i=-1,n=(r=this.GetResolvedPath()).length-1;0<=n;n--)if("\\"===r[n]){i=n;break}if(0<i){var o=r;o=o.substr(0,i),"\0",r[i+1]}else"",t=r}return t},o}();u.HBhvTargetObject=t}(M3D||(M3D={})),function(i){var e=function(){function a(e){void 0===e&&(e=null),this.pAnimation=e,this.pTimelineArray=[],this.pInstancedTimeline=null,this.CurrentTick=0,this.StartTick=0,this.CurrentRelativeTick=0,this.bCheckRelativeFrame=!0,this.pTLRangeArray=[]}return a.ProcessXMLData=function(e,t){var r=new a(t);t.SetTimeline(r);for(var i=e.textContent,n=(i=i.trim()).split(" "),o=0;o<n.length;++o)r.AddKeyframe(parseInt(n[o]));r.AddTLRange()},a.prototype.AddTLRange=function(){this.pTLRangeArray=[];var e,t=this.GetTimelineArrayLength(),r=new i.TimeLineRange(this);for(e=0;e<t-1;e++)r.AddKeyFrameIndex(e),this.pAnimation.IsAnimationInterval(e,e+1)&&(this.pTLRangeArray.push(r),r=new i.TimeLineRange(this));e==t-1&&(r.AddKeyFrameIndex(e),this.pTLRangeArray.push(r))},a.prototype.AddKeyframe=function(e){return this.AddKeyframeInternal(e)},a.prototype.Clone=function(){var e;new a;return e=this.GetTimelineArray(),this.SetTimeline(e),this},a.prototype.SetTimeline=function(e){this.pTimelineArray=[];for(var t=0;t<e.length;t++)this.pTimelineArray.push(e[t])},a.prototype.DeleteAllKeyframe=function(){this.pTimelineArray=[]},a.prototype.AddKeyframeInternal=function(e){var t,r,i=!1;i&&(i=!1);var n=0,o=e,a=this.GetTimelineArrayLength();if((t=0)<=(r=a-1))if(o<=this.pTimelineArray[r]&&o>=this.pTimelineArray[t])for(n=t+(r-t)/2;t<=r;){var s=this.pTimelineArray[n];if(s==o){n,i&&(i=!0);break}o<s?r=n-1:t=n+1,n=t+(r-t)/2}else o>=this.pTimelineArray[r]?n=r+1:o<=this.pTimelineArray[t]&&(n=t);else 0==a&&(n=0);if(i&&i)n>=this.pTimelineArray.length?this.pTimelineArray.push(e):this.pTimelineArray[n]=e;else{var l=this.pTimelineArray.splice(n,this.pTimelineArray.length-n,e);this.pTimelineArray=this.pTimelineArray.concat(l)}return this.pAnimation&&this.pAnimation.GetParentAnimation()&&this.pAnimation.GetParentAnimation().ResetFirstLastTickByChild(),[n,i]},a.prototype.GetTimelineArrayLength=function(){return this.pTimelineArray.length},a.prototype.SetAnimation=function(e){this.pAnimation=e},a.prototype.GetTimelineArray=function(){return 0<this.pTimelineArray.length?this.pTimelineArray:null},a.prototype.GetCurrentRelativeTick=function(){return this.CurrentRelativeTick},a.prototype.DeleteKeyframe=function(e){for(var t=0;t<this.GetTimelineArrayLength();t++)if(this.pTimelineArray[t]==e)return this.pTimelineArray.splice(t,1),this.pAnimation&&this.pAnimation.GetParentAnimation()&&this.pAnimation.GetParentAnimation().ResetFirstLastTickByChild(),t;return-1},a.prototype.SetCurrentRelativeTick=function(e){this.CurrentRelativeTick=e},a.prototype.SetCheckRelativeFrame=function(e){void 0===e&&(e=!0),this.bCheckRelativeFrame=e},a.prototype.SetStartTick=function(e){this.StartTick=e},a.prototype.GetStartTick=function(){return this.StartTick},a.prototype.GetAnimation=function(){return this.pAnimation},a.prototype.AdjustTickToTimeline=function(e){var t=this.GetAnimation().GetLoop(),r=this.GetTimelineArray(),i=this.GetTimelineArrayLength();(e-=this.StartTick)>r[i-1]&&0!=t&&(e-=e/r[i-1]*r[i-1]);return e},a.prototype.Evaluate=function(e,t,r){var i,n=this.GetTimelineArrayLength();if(n<=0)return[!1,t,r];var o,a,s=this.GetTimelineArray(),l=this.AdjustTickToTimeline(e);this.CurrentTick=e;var h=0;if(o=0,a=n-1,this.bCheckRelativeFrame&&l<s[0])return[!1,t,r];if(l<=s[a]&&l>=s[o]){for(h=o+(a-o)/2,h-=h%1;o<=a;){var u=s[h];if(u==l){i=h;break}l<u?a=h-1:o=h+1;var p=(a-o)/2;h=o+(p-=p%1),h-=h%1}i=h}else i=l<s[o]?o+1:l>s[a]?n:0;if(0==(i-=i%1)){if(!(1<=n))return[!1,t,r];i=1}if(i==n)return t=n,r=1,this.CurrentTick=s[n-1],[!0,t,r];var c=s[i]-s[i-1];if(r=(l-s[i-1])/c,0!=(t=i-1));return this.CurrentRelativeTick=l,[!0,t,r]},a.prototype.GetLastTick=function(){return this.pTimelineArray.length?this.pTimelineArray[this.pTimelineArray.length-1]:-1},a}();i.HBhvTimeline=e}(M3D||(M3D={})),function(T){var e=function(){function u(e,t,r,i,n,o,a,s){void 0===i&&(i=null),void 0===n&&(n=null),void 0===o&&(o=null),void 0===a&&(a=!0),void 0===s&&(s=-1),this.pParent=e,this.bSerializeFromKey=!0,this.Name=t||"",this.Path=r||"",this.Pos=new T.Vector3(0,0,0),i&&this.Pos.copyFrom(i),this.Quat=new T.Quaternion(1,0,0,0),n&&this.Quat.copyFrom(n),this.Scale=new T.Vector3(1,1,1),o&&this.Scale.copyFrom(o),this.bVisible=a,this.Trans=s,this.CameraType=T.HBhvCameraType.NoCamera;var l=[this.ResolvedPath,this.Type,this.CameraType];if(u.ResolveTarget(this.Path,l),this.ResolvedPath=l[0],this.Type=l[1],this.CameraType=l[2],this.Key=0,this.pParent)if(this.pParent instanceof T.SimulationAnimationManager)this.Key=this.pParent.RegisterInitTargetObjectKey();else if(this.pParent instanceof T.Process){var h=this.pParent.GetProcessManager().GetAnimationStepManager().GetSimulationAnimationManager().FindInitTargetObjectByPath(this.Path);this.Key=h?h.GetTargetKey():this.pParent.GetSimulationAnimationManager().RegisterInitTargetObjectKey()}}return u.ResolveTarget=function(e,t){var r,i,n,o;if(e){o=e,n=T.HBhvCameraType.NoCamera;var a=o.indexOf(":");i=o.substr(0,a),o=o.substr(a+1)||"",i==T.TARGETOBJECTTYPE_INS||i==T.TARGETOBJECTTYPE_PMI||i==T.TARGETOBJECTTYPE_CLIP||i==T.TARGETOBJECTTYPE_FOLDER||i==T.TARGETOBJECTTYPE_SOUND||i==T.TARGETOBJECTTYPE_IMAGE||"TID"==i||"ANIM"==i||"SSR"==i?(r=o,t[0]=r,t[1]=i,t[2]=n):"CAMERA"==i||"TARGET"==i||"POSITION"==i||"TARGETFREE"==i||"POSITIONFREE"==i||"POSITIONTARGET"==i?"CAMERA"==i?t[2]=T.HBhvCameraType.CameraPosition:"TARGET"==i?t[2]=T.HBhvCameraType.CameraTarget:"TARGETFREE"==i?t[2]=T.HBhvCameraType.CameraTargetFree:"POSITIONFREE"==i?t[2]=T.HBhvCameraType.CameraPositionFree:"POSITIONTARGET"==i&&(t[2]=T.HBhvCameraType.CameraPositionTarget):t[2]=T.HBhvCameraType.NoCamera}},u.prototype.GetTargetKey=function(){return-1==this.Key&&this.CameraType!=T.HBhvCameraType.NoCamera&&(this.Key=0),this.Key},u.prototype.IsEqual=function(e){return this.Path===e},u.ProcessXMLData=function(e,t){var r,i=/(\[)+([\-+]?[0-9]+\.?[0-9]*([eE][\-+]?[0-9]+)?)+[\s]+([\-+]?[0-9]*\.?[0-9]+([eE][\-+]?[0-9]+)?)+[\s]+([\-+]?[0-9]*\.?[0-9]+([eE][\-+]?[0-9]+)?)+(\])+/,n=e.getAttribute("ID"),o=e.getAttribute("Name"),a=e.getAttribute("Path"),s=e.getAttribute("pos");s?r=(u=i.exec(s))?new T.Vector3(parseFloat(u[2]),parseFloat(u[4]),parseFloat(u[6])):new T.Vector3:r=new T.Vector3;var l,h,u,p=e.getAttribute("quat");p?l=(u=/(\[)+([\-+]?[0-9]+\.?[0-9]*([eE][\-+]?[0-9]+)?)+[\s]+([\-+]?[0-9]*\.?[0-9]+([eE][\-+]?[0-9]+)?)+[\s]+([\-+]?[0-9]*\.?[0-9]+([eE][\-+]?[0-9]+)?)+[\s]+([\-+]?[0-9]*\.?[0-9]+([eE][\-+]?[0-9]+)?)+(\])+/.exec(p))?new T.Quaternion(parseFloat(u[8]),parseFloat(u[2]),parseFloat(u[4]),parseFloat(u[6])):new T.Quaternion:l=new T.Quaternion;(s=e.getAttribute("scale"))?h=(u=i.exec(s))?new T.Vector3(parseFloat(u[2]),parseFloat(u[4]),parseFloat(u[6])):new T.Vector3(1,1,1):h=new T.Vector3(1,1,1);var c,d;c="1"==e.getAttribute("visible");var S,f=e.getAttribute("trans");if(d=parseFloat(f),t instanceof T.SimulationAnimationManager)"IMAGE"!==o.substr(0,5)&&(S=t.CreateInitTargetObjectByPath(o,a));else if(t instanceof T.Process){if(""==o&&""==a||null==o&&null==a||null==o&&null==a){var m=T.SimulationAnimationManager.Instance();if(m){var y=m.FindInitTargetObjectByByID(n);y&&(o=y.GetName(),a=y.GetPath())}}S=t.CreateTargetObjectByPath(o,a)}S&&(S.Pos=new T.Vector3(r.x,r.y,r.z),S.Quat=new T.Quaternion(l.w,l.x,l.y,l.z),S.Scale=new T.Vector3(h.x,h.y,h.z),S.bVisible=c,S.Key=n,S.Trans=d)},u.prototype.GetCameraType=function(){return this.CameraType},u.prototype.GetName=function(){return this.Name},u.prototype.GetPath=function(){return this.Path},u.prototype.GetType=function(){return this.Type},u.prototype.GetResolvedPath=function(){return this.ResolvedPath},u.prototype.GetInsPathAndPMIIdByResolvedPath=function(e){var t;if("PMI"==this.GetType()){for(var r,i=-1,n=(r=this.GetResolvedPath()).length-1;0<=n;n--)if("\\"==r[n]){i=n;break}if(0<i){var o=r;o=o.substr(0,i),t.concat(r.substr(i+1))}else"",t=r}return t},u.prototype.GetPos=function(){return this.Pos},u.prototype.GetQuat=function(){return this.Quat},u.prototype.GetScale=function(){return this.Scale},u.prototype.GetVisible=function(){return this.bVisible},u.prototype.GetTrans=function(){return this.Trans},u}();T.ProcessTargetObject=e}(M3D||(M3D={})),function(u){var e=function(){function e(){this.InitTargetObjectList=[],this.ChildrenSAManagerList=[],this.view=null,this.BehaviorManagerList=[],this.InitTargetObjectList=[],this.bCameraPlay=!0,this.bShowTrochoid=!1,this.bPlaySound=!1,this.bPlayVisible=!0,this.bPlayImage=!0,this.bPlayPosRot=!0,this.bPlayClip=!0,this.bPlayColor=!0,this.bCollisionCheck=!1,this.CollisionDelay=100,this.bStopPlayAfterCollision=!1,this.bContinuousPlay=!1,this.bReversePlay=!1,this.fPlaySpeed=1,this.pAnimationPlayApi=new u.AnimationPlayApi}return e.prototype.GetView=function(){return this.view},e.prototype.SetView=function(e){this.view=e},e.prototype.SetChildSAManagerStr=function(e){this.pChildSAManagerStr=e},e.prototype.FindInitTargetObjectByByID=function(e){for(var t=0;t<this.InitTargetObjectList.length;++t)if(this.InitTargetObjectList[t].GetTargetKey()==e)return this.InitTargetObjectList[t];return null},e.prototype.GetContinuousPlay=function(){return this.bContinuousPlay},e.prototype.SetContinuousPlay=function(e){this.bContinuousPlay=e},e.prototype.GetInitTargetObjectList=function(){return this.InitTargetObjectList},e.prototype.GetAnimationPlayCBList=function(){return this.pAnimationPlayApi.pAnimationPlayCBList},e.prototype.ReSetCBTran=function(){this.pAnimationRelated?this.pAnimationRelated.ReSetCBTran():(this.pAnimationRelated=new u.AnimationRelated,this.pAnimationRelated.SetAnimationPlayCB())},e.prototype.ProcessXMLData=function(e){var t=e.getElementsByTagName("SimulationAnimation");if(0<t.length){var r=t[0];this.CurSAID=r.getAttribute("CurSAID"),this.Version=r.getAttribute("Version"),this.Company=r.getAttribute("Company"),this.Name=r.getAttribute("Name"),this.SVLVersion=r.getAttribute("SVLVersion"),r.getAttribute("ViewerVersion")?this.ViewerVersion=r.getAttribute("ViewerVersion"):this.ViewerVersion="6.1";for(var i=0;i<r.childNodes.length;++i){var n=r.childNodes[i];if(1===n.nodeType)switch(n.nodeName){case"BehaviorManager":u.HBhvBehaviorManager.ProcessXMLData(n,this);break;case"InitTargetObject":for(var o=0;o<n.childNodes.length;++o){var a=n.childNodes[o];if(1===a.nodeType)switch(a.nodeName){case"ProcessTargetObject":u.ProcessTargetObject.ProcessXMLData(a,this)}}break;case"AnimationStepManager":u.AnimationStepManager.ProcessXMLData(n,this)}}this.GetBehaviorManagerCount()<=0&&this.AddSimAni(0),this.pAnimationStepManager||(this.pAnimationStepManager=this.CreateAnimationStepManager());var s=this.pAnimationStepManager.GetCurrentProcessManager();s||(s=this.pAnimationStepManager.AddProcessManager());var l=s.GetCurrentProcess();if(!l){for(var h=0;h<this.pAnimationStepManager.GetProcessManagerCount()&&(!(s=this.pAnimationStepManager.GetProcessManagerByIdx(h))||!(l=s.GetCurrentProcess()));h++);l?s.SetCurProcessByID(l.GetID(),!1):s.AddProcess(0,null,!1)}}this.ReSetCBTran(),this.GetAnimationStepManager()&&this.GetAnimationStepManager().CaculateTickCount()},e.prototype.GetCurSAID=function(){return this.CurSAID},e.prototype.GetBehaviorManagerCount=function(){return this.BehaviorManagerList.length},e.prototype.RegisterBehaviorManagerID=function(){for(var e=0,t=0;t<this.BehaviorManagerList.length;++t)this.BehaviorManagerList[t].GetID()>=e&&(e=this.BehaviorManagerList[t].GetID()+1);return e},e.prototype.AddSimAni=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(1!=e.length){var r=null;return(r=this.FindSimAniByID(e[0]))?(this.CurSAID=e[0],r.SetName(e[3]),r.SetTicksPerSecond(e[1]),r.DeleteAllAnimations()):4==e.length?(r=new u.HBhvBehaviorManager(e[0],e[1],e[2],e[3]),this.AddSimAni(r)):6==e.length&&(r=new u.HBhvBehaviorManager(e[0],e[1],e[2],e[3],e[4],e[5]),this.AddSimAni(r)),r}if(e[0]instanceof u.HBhvBehaviorManager){var i=e[0];null!==i&&(this.BehaviorManagerList.push(i),this.CurSAID=i.GetID(),i.SetSimulationAnimationManager(this))}else this.AddSimAni(e[0],10,0,"")},e.prototype.DeleteSimAni=function(e){e&&(e.IsPlaying()&&e.Stop(),e.GetID()===this.CurSAID&&(0<this.GetBehaviorManagerCount()?this.CurSAID=0:this.CurSAID=-1),this.BehaviorManagerList.splice(this.BehaviorManagerList.indexOf(e),1))},e.prototype.DeleteAllSimAni=function(){for(var e=0;e<this.BehaviorManagerList.length;e++){var t=this.BehaviorManagerList[e];t.IsPlaying()&&t.Stop()}this.BehaviorManagerList=[],this.CurSAID=-1},e.prototype.CreateAnimationStepManager=function(e){return void 0===e&&(e=null),this.pAnimationStepManager?(this.pAnimationStepManager.SetName(e),this.pAnimationStepManager.DeleteAllProcessManager()):(this.pAnimationStepManager=new u.AnimationStepManager(e),this.pAnimationStepManager.SetSimulationAnimationManager(this)),this.pAnimationStepManager},e.prototype.IsPlaying=function(){for(var e=!1,t=0;t<this.BehaviorManagerList.length;t++)if(this.BehaviorManagerList[t].IsPlaying()){e=!0;break}return e},e.prototype.SetCurSAByID=function(e){this.CurSAID=e},e.prototype.IsPlayPosRot=function(){return this.bPlayPosRot},e.prototype.SetCameraPlay=function(e){this.bCameraPlay=e,this.GetCurrentSA()&&this.GetCurrentSA().IsPlaying()&&(this.GetCurrentSA().Stop(),this.GetCurrentSA().ScheduleAllAnimations(!0),this.GetCurrentSA().ExecuteAnimations(this.GetCurrentSA().GetCurrentTick(),0),this.GetCurrentSA().Continue())},e.prototype.GetPlaySpeed=function(){return this.fPlaySpeed},e.prototype.SetPlaySpeed=function(e){this.fPlaySpeed=e},e.prototype.GetCurrentSA=function(){return-1!=this.CurSAID?this.FindSimAniByID(this.CurSAID):null},e.prototype.FindSimAniByID=function(e){for(var t=0;t<this.BehaviorManagerList.length;++t)if(this.BehaviorManagerList[t].GetID()==e)return this.BehaviorManagerList[t];return null},e.prototype.GetAnimationPlayApi=function(){return this.pAnimationPlayApi},e.prototype.IsCameraPlay=function(){return this.bCameraPlay},e.prototype.CreateInitTargetObjectByPath=function(e,t){var r;return(r=this.FindInitTargetObjectByPath(t))||(r=new u.ProcessTargetObject(this,e,t),this.AddInitTargetObject(r)),r},e.prototype.AddInitTargetObject=function(e){return this.InitTargetObjectList.push(e),e},e.prototype.RegisterInitTargetObjectKey=function(){for(var e=0,t=0;t<this.InitTargetObjectList.length;++t)this.InitTargetObjectList[t].GetTargetKey()>=e&&(e=Number(this.InitTargetObjectList[t].GetTargetKey())+1);return e},e.prototype.FindInitTargetObjectByPath=function(e){for(var t=0;t<this.InitTargetObjectList.length;++t)if(this.InitTargetObjectList[t].IsEqual(e))return this.InitTargetObjectList[t];return null},e.Instance=function(){return e.instance||(e.instance=new e),e.instance},e.prototype.GetReversePlay=function(){return this.bReversePlay},e.prototype.GetAnimationStepManager=function(){return this.pAnimationStepManager},e.prototype.HasAnimations=function(){for(var e=!1,t=0;t<this.BehaviorManagerList.length;++t)if(this.BehaviorManagerList[t].HasAnimations()){e=!0;break}if(!e)for(var r=this.ChildrenSAManagerList,i=0;i<r.length;i++)e=r[i].HasAnimations();return e},e.prototype.StopAll=function(){for(var e=0;e<this.BehaviorManagerList.length;++e)this.BehaviorManagerList[e].Stop()},e.prototype.ExitAll=function(){for(var e=this.ChildrenSAManagerList,t=0;t<e.length;t++)e[t].ExitAll();var r=this.BehaviorManagerList;for(t=0;t<r.length;t++){var i=r[t];i.SetCurrentTick(i.GetLastTick()),i.ExecuteAnimations(i.GetLastTick(),0)}},e.prototype.GetVersion=function(){return this.Version},e.prototype.SetReversePlay=function(e){this.bReversePlay=e},e.prototype.IsPlayVisible=function(){return this.bPlayVisible},e.prototype.SetPlayVisibleStatus=function(e){this.bPlayVisible=e,this.GetCurrentSA()&&this.GetCurrentSA().IsPlaying()&&(this.GetCurrentSA().Stop(),this.GetCurrentSA().ScheduleAllAnimations(),this.GetCurrentSA().ExecuteAnimations(this.GetCurrentSA().GetCurrentTick(),0),this.GetCurrentSA().Continue())},e.prototype.IsPlayColor=function(){return this.bPlayColor},e.prototype.SetPlayColorStatus=function(e){this.bPlayColor=e,this.GetCurrentSA()&&this.GetCurrentSA().IsPlaying()&&(this.GetCurrentSA().Stop(),this.GetCurrentSA().ScheduleAllAnimations(),this.GetCurrentSA().ExecuteAnimations(this.GetCurrentSA().GetCurrentTick(),0),this.GetCurrentSA().Continue())},e.prototype.IsPlayClip=function(){return this.bPlayClip},e.prototype.SetPlayClipStatus=function(e){this.bPlayClip=e,this.GetCurrentSA()&&this.GetCurrentSA().IsPlaying()&&(this.GetCurrentSA().Stop(),this.GetCurrentSA().ScheduleAllAnimations(),this.GetCurrentSA().ExecuteAnimations(this.GetCurrentSA().GetCurrentTick(),0),this.GetCurrentSA().Continue())},e.prototype.IsPlayImage=function(){return this.bPlayImage},e.prototype.SetPlayImageStatus=function(e){this.bPlayImage=e,this.GetCurrentSA()&&this.GetCurrentSA().IsPlaying()&&(this.GetCurrentSA().Stop(),this.GetCurrentSA().ScheduleAllAnimations(),this.GetCurrentSA().ExecuteAnimations(this.GetCurrentSA().GetCurrentTick(),0),this.GetCurrentSA().Continue())},e.prototype.AddChildSAManager=function(e){this.ChildrenSAManagerList.push(e);for(var t=e.ChildrenSAManagerList,r=0;r<t.length;r++)this.AddChildSAManager(t[r]);return e},e.prototype.DeleteChildSAManager=function(e){var t=!1;if(e){this.IsPlaying()&&this.StopAll();for(var r=0;r<this.ChildrenSAManagerList.length;r++){if(e===this.ChildrenSAManagerList[r]){t=!0;break}t=this.ChildrenSAManagerList[r].DeleteChildSAManager(e)}0<=this.ChildrenSAManagerList.indexOf(e)&&this.ChildrenSAManagerList.splice(this.ChildrenSAManagerList.indexOf(e),1)}return t},e.prototype.DeleteAllChildSAManager=function(){this.IsPlaying()&&this.StopAll(),this.ChildrenSAManagerList=[]},e.prototype.FindChildSAManagerBySAFilePath=function(e){for(var t=0;t<this.ChildrenSAManagerList.length;t++)if(e===this.ChildrenSAManagerList[t].strSAFilePath)return this.ChildrenSAManagerList[t];return null},e.prototype.SetTempFilePath=function(e){this.strSAFilePath=e},e.prototype.FindChildSAManagerBySAFileName=function(e){if(this.ChildrenSAManagerList)for(var t=0;t<this.ChildrenSAManagerList.length;t++){var r=this.ChildrenSAManagerList[t].strSAFilePath,i=r.lastIndexOf("//");if(e===(r=r.substr(i+1,r.length-i-1)))return this.ChildrenSAManagerList[t]}return null},e.prototype.Load=function(){for(var e=this.pAnimationStepManager.GetProcessManagerList(),t=0;t<e.length;t++){var r=e[t];r instanceof u.ChildAnimationProcessManager?r.Load():r instanceof u.ChildAnimation&&r.Load()}},e.instance=null,e}();u.SimulationAnimationManager=e}(M3D||(M3D={})),function(e){var t=function(){this.Name="",this.ID=-1,this.Path="",this.InsPath="",this.EntId=-1,this.bVisible=!1,this.Trans=-1,this.Type=-1,this.Pos=e.ArrayMaker.MakeNumArray(3),this.Quat=e.ArrayMaker.MakeNumArray(4),this.Scale=e.ArrayMaker.MakeNumArray(3),this.Color=e.ArrayMaker.MakeNumArray(3)};e.TargetObjectInfo=t}(M3D||(M3D={})),function(e){var t=function(){function e(e){this.tlKeyFrameIndexArray=[],this.pTimeLine=e}return e.prototype.AddKeyFrameIndex=function(e){this.tlKeyFrameIndexArray.push(e)},e}();e.TimeLineRange=t}(M3D||(M3D={})),function(e){var t=function(){};(M3D||(M3D={})).AreaAllocator=t}(),function(u){var e=function(){function h(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this.min=new u.Vector3,this.max=new u.Vector3;var r=!(this.defined=!1);if(1==e.length)e[0]instanceof h?(r=!1,this.copyFrom(e[0])):e[0]instanceof u.Rect?(r=!1,this.min=new u.Vector3(e[0].min,0),this.max=new u.Vector3(e[0].max,0),this.defined=!0):e[0]instanceof u.Frustum&&(r=!1,this.defined=!1,this.Define(e[0]));else if(2==e.length)if(e[0],u.Vector3,e[1]instanceof u.Vector3)r=!1,this.min.copyFrom(e[0]),this.max.copyFrom(e[1]),this.defined=!0;else if("number"==typeof e[0]&&"number"==typeof e[1]){r=!1;var i=e[0],n=e[1];this.min=new u.Vector3(i,i,i),this.max=new u.Vector3(n,n,n),this.defined=!0}else e[0]instanceof u.Vector3&&"number"==typeof e[1]&&(r=!1,this.defined=!1,this.Define(e[0],e[1]));r&&(this.min.copyFrom(u.Vector3.ZERO()),this.max.copyFrom(u.Vector3.ZERO()),this.defined=!1)}return h.prototype.copyFrom=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];1==e.length&&(e[0]instanceof h?(this.min.copyFrom(e[0].min),this.max.copyFrom(e[0].max),this.defined=e[0].defined):e[0]instanceof u.Rect&&(this.min=new u.Vector3(e[0].min,0),this.max=new u.Vector3(e[0].max,0),this.defined=!0))},h.prototype.Define=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(1==e.length)e[0]instanceof h?this.Define(e[0].min,e[0].max):e[0]instanceof u.Rect?this.Define(new u.Vector3(e[0].min,0),new u.Vector3(e[0].max,0)):e[0]instanceof u.Vector3?(this.min.copyFrom(e[0]),this.max.copyFrom(e[0]),this.defined=!0):e[0]instanceof u.Frustum?this.Define(e[0].vertices,u.NUFRUSTUVERTICES):"[object Array]"==Object.prototype.toString.call(e[0])&&this.Merge(e[0]);else if(2==e.length)if(e[0]instanceof u.Vector3&&e[1]instanceof u.Vector3)this.min.copyFrom(e[0]),this.max.copyFrom(e[1]),this.defined=!0;else if("number"==typeof e[0]&&"number"==typeof e[1]){var r=e[0],i=e[1];this.min=new u.Vector3(r,r,r),this.max=new u.Vector3(i,i,i),this.defined=!0}},h.prototype.Merge=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(1==e.length){if(e[0]instanceof h){if(!this.defined)return this.min.copyFrom(e[0].min),this.max.copyFrom(e[0].max),void(this.defined=!0);e[0].min.x<this.min.x&&(this.min.x=e[0].min.x),e[0].min.y<this.min.y&&(this.min.y=e[0].min.y),e[0].min.z<this.min.z&&(this.min.z=e[0].min.z),e[0].max.x>this.max.x&&(this.max.x=e[0].max.x),e[0].max.y>this.max.y&&(this.max.y=e[0].max.y),e[0].max.z>this.max.z&&(this.max.z=e[0].max.z)}else if(e[0]instanceof u.Vector3){if(!this.defined)return this.min.copyFrom(e[0]),this.max.copyFrom(e[0]),void(this.defined=!0);e[0].x<this.min.x&&(this.min.x=e[0].x),e[0].y<this.min.y&&(this.min.y=e[0].y),e[0].z<this.min.z&&(this.min.z=e[0].z),e[0].x>this.max.x&&(this.max.x=e[0].x),e[0].y>this.max.y&&(this.max.y=e[0].y),e[0].z>this.max.z&&(this.max.z=e[0].z)}else if(e[0]instanceof u.Frustum)this.Merge(e[0].vertices);else if("[object Array]"==Object.prototype.toString.call(e[0]))for(var r=0;r<e[0].length;++r)this.Merge(e[0][r])}else if(3==e.length&&"number"==typeof e[0]&&"number"==typeof e[1]&&"number"==typeof e[2]){if(!this.defined)return this.min.x=e[0],this.min.y=e[1],this.min.z=e[2],this.max.x=e[0],this.max.y=e[1],this.max.z=e[2],void(this.defined=!0);e[0]<this.min.x&&(this.min.x=e[0]),e[1]<this.min.y&&(this.min.y=e[1]),e[2]<this.min.z&&(this.min.z=e[2]),e[0]>this.max.x&&(this.max.x=e[0]),e[1]>this.max.y&&(this.max.y=e[1]),e[2]>this.max.z&&(this.max.z=e[2])}},h.prototype.Clip=function(e){if(e.min.x>this.min.x&&(this.min.x=e.min.x),e.max.x<this.max.x&&(this.max.x=e.max.x),e.min.y>this.min.y&&(this.min.y=e.min.y),e.max.y<this.max.y&&(this.max.y=e.max.y),e.min.z>this.min.z&&(this.min.z=e.min.z),e.max.z<this.max.z&&(this.max.z=e.max.z),this.min.x>this.max.x){var t=this.min.x;this.min.x=this.max.x,this.max.x=t}if(this.min.y>this.max.y){t=this.min.y;this.min.y=this.max.y,this.max.y=t}if(this.min.z>this.max.z){t=this.min.z;this.min.z=this.max.z,this.max.z=t}},h.prototype.Transform=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];1==e.length&&(e[0]instanceof u.Matrix3?this.copyFrom(this.Transformed(new u.Matrix3x4(e[0]))):e[0]instanceof u.Matrix3x4&&this.copyFrom(this.Transformed(e[0])))},h.prototype.Transformed=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(1==e.length){if(e[0]instanceof u.Matrix3)return this.Transformed(new u.Matrix3x4(e[0]));if(e[0]instanceof u.Matrix3x4){var r=e[0].Multiply(this.Center()),i=this.Size().Multiply(.5),n=new u.Vector3(Math.abs(e[0].data[0])*i.x+Math.abs(e[0].data[1])*i.y+Math.abs(e[0].data[2])*i.z,Math.abs(e[0].data[4])*i.x+Math.abs(e[0].data[5])*i.y+Math.abs(e[0].data[6])*i.z,Math.abs(e[0].data[8])*i.x+Math.abs(e[0].data[9])*i.y+Math.abs(e[0].data[10])*i.z);return new h(r.Sub(n),r.AddED(n))}}},h.prototype.Clear=function(){this.min=u.Vector3.ZERO().Clone(),this.max=u.Vector3.ZERO().Clone(),this.defined=!1,this.GetVertexs()},h.prototype.Center=function(){return this.max.Add(this.min).MultiplyED(.5)},h.prototype.Size=function(){return this.max.Sub(this.min)},h.prototype.HalfSize=function(){return this.max.Sub(this.min).Multiply(.5)},h.prototype.Length=function(){return this.max.Sub(this.min).Length()},h.prototype.GetXLength=function(){var e=this.max.x-this.min.x;return 0<=e?e:-e},h.prototype.GetYLength=function(){var e=this.max.y-this.min.y;return 0<=e?e:-e},h.prototype.GetZLength=function(){var e=this.max.z-this.min.z;return 0<=e?e:-e},h.prototype.Projected=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(1==e.length){if(e[0]instanceof u.Matrix4){var r=this.min.Clone(),i=this.max.Clone();r.z<u.MIN_NEARCLIP&&(r.z=u.MIN_NEARCLIP),i.z<u.MIN_NEARCLIP&&(i.z=u.MIN_NEARCLIP),(s=Array(8))[0]=r,s[1]=new u.Vector3(i.x,r.y,r.z),s[2]=new u.Vector3(r.x,i.y,r.z),s[3]=new u.Vector3(i.x,i.y,r.z),s[4]=new u.Vector3(r.x,r.y,i.z),s[5]=new u.Vector3(i.x,r.y,i.z),s[6]=new u.Vector3(r.x,i.y,i.z),s[7]=i;for(var n=new u.Rect,o=0;o<8;++o){var a=e[0].Multiply(s[o]);n.Merge(new u.Vector2(a.x,a.y))}return n}if(e[0]instanceof u.Plane){var s,l=new h;r=this.min.Clone(),i=this.max.Clone();(s=[])[0]=r,s[1]=new u.Vector3(i.x,r.y,r.z),s[2]=new u.Vector3(r.x,i.y,r.z),s[3]=new u.Vector3(i.x,i.y,r.z),s[4]=new u.Vector3(r.x,r.y,i.z),s[5]=new u.Vector3(i.x,r.y,i.z),s[6]=new u.Vector3(r.x,i.y,i.z),s[7]=i;for(o=0;o<8;++o){a=e[0].Project(s[o]);l.Merge(new u.Vector3(a.x,a.y,a.z))}return l}}},h.prototype.IsInside=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(1==e.length)return e[0]instanceof u.Vector3?e[0].x<this.min.x||e[0].x>this.max.x||e[0].y<this.min.y||e[0].y>this.max.y||e[0].z<this.min.z||e[0].z>this.max.z?u.Intersection.OUTSIDE:u.Intersection.INSIDE:e[0]instanceof h?e[0].max.x<this.min.x||e[0].min.x>this.max.x||e[0].max.y<this.min.y||e[0].min.y>this.max.y||e[0].max.z<this.min.z||e[0].min.z>this.max.z?u.Intersection.OUTSIDE:e[0].min.x<this.min.x||e[0].max.x>this.max.x||e[0].min.y<this.min.y||e[0].max.y>this.max.y||e[0].min.z<this.min.z||e[0].max.z>this.max.z?u.Intersection.INTERSECTS:u.Intersection.INSIDE:void 0},h.prototype.IsInsideFast=function(e){return e.max.x<this.min.x||e.min.x>this.max.x||e.max.y<this.min.y||e.min.y>this.max.y||e.max.z<this.min.z||e.min.z>this.max.z?u.Intersection.OUTSIDE:u.Intersection.INSIDE},h.prototype.GetTriangleArray=function(){for(var e=h.pointsArray,t=this.GetVertexs(),r=new Float32Array(4),i=0;i<12;i++)for(var n=0;n<3;n++){var o=3*h.triIndex()[i][n];r[0]=t[o],r[1]=t[o+1],r[2]=t[o+2],r[3]=1,e[9*i+3*n+0]=r[0]/r[3],e[9*i+3*n+1]=r[1]/r[3],e[9*i+3*n+2]=r[2]/r[3]}return e},h.prototype.GetVertexs=function(){var e=h.points;return e[0]=this.max.x,e[1]=this.max.y,e[2]=this.max.z,e[3]=this.min.x,e[4]=this.max.y,e[5]=this.max.z,e[6]=this.min.x,e[7]=this.min.y,e[8]=this.max.z,e[9]=this.max.x,e[10]=this.min.y,e[11]=this.max.z,e[12]=this.max.x,e[13]=this.min.y,e[14]=this.min.z,e[15]=this.max.x,e[16]=this.max.y,e[17]=this.min.z,e[18]=this.min.x,e[19]=this.max.y,e[20]=this.min.z,e[21]=this.min.x,e[22]=this.min.y,e[23]=this.min.z,e},h.prototype.Defined=function(){return this.defined},h.prototype.ScaleBox=function(e){var t=this.Center().Clone(),r=this.max.Sub(t).NormalizedED(),i=this.min.Sub(t).NormalizedED(),n=t.Add(r.MultiplyED(this.max.Sub(t).Length()*e)),o=t.Add(i.MultiplyED(this.min.Sub(t).Length()*e));this.max=n.Clone(),this.min=o.Clone()},h.prototype.Clone=function(){return new h(this)},h.prototype.Tostring=function(){return"min:"+this.min.Tostring()+"max:"+this.max.Tostring()},h.prototype.fromString=function(e){var t=!1,r=e.split(" ");return 6==r.length&&(this.min=new u.Vector3(parseFloat(r[0]),parseFloat(r[1]),parseFloat(r[2])),this.max=new u.Vector3(parseFloat(r[3]),parseFloat(r[4]),parseFloat(r[5])),t=!0),t},h.boxIndexs=function(){return null===h._boxIndexs&&(h._boxIndexs=[0,1,1,2,2,3,3,0,3,4,4,5,5,0,5,6,6,7,7,4,6,1,7,2]),h._boxIndexs},h.chicumIndex=function(){return null===h._chicumIndex&&(h._chicumIndex=[6,7,7,4,7,2]),h._chicumIndex},h.triIndex=function(){return null===h._triIndex&&(h._triIndex=[[1,0,2],[0,3,2],[0,4,3],[0,5,4],[7,4,5],[5,6,7],[6,1,7],[1,2,7],[6,0,1],[6,5,0],[3,7,2],[3,4,7]]),h._triIndex},h.ZeroBox=function(){return null==h._ZeroBox&&(h._ZeroBox=new h),h._ZeroBox},h.MAX_BOX=function(){return null==h._MAX_BOX&&(h._MAX_BOX=new h),h._MAX_BOX},h.NO_BOX=function(){return null==h._NO_BOX&&(h._NO_BOX=new h),h._NO_BOX},h._boxIndexs=null,h._chicumIndex=null,h._triIndex=null,h.points=new Float32Array(108),h.pointsArray=new Float32Array(24),h}();u.BoundingBox=e}(M3D||(M3D={})),function(n){var e=function(){function i(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=!0;1==e.length?e[0]instanceof i?(r=!1,this.copyFrom(e[0])):e[0]instanceof Float32Array&&4===e[0].length&&(r=!1,this.r=e[0][0],this.g=e[0][1],this.b=e[0][2],this.a=e[0][3]):2==e.length?e[0]instanceof i&&"number"==typeof e[1]&&(r=!1,this.copyFrom(e[0]),this.a=e[1]):3==e.length?"number"==typeof e[0]&&"number"==typeof e[1]&&"number"==typeof e[2]&&(r=!1,this.r=e[0],this.g=e[1],this.b=e[2],this.a=1):4==e.length&&"number"==typeof e[0]&&"number"==typeof e[1]&&"number"==typeof e[2]&&"number"==typeof e[3]&&(r=!1,this.r=e[0],this.g=e[1],this.b=e[2],this.a=e[3]),r&&(this.r=.8,this.g=.8,this.b=.8,this.a=1)}return i.prototype.Clone=function(){return new i(this)},i.prototype.SetColor=function(e,t,r,i){void 0===i&&(i=1),this.r=e,this.g=t,this.b=r,this.a=i},i.prototype.copyFrom=function(e){this.r=e.r,this.g=e.g,this.b=e.b,this.a=e.a},i.prototype.Equals=function(e){return n.Equals(this.r,e.r)&&n.Equals(this.g,e.g)&&n.Equals(this.b,e.b)&&n.Equals(this.a,e.a)},i.prototype.Multiply=function(e){return new i(this.r*e,this.g*e,this.b*e,this.a*e)},i.prototype.Add=function(e){return new i(this.r+e.r,this.g+e.g,this.b+e.b,this.a+e.a)},i.prototype.AddED=function(e){this.r+=e.r,this.g+=e.g,this.b+=e.b,this.a+=e.a},i.prototype.Sub=function(e){return new i(this.r-e.r,this.g-e.g,this.b-e.b,this.a-e.a)},i.prototype.Data=function(){var e=new Float32Array(4);return e[0]=this.r,e[1]=this.g,e[2]=this.b,e[3]=this.a,e},i.prototype.ToUInt=function(){var e=n.Clamp(255*this.r,0,255),t=n.Clamp(255*this.g,0,255),r=n.Clamp(255*this.b,0,255);return n.Clamp(255*this.a,0,255)<<24|r<<16|t<<8|e},i.prototype.Bounds=function(e,t){void 0===t&&(t=!1),e.length<2||(this.r>this.g?this.g>this.b?(e[1]=this.r,e[0]=this.b):(e[1]=this.r>this.b?this.r:this.b,e[0]=this.g):this.b>this.g?(e[1]=this.b,e[0]=this.r):(e[1]=this.g,e[0]=this.r<this.b?this.r:this.b),t&&(e[1]=1<e[1]?1:e[1]<0?0:e[1],e[0]=1<e[0]?1:e[0]<0?0:e[0]))},i.prototype.ToHSL=function(){var e=[0,0];this.Bounds(e,!0);var t=this.Hue(e[0],e[1]),r=this.SaturationHSL(e[0],e[1]),i=.5*(e[0]+e[1]);return new n.Vector3(t,r,i)},i.prototype.ToHSV=function(){var e=[0,0];this.Bounds(e,!0);var t=this.Hue(e[0],e[1]),r=this.SaturationHSV(e[0],e[1]),i=e[1];return new n.Vector3(t,r,i)},i.prototype.SaturationHSV=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(0==e.length){var r=[0,0];return this.Bounds(r,!0),this.SaturationHSV(r[0],r[1])}if(2==e.length)return e[1]<=n.EPSILON?0:1-e[0]/e[1]},i.prototype.Value=function(){return this.MaxRGB()},i.prototype.FromHSL=function(e,t,r,i){var n,o=r-.5*(n=r<.5?(2*r-1+1)*t:(1-(2*r-1))*t);this.FromHCM(e,n,o),this.a=i},i.prototype.FromHSV=function(e,t,r,i){var n=r*t,o=r-n;this.FromHCM(e,n,o),this.a=i},i.prototype.ToVector3=function(){return new n.Vector3(this.r,this.g,this.b)},i.prototype.ToVector4=function(){return new n.Vector4(this.r,this.g,this.b,this.a)},i.prototype.SumRGB=function(){return this.r+this.g+this.b},i.prototype.Average=function(){return(this.r+this.g+this.b)/3},i.prototype.Luma=function(){return.299*this.r+.587*this.g+.114*this.b},i.prototype.Chroma=function(){var e=[0,0];return this.Bounds(e,!0),e[1]-e[0]},i.prototype.Hue=function(e,t){var r=t-e;if(r<=n.EPSILON)return 0;if(n.Equals(this.g,t))return(this.b+2*r-this.r)/(6*r);if(n.Equals(this.b,t))return(4*r-this.g+this.r)/(6*r);var i=(this.g-this.b)/(6*r);return i<0?1+i:1<=i?i-1:i},i.prototype.SaturationHSL=function(e,t){if(t<=n.EPSILON||e>=1-n.EPSILON)return 0;var r=t+e;return r<=1?(t-e)/r:(e-t)/(r-2)},i.prototype.MaxRGB=function(){return this.r>this.g?this.r>this.b?this.r:this.b:this.g>this.b?this.g:this.b},i.prototype.MinRGB=function(){return this.r<this.g?this.r<this.b?this.r:this.b:this.g<this.b?this.g:this.b},i.prototype.Range=function(){var e=[0,0];return this.Bounds(e),e[1]-e[0]},i.prototype.Lightness=function(){var e=[0,0];return this.Bounds(e,!0),.5*(e[1]+e[0])},i.prototype.IsTransparent=function(){return this.a<.99},i.prototype.Clip=function(e){this.r=1<this.r?1:this.r<0?0:this.r,this.g=1<this.g?1:this.g<0?0:this.g,this.b=1<this.b?1:this.b<0?0:this.b,e&&(this.a=1<this.a?1:this.a<0?0:this.a)},i.prototype.Invert=function(e){this.r=1-this.r,this.g=1-this.g,this.b=1-this.b,e&&(this.a=1-this.a)},i.prototype.Lerp=function(e,t){var r=1-t;return new i(this.r*r+e.r*t,this.g*r+e.g*t,this.b*r+e.b*t,this.a*r+e.a*t)},i.prototype.Abs=function(){return new i(Math.abs(this.r),Math.abs(this.g),Math.abs(this.b),Math.abs(this.a))},i.prototype.FromHCM=function(e,t,r){(e<0||1<=e)&&(e-=Math.floor(e));var i=6*e,n=t*(1-Math.abs(i%2-1));i<2?(this.b=0,this.r=i<1?(this.g=n,t):(this.g=t,n)):this.b=i<4?(this.r=0,i<3?(this.g=t,n):(this.g=n,t)):(this.g=0,i<5?(this.r=n,t):(this.r=t,n)),this.r+=r,this.g+=r,this.b+=r},i.prototype.Tostring=function(){return this.r.toString()+" "+this.g.toString()+" "+this.b.toString()+" "+this.a.toString()},i.prototype.FromString=function(e){var t=e.split(" ");3===t.length?(this.r=Number(t[0]),this.g=Number(t[1]),this.b=Number(t[2])):4===t.length&&(this.r=Number(t[0]),this.g=Number(t[1]),this.b=Number(t[2]),this.a=Number(t[3]))},i.prototype.FromHexadecimal=function(e){this.r=(e>>16&255)/255,this.g=(e>>8&255)/255,this.b=(255&e)/255,this.a=1},i.WHITE=function(){return null===i.white&&(i.white=new i(1,1,1,1)),i.white},i.GRAY=function(){return null===i.gray&&(i.gray=new i(.5,.5,.5)),i.gray},i.BLACK=function(){return null===i.black&&(i.black=new i(0,0,0)),i.black},i.RED=function(){return null===i.red&&(i.red=new i(1,0,0)),i.red},i.GREEN=function(){return null===i.green&&(i.green=new i(0,1,0)),i.green},i.BLUE=function(){return null===i.blue&&(i.blue=new i(0,0,1)),i.blue},i.CYAN=function(){return null===i.cyan&&(i.cyan=new i(0,1,1)),i.cyan},i.MAGENTA=function(){return null===i.magenta&&(i.magenta=new i(1,0,1)),i.magenta},i.YELLOW=function(){return null===i.yellow&&(i.yellow=new i(1,1,0)),i.yellow},i.TRANSPARENT=function(){return null===i.transparent&&(i.transparent=new i(0,0,0,0)),i.transparent},i.Default=function(){return null===i.default&&(i.default=new i(.8,.8,.8,1)),i.default},i.SelectColor=function(){return null===i.selectColor&&(i.selectColor=new i(1,0,0,1)),n.Parameters.Instance().ModelSelectedColor},i.SelectorShelter=function(){return null===i.selectorShelter&&(i.selectorShelter=new i(1,0,0,.2)),i.selectorShelter},i.FaceDefaultColor=function(){return null===i.faceDefaultColor&&(i.faceDefaultColor=new i(1,0,0,0)),i.faceDefaultColor},i.FaceSelectColor=function(){return null===i.faceSelectColor&&(i.faceSelectColor=new i(1,0,0,0)),i.faceDefaultColor},i.EdgeDefaultColor=function(){return null===i.edgeDefaultColor&&(i.edgeDefaultColor=new i(.25,.25,.25,1)),i.edgeDefaultColor},i.EdgeSelectColor=function(){return null===i.edgeSelectColor&&(i.edgeSelectColor=new i(1,0,0,1)),i.edgeSelectColor},i.white=null,i.gray=null,i.black=null,i.red=null,i.green=null,i.blue=null,i.cyan=null,i.magenta=null,i.yellow=null,i.transparent=null,i.default=null,i.selectColor=null,i.selectorShelter=null,i.faceDefaultColor=null,i.faceSelectColor=null,i.edgeDefaultColor=null,i.edgeSelectColor=null,i}();n.Color=e}(M3D||(M3D={})),function(r){var e=function(){function e(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this.moveVector=new r.Vector3,this.rotation=new r.Quaternion,this.currPos=new r.Vector3,this.scaleVector=new r.Vector3,0===e.length?this.ReSet():(this.rotation=new r.Quaternion(e[0],e[1],e[2],e[3]),this.moveVector.ToZero(),this.scaleVector.ToOne(),this.scaleFactor=1,this.moveVector.ToZero())}return e.prototype.ReSet=function(){this.rotation=new r.Quaternion(0,new r.Vector3(0,0,1)),this.moveVector.ToZero(),this.scaleVector.ToOne(),this.scaleFactor=1,this.fitFactor=1,this.aspective=1},e.prototype.SetScale=function(e){this.scaleFactor=e},e.prototype.GetScale=function(){return this.scaleFactor*this.fitFactor},e.prototype.GetFitFactor=function(){return this.scaleFactor},e.prototype.SetFitFactor=function(e){this.fitFactor=e},e.prototype.SetAspective=function(e){this.aspective=e},e.prototype.GetAspective=function(){return this.aspective},e.prototype.SetMoveVec=function(e){this.moveVector.copyFrom(e)},e.prototype.SetRotate=function(e){this.rotation.copyFrom(e)},e}();r.ControlInfo=e}(M3D||(M3D={})),function(e){var t=function(){function e(){this._count=0,this._data={}}return e.prototype.get=function(e){var t=this._data[e.toString()];if(void 0!==t)return t},e.prototype.getOrAddWithFactory=function(e,t){var r=this.get(e);return void 0!==r||(r=t(e))&&this.add(e,r),r},e.prototype.getOrAdd=function(e,t){var r=this.get(e);return void 0!==r?r:(this.add(e,t),t)},e.prototype.contains=function(e){return void 0!==this._data[e]},e.prototype.add=function(e,t){return void 0===this._data[e.toString()]&&(this._data[e.toString()]=t,++this._count,!0)},e.prototype.set=function(e,t){return void 0!==this._data[e.toString()]&&(this._data[e.toString()]=t,!0)},e.prototype.remove=function(e){return!!this.contains(e)&&(delete this._data[e.toString()],--this._count,!0)},e.prototype.clear=function(){this._data={},this._count=0},Object.defineProperty(e.prototype,"count",{get:function(){return this._count},enumerable:!0,configurable:!0}),e.prototype.forEach=function(e){for(var t in this._data){e(t,this._data[t])}},e.prototype.first=function(e){for(var t in this._data){var r=e(t,this._data[t]);if(r)return r}return null},e}();e.Dictionary=t}(M3D||(M3D={})),function(p){var t,e;p.NUFRUSTUPLANES=6,p.NUFRUSTUVERTICES=8,(e=t||(t={}))[e.PLANE_NEAR=0]="PLANE_NEAR",e[e.PLANE_LEFT=1]="PLANE_LEFT",e[e.PLANE_RIGHT=2]="PLANE_RIGHT",e[e.PLANE_UP=3]="PLANE_UP",e[e.PLANE_DOWN=4]="PLANE_DOWN",e[e.PLANE_FAR=5]="PLANE_FAR";var r=function(){function n(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this.planes=new Array(p.NUFRUSTUPLANES),this.vertices=new Array(p.NUFRUSTUVERTICES),this.Init(),0===e.length?this.UpdatePlanes():1===e.length&&e[0]instanceof n&&this.copyFrom(e[0])}return n.prototype.Init=function(){for(var e=0;e<this.planes.length;e++)this.planes[e]=new p.Plane;for(e=0;e<this.vertices.length;e++)this.vertices[e]=new p.Vector3},n.prototype.Clone=function(){return new n},n.prototype.copyFrom=function(e){for(var t=0;t<p.NUFRUSTUPLANES;++t)this.planes[t].copyFrom(e.planes[t]);for(t=0;t<p.NUFRUSTUVERTICES;++t)this.vertices[t].copyFrom(e.vertices[t])},n.prototype.Define=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(!(e.length<1))if(e[0]instanceof p.BoundingBox){var r=new p.Matrix3x4;e[1]&&e[1]instanceof p.Matrix3x4?r.copyFrom(e[1]):r.copyFrom(p.Matrix3x4.IDENTITY()),this.vertices[0]=r.Multiply(new p.Vector3(e[0].max.x,e[0].max.y,e[0].min.z)),this.vertices[1]=r.Multiply(new p.Vector3(e[0].max.x,e[0].min.y,e[0].min.z)),this.vertices[2]=r.Multiply(new p.Vector3(e[0].min.x,e[0].min.y,e[0].min.z)),this.vertices[3]=r.Multiply(new p.Vector3(e[0].min.x,e[0].max.y,e[0].min.z)),this.vertices[4]=r.Multiply(new p.Vector3(e[0].max.x,e[0].max.y,e[0].max.z)),this.vertices[5]=r.Multiply(new p.Vector3(e[0].max.x,e[0].min.y,e[0].max.z)),this.vertices[6]=r.Multiply(new p.Vector3(e[0].min.x,e[0].min.y,e[0].max.z)),this.vertices[7]=r.Multiply(new p.Vector3(e[0].min.x,e[0].max.y,e[0].max.z)),this.UpdatePlanes()}else if(3===e.length&&e[0]instanceof p.Vector3&&e[1]&&e[1]instanceof p.Vector3){r=new p.Matrix3x4;e[2]&&e[2]instanceof p.Matrix3x4?r.copyFrom(e[2]):r.copyFrom(p.Matrix3x4.IDENTITY());var i=e[0],n=e[1];this.vertices[0]=r.Multiply(i),this.vertices[1]=r.Multiply(new p.Vector3(i.x,-i.y,i.z)),this.vertices[2]=r.Multiply(new p.Vector3(-i.x,-i.y,i.z)),this.vertices[3]=r.Multiply(new p.Vector3(-i.x,i.y,i.z)),this.vertices[4]=r.Multiply(n),this.vertices[5]=r.Multiply(new p.Vector3(n.x,-n.y,n.z)),this.vertices[6]=r.Multiply(new p.Vector3(-n.x,-n.y,n.z)),this.vertices[7]=r.Multiply(new p.Vector3(-n.x,n.y,n.z)),this.UpdatePlanes()}else if(5<=e.length)if("number"==typeof e[0]&&"number"==typeof e[1]&&"number"==typeof e[2]&&"number"==typeof e[3]&&"number"==typeof e[4]){r=new p.Matrix3x4;e[5]&&e[5]instanceof p.Matrix3x4?r.copyFrom(e[5]):r.copyFrom(p.Matrix3x4.IDENTITY());var o=e[0],a=e[1],s=e[2],l=e[3],h=e[4];l=Math.max(l,0),h=Math.max(h,l);var u=Math.tan(o*p.DEGTORAD_2)/s;i=new p.Vector3,n=new p.Vector3;i.z=-l,i.y=i.z*u,i.x=i.y*a,n.z=-h,n.y=n.z*u,n.x=n.y*a,this.Define(i,n,r)}else e[0]instanceof p.Vector3&&(this.vertices[0]=e[4].Clone(),this.vertices[1]=e[5].Clone(),this.vertices[2]=e[6].Clone(),this.vertices[3]=e[7].Clone(),this.vertices[4]=e[0].Clone(),this.vertices[5]=e[1].Clone(),this.vertices[6]=e[2].Clone(),this.vertices[7]=e[3].Clone(),this.UpdatePlanes())},n.prototype.DefineOrtho=function(e,t,r,i,n,o){i=Math.max(i,0),n=Math.max(n,i);var a=.5*e/r,s=new p.Vector3,l=new p.Vector3;s.z=-i,l.z=-n,l.y=s.y=a,l.x=s.x=s.y*t,this.Define(s,l,o)},n.prototype.Transform=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(!(e.length<1))if(e[0]instanceof p.Matrix3){for(var r=0;r<p.NUFRUSTUVERTICES;++r)this.vertices[r]=e[0].Multiply(this.vertices[r]);this.UpdatePlanes()}else if(e[0]instanceof p.Matrix3x4){for(r=0;r<p.NUFRUSTUVERTICES;++r)this.vertices[r]=e[0].Multiply(this.vertices[r]);this.UpdatePlanes()}},n.prototype.IsInside=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(!(e.length<1)){if(e[0]instanceof p.Vector3){for(var r=0;r<p.NUFRUSTUPLANES;++r)if(this.planes[r].Distance(e[0])<0)return p.Intersection.OUTSIDE;return p.Intersection.INSIDE}if(e[0]instanceof p.BoundingBox){var i=e[0],n=i.Center(),o=n.Sub(i.min),a=!0;for(r=0;r<p.NUFRUSTUPLANES;++r){var s=this.planes[r],l=s.normal.DotProduct(n)+s.d,h=s.absNormal.DotProduct(o);if(l<-h)return p.OUTSIDE;l<h&&(a=!1)}return a?p.INSIDE:p.INTERSECTS}}},n.prototype.IsInsideFast=function(e){for(var t=e.Center(),r=t.Sub(e.min),i=0;i<p.NUFRUSTUPLANES;++i){var n=this.planes[i];if(n.normal.DotProduct(t)+n.d<-n.absNormal.DotProduct(r))return p.OUTSIDE}return p.INSIDE},n.prototype.Distance=function(e){for(var t=0,r=0;r<p.NUFRUSTUPLANES;++r)t=p.Max(-this.planes[r].Distance(e),t);return t},n.prototype.Transformed=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(!(e.length<1)){if(e[0]instanceof p.Matrix3){for(var r=new n,i=0;i<p.NUFRUSTUVERTICES;++i)r.vertices[i]=e[0].Multiply(this.vertices[i]);return r.UpdatePlanes(),r}if(e[0]instanceof p.Matrix3x4){for(r=new n,i=0;i<p.NUFRUSTUVERTICES;++i)r.vertices[i]=e[0].Multiply(this.vertices[i]);return r.UpdatePlanes(),r}}},n.prototype.ClipEdgeZ=function(e,t,r){return new p.Vector3(t.x+(e.x-t.x)*((r-t.z)/(e.z-t.z)),t.y+(e.y-t.y)*((r-t.z)/(e.z-t.z)),r)},n.prototype.ProjectAndMergeEdge=function(e,t,r,i){if(!(e.z<p.MIN_NEARCLIP&&t.z<p.MIN_NEARCLIP)){t.z<p.MIN_NEARCLIP?t=this.ClipEdgeZ(t,e,p.MIN_NEARCLIP):e.z<p.MIN_NEARCLIP&&(e=this.ClipEdgeZ(e,t,p.MIN_NEARCLIP));var n=i.Multiply(e),o=i.Multiply(t);r.Merge(new p.Vector2(n.x,n.y)),r.Merge(new p.Vector2(o.x,o.y))}},n.prototype.Projected=function(e){var t=new p.Rect;return this.ProjectAndMergeEdge(this.vertices[0],this.vertices[4],t,e),this.ProjectAndMergeEdge(this.vertices[1],this.vertices[5],t,e),this.ProjectAndMergeEdge(this.vertices[2],this.vertices[6],t,e),this.ProjectAndMergeEdge(this.vertices[3],this.vertices[7],t,e),this.ProjectAndMergeEdge(this.vertices[4],this.vertices[5],t,e),this.ProjectAndMergeEdge(this.vertices[5],this.vertices[6],t,e),this.ProjectAndMergeEdge(this.vertices[6],this.vertices[7],t,e),this.ProjectAndMergeEdge(this.vertices[7],this.vertices[4],t,e),t},n.prototype.UpdatePlanes=function(){if(this.planes[t.PLANE_NEAR].Define(this.vertices[2],this.vertices[1],this.vertices[0]),this.planes[t.PLANE_LEFT].Define(this.vertices[3],this.vertices[7],this.vertices[6]),this.planes[t.PLANE_RIGHT].Define(this.vertices[1],this.vertices[5],this.vertices[4]),this.planes[t.PLANE_UP].Define(this.vertices[0],this.vertices[4],this.vertices[7]),this.planes[t.PLANE_DOWN].Define(this.vertices[6],this.vertices[5],this.vertices[1]),this.planes[t.PLANE_FAR].Define(this.vertices[5],this.vertices[6],this.vertices[7]),this.planes[t.PLANE_NEAR].Distance(this.vertices[5])<0)for(var e=0;e<p.NUFRUSTUPLANES;++e)this.planes[e].normal=this.planes[e].normal.Multiply(-1),this.planes[e].d=-this.planes[e].d},n}();p.Frustum=r}(M3D||(M3D={})),function(r){var e=function(){function e(){}return e.prototype.CreateImage=function(e,t){r.IDCreator.GetUUID(32,16);r.DrawingUtility.createImage(e,t)},e}();r.GlueObj=e}(M3D||(M3D={})),function(r){var e=function(){function p(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this.data=new Float32Array([1,0,0,0,1,0,0,0,1]),1===e.length?e[0]instanceof p?(this.data[0]=e[0].data[0],this.data[1]=e[0].data[1],this.data[2]=e[0].data[2],this.data[3]=e[0].data[3],this.data[4]=e[0].data[4],this.data[5]=e[0].data[5],this.data[6]=e[0].data[6],this.data[7]=e[0].data[7],this.data[8]=e[0].data[8]):e[0]instanceof Float32Array&&9===e[0].length?(this.data[0]=e[0][0],this.data[1]=e[0][1],this.data[2]=e[0][2],this.data[3]=e[0][3],this.data[4]=e[0][4],this.data[5]=e[0][5],this.data[6]=e[0][6],this.data[7]=e[0][7],this.data[8]=e[0][8]):(this.data[0]=1,this.data[1]=0,this.data[2]=0,this.data[3]=0,this.data[4]=1,this.data[5]=0,this.data[6]=0,this.data[7]=0,this.data[8]=1):9===e.length&&(this.data[0]=e[0],this.data[1]=e[1],this.data[2]=e[2],this.data[3]=e[3],this.data[4]=e[4],this.data[5]=e[5],this.data[6]=e[6],this.data[7]=e[7],this.data[8]=e[8])}return p.prototype.Clone=function(){return new p(this)},p.prototype.copyFrom=function(e){this.data[0]=e.data[0],this.data[1]=e.data[1],this.data[2]=e.data[2],this.data[3]=e.data[3],this.data[4]=e.data[4],this.data[5]=e.data[5],this.data[6]=e.data[6],this.data[7]=e.data[7],this.data[8]=e.data[8]},p.prototype.Equals=function(e){return r.Equals(this.data[0],e.data[0])&&r.Equals(this.data[1],e.data[1])&&r.Equals(this.data[2],e.data[2])&&r.Equals(this.data[3],e.data[3])&&r.Equals(this.data[4],e.data[4])&&r.Equals(this.data[5],e.data[5])&&r.Equals(this.data[6],e.data[6])&&r.Equals(this.data[7],e.data[7])&&r.Equals(this.data[8],e.data[8])},p.prototype.Multiply=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return 1!==e.length?null:"number"==typeof e[0]?new p(this.data[0]*e[0],this.data[1]*e[0],this.data[2]*e[0],this.data[3]*e[0],this.data[4]*e[0],this.data[5]*e[0],this.data[6]*e[0],this.data[7]*e[0],this.data[8]*e[0]):e[0]instanceof r.Vector3?new r.Vector3(this.data[0]*e[0].x+this.data[1]*e[0].y+this.data[2]*e[0].z,this.data[3]*e[0].x+this.data[4]*e[0].y+this.data[5]*e[0].z,this.data[6]*e[0].x+this.data[7]*e[0].y+this.data[8]*e[0].z):e[0]instanceof p?new p(this.data[0]*e[0].data[0]+this.data[1]*e[0].data[3]+this.data[2]*e[0].data[6],this.data[0]*e[0].data[1]+this.data[1]*e[0].data[4]+this.data[2]*e[0].data[7],this.data[0]*e[0].data[2]+this.data[1]*e[0].data[5]+this.data[2]*e[0].data[8],this.data[3]*e[0].data[0]+this.data[4]*e[0].data[3]+this.data[5]*e[0].data[6],this.data[3]*e[0].data[1]+this.data[4]*e[0].data[4]+this.data[5]*e[0].data[7],this.data[3]*e[0].data[2]+this.data[4]*e[0].data[5]+this.data[5]*e[0].data[8],this.data[6]*e[0].data[0]+this.data[7]*e[0].data[3]+this.data[8]*e[0].data[6],this.data[6]*e[0].data[1]+this.data[7]*e[0].data[4]+this.data[8]*e[0].data[7],this.data[6]*e[0].data[2]+this.data[7]*e[0].data[5]+this.data[8]*e[0].data[8]):null},p.prototype.Sub=function(e){return new p(this.data[0]-e.data[0],this.data[1]-e.data[1],this.data[2]-e.data[2],this.data[3]-e.data[3],this.data[4]-e.data[4],this.data[5]-e.data[5],this.data[6]-e.data[6],this.data[7]-e.data[7],this.data[8]-e.data[8])},p.prototype.Add=function(e){return new p(this.data[0]+e.data[0],this.data[1]+e.data[1],this.data[2]+e.data[2],this.data[3]+e.data[3],this.data[4]+e.data[4],this.data[5]+e.data[5],this.data[6]+e.data[6],this.data[7]+e.data[7],this.data[8]+e.data[8])},p.prototype.MultiplyED=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(1!==e.length)return this;if("number"==typeof e[0])this.data[0]*=e[0],this.data[1]*=e[0],this.data[2]*=e[0],this.data[3]*=e[0],this.data[4]*=e[0],this.data[5]*=e[0],this.data[6]*=e[0],this.data[7]*=e[0],this.data[8]*=e[0];else if(e[0]instanceof p){var r=this.data[0]*e[0].data[0]+this.data[1]*e[0].data[3]+this.data[2]*e[0].data[6],i=this.data[0]*e[0].data[1]+this.data[1]*e[0].data[4]+this.data[2]*e[0].data[7],n=this.data[0]*e[0].data[2]+this.data[1]*e[0].data[5]+this.data[2]*e[0].data[8],o=this.data[3]*e[0].data[0]+this.data[4]*e[0].data[3]+this.data[5]*e[0].data[6],a=this.data[3]*e[0].data[1]+this.data[4]*e[0].data[4]+this.data[5]*e[0].data[7],s=this.data[3]*e[0].data[2]+this.data[4]*e[0].data[5]+this.data[5]*e[0].data[8],l=this.data[6]*e[0].data[0]+this.data[7]*e[0].data[3]+this.data[8]*e[0].data[6],h=this.data[6]*e[0].data[1]+this.data[7]*e[0].data[4]+this.data[8]*e[0].data[7],u=this.data[6]*e[0].data[2]+this.data[7]*e[0].data[5]+this.data[8]*e[0].data[8];this.data[0]=r,this.data[1]=i,this.data[2]=n,this.data[3]=o,this.data[4]=a,this.data[5]=s,this.data[6]=l,this.data[7]=h,this.data[8]=u}return this},p.prototype.SubED=function(e){return this.data[0]-=e.data[0],this.data[1]-=e.data[1],this.data[2]-=e.data[2],this.data[3]-=e.data[3],this.data[4]-=e.data[4],this.data[5]-=e.data[5],this.data[6]-=e.data[6],this.data[7]-=e.data[7],this.data[8]-=e.data[8],this},p.prototype.AddED=function(e){return this.data[0]+=e.data[0],this.data[1]+=e.data[1],this.data[2]+=e.data[2],this.data[3]+=e.data[3],this.data[4]+=e.data[4],this.data[5]+=e.data[5],this.data[6]+=e.data[6],this.data[7]+=e.data[7],this.data[8]+=e.data[8],this},p.prototype.SetScale=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];1==e.length&&("number"==typeof e[0]?(this.data[0]=e[0],this.data[4]=e[0],this.data[8]=e[0]):e[0]instanceof r.Vector3&&(this.data[0]=e[0].x,this.data[4]=e[0].y,this.data[8]=e[0].z))},p.prototype.Scale=function(){return new r.Vector3(Math.sqrt(this.data[0]*this.data[0]+this.data[3]*this.data[3]+this.data[6]*this.data[6]),Math.sqrt(this.data[1]*this.data[1]+this.data[4]*this.data[4]+this.data[7]*this.data[7]),Math.sqrt(this.data[2]*this.data[2]+this.data[5]*this.data[5]+this.data[8]*this.data[8]))},p.prototype.Transpose=function(){return new p(this.data[0],this.data[3],this.data[6],this.data[1],this.data[4],this.data[7],this.data[2],this.data[5],this.data[8])},p.prototype.Scaled=function(e){return new p(this.data[0]*e.x,this.data[1]*e.y,this.data[2]*e.z,this.data[3]*e.x,this.data[4]*e.y,this.data[5]*e.z,this.data[6]*e.x,this.data[7]*e.y,this.data[8]*e.z)},p.prototype.Inverse=function(){var e=1/(this.data[0]*this.data[4]*this.data[8]+this.data[3]*this.data[7]*this.data[2]+this.data[6]*this.data[1]*this.data[5]-this.data[6]*this.data[4]*this.data[2]-this.data[3]*this.data[1]*this.data[8]-this.data[0]*this.data[7]*this.data[5]);return new p((this.data[4]*this.data[8]-this.data[7]*this.data[5])*e,-(this.data[1]*this.data[8]-this.data[7]*this.data[2])*e,(this.data[1]*this.data[5]-this.data[4]*this.data[2])*e,-(this.data[3]*this.data[8]-this.data[6]*this.data[5])*e,(this.data[0]*this.data[8]-this.data[6]*this.data[2])*e,-(this.data[0]*this.data[5]-this.data[3]*this.data[2])*e,(this.data[3]*this.data[7]-this.data[6]*this.data[4])*e,-(this.data[0]*this.data[7]-this.data[6]*this.data[1])*e,(this.data[0]*this.data[4]-this.data[3]*this.data[1])*e)},p.prototype.InverseED=function(){var e=1/(this.data[0]*this.data[4]*this.data[8]+this.data[3]*this.data[7]*this.data[2]+this.data[6]*this.data[1]*this.data[5]-this.data[6]*this.data[4]*this.data[2]-this.data[3]*this.data[1]*this.data[8]-this.data[0]*this.data[7]*this.data[5]),t=(this.data[4]*this.data[8]-this.data[7]*this.data[5])*e,r=-(this.data[1]*this.data[8]-this.data[7]*this.data[2])*e,i=(this.data[1]*this.data[5]-this.data[4]*this.data[2])*e,n=-(this.data[3]*this.data[8]-this.data[6]*this.data[5])*e,o=(this.data[0]*this.data[8]-this.data[6]*this.data[2])*e,a=-(this.data[0]*this.data[5]-this.data[3]*this.data[2])*e,s=(this.data[3]*this.data[7]-this.data[6]*this.data[4])*e,l=-(this.data[0]*this.data[7]-this.data[6]*this.data[1])*e,h=(this.data[0]*this.data[4]-this.data[3]*this.data[1])*e;return this.data[0]=t,this.data[1]=r,this.data[2]=i,this.data[3]=n,this.data[4]=o,this.data[5]=a,this.data[6]=s,this.data[7]=l,this.data[8]=h,this},p.prototype.Data=function(){return this.data},p.prototype.Value=function(e,t){return this.data[3*e+t]},p.prototype.Tostring=function(){return this.data[0].toString()+" "+this.data[1].toString()+" "+this.data[2].toString()+" "+this.data[3].toString()+" "+this.data[4].toString()+" "+this.data[5].toString()+" "+this.data[6].toString()+" "+this.data[7].toString()+" "+this.data[8].toString()},p.BulkTranspose=function(e,t){for(var r=0;r<e.length&&r<t.length;++r)9==e[r].length&&9==t[r].length&&(e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8])},p.ZERO=function(){return null==p._ZERO&&(p._ZERO=new p(0,0,0,0,0,0,0,0,0)),p._ZERO},p.IDENTITY=function(){return null==p._IDENTITY&&(p._IDENTITY=new p),p._IDENTITY},p}();r.Matrix3=e}(M3D||(M3D={})),function(a){var e=function(){function S(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this.data=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0]),1===e.length?e[0]instanceof S?this.copyFrom(e[0]):e[0]instanceof a.Matrix3?this.copyFrom(e[0]):e[0]instanceof a.Matrix4?this.copyFrom(e[0]):e[0]instanceof Float32Array&&12===e[0].length&&(this.data[0]=e[0][0],this.data[1]=e[0][1],this.data[2]=e[0][2],this.data[3]=e[0][3],this.data[4]=e[0][4],this.data[5]=e[0][5],this.data[6]=e[0][6],this.data[7]=e[0][7],this.data[8]=e[0][8],this.data[9]=e[0][9],this.data[10]=e[0][10],this.data[11]=e[0][11]):3===e.length?e[0]instanceof a.Vector3&&e[1]instanceof a.Quaternion&&"number"==typeof e[2]?(this.SetRotation(e[1].RotationMatrix().MultiplyED(e[2])),this.SetTranslation(e[0])):e[0]instanceof a.Vector3&&e[1]instanceof a.Quaternion&&e[2]instanceof a.Vector3&&(this.SetRotation(e[1].RotationMatrix().Scaled(e[2])),this.SetTranslation(e[0])):12===e.length&&(this.data[0]=e[0],this.data[1]=e[1],this.data[2]=e[2],this.data[3]=e[3],this.data[4]=e[4],this.data[5]=e[5],this.data[6]=e[6],this.data[7]=e[7],this.data[8]=e[8],this.data[9]=e[9],this.data[10]=e[10],this.data[11]=e[11])}return S.prototype.copyFrom=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];1==e.length&&(e[0]instanceof S||e[0]instanceof a.Matrix4?(this.data[0]=e[0].data[0],this.data[1]=e[0].data[1],this.data[2]=e[0].data[2],this.data[3]=e[0].data[3],this.data[4]=e[0].data[4],this.data[5]=e[0].data[5],this.data[6]=e[0].data[6],this.data[7]=e[0].data[7],this.data[8]=e[0].data[8],this.data[9]=e[0].data[9],this.data[10]=e[0].data[10],this.data[11]=e[0].data[11]):e[0]instanceof a.Matrix3&&(this.data[0]=e[0].data[0],this.data[1]=e[0].data[1],this.data[2]=e[0].data[2],this.data[3]=0,this.data[4]=e[0].data[3],this.data[5]=e[0].data[4],this.data[6]=e[0].data[5],this.data[7]=0,this.data[8]=e[0].data[6],this.data[9]=e[0].data[7],this.data[10]=e[0].data[8],this.data[11]=0))},S.prototype.Equals=function(e){return a.Equals(this.data[0],e.data[0])&&a.Equals(this.data[1],e.data[1])&&a.Equals(this.data[2],e.data[2])&&a.Equals(this.data[3],e.data[3])&&a.Equals(this.data[4],e.data[4])&&a.Equals(this.data[5],e.data[5])&&a.Equals(this.data[6],e.data[6])&&a.Equals(this.data[7],e.data[7])&&a.Equals(this.data[8],e.data[8])&&a.Equals(this.data[9],e.data[9])&&a.Equals(this.data[10],e.data[10])&&a.Equals(this.data[11],e.data[11])},S.prototype.Clone=function(){return new S(this)},S.prototype.Multiply=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return 1!==e.length?null:"number"==typeof e[0]?new S(this.data[0]*e[0],this.data[1]*e[0],this.data[2]*e[0],this.data[3]*e[0],this.data[4]*e[0],this.data[5]*e[0],this.data[6]*e[0],this.data[7]*e[0],this.data[8]*e[0],this.data[9]*e[0],this.data[10]*e[0],this.data[11]*e[0]):e[0]instanceof a.Vector3?new a.Vector3(this.data[0]*e[0].x+this.data[1]*e[0].y+this.data[2]*e[0].z+this.data[3],this.data[4]*e[0].x+this.data[5]*e[0].y+this.data[6]*e[0].z+this.data[7],this.data[8]*e[0].x+this.data[9]*e[0].y+this.data[10]*e[0].z+this.data[11]):e[0]instanceof a.Vector4?new a.Vector3(this.data[0]*e[0].x+this.data[1]*e[0].y+this.data[2]*e[0].z+this.data[3]*e[0].w,this.data[4]*e[0].x+this.data[5]*e[0].y+this.data[6]*e[0].z+this.data[7]*e[0].w,this.data[8]*e[0].x+this.data[9]*e[0].y+this.data[10]*e[0].z+this.data[11]*e[0].w):e[0]instanceof a.Matrix4?new a.Matrix4(this.data[0]*e[0].data[0]+this.data[1]*e[0].data[4]+this.data[2]*e[0].data[8]+this.data[3]*e[0].data[12],this.data[0]*e[0].data[1]+this.data[1]*e[0].data[5]+this.data[2]*e[0].data[9]+this.data[3]*e[0].data[13],this.data[0]*e[0].data[2]+this.data[1]*e[0].data[6]+this.data[2]*e[0].data[10]+this.data[3]*e[0].data[14],this.data[0]*e[0].data[3]+this.data[1]*e[0].data[7]+this.data[2]*e[0].data[11]+this.data[3]*e[0].data[15],this.data[4]*e[0].data[0]+this.data[5]*e[0].data[4]+this.data[6]*e[0].data[8]+this.data[7]*e[0].data[12],this.data[4]*e[0].data[1]+this.data[5]*e[0].data[5]+this.data[6]*e[0].data[9]+this.data[7]*e[0].data[13],this.data[4]*e[0].data[2]+this.data[5]*e[0].data[6]+this.data[6]*e[0].data[10]+this.data[7]*e[0].data[14],this.data[4]*e[0].data[3]+this.data[5]*e[0].data[7]+this.data[6]*e[0].data[11]+this.data[7]*e[0].data[15],this.data[8]*e[0].data[0]+this.data[9]*e[0].data[4]+this.data[10]*e[0].data[8]+this.data[11]*e[0].data[12],this.data[8]*e[0].data[1]+this.data[9]*e[0].data[5]+this.data[10]*e[0].data[9]+this.data[11]*e[0].data[13],this.data[8]*e[0].data[2]+this.data[9]*e[0].data[6]+this.data[10]*e[0].data[10]+this.data[11]*e[0].data[14],this.data[8]*e[0].data[3]+this.data[9]*e[0].data[7]+this.data[10]*e[0].data[11]+this.data[11]*e[0].data[15],e[0].data[12],e[0].data[13],e[0].data[14],e[0].data[15]):e[0]instanceof S?new S(this.data[0]*e[0].data[0]+this.data[1]*e[0].data[4]+this.data[2]*e[0].data[8],this.data[0]*e[0].data[1]+this.data[1]*e[0].data[5]+this.data[2]*e[0].data[9],this.data[0]*e[0].data[2]+this.data[1]*e[0].data[6]+this.data[2]*e[0].data[10],this.data[0]*e[0].data[3]+this.data[1]*e[0].data[7]+this.data[2]*e[0].data[11]+this.data[3],this.data[4]*e[0].data[0]+this.data[5]*e[0].data[4]+this.data[6]*e[0].data[8],this.data[4]*e[0].data[1]+this.data[5]*e[0].data[5]+this.data[6]*e[0].data[9],this.data[4]*e[0].data[2]+this.data[5]*e[0].data[6]+this.data[6]*e[0].data[10],this.data[4]*e[0].data[3]+this.data[5]*e[0].data[7]+this.data[6]*e[0].data[11]+this.data[7],this.data[8]*e[0].data[0]+this.data[9]*e[0].data[4]+this.data[10]*e[0].data[8],this.data[8]*e[0].data[1]+this.data[9]*e[0].data[5]+this.data[10]*e[0].data[9],this.data[8]*e[0].data[2]+this.data[9]*e[0].data[6]+this.data[10]*e[0].data[10],this.data[8]*e[0].data[3]+this.data[9]*e[0].data[7]+this.data[10]*e[0].data[11]+this.data[11]):null},S.prototype.Sub=function(e){return new S(this.data[0]-e.data[0],this.data[1]-e.data[1],this.data[2]-e.data[2],this.data[3]-e.data[3],this.data[4]-e.data[4],this.data[5]-e.data[5],this.data[6]-e.data[6],this.data[7]-e.data[7],this.data[8]-e.data[8],this.data[9]-e.data[9],this.data[10]-e.data[10],this.data[11]-e.data[11])},S.prototype.Add=function(e){return new S(this.data[0]+e.data[0],this.data[1]+e.data[1],this.data[2]+e.data[2],this.data[3]+e.data[3],this.data[4]+e.data[4],this.data[5]+e.data[5],this.data[6]+e.data[6],this.data[7]+e.data[7],this.data[8]+e.data[8],this.data[9]+e.data[9],this.data[10]+e.data[10],this.data[11]+e.data[11])},S.prototype.MultiplyED=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(1!==e.length)return this;if("number"==typeof e[0])this.data[0]*=e[0],this.data[1]*=e[0],this.data[2]*=e[0],this.data[3]*=e[0],this.data[4]*=e[0],this.data[5]*=e[0],this.data[6]*=e[0],this.data[7]*=e[0],this.data[8]*=e[0],this.data[9]*=e[0],this.data[10]*=e[0],this.data[11]*=e[0];else if(e[0]instanceof S){var r=this.data[0]*e[0].data[0]+this.data[1]*e[0].data[4]+this.data[2]*e[0].data[8],i=this.data[0]*e[0].data[1]+this.data[1]*e[0].data[5]+this.data[2]*e[0].data[9],n=this.data[0]*e[0].data[2]+this.data[1]*e[0].data[6]+this.data[2]*e[0].data[10],o=this.data[0]*e[0].data[3]+this.data[1]*e[0].data[7]+this.data[2]*e[0].data[11]+this.data[3],a=this.data[4]*e[0].data[0]+this.data[5]*e[0].data[4]+this.data[6]*e[0].data[8],s=this.data[4]*e[0].data[1]+this.data[5]*e[0].data[5]+this.data[6]*e[0].data[9],l=this.data[4]*e[0].data[2]+this.data[5]*e[0].data[6]+this.data[6]*e[0].data[10],h=this.data[4]*e[0].data[3]+this.data[5]*e[0].data[7]+this.data[6]*e[0].data[11]+this.data[7],u=this.data[8]*e[0].data[0]+this.data[9]*e[0].data[4]+this.data[10]*e[0].data[8],p=this.data[8]*e[0].data[1]+this.data[9]*e[0].data[5]+this.data[10]*e[0].data[9],c=this.data[8]*e[0].data[2]+this.data[9]*e[0].data[6]+this.data[10]*e[0].data[10],d=this.data[8]*e[0].data[3]+this.data[9]*e[0].data[7]+this.data[10]*e[0].data[11]+this.data[11];this.data[0]=r,this.data[1]=i,this.data[2]=n,this.data[3]=o,this.data[4]=a,this.data[5]=s,this.data[6]=l,this.data[7]=h,this.data[8]=u,this.data[9]=p,this.data[10]=c,this.data[11]=d}return this},S.prototype.SubED=function(e){return this.data[0]-=e.data[0],this.data[1]-=e.data[1],this.data[2]-=e.data[2],this.data[3]-=e.data[3],this.data[4]-=e.data[4],this.data[5]-=e.data[5],this.data[6]-=e.data[6],this.data[7]-=e.data[7],this.data[8]-=e.data[8],this.data[9]-=e.data[9],this.data[10]-=e.data[10],this.data[11]-=e.data[11],this},S.prototype.AddED=function(e){return this.data[0]+=e.data[0],this.data[1]+=e.data[1],this.data[2]+=e.data[2],this.data[3]+=e.data[3],this.data[4]+=e.data[4],this.data[5]+=e.data[5],this.data[6]+=e.data[6],this.data[7]+=e.data[7],this.data[8]+=e.data[8],this.data[9]+=e.data[9],this.data[10]+=e.data[10],this.data[11]+=e.data[11],this},S.prototype.SetTranslation=function(e){this.data[3]=e.x,this.data[7]=e.y,this.data[11]=e.z},S.prototype.SetRotation=function(e){this.data[0]=e.data[0],this.data[1]=e.data[1],this.data[2]=e.data[2],this.data[4]=e.data[3],this.data[5]=e.data[4],this.data[6]=e.data[5],this.data[8]=e.data[6],this.data[9]=e.data[7],this.data[10]=e.data[8]},S.prototype.SetScale=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];1==e.length&&("number"==typeof e[0]?(this.data[0]=e[0],this.data[5]=e[0],this.data[10]=e[0]):e[0]instanceof a.Vector3&&(this.data[0]=e[0].x,this.data[5]=e[0].y,this.data[10]=e[0].z))},S.prototype.ToMatrix3=function(){return new a.Matrix3(this.data[0],this.data[1],this.data[2],this.data[4],this.data[5],this.data[6],this.data[8],this.data[9],this.data[10])},S.prototype.ToMatrix4=function(){return new a.Matrix4(this.data[0],this.data[1],this.data[2],this.data[3],this.data[4],this.data[5],this.data[6],this.data[7],this.data[8],this.data[9],this.data[10],this.data[11],0,0,0,1)},S.prototype.RotationMatrix=function(){var e=new a.Vector3(1/Math.sqrt(this.data[0]*this.data[0]+this.data[4]*this.data[4]+this.data[8]*this.data[8]),1/Math.sqrt(this.data[1]*this.data[1]+this.data[5]*this.data[5]+this.data[9]*this.data[9]),1/Math.sqrt(this.data[2]*this.data[2]+this.data[6]*this.data[6]+this.data[10]*this.data[10]));return this.ToMatrix3().Scaled(e)},S.prototype.Translation=function(){return new a.Vector3(this.data[3],this.data[7],this.data[11])},S.prototype.Rotation=function(){return new a.Quaternion(this.RotationMatrix())},S.prototype.Scale=function(){return new a.Vector3(Math.sqrt(this.data[0]*this.data[0]+this.data[4]*this.data[4]+this.data[8]*this.data[8]),Math.sqrt(this.data[1]*this.data[1]+this.data[5]*this.data[5]+this.data[9]*this.data[9]),Math.sqrt(this.data[2]*this.data[2]+this.data[6]*this.data[6]+this.data[10]*this.data[10]))},S.prototype.MultiTranslate=function(e){var t=new S;t.SetTranslation(e),this.copyFrom(this.Multiply(t))},S.prototype.LeftMultiTranslate=function(e){var t=new S;t.SetTranslation(e),this.copyFrom(t.Multiply(this))},S.prototype.MultiRotatiton=function(e){var t=new S;t.SetRotation(e.RotationMatrix()),this.copyFrom(this.Multiply(t))},S.prototype.MultiScale=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(1==e.length&&("number"==typeof e[0]||e[0]instanceof a.Vector3)){var r=new S;r.SetScale(e[0]),this.copyFrom(this.Multiply(r))}},S.prototype.GetLookAt=function(e,t,r,i){new S;var n=this.Inverse().Multiply(new a.Vector3(0,0,0));r=this.Multiply(new a.Vector4(0,1,0,0));var o=this.Multiply(new a.Vector4(0,0,-1,0));return o.Normalize(),o=n.Add(o.Multiply(i).Clone()).Clone(),[n,o,r]},S.prototype.Decompose=function(e,t,r){e.x=this.data[3],e.y=this.data[7],e.z=this.data[11],r.x=Math.sqrt(this.data[0]*this.data[0]+this.data[4]*this.data[4]+this.data[8]*this.data[8]),r.y=Math.sqrt(this.data[1]*this.data[1]+this.data[5]*this.data[5]+this.data[9]*this.data[9]),r.z=Math.sqrt(this.data[2]*this.data[2]+this.data[6]*this.data[6]+this.data[10]*this.data[10]);var i=new a.Vector3(1/r.x,1/r.y,1/r.z);new a.Quaternion(this.ToMatrix3().Scaled(i))},S.prototype.Inverse=function(){var e=1/(this.data[0]*this.data[5]*this.data[10]+this.data[4]*this.data[9]*this.data[2]+this.data[8]*this.data[1]*this.data[6]-this.data[8]*this.data[5]*this.data[2]-this.data[4]*this.data[1]*this.data[10]-this.data[0]*this.data[9]*this.data[6]),t=new S;return t.data[0]=(this.data[5]*this.data[10]-this.data[9]*this.data[6])*e,t.data[1]=-(this.data[1]*this.data[10]-this.data[9]*this.data[2])*e,t.data[2]=(this.data[1]*this.data[6]-this.data[5]*this.data[2])*e,t.data[3]=-(this.data[3]*t.data[0]+this.data[7]*t.data[1]+this.data[11]*t.data[2]),t.data[4]=-(this.data[4]*this.data[10]-this.data[8]*this.data[6])*e,t.data[5]=(this.data[0]*this.data[10]-this.data[8]*this.data[2])*e,t.data[6]=-(this.data[0]*this.data[6]-this.data[4]*this.data[2])*e,t.data[7]=-(this.data[3]*t.data[4]+this.data[7]*t.data[5]+this.data[11]*t.data[6]),t.data[8]=(this.data[4]*this.data[9]-this.data[8]*this.data[5])*e,t.data[9]=-(this.data[0]*this.data[9]-this.data[8]*this.data[1])*e,t.data[10]=(this.data[0]*this.data[5]-this.data[4]*this.data[1])*e,t.data[11]=-(this.data[3]*t.data[8]+this.data[7]*t.data[9]+this.data[11]*t.data[10]),t},S.prototype.InverseED=function(){var e=1/(this.data[0]*this.data[5]*this.data[10]+this.data[4]*this.data[9]*this.data[2]+this.data[8]*this.data[1]*this.data[6]-this.data[8]*this.data[5]*this.data[2]-this.data[4]*this.data[1]*this.data[10]-this.data[0]*this.data[9]*this.data[6]),t=(this.data[5]*this.data[10]-this.data[9]*this.data[6])*e,r=-(this.data[1]*this.data[10]-this.data[9]*this.data[2])*e,i=(this.data[1]*this.data[6]-this.data[5]*this.data[2])*e,n=-(this.data[3]*t+this.data[7]*r+this.data[11]*i),o=-(this.data[4]*this.data[10]-this.data[8]*this.data[6])*e,a=(this.data[0]*this.data[10]-this.data[8]*this.data[2])*e,s=-(this.data[0]*this.data[6]-this.data[4]*this.data[2])*e,l=-(this.data[3]*o+this.data[7]*a+this.data[11]*s),h=(this.data[4]*this.data[9]-this.data[8]*this.data[5])*e,u=-(this.data[0]*this.data[9]-this.data[8]*this.data[1])*e,p=(this.data[0]*this.data[5]-this.data[4]*this.data[1])*e,c=-(this.data[3]*h+this.data[7]*u+this.data[11]*p);return this.data[0]=t,this.data[1]=r,this.data[2]=i,this.data[3]=n,this.data[4]=o,this.data[5]=a,this.data[6]=s,this.data[7]=l,this.data[8]=h,this.data[9]=u,this.data[10]=p,this.data[11]=c,this},S.prototype.Data=function(){return this.data},S.prototype.Value=function(e,t){return this.data[4*e+t]},S.prototype.Tostring=function(){return this.data[0].toString()+" "+this.data[1].toString()+" "+this.data[2].toString()+" "+this.data[3].toString()+" "+this.data[4].toString()+" "+this.data[5].toString()+" "+this.data[6].toString()+" "+this.data[7].toString()+" "+this.data[8].toString()+" "+this.data[9].toString()+" "+this.data[10].toString()+this.data[11].toString()},S.prototype.fromString=function(e){var t=!1,r=e.split(" ");if(16==r.length){var i=new a.Matrix4;i.fromString(e)&&(this.copyFrom(i),t=!0)}else if(12==r.length){for(var n=0;n<12;n++)this.data[n]=parseFloat(r[n]);t=!0}return t},S.ZERO=function(){return null==S._ZERO&&(S._ZERO=new S(0,0,0,0,0,0,0,0,0,0,0,0)),S._ZERO},S.IDENTITY=function(){return null==S._IDENTITY&&(S._IDENTITY=new S),S._IDENTITY.Clone()},S._ZERO=null,S._IDENTITY=null,S}();a.Matrix3x4=e}(M3D||(M3D={})),function(g){var e=function(){function M(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this.data=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),1===e.length?e[0]instanceof M?this.copyFrom(e[0]):e[0]instanceof g.Matrix3?this.copyFrom(e[0]):e[0]instanceof Float32Array&&16===e[0].length&&(this.data[0]=e[0][0],this.data[1]=e[0][1],this.data[2]=e[0][2],this.data[3]=e[0][3],this.data[4]=e[0][4],this.data[5]=e[0][5],this.data[6]=e[0][6],this.data[7]=e[0][7],this.data[8]=e[0][8],this.data[9]=e[0][9],this.data[10]=e[0][10],this.data[11]=e[0][11],this.data[12]=e[0][12],this.data[13]=e[0][13],this.data[14]=e[0][14],this.data[15]=e[0][15]):3===e.length?e[0]instanceof g.Vector3&&e[1]instanceof g.Quaternion&&"number"==typeof e[2]?(this.ToIdentity(),this.SetRotation(e[1].RotationMatrix().MultiplyED(e[2])),this.SetTranslation(e[0])):e[0]instanceof g.Vector3&&e[1]instanceof g.Quaternion&&e[2]instanceof g.Vector3&&(this.ToIdentity(),this.SetRotation(e[1].RotationMatrix().Scaled(e[2])),this.SetTranslation(e[0])):16===e.length&&(this.data[0]=e[0],this.data[1]=e[1],this.data[2]=e[2],this.data[3]=e[3],this.data[4]=e[4],this.data[5]=e[5],this.data[6]=e[6],this.data[7]=e[7],this.data[8]=e[8],this.data[9]=e[9],this.data[10]=e[10],this.data[11]=e[11],this.data[12]=e[12],this.data[13]=e[13],this.data[14]=e[14],this.data[15]=e[15])}return M.prototype.Clone=function(){return new M(this)},M.prototype.Set=function(e){this.data[0]=e[0],this.data[1]=e[1],this.data[2]=e[2],this.data[3]=e[3],this.data[4]=e[4],this.data[5]=e[5],this.data[6]=e[6],this.data[7]=e[7],this.data[8]=e[8],this.data[9]=e[9],this.data[10]=e[10],this.data[11]=e[11],this.data[12]=e[12],this.data[13]=e[13],this.data[14]=e[14],this.data[15]=e[15]},M.prototype.copyFrom=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];1==e.length&&(e[0]instanceof M?(this.data[0]=e[0].data[0],this.data[1]=e[0].data[1],this.data[2]=e[0].data[2],this.data[3]=e[0].data[3],this.data[4]=e[0].data[4],this.data[5]=e[0].data[5],this.data[6]=e[0].data[6],this.data[7]=e[0].data[7],this.data[8]=e[0].data[8],this.data[9]=e[0].data[9],this.data[10]=e[0].data[10],this.data[11]=e[0].data[11],this.data[12]=e[0].data[12],this.data[13]=e[0].data[13],this.data[14]=e[0].data[14],this.data[15]=e[0].data[15]):e[0]instanceof g.Matrix3&&(this.data[0]=e[0].data[0],this.data[1]=e[0].data[1],this.data[2]=e[0].data[2],this.data[3]=0,this.data[4]=e[0].data[3],this.data[5]=e[0].data[4],this.data[6]=e[0].data[5],this.data[7]=0,this.data[8]=e[0].data[6],this.data[9]=e[0].data[7],this.data[10]=e[0].data[8],this.data[11]=0,this.data[12]=0,this.data[13]=0,this.data[14]=0,this.data[15]=1))},M.prototype.ToIdentity=function(){this.copyFrom(M.IDENTITY())},M.prototype.SetRotation=function(e){this.data[0]=e.data[0],this.data[1]=e.data[1],this.data[2]=e.data[2],this.data[4]=e.data[3],this.data[5]=e.data[4],this.data[6]=e.data[5],this.data[8]=e.data[6],this.data[9]=e.data[7],this.data[10]=e.data[8]},M.prototype.SetTranslation=function(e){this.data[3]=e.x,this.data[7]=e.y,this.data[11]=e.z},M.prototype.Equals=function(e){return g.Equals(this.data[0],e.data[0])&&g.Equals(this.data[1],e.data[1])&&g.Equals(this.data[2],e.data[2])&&g.Equals(this.data[3],e.data[3])&&g.Equals(this.data[4],e.data[4])&&g.Equals(this.data[5],e.data[5])&&g.Equals(this.data[6],e.data[6])&&g.Equals(this.data[7],e.data[7])&&g.Equals(this.data[8],e.data[8])&&g.Equals(this.data[9],e.data[9])&&g.Equals(this.data[10],e.data[10])&&g.Equals(this.data[11],e.data[11])&&g.Equals(this.data[12],e.data[12])&&g.Equals(this.data[13],e.data[13])&&g.Equals(this.data[14],e.data[14])&&g.Equals(this.data[15],e.data[15])},M.prototype.MultiplyMat4=function(e,t){t.data[0]=this.data[0]*e.data[0]+this.data[1]*e.data[4]+this.data[2]*e.data[8]+this.data[3]*e.data[12],t.data[1]=this.data[0]*e.data[1]+this.data[1]*e.data[5]+this.data[2]*e.data[9]+this.data[3]*e.data[13],t.data[2]=this.data[0]*e.data[2]+this.data[1]*e.data[6]+this.data[2]*e.data[10]+this.data[3]*e.data[14],t.data[3]=this.data[0]*e.data[3]+this.data[1]*e.data[7]+this.data[2]*e.data[11]+this.data[3]*e.data[15],t.data[4]=this.data[4]*e.data[0]+this.data[5]*e.data[4]+this.data[6]*e.data[8]+this.data[7]*e.data[12],t.data[5]=this.data[4]*e.data[1]+this.data[5]*e.data[5]+this.data[6]*e.data[9]+this.data[7]*e.data[13],t.data[6]=this.data[4]*e.data[2]+this.data[5]*e.data[6]+this.data[6]*e.data[10]+this.data[7]*e.data[14],t.data[7]=this.data[4]*e.data[3]+this.data[5]*e.data[7]+this.data[6]*e.data[11]+this.data[7]*e.data[15],t.data[8]=this.data[8]*e.data[0]+this.data[9]*e.data[4]+this.data[10]*e.data[8]+this.data[11]*e.data[12],t.data[9]=this.data[8]*e.data[1]+this.data[9]*e.data[5]+this.data[10]*e.data[9]+this.data[11]*e.data[13],t.data[10]=this.data[8]*e.data[2]+this.data[9]*e.data[6]+this.data[10]*e.data[10]+this.data[11]*e.data[14],t.data[11]=this.data[8]*e.data[3]+this.data[9]*e.data[7]+this.data[10]*e.data[11]+this.data[11]*e.data[15],t.data[12]=this.data[12]*e.data[0]+this.data[13]*e.data[4]+this.data[14]*e.data[8]+this.data[15]*e.data[12],t.data[13]=this.data[12]*e.data[1]+this.data[13]*e.data[5]+this.data[14]*e.data[9]+this.data[15]*e.data[13],t.data[14]=this.data[12]*e.data[2]+this.data[13]*e.data[6]+this.data[14]*e.data[10]+this.data[15]*e.data[14],t.data[15]=this.data[12]*e.data[3]+this.data[13]*e.data[7]+this.data[14]*e.data[11]+this.data[15]*e.data[15]},M.prototype.Multiply=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(1!==e.length)return null;if("number"==typeof e[0])return new M(this.data[0]*e[0],this.data[1]*e[0],this.data[2]*e[0],this.data[3]*e[0],this.data[4]*e[0],this.data[5]*e[0],this.data[6]*e[0],this.data[7]*e[0],this.data[8]*e[0],this.data[9]*e[0],this.data[10]*e[0],this.data[11]*e[0],this.data[12]*e[0],this.data[13]*e[0],this.data[14]*e[0],this.data[15]*e[0]);if(e[0]instanceof g.Vector3){var r=1/(this.data[12]*e[0].x+this.data[13]*e[0].y+this.data[14]*e[0].z+this.data[15]);return new g.Vector3((this.data[0]*e[0].x+this.data[1]*e[0].y+this.data[2]*e[0].z+this.data[3])*r,(this.data[4]*e[0].x+this.data[5]*e[0].y+this.data[6]*e[0].z+this.data[7])*r,(this.data[8]*e[0].x+this.data[9]*e[0].y+this.data[10]*e[0].z+this.data[11])*r)}if(e[0]instanceof g.Vector4)return new g.Vector4(this.data[0]*e[0].x+this.data[1]*e[0].y+this.data[2]*e[0].z+this.data[3]*e[0].w,this.data[4]*e[0].x+this.data[5]*e[0].y+this.data[6]*e[0].z+this.data[7]*e[0].w,this.data[8]*e[0].x+this.data[9]*e[0].y+this.data[10]*e[0].z+this.data[11]*e[0].w,this.data[12]*e[0].x+this.data[13]*e[0].y+this.data[14]*e[0].z+this.data[15]*e[0].w);if(e[0]instanceof g.Quaternion){var i=new M(e[0].RotationMatrix());return this.Multiply(i)}return e[0]instanceof M?new M(this.data[0]*e[0].data[0]+this.data[1]*e[0].data[4]+this.data[2]*e[0].data[8]+this.data[3]*e[0].data[12],this.data[0]*e[0].data[1]+this.data[1]*e[0].data[5]+this.data[2]*e[0].data[9]+this.data[3]*e[0].data[13],this.data[0]*e[0].data[2]+this.data[1]*e[0].data[6]+this.data[2]*e[0].data[10]+this.data[3]*e[0].data[14],this.data[0]*e[0].data[3]+this.data[1]*e[0].data[7]+this.data[2]*e[0].data[11]+this.data[3]*e[0].data[15],this.data[4]*e[0].data[0]+this.data[5]*e[0].data[4]+this.data[6]*e[0].data[8]+this.data[7]*e[0].data[12],this.data[4]*e[0].data[1]+this.data[5]*e[0].data[5]+this.data[6]*e[0].data[9]+this.data[7]*e[0].data[13],this.data[4]*e[0].data[2]+this.data[5]*e[0].data[6]+this.data[6]*e[0].data[10]+this.data[7]*e[0].data[14],this.data[4]*e[0].data[3]+this.data[5]*e[0].data[7]+this.data[6]*e[0].data[11]+this.data[7]*e[0].data[15],this.data[8]*e[0].data[0]+this.data[9]*e[0].data[4]+this.data[10]*e[0].data[8]+this.data[11]*e[0].data[12],this.data[8]*e[0].data[1]+this.data[9]*e[0].data[5]+this.data[10]*e[0].data[9]+this.data[11]*e[0].data[13],this.data[8]*e[0].data[2]+this.data[9]*e[0].data[6]+this.data[10]*e[0].data[10]+this.data[11]*e[0].data[14],this.data[8]*e[0].data[3]+this.data[9]*e[0].data[7]+this.data[10]*e[0].data[11]+this.data[11]*e[0].data[15],this.data[12]*e[0].data[0]+this.data[13]*e[0].data[4]+this.data[14]*e[0].data[8]+this.data[15]*e[0].data[12],this.data[12]*e[0].data[1]+this.data[13]*e[0].data[5]+this.data[14]*e[0].data[9]+this.data[15]*e[0].data[13],this.data[12]*e[0].data[2]+this.data[13]*e[0].data[6]+this.data[14]*e[0].data[10]+this.data[15]*e[0].data[14],this.data[12]*e[0].data[3]+this.data[13]*e[0].data[7]+this.data[14]*e[0].data[11]+this.data[15]*e[0].data[15]):e[0]instanceof g.Matrix3x4?new M(this.data[0]*e[0].data[0]+this.data[1]*e[0].data[4]+this.data[2]*e[0].data[8],this.data[0]*e[0].data[1]+this.data[1]*e[0].data[5]+this.data[2]*e[0].data[9],this.data[0]*e[0].data[2]+this.data[1]*e[0].data[6]+this.data[2]*e[0].data[10],this.data[0]*e[0].data[3]+this.data[1]*e[0].data[7]+this.data[2]*e[0].data[11]+this.data[3],this.data[4]*e[0].data[0]+this.data[5]*e[0].data[4]+this.data[6]*e[0].data[8],this.data[4]*e[0].data[1]+this.data[5]*e[0].data[5]+this.data[6]*e[0].data[9],this.data[4]*e[0].data[2]+this.data[5]*e[0].data[6]+this.data[6]*e[0].data[10],this.data[4]*e[0].data[3]+this.data[5]*e[0].data[7]+this.data[6]*e[0].data[11]+this.data[7],this.data[8]*e[0].data[0]+this.data[9]*e[0].data[4]+this.data[10]*e[0].data[8],this.data[8]*e[0].data[1]+this.data[9]*e[0].data[5]+this.data[10]*e[0].data[9],this.data[8]*e[0].data[2]+this.data[9]*e[0].data[6]+this.data[10]*e[0].data[10],this.data[8]*e[0].data[3]+this.data[9]*e[0].data[7]+this.data[10]*e[0].data[11]+this.data[11],this.data[12]*e[0].data[0]+this.data[13]*e[0].data[4]+this.data[14]*e[0].data[8],this.data[12]*e[0].data[1]+this.data[13]*e[0].data[5]+this.data[14]*e[0].data[9],this.data[12]*e[0].data[2]+this.data[13]*e[0].data[6]+this.data[14]*e[0].data[10],this.data[12]*e[0].data[3]+this.data[13]*e[0].data[7]+this.data[14]*e[0].data[11]+this.data[15]):null},M.prototype.Sub=function(e){return new M(this.data[0]-e.data[0],this.data[1]-e.data[1],this.data[2]-e.data[2],this.data[3]-e.data[3],this.data[4]-e.data[4],this.data[5]-e.data[5],this.data[6]-e.data[6],this.data[7]-e.data[7],this.data[8]-e.data[8],this.data[9]-e.data[9],this.data[10]-e.data[10],this.data[11]-e.data[11],this.data[12]-e.data[12],this.data[13]-e.data[13],this.data[14]-e.data[14],this.data[15]-e.data[15])},M.prototype.Add=function(e){return new M(this.data[0]+e.data[0],this.data[1]+e.data[1],this.data[2]+e.data[2],this.data[3]+e.data[3],this.data[4]+e.data[4],this.data[5]+e.data[5],this.data[6]+e.data[6],this.data[7]+e.data[7],this.data[8]+e.data[8],this.data[9]+e.data[9],this.data[10]+e.data[10],this.data[11]+e.data[11],this.data[12]+e.data[12],this.data[13]+e.data[13],this.data[14]+e.data[14],this.data[15]+e.data[15])},M.prototype.MultiplyED=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if("number"==typeof e[0])this.data[0]*=e[0],this.data[1]*=e[0],this.data[2]*=e[0],this.data[3]*=e[0],this.data[4]*=e[0],this.data[5]*=e[0],this.data[6]*=e[0],this.data[7]*=e[0],this.data[8]*=e[0],this.data[9]*=e[0],this.data[10]*=e[0],this.data[11]*=e[0],this.data[12]*=e[0],this.data[13]*=e[0],this.data[14]*=e[0],this.data[15]*=e[0];else{if(e[0]instanceof g.Quaternion){var r=new M(e[0].RotationMatrix());return this.MultiplyED(r)}if(e[0]instanceof M){var i=this.data[0]*e[0].data[0]+this.data[1]*e[0].data[4]+this.data[2]*e[0].data[8]+this.data[3]*e[0].data[12],n=this.data[0]*e[0].data[1]+this.data[1]*e[0].data[5]+this.data[2]*e[0].data[9]+this.data[3]*e[0].data[13],o=this.data[0]*e[0].data[2]+this.data[1]*e[0].data[6]+this.data[2]*e[0].data[10]+this.data[3]*e[0].data[14],a=this.data[0]*e[0].data[3]+this.data[1]*e[0].data[7]+this.data[2]*e[0].data[11]+this.data[3]*e[0].data[15],s=this.data[4]*e[0].data[0]+this.data[5]*e[0].data[4]+this.data[6]*e[0].data[8]+this.data[7]*e[0].data[12],l=this.data[4]*e[0].data[1]+this.data[5]*e[0].data[5]+this.data[6]*e[0].data[9]+this.data[7]*e[0].data[13],h=this.data[4]*e[0].data[2]+this.data[5]*e[0].data[6]+this.data[6]*e[0].data[10]+this.data[7]*e[0].data[14],u=this.data[4]*e[0].data[3]+this.data[5]*e[0].data[7]+this.data[6]*e[0].data[11]+this.data[7]*e[0].data[15],p=this.data[8]*e[0].data[0]+this.data[9]*e[0].data[4]+this.data[10]*e[0].data[8]+this.data[11]*e[0].data[12],c=this.data[8]*e[0].data[1]+this.data[9]*e[0].data[5]+this.data[10]*e[0].data[9]+this.data[11]*e[0].data[13],d=this.data[8]*e[0].data[2]+this.data[9]*e[0].data[6]+this.data[10]*e[0].data[10]+this.data[11]*e[0].data[14],S=this.data[8]*e[0].data[3]+this.data[9]*e[0].data[7]+this.data[10]*e[0].data[11]+this.data[11]*e[0].data[15],f=this.data[12]*e[0].data[0]+this.data[13]*e[0].data[4]+this.data[14]*e[0].data[8]+this.data[15]*e[0].data[12],m=this.data[12]*e[0].data[1]+this.data[13]*e[0].data[5]+this.data[14]*e[0].data[9]+this.data[15]*e[0].data[13],y=this.data[12]*e[0].data[2]+this.data[13]*e[0].data[6]+this.data[14]*e[0].data[10]+this.data[15]*e[0].data[14],T=this.data[12]*e[0].data[3]+this.data[13]*e[0].data[7]+this.data[14]*e[0].data[11]+this.data[15]*e[0].data[15];this.data[0]=i,this.data[1]=n,this.data[2]=o,this.data[3]=a,this.data[4]=s,this.data[5]=l,this.data[6]=h,this.data[7]=u,this.data[8]=p,this.data[9]=c,this.data[10]=d,this.data[11]=S,this.data[12]=f,this.data[13]=m,this.data[14]=y,this.data[15]=T}else if(e[0]instanceof g.Matrix3x4){i=this.data[0]*e[0].data[0]+this.data[1]*e[0].data[4]+this.data[2]*e[0].data[8],n=this.data[0]*e[0].data[1]+this.data[1]*e[0].data[5]+this.data[2]*e[0].data[9],o=this.data[0]*e[0].data[2]+this.data[1]*e[0].data[6]+this.data[2]*e[0].data[10],a=this.data[0]*e[0].data[3]+this.data[1]*e[0].data[7]+this.data[2]*e[0].data[11]+this.data[3],s=this.data[4]*e[0].data[0]+this.data[5]*e[0].data[4]+this.data[6]*e[0].data[8],l=this.data[4]*e[0].data[1]+this.data[5]*e[0].data[5]+this.data[6]*e[0].data[9],h=this.data[4]*e[0].data[2]+this.data[5]*e[0].data[6]+this.data[6]*e[0].data[10],u=this.data[4]*e[0].data[3]+this.data[5]*e[0].data[7]+this.data[6]*e[0].data[11]+this.data[7],p=this.data[8]*e[0].data[0]+this.data[9]*e[0].data[4]+this.data[10]*e[0].data[8],c=this.data[8]*e[0].data[1]+this.data[9]*e[0].data[5]+this.data[10]*e[0].data[9],d=this.data[8]*e[0].data[2]+this.data[9]*e[0].data[6]+this.data[10]*e[0].data[10],S=this.data[8]*e[0].data[3]+this.data[9]*e[0].data[7]+this.data[10]*e[0].data[11]+this.data[11],f=this.data[12]*e[0].data[0]+this.data[13]*e[0].data[4]+this.data[14]*e[0].data[8],m=this.data[12]*e[0].data[1]+this.data[13]*e[0].data[5]+this.data[14]*e[0].data[9],y=this.data[12]*e[0].data[2]+this.data[13]*e[0].data[6]+this.data[14]*e[0].data[10],T=this.data[12]*e[0].data[3]+this.data[13]*e[0].data[7]+this.data[14]*e[0].data[11]+this.data[15];this.data[0]=i,this.data[1]=n,this.data[2]=o,this.data[3]=a,this.data[4]=s,this.data[5]=l,this.data[6]=h,this.data[7]=u,this.data[8]=p,this.data[9]=c,this.data[10]=d,this.data[11]=S,this.data[12]=f,this.data[13]=m,this.data[14]=y,this.data[15]=T}}return this},M.prototype.SubED=function(e){return this.data[0]-=e.data[0],this.data[1]-=e.data[1],this.data[2]-=e.data[2],this.data[3]-=e.data[3],this.data[4]-=e.data[4],this.data[5]-=e.data[5],this.data[6]-=e.data[6],this.data[7]-=e.data[7],this.data[8]-=e.data[8],this.data[9]-=e.data[9],this.data[10]-=e.data[10],this.data[11]-=e.data[11],this.data[12]-=e.data[12],this.data[13]-=e.data[13],this.data[14]-=e.data[14],this.data[15]-=e.data[15],this},M.prototype.AddED=function(e){return this.data[0]+=e.data[0],this.data[1]+=e.data[1],this.data[2]+=e.data[2],this.data[3]+=e.data[3],this.data[4]+=e.data[4],this.data[5]+=e.data[5],this.data[6]+=e.data[6],this.data[7]+=e.data[7],this.data[8]+=e.data[8],this.data[9]+=e.data[9],this.data[10]+=e.data[10],this.data[11]+=e.data[11],this.data[12]+=e.data[12],this.data[13]+=e.data[13],this.data[14]+=e.data[14],this.data[15]+=e.data[15],this},M.prototype.SetScale=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];1==e.length&&("number"==typeof e[0]?(this.data[0]=e[0],this.data[5]=e[0],this.data[10]=e[0]):e[0]instanceof g.Vector3&&(this.data[0]=e[0].x,this.data[5]=e[0].y,this.data[10]=e[0].z))},M.prototype.ToMatrix3=function(){return new g.Matrix3(this.data[0],this.data[1],this.data[2],this.data[4],this.data[5],this.data[6],this.data[8],this.data[9],this.data[10])},M.prototype.RotationMatrix=function(){var e=new g.Vector3(1/Math.sqrt(this.data[0]*this.data[0]+this.data[4]*this.data[4]+this.data[8]*this.data[8]),1/Math.sqrt(this.data[1]*this.data[1]+this.data[5]*this.data[5]+this.data[9]*this.data[9]),1/Math.sqrt(this.data[2]*this.data[2]+this.data[6]*this.data[6]+this.data[10]*this.data[10]));return this.ToMatrix3().Scaled(e)},M.prototype.Translation=function(){return new g.Vector3(this.data[3],this.data[7],this.data[11])},M.prototype.MultiTranslate=function(e){var t=new M;t.SetTranslation(e),this.MultiplyED(t)},M.prototype.MultiRotatiton=function(e){var t=new M;t.SetRotation(e.RotationMatrix()),this.copyFrom(t.MultiplyED(this))},M.prototype.MultiScale=function(e){var t=new M;t.SetScale(e),this.copyFrom(t.MultiplyED(this))},M.prototype.Rotation=function(){return new g.Quaternion(this.RotationMatrix())},M.prototype.Scale=function(){return new g.Vector3(Math.sqrt(this.data[0]*this.data[0]+this.data[4]*this.data[4]+this.data[8]*this.data[8]),Math.sqrt(this.data[1]*this.data[1]+this.data[5]*this.data[5]+this.data[9]*this.data[9]),Math.sqrt(this.data[2]*this.data[2]+this.data[6]*this.data[6]+this.data[10]*this.data[10]))},M.prototype.Transpose=function(){return new M(this.data[0],this.data[4],this.data[8],this.data[12],this.data[1],this.data[5],this.data[9],this.data[13],this.data[2],this.data[6],this.data[10],this.data[14],this.data[3],this.data[7],this.data[11],this.data[15])},M.prototype.TransposeED=function(){var e=this.data[0],t=this.data[4],r=this.data[8],i=this.data[12],n=this.data[1],o=this.data[5],a=this.data[9],s=this.data[13],l=this.data[2],h=this.data[6],u=this.data[10],p=this.data[14],c=this.data[3],d=this.data[7],S=this.data[11],f=this.data[15];return this.data[0]=e,this.data[1]=t,this.data[2]=r,this.data[3]=i,this.data[4]=n,this.data[5]=o,this.data[6]=a,this.data[7]=s,this.data[8]=l,this.data[9]=h,this.data[10]=u,this.data[11]=p,this.data[12]=c,this.data[13]=d,this.data[14]=S,this.data[15]=f,this},M.prototype.Ortho=function(e,t,r,i,n,o){if(!(g.Equals(e,t)||g.Equals(r,i)||g.Equals(n,o))){var a=t-e,s=i-r,l=o-n,h=new M;h.data[0]=2/a,h.data[4]=0,h.data[8]=0,h.data[12]=-(e+t)/a,h.data[1]=0,h.data[5]=2/s,h.data[9]=0,h.data[13]=-(i+r)/s,h.data[2]=0,h.data[6]=0,h.data[10]=-2/l,h.data[14]=-(n+o)/l,h.data[3]=0,h.data[7]=0,h.data[11]=0,h.data[15]=1,this.copyFrom(this.Multiply(h))}},M.prototype.LookAt=function(e,t,r,i,n,o,a,s,l){var h,u,p,c=new M;h=new g.Vector3(i-e,n-t,o-r),p=new g.Vector3(a,s,l),h.Normalize(),(u=h.CrossProduct(p)).Normalize(),(p=u.CrossProduct(h)).Normalize(),c.data[0]=u.x,c.data[4]=u.y,c.data[8]=u.z,c.data[1]=p.x,c.data[5]=p.y,c.data[9]=p.z,c.data[2]=-h.x,c.data[6]=-h.y,c.data[10]=-h.z,c.data[3]=e,c.data[7]=t,c.data[11]=r,this.copyFrom(c)},M.prototype.Decompose=function(e,t,r){e.x=this.data[3],e.y=this.data[7],e.z=this.data[11],r.x=Math.sqrt(this.data[0]*this.data[0]+this.data[4]*this.data[4]+this.data[8]*this.data[8]),r.y=Math.sqrt(this.data[1]*this.data[1]+this.data[5]*this.data[5]+this.data[9]*this.data[9]),r.z=Math.sqrt(this.data[2]*this.data[2]+this.data[6]*this.data[6]+this.data[10]*this.data[10]);var i=new g.Vector3(1/r.x,1/r.y,1/r.z),n=new g.Quaternion(this.ToMatrix3().Scaled(i));t.copyFrom(n)},M.prototype.Inverse=function(){var e=this.data[8]*this.data[13]-this.data[9]*this.data[12],t=this.data[8]*this.data[14]-this.data[10]*this.data[12],r=this.data[8]*this.data[15]-this.data[11]*this.data[12],i=this.data[9]*this.data[14]-this.data[10]*this.data[13],n=this.data[9]*this.data[15]-this.data[11]*this.data[13],o=this.data[10]*this.data[15]-this.data[11]*this.data[14],a=o*this.data[5]-n*this.data[6]+i*this.data[7],s=-(o*this.data[4]-r*this.data[6]+t*this.data[7]),l=n*this.data[4]-r*this.data[5]+e*this.data[7],h=-(i*this.data[4]-t*this.data[5]+e*this.data[6]),u=1/(a*this.data[0]+s*this.data[1]+l*this.data[2]+h*this.data[3]);a*=u,s*=u,l*=u,h*=u;var p=-(o*this.data[1]-n*this.data[2]+i*this.data[3])*u,c=(o*this.data[0]-r*this.data[2]+t*this.data[3])*u,d=-(n*this.data[0]-r*this.data[1]+e*this.data[3])*u,S=(i*this.data[0]-t*this.data[1]+e*this.data[2])*u;e=this.data[4]*this.data[13]-this.data[5]*this.data[12],t=this.data[4]*this.data[14]-this.data[6]*this.data[12],r=this.data[4]*this.data[15]-this.data[7]*this.data[12],i=this.data[5]*this.data[14]-this.data[6]*this.data[13],n=this.data[5]*this.data[15]-this.data[7]*this.data[13];var f=((o=this.data[6]*this.data[15]-this.data[7]*this.data[14])*this.data[1]-n*this.data[2]+i*this.data[3])*u,m=-(o*this.data[0]-r*this.data[2]+t*this.data[3])*u,y=(n*this.data[0]-r*this.data[1]+e*this.data[3])*u,T=-(i*this.data[0]-t*this.data[1]+e*this.data[2])*u;return e=this.data[9]*this.data[4]-this.data[8]*this.data[5],t=this.data[10]*this.data[4]-this.data[8]*this.data[6],r=this.data[11]*this.data[4]-this.data[8]*this.data[7],i=this.data[10]*this.data[5]-this.data[9]*this.data[6],n=this.data[11]*this.data[5]-this.data[9]*this.data[7],new M(a,p,f,-((o=this.data[11]*this.data[6]-this.data[10]*this.data[7])*this.data[1]-n*this.data[2]+i*this.data[3])*u,s,c,m,(o*this.data[0]-r*this.data[2]+t*this.data[3])*u,l,d,y,-(n*this.data[0]-r*this.data[1]+e*this.data[3])*u,h,S,T,(i*this.data[0]-t*this.data[1]+e*this.data[2])*u)},M.prototype.InverseED=function(){var e=this.data[8]*this.data[13]-this.data[9]*this.data[12],t=this.data[8]*this.data[14]-this.data[10]*this.data[12],r=this.data[8]*this.data[15]-this.data[11]*this.data[12],i=this.data[9]*this.data[14]-this.data[10]*this.data[13],n=this.data[9]*this.data[15]-this.data[11]*this.data[13],o=this.data[10]*this.data[15]-this.data[11]*this.data[14],a=o*this.data[5]-n*this.data[6]+i*this.data[7],s=-(o*this.data[4]-r*this.data[6]+t*this.data[7]),l=n*this.data[4]-r*this.data[5]+e*this.data[7],h=-(i*this.data[4]-t*this.data[5]+e*this.data[6]),u=1/(a*this.data[0]+s*this.data[1]+l*this.data[2]+h*this.data[3]);a*=u,s*=u,l*=u,h*=u;var p=-(o*this.data[1]-n*this.data[2]+i*this.data[3])*u,c=(o*this.data[0]-r*this.data[2]+t*this.data[3])*u,d=-(n*this.data[0]-r*this.data[1]+e*this.data[3])*u,S=(i*this.data[0]-t*this.data[1]+e*this.data[2])*u;e=this.data[4]*this.data[13]-this.data[5]*this.data[12],t=this.data[4]*this.data[14]-this.data[6]*this.data[12],r=this.data[4]*this.data[15]-this.data[7]*this.data[12],i=this.data[5]*this.data[14]-this.data[6]*this.data[13],n=this.data[5]*this.data[15]-this.data[7]*this.data[13];var f=((o=this.data[6]*this.data[15]-this.data[7]*this.data[14])*this.data[1]-n*this.data[2]+i*this.data[3])*u,m=-(o*this.data[0]-r*this.data[2]+t*this.data[3])*u,y=(n*this.data[0]-r*this.data[1]+e*this.data[3])*u,T=-(i*this.data[0]-t*this.data[1]+e*this.data[2])*u;e=this.data[9]*this.data[4]-this.data[8]*this.data[5],t=this.data[10]*this.data[4]-this.data[8]*this.data[6],r=this.data[11]*this.data[4]-this.data[8]*this.data[7],i=this.data[10]*this.data[5]-this.data[9]*this.data[6],n=this.data[11]*this.data[5]-this.data[9]*this.data[7];var M=-((o=this.data[11]*this.data[6]-this.data[10]*this.data[7])*this.data[1]-n*this.data[2]+i*this.data[3])*u,g=(o*this.data[0]-r*this.data[2]+t*this.data[3])*u,v=-(n*this.data[0]-r*this.data[1]+e*this.data[3])*u,C=(i*this.data[0]-t*this.data[1]+e*this.data[2])*u;return this.data[0]=a,this.data[1]=p,this.data[2]=f,this.data[3]=M,this.data[4]=s,this.data[5]=c,this.data[6]=m,this.data[7]=g,this.data[8]=l,this.data[9]=d,this.data[10]=y,this.data[11]=v,this.data[12]=h,this.data[13]=S,this.data[14]=T,this.data[15]=C,this},M.BulkTranspose=function(e,t){for(var r=0;r<e.length&&r<t.length;++r)16==e[r].length&&16==t[r].length&&(e[0]=t[0],e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=t[1],e[5]=t[5],e[6]=t[9],e[7]=t[13],e[8]=t[2],e[9]=t[6],e[10]=t[10],e[11]=t[14],e[12]=t[3],e[13]=t[7],e[14]=t[11],e[15]=t[15])},M.prototype.Data=function(){return this.data},M.prototype.Value=function(e,t){return this.data[4*e+t]},M.prototype.ToMatrix3x4=function(){var e=new g.Matrix3x4;return e.copyFrom(this),e},M.prototype.Tostring=function(){return this.data[0].toString()+" "+this.data[1].toString()+" "+this.data[2].toString()+" "+this.data[3].toString()+" "+this.data[4].toString()+" "+this.data[5].toString()+" "+this.data[6].toString()+" "+this.data[7].toString()+" "+this.data[8].toString()+" "+this.data[9].toString()+" "+this.data[10].toString()+" "+this.data[11].toString()+" "+this.data[12].toString()+" "+this.data[13].toString()+" "+this.data[14].toString()+" "+this.data[15].toString()},M.prototype.fromString=function(e){var t=!1,r=e.split(" ");if(16==r.length){for(var i=0;i<16;i++)this.data[i]=parseFloat(r[i]);t=!0}return t},M.ZERO=function(){return null==M._ZERO&&(M._ZERO=new M(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)),M._ZERO},M.IDENTITY=function(){return null==M._IDENTITY&&(M._IDENTITY=new M),M._IDENTITY},M}();g.Matrix4=e}(M3D||(M3D={})),function(n){var e=function(){function i(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this.d=0,this.normal=new n.Vector3,this.absNormal=new n.Vector3;var r=!0;1===e.length?e[0]instanceof i?(r=!1,this.normal=e[0].normal,this.absNormal=e[0].absNormal,this.d=e[0].d):e[0]instanceof n.Vector4&&(r=!1,this.Define(e[0])):2===e.length?e[0]instanceof n.Vector3&&"number"==typeof e[1]?(r=!1,this.normal=e[0],this.absNormal=this.normal.Abs(),this.d=e[1]):e[0]instanceof n.Vector3&&e[1]instanceof n.Vector3&&(r=!1,this.Define(e[0],e[1])):3===e.length&&e[0]instanceof n.Vector3&&e[1]instanceof n.Vector3&&e[2]instanceof n.Vector3&&(r=!1,this.Define(e[0],e[1],e[2])),r&&(this.d=0)}return i.prototype.Define=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(1===e.length)e[0]instanceof n.Vector4&&(this.normal=new n.Vector3(e[0].x,e[0].y,e[0].z),this.absNormal=this.normal.Abs(),this.d=e[0].w);else if(2===e.length)e[0]instanceof n.Vector3&&e[1]instanceof n.Vector3&&(this.normal=e[0].Normalized(),this.absNormal=this.normal.Abs(),this.d=-this.normal.DotProduct(e[1]));else if(3===e.length&&e[0]instanceof n.Vector3&&e[1]instanceof n.Vector3&&e[2]instanceof n.Vector3){var r=e[1].Sub(e[0]),i=e[2].Sub(e[0]);this.Define(r.CrossProductED(i),e[0])}},i.prototype.Clone=function(){return new i(this)},i.prototype.Transform=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];1==e.length&&(e[0]instanceof n.Matrix3?this.Define(new n.Matrix4(e[0]).InverseED().TransposeED().Multiply(this.ToVector4())):e[0]instanceof n.Matrix3x4?this.Define(e[0].ToMatrix4().InverseED().TransposeED().Multiply(this.ToVector4())):e[0]instanceof n.Matrix4&&this.Define(e[0].Inverse().TransposeED().Multiply(this.ToVector4())))},i.prototype.ToVector4=function(){return new n.Vector4(this.normal,this.d)},i.prototype.Project=function(e){return e.Sub(this.normal.Multiply(this.normal.DotProduct(e)+this.d))},i.prototype.Distance=function(e){return this.normal.DotProduct(e)+this.d},i.prototype.Reflect=function(e){return e.Sub(this.normal.Multiply(2*this.normal.DotProduct(e)))},i.prototype.ReflectionMatrix=function(){return new n.Matrix3x4(-2*this.normal.x*this.normal.x+1,-2*this.normal.x*this.normal.y,-2*this.normal.x*this.normal.z,-2*this.normal.x*this.d,-2*this.normal.y*this.normal.x,-2*this.normal.y*this.normal.y+1,-2*this.normal.y*this.normal.z,-2*this.normal.y*this.d,-2*this.normal.z*this.normal.x,-2*this.normal.z*this.normal.y,-2*this.normal.z*this.normal.z+1,-2*this.normal.z*this.d)},i.prototype.Transformed=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(1==e.length)return e[0]instanceof n.Matrix3?new i(new n.Matrix4(e[0]).InverseED().TransposeED().Multiply(this.ToVector4())):e[0]instanceof n.Matrix3x4?new i(e[0].ToMatrix4().InverseED().TransposeED().Multiply(this.ToVector4())):e[0]instanceof n.Matrix4?new i(e[0].Inverse().TransposeED().Multiply(this.ToVector4())):void 0},i.prototype.GetInsectPnt=function(e,t){var r=this.normal.DotProduct(e.GetDirection());if(Math.abs(r)<1e-8)return!1;var i=e.GetOrigin(),n=(-this.d-this.normal.DotProduct(i))/r;return 0<=n&&(i.Add(e.GetDirection().Multiply(n)),!0)},i.prototype.GetInsectPnt1=function(e,t){var r=this.normal.DotProduct(e.GetDirection());if(Math.abs(r)<1e-8)return t;var i=e.GetOrigin(),n=(-this.d-this.normal.DotProduct(i))/r;return 0<=n&&(t=i.Add(e.GetDirection().Multiply(n))),t},i.prototype.copyFrom=function(e){this.normal.copyFrom(e.normal),this.absNormal.copyFrom(e.absNormal),this.d=e.d},i}();n.Plane=e}(M3D||(M3D={})),function(n){var e=function(){function i(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=!0;1===e.length?e[0]instanceof n.Vector4?(r=!1,this.min=new n.Vector2(e[0].x,e[0].y),this.max=new n.Vector2(e[0].z,e[0].w),this.defined=!0):e[0]instanceof i?(r=!1,this.min=new n.Vector2(e[0].min),this.max=new n.Vector2(e[0].max),this.defined=e[0].defined):e[0]instanceof Float32Array&&4<=e[0].length&&(r=!1,this.min=new n.Vector2(e[0][0],e[0][1]),this.max=new n.Vector2(e[0][2],e[0][3]),this.defined=!0):2===e.length?e[0]instanceof n.Vector2&&e[1]instanceof n.Vector2&&(r=!1,this.min=new n.Vector2,this.max=new n.Vector2,this.min.copyFrom(e[0]),this.max.copyFrom(e[1]),this.defined=!0):4<=e.length&&(this.min=new n.Vector2(e[0],e[1]),this.max=new n.Vector2(e[2],e[3]),this.defined=!0),r&&(this.min=new n.Vector2,this.max=new n.Vector2,this.min.copyFrom(n.Vector2.ZERO()),this.max.copyFrom(n.Vector2.ZERO()),this.defined=!1)}return i.prototype.copyFrom=function(e){this.min.copyFrom(e.min),this.max.copyFrom(e.max),this.defined=e.defined},i.prototype.Equals=function(e){return this.min.Equals(e.min)&&this.max.Equals(e.max)},i.prototype.Define=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];1===e.length?e[0]instanceof i?(this.min.copyFrom(e[0].min),this.max.copyFrom(e[0].max),this.defined=!0):e[0]instanceof n.Vector2&&(this.min.copyFrom(e[0]),this.max.copyFrom(e[0]),this.defined=!0):2===e.length&&(this.min.copyFrom(e[0]),this.max.copyFrom(e[1]),this.defined=!0)},i.prototype.Merge=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];1===e.length&&(e[0]instanceof n.Vector2?(this.defined||(this.min=this.max=e[0],this.defined=!0),e[0].x<this.min.x&&(this.min.x=e[0].x),e[0].x>this.max.x&&(this.max.x=e[0].x),e[0].y<this.min.y&&(this.min.y=e[0].y),e[0].y>this.max.y&&(this.max.y=e[0].y)):e[0]instanceof i&&(this.defined||(this.min=e[0].min,this.max=e[0].max,this.defined=!0),e[0].min.x<this.min.x&&(this.min.x=e[0].min.x),e[0].min.y<this.min.y&&(this.min.y=e[0].min.y),e[0].max.x>this.max.x&&(this.max.x=e[0].max.x),e[0].max.y>this.max.y&&(this.max.y=e[0].max.y)))},i.prototype.Clear=function(){this.min=n.Vector2.ZERO(),this.max=n.Vector2.ZERO(),this.defined=!1},i.prototype.Clip=function(e){if(e.min.x>this.min.x&&(this.min.x=e.min.x),e.max.x<this.max.x&&(this.max.x=e.max.x),e.min.y>this.min.y&&(this.min.y=e.min.y),e.max.y<this.max.y&&(this.max.y=e.max.y),this.min.x>this.max.x){var t=this.min.x;this.min.x=this.max.x,this.max.x=t}if(this.min.y>this.max.y){t=this.min.y;this.min.y=this.max.y,this.max.y=t}},i.prototype.Center=function(){return this.max.Add(this.min).MultiplyED(.5)},i.prototype.Size=function(){return this.max.Sub(this.min)},i.prototype.HalSize=function(){return this.max.Sub(this.min).MultiplyED(.5)},i.prototype.IsInside=function(e){return e.x<this.min.x||e.y<this.min.y||e.x>this.max.x||e.y>this.max.y?n.Intersection.OUTSIDE:n.Intersection.INSIDE},i.prototype.ToVector4=function(){return new n.Vector4(this.min.x,this.min.y,this.max.x,this.max.y)},i.prototype.Tostring=function(){return this.min.x.toString()+" "+this.min.y.toString()+" "+this.max.x.toString()+" "+this.max.y},i.FULL=function(){return null==i.full&&(i.full=new i(-1,-1,1,1)),i.full},i.POSITIVE=function(){return null==i.positive&&(i.positive=new i(0,0,1,1)),i.positive},i.ZERO=function(){return null==i.zero&&(i.zero=new i(0,0,0,0)),i.zero},i.full=null,i.positive=null,i.zero=null,i}();n.Rect=e;var t=function(){function e(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];0===e.length?(this.left=0,this.top=0,this.right=0,this.bottom=0):1===e.length?(this.left=e[0],this.top=e[1],this.right=e[2],this.bottom=e[3]):4===e.length&&(this.left=e[0],this.top=e[1],this.right=e[2],this.bottom=e[3])}return e.prototype.copyFrom=function(e){this.left=e.left,this.top=e.top,this.right=e.right,this.bottom=e.bottom},e.prototype.Equal=function(e){return this.left===e.left&&this.top===e.top&&this.right===e.right&&this.bottom===e.bottom},e.prototype.NotEqual=function(e){return this.left!==e.left||this.top!==e.top||this.right!==e.right||this.bottom!==e.bottom},e.prototype.Size=function(){return new n.Vector2(this.Width(),this.Height())},e.prototype.Width=function(){return this.right-this.left},e.prototype.Height=function(){return this.bottom-this.top},e.prototype.Center=function(){return new n.Vector2(this.left+this.Width()/2,this.top+this.Height()/2)},e.prototype.Data=function(){return this.left},e.prototype.IsInside=function(e){return e.x<this.left||e.y<this.top||e.x>=this.right||e.y>=this.bottom?n.OUTSIDE:n.INSIDE},e.prototype.Tostring=function(){return this.left.toString()+" "+this.top.toString()+" "+this.right.toString()+" "+this.bottom.toString()},e.ZERO=function(){return null==e.zero&&(e.zero=new e(0,0,0,0)),e.zero},e.zero=null,e}();n.IntRect=t}(M3D||(M3D={})),function(g){var e=function(){function r(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this.origin=new g.Vector3,this.direction=new g.Vector3,1==e.length?e[0]instanceof r&&(!1,this.origin.copyFrom(e[0].origin),this.direction.copyFrom(e[0].direction)):2==e.length&&e[0]instanceof g.Vector3&&e[1]instanceof g.Vector3&&(!1,this.Define(e[0],e[1]))}return r.prototype.copyFrom=function(e){this.origin.copyFrom(e.origin),this.direction.copyFrom(e.direction)},r.prototype.Equals=function(e){return this.origin.Equals(e.origin)&&this.direction.Equals(e.direction)},r.prototype.Define=function(e,t){this.origin=e.Clone(),this.direction.copyFrom(t.Normalized())},r.prototype.Project=function(e){var t=e.Sub(this.origin);return this.origin.Add(this.direction.Multiply(t.DotProduct(this.direction)))},r.prototype.Distance=function(e){var t=this.Project(e);return e.Sub(t).Length()},r.prototype.Clone=function(){var e=new r;return e.origin=this.origin,e.direction=this.direction,e},r.prototype.ClosestPoint=function(e){var t=this.origin.Sub(e.origin),r=e.direction,i=this.direction,n=t.DotProduct(r),o=r.DotProduct(i),a=t.DotProduct(i),s=r.DotProduct(r),l=i.DotProduct(i)*s-o*o;if(g.Abs(l)<g.EPSILON)return this.origin.Clone();var h=(n*o-a*s)/l;return this.origin.Add(this.direction.Multiply(h))},r.prototype.HitDistance=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(1==e.length){if(e[0]instanceof g.Plane){var r=e[0].normal.DotProduct(this.direction);return g.Abs(r)>=g.EPSILON&&0<=(m=-(e[0].normal.DotProduct(this.origin)+e[0].d)/r)?m:g.INFINITY}if(e[0]instanceof g.BoundingBox){if(!e[0].defined)return g.INFINITY;if(e[0].IsInside(this.origin))return 0;var i,n,o=g.INFINITY;if(this.origin.x<e[0].min.x&&0<this.direction.x)if((i=(e[0].min.x-this.origin.x)/this.direction.x)<o)(n=this.origin.Add(this.direction.Multiply(i))).y>=e[0].min.y&&n.y<=e[0].max.y&&n.z>=e[0].min.z&&n.z<=e[0].max.z&&(o=i);if(this.origin.x>e[0].max.x&&this.direction.x<0)if((i=(e[0].max.x-this.origin.x)/this.direction.x)<o)(n=this.origin.Add(this.direction.Multiply(i))).y>=e[0].min.y&&n.y<=e[0].max.y&&n.z>=e[0].min.z&&n.z<=e[0].max.z&&(o=i);if(this.origin.y<e[0].min.y&&0<this.direction.y)if((i=(e[0].min.y-this.origin.y)/this.direction.y)<o)(n=this.origin.Add(this.direction.Multiply(i))).x>=e[0].min.x&&n.x<=e[0].max.x&&n.z>=e[0].min.z&&n.z<=e[0].max.z&&(o=i);if(this.origin.y>e[0].max.y&&this.direction.y<0)if((i=(e[0].max.y-this.origin.y)/this.direction.y)<o)(n=this.origin.Add(this.direction.Multiply(i))).x>=e[0].min.x&&n.x<=e[0].max.x&&n.z>=e[0].min.z&&n.z<=e[0].max.z&&(o=i);if(this.origin.z<e[0].min.z&&0<this.direction.z)if((i=(e[0].min.z-this.origin.z)/this.direction.z)<o)(n=this.origin.Add(this.direction.Multiply(i))).x>=e[0].min.x&&n.x<=e[0].max.x&&n.y>=e[0].min.y&&n.y<=e[0].max.y&&(o=i);if(this.origin.z>e[0].max.z&&this.direction.z<0)if((i=(e[0].max.z-this.origin.z)/this.direction.z)<o)(n=this.origin.Add(this.direction.Multiply(i))).x>=e[0].min.x&&n.x<=e[0].max.x&&n.y>=e[0].min.y&&n.y<=e[0].max.y&&(o=i);return o}}else if(2==e.length){if(e[0]instanceof g.Frustum&&e[1]instanceof Boolean){for(var a=0,s=g.INFINITY,l=!0,h=0;h<g.NUFRUSTUPLANES;++h){var u=e[0].planes[h],p=this.HitDistance(e[0].planes[h]);u.Distance(this.origin)<0?(a=g.Max(a,p),l=!1):s=g.Min(s,p)}return l?e[1]?0:s:a<=s?a:g.INFINITY}}else if(3<=e.length&&e[0]instanceof g.Vector3&&e[1]instanceof g.Vector3&&e[2]instanceof g.Vector3){var c=e[1].Sub(e[0]),d=e[2].Sub(e[0]),S=new g.Vector3(this.direction.CrossProduct(d)),f=c.DotProduct(S);if(f>=g.EPSILON){var m,y=(m=this.origin.Sub(e[0])).DotProduct(S);if(0<=y&&y<=f){var T=m.CrossProductED(c),M=this.direction.DotProduct(T);if(0<=M&&y+M<=f)if(0<=(p=d.DotProduct(T)/f))return e[2]&&e[2].copyFrom(c.CrossProductED(d)),p}}return g.INFINITY}},r.prototype.Transformed=function(e){var t=new r;return t.origin=e.Multiply(this.origin),t.direction=e.Multiply(new g.Vector4(this.direction,0)),t},r.prototype.GetDirection=function(){return this.direction},r.prototype.GetOrigin=function(){return this.origin},r}();g.Ray=e}(M3D||(M3D={})),function(s){var e=function(){function e(){}return e.prototype.IsInside=function(e){var t,r=this.radius_*this.radius_,i=0,n=e.min.Clone(),o=e.max.Clone();if(this.center_.x<n.x?i+=(t=this.center_.x-n.x)*t:this.center_.x>o.x&&(i+=(t=this.center_.x-o.x)*t),this.center_.y<n.y?i+=(t=this.center_.y-n.y)*t:this.center_.y>o.y&&(i+=(t=this.center_.y-o.y)*t),this.center_.z<n.z?i+=(t=this.center_.z-n.z)*t:this.center_.z>o.z&&(i+=(t=this.center_.z-o.z)*t),r<=i)return s.OUTSIDE;o=(n=n.Sub(this.center_).Clone()).Sub(this.center_).Clone();var a=n.Clone();return a.LengthSquared()>=r?s.INTERSECTS:(a.x=o.x,a.LengthSquared()>=r?s.INTERSECTS:(a.y=o.y,a.LengthSquared()>=r?s.INTERSECTS:(a.x=n.x,a.LengthSquared()>=r?s.INTERSECTS:(a.z=o.z,a.LengthSquared()>=r?s.INTERSECTS:(a.y=n.y,a.LengthSquared()>=r?s.INTERSECTS:(a.x=o.x,a.LengthSquared()>=r?s.INTERSECTS:(a.y=o.y,a.LengthSquared()>=r?s.INTERSECTS:s.INSIDE)))))))},e.prototype.GetCenter=function(){return this.center_},e.prototype.SetCenter=function(e){this.center_=e},e.prototype.SetRadius=function(e){this.radius_=e},e.prototype.GetRadius=function(){return this.radius_},e.prototype.Distance=function(e){return s.Max(e.Sub(this.center_).Length()-this.radius_,0)},e}();s.Sphere=e}(M3D||(M3D={})),function(e){var t=function(){function e(){this._count=0,this._data={}}return e.prototype.get=function(e){var t=this._data[e];if(void 0!==t)return t},e.prototype.getOrAddWithFactory=function(e,t){var r=this.get(e);return void 0!==r||(r=t(e))&&this.add(e,r),r},e.prototype.getOrAdd=function(e,t){var r=this.get(e);return void 0!==r?r:(this.add(e,t),t)},e.prototype.contains=function(e){return void 0!==this._data[e]},e.prototype.add=function(e,t){return void 0===this._data[e]&&(this._data[e]=t,++this._count,!0)},e.prototype.set=function(e,t){return void 0!==this._data[e]&&(this._data[e]=t,!0)},e.prototype.remove=function(e){return!!this.contains(e)&&(delete this._data[e],--this._count,!0)},e.prototype.clear=function(){this._data={},this._count=0},Object.defineProperty(e.prototype,"count",{get:function(){return this._count},enumerable:!0,configurable:!0}),e.prototype.forEach=function(e){for(var t in this._data){e(t,this._data[t])}},e.prototype.first=function(e){for(var t in this._data){var r=e(t,this._data[t]);if(r)return r}return null},e}();e.StringDictionary=t}(M3D||(M3D={})),function(e){var t=function(){function e(){this.isStart=!1,this.outerTimerId=-1,this.innerTimerId=-1,this.interval=36,this.task=null}return e.prototype.SetTimer=function(e,t,r){this.task=e,this.interval=r,this.data=t},e.prototype.StartTimer=function(){this.isStart=!0;var e=this;this.outerTimerId=setTimeout(function(){e.task(e.data),e.IsStart()&&(e.innerTimerId=setTimeout(arguments.callee,e.interval))},e.interval)},e.prototype.StopTimer=function(){this.isStart=!1,clearTimeout(this.innerTimerId),clearTimeout(this.outerTimerId)},e.prototype.IsStart=function(){return this.isStart},e}();e.Timer=t}(M3D||(M3D={})),function(r){var e=function(){function i(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=!0;1===e.length?e[0]instanceof i?(r=!1,this.x=e[0].x,this.y=e[0].y):e[0]instanceof Float32Array&&2===e[0].length&&(r=!1,this.x=e[0][0],this.y=e[0][1]):2===e.length&&"number"==typeof e[0]&&"number"==typeof e[1]&&(r=!1,this.x=e[0],this.y=e[1]),r&&(this.x=this.y=0)}return i.prototype.Clone=function(){return new i(this)},i.prototype.copyFrom=function(e){this.x=e.x,this.y=e.y},i.prototype.Equals=function(e){return r.Equals(this.x,e.x)&&r.Equals(this.y,e.y)},i.prototype.Add=function(e){return new i(this.x+e.x,this.y+e.y)},i.prototype.AddED=function(e){return this.x+=e.x,this.y+=e.y,this},i.prototype.Sub=function(e){return new i(this.x-e.x,this.y-e.y)},i.prototype.SubED=function(e){return this.x-=e.x,this.y-=e.y,this},i.prototype.Multiply=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return 1!==e.length?null:"number"==typeof e[0]?new i(this.x*e[0],this.y*e[0]):e[0]instanceof i?new i(this.x*e[0].x,this.y*e[0].y):null},i.prototype.MultiplyED=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return 1!==e.length||("number"==typeof e[0]?(this.x*=e[0],this.y*=e[0]):e[0]instanceof i&&(this.x*=e[0].x,this.y*=e[0].y)),this},i.prototype.Divide=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return 1!==e.length?null:"number"==typeof e[0]?new i(this.x/e[0],this.y/e[0]):e[0]instanceof i?new i(this.x/e[0].x,this.y/e[0].y):null},i.prototype.DivideED=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return 1!==e.length||("number"==typeof e[0]?(this.x/=e[0],this.y/=e[0]):e[0]instanceof i&&(this.x/=e[0].x,this.y/=e[0].y)),this},i.prototype.LengthSquared=function(){return this.x*this.x+this.y*this.y},i.prototype.Normalize=function(){var e=this.LengthSquared();if(!r.Equals(e,1)&&0<e){var t=1/Math.sqrt(e);this.x*=t,this.y*=t}return this},i.prototype.Length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},i.prototype.DotProduct=function(e){return this.x*e.x+this.y*e.y},i.prototype.AbsDotProduct=function(e){return Math.abs(this.x*e.x)+Math.abs(this.y*e.y)},i.prototype.Abs=function(){return new i(Math.abs(this.x),Math.abs(this.y))},i.prototype.AbsED=function(){return this.x<0&&(this.x=-this.x),this.y<0&&(this.y=-this.y),this},i.prototype.Lerp=function(e,t){return this.Multiply(1-t).AddED(e.Multiply(t))},i.prototype.LerpED=function(e,t){return this.MultiplyED(1-t).AddED(e.Multiply(t)),this},i.prototype.IsZero=function(){return this.LengthSquared()<1e-8},i.prototype.Nagative=function(){return this.Multiply(-1)},i.prototype.NagativeED=function(){return this.x*=-1,this.y*=-1,this},i.prototype.ToZero=function(){this.copyFrom(i.ZERO())},i.prototype.ToOne=function(){this.copyFrom(i.ONE())},i.prototype.Normalized=function(){var e=this.LengthSquared();if(!r.Equals(e,1)&&0<e){var t=1/Math.sqrt(e);return this.Multiply(t)}return new i(this)},i.prototype.NormalizedED=function(){var e=this.LengthSquared();if(!r.Equals(e,1)&&0<e){var t=1/Math.sqrt(e);return this.MultiplyED(t)}return this},i.prototype.Data=function(){var e=new Float32Array(2);return e[0]=this.x,e[1]=this.y,e},i.prototype.Tostring=function(){return this.x.toString()+" "+this.y.toString()},i.ZERO=function(){return null==i._ZERO&&(i._ZERO=new i),i._ZERO},i.LEFT=function(){return null==i._LEFT&&(i._LEFT=new i(-1,0)),i._LEFT},i.RIGHT=function(){return null==i._RIGHT&&(i._RIGHT=new i(1,0)),i._RIGHT},i.UP=function(){return null==i._UP&&(i._UP=new i(0,1)),i._UP},i.DOWN=function(){return null==i._DOWN&&(i._DOWN=new i(0,-1)),i._DOWN},i.ONE=function(){return null==i._ONE&&(i._ONE=new i(1,1)),i._ONE},i}();r.Vector2=e}(M3D||(M3D={})),function(h){var e=function(){function l(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=!0;1===e.length?e[0]instanceof l?(r=!1,this.x=e[0].x,this.y=e[0].y,this.z=e[0].z,this.w=e[0].w):e[0]instanceof h.Matrix3?(r=!1,this.FromRotationMatrix(e[0])):"number"==typeof e[0]?(r=!1,this.FromAngleAxis(e[0],h.Vector3.FORWARD())):e[0]instanceof Float32Array&&4===e[0].length&&(r=!1,this.w=e[0][0],this.x=e[0][1],this.y=e[0][2],this.z=e[0][3]):2===e.length?(r=!1,e[1]instanceof h.Vector3&&"number"==typeof e[0]?this.FromAngleAxis(e[0],e[1]):e[1]instanceof h.Vector3&&e[0]instanceof h.Vector3&&this.FromRotationTo(e[0],e[1])):3===e.length?"number"==typeof e[0]&&"number"==typeof e[1]&&"number"==typeof e[2]?(r=!1,this.FromEulerAngles(e[0],e[1],e[2])):e[0]instanceof h.Vector3&&e[1]instanceof h.Vector3&&e[2]instanceof h.Vector3&&(r=!1,this.FromAxes(e[0],e[1],e[2])):4===e.length&&(r=!1,this.w=e[0],this.x=e[1],this.y=e[2],this.z=e[3]),r&&(this.w=1,this.x=this.y=this.z=0)}return l.prototype.IsZero=function(){return this.x*this.x+this.y*this.y+this.z*this.z<1e-8},l.prototype.FromAxes=function(e,t,r){var i=new h.Matrix3(e.x,t.x,r.x,e.y,t.y,r.y,e.z,t.z,r.z);this.FromRotationMatrix(i)},l.prototype.ToMatrix=function(e){var t,r,i,n,o,a,s,l,h,u,p,c,d;t=2/(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w),r=this.x*t,i=this.y*t,n=this.z*t,o=this.w*r,a=this.w*i,s=this.w*n,l=this.x*r,h=this.x*i,u=this.x*n,p=this.y*i,c=this.y*n,d=this.z*n,e[0][0]=1-(p+d),e[0][1]=h+s,e[0][2]=u-a,e[0][3]=0,e[1][0]=h-s,e[1][1]=1-(l+d),e[1][2]=c+o,e[1][3]=0,e[2][0]=u+a,e[2][1]=c-o,e[2][2]=1-(l+p),e[2][3]=0,e[3][0]=0,e[3][1]=0,e[3][2]=0,e[3][3]=1},l.prototype.FromEulerAngles=function(e,t,r){e*=h.DEGTORAD_2,t*=h.DEGTORAD_2,r*=h.DEGTORAD_2;var i=Math.sin(e),n=Math.cos(e),o=Math.sin(t),a=Math.cos(t),s=Math.sin(r),l=Math.cos(r);this.w=a*n*l+o*i*s,this.x=a*i*l+o*n*s,this.y=o*n*l-a*i*s,this.z=a*n*s-o*i*l},l.prototype.FromRotationTo=function(e,t){var r=e.Normalized(),i=t.Normalized(),n=r.DotProduct(i);if(n>-1+h.EPSILON){var o=r.CrossProduct(i),a=Math.sqrt(2*(1+n)),s=1/a;this.x=o.x*s,this.y=o.y*s,this.z=o.z*s,this.w=.5*a}else{var l=h.Vector3.RIGHT().CrossProduct(r);l.Length()<h.EPSILON&&(l=h.Vector3.UP().CrossProduct(r)),this.FromAngleAxis(180,l)}},l.prototype.Clone=function(){return new l(this)},l.prototype.FromAngleAxis=function(e,t){var r=t.Normalized();e*=h.DEGTORAD_2;var i=Math.sin(e),n=Math.cos(e);this.w=n,this.x=r.x*i,this.y=r.y*i,this.z=r.z*i},l.prototype.FromRotationMatrix=function(e){var t=e.data[0]+e.data[4]+e.data[8];if(0<t){var r=.5/Math.sqrt(1+t);this.x=(e.data[7]-e.data[5])*r,this.y=(e.data[2]-e.data[6])*r,this.z=(e.data[3]-e.data[1])*r,this.w=.25/r}else if(e.data[0]>e.data[4]&&e.data[0]>e.data[8]){r=.5/Math.sqrt(1+e.data[0]-e.data[4]-e.data[8]);this.x=.25/r,this.y=(e.data[1]+e.data[3])*r,this.z=(e.data[6]+e.data[2])*r,this.w=(e.data[7]-e.data[5])*r}else if(e.data[4]>e.data[8]){r=.5/Math.sqrt(1+e.data[4]-e.data[0]-e.data[8]);this.x=(e.data[1]+e.data[3])*r,this.y=.25/r,this.z=(e.data[5]+e.data[7])*r,this.w=(e.data[2]-e.data[6])*r}else{r=.5/Math.sqrt(1+e.data[8]-e.data[0]-e.data[4]);this.x=(e.data[2]+e.data[6])*r,this.y=(e.data[5]+e.data[7])*r,this.z=.25/r,this.w=(e.data[3]-e.data[1])*r}},l.prototype.FromLookRotation=function(e,t){var r=e.Normalized(),i=t.Normalized(),n=r.CrossProduct(i).Normalized();i=n.CrossProduct(r).Normalized();var o=new l;return o.FromAxes(n,i,r.Nagative()),this.copyFrom(o),!0},l.prototype.copyFrom=function(e){this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w},l.prototype.Equal=function(e,t){if(!(0<=t))return!1;var r=this.x-e.x,i=this.y-e.y,n=this.z-e.z,o=this.w-e.w;return Math.abs(r)<=t&&Math.abs(i)<=t&&Math.abs(n)<=t&&Math.abs(o)<=t},l.prototype.Equals=function(e){return h.Equals(this.x,e.x)&&h.Equals(this.y,e.y)&&h.Equals(this.z,e.z)&&h.Equals(this.w,e.w)},l.prototype.Add=function(e){return new l(this.w+e.w,this.x+e.x,this.y+e.y,this.z+e.z)},l.prototype.AddED=function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this},l.prototype.Sub=function(e){return new l(this.w-e.w,this.x-e.x,this.y-e.y,this.z-e.z)},l.prototype.SubED=function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this},l.prototype.Multiply=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(1!==e.length)return null;if("number"==typeof e[0])return new l(this.w*e[0],this.x*e[0],this.y*e[0],this.z*e[0]);if(e[0]instanceof l)return new l(this.w*e[0].w-this.x*e[0].x-this.y*e[0].y-this.z*e[0].z,this.w*e[0].x+this.x*e[0].w+this.y*e[0].z-this.z*e[0].y,this.w*e[0].y+this.y*e[0].w+this.z*e[0].x-this.x*e[0].z,this.w*e[0].z+this.z*e[0].w+this.x*e[0].y-this.y*e[0].x);if(e[0]instanceof h.Vector3){var r=new h.Vector3(this.x,this.y,this.z),i=r.CrossProduct(e[0]),n=r.CrossProductED(i);return e[0].Add(i.MultiplyED(this.w).AddED(n).MultiplyED(2))}return null},l.prototype.MultiplyED=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(1!==e.length)return this;if("number"==typeof e[0])this.x*=e[0],this.y*=e[0],this.z*=e[0],this.w*=e[0];else if(e[0]instanceof l){var r=this.w*e[0].w-this.x*e[0].x-this.y*e[0].y-this.z*e[0].z,i=this.w*e[0].x+this.x*e[0].w+this.y*e[0].z-this.z*e[0].y,n=this.w*e[0].y+this.y*e[0].w+this.z*e[0].x-this.x*e[0].z,o=this.w*e[0].z+this.z*e[0].w+this.x*e[0].y-this.y*e[0].x;this.w=r,this.x=i,this.y=n,this.z=o}return this},l.prototype.LengthSquared=function(){return this.w*this.w+this.x*this.x+this.y*this.y+this.z*this.z},l.prototype.Normalize=function(){var e=this.LengthSquared();if(!h.Equals(e,1)&&0<e){var t=1/Math.sqrt(e);this.w*=t,this.x*=t,this.y*=t,this.z*=t}},l.prototype.NormalizeED=function(){var e=this.LengthSquared();if(!h.Equals(e,1)&&0<e){var t=1/Math.sqrt(e);this.w*=t,this.x*=t,this.y*=t,this.z*=t}return this},l.prototype.ToZero=function(){this.copyFrom(l.IDENTITY())},l.prototype.Normalized=function(){var e=this.LengthSquared();if(!h.Equals(e,1)&&0<e){var t=1/Math.sqrt(e);return this.Multiply(t)}return new l(this)},l.prototype.NormalizedED=function(){var e=this.LengthSquared();if(!h.Equals(e,1)&&0<e){var t=1/Math.sqrt(e);return this.MultiplyED(t)}return this},l.prototype.Conjugate=function(){return new l(this.w,-this.x,-this.y,-this.z)},l.prototype.Inverse=function(){var e=this.LengthSquared();return h.Equals(e,1)?this.Conjugate():e>=h.EPSILON?this.Conjugate().Multiply(1/e):l.IDENTITY().Clone()},l.prototype.ConjugateED=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},l.prototype.InverseED=function(){var e=this.LengthSquared();return h.Equals(e,1)?this.ConjugateED():e>=h.EPSILON?this.ConjugateED().MultiplyED(1/e):l.IDENTITY().Clone()},l.prototype.DotProduct=function(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w},l.prototype.EulerAngles=function(){var e=2*(-this.y*this.z+this.w*this.x);return e<-.995?new h.Vector3(-90,0,-Math.atan2(2*(this.x*this.z-this.w*this.y),1-2*(this.y*this.y+this.z*this.z))*h.RADTODEG):.995<e?new h.Vector3(90,0,Math.atan2(2*(this.x*this.z-this.w*this.y),1-2*(this.y*this.y+this.z*this.z))*h.RADTODEG):new h.Vector3(Math.asin(e)*h.RADTODEG,Math.atan2(2*(this.x*this.z+this.w*this.y),1-2*(this.x*this.x+this.y*this.y))*h.RADTODEG,Math.atan2(2*(this.x*this.y+this.w*this.z),1-2*(this.x*this.x+this.z*this.z))*h.RADTODEG)},l.prototype.YawAngle=function(){return this.EulerAngles().y},l.prototype.PitchAngle=function(){return this.EulerAngles().x},l.prototype.RollAngle=function(){return this.EulerAngles().z},l.prototype.RotationMatrix=function(){return new h.Matrix3(1-2*this.y*this.y-2*this.z*this.z,2*this.x*this.y-2*this.w*this.z,2*this.x*this.z+2*this.w*this.y,2*this.x*this.y+2*this.w*this.z,1-2*this.x*this.x-2*this.z*this.z,2*this.y*this.z-2*this.w*this.x,2*this.x*this.z-2*this.w*this.y,2*this.y*this.z+2*this.w*this.x,1-2*this.x*this.x-2*this.y*this.y)},l.prototype.Slerp=function(e,t){var r=this.DotProduct(e);r<0&&(r=-r,e=e.Multiply(-1));var i,n,o=Math.acos(r),a=Math.sin(o);if(.001<a){var s=1/a;i=Math.sin((1-t)*o)*s,n=Math.sin(t*o)*s}else i=1-t,n=t;return this.Multiply(i).AddED(e.Multiply(n))},l.prototype.SlerpED=function(e,t){var r=this.DotProduct(e);r<0&&(r=-r,e=e.Multiply(-1));var i,n,o=Math.acos(r),a=Math.sin(o);if(.001<a){var s=1/a;i=Math.sin((1-t)*o)*s,n=Math.sin(t*o)*s}else i=1-t,n=t;return this.MultiplyED(i).AddED(e.Multiply(n))},l.prototype.Nlerp=function(e,t,r){var i;return(i=this.DotProduct(e)<0&&r?this.Add(e.Multiply(-1).SubED(this).MultiplyED(t)):this.Add(e.Sub(this).MultiplyED(t))).NormalizeED(),i},l.prototype.NlerpED=function(e,t,r){var i;return(i=this.DotProduct(e)<0&&r?this.AddED(e.Multiply(-1).SubED(this).MultiplyED(t)):this.AddED(e.Sub(this).MultiplyED(t))).NormalizeED(),i},l.QslerpNoInvertExtraSpins=function(e,t,r,i){var n=e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w,o=Math.acos(n);if(Math.abs(o)<.005)return e;var a=1/Math.sin(o),s=3.1415927*i*r,l=Math.sin((1-r)*o-s)*a,h=Math.sin(r*o+s)*a;return e.Multiply(l).AddED(t.Multiply(h))},l.Qexp=function(e){var t=Math.sqrt(e.x*e.x+e.y*e.y+e.z*e.z),r=Math.sin(t),i=Math.cos(t),n=new l;return n.w=i,0<t?(n.x=r*e.x/t,n.y=r*e.y/t,n.z=r*e.z/t):n.x=n.y=n.z=0,n},l.Qlog=function(e){var t=Math.acos(e.w),r=Math.sin(t),i=new l;return(i.w=0)<r?(i.x=t*e.x/r,i.y=t*e.y/r,i.z=t*e.z/r):i.x=i.y=i.z=0,i},l.Qspline=function(e,t,r){var i=new l;return i.x=-t.x,i.y=-t.y,i.z=-t.z,i.w=t.w,t.Multiply(l.Qexp(l.Qlog(i.Multiply(e)).AddED(l.Qlog(i.Multiply(r))).MultiplyED(-.25)))},l.Qsquad=function(e,t,r,i,n){var o,a;return o=l.QslerpNoInvert(e,t,n),a=l.QslerpNoInvert(r,i,n),l.QslerpNoInvert(o,a,2*n*(1-n))},l.Qlerp=function(e,t,r){new l;return e.Add(t.Sub(e).MultiplyED(r)).NormalizeED()},l.QslerpNoInvert=function(e,t,r){var i=e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w;new l;if(-.95<i&&i<.95){var n,o,a,s=Math.acos(i);return n=Math.sin(s),o=Math.sin(s*r),a=Math.sin(s*(1-r)),e.Multiply(a).AddED(t.Multiply(o)).Multiply(1/n)}return l.Qlerp(e,t,r)},l.MatrixToQuaternion=function(e){var t,r,i,n,o,a=h.ArrayMaker.MakeNumArray(4);if(0<(t=e[0][0]+e[1][1]+e[2][2]))r=Math.sqrt(t+1),a[3]=.5*r,r=.5/r,a[0]=(e[1][2]-e[2][1])*r,a[1]=(e[2][0]-e[0][2])*r,a[2]=(e[0][1]-e[1][0])*r;else{i=0,e[1][1]>e[0][0]&&(i=1),e[2][2]>e[i][i]&&(i=2);var s=[1,2,0];o=s[n=s[i]],r=Math.sqrt(e[i][i]-(e[n][n]+e[o][o])+1),a[i]=.5*r,r=.5/r,a[3]=(e[n][o]-e[o][n])*r,a[n]=(e[i][n]+e[n][i])*r,a[o]=(e[i][o]+e[o][i])*r}return new l(a[3],a[0],a[1],a[2])},l.prototype.Data=function(){var e=new Float32Array(4);return e[0]=this.w,e[1]=this.x,e[2]=this.y,e[3]=this.z,e},l.prototype.Tostring=function(){return this.x.toString()+" "+this.y.toString()+" "+this.z.toString()+" "+this.w.toString()},l.IDENTITY=function(){return null==l._IDENTITY&&(l._IDENTITY=new l),l._IDENTITY},l}();h.Quaternion=e}(M3D||(M3D={})),function(n){var e=function(){function i(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=!0;1===e.length?e[0]instanceof i?(r=!1,this.x=e[0].x,this.y=e[0].y,this.z=e[0].z):e[0]instanceof n.Vector2?(r=!1,this.x=e[0].x,this.y=e[0].y,this.z=0):e[0]instanceof Float32Array&&3===e[0].length&&(r=!1,this.x=e[0][0],this.y=e[0][1],this.z=e[0][2]):2===e.length?e[0]instanceof n.Vector2&&"number"==typeof e[1]?(r=!1,this.x=e[0].x,this.y=e[0].y,this.z=e[1]):"number"==typeof e[0]&&"number"==typeof e[1]&&(r=!1,this.x=e[0],this.y=e[1],this.z=0):3===e.length&&(r=!1,this.x=e[0],this.y=e[1],this.z=e[2]),r&&(this.x=this.y=this.z=0)}return i.prototype.Clone=function(){return new i(this)},i.prototype.copyFrom=function(e){this.x=e.x,this.y=e.y,this.z=e.z},i.prototype.copyFromXYZ=function(e,t,r){this.x=e,this.y=t,this.z=r},i.prototype.Equal=function(e,t){return void 0===t&&(t=n.HPOINT_EPSILON),this.x-e.x<t&&this.x-e.x>-t&&this.y-e.y<t&&this.y-e.y>-t&&this.z-e.z<t&&this.z-e.z>-t},i.prototype.Equals=function(e){return n.Equals(this.x,e.x)&&n.Equals(this.y,e.y)&&n.Equals(this.z,e.z)},i.prototype.Add=function(e){return new i(Number(this.x)+Number(e.x),Number(this.y)+Number(e.y),Number(this.z)+Number(e.z))},i.prototype.AddED=function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this},i.prototype.Sub=function(e){return new i(Number(this.x)-Number(e.x),Number(this.y)-Number(e.y),Number(this.z)-Number(e.z))},i.prototype.SubFill=function(e,t){t.x=this.x-e.x,t.y=this.y-e.y,t.z=this.z-e.z},i.prototype.SubED=function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this},i.prototype.Multiply=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return 1!==e.length?null:"number"==typeof e[0]?new i(Number(this.x)*Number(e[0]),Number(this.y)*Number(e[0]),Number(this.z)*Number(e[0])):e[0]instanceof i?new i(Number(this.x)*Number(e[0].x),Number(this.y)*Number(e[0].y),Number(this.z)*Number(e[0].z)):null},i.prototype.MultiplyED=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return 1!==e.length||("number"==typeof e[0]?(this.x*=e[0],this.y*=e[0],this.z*=e[0]):e[0]instanceof i&&(this.x*=e[0].x,this.y*=e[0].y,this.z*=e[0].z)),this},i.prototype.Divide=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return 1!==e.length?null:"number"==typeof e[0]?new i(this.x/e[0],this.y/e[0],this.z/e[0]):e[0]instanceof i?new i(this.x/e[0].x,this.y/e[0].y,this.z/e[0].z):null},i.prototype.DivideED=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return 1!==e.length||("number"==typeof e[0]?(this.x/=e[0],this.y/=e[0],this.z/=e[0]):e[0]instanceof i&&(this.x/=e[0].x,this.y/=e[0].y,this.z/=e[0].z)),this},i.prototype.LengthSquared=function(){return this.x*this.x+this.y*this.y+this.z*this.z},i.prototype.Normalize=function(){var e=this.LengthSquared();if(!n.Equals(e,1)&&0<e){var t=1/Math.sqrt(e);this.x*=t,this.y*=t,this.z*=t}},i.prototype.NormalizeED=function(){var e=this.LengthSquared();if(!n.Equals(e,1)&&0<e){var t=1/Math.sqrt(e);this.x*=t,this.y*=t,this.z*=t}return this},i.prototype.Length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},i.prototype.DotProduct=function(e){return this.x*e.x+this.y*e.y+this.z*e.z},i.prototype.AbsDotProduct=function(e){return Math.abs(this.x*e.x)+Math.abs(this.y*e.y)+Math.abs(this.z*e.z)},i.prototype.CrossProduct=function(e){return new i(this.y*e.z-this.z*e.y,this.z*e.x-this.x*e.z,this.x*e.y-this.y*e.x)},i.prototype.CrossProductFill=function(e,t){t.x=this.y*e.z-this.z*e.y,t.y=this.z*e.x-this.x*e.z,t.z=this.x*e.y-this.y*e.x},i.prototype.CrossProductED=function(e){var t=this.y*e.z-this.z*e.y,r=this.z*e.x-this.x*e.z,i=this.x*e.y-this.y*e.x;return this.x=t,this.y=r,this.z=i,this},i.prototype.Abs=function(){return new i(Math.abs(this.x),Math.abs(this.y),Math.abs(this.z))},i.prototype.AbsED=function(){return this.x<0&&(this.x=-this.x),this.y<0&&(this.y=-this.y),this.z<0&&(this.z=-this.z),this},i.prototype.Lerp=function(e,t){return this.Multiply(1-t).AddED(e.Multiply(t))},i.prototype.LerpED=function(e,t){return this.MultiplyED(1-t).AddED(e.Multiply(t))},i.prototype.Angle=function(e){return n.Acos(this.DotProduct(e)/(this.Length()*e.Length()))},i.prototype.IsZero=function(){return this.LengthSquared()<1e-8},i.prototype.Nagative=function(){return this.Multiply(-1)},i.prototype.NagativeED=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},i.prototype.ToZero=function(){this.copyFrom(i.ZERO())},i.prototype.ToOne=function(){this.copyFrom(i.ONE())},i.prototype.Normalized=function(){var e=this.LengthSquared();if(!n.Equals(e,1)&&0<e){var t=1/Math.sqrt(e);return this.Multiply(t)}return new i(this)},i.prototype.NormalizedED=function(){var e=this.LengthSquared();if(!n.Equals(e,1)&&0<e){var t=1/Math.sqrt(e);return this.MultiplyED(t)}return this},i.prototype.Data=function(){var e=new Float32Array(3);return e[0]=this.x,e[1]=this.y,e[2]=this.z,e},i.prototype.Tostring=function(){return"x:"+this.x.toString()+"  y:"+this.y.toString()+"  Z:"+this.z.toString()},i.prototype.toPlainString=function(){return this.x.toString()+" "+this.y.toString()+" "+this.z.toString()},i.prototype.fromString=function(e){var t=!1,r=e.split(" ");return 3==r.length&&(this.x=parseFloat(r[0]),this.y=parseFloat(r[1]),this.z=parseFloat(r[2]),t=!0),t},i.ZERO=function(){return null==i._ZERO&&(i._ZERO=new i),i._ZERO},i.LEFT=function(){return null==i._LEFT&&(i._LEFT=new i(-1,0,0)),i._LEFT},i.RIGHT=function(){return null==i._RIGHT&&(i._RIGHT=new i(1,0,0)),i._RIGHT},i.UP=function(){return null==i._UP&&(i._UP=new i(0,1,0)),i._UP},i.DOWN=function(){return null==i._DOWN&&(i._DOWN=new i(0,-1,0)),i._DOWN},i.FORWARD=function(){return null==i._FORWARD&&(i._FORWARD=new i(0,0,1)),i._FORWARD},i.BACK=function(){return null==i._BACK&&(i._BACK=new i(0,0,-1)),i._BACK},i.ONE=function(){return null==i._ONE&&(i._ONE=new i(1,1,1)),i._ONE},i.MINIMUM=function(){return null==i._MINIMUM&&(i._MINIMUM=new i(-99999,-99999,-9999)),i._MINIMUM},i.MAXMUN=function(){return null==i._MAXMUN&&(i._MAXMUN=new i(99999,99999,9999)),i._MAXMUN},i.BYTE_SIZE=12,i}();n.Vector3=e}(M3D||(M3D={})),function(n){var e=function(){function i(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=!0;1===e.length?e[0]instanceof i?(r=!1,this.x=e[0].x,this.y=e[0].y,this.z=e[0].z,this.w=e[0].w):e[0]instanceof Float32Array&&4===e[0].length&&(r=!1,this.x=e[0][0],this.y=e[0][1],this.z=e[0][2],this.w=e[0][3]):2===e.length?e[0]instanceof n.Vector3&&"number"==typeof e[1]&&(r=!1,this.x=e[0].x,this.y=e[0].y,this.z=e[0].z,this.w=e[1]):4===e.length&&(r=!1,this.x=e[0],this.y=e[1],this.z=e[2],this.w=e[3]),r&&(this.x=this.y=this.z=this.w=0)}return i.prototype.Clone=function(){return new i(this)},i.prototype.GetVector3=function(){return new n.Vector3(this.x,this.y,this.z)},i.prototype.copyFrom=function(e){this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w},i.prototype.Equals=function(e){return n.Equals(this.x,e.x)&&n.Equals(this.y,e.y)&&n.Equals(this.z,e.z)&&n.Equals(this.w,e.w)},i.prototype.Add=function(e){return new i(this.x+e.x,this.y+e.y,this.z+e.z,this.w+e.w)},i.prototype.AddED=function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this},i.prototype.Sub=function(e){return new i(this.x-e.x,this.y-e.y,this.z-e.z,this.w-e.w)},i.prototype.SubED=function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this},i.prototype.Multiply=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return 1!==e.length?null:"number"==typeof e[0]?new i(this.x*e[0],this.y*e[0],this.z*e[0],this.w*e[0]):e[0]instanceof i?new i(this.x*e[0].x,this.y*e[0].y,this.z*e[0].z,this.w*e[0].w):null},i.prototype.MultiplyED=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return 1!==e.length||("number"==typeof e[0]?(this.x*=e[0],this.y*=e[0],this.z*=e[0],this.w*=e[0]):e[0]instanceof i&&(this.x*=e[0].x,this.y*=e[0].y,this.z*=e[0].z,this.w*=e[0].w)),this},i.prototype.Divide=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return 1!==e.length?null:"number"==typeof e[0]?new i(this.x/e[0],this.y/e[0],this.z/e[0],this.w/e[0]):e[0]instanceof i?new i(this.x/e[0].x,this.y/e[0].y,this.z/e[0].z,this.w/e[0].w):null},i.prototype.DivideED=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return 1!==e.length||("number"==typeof e[0]?(this.x/=e[0],this.y/=e[0],this.z/=e[0],this.w/=e[0]):e[0]instanceof i&&(this.x/=e[0].x,this.y/=e[0].y,this.z/=e[0].z,this.w/=e[0].w)),this},i.prototype.DotProduct=function(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w},i.prototype.AbsDotProduct=function(e){return Math.abs(this.x*e.x)+Math.abs(this.y*e.y)+Math.abs(this.z*e.z)+Math.abs(this.w*e.w)},i.prototype.Abs=function(){return new i(Math.abs(this.x),Math.abs(this.y),Math.abs(this.z),Math.abs(this.w))},i.prototype.AbsED=function(){return this.x<0&&(this.x=-this.x),this.y<0&&(this.y=-this.y),this.z<0&&(this.z=-this.z),this.w<0&&(this.w=-this.w),this},i.prototype.Lerp=function(e,t){return this.Multiply(1-t).AddED(e.Multiply(t))},i.prototype.LerpED=function(e,t){return this.MultiplyED(1-t).AddED(e.Multiply(t))},i.prototype.Data=function(){var e=new Float32Array(4);return e[0]=this.x,e[1]=this.y,e[2]=this.z,e[3]=this.w,e},i.prototype.Tostring=function(){return this.x.toString()+" "+this.y.toString()+this.z.toString()+this.w.toString()},i.ZERO=function(){return null==i._ZERO&&(i._ZERO=new i),i._ZERO},i.ONE=function(){return null==i._ONE&&(i._ONE=new i(1,1,1,1)),i._ONE},i}();n.Vector4=e}(M3D||(M3D={})),function(o){var e=function(){function e(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this.rect=new o.IntRect,0===e.length?this.rect.copyFrom(o.IntRect.ZERO()):e[0]instanceof o.Camera&&e[1]instanceof o.IntRect&&(this.camera=e[0],this.rect.copyFrom(e[1]))}return e.prototype.SetCamera=function(e){this.camera=e},e.prototype.SetRect=function(e){this.rect.copyFrom(e)},e.prototype.GetRect=function(){return this.rect},e.prototype.GetCamera=function(){return this.camera},e.prototype.GetScreenRay=function(e,t){if(!this.camera)return new o.Ray;var r=0,i=0;return this.rect.Equal(o.IntRect.ZERO())||(r=(e-this.rect.left)/this.rect.Width(),i=(t-this.rect.top)/this.rect.Height()),this.camera.GetScreenRay(r,i)},e.prototype.WorldToScreenPoint=function(e){if(!this.camera)return new o.Vector2(o.Vector2.ZERO());var t=this.camera.WorldToScreenPoint(e),r=0,i=0;return this.rect.Equal(o.IntRect.ZERO())||(r=this.rect.left+t.x*this.rect.Width(),i=this.rect.top+t.y*this.rect.Height()),new o.Vector2(r,i)},e.prototype.ScreenToWorldPoint=function(e,t,r){if(!this.camera)return o.Vector3.ZERO().Clone();var i=0,n=0;return this.rect.Equal(o.IntRect.ZERO())||(i=(e-this.rect.left)/this.rect.Width(),n=(t-this.rect.top)/this.rect.Height()),this.camera.ScreenToWorldPoint(new o.Vector3(i,n,r))},e.prototype.Clone=function(){return null},e}();o.Viewport=e}(M3D||(M3D={})),function(t){var r,e;(e=r=t.ShapeType||(t.ShapeType={}))[e.SHAPE_FEATURE_COORDINATE=-2]="SHAPE_FEATURE_COORDINATE",e[e.SHAPE_COORDINATE=-1]="SHAPE_COORDINATE",e[e.SHAPE_POINT=0]="SHAPE_POINT",e[e.SHAPE_EDGE=1]="SHAPE_EDGE",e[e.SHAPE_FACE=2]="SHAPE_FACE",e[e.SHAPE_BODY=3]="SHAPE_BODY",e[e.SHAPE_MODEL=4]="SHAPE_MODEL",e[e.SHAPE_NOTE=5]="SHAPE_NOTE",e[e.CURVE_UNKNOWN=6]="CURVE_UNKNOWN",e[e.CURVE_POLYLINE=7]="CURVE_POLYLINE",e[e.CURVE_ELLIPSE=8]="CURVE_ELLIPSE",e[e.CURVE_LINE=9]="CURVE_LINE",e[e.CURVE_NURBSCURVE=10]="CURVE_NURBSCURVE",e[e.CURVE_HYPERBOLA=11]="CURVE_HYPERBOLA",e[e.CURVE_PARABOLA=12]="CURVE_PARABOLA",e[e.CURVE_REF_POLYLINE=13]="CURVE_REF_POLYLINE",e[e.SHAPE_GEOMETRY=14]="SHAPE_GEOMETRY",e[e.SHAPE_TRIMESH=20]="SHAPE_TRIMESH",e[e.SHAPE_REF_TRIMESH=21]="SHAPE_REF_TRIMESH",e[e.SHAPE_POLYLINE=22]="SHAPE_POLYLINE",e[e.SHAPE_REF_POLYLINE=23]="SHAPE_REF_POLYLINE",e[e.SHAPE_BILLBOARD=25]="SHAPE_BILLBOARD",e[e.SHAPE_ATTRIBUTE_NOTE=30]="SHAPE_ATTRIBUTE_NOTE",e[e.SHAPE_MEASURE_BASE=50]="SHAPE_MEASURE_BASE",e[e.SHAPE_MEASURE_DISTANCE=51]="SHAPE_MEASURE_DISTANCE",e[e.SHAPE_MEASURE_ANGLE=52]="SHAPE_MEASURE_ANGLE",e[e.SHAPE_MEASURE_PROPERTY=53]="SHAPE_MEASURE_PROPERTY",e[e.SHAPE_MEASURE_DIAMETRE=54]="SHAPE_MEASURE_DIAMETRE",e[e.SHAPE_MEASURE_PNT_PNT_LENGTH=53]="SHAPE_MEASURE_PNT_PNT_LENGTH",e[e.SHAPE_MEASURE_PNT_LINE_LENGTH=54]="SHAPE_MEASURE_PNT_LINE_LENGTH",e[e.SHAPE_MEASURE_PNT_FACE_LENGTH=55]="SHAPE_MEASURE_PNT_FACE_LENGTH",e[e.SHAPE_IMAGE_MODEL=56]="SHAPE_IMAGE_MODEL",e[e.SHAPE_LIGHT_BASE=70]="SHAPE_LIGHT_BASE",e[e.SHAPE_LIGHT_DIRECTIONAL=71]="SHAPE_LIGHT_DIRECTIONAL",e[e.SHAPE_LIGHT_SPOT=72]="SHAPE_LIGHT_SPOT",e[e.SHAPE_LIGHT_POINT=73]="SHAPE_LIGHT_POINT",e[e.SHAPE_LITTLE_FACE=80]="SHAPE_LITTLE_FACE",e[e.SHAPE_NOTE_BASE=200]="SHAPE_NOTE_BASE",e[e.SHAPE_VOICE_NOTE=201]="SHAPE_VOICE_NOTE",e[e.SHAPE_TEXT_NOTE=202]="SHAPE_TEXT_NOTE",e[e.SHAPE_SEQUENCE_NUMBER_NOTE=203]="SHAPE_SEQUENCE_NUMBER_NOTE",e[e.SHAPE_THREED_GESTURE_NOTE=204]="SHAPE_THREED_GESTURE_NOTE",e[e.SHAPE_ANNOTATION_NOTE=205]="SHAPE_ANNOTATION_NOTE",e[e.SHAPE_COMPONENTNAME_NOTE=206]="SHAPE_COMPONENTNAME_NOTE",e[e.SHAPE_COMMON_NOTE=299]="SHAPE_COMMON_NOTE",e[e.SHAPE_HANDLE=300]="SHAPE_HANDLE",e[e.SHAPE_POINT_HANDLE=301]="SHAPE_POINT_HANDLE",e[e.SHAPE_PLANE_HANDLE=302]="SHAPE_PLANE_HANDLE",e[e.SHAPE_AXIS_HANDLE=303]="SHAPE_AXIS_HANDLE",e[e.SHAPE_ROTATE_HANDLE=304]="SHAPE_ROTATE_HANDLE",e[e.SHAPE_SCALE_HANDLE=305]="SHAPE_SCALE_HANDLE",e[e.SHAPE_ROTATECENTER=305]="SHAPE_ROTATECENTER",e[e.SHAPE_BASE=1e3]="SHAPE_BASE",e[e.SHAPE_Collection=1001]="SHAPE_Collection",e[e.MODEL_SHAPE=401]="MODEL_SHAPE",e[e.IMAGEMODEL_SHAPE=402]="IMAGEMODEL_SHAPE",e[e.LINEMODEL_SHAPE=403]="LINEMODEL_SHAPE",e[e.SHAPE_NOTCONTAIN_IMAGEMODEL=404]="SHAPE_NOTCONTAIN_IMAGEMODEL",e[e.VIRTUAL_GROUP=501]="VIRTUAL_GROUP",e[e.SHAPE_SCANNINGBODY=502]="SHAPE_SCANNINGBODY";var i=function(){function e(){this.node=null,this.Color=new t.Color,this.initColor=new t.Color(.8,.8,.8,1),this.BoundingBox=new t.BoundingBox,this.IsSelect=!1,this.selectAble=!0,this.Visible=!0,this.type=r.SHAPE_BASE,this.IsSetSelectColor=!1,this.frontShow=!1,this.copyId=-1,this.allowExcluding=!0,this.Init()}return e.prototype.Init=function(){this.Visible=!0,this.IsSelect=!1,this.node=null,this.Id=e.BASEID++,this.IsFirstGetProperties=!0,this.allowExcluding=!0,this.properties=""},e.prototype.Traverse=function(e){},e.prototype.FindVisiableObject=function(e){},e.prototype.GetType=function(){return this.type},e.prototype.SetType=function(e){this.type=e},e.prototype.RayPick=function(e){},e.prototype.SetVisible=function(e){this.Visible=e},e.prototype.IsVisible=function(){return this.Visible},e.prototype.GetVisible=function(){return this.Visible},e.prototype.IsSelected=function(){return this.IsSelect},e.prototype.GetSelectAble=function(){return this.selectAble},e.prototype.SetSelectAble=function(e){this.selectAble=e},e.prototype.SetSelected=function(e){this.IsSelect=e},e.prototype.GetID=function(){return this.Id},e.prototype.SetID=function(e){this.Id=e},e.prototype.GetName=function(){return this.Name},e.prototype.SetName=function(e){this.Name=e},e.prototype.GetDrawColor=function(){return this.IsSelected()?this.IsSetSelectColor?this.selectColor:t.Color.SelectColor():this.Color},e.prototype.SetSelectColor=function(e){this.selectColor=e.Clone(),this.IsSetSelectColor=!0},e.prototype.GetSelectColor=function(){return this.selectColor},e.prototype.ResetAlpha=function(){this.SetAlpha(this.initColor.a)},e.prototype.GetInitColor=function(){return this.initColor},e.prototype.SetInitColor=function(e){this.initColor=e.Clone(),this.Color=this.initColor.Clone()},e.prototype.ResetColor=function(){this.Color=this.initColor.Clone()},e.prototype.SetColor=function(e){this.Color=e.Clone()},e.prototype.SetAlpha=function(e){this.Color.a=e},e.prototype.GetColor=function(){return this.Color},e.prototype.GetAlpha=function(){return this.Color.a},e.prototype.SetSceneNode=function(e){this.node=e},e.prototype.GetSceneNode=function(){return this.node},e.prototype.ComputeBox=function(){},e.prototype.SetBox=function(e){this.BoundingBox=e.Clone()},e.prototype.GetBoundingBox=function(){return this.BoundingBox.Defined()||this.ComputeBox(),this.BoundingBox},e.prototype.AssignOperator=function(e){this!==e&&(this.Visible=e.Visible,this.IsSelect=e.IsSelect,this.Color=e.Color.Clone(),this.initColor=e.initColor.Clone(),this.node=null,this.IsFirstGetProperties=e.IsFirstGetProperties,this.properties=e.properties,this.SetType(e.GetType()),this.copyId=e.copyId)},e.prototype.AllowExculding=function(){return this.allowExcluding},e.prototype.SetAlloewExculding=function(e){this.allowExcluding=e},e.prototype.IsFrontShow=function(){return this.frontShow},e.prototype.GetProperties=function(){return this.IsFirstGetProperties&&(this.InitProperties(),this.IsFirstGetProperties=!1),this.properties},e.prototype.GetProperty=function(e){},e.prototype.InitProperties=function(){},e.prototype.AddProperty=function(e,t){0<=this.properties.indexOf(e+"::")||(0!=this.properties.length&&(this.properties+=";;"),this.properties=this.properties+(e+"::")+t)},e.prototype.ClearProperties=function(){this.properties=""},e.prototype.SetFrontShow=function(e){this.frontShow=e},e.prototype.FramePick=function(e){},e.prototype.SetInitHightlight=function(e){this.m_isHighlight=e},e.prototype.IsHightlight=function(){return this.IsSelect||this.m_isHighlight},e.BASEID=0,e}();t.Shape=i}(M3D||(M3D={})),function(p){var e;(e=p.NoteType||(p.NoteType={}))[e.Undefine=-1]="Undefine",e[e.TextNote=0]="TextNote",e[e.VoiceNote=1]="VoiceNote",e[e.VidioNote=2]="VidioNote",e[e.GestureNote=3]="GestureNote",e[e.ImageNote=4]="ImageNote",e[e.ThreeDGestureNote=5]="ThreeDGestureNote";var t=function(r){function e(){var e=r.call(this)||this;return e.renderWorldMatrix=new p.Matrix4,e.PointList=[],e.LineList=[],e.PolyLineList=[],e.ComTexts=[],e.imageBoardList=[],e.isParallelScreen=!1,e.isFix=!1,e.drawPoints=[],e.drawLines=[],e.isDirty=!0,e.hasLeader=!1,e.bindBillboard=new p.Billboard,e}return __extends(e,r),e.prototype.SetRenderWorldMatrix=function(e){this.renderWorldMatrix=e.Clone()},e.prototype.GetRenderWorldMatrix=function(){return this.renderWorldMatrix},e.prototype.GetRenderColor=function(){return p.Color.Default().Clone()},e.prototype.GetRenderMaterial=function(){return null},e.prototype.SetRenderMesh=function(e){},e.prototype.GetDataLength=function(){return-1},e.prototype.IsUseIndex=function(){return!1},e.prototype.SetIndexOffset=function(e){},e.prototype.GetIndexOffset=function(){return-1},e.prototype.SetNormalOffset=function(e){},e.prototype.GetNormalOffset=function(){return-1},e.prototype.SetVertexOffset=function(e){},e.prototype.GetVertexOffset=function(){return-1},e.prototype.SetTextureCoordsOffset=function(e){},e.prototype.GetTextureCoordsOffset=function(){return-1},e.prototype.SetCentersCoordsOffset=function(e){},e.prototype.GetCentersCoordsOffset=function(){return-1},e.prototype.GetHardWareVertexBuffer=function(){return null},e.prototype.GetHardWareIndexBuffer=function(){return null},e.prototype.AddPoint=function(e){this.PointList.push(e)},e.prototype.AddLine=function(e){this.LineList.push(e)},e.prototype.AddPolyLine=function(e){this.PolyLineList.push(e)},e.prototype.AddImage=function(e){null!=e&&null!=e&&this.imageBoardList.push(e)},e.prototype.AddText=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(1===e.length&&e[0]instanceof p.ComText)this.ComTexts.push(e[0]),this.MarkDirty();else{var r=new p.ComText,i=new p.CText;i.SetText(e[0]),i.SetInnerLoc(e[1]);var n=new p.Vector3,o=new p.Vector3;n.x=0,n.y=0,n.z=0,i.SetInnerXYAxis(n,o),i.SetCharWidthHeight(e[2],e[2]),r.AddCText(i),this.AddText(r),this.MarkDirty()}},e.prototype.SetSelected=function(e){r.prototype.SetSelected.call(this,e);for(var t=0;t<this.imageBoardList.length;t++)this.imageBoardList[t]&&this.imageBoardList[t].SetSelected(e);for(t=0;t<this.LineList.length;t++)this.LineList[t]&&this.LineList[t].SetSelected(e);for(t=0;t<this.PolyLineList.length;t++)this.PolyLineList[t]&&this.PolyLineList[t].SetSelected(e)},e.prototype.RayPick=function(e){if(this.IsVisible()&&e.CanPickShape(this.GetType())){var t=new p.Vector3,r=e.GetData().GetModelRay().Clone(),i=this.bindBillboard.GetWorldMatrix().Inverse();if(r=r.Transformed(i),0===this.imageBoardList.length){for(var n=0;n<this.ComTexts.length;n++){var o=this.ComTexts[n].GetBoundingBox();p.RayPickAction.IsRayHitBox(r,o)&&(t=this.bindBillboard.GetWorldMatrix().Multiply(t),e.AddIntersectPnt(t))}for(n=0;n<this.LineList.length;n++){var a=this.LineList[n],s=a.StartPoint,l=a.EndPoint;if(e.Intersect(s,l,t)){e.AddIntersectPnt(t);break}}}for(n=0;n<this.imageBoardList.length;n++)if(null!==this.imageBoardList[n]&&void 0!==this.imageBoardList[n]){var h=this.imageBoardList[n].GetIntersects(e);if(0<h.length)for(var u=0;u<h.length;u++)e.AddIntersectPnt(h[u])}e.AddShape(this)}},e.prototype.SetVisiableObject=function(e){if(this.IsVisible()){this.SetRenderWorldMatrix(e.GetGLWorldMatrix());for(var t=0;t<this.PointList.length;t++)this.PointList[t].UpdateRenderData(e);this.IsDirty()&&0==this.imageBoardList.length&&(this.isDirty=!1,this.bindBillboard.SetCenter(this.GetTextsCenter())),this.bindBillboard.GetGLWorldMatrix(e);for(t=0;t<this.imageBoardList.length;t++)this.imageBoardList[t]&&this.imageBoardList[t].UpdateRenderData(e)}},e.prototype.ComputeBox=function(){this.BoundingBox=new p.BoundingBox(p.Vector3.MINIMUM().Clone(),p.Vector3.MAXMUN().Clone())},e.prototype.FindVisiableObject=function(e){if(this.IsVisible()){this.SetRenderWorldMatrix(e.GetGLWorldMatrix());for(var t=0;t<this.PointList.length;t++)this.PointList[t].UpdateRenderData(e);this.IsDirty()&&0===this.imageBoardList.length&&(this.isDirty=!1),this.bindBillboard.GetGLWorldMatrix(e);for(t=0;t<this.imageBoardList.length;t++)null!==this.imageBoardList[t]&&void 0!==this.imageBoardList[t]&&this.imageBoardList[t].UpdateRenderData(e);e.PrepareRenderNote(this)}},e.prototype.IsDirty=function(){return this.isDirty},e.prototype.MarkDirty=function(){this.isDirty=!0},e.prototype.IsFix=function(){return this.isFix},e.prototype.SetFix=function(e){this.isFix=e},e.prototype.IsParallelScreen=function(){return this.isParallelScreen},e.prototype.SetParallelScreen=function(e){this.isParallelScreen=e},e.prototype.GetAnchorPnt=function(){},e.prototype.HasLeader=function(){return this.hasLeader},e.prototype.SetHasLeader=function(e){this.hasLeader=e},e.prototype.GetBillBoard=function(){return this.bindBillboard},e.prototype.GetImageBoards=function(){return this.imageBoardList},e.prototype.GetTextValue=function(){var e="";if(0<this.ComTexts.length){var t=this.ComTexts[0];if(0<t.GetCTextList().length)e=t.GetCText(0).GetText()}return e},e.prototype.SetTextValue=function(e){if(0<this.ComTexts.length){var t=this.ComTexts[0];(r=new p.CText).SetText(e),t.AddCText(r)}else{var r,i=new p.ComText;(r=new p.CText).SetText(e),i.AddCText(r),this.ComTexts.push(i)}},e.prototype.Clear=function(){this.PointList=[],this.LineList=[],this.PolyLineList=[],this.ComTexts=[],this.imageBoardList=[]},e.prototype.InitNote=function(){this.SetAlloewExculding(!1),this.Color=p.Parameters.Instance().DefaultNoteColornew.Clone(),this.SetType(p.ShapeType.SHAPE_NOTE),this.bindBillboard.AllowRotate(!1),this.bindBillboard.AllowTran(!0),this.bindBillboard.AllowScale(!1),this.isDirty=!0},e.prototype.GetTextsCenter=function(){for(var e=new p.BoundingBox,t=0;t<this.ComTexts.length;t++){var r=this.ComTexts[t];e.Merge(r.GetBoundingBox())}return e.min},e}(p.Shape);p.Note=t}(M3D||(M3D={})),function(S){var e=function(t){function e(){var e=t.call(this)||this;return e.m_bLeaderLine=!1,e.m_bStub=!1,e.m_bEnvelope=!1,e.m_bFixed=!1,e.m_fgap=0,e.m_CreateID=e.Id,e.SetType(S.ShapeType.SHAPE_ANNOTATION_NOTE),e}return __extends(e,t),e.prototype.FindVisiableObject=function(e){this.SetVisiableObject(e),this.IsVisible()&&(S.AnnotationFactory.ModifyPntAnnotation(this,e),e.PrepareRenderAnnotation(this))},e.prototype.GetAnnotationPos=function(){return this.m_annotationPos},e.prototype.SetAnnotationPos=function(e){this.m_annotationPos=e.Clone()},e.prototype.GetTextsPos=function(){return this.m_textPos},e.prototype.SetTextsPos=function(e){this.m_textPos=e.Clone()},e.prototype.GetBroadPos=function(){return this.m_BroadPos},e.prototype.SetBroadPos=function(e){this.m_BroadPos=e},e.prototype.GetCenterPos=function(){return this.m_centerPos},e.prototype.SetCenterPos=function(e){this.m_centerPos=e.Clone()},e.prototype.GetOutFrameMatrix=function(){return this.m_outFrameMatrix},e.prototype.GetTextMatrix=function(){return this.m_textMatrix},e.prototype.GetHaveStub=function(){return this.m_bStub},e.prototype.SetHaveStub=function(e){this.m_bStub=e},e.prototype.GetHaveEnvelope=function(){return this.m_bEnvelope},e.prototype.SetHaveEnvelope=function(e){this.m_bEnvelope=e},e.prototype.GetHaveLeaderLine=function(){return this.m_bLeaderLine},e.prototype.SetHaveLeaderLine=function(e){this.m_bLeaderLine=e},e.prototype.GetFixed=function(){return this.isFix},e.prototype.SetFixed=function(e){this.isFix=e},e.prototype.getText=function(){return this.m_textValue},e.prototype.SetText=function(e){this.m_textValue=e},e.prototype.GetPosAverage=function(){return this.m_fTextPos},e.prototype.SetPosAverage=function(e){this.m_fTextPos=e},e.prototype.GetGap=function(){return this.m_fgap},e.prototype.SetGap=function(e){this.m_fgap=e},e.prototype.GetWorldMatrix=function(e,t,r,i,n,o){var a=S.Matrix3x4.IDENTITY();if(a.MultiTranslate(r),!o){var s=this.GetComTextsBox().GetYLength(),l=new S.Vector2(.5/s,.5/s),h=(l=S.ShapeHelper.GetCommonSize(t.GetScene(),l)).y,u=t.GetCamera();if(!u.IsOrthographic()){var p=u.GetWorldPosition(),c=u.GetOrthoSize().y;h=2*p.Sub(r).Length()/c}a.MultiScale(h/u.GetZoom())}if(!n){var d=e.Rotation();a.MultiRotatiton(d);d.RollAngle(),d.RollAngle()}return i||a.MultiTranslate(e.Translation().Nagative()),a.MultiTranslate(r.Nagative()),a},e.prototype.SetFillColor=function(e){this.m_FillColor=e.Clone()},e.prototype.GetFillColor=function(){return this.m_FillColor},e.prototype.SetFrameColor=function(e){this.m_FrameColor=e.Clone()},e.prototype.GetFrameColor=function(){return this.m_FrameColor},e.prototype.GetCreateID=function(){return this.m_CreateID},e.prototype.SetCreateID=function(e){this.m_CreateID=e},e.prototype.GetComTextsBox=function(){for(var e=new S.BoundingBox,t=0;t<this.ComTexts.length;t++){var r=this.ComTexts[t];r&&e.Merge(r.GetBoundingBox())}return e},e}(S.Note);S.Annotation=e}(M3D||(M3D={})),function(b){var e=function(){function T(){}return T.CreateAnnotation=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(e[0]instanceof b.Annotation){var r=e[0],i=e[1],n=e[2],o=e[3];if(e[4]instanceof b.SceneManager){var a=e[4],s=!1;return s=this.CreatePntAnnotation(r,i,n,o,e[4])}var l=e[4],h=e[5],u=e[6],p=e[7];a=e[8],s=!1;return s=this.CreatePntAnnotation(r,i,n,o,l,h,u,p,a),r&&s&&this.AddNoteToScene(a,r),s}var c=e[0],d=e[1],S=e[2],f=(i=e[3],n=e[4],o=e[5],l=e[6],h=e[7],u=e[8],p=e[9],a=e[10],e[11]),m=null;return(m=this.CreatePntAnnotation(c,d,S,i,n,o,l,h,u,p,a)).SetType(f),m&&this.AddNoteToScene(a,m),m},T.CreatePntAnnotation=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(11===e.length){var r=e[0],i=e[1],n=e[2],o=e[3],a=e[4],s=e[5],l=e[6],h=e[7],u=e[8],p=e[9],c=e[10];(w=new b.Annotation).SetText(o);var d=new b.Vector3,S=new b.Vector3,f=(new b.Vector3,new b.Vector3),m=c.GetShape(r);if(m&&m.GetType()==b.ShapeType.SHAPE_POINT_HANDLE)d=m.GetPosition(),w.SetAnnotationPos(d),w.SetTextsPos(d),f=d;else c.GetPickPoint(i,d,!1)&&(w.SetAnnotationPos(d),w.SetTextsPos(d),f=d);if(l&&c.GetPickPoint(n,S,!1)&&(w.SetCenterPos(S),w.SetTextsPos(S),w.SetHaveLeaderLine(!0),f=S),u&&w.SetHaveStub(!0),l){var y=new b.Color(.03,.38,.73);(x=new b.Line3D(d,S)).SetColor(y),x.SetName("LenderLine"),w.AddLine(x)}var T=[];(L=new b.Texts2D).setSize(12),L.setTexts(o),T.push(L);var M=null,g=void 0,v=new b.Vector2,C=new b.Vector2,_=0;M=(N=b.AnnotationDisplayHelper.GetAnnotationTextRectInfo(c,T,M,g,v,C,_))[0],g=N[1],_=N[4];var A=(C.x-v.x)/4;w.SetPosAverage(A),w.SetFillColor(s),w.SetFrameColor(a),w.SetFixed(p);var E=null;h?(w.SetHaveEnvelope(!0),b.AnnotationDisplayHelper.createAnnotationImage(c,w,E,M,g,_,v,C,a,s,f)):b.AnnotationDisplayHelper.createAnnotation(c,w,E,M,g,_,v,C,f);for(var G=0;G<T.length;G++)delete T[G];T=[];var P=new b.ComText;return(I=new b.CText).SetText(o),P.AddCText(I),w.ComTexts.push(P),w.SetFrontShow(!0),w}if(9===e.length){var w=e[0],D=(o=e[1],a=e[2],s=e[3],l=e[4],h=e[5],u=e[6],p=e[7],c=e[8],!1);if(null==w)return D;w.SetText(o);d=new b.Vector3,S=new b.Vector3,f=new b.Vector3;if(l){w.SetHaveLeaderLine(!0),d=w.GetAnnotationPos(),S=w.GetCenterPos();var x;y=new b.Color(.03,.38,.73);(x=new b.Line3D(d,S)).SetColor(y),x.SetName("LenderLine"),w.AddLine(x)}f=w.GetAnnotationPos(),u&&w.SetHaveStub(!0);T=[];(L=new b.Texts2D).setSize(12),L.setTexts(o),T.push(L);M=void 0,g=void 0,v=new b.Vector2,C=new b.Vector2,_=0;M=(N=b.AnnotationDisplayHelper.GetAnnotationTextRectInfo(c,T,M,g,v,C,_))[0],g=N[1],_=N[4];A=(C.x-v.x)/4;w.SetPosAverage(A),w.SetFillColor(s),w.SetFrameColor(a);E=null;h?(w.SetHaveEnvelope(!0),b.AnnotationDisplayHelper.createAnnotationImage(c,w,E,M,g,_,v,C,a,s,f)):b.AnnotationDisplayHelper.createAnnotation(c,w,E,M,g,_,v,C,f);for(var R=0;R<T.length;R++)delete T[R];T=[];var I;P=new b.ComText;return(I=new b.CText).SetText(o),P.AddCText(I),w.ComTexts.push(P),w.SetFixed(p),w.SetFrontShow(!0),D=!0}if(5===e.length){w=e[0],o=e[1],a=e[2],s=e[3],c=e[4],D=!1;if(null==w)return D;w.SetText(o);var L;T=[];(L=new b.Texts2D).setSize(12),L.setTexts(o),T.push(L);var N;M=void 0,g=void 0,v=new b.Vector2,C=new b.Vector2,_=0,f=w.GetAnnotationPos();M=(N=b.AnnotationDisplayHelper.GetAnnotationTextRectInfo(c,T,M,g,v,C,_))[0],g=N[1],_=N[4];A=(C.x-v.x)/4;w.SetPosAverage(A),w.SetFillColor(s),w.SetFrameColor(a);E=null;w.GetHaveEnvelope()?b.AnnotationDisplayHelper.createAnnotationImage(c,w,E,M,g,_,v,C,a,s,f):b.AnnotationDisplayHelper.createAnnotation(c,w,E,M,g,_,v,C,f);for(var O=0;O<T.length;O++)delete T[O];return T=[],M=o,w.SetTextValue(M),D=!0}},T.CreateAnnotationNumber=function(e,t,r,i){var n;return(n=this.createPntAnnotationNumber(e,t,r,i))&&this.AddNoteToScene(i,n),n},T.createPntAnnotationNumber=function(e,t,r,i){var n=null,o=i.GetShape(e);if(o&&o.GetType()==b.ShapeType.SHAPE_POINT_HANDLE){n=new b.AnnotationNumber;var a=o.GetPosition();n.SetNotePos(a);var s=new b.Vector3;if(i.GetPickPoint(t,s,!1)){var l=r,h=(i.GetSceneBox().Length(),new b.Point(a));h.SetDrawType(1),h.SetSize(.8);var u=new b.Point(s);u.SetDrawType(1),u.SetSize(.8);var p=i.GetCamera().GetViewPort().GetScreenRay(t.x,t.y),c=new b.Plane(p.GetDirection(),a).Project(s),d=new b.Line3D(a,c),S=new b.Color(.03,.38,.73);d.SetColor(S),d.SetName("SequenceNumberImageLeader"),n.SetTextPos(c);var f=new b.Texts2D;f.setSize(14),f.setTexts(l);var m=[];m.push(f);var y=null,T=void 0,M=new b.Vector2,g=new b.Vector2,v=0,C=b.AnnotationDisplayHelper.GetAnnotationTextRectInfo(i,m,y,T,M,g,v);y=C[0],T=C[1],v=C[4];var _=(g.x-M.x)/4;n.SetPosAverage(_);var A=new b.Color(.15,.15,.15),E=new b.Color(.03,.38,.73);n.SetFillColor(A),n.SetFrameColor(E),b.AnnotationDisplayHelper.createAnnotationImage(i,n,null,y,T,v,M,g,E,A,c),n.AddLine(d),n.AddImage(null),n.AddPoint(h);var G=new b.ComText,P=new b.CText;P.SetText(r),G.AddCText(P),n.ComTexts.push(G),n.SetFrontShow(!0)}}return n},T.ModifyPntAnnotation=function(e,t){if(!e||e.GetHaveLeaderLine()){var r=t.GetCamera(),i=t.GetScene(),n=r.GetViewPort().GetRect(),o=n.right,a=n.bottom,s=e.GetAnnotationPos(),l=e.GetCenterPos(),h=new b.Vector3,u=r.WorldToScreenPoint(s),p=r.WorldToScreenPoint(l);u.x*=o,u.y*=a,p.x*=o,p.y*=a;var c,d=new b.Vector2,S=new b.Vector2;if(u.x<=p.x?e.GetHaveStub()?((d=p).x+=25,S=d):(S=p).x+=5:e.GetHaveStub()?((d=p).x-=25,S=d):(S=p).x-=5,e.GetHaveLeaderLine())if(0<e.LineList.length)e.LineList[0].EndPoint=l;if(e.GetHaveStub()){var f=new b.Vector3;f=i.GetCamera().GetViewPort().ScreenToWorldPoint(d.x,d.y,.5);var m=null;if(1<e.LineList.length)(m=e.LineList[1]).StartPoint=l,m.EndPoint=f;else{m=new b.Line3D(l,f);var y=new b.Color(.03,.38,.73);m.SetColor(y),m.SetName("parallelLines"),e.AddLine(m)}}c=.425*e.GetPosAverage(),u.x<=p.x?S.x+=c:S.x-=c,h=i.GetCamera().GetViewPort().ScreenToWorldPoint(S.x,S.y,.5),e.SetTextsPos(h),T.UpdateAnnotationImagePos(e,S,i)}},T.UpdateAnnotationImagePos=function(e,t,r){if(null!=e&&null!=r)for(var i=e.GetImageBoards(),n=0;n<i.length;n++){var o=i[n];if(o){var a=o.GetPosition(),s=r.GetCamera().GetViewPort().GetScreenRay(t.x,t.y);a=new b.Plane(s.GetDirection(),a).Project(s.GetOrigin()),o.SetPosition(a)}}return!1},T.AddNoteToScene=function(e,t){var r=!1;if(null==e||null==t)return r;var i=e.GetAnnotationGroup(),n=new b.ShapeNode;n.SetShape(t),n.SetName(i.GetName()+"|"+n.GetID()),i.AddChild(n);var o=t;return i.AddAnnotationId(o),e.AddShapeIDToMap(t),e.GetRenderManager().RequestRedraw(),r=!0},T.calculateGap=function(e,t,r){if(null==e)return 0;var i=new b.Vector3,n=r.GetCamera(),o=n.GetViewPort().GetRect().right;i=e.GetHaveLeaderLine()?e.GetCenterPos():e.GetAnnotationPos();var a=n.WorldToScreenPoint(i);return a.x*=o,t-a.x},T.UpdateNoteImagePos=function(e,t,r){if(!e)return!1;var i=e;if(null==i||i.GetFixed())return!1;var n=r.GetCamera().GetViewPort().GetRect(),o=(n.right,n.bottom,new b.Vector3),a=new b.Vector3,s=new b.Vector2,l=new b.Vector2;if(i.GetHaveLeaderLine()){(l=t).x-=i.GetGap(),a=i.GetCenterPos();var h=r.GetCamera().GetViewPort().GetScreenRay(l.x,l.y);a=new b.Plane(h.GetDirection(),a).Project(h.GetOrigin()),i.SetCenterPos(a)}else{(s=t).x-=i.GetGap(),o=i.GetAnnotationPos();h=r.GetCamera().GetViewPort().GetScreenRay(s.x,s.y);o=new b.Plane(h.GetDirection(),o).Project(h.GetOrigin()),i.SetAnnotationPos(o),T.UpdateAnnotationImagePos(i,s,r)}return!1},T.CreateTmpPoint=function(e,t,r){var i=new b.Vector3,n=null,o=0,a=r.GetShape(t);a&&a.GetType()==b.ShapeType.SHAPE_POINT_HANDLE?i=a.GetPosition():r.GetPickPoint(e,i,!1);return(n=b.ShapeHelper.AddPointHandler(i,1,r))&&(o=n.GetID()),o},T.UpdateAnnotationTextValue=function(e,t,r){this.CreateAnnotation(e,t,b.Color.BLACK(),b.Color.WHITE(),r)},T}();b.AnnotationFactory=e}(M3D||(M3D={})),function(r){var e=function(t){function e(){var e=t.call(this)||this;return e.textPos=new r.Vector3,e.notePos=new r.Vector3,e.InitAnnotationDistance(),e}return __extends(e,t),e.prototype.InitAnnotationDistance=function(){this.SetType(r.ShapeType.SHAPE_SEQUENCE_NUMBER_NOTE)},e.prototype.SetTextPos=function(e){this.textPos=e},e.prototype.GetTextPos=function(){return this.textPos},e.prototype.SetNotePos=function(e){this.notePos=e},e.prototype.GetNotePos=function(){return this.notePos},e}(r.Annotation);r.AnnotationNumber=e}(M3D||(M3D={})),function(_){var e=function(){function T(){}return T.createAnnotationImage=function(a,s,l,e,t,r,i,n,o,h,u){var p=a.GetGlueObj(),c=new _.Shape2DSet,d=(_.Color.BLACK(),_.Color.GRAY(),_.Color.WHITE(),new _.Color(1,0,0)),S=new _.Color(o),f=new _.Color(h);d=_.Parameters.Instance().m_annotationDisplayColor,T.CreateAnnotationRectangleImage(c,i,n,S,4,f,d,t,r,e);var m=n.x/100,y=2.5*t/100;if(p){p.CreateImage(c,function(e){var t=null;t=e instanceof Blob?URL.createObjectURL(e):e;var r=_.IDCreator.GetUUID(32,16),i=new _.Vector2(m,y);i=_.ShapeHelper.GetCommonSize(a,i),(l=new _.ImageBoard(u,i)).m_fixShowInScreen=!0;var n=a.GetResourceManager().GetOrCreateTexture(r),o=a.GetResourceManager().GetImage(r);null===o&&(o=a.GetResourceManager().GetOrCreateImage(r,t)),n.AddImage(o),l.SetTexture(n),l.SetCurrentGLContext(a.GetResourceManager().GetRenderContext()),s.imageBoardList.splice(0,1),l.SetFrontShow(!0),s.AddImage(l)})}return l},T.CreateAnnotationRectangleImage=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(10===e.length){var r=e[0],i=e[1],n=e[2],o=e[3],a=e[4],s=e[5],l=e[6],h=e[7],u=(e[8],e[9]);"IE"===SView.BrowserHelper.myBrowser()&&(o=new _.Color(o.r,o.g,o.b),s=new _.Color(s.r,s.g,s.b,s.a),l=new _.Color(l.r,l.g,l.b));var p=i.x,c=i.y,d=n.x,S=n.y,f=a/2;if(!s.Equals(new _.Color(0,0,0,0)))(v=new _.Rect2D).setColor(s),v.setStart(i),v.setEnd(n),r.addShape(v);(C=new _.Texts2D).setColor(l);var m=new _.Vector2(p+h/2,(c+S)/2+h/3);C.setStart(m),C.setSize(h),C.setTexts(u),r.addShape(C);var y=new _.Line2D;y.setBlod(a),y.setStart(new _.Vector2(p+f,c)),y.setEnd(new _.Vector2(p+f,S)),y.setColor(o),r.addShape(y);var T=new _.Line2D;T.setBlod(a),T.setStart(new _.Vector2(p,c+f)),T.setEnd(new _.Vector2(d,c+f)),T.setColor(o),r.addShape(T);var M=new _.Line2D;M.setBlod(a),M.setStart(new _.Vector2(p,S-f)),M.setEnd(new _.Vector2(d,S-f)),M.setColor(o),r.addShape(M);var g=new _.Line2D;g.setBlod(a),g.setStart(new _.Vector2(d-f,c)),g.setEnd(new _.Vector2(d-f,S)),g.setColor(o),r.addShape(g)}else{var v,C;r=e[0],i=e[1],n=e[2],s=e[3],l=e[4],h=e[5],e[6],u=e[7],p=i.x,c=i.y,d=n.x,S=n.y;"IE"===SView.BrowserHelper.myBrowser()&&(s=new _.Color(s.r,s.g,s.b,s.a),l=new _.Color(l.r,l.g,l.b)),(v=new _.Rect2D).setColor(s),v.setStart(i),v.setEnd(n),r.addShape(v),(C=new _.Texts2D).setColor(l);m=new _.Vector2(p+h/2,(c+S)/2+h/3);C.setStart(m),C.setSize(h),C.setTexts(u),r.addShape(C)}},T.createAnnotation=function(a,s,l,e,t,r,i,n,h){var o=a.GetGlueObj(),u=new _.Shape2DSet,p=(_.Color.BLACK(),_.Color.GRAY(),_.Color.WHITE(),new _.Color(0,0,0)),c=s.GetFillColor().Clone(),d=s.GetFrameColor().Clone();T.CreateAnnotationRectangleImage(u,i,n,d,4,c,p,t,r,e);var S=n.x/100,f=2.5*t/100;if(o){o.CreateImage(u,function(e){var t=null;t=e instanceof Blob?URL.createObjectURL(e):e;var r=_.IDCreator.GetUUID(32,16),i=new _.Vector2(S,f);i=_.ShapeHelper.GetCommonSize(a,i),(l=new _.ImageBoard(h,i)).m_fixShowInScreen=!0;var n=a.GetResourceManager().GetOrCreateTexture(r),o=a.GetResourceManager().GetImage(r);null===o&&(o=a.GetResourceManager().GetOrCreateImage(r,t)),n.AddImage(o),l.SetTexture(n),l.SetCurrentGLContext(a.GetResourceManager().GetRenderContext()),s.GetFixed()&&s.GetBroadPos()&&l.SetLocalPos(s.GetBroadPos()),l.SetFrontShow(!0),s.AddImage(l)})}},T.GetAnnotationTextRectInfo=function(e,t,r,i,n,o,a){var s="";if(0!=t.length){s=t[0].getTexts();var l=_.Parameters.Instance().m_annotationDepartment,h=_.Parameters.Instance().m_annotationCharacter,u=_.Parameters.Instance().m_annotationUser,p=_.Parameters.Instance().m_internationalLanguage;if((0<l.length||0<h.length||0<u.length)&&(s+="\n"),0<l.length)s+=(0==p?"����:":"Department:")+l+" ";if(0<h.length)s+=(0==p?"��ɫ:":"Character:")+h+" ";if(0<u.length)s+=(0==p?"�û�:":"User:")+u;(i=t[0].getSize())<1&&(i=15),i=40*i/15;e.GetGlueObj(),this.countChar(s,1,0);var c=document.createElement("canvas");document.body.appendChild(c);var d=c.getContext("2d");d.font="Bold 40pt "+t[0].getFontName();var S=d.measureText(s);document.body.removeChild(c);var f=1.1*S.width,m=new _.Vector2(1,1),y=new _.Vector2(f+25,2.5*i+2);return r=s,n.copyFrom(m),o.copyFrom(y),[r,i,n,o,1]}},T.countChar=function(e,t,r){for(var i=0,n=0,o=1,a="",s="",l=0;l<e.length;l++){var h=e[l];s+=h,"\n"==h&&0<l&&"\r"==(h=e[l-1])&&(i<n&&(i=n-1,a=s.substr(0,s.length-2)),o++,n=0,s=""),l%2==0&&n++}return i<n&&(i=n,a=s),o,i,a},T}();_.AnnotationDisplayHelper=e}(M3D||(M3D={})),function(r){var e=function(t){function e(){var e=t.call(this)||this;return e.measureType=-1,e.createID=0,e.SetType(r.ShapeType.SHAPE_MEASURE_BASE),e}return __extends(e,t),e.prototype.GetMeasureType=function(){return this.measureType},e.prototype.SetMeasureType=function(e){this.measureType=e},e.prototype.GetCreateID=function(){return this.createID},e.prototype.SetCreateID=function(e){this.createID=e},e.MEASURE_TYPE_BASE=0,e.MEASURE_TYPE_PNT_PNT_DISTANCE=1,e.MEASURE_TYPE_PNT_LINE_DISTANCE=2,e.MEASURE_TYPE_PNT_FACE_DISTANCE=3,e.MEASURE_TYPE_LINE_LINE_DISTANCE=4,e.MEASURE_TYPE_LINE_FACE_DISTANCE=5,e.MEASURE_TYPE_FACE_FACE_DISTANCE=6,e.MEASURE_TYPE_SHAFT_SHAFT_DISTANCE=9,e.MEASURE_TYPE_CENTER_CENTER_DISTANCE=10,e.MEASURE_TYPE_LINE_LINE_ANGLE=50,e.MEASURE_TYPE_FACE_FACE_ANGLE=51,e.MEASURE_TYPE_LINE_FACE_ANGLE=52,e.MEASURE_TYPE_CURVE_CURVE_ANGLE=53,e.MEASURE_TYPE_CRICLE_DIAMETRE=60,e.MEASURE_TYPE_CRICLE_RADIUS=61,e.MEASURE_TYPE_PNT_COORD=100,e.MEASURE_TYPE_LINE_LENGTH=101,e.MEASURE_TYPE_CRICLE_PROPERTY=102,e.MEASURE_TYPE_FACE_PROPERTY=103,e.MEASURE_TYPE_APERTURE_PROPERTY=104,e.MEASURE_TYPE_MODEL_PROPERTY=105,e.MEASURE_TYPE_MODEL_STATISTICS=106,e.MEASURE_TYPE_TEXT_NOTE=150,e.MEASURE_TYPE_VOICE_NOTE=151,e.MEASURE_TYPE_SEQUENCE_NUMBER_NOTE=152,e.MEASURE_TYPE_THREED_GESTURE_NOTE=153,e.MEASURE_TYPE_MODELVIEW_TRACK_LINE=161,e}(r.Note);r.Measure=e}(M3D||(M3D={})),function(r){var e=function(t){function e(){var e=t.call(this)||this;return e.InitMeasureDistance(),e}return __extends(e,t),e.prototype.InitMeasureDistance=function(){this.SetType(r.ShapeType.SHAPE_MEASURE_ANGLE)},e}(r.Measure);r.MeasureAngle=e}(M3D||(M3D={})),function(r){var e=function(t){function e(){var e=t.call(this)||this;return e.InitMeasureDistance(),e}return __extends(e,t),e.prototype.InitMeasureDistance=function(){this.SetType(r.ShapeType.SHAPE_MEASURE_DIAMETRE)},e}(r.Measure);r.MeasureDiametre=e}(M3D||(M3D={})),function(r){var e=function(t){function e(){var e=t.call(this)||this;return e.InitMeasureDistance(),e}return __extends(e,t),e.prototype.InitMeasureDistance=function(){this.SetType(r.ShapeType.SHAPE_MEASURE_DISTANCE)},e}(r.Measure);r.MeasureDistance=e}(M3D||(M3D={})),function(Tt){var e=function(){function yt(){}return yt.LeaderColor=function(){return null===yt.m_leaderColor&&(yt.m_leaderColor=new Tt.Color(.294,.294,.294)),yt.m_leaderColor},yt.SelectColor=function(){return null===yt.m_selectColor&&(yt.m_selectColor=new Tt.Color(0,1,0)),yt.m_selectColor},yt.ExLineColor=function(){return null===yt.m_exLineColor&&(yt.m_exLineColor=new Tt.Color(.51,1,.51)),yt.m_exLineColor},yt.MeasureColor1=function(){return null===yt.m_measureColor1&&(yt.m_measureColor1=new Tt.Color(0,.443,.78)),yt.m_measureColor1},yt.MeasureColor2=function(){return null===yt.m_measureColor2&&(yt.m_measureColor2=new Tt.Color(.969,.373,.047)),yt.m_measureColor2},yt.MeasureColor3=function(){return null===yt.m_measureColor3&&(yt.m_measureColor3=new Tt.Color(.071,.686,.565)),yt.m_measureColor3},yt.CreateDistanceMeasure=function(e,t,r,i,n){var o=null;return null===n||(r===Tt.Measure.MEASURE_TYPE_PNT_PNT_DISTANCE?o=this.CreatePntToPntDistance(e,t,i,n):r===Tt.Measure.MEASURE_TYPE_PNT_LINE_DISTANCE?o=this.createPntToLineDistance(e,t,i,n):r===Tt.Measure.MEASURE_TYPE_PNT_FACE_DISTANCE?o=this.createPntToFaceDistance(e,t,i,n):r===Tt.Measure.MEASURE_TYPE_LINE_LINE_DISTANCE?o=this.createLineToLineDistance(e,t,i,n):r===Tt.Measure.MEASURE_TYPE_LINE_FACE_DISTANCE?o=this.createLineToFaceDistance(e,t,i,n):r===Tt.Measure.MEASURE_TYPE_FACE_FACE_DISTANCE&&(o=this.createFaceToFaceDistance(e,t,i,n)),yt.AddMeasureToScene(n,o),o&&o.SetFrontShow(!0)),o},yt.CreateSingleMeasure=function(e,t){var r=null;return null==t||(e==Tt.Measure.MEASURE_TYPE_PNT_PNT_DISTANCE||e==Tt.Measure.MEASURE_TYPE_PNT_LINE_DISTANCE||e==Tt.Measure.MEASURE_TYPE_LINE_LINE_DISTANCE||e==Tt.Measure.MEASURE_TYPE_LINE_FACE_DISTANCE||e==Tt.Measure.MEASURE_TYPE_LINE_LINE_DISTANCE||e==Tt.Measure.MEASURE_TYPE_FACE_FACE_DISTANCE||e==Tt.Measure.MEASURE_TYPE_SHAFT_SHAFT_DISTANCE||e==Tt.Measure.MEASURE_TYPE_CENTER_CENTER_DISTANCE||e==Tt.Measure.MEASURE_TYPE_LINE_LENGTH||e==Tt.Measure.MEASURE_TYPE_CRICLE_PROPERTY?(r=new Tt.MeasureDistance).SetMeasureType(e):e==Tt.Measure.MEASURE_TYPE_LINE_LINE_ANGLE||e==Tt.Measure.MEASURE_TYPE_FACE_FACE_ANGLE||e==Tt.Measure.MEASURE_TYPE_LINE_FACE_ANGLE?(r=new Tt.MeasureAngle).SetMeasureType(e):e!=Tt.Measure.MEASURE_TYPE_CRICLE_DIAMETRE&&e!=Tt.Measure.MEASURE_TYPE_CRICLE_RADIUS||(r=new Tt.MeasureDiametre).SetMeasureType(e),this.AddMeasureToScene(t,r),r&&r.SetFrontShow(!0)),r},yt.CreateMeasureImageBoard=function(e,t,r,i){if(!e)return!1;var n=new Tt.ComText,o=new Tt.CText;o.SetText(t),n.AddCText(o),e.ComTexts.push(n);var a=[],s=new Tt.Texts2D;s.setSize(12),s.setTexts("内容"),a.push(s);var l=new Tt.Texts2D;l.setSize(12),l.setTexts(t),a.push(l);Tt.MeasureDisplayHelper.createNoteTextsImageN(i,a,r,e);return!0},yt.CreateMeasureLine=function(e,t,r,i,n){if(!e)return!1;var o=new Tt.Line3D(r,i);return o.SetColor(n),o.SetName(t),e.AddLine(o),!0},yt.CreateMeasurePoint=function(e,t,r,i){if(!e)return!1;var n=new Tt.Point(i);return n.SetDrawType(t),n.SetSize(r),e.AddPoint(n),!0},yt.CreateTmpDiametreMeasure=function(e,t,r,i){var n=null;return null==r||(t==Tt.Measure.MEASURE_TYPE_CRICLE_DIAMETRE?n=this.createDesignerDiametre(e,r):t==Tt.Measure.MEASURE_TYPE_CRICLE_RADIUS&&(n=this.createDesignerRadius(e,r)),this.AddMeasureToScene(r,n),n&&n.SetFrontShow(!0)),n},yt.createDesignerDiametre=function(e,t){var r=null,i=t.GetShape(e);if(i&&i.GetType()==Tt.ShapeType.SHAPE_EDGE){(r=new Tt.MeasureDiametre).SetMeasureType(Tt.Measure.MEASURE_TYPE_CRICLE_DIAMETRE);var n=new Tt.Vector3,o=new Tt.Vector3,a=0,s=this.CreateCircularArc(r,i,n,o,a),l=s[0];if(n=s[1],a=s[2],o=s[3],!l)return r=null}return r},yt.createDesignerRadius=function(e,t){var r=null,i=t.GetShape(e);if(i&&i.GetType()==Tt.ShapeType.SHAPE_EDGE){(r=new Tt.MeasureDiametre).SetMeasureType(Tt.Measure.MEASURE_TYPE_CRICLE_RADIUS);var n=new Tt.Vector3,o=new Tt.Vector3,a=0,s=this.CreateCircularArc(r,i,n,o,a),l=s[0];if(n=s[1],a=s[2],o=s[3],!l)return r=null}return r},yt.CompleteDiametreMeasure=function(e,t,r,i){var n=!1;if(!e||!i)return n;var o=e.GetMeasureType();return o==Tt.Measure.MEASURE_TYPE_CRICLE_DIAMETRE?n=this.completeDesignerDiametre(e,t,r,i):o==Tt.Measure.MEASURE_TYPE_CRICLE_RADIUS&&(n=this.completeDesignerRadius(e,t,r,i)),n},yt.completeDesignerDiametre=function(e,t,r,i){var n=!1;if(!e||!i)return n;if(!e)return n;var o=i.GetShape(t);if(o&&o.GetType()==Tt.ShapeType.SHAPE_EDGE){var a=o,s=a.GetLineData(),l=a.GetGeoAttribute();if(l&&l.GetGeoAttrType()==Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_ELLIPSE){var h=l,u=Tt.ShapeHelper.GetShapeWorldMatrix(a);Tt.GeometryHelper.Transform(h,u),this.DeleteMeasureLine(e);var p=h.GetMajorRadius(),c=h.GetCenterPoint(),d=h.GetStartPoint(),S=h.GetEndPoint(),f=d.Sub(c),m=S.Sub(c),y=new Tt.Vector3,T=f.Angle(m);if(Math.abs(T-180)<.1){var M=s.GetRefLine().GetPoints(),g=s.GetDataOffset(),v=s.GetDataLength();v/=2;var C=u.Multiply(M[g+v]);y=f.CrossProduct(C.Sub(c))}else y=f.CrossProduct(m);var _=new Tt.Plane(y,d),A=i.GetCamera().GetViewPort().GetScreenRay(r.x,r.y),E=new Tt.Vector3,G=(E=_.GetInsectPnt1(A,E)).Sub(c).Normalized(),P=c.Sub(G.Multiply(p)),w=c.Add(G.Multiply(p)),D=Tt.Color.RED();E.Sub(c).Length()>p&&(w=E);var x=new Tt.Line3D(P,w);x.SetColor(D),x.SetCanDelete(!0),e.AddLine(x),e.imageBoardList.length=0;var R=[];R.push(2*p);var I=null;I=Tt.MeasureDisplayHelper.SetMeasureUnit(Tt.Parameters.Instance().measureUnitStyle,R,I);var L="φ"+String(R[0])+I,N=new Tt.ComText,O=new Tt.CText;O.SetText(L),N.AddCText(O),e.ComTexts.push(N);var b=[],V=new Tt.Texts2D;V.setSize(12),V.setTexts("内容"),b.push(V);var F=new Tt.Texts2D;F.setSize(12),F.setTexts(L),b.push(F),Tt.MeasureDisplayHelper.createNoteTextsImageN(i,b,E,e,r),n=!0}else e=null}return n},yt.completeDesignerRadius=function(e,t,r,i){var n=!1;if(!e||!i)return n;if(!e)return n;var o=i.GetShape(t);if(o&&o.GetType()==Tt.ShapeType.SHAPE_EDGE){var a=o,s=a.GetLineData(),l=a.GetGeoAttribute();if(l&&l.GetGeoAttrType()==Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_ELLIPSE){var h=l,u=Tt.ShapeHelper.GetShapeWorldMatrix(a);Tt.GeometryHelper.Transform(h,u),this.DeleteMeasureLine(e);var p=h.GetMajorRadius(),c=h.GetCenterPoint(),d=h.GetStartPoint(),S=h.GetEndPoint(),f=d.Sub(c),m=S.Sub(c),y=new Tt.Vector3,T=f.Angle(m);if(Math.abs(T-180)<.1){var M=s.GetRefLine().GetPoints(),g=s.GetDataOffset(),v=s.GetDataLength();v/=2;var C=u.Multiply(M[g+v]);y=f.CrossProduct(C.Sub(c))}else y=f.CrossProduct(m);var _=new Tt.Plane(y,d),A=i.GetCamera().GetViewPort().GetScreenRay(r.x,r.y),E=new Tt.Vector3,G=(E=_.GetInsectPnt1(A,E)).Sub(c).Normalized(),P=c.Sub(G.Multiply(p)),w=c.Add(G.Multiply(p)),D=Tt.Color.RED();E.Sub(c).Length()>p&&(w=E);var x=new Tt.Line3D(P,w);x.SetColor(D),x.SetCanDelete(!0),e.AddLine(x),e.imageBoardList.length=0;var R=[];R.push(p);var I=null;I=Tt.MeasureDisplayHelper.SetMeasureUnit(Tt.Parameters.Instance().measureUnitStyle,R,I);var L="R"+String(R[0])+I,N=new Tt.ComText,O=new Tt.CText;O.SetText(L),N.AddCText(O),e.ComTexts.push(N);var b=[],V=new Tt.Texts2D;V.setSize(12),V.setTexts("内容"),b.push(V);var F=new Tt.Texts2D;F.setSize(12),F.setTexts(L),b.push(F),Tt.MeasureDisplayHelper.createNoteTextsImageN(i,b,E,e,r),n=!0}else e=null}return n},yt.CreateTmpDistanceMeasure=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=e[3],i=e[2],n=null;if(null==r)return n;if(e[0]instanceof Tt.Vector3){var o=e[0],a=e[1];n=this.createDesignerPntToPntDistance2(o,a,r),this.AddMeasureToScene(r,n),n&&n.SetFrontShow(!0)}else{var s=e[0],l=e[1],h=e[4];i==Tt.Measure.MEASURE_TYPE_PNT_PNT_DISTANCE?n=this.createDesignerPntToPntDistance(s,l,r,h):i==Tt.Measure.MEASURE_TYPE_PNT_LINE_DISTANCE?n=this.createDesignerPntToLineDistance(s,l,r,h):i==Tt.Measure.MEASURE_TYPE_LINE_LINE_DISTANCE?n=this.createDesignerLineToLineDistance(s,l,r,h):i==Tt.Measure.MEASURE_TYPE_SHAFT_SHAFT_DISTANCE?n=this.createDesignerShaftToShaftDistance(s,l,r,h):i==Tt.Measure.MEASURE_TYPE_CENTER_CENTER_DISTANCE?n=this.createDesignerCenterToCenterDistance(s,l,r,h):i==Tt.Measure.MEASURE_TYPE_LINE_LENGTH?n=this.createDesignerLineDistance(s,r,h):i==Tt.Measure.MEASURE_TYPE_CRICLE_PROPERTY&&(n=this.createDesignerArcDistance(s,r,h)),this.AddMeasureToScene(r,n),n&&n.SetFrontShow(!0)}return n},yt.createDesignerPntToPntDistance=function(e,t,r,i){var n=null,o=r.GetShape(e),a=r.GetShape(t);if(o&&a&&o.GetType()==Tt.ShapeType.SHAPE_POINT_HANDLE&&a.GetType()==Tt.ShapeType.SHAPE_POINT_HANDLE){(n=new Tt.MeasureDistance).SetMeasureType(Tt.Measure.MEASURE_TYPE_PNT_PNT_DISTANCE);var s=a,l=o.GetPosition(),h=s.GetPosition(),u=l.Sub(h).Length(),p=h.Sub(l).Clone();(p=r.GetCamera().GetViewPort().GetScreenRay(0,0).GetDirection().CrossProduct(p)).Normalize();var c=l.Add(p.Multiply(u).Multiply(.5)),d=h.Add(p.Multiply(u).Multiply(.5)),S=Tt.Color.RED(),f=new Tt.Line3D(l,h);f.SetName("dottedLine"),f.SetColor(S),new Tt.Line3D(l,c).SetColor(S),new Tt.Line3D(h,d).SetColor(S),new Tt.Line3D(c,d).SetColor(S),n.AddLine(f);var m=[];m.push(u);var y=null;y=Tt.MeasureDisplayHelper.SetMeasureUnit(Tt.Parameters.Instance().measureUnitStyle,m,y);var T=String(m[0].toFixed(3))+y,M=(r.GetSceneBox().Length(),new Tt.ComText),g=new Tt.CText;g.SetLanguageType("PointPointDistance"),g.SetText(T),M.AddCText(g),n.ComTexts.push(M);var v=new Tt.Vector3;v=c.Add(d).Divide(2);var C=[],_=new Tt.Texts2D;_.setSize(12),_.setTexts("内容"),C.push(_);var A=new Tt.Texts2D;A.setSize(12),A.setTexts(T),C.push(A),Tt.MeasureDisplayHelper.createNoteTextsImageN(r,C,v,n,i)}return n},yt.createDesignerPntToPntDistance2=function(e,t,r){var i=null;(i=new Tt.MeasureDistance).SetMeasureType(Tt.Measure.MEASURE_TYPE_PNT_PNT_DISTANCE);var n=Tt.Color.BLUE(),o=new Tt.Line3D(e,t);return o.SetLineWidth(2),o.SetColor(n),i.AddLine(o),i},yt.createDesignerPntToLineDistance=function(e,t,r,i){var n=null,o=r.GetShape(e),a=r.GetShape(t);if(o&&o.GetType()==Tt.ShapeType.SHAPE_EDGE){(n=new Tt.MeasureDistance).SetMeasureType(Tt.Measure.MEASURE_TYPE_PNT_LINE_DISTANCE);var s=o,l=(s.GetLineData(),s.GetGeoAttribute());if(l&&!a&&l.GetGeoAttrType()==Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_LINE){var h=l,u=Tt.ShapeHelper.GetShapeWorldMatrix(s);Tt.GeometryHelper.Transform(h,u);var p=0,c=h.GetStartPoint(),d=h.GetEndPoint();p=c.Sub(d).Length();var S=c.Sub(d);(S=r.GetCamera().GetViewPort().GetScreenRay(0,0).GetDirection().CrossProduct(S)).Normalize();var f=c.Add(S.Multiply(p).Multiply(.5)),m=d.Add(S.Multiply(p).Multiply(.5)),y=Tt.Color.RED();(_=new Tt.Line3D(c,d)).SetColor(y),(G=new Tt.Line3D(c,f)).SetColor(y),(P=new Tt.Line3D(d,m)).SetColor(y),(w=new Tt.Line3D(f,m)).SetColor(y),n.AddLine(_),(x=new Tt.Point(c)).SetDrawType(1),x.SetSize(.8),(R=new Tt.Point(d)).SetDrawType(1),R.SetSize(.8),n.AddPoint(x),n.AddPoint(R),(O=[]).push(p);var T=null;T=Tt.MeasureDisplayHelper.SetMeasureUnit(Tt.Parameters.Instance().measureUnitStyle,O,T);var M=String(O[0].toFixed(3))+T,g=new Tt.ComText;(V=new Tt.CText).SetText(M),g.AddCText(V),n.ComTexts.push(g);var v=new Tt.Vector3;v=m;var C=[];(F=new Tt.Texts2D).setSize(12),F.setTexts("内容"),C.push(F),(B=new Tt.Texts2D).setSize(12),B.setTexts(M),C.push(B),Tt.MeasureDisplayHelper.createNoteTextsImageN(r,C,v,n,i)}else if(l&&a&&l.GetGeoAttrType()==Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_LINE&&a.GetType()==Tt.ShapeType.SHAPE_POINT_HANDLE){h=l,u=Tt.ShapeHelper.GetShapeWorldMatrix(s);Tt.GeometryHelper.Transform(h,u);c=h.GetStartPoint(),d=h.GetEndPoint();var _,A=a.GetPosition();y=Tt.Color.RED();(_=new Tt.Line3D(c,d)).SetColor(y);var E=new Tt.Vector3;p=0;p=Tt.MeasureCalculateHelper.PntLineDistance(A,h,p,0,E);S=A.Sub(E).Clone();(S=r.GetCamera().GetViewPort().GetScreenRay(0,0).GetDirection().CrossProduct(S)).Normalize();var G,P,w;f=A.Add(S.Multiply(p).Multiply(.5)).Clone(),m=E.Add(S.Multiply(p).Multiply(.5)).Clone();(G=new Tt.Line3D(A,E)).SetName("dottedLine"),G.SetColor(y),(P=new Tt.Line3D(A,f)).SetCanDelete(!0),P.SetColor(y),(w=new Tt.Line3D(E,m)).SetCanDelete(!0),w.SetColor(y);var D=new Tt.Line3D(f,m);D.SetCanDelete(!0),D.SetColor(y);var x,R,I=null,L=new Tt.Vector3;Tt.MeasureCalculateHelper.pntInSegment(E,c,d,L)||((I=new Tt.Line3D(E,L)).SetName("dottedLine"),I.SetColor(y)),n.AddLine(_),n.AddLine(G),I&&n.AddLine(I),(x=new Tt.Point(c)).SetDrawType(1),x.SetSize(.8),(R=new Tt.Point(d)).SetDrawType(1),R.SetSize(.8);var N=new Tt.Point(E);N.SetDrawType(1),N.SetSize(.8);var O,b=new Tt.Point(A);b.SetDrawType(1),b.SetSize(.8),n.AddPoint(x),n.AddPoint(R),n.AddPoint(N),n.AddPoint(b),(O=[]).push(p);T=null;T=Tt.MeasureDisplayHelper.SetMeasureUnit(Tt.Parameters.Instance().measureUnitStyle,O,T);var V;M=String(O[0].toFixed(3))+T,g=new Tt.ComText;(V=new Tt.CText).SetText(M),g.AddCText(V),n.ComTexts.push(g);v=new Tt.Vector3;v=m;var F,B;C=[];(F=new Tt.Texts2D).setSize(12),F.setTexts("内容"),C.push(F),(B=new Tt.Texts2D).setSize(12),B.setTexts(M),C.push(B);Tt.MeasureDisplayHelper.createNoteTextsImageN(r,C,v,n,i)}else n=null}return n},yt.createDesignerLineToLineDistance=function(e,t,r,i){var n=null,o=r.GetShape(e),a=r.GetShape(t);if(o&&!a&&o.GetType()==Tt.ShapeType.SHAPE_EDGE){(n=new Tt.MeasureDistance).SetMeasureType(Tt.Measure.MEASURE_TYPE_LINE_LINE_DISTANCE);(v=o).GetLineData();if((_=v.GetGeoAttribute())&&!a&&_.GetGeoAttrType()==Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_LINE){var s=_,l=Tt.ShapeHelper.GetShapeWorldMatrix(v);Tt.GeometryHelper.Transform(s,l);var h=0,u=s.GetStartPoint(),p=s.GetEndPoint();h=u.Sub(p).Length();var c=u.Sub(p).Clone();(c=r.GetCamera().GetViewPort().GetScreenRay(0,0).GetDirection().CrossProduct(c)).Normalize();var d=u.Add(c.Multiply(h).Multiply(.5)).Clone(),S=p.Add(c.Multiply(h).Multiply(.5)).Clone(),f=Tt.Color.RED();(F=new Tt.Line3D(u,p)).SetColor(f),(B=new Tt.Line3D(u,d)).SetColor(f),(W=new Tt.Line3D(p,S)).SetColor(f),(Y=new Tt.Line3D(d,S)).SetColor(f),n.AddLine(F),n.AddLine(B),n.AddLine(W),n.AddLine(Y),(U=new Tt.Point(u)).SetDrawType(1),U.SetSize(.8),(H=new Tt.Point(p)).SetDrawType(1),H.SetSize(.8),n.AddPoint(U),n.AddPoint(H),($=[]).push(h);var m=null;m=Tt.MeasureDisplayHelper.SetMeasureUnit(Tt.Parameters.Instance().measureUnitStyle,$,m);var y=String($[0].toFixed(3))+m,T=new Tt.ComText;(te=new Tt.CText).SetText(y),T.AddCText(te),n.ComTexts.push(T);var M=new Tt.Vector3;M=d.Add(S).Divide(2);var g=[];(re=new Tt.Texts2D).setSize(12),re.setTexts("内容"),g.push(re),(ie=new Tt.Texts2D).setSize(12),ie.setTexts(y),g.push(ie),Tt.MeasureDisplayHelper.createNoteTextsImageN(r,g,M,n,i)}else n=null}else if(o&&a&&e!=t&&o.GetType()==Tt.ShapeType.SHAPE_EDGE&&a.GetType()==Tt.ShapeType.SHAPE_EDGE){(n=new Tt.MeasureDistance).SetMeasureType(Tt.Measure.MEASURE_TYPE_LINE_LINE_DISTANCE);var v,C=a,_=((v=o).GetLineData(),C.GetLineData(),v.GetGeoAttribute()),A=C.GetGeoAttribute();if(_&&_.GetGeoAttrType()==Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_LINE&&a&&A.GetGeoAttrType()==Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_LINE){s=_;var E=A,G=Tt.ShapeHelper.GetShapeWorldMatrix(v),P=Tt.ShapeHelper.GetShapeWorldMatrix(C);Tt.GeometryHelper.Transform(s,G),Tt.GeometryHelper.Transform(E,P);var w=s.GetStartPoint(),D=s.GetEndPoint(),x=E.GetStartPoint(),R=E.GetEndPoint(),I=(h=0,new Tt.Vector3),L=new Tt.Vector3,N=!0,O=Tt.MeasureCalculateHelper.LineLineDistance(s,E,h,I,L,N);if(h=O[0],N=O[1]){var b=new Tt.Vector3,V=new Tt.Vector3,F=(f=Tt.Color.RED(),null),B=null,U=null,H=null;Tt.MeasureCalculateHelper.pntInSegment(I,w,D,b)?I!=w&&I!=D&&((U=new Tt.Point(I)).SetDrawType(1),U.SetSize(.8)):((F=new Tt.Line3D(I,b)).SetColor(f),F.SetName("dottedLine"),(U=new Tt.Point(I)).SetDrawType(1),U.SetSize(.8)),Tt.MeasureCalculateHelper.pntInSegment(L,x,R,V)?L!=x&&L!=R&&((H=new Tt.Point(L)).SetDrawType(1),H.SetSize(.8)):((B=new Tt.Line3D(L,V)).SetColor(f),B.SetName("dottedLine"),(H=new Tt.Point(L)).SetDrawType(1),H.SetSize(.8));var k=(c=I.Sub(L).Clone()).Length();(c=D.Sub(w).CrossProduct(c)).Normalize();var z=k;k<500&&(z=1e3);var W,Y;d=I.Add(c.Multiply(z).Multiply(.5)).Clone(),S=L.Add(c.Multiply(z).Multiply(.5)).Clone();(W=new Tt.Line3D(w,D)).SetColor(f),(Y=new Tt.Line3D(x,R)).SetColor(f);var X=new Tt.Line3D(I,L);X.SetColor(f),X.SetName("dottedLine");var j=new Tt.Line3D(I,d);j.SetColor(f),j.SetCanDelete(!0);var K=new Tt.Line3D(L,S);K.SetColor(f),K.SetCanDelete(!0);var q=new Tt.Line3D(d,S);q.SetColor(f),q.SetCanDelete(!0),F&&n.AddLine(F),B&&n.AddLine(B),n.AddLine(W),n.AddLine(Y),n.AddLine(X),n.AddLine(j),n.AddLine(K),n.AddLine(q);var Q=new Tt.Point(w);Q.SetDrawType(1),Q.SetSize(.8);var Z=new Tt.Point(D);Z.SetDrawType(1),Z.SetSize(.8);var J=new Tt.Point(x);J.SetDrawType(1),J.SetSize(.8);var $,ee=new Tt.Point(R);ee.SetDrawType(1),ee.SetSize(.8),U&&n.AddPoint(U),H&&n.AddPoint(H),n.AddPoint(Q),n.AddPoint(Z),n.AddPoint(J),n.AddPoint(ee),($=[]).push(k);m=null;m=Tt.MeasureDisplayHelper.SetMeasureUnit(Tt.Parameters.Instance().measureUnitStyle,$,m);var te;y=String($[0].toFixed(3))+m,T=new Tt.ComText;(te=new Tt.CText).SetText(y),T.AddCText(te),n.ComTexts.push(T);M=new Tt.Vector3;M=d.Add(S).Divide(2);var re,ie;g=[];(re=new Tt.Texts2D).setSize(12),re.setTexts("内容"),g.push(re),(ie=new Tt.Texts2D).setSize(12),ie.setTexts(y),g.push(ie);Tt.MeasureDisplayHelper.createNoteTextsImageN(r,g,M,n,i)}else n=null}else n=null}return n},yt.createDesignerShaftToShaftDistance=function(e,t,r,i){var n=null,o=r.GetShape(e),a=r.GetShape(t),s=!1,l=!1,h=new Tt.Vector3,u=new Tt.Vector3,p=new Tt.Vector3,c=new Tt.Vector3,d=0,S=0;if(o&&o.GetType()==Tt.ShapeType.SHAPE_EDGE&&((n=new Tt.MeasureDistance).SetMeasureType(Tt.Measure.MEASURE_TYPE_SHAFT_SHAFT_DISTANCE),s=(f=this.CreateCircularArc(n,o,h,p,d))[0],h=f[1],d=f[2],p=f[3],!s))return n=null;if(s&&a&&a.GetType()==Tt.ShapeType.SHAPE_EDGE){if(!n)return n;var f;if(l=(f=this.CreateCircularArc(n,a,u,c,S))[0],u=f[1],S=f[2],c=f[3],0!=h.Angle(u)&&180!=h.Angle(u)&&(l=!1),!l||e==t)return n=null}if(s&&l){var m=p.Add(h.Multiply(d).Multiply(2)),y=p.Sub(h.Multiply(d).Multiply(2)),T=c.Add(u.Multiply(S).Multiply(2)),M=c.Sub(u.Multiply(S).Multiply(2)),g=new Tt.Point(m);g.SetDrawType(1),g.SetSize(.8);var v=new Tt.Point(y);v.SetDrawType(1),v.SetSize(.8);var C=new Tt.Point(T);C.SetDrawType(1),C.SetSize(.8);var _=new Tt.Point(M);_.SetDrawType(1),_.SetSize(.8),n.AddPoint(g),n.AddPoint(v),n.AddPoint(C),n.AddPoint(_);var A=Tt.Color.RED(),E=new Tt.Line3D(m,y);E.SetColor(A),E.SetName("dottedLine");var G=new Tt.Line3D(T,M);G.SetColor(A),G.SetName("dottedLine"),n.AddLine(E),n.AddLine(G);var P=new Tt.Ray(p,h).Project(c),w=P.Sub(c).Length(),D=new Tt.Line3D(c,P);if(D.SetColor(A),D.SetName("dottedLine"),n.AddLine(D),P!=p){var x=new Tt.Point(P);x.SetName("SpecialPnt"),x.SetDrawType(1),x.SetSize(.8),n.AddPoint(x);var R=new Tt.Line3D(p,P);R.SetColor(A),R.SetName("dottedLine"),n.AddLine(R)}var I=[];I.push(w);var L=null;L=Tt.MeasureDisplayHelper.SetMeasureUnit(Tt.Parameters.Instance().measureUnitStyle,I,L);var N=String(I[0].toFixed(3))+L,O=new Tt.ComText,b=new Tt.CText;b.SetText(N),O.AddCText(b),n.ComTexts.push(O);var V=new Tt.Vector3;V=P.Add(c).Divide(2);var F=[],B=new Tt.Texts2D;B.setSize(12),B.setTexts("内容"),F.push(B);var U=new Tt.Texts2D;U.setSize(12),U.setTexts(N),F.push(U),Tt.MeasureDisplayHelper.createNoteTextsImageN(r,F,V,n,i)}return n},yt.CreateCircularArc=function(e,t,r,i,n){var o=!1;if(!e)return o;if(t&&t.GetType()==Tt.ShapeType.SHAPE_EDGE){var a=t,s=a.GetLineData(),l=a.GetGeoAttribute();if(l&&l.GetGeoAttrType()==Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_ELLIPSE){var h=l,u=Tt.ShapeHelper.GetShapeWorldMatrix(a);Tt.GeometryHelper.Transform(h,u),i=h.GetCenterPoint();var p=h.GetMajorRadius();if((n=p)!=h.GetMinorRadius())return o;var c=h.GetStartPoint(),d=h.GetEndPoint(),S=c.Sub(i).Normalized(),f=d.Sub(i).Normalized();r=S.CrossProduct(f).Normalized();var m=new Tt.Point(i);m.SetDrawType(1),m.SetSize(.8),e.AddPoint(m);var y=s.GetRefLine().GetPoints(),T=s.GetDataOffset(),M=s.GetDataLength(),g=[],v=[],C=S.Angle(f);if(Math.abs(C-180)<.1){M/=2;var _=u.Multiply(y[T+M]),A=i.Sub(_).Normalized(),E=_.Add(A.Multiply(p).Multiply(2));r=S.CrossProduct(A).Normalized(),C=c.Sub(i).Angle(_.Sub(i)),Tt.MeasureDisplayHelper.CreateDesignerAngleMark(i,c,i,_,i,p,C,g),Tt.MeasureDisplayHelper.CreateDesignerAngleMark(i,_,i,d,i,p,180-C,g),Tt.MeasureDisplayHelper.CreateDesignerAngleMark(i,c,i,E,i,p,C,v),Tt.MeasureDisplayHelper.CreateDesignerAngleMark(i,E,i,d,i,p,180-C,v)}else if(Math.abs(C)<.001)Tt.MeasureDisplayHelper.CreateDesignerAngleMark(i,c,i,d,i,p,360,g);else if(M<3)Tt.MeasureDisplayHelper.CreateDesignerAngleMark(i,c,i,d,i,p,C,g),Tt.MeasureDisplayHelper.CreateDesignerAngleMark(i,c,i,d,i,p,C-360,v);else{M/=2;_=u.Multiply(y[T+M]);var G=c.Sub(i).Angle(_.Sub(i)),P=d.Sub(i).Angle(_.Sub(i));G<C&&P<C?(Tt.MeasureDisplayHelper.CreateDesignerAngleMark(i,c,i,d,i,p,C,g),Tt.MeasureDisplayHelper.CreateDesignerAngleMark(i,c,i,d,i,p,C-360,v)):(Tt.MeasureDisplayHelper.CreateDesignerAngleMark(i,c,i,d,i,p,C-360,g),Tt.MeasureDisplayHelper.CreateDesignerAngleMark(i,c,i,d,i,p,C,v))}var w=Tt.Color.RED();if(0<g.length)for(var D=0;D<g.length-1;D++){(x=new Tt.Line3D(g[D],g[D+1])).SetColor(w),e.AddLine(x)}if(0<v.length)for(D=0;D<v.length-1;D++){var x;(x=new Tt.Line3D(v[D],v[D+1])).SetColor(w),x.SetName("dottedLine"),e.AddLine(x)}var R=i.Add(S.Multiply(p).Divide(3)),I=i.Sub(S.Multiply(p).Divide(3)),L=S.CrossProduct(r).Normalized(),N=i.Add(L.Multiply(p).Divide(3)),O=i.Sub(L.Multiply(p).Divide(3)),b=new Tt.Line3D(R,I);b.SetColor(w);var V=new Tt.Line3D(N,O);V.SetColor(w),e.AddLine(b),e.AddLine(V),o=!0}}return[o,r,n,i]},yt.createDesignerCenterToCenterDistance=function(e,t,r,i){var n=null,o=r.GetShape(e),a=r.GetShape(t),s=!1,l=!1,h=new Tt.Vector3,u=new Tt.Vector3,p=new Tt.Vector3,c=new Tt.Vector3,d=0,S=0;if(o&&o.GetType()==Tt.ShapeType.SHAPE_EDGE&&((n=new Tt.MeasureDistance).SetMeasureType(Tt.Measure.MEASURE_TYPE_CENTER_CENTER_DISTANCE),s=(f=this.CreateCircularArc(n,o,h,p,d))[0],h=f[1],d=f[2],p=f[3],!s))return n=null;if(s&&a&&a.GetType()==Tt.ShapeType.SHAPE_EDGE){if(!n)return n;var f;if(l=(f=this.CreateCircularArc(n,a,u,c,S))[0],u=f[1],S=f[2],c=f[3],!l||e==t)return n=null}if(s&&l){var m=Tt.Color.RED(),y=p.Sub(c).Length(),T=new Tt.Line3D(c,p);T.SetName("dottedLine"),T.SetColor(m),n.AddLine(T);var M=[];M.push(y);var g=null;g=Tt.MeasureDisplayHelper.SetMeasureUnit(Tt.Parameters.Instance().measureUnitStyle,M,g);var v=String(M[0].toFixed(3))+g,C=new Tt.ComText,_=new Tt.CText;_.SetText(v),C.AddCText(_),n.ComTexts.push(C);var A=new Tt.Vector3;A=p.Add(c).Divide(2);var E=[],G=new Tt.Texts2D;G.setSize(12),G.setTexts("内容"),E.push(G);var P=new Tt.Texts2D;P.setSize(12),P.setTexts(v),E.push(P),Tt.MeasureDisplayHelper.createNoteTextsImageN(r,E,A,n,i)}return n},yt.createDesignerLineDistance=function(e,t,r){var i=null,n=t.GetShape(e);if(n&&n.GetType()==Tt.ShapeType.SHAPE_EDGE){(i=new Tt.MeasureDistance).SetMeasureType(Tt.Measure.MEASURE_TYPE_LINE_LENGTH);var o=n,a=(o.GetLineData(),o.GetGeoAttribute());if(a&&a.GetGeoAttrType()==Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_LINE){var s=a,l=Tt.ShapeHelper.GetShapeWorldMatrix(o);Tt.GeometryHelper.Transform(s,l);var h,u=s.GetStartPoint(),p=s.GetEndPoint();h=u.Sub(p).Length();var c=u.Sub(p);(c=t.GetCamera().GetViewPort().GetScreenRay(0,0).GetDirection().CrossProduct(c)).Normalize();var d=u.Add(c.Multiply(h).Multiply(.5)),S=p.Add(c.Multiply(h).Multiply(.5)),f=Tt.Color.RED(),m=new Tt.Line3D(u,p);m.SetColor(f);var y=new Tt.Line3D(u,d);y.SetColor(f),y.SetCanDelete(!0);var T=new Tt.Line3D(p,S);T.SetCanDelete(!0),T.SetColor(f);var M=new Tt.Line3D(d,S);M.SetCanDelete(!0),M.SetColor(f),i.AddLine(m);var g=new Tt.Point(u);g.SetDrawType(1),g.SetSize(.8);var v=new Tt.Point(p);v.SetDrawType(1),v.SetSize(.8),i.AddPoint(g),i.AddPoint(v);var C=[];C.push(h);var _=null;_=Tt.MeasureDisplayHelper.SetMeasureUnit(Tt.Parameters.Instance().measureUnitStyle,C,_);var A=String(C[0].toFixed(3))+_,E=new Tt.ComText,G=new Tt.CText;G.SetText(A),E.AddCText(G),i.ComTexts.push(E);var P=new Tt.Vector3;P=d.Add(S).Divide(2);var w=[],D=new Tt.Texts2D;D.setSize(12),D.setTexts("内容"),w.push(D);var x=new Tt.Texts2D;x.setSize(12),x.setTexts(A),w.push(x),Tt.MeasureDisplayHelper.createNoteTextsImageN(t,w,P,i,r)}else i=null}return i},yt.createDesignerArcDistance=function(e,t,r){var i=null,n=t.GetShape(e);if(n&&n.GetType()==Tt.ShapeType.SHAPE_EDGE){(i=new Tt.MeasureDistance).SetMeasureType(Tt.Measure.MEASURE_TYPE_CRICLE_PROPERTY);var o,a=new Tt.Vector3,s=new Tt.Vector3,l=0,h=this.CreateCircularArc(i,n,a,s,l);if(o=h[0],a=h[1],l=h[2],s=h[3],!o)return i=null}return i},yt.CompleteFaceDistanceMeasure=function(e,t,r,i,n,o,a){var s=!1;if(!e||!a)return s;var l=e.GetMeasureType();return l==Tt.Measure.MEASURE_TYPE_PNT_FACE_DISTANCE?s=this.completeDesignerPntToFaceDistance(e,t,r,i,o,a):l==Tt.Measure.MEASURE_TYPE_LINE_FACE_DISTANCE?s=this.completeDesignerLineToFaceDistance(e,t,r,i,o,a):l==Tt.Measure.MEASURE_TYPE_FACE_FACE_DISTANCE&&(s=this.completeDesignerFaceToFaceDistance(e,t,r,i,n,o,a)),s},yt.completeDesignerPntToFaceDistance=function(e,t,r,i,n,o){var a=!1;if(!e||!o)return a;var s=e;if(!s)return a;var l=o.GetShape(t),h=o.GetShape(r);if(l&&h&&l.GetType()==Tt.ShapeType.SHAPE_FACE&&h.GetType()==Tt.ShapeType.SHAPE_POINT_HANDLE){var u=l,p=u.GetMesh(),c=u.GetGeoAttribute(),d=h.GetPosition();if(!c||c.GetGeoAttrType()!=Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_PLANEFACE)return e=null,a;var S=c,f=(p.GetRefMesh().GetPositionArray(),Tt.ShapeHelper.GetShapeWorldMatrix(u));Tt.GeometryHelper.Transform(S,f);var m=new Tt.Plane(S.GetNormal(),S.GetOrigin()).Project(d),y=(d.Sub(m).Length(),new Tt.Vector3);if(!o.GetPickPoint(n,y,!1))return a;var T=d.Sub(m).Clone(),M=new Tt.Plane(d,m,y).normal;(M=T.CrossProduct(M)).Normalize();for(var g=new Tt.Ray(d,T).Project(y),v=g.Sub(y).Length(),C=d.Add(M.Multiply(v)).Clone(),_=m.Add(M.Multiply(v)).Clone(),A=s.LineList,E=0,G=A;E<G.length;E++){var P=G[E];P&&!P.GetCanDelete()||A.splice(A.indexOf(P),1)}var w=Tt.Color.RED(),D=new Tt.Line3D(d,C);D.SetCanDelete(!0),D.SetColor(w);var x=new Tt.Line3D(m,_);x.SetCanDelete(!0),x.SetColor(w);var R=new Tt.Line3D(C,_);R.SetCanDelete(!0),R.SetColor(w);var I=null;Tt.MeasureCalculateHelper.pntInSegment(y,C,_,g)||((I=new Tt.Line3D(g,y)).SetCanDelete(!0),I.SetColor(w)),e.AddLine(D),e.AddLine(x),e.AddLine(R),I&&e.AddLine(I);for(var L=0;L<e.imageBoardList.length;L++)e.imageBoardList[L].SetPosition(y);a=!0}return a},yt.completeDesignerLineToFaceDistance=function(e,t,r,i,n,o){var a=!1;if(!e||!o)return a;var s=e;if(!s)return a;var l=o.GetShape(t),h=o.GetShape(r),u=o.GetShape(i);if(l&&h&&u&&l.GetType()==Tt.ShapeType.SHAPE_FACE&&h.GetType()==Tt.ShapeType.SHAPE_EDGE&&u.GetType()==Tt.ShapeType.SHAPE_POINT_HANDLE){var p=l,c=(p.GetMesh(),p.GetGeoAttribute()),d=h,S=(d.GetLineData(),d.GetGeoAttribute()),f=u.GetPosition();if(null==c||c.GetGeoAttrType()!=Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_PLANEFACE||null==S||S.GetGeoAttrType()!=Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_LINE)return e=null,a;var m=c,y=S,T=Tt.ShapeHelper.GetShapeWorldMatrix(p),M=Tt.ShapeHelper.GetShapeWorldMatrix(d);Tt.GeometryHelper.Transform(m,T),Tt.GeometryHelper.Transform(y,M);var g=0,v=new Tt.Vector3,C=new Tt.Vector3,_=Tt.MeasureCalculateHelper.LineFaceDistance(y,m,g,v,C);if(!_[0])return e=null,a;g=Number(_[1]);var A=y.GetStartPoint(),E=y.GetEndPoint(),G=A.Add(E).Divide(2).Clone(),P=A.Sub(v).Clone();P.Normalize();for(var w=f.Add(P.Multiply(g)),D=G.Sub(P.Multiply(g)),x=w.Add(G).Divide(2),R=f.Add(D).Divide(2),I=Tt.Color.RED(),L=s.LineList,N=0,O=L;N<O.length;N++){var b=O[N];b&&!b.GetCanDelete()||L.splice(L.indexOf(b),1)}var V=new Tt.Vector3;if(!o.GetPickPoint(n,V,!1))return e=null,a;var F=R.Sub(x),B=new Tt.Plane(x,R,V).normal;(B=B.CrossProduct(F)).Normalize();var U=new Tt.Ray(x,F).Project(V);g=U.Sub(V).Length();var H=x.Add(B.Multiply(g)),k=R.Add(B.Multiply(g)),z=new Tt.Line3D(x,H);z.SetCanDelete(!0),z.SetColor(I);var W=new Tt.Line3D(R,k);W.SetCanDelete(!0),W.SetColor(I);var Y=new Tt.Line3D(H,k);Y.SetCanDelete(!0),Y.SetColor(I);var X=null;Tt.MeasureCalculateHelper.pntInSegment(V,H,k,U)||((X=new Tt.Line3D(U,V)).SetCanDelete(!0),X.SetColor(I)),e.AddLine(z),e.AddLine(W),e.AddLine(Y),X&&e.AddLine(X);for(var j=0;j<e.imageBoardList.length;j++)e.imageBoardList[j].SetPosition(V);a=!0}return a},yt.completeDesignerFaceToFaceDistance=function(e,t,r,i,n,o,a){var s=!1;if(!e||!a)return s;var l=e;if(!l)return s;var h=a.GetShape(t),u=a.GetShape(r),p=a.GetShape(i),c=a.GetShape(n);if(h&&u&&p&&c&&h.GetType()==Tt.ShapeType.SHAPE_FACE&&u.GetType()==Tt.ShapeType.SHAPE_FACE&&p.GetType()==Tt.ShapeType.SHAPE_POINT_HANDLE&&c.GetType()==Tt.ShapeType.SHAPE_POINT_HANDLE){var d=h,S=u,f=(d.GetMesh(),S.GetMesh(),p.GetPosition()),m=c.GetPosition(),y=d.GetGeoAttribute(),T=S.GetGeoAttribute();if(null!=y&&y.GetGeoAttrType()==Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_PLANEFACE&&null!=T&&T.GetGeoAttrType()==Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_PLANEFACE){var M=y,g=T,v=Tt.ShapeHelper.GetShapeWorldMatrix(d),C=Tt.ShapeHelper.GetShapeWorldMatrix(S);Tt.GeometryHelper.Transform(M,v),Tt.GeometryHelper.Transform(g,C);var _=0,A=new Tt.Vector3,E=new Tt.Vector3;if(!(_=Tt.MeasureCalculateHelper.FaceFaceDistance(M,g,_,A,E)))return e=null,s;var G=M.GetOrigin(),P=A.Sub(G);P.Normalize();var w=f.Add(P.Multiply(_)),D=m.Sub(P.Multiply(_)),x=f.Add(D).Divide(2),R=m.Add(w).Divide(2),I=new Tt.Vector3;if(!a.GetPickPoint(o,I,!1))return e=null,s;var L=R.Sub(x),N=new Tt.Plane(x,R,I).normal;(N=N.CrossProduct(L)).Normalize();var O=new Tt.Ray(x,L).Project(I);_=O.Sub(I).Length(),w=x.Add(N.Multiply(_)),D=R.Add(N.Multiply(_));for(var b=l.LineList,V=0,F=b;V<F.length;V++){var B=F[V];B&&!B.GetCanDelete()||b.splice(b.indexOf(B),1)}var U=Tt.Color.RED(),H=new Tt.Line3D(x,w);H.SetCanDelete(!0),H.SetColor(U);var k=new Tt.Line3D(R,D);k.SetCanDelete(!0),k.SetColor(U);var z=new Tt.Line3D(w,D);z.SetCanDelete(!0),z.SetColor(U);var W=null;Tt.MeasureCalculateHelper.pntInSegment(I,w,D,O)||((W=new Tt.Line3D(O,I)).SetCanDelete(!0),W.SetColor(U)),e.AddLine(H),e.AddLine(k),e.AddLine(z),W&&e.AddLine(W);for(var Y=0;Y<e.imageBoardList.length;Y++)e.imageBoardList[Y].SetPosition(I);s=!0}}return s},yt.CompleteDistanceMeasure=function(e,t,r,i,n){var o=!1;if(!e||!n)return o;var a=e.GetMeasureType();return a==Tt.Measure.MEASURE_TYPE_PNT_PNT_DISTANCE?o=this.completeDesignerPntToPntDistance(e,t,r,i,n):a==Tt.Measure.MEASURE_TYPE_PNT_LINE_DISTANCE?o=this.completeDesignerPntToLineDistance(e,t,r,i,n):a==Tt.Measure.MEASURE_TYPE_LINE_LINE_DISTANCE?o=this.completeDesignerLineToLineDistance(e,t,r,i,n):a==Tt.Measure.MEASURE_TYPE_SHAFT_SHAFT_DISTANCE?o=this.completeDesignerShaftToShaftDistance(e,t,r,i,n):a==Tt.Measure.MEASURE_TYPE_CENTER_CENTER_DISTANCE?o=this.completeDesignerCenterToCenterDistance(e,t,r,i,n):a==Tt.Measure.MEASURE_TYPE_LINE_LENGTH?o=this.completeDesignerLineDistance(e,t,i,n):a==Tt.Measure.MEASURE_TYPE_CRICLE_PROPERTY&&(o=this.completeDesignerArcDistance(e,t,i,n)),o},yt.completeDesignerPntToPntDistance=function(e,t,r,i,n){var o=!1;if(!e||!n)return o;var a=e;if(!a)return o;var s=n.GetShape(t),l=n.GetShape(r);if(s&&l&&s.GetType()==Tt.ShapeType.SHAPE_POINT_HANDLE&&l.GetType()==Tt.ShapeType.SHAPE_POINT_HANDLE){var h=l,u=s.GetPosition(),p=h.GetPosition(),c=p.Sub(u).Clone(),d=new Tt.Vector3;if(!n.GetPickPoint(i,d,!1))return o;var S=new Tt.Plane(u,p,d).normal;(S=S.CrossProduct(c)).Normalize();for(var f=null,m=a.LineList,y=0,T=m;y<T.length;y++){var M=T[y];if(M&&null!=M.GetName()){if(-1<M.GetName().indexOf("dottedLine")){f=M;continue}}else m.splice(m.indexOf(M),1)}var g=0;if(f){var v=f.GetClosestPoint(d);g=d.Sub(v).Length()}var C=u.Add(S.Multiply(g)),_=p.Add(S.Multiply(g)),A=Tt.Color.RED(),E=new Tt.Line3D(u,C);E.SetColor(A);var G=new Tt.Line3D(p,_);G.SetColor(A);var P=new Tt.Line3D(C,_);P.SetCanDelete(!0),P.SetColor(A);var w=null,D=new Tt.Vector3;if(Tt.MeasureCalculateHelper.pntInSegment(d,C,_,D)||(w=new Tt.Line3D(D,d)).SetColor(A),e.AddLine(E),e.AddLine(G),e.AddLine(P),w&&e.AddLine(w),2!=e.PointList.length){e.PointList.splice(0,e.PointList.length);var x=new Tt.Point(u);x.SetDrawType(1),x.SetSize(.8);var R=new Tt.Point(p);R.SetDrawType(1),R.SetSize(.8),e.AddPoint(x),e.AddPoint(R)}for(var I=0;I<e.imageBoardList.length;I++)e.imageBoardList[I].SetPosition(d);o=!0}return o},yt.completeDesignerPntToLineDistance=function(e,t,r,i,n){var o=!1;if(!e||!n)return o;var a=e;if(!a)return o;var s=n.GetShape(t),l=n.GetShape(r);if(s&&l&&l.GetType()==Tt.ShapeType.SHAPE_POINT_HANDLE&&s.GetType()==Tt.ShapeType.SHAPE_EDGE){var h=l.GetPosition(),u=s,p=(u.GetLineData(),u.GetGeoAttribute());if(p&&p.GetGeoAttrType()==Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_LINE){var c=p,d=Tt.ShapeHelper.GetShapeWorldMatrix(u);Tt.GeometryHelper.Transform(c,d);c.GetStartPoint(),c.GetEndPoint();var S=new Tt.Vector3,f=0;f=Tt.MeasureCalculateHelper.PntLineDistance(h,c,f,0,S);var m=h.Sub(S),y=new Tt.Vector3;if(!n.GetPickPoint(i,y,!1))return o;var T=new Tt.Plane(S,h,y).normal;(T=T.CrossProduct(m)).Normalize();var M=new Tt.Ray(h,m).Project(y);f=M.Sub(y).Length();for(var g=S.Add(T.Multiply(f)),v=h.Add(T.Multiply(f)),C=a.LineList,_=0,A=C;_<A.length;_++){var E=A[_];E&&!E.GetCanDelete()||C.splice(C.indexOf(E),1)}var G=Tt.Color.RED(),P=new Tt.Line3D(S,g);P.SetCanDelete(!0),P.SetColor(G);var w=new Tt.Line3D(h,v);w.SetCanDelete(!0),w.SetColor(G);var D=new Tt.Line3D(g,v);D.SetCanDelete(!0),D.SetColor(G);var x=null;Tt.MeasureCalculateHelper.pntInSegment(y,g,v,M)||((x=new Tt.Line3D(M,y)).SetCanDelete(!0),x.SetColor(G)),e.AddLine(P),e.AddLine(w),e.AddLine(D),x&&e.AddLine(x);for(var R=0;R<e.imageBoardList.length;R++)e.imageBoardList[R].SetPosition(y);o=!0}}return o},yt.completeDesignerLineToLineDistance=function(e,t,r,i,n){var o=!1;if(!e||!n)return o;var a=e;if(!a)return o;var s=n.GetShape(t),l=n.GetShape(r);if(s&&l&&s.GetType()==Tt.ShapeType.SHAPE_EDGE&&l.GetType()==Tt.ShapeType.SHAPE_EDGE){var h=s,u=l,p=(h.GetLineData(),u.GetLineData(),h.GetGeoAttribute()),c=u.GetGeoAttribute();if(null!=p&&p.GetGeoAttrType()==Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_LINE&&null!=c&&c.GetGeoAttrType()==Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_LINE){var d=p,S=c,f=Tt.ShapeHelper.GetShapeWorldMatrix(h),m=Tt.ShapeHelper.GetShapeWorldMatrix(u);Tt.GeometryHelper.Transform(d,f),Tt.GeometryHelper.Transform(S,m);var y=0,T=new Tt.Vector3,M=new Tt.Vector3,g=!0,v=Tt.MeasureCalculateHelper.LineLineDistance(d,S,y,T,M,g);y=v[0],g=v[1];var C=T.Sub(M).Clone(),_=new Tt.Vector3;if(!n.GetPickPoint(i,_,!1))return o;var A=new Tt.Plane(T,M,_).normal;(A=A.CrossProduct(C)).Normalize();var E=new Tt.Ray(T,C).Project(_);y=E.Sub(_).Length();for(var G=T.Sub(A.Multiply(y)),P=M.Sub(A.Multiply(y)),w=a.LineList,D=0;D<w.length;D++){var x=w[D];x&&!x.GetCanDelete()||(w.splice(w.indexOf(x),1),D--)}var R=Tt.Color.RED(),I=new Tt.Line3D(T,G);I.SetCanDelete(!0),I.SetColor(R);var L=new Tt.Line3D(M,P);L.SetCanDelete(!0),L.SetColor(R);var N=new Tt.Line3D(G,P);N.SetCanDelete(!0),N.SetColor(R);var O=null;Tt.MeasureCalculateHelper.pntInSegment(_,G,P,E)||((O=new Tt.Line3D(E,_)).SetCanDelete(!0),O.SetColor(R)),e.AddLine(I),e.AddLine(L),e.AddLine(N),O&&e.AddLine(O);for(D=0;D<e.imageBoardList.length;D++)e.imageBoardList[D].SetPosition(_);o=!0}}return o},yt.completeDesignerShaftToShaftDistance=function(e,t,r,i,n){var o=!1;if(!e||!n)return o;if(!e)return o;var a=n.GetShape(t),s=n.GetShape(r);if(a&&s&&a.GetType()==Tt.ShapeType.SHAPE_EDGE&&s.GetType()==Tt.ShapeType.SHAPE_EDGE){var l=a,h=s,u=(l.GetLineData(),h.GetLineData(),l.GetGeoAttribute()),p=h.GetGeoAttribute();if(null!=u&&u.GetGeoAttrType()==Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_ELLIPSE&&null!=p&&p.GetGeoAttrType()==Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_ELLIPSE){var c=u,d=p,S=Tt.ShapeHelper.GetShapeWorldMatrix(l),f=Tt.ShapeHelper.GetShapeWorldMatrix(h);Tt.GeometryHelper.Transform(c,S),Tt.GeometryHelper.Transform(d,f);var m=c.GetCenterPoint(),y=d.GetCenterPoint(),T=(c.GetMajorRadius(),d.GetMajorRadius(),c.GetStartPoint(),c.GetEndPoint(),new Tt.Vector3);if(!n.GetPickPoint(i,T,!1))return o;for(var M=m,g=0;g<e.PointList.length;g++){var v=e.PointList[g];if(v&&null!=v.GetName()&&-1<v.GetName().indexOf("SpecialPnt")){M=v.GetCoordinate();break}}var C=new Tt.Plane(y,M,T).normal;(C=y.Sub(M).CrossProduct(C)).Normalize();var _=new Tt.Ray(y,y.Sub(M)).Project(T).Sub(T).Length(),A=y.Add(C.Multiply(_)),E=M.Add(C.Multiply(_));this.DeleteMeasureLine(e);var G=Tt.Color.RED(),P=new Tt.Line3D(y,A);P.SetCanDelete(!0),P.SetColor(G);var w=new Tt.Line3D(M,E);w.SetCanDelete(!0),w.SetColor(G);var D=new Tt.Line3D(A,E);D.SetCanDelete(!0),D.SetColor(G);var x=null;Tt.MeasureCalculateHelper.pntInSegment(T,A,E,M)||((x=new Tt.Line3D(M,T)).SetCanDelete(!0),x.SetColor(G)),e.AddLine(P),e.AddLine(w),e.AddLine(D),x&&e.AddLine(x);for(g=0;g<e.imageBoardList.length;g++)e.imageBoardList[g].SetPosition(T);o=!0}}return o},yt.DeleteMeasureLine=function(e){if(e)for(var t=e.LineList,r=0,i=t;r<i.length;r++){var n=i[r];n&&!n.GetCanDelete()||t.splice(t.indexOf(n),1)}},yt.completeDesignerCenterToCenterDistance=function(e,t,r,i,n){var o=!1;if(!e||!n)return o;if(!e)return o;var a=n.GetShape(t),s=n.GetShape(r);if(a&&s&&a.GetType()==Tt.ShapeType.SHAPE_EDGE&&s.GetType()==Tt.ShapeType.SHAPE_EDGE){var l=a,h=s,u=(l.GetLineData(),h.GetLineData(),l.GetGeoAttribute()),p=h.GetGeoAttribute();if(null!=u&&u.GetGeoAttrType()==Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_ELLIPSE&&null!=p&&p.GetGeoAttrType()==Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_ELLIPSE){var c=u,d=p,S=Tt.ShapeHelper.GetShapeWorldMatrix(l),f=Tt.ShapeHelper.GetShapeWorldMatrix(h);Tt.GeometryHelper.Transform(c,S),Tt.GeometryHelper.Transform(d,f);var m=c.GetCenterPoint(),y=d.GetCenterPoint(),T=new Tt.Vector3;if(!n.GetPickPoint(i,T,!1))return o;var M=new Tt.Plane(m,y,T).normal;(M=m.Sub(y).CrossProduct(M)).Normalize();var g=new Tt.Ray(m,m.Sub(y)).Project(T).Sub(T).Length(),v=m.Add(M.Multiply(g)),C=y.Add(M.Multiply(g));this.DeleteMeasureLine(e);var _=Tt.Color.RED(),A=new Tt.Line3D(m,v);A.SetCanDelete(!0),A.SetColor(_);var E=new Tt.Line3D(y,C);E.SetCanDelete(!0),E.SetColor(_);var G=new Tt.Line3D(v,C);G.SetCanDelete(!0),G.SetColor(_);var P=null,w=new Tt.Vector3;Tt.MeasureCalculateHelper.pntInSegment(T,v,C,w)||((P=new Tt.Line3D(w,T)).SetCanDelete(!0),P.SetColor(_)),e.AddLine(A),e.AddLine(E),e.AddLine(G),P&&e.AddLine(P);for(var D=0;D<e.imageBoardList.length;D++)e.imageBoardList[D].SetPosition(T);o=!0}}return o},yt.completeDesignerLineDistance=function(e,t,r,i){var n=!1;if(!e||!i)return n;if(!e)return n;var o=i.GetShape(t);if(o&&o.GetType()==Tt.ShapeType.SHAPE_EDGE){var a=o,s=(a.GetLineData(),a.GetGeoAttribute());if(null!=s&&s.GetGeoAttrType()==Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_LINE){var l=s,h=Tt.ShapeHelper.GetShapeWorldMatrix(a);Tt.GeometryHelper.Transform(l,h);var u=l.GetStartPoint(),p=l.GetEndPoint(),c=new Tt.Vector3;if(!i.GetPickPoint(r,c,!1))return n;var d=new Tt.Plane(u,p,c).normal;(d=u.Sub(p).CrossProduct(d)).Normalize();var S=new Tt.Ray(u,p.Sub(u)).Project(c).Sub(c).Length(),f=u.Add(d.Multiply(S)),m=p.Add(d.Multiply(S));this.DeleteMeasureLine(e);var y=Tt.Color.RED(),T=new Tt.Line3D(u,f);T.SetCanDelete(!0),T.SetColor(y);var M=new Tt.Line3D(p,m);M.SetCanDelete(!0),M.SetColor(y);var g=new Tt.Line3D(f,m);g.SetCanDelete(!0),g.SetColor(y);var v=null,C=new Tt.Vector3;Tt.MeasureCalculateHelper.pntInSegment(c,f,m,C)||((v=new Tt.Line3D(C,c)).SetCanDelete(!0),v.SetColor(y)),e.AddLine(T),e.AddLine(M),e.AddLine(g),v&&e.AddLine(v);for(var _=0;_<e.imageBoardList.length;_++)e.imageBoardList[_].SetPosition(c);n=!0}}return n},yt.completeDesignerArcDistance=function(e,t,r,i){var n=!1;if(!e||!i)return n;if(!e)return n;var o=i.GetShape(t);if(o&&o.GetType()==Tt.ShapeType.SHAPE_EDGE){var a=o,s=a.GetLineData(),l=a.GetGeoAttribute();if(null!=l&&l.GetGeoAttrType()==Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_ELLIPSE){var h=l,u=Tt.ShapeHelper.GetShapeWorldMatrix(a);Tt.GeometryHelper.Transform(h,u),this.DeleteMeasureLine(e);var p=h.GetCenterPoint(),c=h.GetStartPoint(),d=h.GetEndPoint(),S=c.Sub(p).Normalized(),f=d.Sub(p).Normalized(),m=h.GetMajorRadius(),y=s.GetRefLine().GetPoints(),T=s.GetDataOffset(),M=s.GetDataLength(),g=new Tt.Vector3,v=S.Angle(f);if(Math.abs(v-180)<.1){M/=2;var C=u.Multiply(y[T+M]);g=S.CrossProduct(C.Sub(p))}else g=S.CrossProduct(f);var _=new Tt.Plane(g,c),A=i.GetCamera().GetViewPort().GetScreenRay(r.x,r.y),E=new Tt.Vector3,G=(E=_.GetInsectPnt1(A,E)).Sub(p),P=G.Length(),w=p.Add(S.Multiply(P)),D=p.Add(f.Multiply(P)),x=[],R=0;if(Math.abs(v-180)<.1){R=Tt.PI*m;var I=S.Angle(G);Tt.MeasureDisplayHelper.CreateDesignerAngleMark(p,w,p,E,p,P,I,x),Tt.MeasureDisplayHelper.CreateDesignerAngleMark(p,E,p,D,p,P,180-I,x)}else{var L=G.Angle(S),N=G.Angle(f);if(M<3)R=v*Tt.PI*m/180,Math.abs(L-N-v)<.1?Tt.MeasureDisplayHelper.CreateDesignerAngleMark(p,w,p,E,p,P,L,x):Math.abs(N-L-v)<.1?Tt.MeasureDisplayHelper.CreateDesignerAngleMark(p,D,p,E,p,P,N,x):L<v&&N<v&&Tt.MeasureDisplayHelper.CreateDesignerAngleMark(p,w,p,D,p,P,v,x);else{M/=2;C=u.Multiply(y[T+M]);var O=S.Angle(C.Sub(p)),b=f.Angle(C.Sub(p));O<v&&b<v?(R=v*Tt.PI*m/180,Math.abs(L-N-v)<.1?Tt.MeasureDisplayHelper.CreateDesignerAngleMark(p,w,p,E,p,P,L,x):Math.abs(N-L-v)<.1?Tt.MeasureDisplayHelper.CreateDesignerAngleMark(p,D,p,E,p,P,N,x):L<v&&N<v&&Tt.MeasureDisplayHelper.CreateDesignerAngleMark(p,w,p,D,p,P,v,x)):(R=(360-v)*Tt.PI*m/180,N<L&&L<v&&N<v?Tt.MeasureDisplayHelper.CreateDesignerAngleMark(p,w,p,E,p,P,L-360,x):L<=N&&L<v&&N<v?Tt.MeasureDisplayHelper.CreateDesignerAngleMark(p,E,p,D,p,P,N-360,x):(v<L||v<N)&&Tt.MeasureDisplayHelper.CreateDesignerAngleMark(p,w,p,D,p,P,v-360,x))}}if(0<x.length){for(var V=Tt.Color.RED(),F=0;F<x.length-1;F++){var B=new Tt.Line3D(x[F],x[F+1]);B.SetColor(V),B.SetCanDelete(!0),e.AddLine(B)}var U=new Tt.Line3D(c,w);U.SetCanDelete(!0),U.SetColor(V);var H=new Tt.Line3D(d,D);H.SetCanDelete(!0),H.SetColor(V),e.AddLine(U),e.AddLine(H)}if(0==e.imageBoardList.length){var k=[];k.push(R);var z=null;z=Tt.MeasureDisplayHelper.SetMeasureUnit(Tt.Parameters.Instance().measureUnitStyle,k,z);var W=String(k[0].toFixed(3))+z,Y=new Tt.ComText,X=new Tt.CText;X.SetText(W),Y.AddCText(X),e.ComTexts.push(Y);var j=[],K=new Tt.Texts2D;K.setSize(12),K.setTexts("内容"),j.push(K);var q=new Tt.Texts2D;q.setSize(12),q.setTexts(W),j.push(q),Tt.MeasureDisplayHelper.createNoteTextsImageN(i,j,E,e,r)}else e.imageBoardList[0].SetPosition(E);n=!0}}return n},yt.CreateAngleMeasure=function(e,t,r,i,n){var o=null;return null==n||(r==Tt.Measure.MEASURE_TYPE_LINE_LINE_ANGLE?o=this.createLineToLineAngle(e,t,i,n):r==Tt.Measure.MEASURE_TYPE_FACE_FACE_ANGLE?o=this.createFaceToFaceAngle(e,t,i,n):r==Tt.Measure.MEASURE_TYPE_LINE_FACE_ANGLE?o=this.createLineToFaceAngle(e,t,i,n):r==Tt.Measure.MEASURE_TYPE_CURVE_CURVE_ANGLE&&(o=this.createLineToLineAngle(e,t,i,n)),yt.AddMeasureToScene(n,o),o&&o.SetFrontShow(!0)),o},yt.CreateTmpAngleMeasure=function(e,t,r,i,n,o){var a=null;return null==o||(n==Tt.Measure.MEASURE_TYPE_LINE_LINE_ANGLE?a=this.createDesignerLineToLineAngle(e,t,o):n==Tt.Measure.MEASURE_TYPE_FACE_FACE_ANGLE?a=this.createDesignerFaceToFaceAngle(e,t,r,i,o):n==Tt.Measure.MEASURE_TYPE_LINE_FACE_ANGLE&&(a=this.createDesignerLineToFaceAngle(e,t,r,o)),this.AddMeasureToScene(o,a),a&&a.SetFrontShow(!0)),a},yt.createDesignerLineToLineAngle=function(e,t,r){var i=null,n=r.GetShape(e),o=r.GetShape(t),a=!1,s=new Tt.LineAttribute;if(n&&n.GetType()==Tt.ShapeType.SHAPE_EDGE){(i=new Tt.MeasureAngle).SetMeasureType(Tt.Measure.MEASURE_TYPE_LINE_LINE_ANGLE);var l=n,h=(l.GetLineData(),l.GetGeoAttribute());if(h&&h.GetGeoAttrType()==Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_LINE){s=h;var u=Tt.ShapeHelper.GetShapeWorldMatrix(l);Tt.GeometryHelper.Transform(s,u);var p=s.GetStartPoint(),c=s.GetEndPoint(),d=Tt.Color.RED();(C=new Tt.Line3D(p,c)).SetColor(d),i.AddLine(C),(_=new Tt.Point(p)).SetDrawType(1),_.SetSize(.8),(A=new Tt.Point(c)).SetDrawType(1),A.SetSize(.8),i.AddPoint(_),i.AddPoint(A),a=!0}else i=null}if(a&&o&&o.GetType()==Tt.ShapeType.SHAPE_EDGE){if(null==i)return i;var S=o,f=(S.GetLineData(),S.GetGeoAttribute());if(f&&f.GetGeoAttrType()==Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_LINE){var m=f;u=Tt.ShapeHelper.GetShapeWorldMatrix(S);Tt.GeometryHelper.Transform(m,u);var y=0,T=new Tt.Vector3,M=new Tt.Vector3,g=!0,v=Tt.MeasureCalculateHelper.LineLineDistance(s,m,y,T,M,g);if(y=v[0],(g=v[1])||.001<y)return i=null;var C,_,A;p=m.GetStartPoint(),c=m.GetEndPoint(),d=Tt.Color.RED();(C=new Tt.Line3D(p,c)).SetColor(d),i.AddLine(C),(_=new Tt.Point(p)).SetDrawType(1),_.SetSize(.8),(A=new Tt.Point(c)).SetDrawType(1),A.SetSize(.8),i.AddPoint(_),i.AddPoint(A),a=!0}else i=null}return i},yt.createDesignerFaceToFaceAngle=function(e,t,r,i,n){var o=null,a=n.GetShape(e),s=n.GetShape(t),l=n.GetShape(r),h=n.GetShape(i);if(!a||!l||a.GetType()!=Tt.ShapeType.SHAPE_FACE||l.GetType()!=Tt.ShapeType.SHAPE_POINT_HANDLE||s&&s.GetType()==Tt.ShapeType.SHAPE_FACE){if(a&&l&&s&&h&&a.GetType()==Tt.ShapeType.SHAPE_FACE&&l.GetType()==Tt.ShapeType.SHAPE_POINT_HANDLE&&s.GetType()==Tt.ShapeType.SHAPE_FACE&&h.GetType()==Tt.ShapeType.SHAPE_POINT_HANDLE){(o=new Tt.MeasureAngle).SetMeasureType(Tt.Measure.MEASURE_TYPE_FACE_FACE_ANGLE);var u=s,p=(O=(N=a).GetMesh(),u.GetMesh(),b=N.GetGeoAttribute(),u.GetGeoAttribute()),c=(V=l.GetPosition(),h.GetPosition());if(b&&p&&b.GetGeoAttrType()==Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_PLANEFACE&&p.GetGeoAttrType()==Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_PLANEFACE){F=b;var d=p,S=(B=Tt.ShapeHelper.GetShapeWorldMatrix(N),Tt.ShapeHelper.GetShapeWorldMatrix(u));Tt.GeometryHelper.Transform(F,B),Tt.GeometryHelper.Transform(d,S);var f=0;f=Tt.MeasureCalculateHelper.FaceFaceAngle(F,d,f);q=Tt.Color.RED();var m=new Tt.Vector3,y=new Tt.Vector3,T=new Tt.Vector3,M=0;if(Math.abs(f-180)<.001||Math.abs(f)<.001)return o=null;if(Math.abs(f-90)<=.001){var g=(C=new Tt.Plane(F.GetNormal(),V)).Project(c),v=new Tt.Ray(g,d.GetNormal()).Project(V);(j=new Tt.Line3D(g,c)).SetColor(q),(K=new Tt.Line3D(g,v)).SetColor(q),o.AddLine(j),o.AddLine(K),y=v,T=g,M=.5*(m=c).Sub(g).Length(),(w=new Tt.Point(g)).SetDrawType(1),w.SetSize(.8),(D=new Tt.Point(c)).SetDrawType(1),D.SetSize(.8),(x=new Tt.Point(v)).SetDrawType(1),x.SetSize(.8),o.AddPoint(w),o.AddPoint(D),o.AddPoint(x)}else{var C=new Tt.Plane(F.GetNormal(),V),_=new Tt.Plane(d.GetNormal(),c),A=C.Project(c),E=new Tt.Ray(c,d.GetNormal()),G=new Tt.Vector3;if(!C.GetInsectPnt(E,G)&&(E.Define(c,d.GetNormal().Nagative()),!C.GetInsectPnt(E,G)))return o=null;G=C.GetInsectPnt1(E,G);var P=new Tt.Ray(G,A.Sub(G));if(!_.GetInsectPnt(P,G)&&(P.Define(G,G.Sub(A)),!_.GetInsectPnt(P,G)))return o=null;G=_.GetInsectPnt1(P,G);var w,D,x,R=P.Project(V);(j=new Tt.Line3D(c,G)).SetColor(q),(K=new Tt.Line3D(R,G)).SetColor(q),o.AddLine(j),o.AddLine(K),y=R,T=G,M=.5*(m=c).Sub(G).Length(),f=c.Sub(G).Angle(R.Sub(G)),(w=new Tt.Point(c)).SetDrawType(1),w.SetSize(.8),(D=new Tt.Point(G)).SetDrawType(1),D.SetSize(.8),(x=new Tt.Point(R)).SetDrawType(1),x.SetSize(.8),o.AddPoint(w),o.AddPoint(D),o.AddPoint(x)}if(y.Sub(T).Length()<M){(Y=y.Sub(T)).Normalize();var I=T.Add(Y.Multiply(M)),L=new Tt.Line3D(y,I);L.SetColor(q),o.AddLine(L)}Tt.MeasureDisplayHelper.CreateDesignerAngleMark(T,m,T,y,T,M,f,[]),m=m.Add(T).Divide(2)}else o=null}}else{(o=new Tt.MeasureAngle).SetMeasureType(Tt.Measure.MEASURE_TYPE_FACE_FACE_ANGLE);var N,O=(N=a).GetMesh(),b=N.GetGeoAttribute(),V=l.GetPosition();if(b&&b.GetGeoAttrType()==Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_PLANEFACE){var F=b,B=Tt.ShapeHelper.GetShapeWorldMatrix(N);Tt.GeometryHelper.Transform(F,B);var U=0,H=new Tt.Vector3;H=Tt.MeasureCalculateHelper.PntFaceDistance(V,F,U,H)[2];var k=O.GetBoundingBox();U=k.max.Sub(k.min).Length()/20;var z=F.GetNormal(),W=F.GetOrigin(),Y=H.Sub(W),X=[];Tt.MeasureDisplayHelper.CreateSelectFaceMark(X,H,Y,z,U);var j,K,q=Tt.Color.RED();(j=new Tt.Line3D(X[0],X[1])).SetColor(q),(K=new Tt.Line3D(X[2],X[3])).SetColor(q);var Q=new Tt.Line3D(X[0],X[2]);Q.SetColor(q);var Z=new Tt.Line3D(X[3],X[1]);Z.SetColor(q),o.AddLine(j),o.AddLine(K),o.AddLine(Q),o.AddLine(Z);var J=new Tt.Point(V);J.SetDrawType(1),J.SetSize(.8),o.AddPoint(J),!0}else o=null}return o},yt.createDesignerLineToFaceAngle=function(e,t,r,i){var n=null,o=i.GetShape(e),a=i.GetShape(t),s=i.GetShape(r),l=!1,h=!1,u=new Tt.PlaneFaceAttribute,p=new Tt.LineAttribute,c=new Tt.Vector3,d=0;if(o&&s&&o.GetType()==Tt.ShapeType.SHAPE_FACE&&s.GetType()==Tt.ShapeType.SHAPE_POINT_HANDLE){(n=new Tt.MeasureAngle).SetMeasureType(Tt.Measure.MEASURE_TYPE_LINE_FACE_ANGLE);var S=o,f=S.GetMesh(),m=S.GetGeoAttribute();if(c=s.GetPosition(),m&&m.GetGeoAttrType()==Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_PLANEFACE){u=m;var y=Tt.ShapeHelper.GetShapeWorldMatrix(S);Tt.GeometryHelper.Transform(u,y);var T=new Tt.Vector3;T=Tt.MeasureCalculateHelper.PntFaceDistance(c,u,d,T)[2];var M=f.GetBoundingBox();d=M.max.Sub(M.min).Length()/20;var g=u.GetNormal(),v=u.GetOrigin(),C=T.Sub(v),_=[];Tt.MeasureDisplayHelper.CreateSelectFaceMark(_,T,C,g,d);var A=Tt.Color.RED();(B=new Tt.Line3D(_[0],_[1])).SetColor(A);var E=new Tt.Line3D(_[2],_[3]);E.SetColor(A);var G=new Tt.Line3D(_[0],_[2]);G.SetColor(A);var P=new Tt.Line3D(_[3],_[1]);P.SetColor(A),n.AddLine(B),n.AddLine(E),n.AddLine(G),n.AddLine(P);var w=new Tt.Point(c);w.SetDrawType(1),w.SetSize(.8),n.AddPoint(w),l=!0}else n=null}if(l&&!h&&a&&a.GetType()==Tt.ShapeType.SHAPE_EDGE){if(null==n)return n;var D=a,x=(D.GetLineData(),D.GetGeoAttribute());if(x&&x.GetGeoAttrType()==Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_LINE){p=x;y=Tt.ShapeHelper.GetShapeWorldMatrix(D);Tt.GeometryHelper.Transform(p,y);var R=p.GetStartPoint(),I=p.GetEndPoint();A=Tt.Color.RED();(B=new Tt.Line3D(R,I)).SetColor(A),n.AddLine(B),(U=new Tt.Point(R)).SetDrawType(1),U.SetSize(.8);var L=new Tt.Point(I);L.SetDrawType(1),L.SetSize(.8),n.AddPoint(U),n.AddPoint(L),h=!0}else n=null}if(l&&h){var N=0;if(N=Tt.MeasureCalculateHelper.LineFaceAngle(p,u,N),Math.abs(N-180)<.001||Math.abs(N)<.001)return n=null;var O=new Tt.Plane(u.GetNormal(),u.GetOrigin()),b=(R=p.GetStartPoint(),I=p.GetEndPoint(),new Tt.Ray(R,R.Sub(I))),V=new Tt.Vector3,F=new Tt.Vector3;if(!O.GetInsectPnt(b,V)&&(b.Define(R,I.Sub(R)),!O.GetInsectPnt(b,V)))return n=null;V=O.GetInsectPnt1(b,V);var B,U,H=Tt.Color.RED();if(!Tt.MeasureCalculateHelper.pntInSegment(V,R,I,F)){var k=new Tt.Line3D(F,V);k.SetName("dottedLine"),k.SetColor(H),n.AddLine(k)}(B=new Tt.Line3D(c,V)).SetName("dottedLine"),B.SetColor(H),n.AddLine(B),(U=new Tt.Point(V)).SetDrawType(1),U.SetSize(.8),n.AddPoint(U);var z=R.Sub(I).Length();Tt.MeasureDisplayHelper.CreateDesignerAngleMark(V,R.Add(I).Divide(2),V,c,V,z,N,[])}return n},yt.CompleteAngleMeasure=function(e,t,r,i,n,o,a){var s=!1;if(!e||!a)return s;var l=e.GetMeasureType();return l==Tt.Measure.MEASURE_TYPE_LINE_LINE_ANGLE?s=this.completeDesignerLineToLineAngle(e,t,r,o,a):l==Tt.Measure.MEASURE_TYPE_FACE_FACE_ANGLE?s=this.completeDesignerFaceToFaceAngle(e,t,r,i,n,o,a):l==Tt.Measure.MEASURE_TYPE_LINE_FACE_ANGLE&&(s=this.completeDesignerLineToFaceAngle(e,t,r,i,o,a)),s},yt.completeDesignerLineToLineAngle=function(e,t,r,i,n){var o=!1;if(!e||!n)return o;if(!e)return o;var a=n.GetShape(t),s=n.GetShape(r);if(a&&s&&a.GetType()==Tt.ShapeType.SHAPE_EDGE&&s.GetType()==Tt.ShapeType.SHAPE_EDGE){var l=a,h=s,u=(l.GetLineData(),h.GetLineData(),l.GetGeoAttribute()),p=h.GetGeoAttribute();if(null!=u&&u.GetGeoAttrType()==Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_LINE&&null!=p&&p.GetGeoAttrType()==Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_LINE){var c=u,d=p,S=Tt.ShapeHelper.GetShapeWorldMatrix(l),f=Tt.ShapeHelper.GetShapeWorldMatrix(h);Tt.GeometryHelper.Transform(c,S),Tt.GeometryHelper.Transform(d,f);var m=c.GetStartPoint(),y=c.GetEndPoint(),T=m.Add(y).Divide(2),M=d.GetStartPoint(),g=d.GetEndPoint(),v=M.Add(g).Divide(2),C=0,_=new Tt.Vector3,A=new Tt.Vector3,E=!0,G=Tt.MeasureCalculateHelper.LineLineDistance(c,d,C,_,A,E);if(C=G[0],(E=G[1])||.001<C)return e=null,o;this.DeleteMeasureLine(e);var P=T.Sub(_),w=v.Sub(_);P.Normalize(),w.Normalize();var D=n.GetCamera().GetViewPort().GetScreenRay(i.x,i.y),x=new Tt.Plane(m,y,v),R=new Tt.Vector3,I=(R=x.GetInsectPnt1(D,R)).Sub(_),L=I.Length(),N=new Tt.Vector3,O=new Tt.Vector3,b=new Tt.Vector3,V=new Tt.Vector3,F=Tt.Color.RED();if(!Tt.MeasureCalculateHelper.pntInSegment(_,m,y,N))(j=new Tt.Line3D(N,_)).SetCanDelete(!0),j.SetName("dottedLine"),j.SetColor(F),e.AddLine(j);if(!Tt.MeasureCalculateHelper.pntInSegment(_,M,g,O))(j=new Tt.Line3D(O,_)).SetCanDelete(!0),j.SetName("dottedLine"),j.SetColor(F),e.AddLine(j);var B=new Tt.Vector3,U=new Tt.Vector3,H=P.Angle(w),k=I.Angle(P),z=I.Angle(w),W=[];if(k<=H&&z<=H&&Math.abs(k+z-H)<.01){if(Tt.MeasureDisplayHelper.CreateDesignerAngleMark(_,T,_,v,_,L,H,W),B=_.Add(P.Multiply(L)),U=_.Add(w.Multiply(L)),!Tt.MeasureCalculateHelper.pntInSegment(B,m,y,b)&&b!=N)(j=new Tt.Line3D(b,B)).SetCanDelete(!0),j.SetName("dottedLine"),j.SetColor(F),e.AddLine(j);if(!Tt.MeasureCalculateHelper.pntInSegment(U,M,g,V)&&V!=O)(j=new Tt.Line3D(V,U)).SetCanDelete(!0),j.SetName("dottedLine"),j.SetColor(F),e.AddLine(j)}else if(H<k&&z<k&&Math.abs(k-z-H)<.01){if(H=180-H,Tt.MeasureDisplayHelper.CreateDesignerAngleMark(_,v,T,_,_,L,H,W),B=_.Sub(P.Multiply(L)),U=_.Add(w.Multiply(L)),(j=new Tt.Line3D(_,B)).SetCanDelete(!0),j.SetName("dottedLine"),j.SetColor(F),e.AddLine(j),!Tt.MeasureCalculateHelper.pntInSegment(U,M,g,V)&&V!=O){var Y=new Tt.Line3D(V,U);Y.SetCanDelete(!0),Y.SetName("dottedLine"),Y.SetColor(F),e.AddLine(Y)}}else if(H<z&&k<z&&Math.abs(z-k-H)<.01){if(H=180-H,Tt.MeasureDisplayHelper.CreateDesignerAngleMark(_,T,v,_,_,L,H,W),B=_.Add(P.Multiply(L)),U=_.Sub(w.Multiply(L)),!Tt.MeasureCalculateHelper.pntInSegment(B,m,y,b)&&b!=N){var X=new Tt.Line3D(b,B);X.SetCanDelete(!0),X.SetName("dottedLine"),X.SetColor(F),e.AddLine(X)}(j=new Tt.Line3D(_,U)).SetCanDelete(!0),j.SetName("dottedLine"),j.SetColor(F),e.AddLine(j)}else{var j;Tt.MeasureDisplayHelper.CreateDesignerAngleMark(T,_,v,_,_,L,H,W),B=_.Sub(P.Multiply(L)),U=_.Sub(w.Multiply(L)),(j=new Tt.Line3D(_,B)).SetCanDelete(!0),j.SetName("dottedLine"),j.SetColor(F),e.AddLine(j),(j=new Tt.Line3D(_,U)).SetCanDelete(!0),j.SetName("dottedLine"),j.SetColor(F),e.AddLine(j)}if(0<W.length)for(var K=0;K<W.length-1;K++){var q=new Tt.Line3D(W[K],W[K+1]);q.SetColor(F),q.SetCanDelete(!0),e.AddLine(q)}e.imageBoardList.length=0;var Q=String(H.toFixed(0))+"°",Z=new Tt.ComText,J=new Tt.CText;J.SetText(Q),Z.AddCText(J),e.ComTexts.push(Z);var $=[],ee=new Tt.Texts2D;ee.setSize(12),ee.setTexts("内容"),$.push(ee);var te=new Tt.Texts2D;te.setSize(12),te.setTexts(Q),$.push(te),Tt.MeasureDisplayHelper.createNoteTextsImageN(n,$,R,e,i),o=!0}else e=null}return o},yt.completeDesignerFaceToFaceAngle=function(e,t,r,i,n,o,a){var s=!1;if(!e||!a)return s;if(!e)return s;var l=a.GetShape(t),h=a.GetShape(r),u=a.GetShape(i),p=a.GetShape(n);if(l&&h&&u&&p&&l.GetType()==Tt.ShapeType.SHAPE_FACE&&h.GetType()==Tt.ShapeType.SHAPE_FACE&&u.GetType()==Tt.ShapeType.SHAPE_POINT_HANDLE&&p.GetType()==Tt.ShapeType.SHAPE_POINT_HANDLE){var c=l,d=h,S=(c.GetMesh(),d.GetMesh(),c.GetGeoAttribute()),f=d.GetGeoAttribute(),m=u.GetPosition(),y=p.GetPosition();if(S&&f&&S.GetGeoAttrType()==Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_PLANEFACE&&f.GetGeoAttrType()==Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_PLANEFACE){var T=S,M=f,g=Tt.ShapeHelper.GetShapeWorldMatrix(c),v=Tt.ShapeHelper.GetShapeWorldMatrix(d);Tt.GeometryHelper.Transform(T,g),Tt.GeometryHelper.Transform(M,v),this.DeleteMeasureLine(e);var C=0;C=Tt.MeasureCalculateHelper.FaceFaceAngle(T,M,C);var _=new Tt.Vector3,A=new Tt.Vector3,E=new Tt.Vector3;if(Math.abs(C-180)<.001||Math.abs(C)<.001)return e=null,s;if(Math.abs(C-90)<=.001){var G=(P=new Tt.Plane(T.GetNormal(),m)).Project(y);_=y,A=new Tt.Ray(G,M.GetNormal()).Project(m),E=G}else{var P=new Tt.Plane(T.GetNormal(),m),w=new Tt.Plane(M.GetNormal(),y),D=P.Project(y),x=new Tt.Ray(y,M.GetNormal()),R=new Tt.Vector3;if(!P.GetInsectPnt(x,R)&&(x.Define(y,M.GetNormal().Nagative()),!P.GetInsectPnt(x,R)))return e=null,s;R=P.GetInsectPnt1(x,R);var I=new Tt.Ray(R,D.Sub(R));if(!w.GetInsectPnt(I,R)&&(I.Define(R,R.Sub(D)),!w.GetInsectPnt(I,R)))return e=null,s;R=w.GetInsectPnt1(I,R),_=y,A=I.Project(m),E=R}var L=a.GetCamera().GetViewPort().GetScreenRay(o.x,o.y),N=new Tt.Plane(_,A,E),O=new Tt.Vector3,b=(O=N.GetInsectPnt1(L,O)).Sub(E).Length();C=_.Sub(E).Angle(A.Sub(E));var V=Tt.Color.RED();if(A.Sub(E).Length()<b){(B=A.Sub(E)).Normalize();var F=E.Add(B.Multiply(b));(U=new Tt.Line3D(A,F)).SetColor(V),U.SetCanDelete(!0),e.AddLine(U)}if(_.Sub(E).Length()<b){var B;(B=_.Sub(E)).Normalize();var U;F=E.Add(B.Multiply(b));(U=new Tt.Line3D(_,F)).SetColor(V),U.SetCanDelete(!0),e.AddLine(U)}var H=[];if(Tt.MeasureDisplayHelper.CreateDesignerAngleMark(E,_,E,A,E,b,C,H),0<H.length)for(var k=0;k<H.length-1;k++){(Y=new Tt.Line3D(H[k],H[k+1])).SetColor(V),Y.SetCanDelete(!0),e.AddLine(Y)}var z=O.Sub(E).Angle(_.Sub(E)),W=O.Sub(E).Angle(A.Sub(E));if(.001<z-C||.001<W-C){H=[],W<=z?Tt.MeasureDisplayHelper.CreateDesignerAngleMark(E,A,E,O,E,b,W,H):Tt.MeasureDisplayHelper.CreateDesignerAngleMark(E,_,E,O,E,b,z,H);for(k=0;k<H.length-1;k++){var Y;(Y=new Tt.Line3D(H[k],H[k+1])).SetColor(V),Y.SetCanDelete(!0),e.AddLine(Y)}}var X=String(C.toFixed(0))+"°",j=new Tt.ComText,K=new Tt.CText;K.SetText(X),j.AddCText(K),e.ComTexts.push(j);var q=[],Q=new Tt.Texts2D;Q.setSize(12),Q.setTexts("内容"),q.push(Q);var Z=new Tt.Texts2D;Z.setSize(12),Z.setTexts(X),q.push(Z),Tt.MeasureDisplayHelper.createNoteTextsImageN(a,q,O,e,o),s=!(e.imageBoardList.length=0)}else e=null}return s},yt.completeDesignerLineToFaceAngle=function(e,t,r,i,n,o){var a=!1;if(!e||!o)return a;if(!e)return a;var s=o.GetShape(t),l=o.GetShape(r),h=o.GetShape(i);if(s&&l&&h&&s.GetType()==Tt.ShapeType.SHAPE_FACE&&l.GetType()==Tt.ShapeType.SHAPE_EDGE&&h.GetType()==Tt.ShapeType.SHAPE_POINT_HANDLE){var u=s,p=(u.GetMesh(),u.GetGeoAttribute()),c=l,d=(c.GetLineData(),c.GetGeoAttribute()),S=h.GetPosition();if(p&&d&&p.GetGeoAttrType()==Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_PLANEFACE&&d.GetGeoAttrType()==Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_LINE){var f=p,m=d,y=Tt.ShapeHelper.GetShapeWorldMatrix(u),T=Tt.ShapeHelper.GetShapeWorldMatrix(c);Tt.GeometryHelper.Transform(f,y),Tt.GeometryHelper.Transform(m,T),this.DeleteMeasureLine(e);var M=new Tt.Plane(f.GetNormal(),f.GetOrigin()),g=m.GetStartPoint(),v=m.GetEndPoint(),C=g.Add(v).Divide(2),_=new Tt.Ray(g,g.Sub(v)),A=new Tt.Vector3;new Tt.Vector3;if(!M.GetInsectPnt(_,A)&&(_.Define(g,v.Sub(g)),!M.GetInsectPnt(_,A)))return e=null,a;A=M.GetInsectPnt1(_,A);var E=o.GetCamera().GetViewPort().GetScreenRay(n.x,n.y),G=new Tt.Plane(S,C,A),P=new Tt.Vector3,w=(P=G.GetInsectPnt1(E,P)).Sub(A).Length(),D=S.Sub(A).Angle(C.Sub(A)),x=g.Sub(A).Length(),R=v.Sub(A).Length(),I=S.Sub(A).Length(),L=Tt.Color.RED();if(x<w&&R<w){(b=C.Sub(A)).Normalize();var N=A.Add(b.Multiply(w)),O=null;(O=R<x?new Tt.Line3D(g,N):new Tt.Line3D(v,N)).SetName("dottedLine"),O.SetColor(L),O.SetCanDelete(!0),e.AddLine(O)}if(I<w){var b;(b=S.Sub(A)).Normalize();N=A.Add(b.Multiply(w));(O=new Tt.Line3D(S,N)).SetName("dottedLine"),O.SetColor(L),O.SetCanDelete(!0),e.AddLine(O)}var V=[];if(Tt.MeasureDisplayHelper.CreateDesignerAngleMark(A,S,A,C,A,w,D,V),0<V.length)for(var F=0;F<V.length-1;F++){(H=new Tt.Line3D(V[F],V[F+1])).SetColor(L),H.SetCanDelete(!0),e.AddLine(H)}var B=P.Sub(A).Angle(S.Sub(A)),U=P.Sub(A).Angle(C.Sub(A));if(.001<B-D||.001<U-D){V=[],U<=B?Tt.MeasureDisplayHelper.CreateDesignerAngleMark(A,C,A,P,A,w,U,V):Tt.MeasureDisplayHelper.CreateDesignerAngleMark(A,S,A,P,A,w,B,V);for(F=0;F<V.length-1;F++){var H;(H=new Tt.Line3D(V[F],V[F+1])).SetColor(L),H.SetCanDelete(!0),e.AddLine(H)}}var k=String(D.toFixed(0))+"°",z=new Tt.ComText,W=new Tt.CText;W.SetText(k),z.AddCText(W),e.ComTexts.push(z);var Y=[],X=new Tt.Texts2D;X.setSize(12),X.setTexts("内容"),Y.push(X);var j=new Tt.Texts2D;j.setSize(12),j.setTexts(k),Y.push(j),Tt.MeasureDisplayHelper.createNoteTextsImageN(o,Y,P,e,n),a=!(e.imageBoardList.length=0)}else e=null}return a},yt.CreateCurveAngleMeasure=function(e,t,r,i,n,o,a){var s=null;return null==a||(n==Tt.Measure.MEASURE_TYPE_CURVE_CURVE_ANGLE&&(s=this.createCurveToCurveAngle(e,t,r,i,o,a)),yt.AddMeasureToScene(a,s),s&&s.SetFrontShow(!0)),s},yt.CreatePropertyMeasure=function(e,t,r,i){var n=null;return null==i||(t==Tt.Measure.MEASURE_TYPE_PNT_COORD?n=this.createPntProperty(e,r,i):t==Tt.Measure.MEASURE_TYPE_LINE_LENGTH?n=this.createLineProperty(e,r,i):t==Tt.Measure.MEASURE_TYPE_CRICLE_PROPERTY?n=this.createCircleProperty(e,r,i):t==Tt.Measure.MEASURE_TYPE_FACE_PROPERTY?n=this.createFaceProperty(e,r,i):t==Tt.Measure.MEASURE_TYPE_APERTURE_PROPERTY||t==Tt.Measure.MEASURE_TYPE_MODEL_PROPERTY&&(n=this.createModelProperty(e,r,i)),yt.AddMeasureToScene(i,n),n&&n.SetFrontShow(!0)),n},yt.CreateFaceDistanceMeasure=function(e,t,r,i,n,o,a){var s=null;return null==a||(n==Tt.Measure.MEASURE_TYPE_FACE_FACE_DISTANCE&&(s=this.createFaceToFaceDistance(e,t,r,i,o,a)),yt.AddMeasureToScene(a,s),s&&s.SetFrontShow(!0)),s},yt.CreateTmpFaceDistanceMeasure=function(e,t,r,i,n,o,a){var s=null;return null==o||(n==Tt.Measure.MEASURE_TYPE_PNT_FACE_DISTANCE?s=this.createDesignerPntToFaceDistance(e,t,r,o,a):n==Tt.Measure.MEASURE_TYPE_LINE_FACE_DISTANCE?s=this.createDesignerLineToFaceDistance(e,t,r,o,a):n==Tt.Measure.MEASURE_TYPE_FACE_FACE_DISTANCE&&(s=this.createDesignerFaceToFaceDistance(e,t,r,i,o,a)),this.AddMeasureToScene(o,s),s&&s.SetFrontShow(!0)),s},yt.createDesignerPntToFaceDistance=function(e,t,r,i,n){var o=null,a=i.GetShape(e),s=i.GetShape(t),l=i.GetShape(r);if(a&&l&&a.GetType()==Tt.ShapeType.SHAPE_FACE&&l.GetType()==Tt.ShapeType.SHAPE_POINT_HANDLE){(o=new Tt.MeasureDistance).SetMeasureType(Tt.Measure.MEASURE_TYPE_PNT_FACE_DISTANCE);var h=a,u=h.GetMesh(),p=h.GetGeoAttribute(),c=l.GetPosition();if(!p||p.GetGeoAttrType()!=Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_PLANEFACE)return o=null;var d=p,S=(u.GetRefMesh().GetPositionArray(),Tt.ShapeHelper.GetShapeWorldMatrix(h));Tt.GeometryHelper.Transform(d,S);var f=0,m=new Tt.Vector3;Tt.MeasureCalculateHelper.PntFaceDistance(c,d,f,m);var y=u.GetBoundingBox();f=y.max.Sub(y.min).Length()/20;var T=d.GetNormal(),M=d.GetOrigin(),g=m.Sub(M),v=[];Tt.MeasureDisplayHelper.CreateSelectFaceMark(v,m,g,T,f);var C=Tt.Color.RED(),_=new Tt.Line3D(v[0],v[1]);_.SetColor(C);var A=new Tt.Line3D(v[2],v[3]);A.SetColor(C);var E=new Tt.Line3D(v[0],v[2]);E.SetColor(C);var G=new Tt.Line3D(v[3],v[1]);G.SetColor(C),o.AddLine(_),o.AddLine(A),o.AddLine(E),o.AddLine(G);var P=new Tt.Point(c);if(P.SetDrawType(1),P.SetSize(.8),o.AddPoint(P),s&&s.GetType()==Tt.ShapeType.SHAPE_POINT_HANDLE){var w=s.GetPosition(),D=new Tt.Plane(T,M).Project(w),x=w.Sub(D).Length(),R=w.Sub(D);R.Normalize();var I=c.Add(R.Multiply(x)),L=Tt.Color.RED(),N=new Tt.Line3D(w,D);N.SetName("dottedLine"),N.SetColor(L);var O=new Tt.Line3D(c,I);O.SetName("dottedLine"),O.SetColor(L);var b=new Tt.Line3D(c,D);b.SetColor(L);var V=new Tt.Line3D(w,I);V.SetColor(L),o.AddLine(N),o.AddLine(O),o.AddLine(b),o.AddLine(V);var F=new Tt.Point(w);F.SetDrawType(1),F.SetSize(.8),o.AddPoint(F);var B=[];B.push(x);var U=null;U=Tt.MeasureDisplayHelper.SetMeasureUnit(Tt.Parameters.Instance().measureUnitStyle,B,U);var H=String(B[0].toFixed(3))+U,k=new Tt.ComText,z=new Tt.CText;z.SetText(H),k.AddCText(z),o.ComTexts.push(k);var W=new Tt.Vector3;W=w.Add(D).Divide(2);var Y=[],X=new Tt.Texts2D;X.setSize(12),X.setTexts("内容"),Y.push(X);var j=new Tt.Texts2D;j.setSize(12),j.setTexts(H),Y.push(j),Tt.MeasureDisplayHelper.createNoteTextsImageN(i,Y,W,o,n)}}return o},yt.createDesignerLineToFaceDistance=function(e,t,r,i,n){var o=null,a=i.GetShape(e),s=i.GetShape(t),l=i.GetShape(r),h=!1,u=!1,p=new Tt.Vector3,c=(new Tt.Vector3,new Tt.Vector3,new Tt.PlaneFaceAttribute),d=new Tt.LineAttribute;if(a&&l&&a.GetType()==Tt.ShapeType.SHAPE_FACE&&l.GetType()==Tt.ShapeType.SHAPE_POINT_HANDLE){(o=new Tt.MeasureDistance).SetMeasureType(Tt.Measure.MEASURE_TYPE_LINE_FACE_DISTANCE);var S=a,f=S.GetMesh(),m=S.GetGeoAttribute();if(p=l.GetPosition(),m&&m.GetGeoAttrType()==Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_PLANEFACE){c=m;f.GetRefMesh().GetPositionArray();var y=Tt.ShapeHelper.GetShapeWorldMatrix(S);Tt.GeometryHelper.Transform(c,y);var T=0,M=new Tt.Vector3;M=(N=Tt.MeasureCalculateHelper.PntFaceDistance(p,c,T,M))[2];var g=f.GetBoundingBox();T=g.max.Sub(g.min).Length()/20;var v=c.GetNormal(),C=c.GetOrigin();v;var _=M.Sub(C).Clone(),A=[];Tt.MeasureDisplayHelper.CreateSelectFaceMark(A,M,_,v,T);var E=Tt.Color.RED();(F=new Tt.Line3D(A[0],A[1])).SetColor(E),(B=new Tt.Line3D(A[2],A[3])).SetColor(E),(U=new Tt.Line3D(A[0],A[2])).SetColor(E),(H=new Tt.Line3D(A[3],A[1])).SetColor(E),o.AddLine(F),o.AddLine(B),o.AddLine(U),o.AddLine(H);var G=new Tt.Point(p);G.SetDrawType(1),G.SetSize(.8),o.AddPoint(G),h=!0}else o=null}if(h&&!u&&s&&s.GetType()==Tt.ShapeType.SHAPE_EDGE){if(null==o)return o;var P=s,w=(P.GetLineData(),P.GetGeoAttribute());if(w&&w.GetGeoAttrType()==Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_LINE){d=w;y=Tt.ShapeHelper.GetShapeWorldMatrix(P);Tt.GeometryHelper.Transform(d,y);T=0;var D=new Tt.Vector3,x=new Tt.Vector3,R=Tt.MeasureCalculateHelper.LineFaceDistance(d,c,T,D,x);if(!R[0])return o=null;T=Number(R[1]);var I=d.GetStartPoint(),L=d.GetEndPoint();I.Add(L).Divide(2);E=Tt.Color.RED();(F=new Tt.Line3D(I,L)).SetColor(E),o.AddLine(F),(X=new Tt.Point(I)).SetDrawType(1),X.SetSize(.8),(j=new Tt.Point(L)).SetDrawType(1),j.SetSize(.8),o.AddPoint(X),o.AddPoint(j),u=!0}else o=null}if(h&&u){if(null==o)return o;var N;T=0,D=new Tt.Vector3,x=new Tt.Vector3;if(!(N=Tt.MeasureCalculateHelper.LineFaceDistance(d,c,T,D,x))[0])return o=null;T=Number(N[1]);var O=d.GetStartPoint(),b=d.GetEndPoint(),V=O.Add(b).Divide(2);(v=O.Sub(D)).Normalize();var F,B,U,H,k=p.Add(v.Multiply(T)),z=V.Sub(v.Multiply(T)),W=k.Add(V).Divide(2),Y=p.Add(z).Divide(2);E=Tt.Color.RED();(F=new Tt.Line3D(p,k)).SetName("dottedLine"),F.SetColor(E),(B=new Tt.Line3D(p,z)).SetColor(E),(U=new Tt.Line3D(V,z)).SetName("dottedLine"),U.SetColor(E),(H=new Tt.Line3D(V,k)).SetColor(E);var X,j,K=new Tt.Line3D(W,Y);K.SetName("dottedLine"),K.SetColor(E),o.AddLine(F),o.AddLine(B),o.AddLine(U),o.AddLine(H),o.AddLine(K),(X=new Tt.Point(W)).SetDrawType(1),X.SetSize(.8),(j=new Tt.Point(Y)).SetDrawType(1),j.SetSize(.8),o.AddPoint(X),o.AddPoint(j);var q=[];q.push(T);var Q=null;Q=Tt.MeasureDisplayHelper.SetMeasureUnit(Tt.Parameters.Instance().measureUnitStyle,q,Q);var Z=String(q[0].toFixed(3))+Q,J=new Tt.ComText,$=new Tt.CText;$.SetText(Z),J.AddCText($),o.ComTexts.push(J);var ee=new Tt.Vector3;ee=W.Add(Y).Divide(2);var te=[],re=new Tt.Texts2D;re.setSize(12),re.setTexts("内容"),te.push(re);var ie=new Tt.Texts2D;ie.setSize(12),ie.setTexts(Z),te.push(ie);Tt.MeasureDisplayHelper.createNoteTextsImageN(i,te,ee,o,n)}return o},yt.createDesignerFaceToFaceDistance=function(e,t,r,i,n,o){var a=null,s=n.GetShape(e),l=n.GetShape(t),h=n.GetShape(r),u=n.GetShape(i),p=!1,c=!1,d=new Tt.PlaneFaceAttribute,S=new Tt.PlaneFaceAttribute,f=new Tt.Vector3,m=new Tt.Vector3;if(s&&h&&s.GetType()==Tt.ShapeType.SHAPE_FACE&&h.GetType()==Tt.ShapeType.SHAPE_POINT_HANDLE){(a=new Tt.MeasureDistance).SetMeasureType(Tt.Measure.MEASURE_TYPE_FACE_FACE_DISTANCE);var y=s,T=y.GetMesh(),M=y.GetGeoAttribute();if(f=h.GetPosition(),M&&M.GetGeoAttrType()==Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_PLANEFACE){d=M;var g=Tt.ShapeHelper.GetShapeWorldMatrix(y);Tt.GeometryHelper.Transform(d,g);var v=0,C=new Tt.Vector3;Tt.MeasureCalculateHelper.PntFaceDistance(f,d,v,C),v=(R=T.GetBoundingBox()).max.Sub(R.min).Length()/20;var _=d.GetNormal(),A=d.GetOrigin(),E=C.Sub(A),G=[];Tt.MeasureDisplayHelper.CreateSelectFaceMark(G,C,E,_,v);var P=Tt.Color.RED();(O=new Tt.Line3D(G[0],G[1])).SetColor(P),(b=new Tt.Line3D(G[2],G[3])).SetColor(P),(V=new Tt.Line3D(G[0],G[2])).SetColor(P),(F=new Tt.Line3D(G[3],G[1])).SetColor(P),a.AddLine(O),a.AddLine(b),a.AddLine(V),a.AddLine(F),(I=new Tt.Point(f)).SetDrawType(1),I.SetSize(.8),a.AddPoint(I),p=!0}else a=null}if(p&&l&&u&&l.GetType()==Tt.ShapeType.SHAPE_FACE&&u.GetType()==Tt.ShapeType.SHAPE_POINT_HANDLE){if(null==a)return a;var w=l,D=w.GetMesh(),x=w.GetGeoAttribute();if(m=u.GetPosition(),e!=t&&x&&x.GetGeoAttrType()==Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_PLANEFACE){S=x;g=Tt.ShapeHelper.GetShapeWorldMatrix(w);Tt.GeometryHelper.Transform(S,g);var R;v=0,C=new Tt.Vector3;Tt.MeasureCalculateHelper.PntFaceDistance(m,S,v,C),v=(R=D.GetBoundingBox()).max.Sub(R.min).Length()/20;_=S.GetNormal(),A=S.GetOrigin(),E=C.Sub(A),G=[];Tt.MeasureDisplayHelper.CreateSelectFaceMark(G,C,E,_,v);var I;P=Tt.Color.RED();(O=new Tt.Line3D(G[0],G[1])).SetColor(P),(b=new Tt.Line3D(G[2],G[3])).SetColor(P),(V=new Tt.Line3D(G[0],G[2])).SetColor(P),(F=new Tt.Line3D(G[3],G[1])).SetColor(P),a.AddLine(O),a.AddLine(b),a.AddLine(V),a.AddLine(F),(I=new Tt.Point(m)).SetDrawType(1),I.SetSize(.8),a.AddPoint(I),c=!0}else a=null}if(p&&c){if(null==a)return a;v=0;var L=new Tt.Vector3,N=new Tt.Vector3;if(!(v=Tt.MeasureCalculateHelper.FaceFaceDistance(d,S,v,L,N)))return a=null;A=d.GetOrigin();(E=L.Sub(A)).Normalize();var O,b,V,F,B=f.Add(E.Multiply(v)),U=m.Sub(E.Multiply(v)),H=f.Add(U).Divide(2),k=m.Add(B).Divide(2);P=Tt.Color.RED();(O=new Tt.Line3D(f,B)).SetName("dottedLine"),O.SetColor(P),(b=new Tt.Line3D(m,U)).SetName("dottedLine"),b.SetColor(P),(V=new Tt.Line3D(f,U)).SetColor(P),(F=new Tt.Line3D(m,B)).SetColor(P);var z=new Tt.Line3D(H,k);z.SetName("dottedLine"),z.SetColor(P),a.AddLine(O),a.AddLine(b),a.AddLine(V),a.AddLine(F),a.AddLine(z);var W=new Tt.Point(H);W.SetDrawType(1),W.SetSize(.8);var Y=new Tt.Point(k);Y.SetDrawType(1),Y.SetSize(.8),a.AddPoint(W),a.AddPoint(Y);var X=[];X.push(v);var j=null;j=Tt.MeasureDisplayHelper.SetMeasureUnit(Tt.Parameters.Instance().measureUnitStyle,X,j);var K=String(X[0].toFixed(3))+j,q=new Tt.ComText,Q=new Tt.CText;Q.SetText(K),q.AddCText(Q),a.ComTexts.push(q);var Z=new Tt.Vector3;Z=H.Add(k).Divide(2);var J=[],$=new Tt.Texts2D;$.setSize(12),$.setTexts("内容"),J.push($);var ee=new Tt.Texts2D;ee.setSize(12),ee.setTexts(K),J.push(ee),Tt.MeasureDisplayHelper.createNoteTextsImageN(n,J,Z,a,o)}return a},yt.CreateFaceAngleMeasure=function(e,t,r,i,n,o,a){var s=null;return null==a||(n==Tt.Measure.MEASURE_TYPE_FACE_FACE_ANGLE?s=this.createFaceToFaceAngle(e,t,r,i,o,a):n==Tt.Measure.MEASURE_TYPE_LINE_FACE_ANGLE&&(s=this.createLineToFaceAngle(e,t,r,i,o,a)),yt.AddMeasureToScene(a,s),s&&s.SetFrontShow(!0)),s},yt.GetMeasureProperty=function(e,t,r,i){return t==Tt.Measure.MEASURE_TYPE_PNT_COORD?this.GetPntProperty(e,r,i):t==Tt.Measure.MEASURE_TYPE_LINE_LENGTH||t==Tt.Measure.MEASURE_TYPE_CRICLE_PROPERTY?this.GetLineProperty(e,r,i):t==Tt.Measure.MEASURE_TYPE_FACE_PROPERTY?this.GetFaceProperty(e,r,i):t==Tt.Measure.MEASURE_TYPE_MODEL_PROPERTY?this.GetModelProperty(e,r,i):void 0},yt.CreatePntToPntDistance=function(e,t,r,i){var n=null,o=i.GetShape(e),a=i.GetShape(t);if(o&&a&&o.GetType()===Tt.ShapeType.SHAPE_POINT_HANDLE&&a.GetType()===Tt.ShapeType.SHAPE_POINT_HANDLE){(n=new Tt.MeasureDistance).SetMeasureType(Tt.Measure.MEASURE_TYPE_PNT_PNT_DISTANCE);var s=a,l=o.GetPosition().Clone(),h=s.GetPosition().Clone(),u=l.Sub(h).Length(),p=i.GetCamera().GetViewPort().GetScreenRay(r.x,r.y),c=l.Add(h).Multiply(.5),d=new Tt.Plane(p.GetDirection(),c).Project(p.GetOrigin()),S=new Tt.Line3D(l,h);Tt.Color.BLACK().Clone();S.SetColor(yt.MeasureColor1().Clone());var f=new Tt.Line3D(c,d);f.SetColor(yt.LeaderColor().Clone()),f.SetName("MeasureImageLeader");var m=new Array;m.push(u);var y="";y=Tt.MeasureDisplayHelper.SetMeasureUnit(Tt.Parameters.Instance().measureUnitStyle,m,y);i.GetSceneBox().Length();var T=new Tt.Point(l);T.SetDrawType(1),T.SetSize(.8);var M=new Tt.Point(h);M.SetDrawType(1),M.SetSize(.8),n.AddLine(S),n.AddLine(f),n.AddPoint(T),n.AddPoint(M);var g=new Tt.Shape2DSet,v=new Tt.Vector2(1,1),C=new Tt.Vector2(250,100),_=(Tt.Color.GRAY().Clone(),Tt.Color.WHITE().Clone()),A=Tt.Color.BLACK().Clone();Tt.Color.GREEN().Clone(),Tt.Color.RED().Clone(),Tt.Color.BLUE().Clone();Tt.MeasureDisplayHelper.createRectImage(g,v,C,450,yt.MeasureColor1().Clone(),_,_,A,"点点距离",m[0].toFixed(3).toString()+y,40,!0);Tt.MeasureDisplayHelper.addImageToMemory(i,null,g,d,7,1.5,n)}else Tt.LOGE("MeasureFactory.createPntToPntDistance shape is null");return n},yt.createPntToLineDistance=function(e,t,r,i){var n=new Tt.Measure,o=i.GetShape(e),a=i.GetShape(t);if(o&&a&&o.GetType()==Tt.ShapeType.SHAPE_POINT_HANDLE&&a.GetType()==Tt.ShapeType.SHAPE_EDGE){(n=new Tt.MeasureDistance).SetMeasureType(Tt.Measure.MEASURE_TYPE_PNT_LINE_DISTANCE);var s=o,l=a,h=l.GetLineData(),u=l.GetGeoAttribute();if(null!=u&&u.GetGeoAttrType()==Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_LINE){var p=u,c=Tt.ShapeHelper.GetShapeWorldMatrix(l);Tt.GeometryHelper.Transform(p,c);var d=s.GetPosition(),S=void 0,f=void 0,m=void 0,y=void 0,T=new Tt.Vector3;S=Tt.MeasureCalculateHelper.PntLineDistance(d,p,S,y,T);var M=p.GetStartPoint(),g=p.GetEndPoint(),v=d.Sub(M).Length(),C=d.Sub(g).Length(),_=new Tt.Vector3,A=new Tt.Vector3;C<v?(m=v,f=C,_=M.Clone(),A=g.Clone()):(m=C,f=v,A=M.Clone(),_=g.Clone());var E=i.GetCamera().GetViewPort().GetScreenRay(r.x,r.y),G=new Tt.Plane(E.GetDirection(),M.Add(g).Divide(2)).Project(E.GetOrigin()),P=new Tt.Line3D(M,g);Tt.Color.GREEN().Clone();P.SetColor(yt.SelectColor().Clone());var w=M.Add(g).Divide(2);(de=new Tt.Point(d)).SetDrawType(1),de.SetSize(.8);var D=new Tt.Line3D(d,T);Tt.Color.BLACK().Clone();D.SetColor(yt.MeasureColor1().Clone()),(Se=new Tt.Point(T)).SetDrawType(1),Se.SetSize(.8);var x=new Tt.Line3D(_,d);Tt.Color.RED().Clone();x.SetColor(yt.MeasureColor2().Clone());var R=new Tt.Line3D(A,d);Tt.Color.BLUE().Clone();R.SetColor(yt.MeasureColor3().Clone());var I=null;if(!Tt.MeasureCalculateHelper.pntInSegment(T,p)){I=new Tt.Line3D(A,T);Tt.Color.BLACK().Clone();I.SetColor(yt.ExLineColor().Clone()),I.SetName("exLine")}var L=new Tt.Line3D(T.Add(d).Divide(2),G);L.SetName("MeasureImageLeader"),L.SetColor(yt.LeaderColor().Clone());i.GetSceneBox().Length();n.AddLine(P),n.AddLine(L),n.AddLine(x),n.AddLine(R),n.AddLine(D),I&&n.AddLine(I),n.AddPoint(de),n.AddPoint(Se);var N="投影距离";(fe=new Array).push(S),fe.push(m),fe.push(f);var O="";O=Tt.MeasureDisplayHelper.SetMeasureUnit(Tt.Parameters.Instance().measureUnitStyle,fe,O);var b=String(fe[0].toFixed(3))+O,V=String(fe[1].toFixed(3))+O,F=String(fe[2].toFixed(3))+O,B=new Tt.ComText;(me=new Tt.CText).SetText(b),B.AddCText(me),n.ComTexts.push(B);var U=new Tt.ComText,H=new Tt.CText;H.SetText(V),U.AddCText(H),n.ComTexts.push(U);var k=new Tt.ComText,z=new Tt.CText;z.SetText(F),k.AddCText(z),n.ComTexts.push(k);var W=new Tt.Shape2DSet,Y=40,X=new Tt.Vector2(1,1),j=new Tt.Vector2(350,100),K=450,q=(Tt.Color.GRAY().Clone(),Tt.Color.WHITE().Clone()),Q=Tt.Color.BLACK().Clone();Tt.Color.GREEN().Clone(),Tt.Color.RED().Clone(),Tt.Color.BLUE().Clone();Tt.MeasureDisplayHelper.createRectImage(W,X,j,K,yt.MeasureColor1().Clone(),q,q,Q,N,b,Y,!1);var Z=new Tt.Vector2(1,100),J=new Tt.Vector2(350,200);Tt.MeasureDisplayHelper.createRectImage(W,Z,J,K,yt.MeasureColor2().Clone(),q,q,Q,"端点最大距离",V,Y,!1);var $=new Tt.Vector2(1,200),ee=new Tt.Vector2(350,300);Tt.MeasureDisplayHelper.createRectImage(W,$,ee,K,yt.MeasureColor3().Clone(),q,q,Q,"端点最小距离",F,Y,!0);var te=null;Tt.MeasureDisplayHelper.addImageToMemory(i,te,W,G,(350+K)/100,4.5,n)}else if(null!=u&&u.GetGeoAttrType()==Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_ELLIPSE){Tt.LOGI("point to circle distance");Tt.Color.GRAY().Clone(),q=Tt.Color.WHITE().Clone(),Q=Tt.Color.BLACK().Clone(),Tt.Color.GREEN().Clone(),Tt.Color.RED().Clone(),Tt.Color.BLUE().Clone();var re=u;c=Tt.ShapeHelper.GetShapeWorldMatrix(l);Tt.GeometryHelper.Transform(re,c);d=s.GetPosition(),S=void 0,y=void 0,T=new Tt.Vector3;S=Tt.MeasureCalculateHelper.PntLineDistance(d,re,S,y,T,c,h);M=re.GetStartPoint(),g=re.GetEndPoint(),E=i.GetCamera().GetViewPort().GetScreenRay(r.x,r.y),G=new Tt.Plane(E.GetDirection(),M.Add(g).Divide(2)).Clone().Project(E.GetOrigin());(P=new Tt.Line3D(T,d)).SetColor(yt.MeasureColor1().Clone());w=T.Add(d).Divide(2).Clone();(ce=new Tt.Line3D(w,G)).SetName("MeasureImageLeader"),ce.SetColor(yt.LeaderColor().Clone()),(de=new Tt.Point(d)).SetDrawType(1),de.SetSize(.8),(Se=new Tt.Point(T)).SetDrawType(1),Se.SetSize(.8),n.AddPoint(Se);N="点线距离";for(var ie=250,ne=(i.GetSceneBox().Length(),h.GetRefLine().GetPoints()),oe=h.GetDataOffset(),ae=h.GetDataLength(),se=oe;se<ae;se+=2){var le=new Tt.Line3D(c.Multiply(ne[se]),c.Multiply(ne[se+1]));Tt.Color.GREEN().Clone();le.SetColor(yt.SelectColor().Clone()),n.AddLine(le)}n.AddLine(P),n.AddLine(ce),n.AddPoint(de),(fe=new Array).push(S);O=void 0;O=Tt.MeasureDisplayHelper.SetMeasureUnit(Tt.Parameters.Instance().measureUnitStyle,fe,O);var he=String(fe[0].toFixed(3))+O;B=new Tt.ComText;(me=new Tt.CText).SetText(he),B.AddCText(me),n.ComTexts.push(B);W=new Tt.Shape2DSet,Y=40,X=new Tt.Vector2(1,1),j=new Tt.Vector2(ie,100),K=450;Tt.MeasureDisplayHelper.createRectImage(W,X,j,K,yt.MeasureColor1().Clone(),q,q,Q,"点线距离",he,Y,!0);te=null;Tt.MeasureDisplayHelper.addImageToMemory(i,te,W,G,(K+ie)/100,1.5,n)}else{Tt.LOGI("point to polyline distance");d=s.GetPosition();var ue=Tt.ShapeHelper.GetShapeWorldMatrix(l),pe=ue.Inverse().Multiply(d).Clone();S=void 0,A=new Tt.Vector3;S=Tt.MeasureCalculateHelper.PntLineDistance(h,pe,S,A),A=ue.Multiply(A).Clone();var ce,de,Se,fe;E=i.GetCamera().GetViewPort().GetScreenRay(r.x,r.y),G=new Tt.Plane(E.GetDirection(),d).Project(E.GetOrigin());(ce=new Tt.Line3D(A.Add(d).Divide(2),G)).SetName("MeasureImageLeader"),ce.SetColor(yt.LeaderColor().Clone()),(P=new Tt.Line3D(d,A)).SetColor(yt.MeasureColor1().Clone()),(de=new Tt.Point(d)).SetDrawType(1),de.SetSize(.8),(Se=new Tt.Point(A)).SetDrawType(1),Se.SetSize(.8),n.AddPoint(Se);for(N="点线距离",ie=250,i.GetSceneBox().Length(),ne=h.GetRefLine().GetPoints(),oe=h.GetDataOffset(),ae=h.GetDataLength(),se=oe;se<ne.length+ae;se+=2){le=new Tt.Line3D(ue.Multiply(ne[se]),ue.Multiply(ne[se+1])),Tt.Color.GREEN().Clone();le.SetColor(yt.SelectColor()),n.AddLine(le)}n.AddLine(P),n.AddLine(ce),(fe=new Array).push(S);O=void 0;O=Tt.MeasureDisplayHelper.SetMeasureUnit(Tt.Parameters.Instance().measureUnitStyle,fe,O);var me;he=String(fe[0].toFixed(3))+O,B=new Tt.ComText;(me=new Tt.CText).SetText(he),B.AddCText(me),n.ComTexts.push(B);W=new Tt.Shape2DSet,Y=40,X=new Tt.Vector2(1,1),j=new Tt.Vector2(ie,100),K=450,Tt.Color.GRAY().Clone(),q=Tt.Color.WHITE().Clone(),Q=Tt.Color.BLACK().Clone(),Tt.Color.GREEN().Clone(),Tt.Color.RED().Clone(),Tt.Color.BLUE().Clone();Tt.MeasureDisplayHelper.createRectImage(W,X,j,K,yt.MeasureColor1().Clone(),q,q,Q,N,he,Y,!0);te=null;Tt.MeasureDisplayHelper.addImageToMemory(i,te,W,G,(K+ie)/100,1.5,n)}}else Tt.LOGE("MeasureFactory.createPntTOLineDistance shape is null");return n},yt.createPntToFaceDistance=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(4==e.length){var r=e[0],i=e[1],n=e[2],o=null,a=(ee=e[3]).GetShape(r),s=ee.GetShape(i);if(a&&s&&a.GetType()==Tt.ShapeType.SHAPE_POINT_HANDLE&&s.GetType()==Tt.ShapeType.SHAPE_FACE){(o=new Tt.MeasureDistance).SetMeasureType(Tt.Measure.MEASURE_TYPE_PNT_FACE_DISTANCE);var l=s,h=a.GetPosition(),u=l.GetMesh();if(null!=(ie=l.GetGeoAttribute())&&ie.GetGeoAttrType()==Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_PLANEFACE){var p=ie,c=Tt.ShapeHelper.GetShapeWorldMatrix(l);Tt.GeometryHelper.Transform(p,c);var d=new Tt.Plane(p.GetNormal(),p.GetOrigin()).Project(h),S=h.Sub(d).Length(),f=h.Add(d).Divide(2).Clone(),m=c.Inverse().Multiply(h).Clone(),y=void 0,T=void 0,M=new Tt.Vector3,g=new Tt.Vector3;y=(ue=Tt.MeasureCalculateHelper.PntFaceDistance(m,u,y,T,M,g))[0],T=ue[1],M=c.Multiply(M).Clone(),g=c.Multiply(g).Clone();var v=ee.GetCamera().GetViewPort().GetScreenRay(n.x,n.y),C=new Tt.Plane(v.GetDirection(),f).Project(v.GetOrigin()),_=new Tt.Line3D(h,d);Tt.Color.BLACK().Clone();_.SetColor(yt.MeasureColor1().Clone()),(pe=new Tt.Line3D(f,C)).SetName("MeasureImageLeader"),pe.SetColor(yt.LeaderColor().Clone()),(ce=new Tt.Point(h)).SetDrawType(1),ce.SetSize(.8),(de=new Tt.Point(d)).SetDrawType(1),de.SetSize(.8),(Se=new Tt.Point(g)).SetDrawType(1),Se.SetSize(.8),(ae=new Tt.Point(M)).SetDrawType(1),ae.SetSize(.8);var A=new Tt.Line3D(h,M);Tt.Color.RED().Clone();A.SetColor(yt.MeasureColor3().Clone());var E=new Tt.Line3D(h,g);Tt.Color.BLUE().Clone();E.SetColor(yt.MeasureColor2().Clone()),(se=new Tt.Line3D(M,d)).SetColor(yt.ExLineColor().Clone()),se.SetName("exLine");ee.GetSceneBox().Length();var G="点线距离",P=40;(me=new Array).push(P);var w="最大距离",D=40;me.push(D);var x="最小距离",R=40;me.push(R);var I=250;o.AddLine(pe),o.AddLine(se),o.AddPoint(ce),(ye=new Array).push(S),ye.push(T),ye.push(y);var L=void 0;L=Tt.MeasureDisplayHelper.SetMeasureUnit(Tt.Parameters.Instance().measureUnitStyle,ye,L);var N=String(ye[0].toFixed(3))+L,O=String(ye[1].toFixed(3))+L,b=String(ye[2].toFixed(3))+L,V=new Tt.Shape2DSet,F=40,B=new Tt.Vector2(1,1),U=new Tt.Vector2(I,100),H=450,k=(Tt.Color.GRAY().Clone(),Tt.Color.WHITE().Clone()),z=Tt.Color.BLACK().Clone();Tt.Color.GREEN().Clone(),Tt.Color.RED().Clone(),Tt.Color.BLUE().Clone(),new Tt.Vector2(1,1),new Tt.Vector2(I,300);if(0<y){o.AddLine(_),o.AddLine(A),o.AddLine(E),o.AddPoint(de),o.AddPoint(Se),o.AddPoint(ae);var W=new Tt.ComText;(le=new Tt.CText).SetText(N),W.AddCText(le),o.ComTexts.push(W);var Y=new Tt.ComText;($=new Tt.CText).SetText(O),Y.AddCText($),o.ComTexts.push(Y);var X=new Tt.ComText;(Te=new Tt.CText).SetText(b),X.AddCText(Te),o.ComTexts.push(X),Tt.MeasureDisplayHelper.createRectImage(V,B,U,H,yt.MeasureColor1().Clone(),k,k,z,G,N,F,!0);var j=new Tt.Vector2(1,100),K=new Tt.Vector2(I,200);Tt.MeasureDisplayHelper.createRectImage(V,j,K,H,yt.MeasureColor2().Clone(),k,k,z,w,O,F,!0);var q=new Tt.Vector2(1,200),Q=new Tt.Vector2(I,300);Tt.MeasureDisplayHelper.createRectImage(V,q,Q,H,yt.MeasureColor3().Clone(),k,k,z,x,b,F,!0);var Z=null;Tt.MeasureDisplayHelper.addImageToMemory(ee,Z,V,C,(I+H)/100,4.5,o)}else{X=new Tt.ComText;(Te=new Tt.CText).SetText(b),X.AddCText(Te),o.ComTexts.push(X);q=new Tt.Vector2(1,1),Q=new Tt.Vector2(I,100);Tt.MeasureDisplayHelper.createRectImage(V,q,Q,H,yt.MeasureColor1().Clone(),k,k,z,x,b,F,!0);Z=null;Tt.MeasureDisplayHelper.addImageToMemory(ee,Z,V,C,(I+H)/100,1,o)}}else{m=(c=Tt.ShapeHelper.GetShapeWorldMatrix(l)).Inverse().Multiply(h).Clone(),y=void 0,T=void 0;var J=new Tt.Vector3;g=new Tt.Vector3;y=(ue=Tt.MeasureCalculateHelper.PntFaceDistance(m,u,y,T,J,g))[0],T=ue[1],J=c.Multiply(J).Clone(),g=c.Multiply(g).Clone();f=h.Add(J).Clone().Divide(2),v=ee.GetCamera().GetViewPort().GetScreenRay(n.x,n.y),C=new Tt.Plane(v.GetDirection(),J).Project(v.GetOrigin());(pe=new Tt.Line3D(f,C)).SetName("MeasureImageLeader"),pe.SetColor(yt.LeaderColor().Clone()),(ce=new Tt.Point(h)).SetDrawType(1),ce.SetSize(.8),(de=new Tt.Point(J)).SetDrawType(1),de.SetSize(.8),(Se=new Tt.Point(g)).SetDrawType(1),Se.SetSize(.8);A=new Tt.Line3D(h,J),Tt.Color.RED().Clone();A.SetColor(yt.MeasureColor1().Clone());E=new Tt.Line3D(h,g),Tt.Color.BLUE().Clone();E.SetColor(yt.MeasureColor2().Clone());ee.GetSceneBox().Length(),w="最大距离",D=40;(me=new Array).push(D);x="最小距离",R=40;me.push(R);I=250;o.AddLine(pe),o.AddPoint(ce),(ye=new Array).push(y),ye.push(T);L=void 0;L=Tt.MeasureDisplayHelper.SetMeasureUnit(Tt.Parameters.Instance().measureUnitStyle,ye,L);b=String(ye[0].toFixed(3))+L,O=String(ye[1].toFixed(3))+L,V=new Tt.Shape2DSet,F=40,B=new Tt.Vector2(1,1),U=new Tt.Vector2(I,100),H=450,Tt.Color.GRAY().Clone(),k=Tt.Color.WHITE().Clone(),z=Tt.Color.BLACK().Clone(),Tt.Color.GREEN().Clone(),Tt.Color.RED().Clone(),Tt.Color.BLUE().Clone(),new Tt.Vector2(1,1),new Tt.Vector2(I,200);if(0<y){X=new Tt.ComText;(Te=new Tt.CText).SetText(b),X.AddCText(Te),o.ComTexts.push(X);var $;Y=new Tt.ComText;($=new Tt.CText).SetText(O),Y.AddCText($),o.ComTexts.push(Y),o.AddLine(A),o.AddLine(E),o.AddPoint(de),o.AddPoint(Se),Tt.MeasureDisplayHelper.createRectImage(V,B,U,H,yt.MeasureColor1().Clone(),k,k,z,x,b,F,!1);j=new Tt.Vector2(1,100),K=new Tt.Vector2(I,200);Tt.MeasureDisplayHelper.createRectImage(V,j,K,H,yt.MeasureColor2().Clone(),k,k,z,w,O,F,!0);Z=null;Tt.MeasureDisplayHelper.addImageToMemory(ee,Z,V,C,(I+H)/100,3,o)}else{X=new Tt.ComText;(Te=new Tt.CText).SetText(b),X.AddCText(Te),o.ComTexts.push(X);q=new Tt.Vector2(1,1),Q=new Tt.Vector2(I,100);Tt.MeasureDisplayHelper.createRectImage(V,q,Q,H,yt.MeasureColor1().Clone(),k,k,z,x,b,F,!0);Z=null;Tt.MeasureDisplayHelper.addImageToMemory(ee,Z,V,C,(I+H)/100,1.5,o)}}}return o}if(6==e.length){r=e[0],i=e[1],e[2];var ee,te=e[3],re=(n=e[4],o=null,a=(ee=e[5]).GetShape(r),s=ee.GetShape(i),ee.GetShape(te));if(a&&s&&re&&a.GetType()==Tt.ShapeType.SHAPE_POINT_HANDLE&&s.GetType()==Tt.ShapeType.SHAPE_FACE&&re.GetType()==Tt.ShapeType.SHAPE_POINT_HANDLE){Tt.LOGE("createLineTOFaceAngle step2"),(o=new Tt.MeasureDistance).SetMeasureType(Tt.Measure.MEASURE_TYPE_PNT_FACE_DISTANCE);var ie,ne=re,oe=(l=s,h=a.GetPosition(),ne.GetPosition());u=l.GetMesh();if(null!=(ie=l.GetGeoAttribute())&&ie.GetGeoAttrType()==Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_PLANEFACE){p=ie,c=Tt.ShapeHelper.GetShapeWorldMatrix(l);Tt.GeometryHelper.Transform(p,c);d=new Tt.Plane(p.GetNormal(),p.GetOrigin()).Project(h),S=h.Sub(d).Length(),f=h.Add(d).Divide(2).Clone(),m=c.Inverse().Multiply(h).Clone(),y=void 0,T=void 0,M=new Tt.Vector3,g=new Tt.Vector3;y=(ue=Tt.MeasureCalculateHelper.PntFaceDistance(m,u,y,T,M,g))[0],T=ue[1],M=c.Multiply(M),g=c.Multiply(g);var ae;v=ee.GetCamera().GetViewPort().GetScreenRay(n.x,n.y),C=new Tt.Plane(v.GetDirection(),f).Project(v.GetOrigin()),_=new Tt.Line3D(h,d),Tt.Color.BLACK().Clone();_.SetColor(yt.MeasureColor1().Clone()),(pe=new Tt.Line3D(f,C)).SetName("MeasureImageLeader"),pe.SetColor(yt.LeaderColor().Clone()),(ce=new Tt.Point(h)).SetDrawType(1),ce.SetSize(.8),(de=new Tt.Point(d)).SetDrawType(1),de.SetSize(.8),(Se=new Tt.Point(g)).SetDrawType(1),Se.SetSize(.8),(ae=new Tt.Point(M)).SetDrawType(1),ae.SetSize(.8),(fe=new Tt.Point(oe)).SetDrawType(1),fe.SetSize(3),o.AddPoint(fe);A=new Tt.Line3D(h,M),Tt.Color.RED().Clone();A.SetColor(yt.MeasureColor3().Clone());var se;E=new Tt.Line3D(h,g),Tt.Color.BLUE().Clone();E.SetColor(yt.MeasureColor2().Clone()),(se=new Tt.Line3D(M,d)).SetColor(yt.ExLineColor().Clone()),se.SetName("exLine");ee.GetSceneBox().Length(),G="点面距离",P=40;(me=new Array).push(P);w="最大距离",D=40;me.push(D);x="最小距离",R=40;me.push(R);I=250;o.AddLine(pe),o.AddLine(se),o.AddPoint(ce),(ye=new Array).push(S),ye.push(T),ye.push(y);L=void 0;L=Tt.MeasureDisplayHelper.SetMeasureUnit(Tt.Parameters.Instance().measureUnitStyle,ye,L);var le;N=String(ye[0].toFixed(3))+L,O=String(ye[1].toFixed(3))+L,b=String(ye[2].toFixed(3))+L,W=new Tt.ComText;(le=new Tt.CText).SetText(N),W.AddCText(le),o.ComTexts.push(W);var he=new Tt.ComText;(Me=new Tt.CText).SetText(O),he.AddCText(Me),o.ComTexts.push(he);X=new Tt.ComText;(Te=new Tt.CText).SetText(b),X.AddCText(Te),o.ComTexts.push(X);V=new Tt.Shape2DSet,F=40,B=new Tt.Vector2(1,1),U=new Tt.Vector2(I,100),H=450,Tt.Color.GRAY().Clone(),k=Tt.Color.WHITE().Clone(),z=Tt.Color.BLACK().Clone(),Tt.Color.GREEN().Clone(),Tt.Color.RED().Clone(),Tt.Color.BLUE().Clone(),new Tt.Vector2(1,1),new Tt.Vector2(I,300);if(0<y){o.AddLine(_),o.AddLine(A),o.AddLine(E),o.AddPoint(de),o.AddPoint(Se),o.AddPoint(ae),Tt.MeasureDisplayHelper.createRectImage(V,B,U,H,yt.MeasureColor1().Clone(),k,k,z,G,N,F,!0);j=new Tt.Vector2(1,100),K=new Tt.Vector2(I,200);Tt.MeasureDisplayHelper.createRectImage(V,j,K,H,yt.MeasureColor2().Clone(),k,k,z,w,O,F,!0);q=new Tt.Vector2(1,200),Q=new Tt.Vector2(I,300);Tt.MeasureDisplayHelper.createRectImage(V,q,Q,H,yt.MeasureColor3().Clone(),k,k,z,x,b,F,!0);Z=null;Tt.MeasureDisplayHelper.addImageToMemory(ee,Z,V,C,(I+H)/100,4.5,o)}else{q=new Tt.Vector2(1,1),Q=new Tt.Vector2(I,100);Tt.MeasureDisplayHelper.createRectImage(V,q,Q,H,yt.MeasureColor1().Clone(),k,k,z,x,b,F,!0);Z=null;Tt.MeasureDisplayHelper.addImageToMemory(ee,Z,V,C,(I+H)/100,1.5,o)}}else{var ue;m=(c=Tt.ShapeHelper.GetShapeWorldMatrix(l)).Inverse().Multiply(h).Clone(),y=void 0,T=void 0,J=new Tt.Vector3,g=new Tt.Vector3;y=(ue=Tt.MeasureCalculateHelper.PntFaceDistance(m,u,y,T,J,g))[0],T=ue[0],J=c.Multiply(J).Clone(),g=c.Multiply(g).Clone();var pe,ce,de,Se,fe;f=h.Add(J).Divide(2).Clone(),v=ee.GetCamera().GetViewPort().GetScreenRay(n.x,n.y),C=new Tt.Plane(v.GetDirection(),J).Project(v.GetOrigin());(pe=new Tt.Line3D(f,C)).SetName("MeasureImageLeader"),pe.SetColor(yt.LeaderColor().Clone()),(ce=new Tt.Point(h)).SetDrawType(1),ce.SetSize(.8),(de=new Tt.Point(J)).SetDrawType(1),de.SetSize(.8),(Se=new Tt.Point(g)).SetDrawType(1),Se.SetSize(.8),(fe=new Tt.Point(oe)).SetDrawType(1),fe.SetSize(3),o.AddPoint(fe);A=new Tt.Line3D(h,J),Tt.Color.RED().Clone();A.SetColor(yt.MeasureColor1().Clone());E=new Tt.Line3D(h,g),Tt.Color.BLUE().Clone();E.SetColor(yt.MeasureColor2().Clone());var me;ee.GetSceneBox().Length(),w="最大距离",D=40;(me=new Array).push(D);x="最小距离",R=40;me.push(R);var ye;I=250;o.AddLine(pe),o.AddPoint(ce),(ye=void 0).push(y),ye.push(T);L=void 0;L=Tt.MeasureDisplayHelper.SetMeasureUnit(Tt.Parameters.Instance().measureUnitStyle,ye,L);var Te;b=String(ye[0].toFixed(3))+L,O=String(ye[1].toFixed(3))+L,X=new Tt.ComText;(Te=new Tt.CText).SetText(b),X.AddCText(Te),o.ComTexts.push(X);var Me;he=new Tt.ComText;(Me=new Tt.CText).SetText(O),he.AddCText(Me),o.ComTexts.push(he);V=new Tt.Shape2DSet,F=40,B=new Tt.Vector2(1,1),U=new Tt.Vector2(I,100),H=450,Tt.Color.GRAY().Clone(),k=Tt.Color.WHITE().Clone(),z=Tt.Color.BLACK().Clone(),Tt.Color.GREEN().Clone(),Tt.Color.RED().Clone(),Tt.Color.BLUE().Clone(),new Tt.Vector2(1,1),new Tt.Vector2(I,200);if(0<y){o.AddLine(A),o.AddLine(E),o.AddPoint(de),o.AddPoint(Se),Tt.MeasureDisplayHelper.createRectImage(V,B,U,H,yt.MeasureColor1().Clone(),k,k,z,x,b,F,!1);j=new Tt.Vector2(1,100),K=new Tt.Vector2(I,200);Tt.MeasureDisplayHelper.createRectImage(V,j,K,H,yt.MeasureColor2().Clone(),k,k,z,w,O,F,!0);Z=null;Tt.MeasureDisplayHelper.addImageToMemory(ee,Z,V,C,(I+H)/100,3,o)}else{q=new Tt.Vector2(1,1),Q=new Tt.Vector2(I,100);Tt.MeasureDisplayHelper.createRectImage(V,q,Q,H,yt.MeasureColor1().Clone(),k,k,z,x,b,F,!0);Z=null;Tt.MeasureDisplayHelper.addImageToMemory(ee,Z,V,C,(I+H)/100,1,o)}}}return o}},yt.createLineToLineDistance=function(e,t,r,i){var n=null,o=i.GetShape(e),a=i.GetShape(t);if(o&&a&&o.GetType()==Tt.ShapeType.SHAPE_EDGE&&a.GetType()==Tt.ShapeType.SHAPE_EDGE){Tt.LOGE("createLineTOLineDistance step2"),(n=new Tt.MeasureDistance).SetMeasureType(Tt.Measure.MEASURE_TYPE_LINE_LINE_DISTANCE);var s=o,l=a,h=s.GetLineData(),u=l.GetLineData(),p=s.GetGeoAttribute(),c=l.GetGeoAttribute();if(null!=p&&p.GetGeoAttrType()==Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_LINE&&null!=c&&c.GetGeoAttrType()==Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_LINE){Tt.LOGE("createLineTOLineDistance step3");var d=p,S=c,f=Tt.ShapeHelper.GetShapeWorldMatrix(s),m=Tt.ShapeHelper.GetShapeWorldMatrix(l);Tt.GeometryHelper.Transform(d,f),Tt.GeometryHelper.Transform(S,m);var y=void 0,T=new Tt.Vector3,M=new Tt.Vector3,g=!0,v=Tt.MeasureCalculateHelper.LineLineDistance(d,S,y,T,M,g);y=v[0],g=v[1];var C,_,A,E,G,P,w=d.GetStartPoint(),D=d.GetEndPoint(),x=S.GetStartPoint(),R=S.GetEndPoint();G=Tt.MeasureCalculateHelper.pntInSegment(T,d),P=Tt.MeasureCalculateHelper.pntInSegment(M,S);var I=0,L=new Tt.Vector3;I=Tt.MeasureCalculateHelper.PntLineDistance(x,R,w,I,L);var N=0,O=new Tt.Vector3;N=Tt.MeasureCalculateHelper.PntLineDistance(x,R,D,N,O);var b=0,V=new Tt.Vector3;b=Tt.MeasureCalculateHelper.PntLineDistance(w,D,x,b,V);var F=0,B=new Tt.Vector3;F=Tt.MeasureCalculateHelper.PntLineDistance(w,D,R,F,B);var U=0,H=new Tt.Vector3,k=new Tt.Vector3;k=(E=F)<(A=b)?(U=E,H=B,R):(U=A,H=V,x),(C=I)<U&&(U=C,H=L,k=w),(_=N)<U&&(U=_,H=D,k=O);var z=i.GetCamera().GetViewPort().GetScreenRay(r.x,r.y),W=T.Add(M).Divide(2).Clone(),Y=M.Sub(T).Clone(),X=new Tt.Plane(z.GetDirection(),W).Project(z.GetOrigin()),j=new Tt.Line3D(w,D);Tt.Color.GREEN().Clone();j.SetColor(yt.SelectColor().Clone());var K=new Tt.Line3D(x,R);Tt.Color.GREEN().Clone();K.SetColor(yt.SelectColor().Clone());var q=new Tt.Line3D(T,M);Tt.Color.BLACK().Clone();q.SetColor(yt.MeasureColor1().Clone()),(tt=new Tt.Line3D(W,X)).SetName("MeasureImageLeader"),tt.SetColor(yt.LeaderColor().Clone());var Q=new Tt.Line3D(H,k);Tt.Color.RED().Clone();Q.SetColor(yt.MeasureColor2().Clone());var Z=new Tt.Vector3;Z=T.Sub(w).Length()>T.Sub(D).Length()?D:w;var J=new Tt.Line3D(Z,T);Tt.Color.BLACK().Clone();J.SetColor(yt.ExLineColor().Clone()),J.SetName("exLine");var $=new Tt.Vector3;$=M.Sub(x).Length()>M.Sub(R).Length()?R:x;var ee=new Tt.Line3D($,M);Tt.Color.BLACK().Clone();ee.SetColor(yt.ExLineColor().Clone()),ee.SetName("exLine"),(ut=new Tt.Point(T)).SetDrawType(1),ut.SetSize(.8),(pt=new Tt.Point(M)).SetDrawType(1),pt.SetSize(.8);String(Y.x),String(Y.y),String(Y.z),i.GetSceneBox().Length();n.AddLine(j),n.AddLine(K),n.AddLine(q),n.AddLine(tt),n.AddLine(Q),G||n.AddLine(J),P||n.AddLine(ee),n.AddPoint(ut),n.AddPoint(pt);var te=new Tt.Shape2DSet,re=40,ie=450,ne=Tt.Color.GRAY().Clone(),oe=Tt.Color.WHITE().Clone(),ae=Tt.Color.BLACK().Clone(),se=(Tt.Color.GREEN().Clone(),Tt.Color.RED().Clone());Tt.Color.BLUE().Clone();if(g){(ct=new Array).push(40);var le="最短距离",he=40;ct.push(he);var ue=250;(dt=new Array).push(y),dt.push(U);var pe="";pe=Tt.MeasureDisplayHelper.SetMeasureUnit(Tt.Parameters.Instance().measureUnitStyle,dt,pe);var ce=String(dt[0].toFixed(3))+pe,de=String(dt[1].toFixed(3))+pe,Se=new Tt.ComText,fe=new Tt.CText;fe.SetText(ce),Se.AddCText(fe),n.ComTexts.push(Se);var me=new Tt.ComText,ye=new Tt.CText;ye.SetText(de),me.AddCText(ye),n.ComTexts.push(me);new Tt.Vector2(1,1),new Tt.Vector2(ue,200);var Te=new Tt.Vector2(1,1),Me=new Tt.Vector2(ue,100);Tt.MeasureDisplayHelper.createRectImage(te,Te,Me,ie,yt.MeasureColor1().Clone(),oe,oe,ae,"线线距离",ce,re,!1);var ge=new Tt.Vector2(1,100),ve=new Tt.Vector2(ue,200);Tt.MeasureDisplayHelper.createRectImage(te,ge,ve,ie,yt.MeasureColor2().Clone(),oe,oe,ae,le,de,re,!0);var Ce=null;Tt.MeasureDisplayHelper.addImageToMemory(i,Ce,te,X,(ue+ie)/100,3,n)}else{he=40;(ct=new Array).push(he);ct.push(40);ue=250;(dt=new Array).push(y),dt.push(U);pe="";pe=Tt.MeasureDisplayHelper.SetMeasureUnit(Tt.Parameters.Instance().measureUnitStyle,dt,pe);var _e=String(dt[0].toFixed(3))+pe,Ae=(de=String(dt[1].toFixed(3))+pe,new Tt.ComText),Ee=new Tt.CText;Ee.SetText(_e),Ae.AddCText(Ee),n.ComTexts.push(Ae);var Ge=new Tt.ComText,Pe=new Tt.CText;Pe.SetText(de),Ge.AddCText(Pe),n.ComTexts.push(Ge);new Tt.Vector2(1,1),new Tt.Vector2(ue,200),Te=new Tt.Vector2(1,1),Me=new Tt.Vector2(ue,100);Tt.MeasureDisplayHelper.createRectImage(te,Te,Me,ie,yt.MeasureColor1().Clone(),oe,oe,ae,"交叉线距离",_e,re,!1);ge=new Tt.Vector2(1,100),ve=new Tt.Vector2(ue,200);Tt.MeasureDisplayHelper.createRectImage(te,ge,ve,ie,yt.MeasureColor2().Clone(),oe,oe,ae,"最短距离",de,re,!0);Ce=null;Tt.MeasureDisplayHelper.addImageToMemory(i,Ce,te,X,(ue+ie)/100,3,n)}}else if(null!=p&&p.GetGeoAttrType()==Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_ELLIPSE&&null!=c&&c.GetGeoAttrType()==Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_ELLIPSE){var we=p,De=c;f=Tt.ShapeHelper.GetShapeWorldMatrix(s),m=Tt.ShapeHelper.GetShapeWorldMatrix(l);Tt.GeometryHelper.Transform(we,f),Tt.GeometryHelper.Transform(De,m);var xe=void 0,Re=void 0,Ie=new Tt.Vector3,Le=(T=new Tt.Vector3,void 0),Ne=Tt.MeasureCalculateHelper.LineLineDistance(we,De,xe,Re,Ie,T,Le);xe=Ne[0],Re=Ne[1],Le=Ne[2];var Oe=new Tt.Vector3,be=new Tt.Vector3,Ve=(new Tt.Vector3,new Tt.Vector3,new Tt.Vector3),Fe=new Tt.Vector3,Be=new Tt.Vector3,Ue=new Tt.Vector3,He=new Tt.Vector3,ke=new Tt.Vector3;we.GetXYZDir(Ve,Fe,Be),De.GetXYZDir(Ue,He,ke),Oe=we.GetCenterPoint(),be=De.GetCenterPoint(),we.GetMajorRadius(),De.GetMajorRadius(),we.GetStartPoint(),De.GetStartPoint();z=i.GetCamera().GetViewPort().GetScreenRay(r.x,r.y),W=T.Add(Ie).Divide(2).Clone(),X=new Tt.Plane(z.GetDirection(),W).Project(z.GetOrigin());var ze=new Tt.Point(be);ze.SetDrawType(1),ze.SetSize(.8);var We=new Tt.Point(Oe);We.SetDrawType(1),We.SetSize(.8),n.AddPoint(We),n.AddPoint(ze);for(var Ye=h.GetRefLine().GetPoints(),Xe=h.GetDataOffset(),je=h.GetDataLength(),Ke=Xe;Ke<Xe+je;Ke+=2){var qe=new Tt.Line3D(f.Multiply(Ye[Ke]),f.Multiply(Ye[Ke+1]));Tt.Color.GREEN().Clone();qe.SetColor(yt.SelectColor()),n.AddLine(qe)}for(Ye=u.GetRefLine().GetPoints(),Xe=u.GetDataOffset(),je=u.GetDataLength(),Ke=Xe;Ke<Xe+je;Ke+=2){qe=new Tt.Line3D(m.Multiply(Ye[Ke]),m.Multiply(Ye[Ke+1])),Tt.Color.GREEN().Clone();qe.SetColor(yt.SelectColor()),n.AddLine(qe)}(dt=new Array).push(xe),dt.push(Re);pe="";pe=Tt.MeasureDisplayHelper.SetMeasureUnit(Tt.Parameters.Instance().measureUnitStyle,dt,pe);var Qe=String(dt[0].toFixed(3))+pe,Ze=String(dt[1].toFixed(3))+pe;te=new Tt.Shape2DSet,re=40,ie=450,ne=Tt.Color.GRAY().Clone(),oe=Tt.Color.WHITE().Clone(),ae=Tt.Color.BLACK().Clone(),Tt.Color.GREEN().Clone(),se=Tt.Color.RED().Clone(),Tt.Color.BLUE().Clone();if(0==Le){(j=new Tt.Line3D(Oe,be)).SetColor(se),n.AddLine(j),(K=new Tt.Line3D(W,X)).SetName("MeasureImageLeader"),K.SetColor(yt.LeaderColor().Clone()),n.AddLine(K);var Je="曲线中心",$e=250,et=new Tt.ComText;(at=new Tt.CText).SetText(Ze),et.AddCText(at),n.ComTexts.push(et);new Tt.Vector2(1,1),new Tt.Vector2($e,100),Te=new Tt.Vector2(1,1),Me=new Tt.Vector2($e,100);Tt.MeasureDisplayHelper.createRectImage(te,Te,Me,ie,yt.MeasureColor1().Clone(),oe,oe,ae,Je,Ze,re,!0);Ce=null;Tt.MeasureDisplayHelper.addImageToMemory(i,Ce,te,X,($e+ie)/100,1.5,n)}else if(1==Le){var tt;(j=new Tt.Line3D(Oe,be)).SetColor(yt.MeasureColor1().Clone()),n.AddLine(j),(K=new Tt.Line3D(Ie,T)).SetColor(yt.MeasureColor2().Clone()),n.AddLine(K),(q=new Tt.Line3D(Oe,Ie)).SetColor(yt.ExLineColor().Clone()),q.SetName("exLine"),n.AddLine(q),(tt=new Tt.Line3D(Oe.Add(be).Divide(2).Clone(),X)).SetName("MeasureImageLeader"),tt.SetColor(yt.LeaderColor().Clone()),n.AddLine(tt),(ut=new Tt.Point(Ie)).SetDrawType(1),ut.SetSize(.8),n.AddPoint(ut),(pt=new Tt.Point(T)).SetDrawType(1),pt.SetSize(.8),n.AddPoint(pt);Je="曲线中心",$e=40;(ct=new Array).push($e);ct.push(40);et=new Tt.ComText;(at=new Tt.CText).SetText(Ze),et.AddCText(at),n.ComTexts.push(et);var rt=new Tt.ComText,it=new Tt.CText;it.SetText(Qe),rt.AddCText(it),n.ComTexts.push(rt);ue=250,new Tt.Vector2(1,1),new Tt.Vector2(ue,200),Te=new Tt.Vector2(1,1),Me=new Tt.Vector2(ue,100);Tt.MeasureDisplayHelper.createRectImage(te,Te,Me,ie,yt.MeasureColor1().Clone(),oe,oe,ae,Je,Ze,re,!1);var nt=new Tt.Vector2(1,100),ot=new Tt.Vector2(ue,200);Tt.MeasureDisplayHelper.createRectImage(te,nt,ot,ie,yt.MeasureColor2().Clone(),oe,oe,ae,"线线轴距",Qe,re,!0);Ce=null;Tt.MeasureDisplayHelper.addImageToMemory(i,Ce,te,X,(ue+ie)/100,3,n)}else if(2==Le){(j=new Tt.Line3D(Ie,T)).SetColor(yt.MeasureColor1().Clone()),n.AddLine(j);var at;et=new Tt.ComText;(at=new Tt.CText).SetText(Ze),et.AddCText(at),n.ComTexts.push(et),(K=new Tt.Line3D(W,X)).SetName("MeasureImageLeader"),K.SetColor(yt.LeaderColor().Clone()),n.AddLine(K);new Tt.Vector2(1,1),new Tt.Vector2(250,100),Te=new Tt.Vector2(1,1),Me=new Tt.Vector2(250,100);Tt.MeasureDisplayHelper.createRectImage(te,Te,Me,ie,yt.MeasureColor1().Clone(),oe,oe,ae,"半径差",Ze,re,!0);Ce=null;Tt.MeasureDisplayHelper.addImageToMemory(i,Ce,te,X,(250+ie)/100,1.5,n)}}else if(null!=p&&p.GetGeoAttrType()==Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_ELLIPSE&&null!=c&&c.GetGeoAttrType()==Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_LINE||null!=p&&p.GetGeoAttrType()==Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_LINE&&null!=c&&c.GetGeoAttrType()==Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_ELLIPSE){Tt.LOGI("line and ellipse distance BEGIN");ne=Tt.Color.GRAY().Clone(),oe=Tt.Color.WHITE().Clone(),ae=Tt.Color.BLACK().Clone(),Tt.Color.GREEN().Clone(),se=Tt.Color.RED().Clone(),Tt.Color.BLUE().Clone(),f=Tt.ShapeHelper.GetShapeWorldMatrix(s),m=Tt.ShapeHelper.GetShapeWorldMatrix(l);var st=new Tt.Vector3,lt=new Tt.Vector3,ht=1e5;ht=Tt.MeasureCalculateHelper.PolylinePolylineDistance(h,u,st,lt,ht,f,m);for(Ye=h.GetRefLine().GetPoints(),Xe=h.GetDataOffset(),je=h.GetDataLength(),Ke=Xe;Ke<je;Ke+=2){qe=new Tt.Line3D(f.Multiply(Ye[Ke]),f.Multiply(Ye[Ke+1])),Tt.Color.GREEN().Clone();qe.SetColor(yt.SelectColor().Clone()),n.AddLine(qe)}for(Ye=u.GetRefLine().GetPoints(),Xe=u.GetDataOffset(),je=u.GetDataLength(),Ke=Xe;Ke<je;Ke+=2){qe=new Tt.Line3D(m.Multiply(Ye[Ke]),m.Multiply(Ye[Ke+1])),Tt.Color.GREEN().Clone();qe.SetColor(yt.SelectColor().Clone()),n.AddLine(qe)}var ut,pt;W=st.Add(lt).Divide(2).Clone(),z=i.GetCamera().GetViewPort().GetScreenRay(r.x,r.y),X=new Tt.Plane(z.GetDirection(),W).Project(z.GetOrigin());(j=new Tt.Line3D(st,lt)).SetColor(yt.MeasureColor1().Clone()),n.AddLine(j),(ut=new Tt.Point(st)).SetDrawType(1),ut.SetSize(.8),(pt=new Tt.Point(lt)).SetDrawType(1),pt.SetSize(.8),n.AddPoint(ut),n.AddPoint(pt),(K=new Tt.Line3D(W,X)).SetColor(ne),K.SetName("MeasureImageLeader"),K.SetColor(yt.LeaderColor().Clone()),n.AddLine(K);var ct;le="最短距离",he=40;(ct=new Array).push(he);var dt;ue=250;(dt=new Array).push(ht);pe="";pe=Tt.MeasureDisplayHelper.SetMeasureUnit(Tt.Parameters.Instance().measureUnitStyle,dt,pe);var St=String(dt[0].toFixed(3))+pe,ft=new Tt.ComText,mt=new Tt.CText;mt.SetText(St),ft.AddCText(mt),n.ComTexts.push(ft);te=new Tt.Shape2DSet,re=40,Te=new Tt.Vector2(1,1),Me=new Tt.Vector2(ue,100),ie=450;Tt.MeasureDisplayHelper.createRectImage(te,Te,Me,ie,yt.MeasureColor1().Clone(),oe,oe,ae,le,St,re,!0);Ce=null;Tt.MeasureDisplayHelper.addImageToMemory(i,Ce,te,X,(ue+ie)/100,1.5,n)}}else Tt.LOGE("MeasureFactory.createLineTOLineDistance shape is null");return n},yt.createLineToFaceDistance=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(4==e.length){var r=e[0],i=e[1],n=e[2],o=null,a=(W=e[3]).GetShape(r),s=W.GetShape(i);if(a&&s&&a.GetType()==Tt.ShapeType.SHAPE_EDGE&&s.GetType()==Tt.ShapeType.SHAPE_FACE){(o=new Tt.MeasureDistance).SetMeasureType(Tt.Measure.MEASURE_TYPE_LINE_FACE_DISTANCE);var l=s,h=((j=a).GetLineData(),l.GetMesh()),u=j.GetGeoAttribute(),p=l.GetGeoAttribute();if(null!=u&&u.GetGeoAttrType()==Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_LINE&&null!=p&&p.GetGeoAttrType()==Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_PLANEFACE){var c=u,d=p,S=Tt.ShapeHelper.GetShapeWorldMatrix(j),f=Tt.ShapeHelper.GetShapeWorldMatrix(l);Tt.GeometryHelper.Transform(c,S),Tt.GeometryHelper.Transform(d,f);var m=void 0,y=new Tt.Vector3,T=new Tt.Vector3;m=Tt.MeasureCalculateHelper.LineFaceDistance(c,d,m,y,T)[1];var M=(q=h.GetBoundingBox()).Center();Tt.GeometryHelper.Transform(M,f);var g=W.GetCamera().GetViewPort().GetScreenRay(n.x,n.y),v=c.GetStartPoint(),C=c.GetEndPoint(),_=(Q=v.Add(C).Divide(2).Clone()).Add(M).Divide(2).Clone();C.Sub(v),d.GetNormal();(Z=new Array).push(q.GetXLength()),Z.push(q.GetYLength()),Z.push(q.GetZLength()),Z.sort(),2<Z[0]?Z[0]:Z[1];Tt.Color.GRAY().Clone();var A=Tt.Color.WHITE().Clone(),E=Tt.Color.BLACK().Clone(),G=(Tt.Color.GREEN().Clone(),Tt.Color.RED().Clone(),Tt.Color.BLUE().Clone(),new Tt.Plane(d.GetNormal(),d.GetOrigin()).Project(Q)),P=new Tt.Plane(g.GetDirection(),Q.Add(G).Divide(2)).Project(g.GetOrigin());(J=new Tt.Line3D(Q,G)).SetColor(yt.MeasureColor1().Clone()),($=new Tt.Line3D(Q.Add(G).Divide(2),P)).SetName("MeasureImageLeader"),$.SetColor(yt.LeaderColor().Clone()),(te=new Tt.Line3D(v,C)).SetColor(yt.SelectColor().Clone());var w=new Tt.Line3D(G,M);w.SetColor(yt.ExLineColor().Clone()),w.SetName("exLine"),o.AddLine(w);var D=new Tt.Point(G);D.SetDrawType(1),D.SetSize(.8),o.AddPoint(D);var x=new Tt.Point(Q);x.SetDrawType(1),x.SetSize(.8),o.AddPoint(x);var R=new Array,I=void 0;new Array;if(!(0<=m))return o=null;(re=new Array).push(m);var L="";L=Tt.MeasureDisplayHelper.SetMeasureUnit(Tt.Parameters.Instance().measureUnitStyle,re,L),I=String(re[0].toFixed(3))+L;var N="线面距离",O=40;R.push(O);var b=new Tt.ComText;(ie=new Tt.CText).SetText(I),b.AddCText(ie),o.ComTexts.push(b);var V=250;W.GetSceneBox().Length();o.AddLine(J),o.AddLine($),o.AddLine(te);var F=new Tt.Shape2DSet,B=40,U=new Tt.Vector2(1,1),H=new Tt.Vector2(V,100),k=450;Tt.MeasureDisplayHelper.createRectImage(F,U,H,k,yt.MeasureColor1().Clone(),A,A,E,N,I,B,!0);var z=null;Tt.MeasureDisplayHelper.addImageToMemory(W,z,F,P,(V+k)/100,1.5,o)}else o=null}return o}if(6==e.length){r=e[0],i=e[1],e[2];var W,Y=e[3],X=(n=e[4],o=null,a=(W=e[5]).GetShape(r),s=W.GetShape(i),W.GetShape(Y));if(a&&s&&X&&a.GetType()==Tt.ShapeType.SHAPE_EDGE&&s.GetType()==Tt.ShapeType.SHAPE_FACE&&X.GetType()==Tt.ShapeType.SHAPE_POINT_HANDLE){(o=new Tt.MeasureDistance).SetMeasureType(Tt.Measure.MEASURE_TYPE_LINE_FACE_DISTANCE);var j=a,K=(l=s,X.GetPosition());j.GetLineData(),h=l.GetMesh(),u=j.GetGeoAttribute(),p=l.GetGeoAttribute();if(null!=u&&u.GetGeoAttrType()==Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_LINE&&null!=p&&p.GetGeoAttrType()==Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_PLANEFACE){c=u,d=p,S=Tt.ShapeHelper.GetShapeWorldMatrix(j),f=Tt.ShapeHelper.GetShapeWorldMatrix(l);Tt.GeometryHelper.Transform(c,S),Tt.GeometryHelper.Transform(d,f);m=void 0,y=new Tt.Vector3,T=new Tt.Vector3;m=Tt.MeasureCalculateHelper.LineFaceDistance(c,d,m,y,T)[1];var q;M=(q=h.GetBoundingBox()).Center();Tt.GeometryHelper.Transform(M,f);var Q,Z;g=W.GetCamera().GetViewPort().GetScreenRay(n.x,n.y),v=c.GetStartPoint(),C=c.GetEndPoint(),_=(Q=v.Add(C).Divide(2).Clone()).Add(M).Divide(2).Clone(),C.Sub(v).Clone(),d.GetNormal();(Z=new Array).push(q.GetXLength()),Z.push(q.GetYLength()),Z.push(q.GetZLength()),Z.sort(),2<Z[0]?Z[0]:Z[1];Tt.Color.GRAY().Clone(),A=Tt.Color.WHITE().Clone(),E=Tt.Color.BLACK().Clone(),Tt.Color.GREEN().Clone(),Tt.Color.RED().Clone(),Tt.Color.BLUE().Clone(),P=new Tt.Plane(g.GetDirection(),v).Project(g.GetOrigin());var J,$,ee=new Tt.Point(K);ee.SetDrawType(1),ee.SetSize(.8),o.AddPoint(ee),(J=new Tt.Line3D(Q,K)).SetColor(yt.MeasureColor1().Clone()),($=new Tt.Line3D(_,P)).SetName("MeasureImageLeader"),$.SetColor(yt.LeaderColor().Clone());var te=new Tt.Line3D(v,C);Tt.Color.GREEN().Clone();te.SetColor(yt.SelectColor().Clone());var re;R=new Array,I=void 0,new Array;if(!(0<=m))return o=null;(re=new Array).push(m);L="";L=Tt.MeasureDisplayHelper.SetMeasureUnit(Tt.Parameters.Instance().measureUnitStyle,re,L),I=String(re[0].toFixed(3))+L;N="线面距离",O=40;R.push(O);var ie;b=new Tt.ComText;(ie=new Tt.CText).SetText(I),b.AddCText(ie),o.ComTexts.push(b);V=250,W.GetSceneBox().Length();o.AddLine(J),o.AddLine($),o.AddLine(te);F=new Tt.Shape2DSet,B=40,U=new Tt.Vector2(1,1),H=new Tt.Vector2(V,100),k=450;Tt.MeasureDisplayHelper.createRectImage(F,U,H,k,yt.MeasureColor1().Clone(),A,A,E,N,I,B,!0);z=null;Tt.MeasureDisplayHelper.addImageToMemory(W,z,F,P,(V+k)/100,1.5,o)}else o=null}return o}},yt.createFaceToFaceDistance=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(4==e.length){var r=e[0],i=e[1],n=e[2],o=null,a=(H=e[3]).GetShape(r),s=H.GetShape(i);if(a&&s&&a.GetType()==Tt.ShapeType.SHAPE_FACE&&s.GetType()==Tt.ShapeType.SHAPE_FACE){Tt.LOGE("createFaceTOFaceAngle step2"),(o=new Tt.MeasureDistance).SetMeasureType(Tt.Measure.MEASURE_TYPE_FACE_FACE_DISTANCE);var l=s,h=(X=a).GetMesh(),u=l.GetMesh(),p=X.GetGeoAttribute(),c=l.GetGeoAttribute();if(null!=p&&p.GetGeoAttrType()==Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_PLANEFACE&&null!=c&&c.GetGeoAttrType()==Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_PLANEFACE){Tt.LOGI("createFaceTOFaceAngle step3");Tt.Color.GRAY().Clone();var d=Tt.Color.WHITE().Clone(),S=Tt.Color.BLACK().Clone(),f=(Tt.Color.GREEN().Clone(),Tt.Color.RED().Clone(),Tt.Color.BLUE().Clone(),p),m=c,y=Tt.ShapeHelper.GetShapeWorldMatrix(X),T=Tt.ShapeHelper.GetShapeWorldMatrix(l);Tt.GeometryHelper.Transform(f,y),Tt.GeometryHelper.Transform(m,T);var M=void 0,g=new Tt.Vector3,v=new Tt.Vector3;M=Tt.MeasureCalculateHelper.FaceFaceDistance(f,m,M,g,v);var C=h.GetBoundingBox().Center();Tt.GeometryHelper.Transform(C,y);var _=u.GetBoundingBox().Center();Tt.GeometryHelper.Transform(_,T);var A=C.Add(_).Divide(2),E=H.GetCamera().GetViewPort().GetScreenRay(n.x,n.y),G=new Tt.Plane(E.GetDirection(),A).Project(E.GetOrigin()),P=new Tt.Plane(f.GetNormal(),C).Project(_);(q=new Tt.Line3D(A,G)).SetName("MeasureImageLeader"),q.SetColor(yt.LeaderColor().Clone()),(Q=new Tt.Line3D(C,_)).SetColor(yt.MeasureColor1().Clone()),(Z=new Tt.Line3D(P,_)).SetColor(yt.MeasureColor1().Clone()),(J=new Tt.Point(C)).SetSize(.8),J.SetDrawType(1);var w=new Tt.Point(_);w.SetSize(.8),w.SetDrawType(1);var D=void 0;if(!(0<=M))return o=null;(te=new Array(0)).push(M);var x=void 0;x=Tt.MeasureDisplayHelper.SetMeasureUnit(Tt.Parameters.Instance().measureUnitStyle,te,x),D=String(te[0].toFixed(3))+x;var R="面面距离",I=40;(new Array).push(I);var L=new Tt.ComText;(re=new Tt.CText).SetText(D),L.AddCText(re),o.ComTexts.push(L);var N=250;H.GetSceneBox().Length();o.AddLine(q),o.AddLine(Q),o.AddPoint(J),o.AddPoint(w);var O=new Tt.Shape2DSet,b=40,V=new Tt.Vector2(1,1),F=new Tt.Vector2(N,100),B=450;Tt.MeasureDisplayHelper.createRectImage(O,V,F,B,yt.MeasureColor1().Clone(),d,d,S,R,D,b,!0);var U=null;Tt.MeasureDisplayHelper.addImageToMemory(H,U,O,G,(N+B)/100,1.5,o)}else o=null}return o}if(6==e.length){r=e[0],i=e[1];var H,k=e[2],z=e[3],W=(n=e[4],o=null,a=(H=e[5]).GetShape(r),s=H.GetShape(i),H.GetShape(k)),Y=H.GetShape(z);if(a&&s&&W&&Y&&a.GetType()==Tt.ShapeType.SHAPE_FACE&&s.GetType()==Tt.ShapeType.SHAPE_FACE&&W.GetType()==Tt.ShapeType.SHAPE_POINT_HANDLE&&Y.GetType()==Tt.ShapeType.SHAPE_POINT_HANDLE){(o=new Tt.MeasureDistance).SetMeasureType(Tt.Measure.MEASURE_TYPE_FACE_FACE_DISTANCE);l=s,h=(X=a).GetMesh(),u=l.GetMesh();var X,j=W.GetPosition(),K=Y.GetPosition();p=X.GetGeoAttribute(),c=l.GetGeoAttribute();if(null!=p&&p.GetGeoAttrType()==Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_PLANEFACE&&null!=c&&c.GetGeoAttrType()==Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_PLANEFACE){Tt.LOGI("createFaceTOFaceAngle step3");Tt.Color.GRAY().Clone(),d=Tt.Color.WHITE().Clone(),S=Tt.Color.BLACK().Clone(),Tt.Color.GREEN().Clone(),Tt.Color.RED().Clone(),Tt.Color.BLUE().Clone(),f=p,m=c,y=Tt.ShapeHelper.GetShapeWorldMatrix(X),T=Tt.ShapeHelper.GetShapeWorldMatrix(l);Tt.GeometryHelper.Transform(f,y),Tt.GeometryHelper.Transform(m,T);M=void 0,g=new Tt.Vector3,v=new Tt.Vector3;M=Tt.MeasureCalculateHelper.FaceFaceDistance(f,m,M,g,v);var q,Q,Z,J;A=(P=new Tt.Plane(f.GetNormal(),j).Project(K)).Add(K).Divide(2).Clone(),E=H.GetCamera().GetViewPort().GetScreenRay(n.x,n.y),G=new Tt.Plane(E.GetDirection(),A).Project(E.GetOrigin());(q=new Tt.Line3D(A,G)).SetName("MeasureImageLeader"),q.SetColor(yt.LeaderColor().Clone()),(Q=new Tt.Line3D(P,j)).SetColor(yt.ExLineColor().Clone()),Q.SetName("exLine"),(Z=new Tt.Line3D(P,K)).SetColor(yt.MeasureColor1().Clone()),(J=new Tt.Point(P)).SetSize(.8),J.SetDrawType(1);var $=new Tt.Point(j);$.SetDrawType(1),$.SetSize(.8),o.AddPoint($);var ee=new Tt.Point(K);ee.SetDrawType(1),ee.SetSize(.8),o.AddPoint(ee);var te;D=void 0;if(!(0<=M))return o=null;(te=new Array).push(M);x=void 0;x=Tt.MeasureDisplayHelper.SetMeasureUnit(Tt.Parameters.Instance().measureUnitStyle,te,x),D=String(te[0].toFixed(3))+x;R="面面距离",I=40;(new Array).push(I);var re;L=new Tt.ComText;(re=new Tt.CText).SetText(D),L.AddCText(re),o.ComTexts.push(L);N=250,H.GetSceneBox().Length();o.AddLine(q),o.AddLine(Q),o.AddLine(Z),o.AddPoint(J);O=new Tt.Shape2DSet,b=40,V=new Tt.Vector2(1,1),F=new Tt.Vector2(N,100),B=450;Tt.MeasureDisplayHelper.createRectImage(O,V,F,B,yt.MeasureColor1().Clone(),d,d,S,R,D,b,!0);U=null;Tt.MeasureDisplayHelper.addImageToMemory(H,U,O,G,(N+B)/100,1.5,o)}else o=null}return o}},yt.createLineToLineAngle=function(e,t,r,i){var n=null,o=i.GetShape(e),a=i.GetShape(t);if(o&&a&&o.GetType()==Tt.ShapeType.SHAPE_EDGE&&a.GetType()==Tt.ShapeType.SHAPE_EDGE){(n=new Tt.MeasureAngle).SetMeasureType(Tt.Measure.MEASURE_TYPE_LINE_LINE_ANGLE);var s=o,l=a,h=(s.GetLineData(),l.GetLineData(),s.GetGeoAttribute()),u=l.GetGeoAttribute(),p=(Tt.Color.GRAY().Clone(),Tt.Color.WHITE().Clone()),c=Tt.Color.BLACK().Clone();Tt.Color.GREEN().Clone(),Tt.Color.RED().Clone(),Tt.Color.BLUE().Clone();if(null!=h&&h.GetGeoAttrType()==Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_LINE&&null!=u&&u.GetGeoAttrType()==Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_LINE){var d=h,S=u,f=Tt.ShapeHelper.GetShapeWorldMatrix(s),m=Tt.ShapeHelper.GetShapeWorldMatrix(l);Tt.GeometryHelper.Transform(d,f),Tt.GeometryHelper.Transform(S,m);var y=void 0;y=Tt.MeasureCalculateHelper.LineLineAngle(d,S,y);var T=i.GetCamera().GetViewPort().GetScreenRay(r.x,r.y),M=d.GetStartPoint(),g=d.GetEndPoint(),v=g.Sub(M).Clone(),C=S.GetStartPoint(),_=S.GetEndPoint(),A=(C.Add(_).Divide(2).Clone(),C.Add(v).Clone()),E=new Tt.Plane(T.GetDirection(),M).Project(T.GetOrigin()),G=new Tt.Line3D(M,g);Tt.Color.GREEN().Clone();G.SetColor(yt.SelectColor().Clone());var P=new Tt.Line3D(C,_);P.SetColor(yt.SelectColor().Clone());var w=new Tt.Line3D(C,A);Tt.Color.YELLOW().Clone();w.SetColor(yt.ExLineColor().Clone()),w.SetName("exLine");var D=new Tt.Line3D(M,C);D.SetColor(yt.ExLineColor().Clone()),D.SetName("exLine");var x=new Tt.Line3D(g,A);x.SetColor(yt.ExLineColor().Clone()),x.SetName("exLine");var R=new Array;Tt.MeasureDisplayHelper.CreateAngleMark(C,A,C,_,y,R);var I=void 0;if(0<R.length){for(var L=0;L<R.length-1;L++){var N=new Tt.Line3D(R[L],R[L+1]);N.SetColor(yt.MeasureColor1().Clone()),n.AddLine(N)}I=0<y&&y<90||90<y&&y<180?new Tt.Line3D(R[R.length/2].Add(R[R.length/2-1]).Divide(2).Clone(),E):y-90<1e-7&&-1e-7<y-90?new Tt.Line3D(R[1],E):new Tt.Line3D(C,E)}else I=new Tt.Line3D(C,E);I.SetName("MeasureImageLeader"),I.SetColor(yt.LeaderColor().Clone());(new Array).push(40);var O=String(y),b=new Tt.ComText,V=new Tt.CText;V.SetText(O),b.AddCText(V),n.ComTexts.push(b);i.GetSceneBox().Length();n.AddLine(I),n.AddLine(G),n.AddLine(P),n.AddLine(w);var F=new Tt.Shape2DSet,B=new Tt.Vector2(1,1),U=new Tt.Vector2(250,100);Tt.MeasureDisplayHelper.createRectImage(F,B,U,450,yt.MeasureColor1().Clone(),p,p,c,"线线角度",O,40,!0);Tt.MeasureDisplayHelper.addImageToMemory(i,null,F,E,7,1.5,n)}else n=null}return n},yt.createCurveToCurveAngle=function(e,t,r,i,n,o){var a=null,s=o.GetShape(e),l=o.GetShape(t);if(r&&i&&r.GetType()==Tt.ShapeType.SHAPE_EDGE&&i.GetType()==Tt.ShapeType.SHAPE_EDGE){(a=new Tt.MeasureAngle).SetMeasureType(Tt.Measure.MEASURE_TYPE_CURVE_CURVE_ANGLE);var h=s,u=l,p=(Tt.Color.GRAY().Clone(),Tt.Color.WHITE().Clone()),c=Tt.Color.BLACK().Clone(),d=(Tt.Color.GREEN().Clone(),Tt.Color.RED().Clone(),Tt.Color.BLUE().Clone(),new Tt.LineAttribute);d.SetID(r.GetID()),d.SetDirection(new Tt.Vector3(r.GetPosition().x-r.GetEndPoint().x,r.GetPosition().y-r.GetEndPoint().y,r.GetPosition().z-r.GetEndPoint().z)),d.SetStartPoint(r.GetEndPoint()),d.SetEndPoint(r.GetPosition()),d.SetCenterPoint(new Tt.Vector3(NaN,NaN,NaN));var S=new Tt.LineAttribute;S.SetID(i.GetID()),S.SetDirection(new Tt.Vector3(i.GetPosition().x-i.GetEndPoint().x,i.GetPosition().y-i.GetEndPoint().y,i.GetPosition().z-i.GetEndPoint().z)),S.SetStartPoint(i.GetEndPoint()),S.SetEndPoint(i.GetPosition()),S.SetCenterPoint(new Tt.Vector3(NaN,NaN,NaN));var f=Tt.ShapeHelper.GetShapeWorldMatrix(h),m=Tt.ShapeHelper.GetShapeWorldMatrix(u);Tt.GeometryHelper.Transform(d,f),Tt.GeometryHelper.Transform(S,m);var y=void 0;y=(y=Tt.MeasureCalculateHelper.LineLineAngle(d,S,y)).toFixed(3);var T=o.GetCamera().GetViewPort().GetScreenRay(n.x,n.y),M=d.GetStartPoint(),g=d.GetEndPoint(),v=g.Sub(M).Clone(),C=S.GetStartPoint(),_=S.GetEndPoint(),A=(C.Add(_).Divide(2).Clone(),C.Add(v).Clone()),E=new Tt.Plane(T.GetDirection(),M).Project(T.GetOrigin()),G=new Tt.Line3D(M,g);Tt.Color.GREEN().Clone();G.SetColor(yt.SelectColor().Clone());var P=new Tt.Line3D(C,_);P.SetColor(yt.SelectColor().Clone());var w=new Tt.Line3D(C,A);Tt.Color.YELLOW().Clone();w.SetColor(yt.ExLineColor().Clone()),w.SetName("exLine");var D=new Tt.Line3D(M,C);D.SetColor(yt.ExLineColor().Clone()),D.SetName("exLine");var x=new Tt.Line3D(g,A);x.SetColor(yt.ExLineColor().Clone()),x.SetName("exLine");var R=new Array;Tt.MeasureDisplayHelper.CreateAngleMark(C,A,C,_,y,R);var I=void 0;if(0<R.length){for(var L=0;L<R.length-1;L++){var N=new Tt.Line3D(R[L],R[L+1]);N.SetColor(yt.MeasureColor1().Clone()),a.AddLine(N)}I=0<y&&y<90||90<y&&y<180?new Tt.Line3D(R[R.length/2].Add(R[R.length/2-1]).Divide(2).Clone(),E):y-90<1e-7&&-1e-7<y-90?new Tt.Line3D(R[1],E):new Tt.Line3D(C,E)}else I=new Tt.Line3D(C,E);I.SetName("MeasureImageLeader"),I.SetColor(yt.LeaderColor().Clone());(new Array).push(40);var O=String(y),b=new Tt.ComText,V=new Tt.CText;V.SetText(O),b.AddCText(V),a.ComTexts.push(b);o.GetSceneBox().Length();a.AddLine(I),a.AddLine(G),a.AddLine(P),a.AddLine(w);var F=new Tt.Shape2DSet,B=new Tt.Vector2(1,1),U=new Tt.Vector2(250,100);Tt.MeasureDisplayHelper.createRectImage(F,B,U,450,yt.MeasureColor1().Clone(),p,p,c,"线线角度",O,40,!0);Tt.MeasureDisplayHelper.addImageToMemory(o,null,F,E,7,1.5,a)}return a},yt.createLineToFaceAngle=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(4==e.length){var r=e[0],i=e[1],n=e[2],o=null,a=(V=e[3]).GetShape(r),s=V.GetShape(i);if(a&&s&&a.GetType()==Tt.ShapeType.SHAPE_EDGE&&s.GetType()==Tt.ShapeType.SHAPE_FACE){Tt.LOGE("createLineTOFaceAngle step2"),(o=new Tt.MeasureAngle).SetMeasureType(Tt.Measure.MEASURE_TYPE_LINE_FACE_ANGLE);var l=s,h=((U=a).GetLineData(),l.GetMesh()),u=U.GetGeoAttribute(),p=l.GetGeoAttribute(),c=(Tt.Color.GRAY().Clone(),Tt.Color.WHITE().Clone()),d=Tt.Color.BLACK().Clone();Tt.Color.GREEN().Clone(),Tt.Color.RED().Clone(),Tt.Color.BLUE().Clone();if(null!=u&&u.GetGeoAttrType()==Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_LINE&&null!=p&&p.GetGeoAttrType()==Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_PLANEFACE){var S=u,f=p,m=Tt.ShapeHelper.GetShapeWorldMatrix(U),y=Tt.ShapeHelper.GetShapeWorldMatrix(l);Tt.GeometryHelper.Transform(S,m),Tt.GeometryHelper.Transform(f,y);var T=void 0;T=Tt.MeasureCalculateHelper.LineFaceAngle(S,f,T).toFixed(3);var M=h.GetBoundingBox().Center();Tt.GeometryHelper.Transform(M,y);var g=V.GetCamera().GetViewPort().GetScreenRay(n.x,n.y),v=S.GetStartPoint(),C=S.GetEndPoint(),_=(k=v.Add(C).Divide(2).Clone()).Add(M).Divide(2).Clone(),A=new Tt.Plane(g.GetDirection(),v).Project(g.GetOrigin());(z=new Tt.Line3D(k,M)).SetColor(yt.MeasureColor1().Clone()),(W=new Tt.Line3D(_,A)).SetName("MeasureImageLeader"),W.SetColor(yt.LeaderColor().Clone()),(Y=new Tt.Line3D(v,C)).SetColor(yt.SelectColor().Clone()),(X=new Tt.Point(k)).SetDrawType(1),X.SetSize(.8),o.AddPoint(X),(j=new Tt.Point(M)).SetDrawType(1),j.SetSize(.8),o.AddPoint(j);var E=T.toString(),G="线面夹角",P=40;(new Array).push(P);var w=250,D=(V.GetSceneBox().Length(),new Tt.ComText),x=new Tt.CText;x.SetText(E),D.AddCText(x),o.ComTexts.push(D),o.AddLine(z),o.AddLine(W),o.AddLine(Y);var R=new Tt.Shape2DSet,I=40,L=new Tt.Vector2(1,1),N=new Tt.Vector2(w,100),O=450;Tt.MeasureDisplayHelper.createRectImage(R,L,N,O,yt.MeasureColor1().Clone(),c,c,d,G,E,I,!0);var b=null;Tt.MeasureDisplayHelper.addImageToMemory(V,b,R,A,(w+O)/100,1.5,o)}else o=null}return o}if(6==e.length){r=e[0],i=e[1],e[2];var V,F=e[3],B=(n=e[4],o=null,a=(V=e[5]).GetShape(r),s=V.GetShape(i),V.GetShape(F));if(a&&s&&B&&a.GetType()==Tt.ShapeType.SHAPE_EDGE&&s.GetType()==Tt.ShapeType.SHAPE_FACE&&B.GetType()==Tt.ShapeType.SHAPE_POINT_HANDLE){(o=new Tt.MeasureAngle).SetMeasureType(Tt.Measure.MEASURE_TYPE_LINE_FACE_ANGLE);l=s,(U=a).GetLineData(),h=l.GetMesh();var U,H=B.GetPosition();u=U.GetGeoAttribute(),p=l.GetGeoAttribute(),Tt.Color.GRAY().Clone(),c=Tt.Color.WHITE().Clone(),d=Tt.Color.BLACK().Clone(),Tt.Color.GREEN().Clone(),Tt.Color.RED().Clone(),Tt.Color.BLUE().Clone();if(null!=u&&u.GetGeoAttrType()==Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_LINE&&null!=p&&p.GetGeoAttrType()==Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_PLANEFACE){S=u,f=p,m=Tt.ShapeHelper.GetShapeWorldMatrix(U),y=Tt.ShapeHelper.GetShapeWorldMatrix(l);Tt.GeometryHelper.Transform(S,m),Tt.GeometryHelper.Transform(f,y);T=void 0;T=Tt.MeasureCalculateHelper.LineFaceAngle(S,f,T).toFixed(3);var k,z,W,Y,X,j;g=V.GetCamera().GetViewPort().GetScreenRay(n.x,n.y),v=S.GetStartPoint(),C=S.GetEndPoint(),_=(k=v.Add(C).Divide(2)).Add(H).Divide(2).Clone(),A=new Tt.Plane(g.GetDirection(),v).Project(g.GetOrigin());(z=new Tt.Line3D(k,H)).SetColor(yt.MeasureColor1().Clone()),(W=new Tt.Line3D(_,A)).SetName("MeasureImageLeader"),W.SetColor(yt.LeaderColor().Clone()),(Y=new Tt.Line3D(v,C)).SetColor(yt.SelectColor().Clone()),(X=new Tt.Point(k)).SetDrawType(1),X.SetSize(.8),o.AddPoint(X),(j=new Tt.Point(H)).SetDrawType(1),j.SetSize(.8),o.AddPoint(j);E=String(T),G="线面角度",P=40;(new Array).push(P);w=250,V.GetSceneBox().Length();o.AddLine(z),o.AddLine(W),o.AddLine(Y);R=new Tt.Shape2DSet,I=40,L=new Tt.Vector2(1,1),N=new Tt.Vector2(P,100),O=450;Tt.MeasureDisplayHelper.createRectImage(R,L,N,O,yt.MeasureColor1().Clone(),c,c,d,G,E,I,!0);b=null;Tt.MeasureDisplayHelper.addImageToMemory(V,b,R,A,(w+O)/100,1.5,o)}else o=null}return o}},yt.createFaceToFaceAngle=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(4==e.length){var r=e[0],i=e[1],n=e[2],o=null,a=(V=e[3]).GetShape(r),s=V.GetShape(i);if(a&&s&&a.GetType()==Tt.ShapeType.SHAPE_FACE&&s.GetType()==Tt.ShapeType.SHAPE_FACE){(o=new Tt.MeasureAngle).SetMeasureType(Tt.Measure.MEASURE_TYPE_FACE_FACE_ANGLE);var l=s,h=(k=a).GetMesh(),u=l.GetMesh(),p=k.GetGeoAttribute(),c=l.GetGeoAttribute();if(null!=p&&p.GetGeoAttrType()==Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_PLANEFACE&&null!=c&&c.GetGeoAttrType()==Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_PLANEFACE){Tt.LOGI("createFaceTOFaceAngle step3");var d=p,S=c,f=Tt.ShapeHelper.GetShapeWorldMatrix(k),m=Tt.ShapeHelper.GetShapeWorldMatrix(l);Tt.GeometryHelper.Transform(d,f),Tt.GeometryHelper.Transform(S,m);var y=void 0;y=Tt.MeasureCalculateHelper.FaceFaceAngle(d,S,y).toFixed(3);var T=h.GetBoundingBox().Center();Tt.GeometryHelper.Transform(T,f);var M=u.GetBoundingBox().Center();Tt.GeometryHelper.Transform(M,m);var g=T.Add(M).Divide(2).Clone(),v=V.GetCamera().GetViewPort().GetScreenRay(n.x,n.y),C=new Tt.Plane(v.GetDirection(),g).Project(v.GetOrigin());(Y=new Tt.Line3D(g,C)).SetName("MeasureImageLeader"),(X=new Tt.Line3D(T,M)).SetColor(yt.MeasureColor1().Clone()),(j=new Tt.Point(T)).SetDrawType(1),j.SetSize(.8),o.AddPoint(j),(K=new Tt.Point(M)).SetDrawType(1),K.SetSize(.8),o.AddPoint(K),Y.SetColor(yt.LeaderColor().Clone());var _=String(y),A="面面夹角",E=40;(new Array).push(E);var G=250,P=new Tt.ComText,w=new Tt.CText;w.SetText(_),P.AddCText(w),o.ComTexts.push(P);V.GetSceneBox().Length();o.AddLine(Y),o.AddLine(X);var D=new Tt.Shape2DSet,x=40,R=new Tt.Vector2(1,1),I=new Tt.Vector2(G,100),L=450,N=(Tt.Color.GRAY().Clone(),Tt.Color.WHITE().Clone()),O=Tt.Color.BLACK().Clone();Tt.Color.GREEN().Clone(),Tt.Color.RED().Clone(),Tt.Color.BLUE().Clone();Tt.MeasureDisplayHelper.createRectImage(D,R,I,L,yt.MeasureColor1().Clone(),N,N,O,A,_,x,!0);var b=null;Tt.MeasureDisplayHelper.addImageToMemory(V,b,D,C,(G+L)/100,1.5,o)}else o=null}return o}if(6==e.length){r=e[0],i=e[1];var V,F=e[2],B=e[2],U=(n=e[4],o=null,a=(V=e[5]).GetShape(r),s=V.GetShape(i),V.GetShape(F)),H=V.GetShape(B);if(a&&s&&U&&H&&a.GetType()==Tt.ShapeType.SHAPE_FACE&&s.GetType()==Tt.ShapeType.SHAPE_FACE&&U.GetType()==Tt.ShapeType.SHAPE_POINT_HANDLE&&H.GetType()==Tt.ShapeType.SHAPE_POINT_HANDLE){Tt.LOGE("createFaceTOFaceAngle step2"),(o=new Tt.MeasureAngle).SetMeasureType(Tt.Measure.MEASURE_TYPE_FACE_FACE_ANGLE);l=s,h=(k=a).GetMesh(),u=l.GetMesh();var k,z=U.GetPosition(),W=H.GetPosition();p=k.GetGeoAttribute(),c=l.GetGeoAttribute();if(null!=p&&p.GetGeoAttrType()==Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_PLANEFACE&&null!=c&&c.GetGeoAttrType()==Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_PLANEFACE){d=p,S=c,f=Tt.ShapeHelper.GetShapeWorldMatrix(k),m=Tt.ShapeHelper.GetShapeWorldMatrix(l);Tt.GeometryHelper.Transform(d,f),Tt.GeometryHelper.Transform(S,m);y=void 0;y=Tt.MeasureCalculateHelper.FaceFaceAngle(d,S,y).toFixed(3);var Y,X,j,K;g=z.Add(W).Divide(2),v=V.GetCamera().GetViewPort().GetScreenRay(n.x,n.y),C=new Tt.Plane(v.GetDirection(),g).Project(v.GetOrigin());(Y=new Tt.Line3D(g,C)).SetName("MeasureImageLeader"),(X=new Tt.Line3D(z,W)).SetColor(yt.MeasureColor1().Clone()),(j=new Tt.Point(z)).SetDrawType(1),j.SetSize(.8),o.AddPoint(j),(K=new Tt.Point(W)).SetDrawType(1),K.SetSize(.8),o.AddPoint(K),Y.SetColor(yt.LeaderColor().Clone());_=String(y),A="面面夹角",E=40;(new Array).push(E);G=250,V.GetSceneBox().Length();o.AddLine(Y),o.AddLine(X);D=new Tt.Shape2DSet,x=40,R=new Tt.Vector2(1,1),I=new Tt.Vector2(G,100),L=450,Tt.Color.GRAY().Clone(),N=Tt.Color.WHITE().Clone(),O=Tt.Color.BLACK().Clone(),Tt.Color.GREEN().Clone(),Tt.Color.RED().Clone(),Tt.Color.BLUE().Clone();Tt.MeasureDisplayHelper.createRectImage(D,R,I,L,yt.MeasureColor1().Clone(),N,N,O,A,_,x,!0);b=null;Tt.MeasureDisplayHelper.addImageToMemory(V,b,D,C,(G+L)/100,1.5,o)}else o=null}return o}},yt.GetPntProperty=function(e,t,r){r="";var i=t.GetShape(e);if(i&&i.GetType()==Tt.ShapeType.SHAPE_POINT_HANDLE){var n=i,o=n.GetPosition(),a=String(o.x.toFixed(3))+", "+(String(o.y.toFixed(3))+", ")+String(o.z.toFixed(3));n.ClearProperties(),n.AddProperty("Point",a),r=n.GetProperties()}else Tt.LOGE("MeasureFactory.GetPntProperty is NULL"),r="";return r},yt.GetLineProperty=function(e,t,r){r="";var i=t.GetShape(e);if(i&&i.GetType()==Tt.ShapeType.SHAPE_EDGE){var n=i,o=n.GetLineData(),a=n.GetGeoAttribute();if(null!=a&&a.GetGeoAttrType()==Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_LINE){var s=a,l=Tt.ShapeHelper.GetShapeWorldMatrix(n);Tt.GeometryHelper.Transform(s,l);var h=s.GetStartPoint(),u=s.GetEndPoint(),p=(h.Add(u).Divide(2).Clone(),h.Sub(u).Length()),c=(String(p),"Line");(D=new Array).push(p);var d="";d=Tt.MeasureDisplayHelper.SetMeasureUnit(Tt.Parameters.Instance().measureUnitStyle,D,d);var S=String(D[0].toFixed(3))+d;n.AddProperty(c,S),r=n.GetProperties()}else if(null!=a&&a.GetGeoAttrType()==Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_ELLIPSE){var f=a;l=Tt.ShapeHelper.GetShapeWorldMatrix(n);Tt.GeometryHelper.Transform(f,l);h=f.GetStartPoint(),u=f.GetEndPoint();var m=f.GetCenterPoint(),y=f.GetMajorRadius(),T=new Tt.Vector3,M=new Tt.Vector3,g=new Tt.Vector3;f.GetXYZDir(T,M,g);var v=0,C=h.Sub(m).Clone(),_=u.Sub(m).Clone(),A=C.CrossProduct(_).DotProduct(g),E=Tt.Acos(C.DotProduct(_.Divide(C.Length()*_.Length())));v=h==u?2*Tt.PI*y:0<A?E*y:(2*Tt.PI-E)*y;var G=String(y.toFixed(3)),P=String(m.x.toFixed(3))+","+String(m.y.toFixed(3))+","+String(m.z.toFixed(3)),w=String(v.toFixed(3));(D=new Array).push(v);d="";d=Tt.MeasureDisplayHelper.SetMeasureUnit(Tt.Parameters.Instance().measureUnitStyle,D,d),w=String(D[0].toFixed(3))+d,n.AddProperty("CircleCenter",P),n.AddProperty("CircleRadius",G),n.AddProperty("CircleArcLength",w),r=n.GetProperties()}else{Tt.MeasureCalculateHelper.PolyLineLength(o,0);var D;String(0),c="Line";(D=new Array).push(0);d="";d=Tt.MeasureDisplayHelper.SetMeasureUnit(Tt.Parameters.Instance().measureUnitStyle,D,d),String(D[0].toFixed(3))+d,n.AddProperty(c,d),r=n.GetProperties()}}else r="";return Tt.LOGI(" MeasureFactory.GetLineProperty END"),r},yt.GetFaceProperty=function(e,t,r){r="";var i=t.GetShape(e);if(i&&i.GetType()==Tt.ShapeType.SHAPE_FACE){var n=i;n.GetMesh(),n.GetGeoAttribute();r=n.GetProperties()}return Tt.LOGI(" MeasureFactory::GetFaceProperty END"),r},yt.GetModelProperty=function(e,t,r){r="";var i=t.GetShape(e);i&&i.GetType()==Tt.ShapeType.SHAPE_MODEL?r=i.GetProperties():r=t.GetModel().GetProperties();return r},yt.createPntProperty=function(e,t,r){var i=null,n=r.GetShape(e);if(n&&n.GetType()==Tt.ShapeType.SHAPE_POINT_HANDLE){var o=n;(i=new Tt.MeasureProperty).SetMeasureType(Tt.Measure.MEASURE_TYPE_PNT_COORD);var a=o.GetPosition(),s=r.GetCamera().GetViewPort().GetScreenRay(t.x,t.y),l=new Tt.Plane(s.GetDirection(),a).Project(s.GetOrigin()),h=new Tt.Line3D(a,l);h.SetName("MeasureImageLeader"),h.SetColor(yt.LeaderColor().Clone());var u=new Tt.Point(a),p=Tt.Color.GREEN().Clone();u.SetColor(p),u.SetDrawType(1),u.SetSize(.8);var c=String(a.x.toFixed(3))+", "+(String(a.y.toFixed(3))+", ")+String(a.z.toFixed(3));r.GetSceneBox().Length();i.AddLine(h),i.AddPoint(u);var d=new Tt.Shape2DSet,S=new Tt.Vector2(1,1),f=new Tt.Vector2(40*("点坐标".length-1)/2+40,100),m=40*c.length/2+20,y=Tt.Color.GRAY().Clone(),T=Tt.Color.WHITE().Clone(),M=Tt.Color.BLACK().Clone();Tt.Color.GREEN().Clone(),Tt.Color.RED().Clone(),Tt.Color.BLUE().Clone();Tt.MeasureDisplayHelper.createRectImage(d,S,f,m,y,T,T,M,"点坐标",c,40,!0);Tt.MeasureDisplayHelper.addImageToMemory(r,null,d,l,(40*("点坐标".length-1)/2+40+m)/100,1,i)}return i},yt.createLineProperty=function(e,t,r){var i=null,n=r.GetShape(e);if(n&&n.GetType()==Tt.ShapeType.SHAPE_EDGE){var o=n;(i=new Tt.MeasureProperty).SetMeasureType(Tt.Measure.MEASURE_TYPE_LINE_LENGTH);var a=o.GetLineData().GetGeoAttribute();if(null!=a&&a.GetGeoAttrType()==Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_LINE){var s=a,l=Tt.ShapeHelper.GetShapeWorldMatrix(o);Tt.GeometryHelper.Transform(s,l);var h=s.GetStartPoint(),u=s.GetEndPoint(),p=h.Add(u).Divide(2).Clone(),c=r.GetCamera().GetViewPort().GetScreenRay(t.x,t.y),d=new Tt.Plane(c.GetDirection(),p).Project(c.GetOrigin()),S=new Tt.Line3D(h,u),f=Tt.Color.GREEN().Clone();S.SetColor(f);var m=new Tt.Line3D(p,d);Tt.Color.GRAY().Clone();m.SetName("MeasureImageLeader"),m.SetColor(yt.LeaderColor().Clone());var y=h.Sub(u).Length(),T=String(y);r.GetSceneBox().Length();i.AddLine(S),i.AddLine(m);var M=new Tt.Shape2DSet,g=new Tt.Vector2(1,1),v=new Tt.Vector2(180,100),C=Tt.Color.GRAY().Clone(),_=Tt.Color.WHITE().Clone(),A=Tt.Color.BLACK().Clone();Tt.Color.GREEN().Clone(),Tt.Color.RED().Clone(),Tt.Color.BLUE().Clone();Tt.MeasureDisplayHelper.createRectImage(M,g,v,450,C,_,_,A,"长度",T,40,!0);Tt.MeasureDisplayHelper.addImageToMemory(r,null,M,d,6,1,i)}}return i},yt.createCircleProperty=function(e,t,r){var i=null,n=r.GetShape(e);if(n&&n.GetType()==Tt.ShapeType.SHAPE_EDGE){var o=n;(i=new Tt.MeasureProperty).SetMeasureType(Tt.Measure.MEASURE_TYPE_CRICLE_PROPERTY);var a=o.GetLineData(),s=a.GetGeoAttribute();if(null!=s&&s.GetGeoAttrType()==Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_ELLIPSE){var l=s,h=Tt.ShapeHelper.GetShapeWorldMatrix(o);Tt.GeometryHelper.Transform(l,h);var u=l.GetStartPoint(),p=l.GetEndPoint(),c=l.GetCenterPoint(),d=l.GetMajorRadius(),S=new Tt.Vector3,f=new Tt.Vector3,m=new Tt.Vector3;l.GetXYZDir(S,f,m);var y=0,T=u.Sub(c).Clone(),M=p.Sub(c).Clone(),g=T.CrossProduct(M).DotProduct(m),v=Tt.Acos(T.DotProduct(M.Divide(T.Length())));y=u==p?2*Tt.PI*d:0<g?v*d:(2*Tt.PI-v)*d;for(var C=r.GetCamera().GetViewPort().GetScreenRay(t.x,t.y),_=new Tt.Plane(C.GetDirection(),c).Project(C.GetOrigin()),A=a.GetRefLine().GetPoints(),E=a.GetDataOffset(),G=a.GetDataLength(),P=E;P<G;P+=2){var w=new Tt.Line3D(h.Multiply(A[P]).Clone(),h.Multiply(A[P+1]).Clone()),D=Tt.Color.GREEN().Clone();w.SetColor(D),i.AddLine(w)}var x=new Tt.Line3D(c,_);x.SetName("MeasureImageLeader"),x.SetColor(yt.LeaderColor().Clone());var R=new Tt.Line3D(c,u),I=Tt.Color.RED().Clone();R.SetColor(I);var L=new Tt.Point(c);L.SetDrawType(1),L.SetSize(.5);var N=String(d),O=String(c.x)+","+String(c.y)+","+String(c.z),b=String(y);r.GetSceneBox().Length();i.AddLine(x),i.AddLine(R),i.AddPoint(L);var V=new Tt.Shape2DSet,F=new Tt.Vector2(1,1),B=new Tt.Vector2(180,100),U=Tt.Color.GRAY().Clone(),H=Tt.Color.WHITE().Clone(),k=Tt.Color.BLACK().Clone(),z=Tt.Color.GREEN().Clone(),W=Tt.Color.RED().Clone();Tt.Color.BLUE().Clone(),new Tt.Vector2(1,1),new Tt.Vector2(180,300);Tt.MeasureDisplayHelper.createRectImage(V,F,B,450,U,H,H,k,"圆心",O,40,!1);var Y=new Tt.Vector2(1,100),X=new Tt.Vector2(180,200);Tt.MeasureDisplayHelper.createRectImage(V,Y,X,450,W,H,H,k,"半径",N,40,!1);var j=new Tt.Vector2(1,200),K=new Tt.Vector2(180,300);Tt.MeasureDisplayHelper.createRectImage(V,j,K,450,z,H,k,k,"弧长",b,40,!0);Tt.MeasureDisplayHelper.addImageToMemory(r,null,V,_,6,3,i)}}return i},yt.createFaceProperty=function(e,t,r){var i=null,n=r.GetShape(e);if(n&&n.GetType()==Tt.ShapeType.SHAPE_FACE){var o=n;(i=new Tt.MeasureProperty).SetMeasureType(Tt.Measure.MEASURE_TYPE_FACE_PROPERTY);var a=o.GetMesh(),s=a.GetGeoAttribute();if(Tt.MeasureCalculateHelper.faceArea(a,0),null!=s&&s.GetGeoAttrType()==Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_PLANEFACE){var l=s,h=Tt.ShapeHelper.GetShapeWorldMatrix(o);Tt.GeometryHelper.Transform(l,h);var u=a.GetBoundingBox().Center();Tt.GeometryHelper.Transform(u,h);var p=r.GetCamera().GetViewPort().GetScreenRay(t.x,t.y),c=new Tt.Plane(p.GetDirection(),u).Project(p.GetOrigin());(A=new Tt.Line3D(u,c)).SetName("MeasureImageLeader"),A.SetColor(yt.LeaderColor().Clone());l.GetNormal();var d=String(0);r.GetSceneBox().Length();i.AddLine(A);var S=new Tt.Shape2DSet,f=40,m=new Tt.Vector2(1,1),y=new Tt.Vector2(180,100),T=450,M=Tt.Color.GRAY().Clone(),g=Tt.Color.WHITE().Clone(),v=Tt.Color.BLACK().Clone();Tt.Color.GREEN().Clone(),Tt.Color.RED().Clone(),Tt.Color.BLUE().Clone();Tt.MeasureDisplayHelper.createRectImage(S,m,y,T,M,g,g,v,"面积",d,f,!0);var C=null;Tt.MeasureDisplayHelper.addImageToMemory(r,C,S,c,6,1,i)}else if(null!=s&&s.GetGeoAttrType()==Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_REVOLUTIONFACE){var _=s;h=Tt.ShapeHelper.GetShapeWorldMatrix(o);Tt.GeometryHelper.Transform(_,h);u=a.GetBoundingBox().Center();Tt.GeometryHelper.Transform(u,h);p=r.GetCamera().GetViewPort().GetScreenRay(t.x,t.y),c=new Tt.Plane(p.GetDirection(),u).Project(p.GetOrigin());(A=new Tt.Line3D(u,c)).SetName("MeasureImageLeader"),A.SetColor(yt.LeaderColor().Clone());_.GetRadius(),d=String(0),r.GetSceneBox().Length();i.AddLine(A);S=new Tt.Shape2DSet,f=40,m=new Tt.Vector2(1,1),y=new Tt.Vector2(200,100),T=450,M=Tt.Color.GRAY().Clone(),g=Tt.Color.WHITE().Clone(),v=Tt.Color.BLACK().Clone(),Tt.Color.GREEN().Clone(),Tt.Color.RED().Clone(),Tt.Color.BLUE().Clone();Tt.MeasureDisplayHelper.createRectImage(S,m,y,T,M,g,g,v,"面积",d,f,!0);C=null;Tt.MeasureDisplayHelper.addImageToMemory(r,C,S,c,6,1,i)}else if(null!=s&&s.GetGeoAttrType()==Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_CYLINDERFACE){_=s,h=Tt.ShapeHelper.GetShapeWorldMatrix(o);Tt.GeometryHelper.Transform(_,h);u=a.GetBoundingBox().Center();Tt.GeometryHelper.Transform(u,h);p=r.GetCamera().GetViewPort().GetScreenRay(t.x,t.y),c=new Tt.Plane(p.GetDirection(),u).Project(p.GetOrigin());(A=new Tt.Line3D(u,c)).SetName("MeasureImageLeader"),A.SetColor(yt.LeaderColor().Clone());d=String(0),r.GetSceneBox().Length();i.AddLine(A);S=new Tt.Shape2DSet,f=40,m=new Tt.Vector2(1,1),y=new Tt.Vector2(200,100),T=450,M=Tt.Color.GRAY().Clone(),g=Tt.Color.WHITE().Clone(),v=Tt.Color.BLACK().Clone(),Tt.Color.GREEN().Clone(),Tt.Color.RED().Clone(),Tt.Color.BLUE().Clone();Tt.MeasureDisplayHelper.createRectImage(S,m,y,T,M,g,g,v,"面积",d,f,!0);C=null;Tt.MeasureDisplayHelper.addImageToMemory(r,C,S,c,6,1,i)}else if(null!=s&&s.GetGeoAttrType()==Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_CONICALFACE){_=s,h=Tt.ShapeHelper.GetShapeWorldMatrix(o);Tt.GeometryHelper.Transform(_,h);u=a.GetBoundingBox().Center();Tt.GeometryHelper.Transform(u,h);p=r.GetCamera().GetViewPort().GetScreenRay(t.x,t.y),c=new Tt.Plane(p.GetDirection(),u).Project(p.GetOrigin());(A=new Tt.Line3D(u,c)).SetName("MeasureImageLeader"),A.SetColor(yt.LeaderColor().Clone());d=String(0),r.GetSceneBox().Length();i.AddLine(A);S=new Tt.Shape2DSet,f=40,m=new Tt.Vector2(1,1),y=new Tt.Vector2(200,100),T=450,M=Tt.Color.GRAY().Clone(),g=Tt.Color.WHITE().Clone(),v=Tt.Color.BLACK().Clone(),Tt.Color.GREEN().Clone(),Tt.Color.RED().Clone(),Tt.Color.BLUE().Clone();Tt.MeasureDisplayHelper.createRectImage(S,m,y,T,M,g,g,v,"面积",d,f,!0);C=null;Tt.MeasureDisplayHelper.addImageToMemory(r,C,S,c,6,1,i)}else if(null!=s&&s.GetGeoAttrType()==Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_SPHEREFACE){_=s,h=Tt.ShapeHelper.GetShapeWorldMatrix(o);Tt.GeometryHelper.Transform(_,h);u=a.GetBoundingBox().Center();Tt.GeometryHelper.Transform(u,h);p=r.GetCamera().GetViewPort().GetScreenRay(t.x,t.y),c=new Tt.Plane(p.GetDirection(),u).Project(p.GetOrigin());(A=new Tt.Line3D(u,c)).SetName("MeasureImageLeader"),A.SetColor(yt.LeaderColor().Clone());d=String(0),r.GetSceneBox().Length();i.AddLine(A);S=new Tt.Shape2DSet,f=40,m=new Tt.Vector2(1,1),y=new Tt.Vector2(200,100),T=450,M=Tt.Color.GRAY().Clone(),g=Tt.Color.WHITE().Clone(),v=Tt.Color.BLACK().Clone(),Tt.Color.GREEN().Clone(),Tt.Color.RED().Clone(),Tt.Color.BLUE().Clone();Tt.MeasureDisplayHelper.createRectImage(S,m,y,T,M,g,g,v,"面积",d,f,!0);C=null;Tt.MeasureDisplayHelper.addImageToMemory(r,C,S,c,6,1,i)}else if(null!=s&&s.GetGeoAttrType()==Tt.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_TOROIDALFACE){_=s,h=Tt.ShapeHelper.GetShapeWorldMatrix(o);Tt.GeometryHelper.Transform(_,h);u=a.GetBoundingBox().Center();Tt.GeometryHelper.Transform(u,h);p=r.GetCamera().GetViewPort().GetScreenRay(t.x,t.y),c=new Tt.Plane(p.GetDirection(),u).Project(p.GetOrigin());(A=new Tt.Line3D(u,c)).SetName("MeasureImageLeader"),A.SetColor(yt.LeaderColor().Clone());d=String(0),r.GetSceneBox().Length();i.AddLine(A);S=new Tt.Shape2DSet,f=40,m=new Tt.Vector2(1,1),y=new Tt.Vector2(200,100),T=450,M=Tt.Color.GRAY().Clone(),g=Tt.Color.WHITE().Clone(),v=Tt.Color.BLACK().Clone(),Tt.Color.GREEN().Clone(),Tt.Color.RED().Clone(),Tt.Color.BLUE().Clone();Tt.MeasureDisplayHelper.createRectImage(S,m,y,T,M,g,g,v,"面积",d,f,!0);C=null;Tt.MeasureDisplayHelper.addImageToMemory(r,C,S,c,6,1,i)}else{h=Tt.ShapeHelper.GetShapeWorldMatrix(o),u=a.GetBoundingBox().Center();Tt.GeometryHelper.Transform(u,h);var A;p=r.GetCamera().GetViewPort().GetScreenRay(t.x,t.y),c=new Tt.Plane(p.GetDirection(),u).Project(p.GetOrigin());(A=new Tt.Line3D(u,c)).SetName("MeasureImageLeader"),A.SetColor(yt.LeaderColor().Clone());d=String(0),r.GetSceneBox().Length();i.AddLine(A);S=new Tt.Shape2DSet,f=40,m=new Tt.Vector2(1,1),y=new Tt.Vector2(180,100),T=450,M=Tt.Color.GRAY().Clone(),g=Tt.Color.WHITE().Clone(),v=Tt.Color.BLACK().Clone(),Tt.Color.GREEN().Clone(),Tt.Color.RED().Clone(),Tt.Color.BLUE().Clone();Tt.MeasureDisplayHelper.createRectImage(S,m,y,T,M,g,g,v,"面积",d,f,!0);C=null;Tt.MeasureDisplayHelper.addImageToMemory(r,C,S,c,6,1,i)}}return i},yt.createModelProperty=function(e,t,r){var i=null,n=r.GetShape(e);if(n&&n.GetType()==Tt.ShapeType.SHAPE_MODEL){var o=n;(i=new Tt.MeasureProperty).SetMeasureType(Tt.Measure.MEASURE_TYPE_MODEL_PROPERTY);var a=o.GetName(),s=(o.GetColor(),o.GetVertexCount(0)/3),l=(o.GetVertexCount(1),Tt.ShapeHelper.GetShapeWorldMatrix(o)),h=o.GetBoundingBox().Center();Tt.GeometryHelper.Transform(h,l);var u=r.GetCamera().GetViewPort().GetScreenRay(t.x,t.y),p=new Tt.Plane(u.GetDirection(),h).Project(u.GetOrigin()),c=new Tt.Line3D(h,p);c.SetName("MeasureImageLeader"),c.SetColor(yt.LeaderColor().Clone()),i.AddLine(c);var d=new Tt.Shape2DSet,S=Tt.Color.GRAY().Clone(),f=Tt.Color.WHITE().Clone(),m=Tt.Color.BLACK().Clone(),y=(Tt.Color.GREEN().Clone(),Tt.Color.RED().Clone()),T=(Tt.Color.BLUE().Clone(),new Tt.Vector2(1,1),new Tt.Vector2(180,200),new Tt.Vector2(1,1)),M=new Tt.Vector2(180,100);Tt.MeasureDisplayHelper.createRectImage(d,T,M,500,S,f,f,m,"名称",a,40,!1);var g=new Tt.Vector2(1,100),v=new Tt.Vector2(180,200);Tt.MeasureDisplayHelper.createRectImage(d,g,v,500,y,f,f,m,"面数",String(s),40,!0);Tt.MeasureDisplayHelper.addImageToMemory(r,null,d,p,6,2,i)}return i},yt.AddMeasureToScene=function(e,t){var r=!1;if(e&&t){var i=e.GetMeasureGroup(),n=new Tt.ShapeNode;n.SetShape(t);var o=n.GetID().toString();n.SetName(i.GetName()+"|"+o),i.AddChild(n),e.AddShapeIDToMap(t),r=!0}return r},yt.UpdateMeasureImagePos=function(e,t,r){var i=new Tt.Vector3;if(null!=e&&null!=r){for(var n=e.GetImageBoards(),o=0;o<n.length;o++){var a=n[0];if(a){var s=a.GetPosition().Clone(),l=r.GetCamera().GetViewPort().GetScreenRay(t.x,t.y);s=new Tt.Plane(l.GetDirection(),s).Project(l.GetOrigin()),a.SetPosition(s),i=s}}var h=e.LineList;for(o=0;o<h.length;o++){var u=h[o];u&&"MeasureImageLeader"==u.GetName()&&(u.EndPoint=i)}r.GetRenderManager().RequestRedraw()}},yt.MeasureToXMLElement=function(e,t){var r=document,i=r.createElement(yt.Serializer_XML_Element_Measures);i.setAttribute(yt.Serializer_XML_Attribute_ID,String(e.GetID())),i.setAttribute(yt.Serializer_XML_Attribute_MeasureType,String(e.GetMeasureType()));var n=r.createElement(yt.Serializer_XML_Element_ImageBoard);if(i.appendChild(n),0<e.imageBoardList.length){var o=e.imageBoardList[0].GetPosition(),a=r.createElement(yt.Serializer_XML_Element_Center);a.setAttribute(yt.Serializer_XML_Attribute_X,String(o.x)),a.setAttribute(yt.Serializer_XML_Attribute_Y,String(o.y)),a.setAttribute(yt.Serializer_XML_Attribute_Z,String(o.z)),n.appendChild(a)}var s=r.createElement(yt.Serializer_XML_Element_Points);i.appendChild(s);for(var l=0;l<e.PointList.length;l++){var h=e.PointList[l],u=r.createElement(yt.Serializer_XML_Element_Point);s.appendChild(u),u.setAttribute(yt.Serializer_XML_Attribute_X,String(h.GetCoordinate().x)),u.setAttribute(yt.Serializer_XML_Attribute_Y,String(h.GetCoordinate().y)),u.setAttribute(yt.Serializer_XML_Attribute_Z,String(h.GetCoordinate().z));var p=h.GetColor(),c=String(p.r)+" "+String(p.g)+" "+String(p.b);u.setAttribute(yt.Serializer_XML_Attribute_Color,c)}var d=new Tt.Vector3,S=r.createElement(yt.Serializer_XML_Element_Line3Ds);i.appendChild(S);for(var f=0;f<e.LineList.length;f++){var m=e.LineList[f],y=r.createElement(yt.Serializer_XML_Element_Line3D);S.appendChild(y);var T=r.createElement(yt.Serializer_XML_Element_Color);y.appendChild(T);p=m.GetColor();T.setAttribute(yt.Serializer_XML_Attribute_R,String(p.r)),T.setAttribute(yt.Serializer_XML_Attribute_G,String(p.g)),T.setAttribute(yt.Serializer_XML_Attribute_B,String(p.b));var M=r.createElement(yt.Serializer_XML_Element_Position);y.appendChild(M),M.setAttribute(yt.Serializer_XML_Attribute_X,String(m.StartPoint.x)),M.setAttribute(yt.Serializer_XML_Attribute_Y,String(m.StartPoint.y)),M.setAttribute(yt.Serializer_XML_Attribute_Z,String(m.StartPoint.z));var g=r.createElement(yt.Serializer_XML_Element_Direction);y.appendChild(g),g.setAttribute(yt.Serializer_XML_Attribute_X,String(m.EndPoint.x)),g.setAttribute(yt.Serializer_XML_Attribute_Y,String(m.EndPoint.y)),g.setAttribute(yt.Serializer_XML_Attribute_Z,String(m.EndPoint.z)),"MeasureImageLeader"==m.GetName()?(y.setAttribute(yt.Serializer_XML_Attribute_Type,String(1)),d=m.EndPoint.Clone()):y.setAttribute(yt.Serializer_XML_Attribute_Type,String(0))}var v=r.createElement(yt.Serializer_XML_Element_MeasureTexts);if(i.appendChild(v),0<e.ComTexts.length)for(l=0;l<e.ComTexts.length;l++){var C=e.ComTexts[l],_=r.createElement(yt.Serializer_XML_Element_Texts);v.appendChild(_);var A=r.createElement(yt.Serializer_XML_Element_Text);_.appendChild(A),A.setAttribute(yt.Serializer_XML_Attribute_Value,C.GetCText(0).GetText());var E=r.createElement(yt.Serializer_XML_Element_Location);A.appendChild(E),E.setAttribute(yt.Serializer_XML_Attribute_X,String(d.x)),E.setAttribute(yt.Serializer_XML_Attribute_Y,String(d.y)),E.setAttribute(yt.Serializer_XML_Attribute_Z,String(d.z));T=r.createElement(yt.Serializer_XML_Element_Color);A.appendChild(T);p=C.GetColor();T.setAttribute(yt.Serializer_XML_Attribute_R,String(p.r)),T.setAttribute(yt.Serializer_XML_Attribute_G,String(p.g)),T.setAttribute(yt.Serializer_XML_Attribute_B,String(p.b))}return i.outerHTML},yt.CreateMeasureFromXMLElement=function(e,t){var r=null,i=new Tt.Vector3,n=new Tt.Vector3,o=new Tt.Vector3;if(0==t.length)return r;r=new Tt.MeasureDistance;var a=t.firstChild;if(null==a)return null;Number(a.getAttribute(yt.Serializer_XML_Attribute_ID));var s=Number(a.getAttribute(yt.Serializer_XML_Attribute_MeasureType));r.SetMeasureType(s);var l=new Tt.Vector3,h=a.getElementsByTagName(yt.Serializer_XML_Element_ImageBoard)[0];if(h){var u=h.getElementsByTagName(yt.Serializer_XML_Element_Center)[0];l.x=Number(u.getAttribute(yt.Serializer_XML_Attribute_X)),l.y=Number(u.getAttribute(yt.Serializer_XML_Attribute_Y)),l.z=Number(u.getAttribute(yt.Serializer_XML_Attribute_Z))}var p=a.getElementsByTagName(yt.Serializer_XML_Element_Points)[0];if(p){for(var c=p.getElementsByTagName(yt.Serializer_XML_Element_Point),d=new Array,S=0;S<c.length;S++){var f=new Tt.Vector3;f.x=Number(c[S].getAttribute(yt.Serializer_XML_Attribute_X)),f.y=Number(c[S].getAttribute(yt.Serializer_XML_Attribute_Y)),f.z=Number(c[S].getAttribute(yt.Serializer_XML_Attribute_Z)),d.push(f)}i=d[0];var m=new Tt.Point(i);if(m.SetDrawType(1),m.SetSize(.8),r.AddPoint(m),1==S)n=i;else{n=d[1];var y=new Tt.Point(n);y.SetDrawType(1),y.SetSize(.8),r.AddPoint(y)}}var T=a.getElementsByTagName(yt.Serializer_XML_Element_Line3Ds)[0];if(T)for(var M=T.getElementsByTagName(yt.Serializer_XML_Element_Line3D),g=0;g<M.length;g++){var v=void 0,C=void 0,_=new Tt.Vector3,A=new Tt.Vector3,E=M[g].getElementsByTagName(yt.Serializer_XML_Element_Color)[0];(C=new Tt.Color).r=Number(E.getAttribute(yt.Serializer_XML_Attribute_R)),C.g=Number(E.getAttribute(yt.Serializer_XML_Attribute_G)),C.b=Number(E.getAttribute(yt.Serializer_XML_Attribute_B));var G=M[g].getElementsByTagName(yt.Serializer_XML_Element_Position)[0];(d=new Tt.Vector3).x=Number(G.getAttribute(yt.Serializer_XML_Attribute_X)),d.y=Number(G.getAttribute(yt.Serializer_XML_Attribute_Y)),d.z=Number(G.getAttribute(yt.Serializer_XML_Attribute_Z)),_=d;var P=M[g].getElementsByTagName(yt.Serializer_XML_Element_Direction)[0];(d=new Tt.Vector3).x=Number(P.getAttribute(yt.Serializer_XML_Attribute_X)),d.y=Number(P.getAttribute(yt.Serializer_XML_Attribute_Y)),d.z=Number(P.getAttribute(yt.Serializer_XML_Attribute_Z)),A=d;var w=Number(M[g].getAttribute(yt.Serializer_XML_Attribute_Type));(v=new Tt.Line3D(_,A)).SetColor(C),1==w&&v.SetName("MeasureImageLeader"),r.AddLine(v)}var D=a.getElementsByTagName(yt.Serializer_XML_Element_MeasureTexts)[0];if(D)for(var x=D.getElementsByTagName(yt.Serializer_XML_Element_Texts),R=0;R<x.length;R++){var I=x.getElementsByTagName(yt.Serializer_XML_Element_Text),L=I.Attribute(yt.Serializer_XML_Attribute_Value);L;var N=new Tt.ComText,O=new Tt.CText;if(O.SetText(L),N.AddCText(O),r.ComTexts.push(N),I){C=void 0,E=I.getElementsByTagName(yt.Serializer_XML_Element_Color);(C=new Tt.Color).r=E.FloatAttribute(yt.Serializer_XML_Attribute_R),C.g=E.FloatAttribute(yt.Serializer_XML_Attribute_G),C.b=E.FloatAttribute(yt.Serializer_XML_Attribute_B);var b=I.getElementsByTagName(yt.Serializer_XML_Element_Location);(o=new Tt.Vector3).x=b.FloatAttribute(yt.Serializer_XML_Attribute_X),o.y=b.FloatAttribute(yt.Serializer_XML_Attribute_Y),o.z=b.FloatAttribute(yt.Serializer_XML_Attribute_Z)}x=x.NextSiblingElement(yt.Serializer_XML_Element_Texts)}new Array;var V=new Array;for(new Array,S=0;S<r.ComTexts.length;S++){r.ComTexts[S].GetCText(0).GetText();var F=void 0;V.push(Number(F))}if(0===r.ComTexts.length&&1===r.GetMeasureType()){F=r.PointList[0].GetCoordinate().Sub(r.PointList[1].GetCoordinate()).Length();V.push(Number(F))}var B="";B=Tt.MeasureDisplayHelper.SetMeasureUnit(Tt.Parameters.Instance().measureUnitStyle,V,B);var U=new Tt.Shape2DSet,H=(Tt.Color.GRAY().Clone(),Tt.Color.WHITE().Clone()),k=Tt.Color.BLACK().Clone();for(Tt.Color.GREEN().Clone(),Tt.Color.RED().Clone(),Tt.Color.BLUE().Clone(),S=0;S<V.length;S++){var z=V[S].toFixed(3).toString()+B,W=new Tt.Vector2,Y=new Tt.Vector2,X=void 0;0==S?(W.x=W.y=1,Y.x=250,Y.y=100,X=yt.MeasureColor1().Clone()):1==S?(W.x=1,W.y=100,Y.x=250,Y.y=200,X=yt.MeasureColor2().Clone()):2==S&&(W.x=1,W.y=200,Y.x=250,Y.y=300,X=yt.MeasureColor3().Clone());var j=!1;S+1==V.length&&(j=!0),Tt.MeasureDisplayHelper.createRectImage(U,W,Y,450,X,H,H,k,"点点距离",z,40,j)}return Tt.MeasureDisplayHelper.addImageToMemory(e,null,U,l,700/(Tt.MeasureDisplayHelper.IsPC()?100:40),Tt.MeasureDisplayHelper.IsPC()?2:4,r),r.SetFrontShow(!0),r&&yt.AddMeasureToScene(e,r),r},yt.m_leaderColor=null,yt.m_selectColor=null,yt.m_exLineColor=null,yt.m_measureColor1=null,yt.m_measureColor2=null,yt.m_measureColor3=null,yt.Serializer_XML_Element_SVL="svl",yt.Serializer_XML_Element_Model="model",yt.Serializer_XML_Element_Users="users",yt.Serializer_XML_Element_User="user",yt.Serializer_XML_Element_Measures="measures",yt.Serializer_XML_Element_Color="color",yt.Serializer_XML_Element_ImageBoard="imageboard",yt.Serializer_XML_Element_Center="center",yt.Serializer_XML_Element_Line3Ds="line3ds",yt.Serializer_XML_Element_Line3D="line3d",yt.Serializer_XML_Element_Points="points",yt.Serializer_XML_Element_Point="point",yt.Serializer_XML_Element_Position="position",yt.Serializer_XML_Element_Direction="direction",yt.Serializer_XML_Element_MeasureTexts="measuretexts",yt.Serializer_XML_Element_Texts="texts",yt.Serializer_XML_Element_Text="text",yt.Serializer_XML_Element_Location="location",yt.Serializer_XML_Element_Attributes="attributes",yt.Serializer_XML_Element_Attribute="attribute",yt.Serializer_XML_Attribute_ID="id",yt.Serializer_XML_Attribute_MeasureType="measuretype",yt.Serializer_XML_Attribute_UserID="userid",yt.Serializer_XML_Attribute_Created="created",yt.Serializer_XML_Attribute_R="r",yt.Serializer_XML_Attribute_G="g",yt.Serializer_XML_Attribute_B="b",yt.Serializer_XML_Attribute_Color="color",yt.Serializer_XML_Attribute_X="x",yt.Serializer_XML_Attribute_Y="y",yt.Serializer_XML_Attribute_Z="z",yt.Serializer_XML_Attribute_Value="value",yt.Serializer_XML_Attribute_Length="length",yt.Serializer_XML_Attribute_Type="type",yt.Serializer_XML_Attribute_Key="key",yt.Serializer_XML_Attribute_URI="uri",yt.Serializer_XML_Attribute_Width="width",yt.Serializer_XML_Attribute_Height="height",yt.Serializer_XML_Attribute_Name="name",yt}();Tt.MeasureFactory=e}(M3D||(M3D={})),function(r){var e=function(t){function e(){var e=t.call(this)||this;return e.InitMeasureDistance(),e}return __extends(e,t),e.prototype.InitMeasureDistance=function(){this.SetType(r.ShapeType.SHAPE_MEASURE_PROPERTY)},e}(r.Measure);r.MeasureProperty=e}(M3D||(M3D={})),function(f){var e=function(){function e(){}return e.Transform=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(2==e.length)if(e[0]instanceof f.LineAttribute&&e[1]instanceof f.Matrix3x4){var r=e[0],i=(S=e[1]).Multiply(r.GetCenterPoint()).Clone(),n=(S.Multiply(new f.Vector4(r.GetDirection(),0)).Clone(),S.Multiply(r.GetStartPoint()).Clone()),o=S.Multiply(r.GetEndPoint()).Clone();r.SetCenterPoint(i),r.SetDirection(o.Sub(n).Clone()),r.SetStartPoint(n),r.SetEndPoint(o)}else if(e[0]instanceof f.EllipseAttribute&&e[1]instanceof f.Matrix3x4){r=e[0],i=(S=e[1]).Multiply(r.GetCenterPoint()).Clone(),n=S.Multiply(r.GetStartPoint()).Clone(),o=S.Multiply(r.GetEndPoint()).Clone();var a=new f.Vector3,s=new f.Vector3,l=new f.Vector3;r.GetXYZDir(a,s,l),a.copyFrom(S.Multiply(new f.Vector4(a,0))),s.copyFrom(S.Multiply(new f.Vector4(s,0))),l.copyFrom(S.Multiply(new f.Vector4(l,0))),r.SetCenterPoint(i),r.SetStartPoint(n),r.SetEndPoint(o),r.SetXYZDir(a,s,l)}else if(e[0]instanceof f.PlaneFaceAttribute&&e[1]instanceof f.Matrix3x4){r=e[0];var h=(S=e[1]).Multiply(new f.Vector4(r.GetNormal(),0)).Clone(),u=r.GetOrigin();r.SetOrigin(S.Multiply(u).Clone()),r.SetNormal(h)}else if(e[0]instanceof f.RevolutionFaceAttribute&&e[1]instanceof f.Matrix3x4){r=e[0];var p=(S=e[1]).Multiply(new f.Vector4(r.GetRevoAxis(),0)).Clone(),c=S.Multiply(r.GetAxisOrigin()).Clone();r.SetAxisOrigin(c),r.SetRevoAxis(p)}else if(e[0]instanceof f.Vector3&&e[1]instanceof f.Matrix3x4){var d=e[0],S=e[1];d.copyFrom(S.Multiply(d).Clone())}},e}();f.GeometryHelper=e}(M3D||(M3D={})),function($){var e=function(){function k(){}return k.PntPntDistance=function(e,t){return e.Sub(t).Length()},k.PntLineDistance=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(5==e.length){if(e[1]instanceof $.LineAttribute){var r=e[0],i=e[1],n=e[2],o=(e[3],e[4]),a=new $.Ray(i.GetStartPoint(),i.GetDirection());return o.copyFrom(a.Project(r)),0,n=r.Sub(o).Length()}if(e[1]instanceof $.Vector3){var s=e[0],l=e[1],h=e[2],u=e[3],p=e[4],c=new $.Vector3;return k.pntInSegment(h,s,l,c),u=h.Sub(c).Length(),p.copyFrom(c),u}}else{if(7==e.length){r=e[0];var d=e[1],S=(n=e[2],e[3],o=e[4],e[5],e[6]);0;var f=d.GetCenterPoint(),m=d.GetStartPoint(),y=d.GetEndPoint(),T=new $.Vector3,M=new $.Vector3,g=new $.Vector3;d.GetXYZDir(T,M,g);var v=d.GetMajorRadius(),C=new $.Plane(g,f).Project(r),_=C.Sub(f).Clone(),A=_.Length();if(v<A){$.LOGI("在圆外");for(var E=S.GetRefLine().GetPoints(),G=S.GetDataOffset(),P=S.GetDataLength(),w=!1,D=G;D<G+P;D+=2)(w=k.RaySegmentInsect(f,C,E[D],E[D+1]))&&(o.copyFrom(f.Add(_.Multiply(v*(1/A)))),n=r.Sub(o).Clone().Length());if(!w){var x=C.Sub(m).Clone().Length();C.Sub(y).Clone().Length()<=x?(n=r.Sub(y).Clone().Length(),o.copyFrom(y)):(n=r.Sub(m).Clone().Length(),o.copyFrom(m))}return n}$.LOGI("在圆内");for(E=S.GetRefLine().GetPoints(),G=S.GetDataOffset(),P=S.GetDataLength(),w=!1,D=G;D<G+P;D+=2)(w=k.RaySegmentInsect(f,C,E[D],E[D+1]))&&(o.copyFrom(f.Add(_.Multiply(v*(1/A)))),n=r.Sub(o).Clone().Length());if(!w){x=C.Sub(m).Clone().Length();C.Sub(y).Clone().Length()<=x?(n=r.Sub(y).Clone().Length(),o.copyFrom(y)):(n=r.Sub(m).Clone().Length(),o.copyFrom(m))}return n}if(4==e.length){var R=e[0];h=e[1],n=e[2],p=e[3],E=R.GetRefLine().GetPoints(),G=R.GetDataOffset(),P=R.GetDataLength();n=E[G].Sub(h).Clone().Length(),p.copyFrom(E[G]);for(D=G;D<G+P;D+=2){var I=void 0,L=new $.Vector3;s=E[D],l=E[D+1];(I=k.PntLineDistance(s,l,h,I,L))<n&&(n=I,p.copyFrom(L))}return n}}},k.RaySegmentInsect=function(e,t,r,i){var n=t.Sub(e).Clone(),o=i.Sub(r).Clone();if(n.CrossProduct(o).IsZero())return!!0;var a,s,l,h,u,p,c,d,S,f;a=e.x,s=e.y,l=e.z,h=t.x,u=t.y,p=t.z,c=r.x,d=r.y,S=r.z,f=i.x;var m,y,T,M,g,v,C,_,A;C=(m=h-a)*(y=u-s)*(g=i.y-d)-y*y*(M=f-c)-(T=p-l)*T*M+m*T*(v=i.z-S);var E=((_=m*m*g-m*y*M-y*T*v+T*T*g)*d-C*c-(A=m*T*M-m*m*v-y*y*v+y*T*g)*S-(-a*C+s*_-l*A))/(C*M-_*g+A*v),G=new $.Vector3;new $.Vector3;G.x=M*E+c,G.y=g*E+d,G.z=v*E+S;var P=new $.Vector3,w=G,D=P=new $.Ray(e,t.Sub(e).Clone().Normalized()).Project(G),x=(P.Sub(G).Clone().Length(),new $.Vector3);return!(!k.pntInSegment(w,r,i,x)||!w.Sub(D).IsZero())&&0<D.Sub(e).DotProduct(t.Sub(e))},k.PntFaceDistance=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(6!=e.length){n=e[0];var r=e[1],i=(a=e[2],e[3]);U=new $.Plane(r.GetNormal(),r.GetOrigin());return i.copyFrom(U.Project(n)),[!0,a=i.Sub(n).Length(),i]}if(e[0]instanceof $.Vector3&&e[1]instanceof $.Mesh){for(var n=e[0],o=e[1],a=e[2],s=e[3],l=e[4],h=e[5],u=o.GetRefMesh(),p=o.GetDataOffset(),c=o.GetDataLength(),d=new Array,S=u.GetPositionArray(),f=0;f<S.length;f+=3)d.push(new $.Vector3(S[f],S[f+1],S[f+2]));if(0<d.length){u.GetIndexArray();var m=0,y=void 0,T=d[p];l.copyFrom(T),a=n.Sub(T).Clone().Length(),s=0;for(f=p;f<p+c;f+=3){var M=void 0,g=void 0,v=d[f],C=d[f+1],_=d[f+2],A=n.Sub(v).Clone().Length(),E=n.Sub(C).Clone().Length(),G=n.Sub(_).Clone().Length();m<(g=E<A?G<A?(M=f,A):(M=f+2,G):G<E?(M=f+1,E):(M=f+2,G))&&(m=g,y=M);var P=(U=new $.Plane(v,C,_)).Project(n),w=new $.Ray(n,P.Sub(n)),D=new $.Vector3;if(n.Sub(P).Clone().IsZero())a=0,l.copyFrom(P);else if($.RayPickAction.ISintersectRayAndTriangle(v,C,_,w,D)){var x=0;(x=n.Sub(D).Clone().Length())<a&&(a=x,l.copyFrom(D))}else{x=void 0;var R=new $.Vector3,I=new $.Vector3,L=new $.Vector3,N=new $.Vector3;k.pntInSegment(n,v,C,I),k.pntInSegment(n,v,_,L),k.pntInSegment(n,C,_,N);var O=n.Sub(I).Clone().Length(),b=n.Sub(L).Clone().Length(),V=n.Sub(N).Clone().Length();R=O<b?O<V?(x=O,I):(x=V,N):b<V?(x=b,L):(x=V,N),x<a&&(a=x,l.copyFrom(R))}}$.LOGI("complete "),$.LOGI("maxIndex = %d",y),s=m,h.copyFrom(d[y])}else{m=0,T=d[p];l.copyFrom(T),a=n.Sub(T).Clone().Length();g=void 0,new $.Vector3;var F=new $.Vector3,B=(new $.Vector3,new $.Vector3);for(f=p;f<p+c;f+=3){x=0,v=d[f],C=d[f+1],_=d[f+2],A=n.Sub(v).Clone().Length(),E=n.Sub(C).Clone().Length(),G=n.Sub(_).Clone().Length();m<(g=E<A?G<A?(F=v,A):(F=_,G):G<E?(F=C,E):(F=_,G))&&(m=g,B.copyFrom(F));var U;P=(U=new $.Plane(v,C,_)).Project(n),w=new $.Ray(n,P.Sub(n).Clone()),D=new $.Vector3;if(n.Sub(P).IsZero())a=0,l.copyFrom(P);else if($.RayPickAction.ISintersectRayAndTriangle(v,C,_,w,D))(x=n.Sub(D).Clone().Length())<a&&(a=x,l.copyFrom(D));else{var H=void 0;R=new $.Vector3,I=new $.Vector3,L=new $.Vector3,N=new $.Vector3;k.pntInSegment(n,v,C,I),k.pntInSegment(n,v,_,L),k.pntInSegment(n,C,_,N);O=n.Sub(I).Clone().Length(),b=n.Sub(L).Clone().Length(),V=n.Sub(N).Clone().Length();R=O<b?O<V?(H=O,I):(H=V,N):b<V?(H=b,L):(H=V,N),H<a&&(a=H,l.copyFrom(R))}}s=m,h.copyFrom(B)}return[a,s]}},k.pntInSegment=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(4!=e.length){o=e[0];var r=e[1],i=(h=void 0,u=void 0,r.GetStartPoint()),n=r.GetEndPoint();return!((h=o.Sub(i).Length())+(u=o.Sub(n).Length())>i.Sub(n).Length())}if(e[0]instanceof $.Vector3&&e[1]instanceof $.Vector3&&e[2]instanceof $.Vector3&&e[3]instanceof $.Vector3){var o=e[0],a=e[1],s=e[2],l=e[3],h=void 0,u=void 0,p=s.Sub(a).Clone(),c=new $.Ray(a,p).Project(o);return(h=c.Sub(a).Clone().Length())+(u=c.Sub(s).Clone().Length())>p.Length()?(u<h?l.copyFrom(s):l.copyFrom(a),!1):(l.copyFrom(c),!0)}},k.LineFaceDistance=function(e,t,r,i,n){var o=!0,a=e.GetEndPoint().Sub(e.GetStartPoint()),s=t.GetNormal();return-.001<=a.DotProduct(s)&&a.DotProduct(s)<=.001?(r=k.PntFaceDistance(e.GetStartPoint(),t,r,i)[1],r=k.PntFaceDistance(e.GetEndPoint(),t,r,n)[1]):o=!1,[o,r]},k.LineLineDistance=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(6==e.length){var r=[],i=e[0],n=e[1],o=e[2],a=e[3],s=e[4],l=e[5],h=i.GetEndPoint().Sub(i.GetStartPoint()).Normalized(),u=n.GetEndPoint().Sub(n.GetStartPoint()).Normalized();if(-.001<=h.CrossProduct(u).Length()&&h.CrossProduct(u).Length()<=.001){$.LOGI("平行线"),l=!0;var p=new $.Vector3,c=new $.Ray(i.GetStartPoint(),i.GetDirection());p.copyFrom(c.Project(n.GetStartPoint())),o=n.GetStartPoint().Sub(p).Length();var d=i.GetStartPoint().Sub(p).Length(),S=i.GetEndPoint().Sub(p).Length();i.GetLength();a.copyFrom(p),s.copyFrom(n.GetStartPoint())}else{$.LOGI("异面直线或公面相交线"),l=!1;var f,m,y,T,M,g,v,C,_,A;f=Number(i.GetStartPoint().x),m=Number(i.GetStartPoint().y),y=Number(i.GetStartPoint().z),T=Number(i.GetEndPoint().x),M=Number(i.GetEndPoint().y),g=Number(i.GetEndPoint().z),v=Number(n.GetStartPoint().x),C=Number(n.GetStartPoint().y),_=Number(n.GetStartPoint().z),A=Number(n.GetEndPoint().x);var E,G,P,w,D,x,R,I,L;R=(E=T-f)*(G=M-m)*(D=Number(n.GetEndPoint().y)-C)-G*G*(w=A-v)-(P=g-y)*P*w+E*P*(x=Number(n.GetEndPoint().z)-_);var N=((I=E*E*D-E*G*w-G*P*x+P*P*D)*C-R*v-(L=E*P*w-E*E*x-G*G*x+G*P*D)*_-(-f*R+m*I-y*L))/(R*w-I*D+L*x),O=new $.Vector3;new $.Vector3;O.x=w*N+v,O.y=D*N+C,O.z=x*N+_;var b=void 0;b=new $.Ray(i.GetStartPoint(),i.GetDirection()).Project(O),s.copyFrom(O),a.copyFrom(b),o=b.Sub(O).Length()}return r.push(o),r.push(l),r}if(7==e.length){var V,F,B=e[0],U=e[1],H=e[2],k=e[3],z=(a=e[4],s=e[5],e[6]),W=new $.Vector3,Y=new $.Vector3,X=new $.Vector3,j=(new $.Vector3,new $.Vector3),K=new $.Vector3,q=new $.Vector3,Q=new $.Vector3,Z=new $.Vector3,J=new $.Vector3;if(B.GetXYZDir(j,K,q),U.GetXYZDir(Q,Z,J),W=B.GetCenterPoint(),Y=U.GetCenterPoint(),V=B.GetMajorRadius(),F=U.GetMajorRadius(),X=B.GetStartPoint(),U.GetStartPoint(),$.LOGI("radius0 %f radius1 %f ",V,F),q.CrossProduct(J).IsZero())if(W.Sub(Y).IsZero())H=0,k=$.Abs(V-F),a.copyFrom(X),s.copyFrom(Y.Add(X.Sub(W).Multiply(F).Divide(X.Sub(W).Length()))),z=2;else H=(p=(c=new $.Ray(W,q)).Project(Y)).Sub(Y).Length(),k=W.Sub(Y).Length(),a.copyFrom(p),s.copyFrom(Y),z=1;else z=0,H=-1,k=W.Sub(Y).Length(),a.copyFrom(W),s.copyFrom(Y);return[H,k,z]}},k.PolylinePolylineDistance=function(e,t,r,i,n,o,a){for(var s=e.GetRefLine().GetPoints(),l=e.GetDataOffset(),h=e.GetDataLength(),u=t.GetRefLine().GetPoints(),p=t.GetDataOffset(),c=t.GetDataLength(),d=1e5,S=new $.Vector3,f=new $.Vector3,m=l;m<l+h;m+=2)for(var y=o.Multiply(s[m]),T=o.Multiply(s[m+1]),M=p;M<p+c;M+=2){var g=0,v=new $.Vector3,C=new $.Vector3,_=a.Multiply(u[M]),A=a.Multiply(u[M+1]);(g=k.SegmentSegmentDiatance(y,T,_,A,v,C,g))<d&&(d=g,S=v,f=C)}return r.copyFrom(S),i.copyFrom(f),d},k.FaceFaceDistance=function(e,t,r,i,n){var o=e.GetOrigin(),a=t.GetOrigin(),s=e.GetNormal(),l=t.GetNormal();if(s.CrossProduct(l).IsZero()){var h=new $.Plane(s,o),u=new $.Plane(l,a);i.copyFrom(u.Project(o)),n.copyFrom(h.Project(a)),r=i.Sub(o).Length()}else r=-1;return r},k.LineLineAngle=function(e,t,r){return e.GetDirection().Angle(t.GetDirection())},k.LineFaceAngle=function(e,t,r){var i=t.GetNormal(),n=e.GetDirection(),o=Math.abs(i.DotProduct(n)/(i.Length()*n.Length()));return $.Asin(o)},k.FaceFaceAngle=function(e,t,r){return e.GetNormal().Angle(t.GetNormal())},k.faceArea=function(e,t){for(var r=e.GetRefMesh(),i=e.GetDataOffset(),n=e.GetDataLength(),o=new Array,a=0;a<r.GetPositionArray().length;a+=3)o.push(new $.Vector3(r.GetPositionArray[a],r.GetPositionArray[a+1],r.GetPositionArray[a+2]));if(0<o.length){var s=r.GetIndexArray();for(a=i;a<i+n;a+=3){var l=o[s[a]],h=o[s[a+1]],u=o[s[a+2]];k.triangleArea(l,h,u,p=0),p}}else for(s=r.GetPositionArray(),a=i;a<i+n;a+=3){var p;l=o[a],h=o[a+1],u=o[a+2];k.triangleArea(l,h,u,p=0),p}return!0},k.triangleArea=function(e,t,r,i){var n=t.Sub(e).Clone(),o=r.Sub(e).Clone();return n.CrossProduct(o).Length()/2,!0},k.PolyLineLength=function(e,t){var r=e.GetRefLine().GetPoints(),i=e.GetDataOffset(),n=e.GetDataLength();for(var o=i;o<i+n;o+=2){var a=r[o];r[o+1].Sub(a).Length()}},k.SegmentSegmentDiatance=function(e,t,r,i,n,o,a){var s,l=new $.LineAttribute,h=new $.LineAttribute;l.SetStartPoint(e),l.SetEndPoint(t),l.SetDirection(t.Sub(e).Clone()),h.SetStartPoint(r),h.SetEndPoint(i),h.SetDirection(i.Sub(r));var u=new $.Vector3,p=new $.Vector3,c=!0,d=k.LineLineDistance(l,h,s,u,p,c);s=d[0],c=d[1];var S,f,m,y,T=e,M=t,g=r,v=i;k.pntInSegment(u,l),k.pntInSegment(p,h);var C=0,_=new $.Vector3;C=k.PntLineDistance(g,v,T,C,_);var A=0,E=new $.Vector3;A=k.PntLineDistance(g,v,M,A,E);var G=0,P=new $.Vector3;G=k.PntLineDistance(T,M,g,G,P);var w=0,D=new $.Vector3;w=k.PntLineDistance(T,M,v,w,D);var x=0,R=new $.Vector3,I=new $.Vector3;return I=(y=w)<(m=G)?(x=y,R=D,v):(x=m,R=P,g),(S=C)<x&&(x=S,R=_,I=T),(f=A)<x&&(x=f,R=M,I=E),a=x,n.copyFrom(R),o.copyFrom(I),a},k}();$.MeasureCalculateHelper=e}(M3D||(M3D={})),function(q){var e=function(){function K(){}return K.createRectImage=function(e,t,r,i,n,o,a,s,l,h,u,p){q.LOGI("createRectImage shape2DSet %p",e);var c=t.x,d=t.y,S=r.x,f=r.y,m=new q.Color(.45,.45,.45),y=new q.Rect2D;y.setColor(n),y.setStart(t.Clone()),y.setEnd(r.Clone()),e.addShape(y);var T=new q.Texts2D;T.setColor(a);var M=new q.Vector2(c+10,(d+f)/2+u/3);T.setStart(M.Clone()),T.setSize(u),T.setTexts(l),e.addShape(T);var g=new q.Line2D;g.setStart(new q.Vector2(c,d)),g.setEnd(new q.Vector2(c,f)),g.setBlod(4),g.setColor(m),e.addShape(g);var v=new q.Line2D;if(v.setStart(new q.Vector2(c,d)),v.setEnd(new q.Vector2(S,d)),v.setBlod(4),v.setColor(m),e.addShape(v),p){var C=new q.Line2D;C.setStart(new q.Vector2(c,f)),C.setEnd(new q.Vector2(S,f)),C.setBlod(4),C.setColor(m),e.addShape(C)}var _=new q.Line2D;_.setStart(new q.Vector2(S,d)),_.setEnd(new q.Vector2(S,f)),_.setBlod(4),_.setColor(m),e.addShape(_);var A=S,E=d,G=S+i,P=f,w=new q.Rect2D;w.setColor(o),w.setStart(new q.Vector2(A,E)),w.setEnd(new q.Vector2(G,P)),e.addShape(w);var D=new q.Texts2D;D.setColor(s);var x=new q.Vector2(A+10,(E+P)/2+u/3);D.setStart(x),D.setSize(u),D.setTexts(h),e.addShape(D);var R=new q.Line2D;R.setStart(new q.Vector2(A,E)),R.setEnd(new q.Vector2(A,P)),R.setBlod(4),R.setColor(m),e.addShape(R);var I=new q.Line2D;if(I.setStart(new q.Vector2(A,E)),I.setEnd(new q.Vector2(G,E)),I.setBlod(4),I.setColor(m),e.addShape(I),p){var L=new q.Line2D;L.setStart(new q.Vector2(A,P)),L.setEnd(new q.Vector2(G,P)),L.setBlod(4),L.setColor(m),e.addShape(L)}var N=new q.Line2D;N.setStart(new q.Vector2(G,E)),N.setEnd(new q.Vector2(G,P)),N.setBlod(4),N.setColor(m),e.addShape(N)},K.addImageToMemory=function(a,s,e,l,h,u,p){a.GetGlueObj().CreateImage(e,function(e){var t=null;t=e instanceof Blob?URL.createObjectURL(e):e;var r=q.IDCreator.GetUUID(32,16),i=new q.Vector2(h,u);i=q.ShapeHelper.GetCommonSize(a,i),(s=new q.ImageBoard(l,i)).m_fixShowInScreen=!0;var n=a.GetResourceManager().GetOrCreateTexture(r),o=a.GetResourceManager().GetImage(r);null===o&&(o=a.GetResourceManager().GetOrCreateImage(r,t)),n.AddImage(o),s.SetTexture(n),s.SetCurrentGLContext(a.GetResourceManager().GetRenderContext()),p.AddImage(s)})},K.IsPC=function(){for(var e=navigator.userAgent,t=["Android","iPhone","SymbianOS","Windows Phone","iPad","iPod"],r=!0,i=0;i<t.length;i++)if(0<e.indexOf(t[i])){r=!1;break}return r},K.createNoteTextsImageN1=function(s,e,l,h){var t=null,r="",i=new q.Shape2DSet;4<=e.length?""==e[3].getTexts()?r=e[1].getTexts():0==q.Parameters.Instance().textNoteStyle?r=e[1].getTexts():1==q.Parameters.Instance().textNoteStyle&&(r=e[3].getTexts()+":"+e[1].getTexts()):r=e[1].getTexts();var n=e[1].getSize();n<1&&(n=15),n=40*n/15;var o=s.GetGlueObj(),a=(r.length-0+0+1)*n,u=new q.Vector2(1,1),p=new q.Vector2(a,2.5*n+1),c=(q.Color.BLACK().Clone(),q.Color.GRAY().Clone(),q.Color.WHITE().Clone()),d=new q.Color(.15,.15,.15),S=new q.Color(.03,.38,.73);K.createNoteRectangleImage(i,u,p,S,4,c,d,n,r);var f=q.DrawingUtility.getRectF(i),m=f.getWidth()/(K.IsPC()?70:25),y=f.getHeigh()/(K.IsPC()?70:25);if(o){o.CreateImage(i,function(e){var t=null;t=e instanceof Blob?URL.createObjectURL(e):e;var r=q.IDCreator.GetUUID(32,16),i=new q.Vector2(m,y);i=q.ShapeHelper.GetCommonSize(s,i);var n=new q.ImageBoard(l,i);n.m_fixShowInScreen=!0;var o=s.GetResourceManager().GetOrCreateTexture(r),a=s.GetResourceManager().GetImage(r);null===a&&(a=s.GetResourceManager().GetOrCreateImage(r,t)),o.AddImage(a),n.SetTexture(o),n.SetCurrentGLContext(s.GetResourceManager().GetRenderContext()),h.imageBoardList.splice(0,1),h.AddImage(n)})}if(i=null,0<"".length){var T=new q.Vector2(m,y);(t=new q.ImageBoard(l,T)).SetTexture(s.GetResourceManager().GetOrCreateTexture(""))}for(var M=0;M<e.length;M++)e[M]=null;return t},K.createNoteTextsImageN=function(){for(var a=[],e=0;e<arguments.length;e++)a[e]=arguments[e];var l=a[0];if(4==a.length){var t=a[1],s=a[2],r=null,h=a[3],i="",n=new q.Shape2DSet;4<=t.length?""==t[3].getTexts()?i=t[1].getTexts():0==q.Parameters.Instance().textNoteStyle?i=t[1].getTexts():1==q.Parameters.Instance().textNoteStyle&&(i=t[3].getTexts()+":"+t[1].getTexts()):i=t[1].getTexts(),(b=t[1].getSize())<1&&(b=15),b=40*b/15;var o=l.GetGlueObj(),u=(.6*(V=0)+(i.length-V)+1)*b,p=new q.Vector2(1,1),c=new q.Vector2(u,2.5*b+1),d=q.Color.BLACK().Clone(),S=q.Color.GRAY().Clone(),f=q.Color.WHITE().Clone(),m=new q.Color(.15,.15,.15),y=new q.Color(.03,.38,.73);K.createNoteRectangleImage(n,p,c,y,4,f,m,b,i);var T=(O=q.DrawingUtility.getRectF(n)).getWidth()/(K.IsPC()?70:25),M=O.getHeigh()/(K.IsPC()?70:25),g="";if(o){var v=function(e){var t=null;t=e instanceof Blob?URL.createObjectURL(e):e;var r=q.IDCreator.GetUUID(32,16),i=new q.Vector2(T,M);i=q.ShapeHelper.GetCommonSize(l,i);var n=new q.ImageBoard(s,i);n.m_fixShowInScreen=!0;var o=l.GetResourceManager().GetOrCreateTexture(r),a=l.GetResourceManager().GetImage(r);null===a&&(a=l.GetResourceManager().GetOrCreateImage(r,t)),o.AddImage(a),n.SetTexture(o),n.SetCurrentGLContext(l.GetResourceManager().GetRenderContext()),h.imageBoardList.splice(0,1),h.AddImage(n)};o.CreateImage(n,v)}if(n=null,0<g.length){var C=new q.Vector2(T,M);(r=new q.ImageBoard(s,C)).SetTexture(l.GetResourceManager().GetOrCreateTexture(g))}for(var _=0;_<t.length;_++)t[_]=null;return r}if(5==a.length&&a[4]instanceof q.Vector2){t=a[1];var A=a[2],E=(r=null,a[3]),G=a[4];i="",n=new q.Shape2DSet;4<=t.length?""==t[3].getTexts()?i=t[1].getTexts():0==q.Parameters.Instance().textNoteStyle?i=t[1].getTexts():1==q.Parameters.Instance().textNoteStyle&&(i=t[3].getTexts()+":"+t[1].getTexts()):i=t[1].getTexts(),(b=t[1].getSize())<1&&(b=15),b=40*b/15;o=l.GetGlueObj(),u=(.6*(V=0)+(i.length-V)+1)*b,p=new q.Vector2(1,1),c=new q.Vector2(u,2.5*b+1),d=q.Color.BLACK().Clone(),S=q.Color.GRAY().Clone(),f=q.Color.WHITE().Clone(),m=new q.Color(.15,.15,.15),y=new q.Color(.03,.38,.73);K.createNoteRectangleImage(n,p,c,y,4,f,m,b,i);var P=(O=q.DrawingUtility.getRectF(n)).getWidth()/(K.IsPC()?70:25),w=O.getHeigh()/(K.IsPC()?70:25);g="";if(o){v=function(e){var t=null;t=e instanceof Blob?URL.createObjectURL(e):e;var r=q.IDCreator.GetUUID(32,16),i=new q.Vector2(P,w);i=q.ShapeHelper.GetCommonSize(l,i);var n=new q.ImageBoard(A,i);n.m_fixShowInScreen=!0;var o=l.GetResourceManager().GetOrCreateTexture(r),a=l.GetResourceManager().GetImage(r);null===a&&(a=l.GetResourceManager().GetOrCreateImage(r,t)),o.AddImage(a),n.SetTexture(o),n.SetCurrentGLContext(l.GetResourceManager().GetRenderContext()),E.imageBoardList.splice(0,1),E.AddImage(n);var s=new q.Vector3;l.GetPickPoint(G,s,!1),n.SetPosition(s)};o.CreateImage(n,v)}if(n=null,0<g.length){C=new q.Vector2(P,w);(r=new q.ImageBoard(A,C)).SetTexture(l.GetResourceManager().GetOrCreateTexture(g))}for(_=0;_<t.length;_++)t[_]=null;return r}var D,x=a[1],R=(t=a[2],a[3]),I=a[4];6==a.length&&(D=a[5]);i="",n=new q.Shape2DSet;var L,N,O=void 0;if(t instanceof Array){var b;4<=t.length?""==t[3].getTexts()?i=t[1].getTexts():0==q.Parameters.Instance().textNoteStyle?i=t[1].getTexts():1==q.Parameters.Instance().textNoteStyle&&(i=t[3].getTexts()+"："+t[1].getTexts()):i=t[1].getTexts(),(b=t[1].getSize())<1&&(b=15),b=40*b/15;u=(.6*(V=0)+2*(i.length-V)+1)*b;var V,F=document.createElement("canvas");document.body.appendChild(F);var B=F.getContext("2d");B.font="Bold 40pt "+t[1].getFontName();var U=B.measureText(i);document.body.removeChild(F);p=new q.Vector2(1,1),c=new q.Vector2(U.width+b,3.5*b+1),d=q.Color.BLACK().Clone(),S=q.Color.GRAY().Clone(),f=q.Color.WHITE().Clone(),m=new q.Color(.15,.15,.15),y=new q.Color(.03,.38,.73);K.createNoteRectangleImage(n,p,c,y,4,f,m,b,i),O=q.DrawingUtility.getRectF(n),L=O.getWidth()/(K.IsPC()?70:25),N=O.getHeigh()/(K.IsPC()?70:25)}else{var H=a[2],k=0;for(var z in H){S=q.Color.WHITE().Clone(),f=q.Color.WHITE().Clone();var W=q.Color.BLACK().Clone(),Y=(d=q.Color.BLACK().Clone(),q.Color.GREEN().Clone(),q.Color.RED().Clone(),q.Color.BLUE().Clone(),new q.Vector2(1,1+100*k)),X=new q.Vector2(260,100+100*k);K.createRectImage(n,Y,X,450,S,f,W,d,z,a[2][z],16,!0),k++}var j=Object.keys(H).length;L=5.5,N=j+2}g="";if(o=l.GetGlueObj()){v=function(e){var t=null;t=e instanceof Blob?URL.createObjectURL(e):e;var r=q.IDCreator.GetUUID(32,16),i=new q.Vector2(L,N);i=q.ShapeHelper.GetCommonSize(l,i),(x=new q.ImageBoard(R,i)).m_fixShowInScreen=!0;var n=l.GetResourceManager().GetOrCreateTexture(r),o=l.GetResourceManager().GetImage(r);null===o&&(o=l.GetResourceManager().GetOrCreateImage(r,t)),n.AddImage(o),x.SetTexture(n),x.SetCurrentGLContext(l.GetResourceManager().GetRenderContext()),5==a.length?I.AddImage(x):I[D]=x};o.CreateImage(n,v)}},K.createNoteRectangleImage=function(e,t,r,i,n,o,a,s,l){var h=t.x,u=t.y,p=r.x,c=r.y,d=n/2,S=new q.Rect2D;S.setColor(o),S.setStart(t),S.setEnd(r),e.addShape(S);var f=new q.Texts2D;f.setColor(a);var m=new q.Vector2(h+s/2,(u+c)/2+s/3);f.setStart(m),f.setSize(s),f.setTexts(l),e.addShape(f);var y=new q.Line2D;y.setBlod(n),y.setStart(new q.Vector2(h+d,u)),y.setEnd(new q.Vector2(h+d,c)),y.setColor(i),e.addShape(y);var T=new q.Line2D;T.setBlod(n),T.setStart(new q.Vector2(h,u+d)),T.setEnd(new q.Vector2(p,u+d)),T.setColor(i),e.addShape(T);var M=new q.Line2D;M.setBlod(n),M.setStart(new q.Vector2(h,c-d)),M.setEnd(new q.Vector2(p,c-d)),M.setColor(i),e.addShape(M);var g=new q.Line2D;g.setBlod(n),g.setStart(new q.Vector2(p-d,u)),g.setEnd(new q.Vector2(p-d,c)),g.setColor(i),e.addShape(g)},K.CreateSequenceNumberImage=function(){for(var a=[],e=0;e<arguments.length;e++)a[e]=arguments[e];var s=a[0],l=a[1],t=a[2],h=a[3],u=a[4],p=a[5];if(!t)return null;var r=t.getTexts(),i=new q.Shape2DSet,n=t.getSize();n<1&&(n=15),n=40*n/15;var o=(0+2*(r.length-0)+1)*n,c=new q.Vector2(1,1),d=new q.Vector2(o,o),S=q.Color.WHITE().Clone(),f=new q.Color(.15,.15,.15),m=new q.Color(.03,.38,.73),y=c.x+1,T=c.y+1,M=d.x-1,g=d.y-1,v=new q.Vector2(y,T),C=new q.Vector2(M,g),_=new q.Ellipse2D;_.setColor(m),_.setStart(v),_.setEnd(C),_.setStrokeWidth(2),_.setIsFill(!1),i.addShape(_);var A=new q.Ellipse2D;A.setColor(S),A.setStart(c),A.setEnd(d),A.setIsFill(!0),_.setStrokeWidth(0),i.addShape(A);var E=new q.Texts2D;E.setColor(f);var G=new q.Vector2((y+M)/2,(T+g)/2+n/3);E.setStart(G),E.setSize(n),E.setTexts(r),E.setAlignCenter(!0),i.addShape(E);var P=s.GetGlueObj(),w=o/40,D=o/40;if(P){P.CreateImage(i,function(e){var t=null;t=e instanceof Blob?URL.createObjectURL(e):e;var r=q.IDCreator.GetUUID(32,16),i=new q.Vector2(w,D);(l=new q.ImageBoard(h,i)).m_fixShowInScreen=!0;var n=s.GetResourceManager().GetOrCreateTexture(r),o=s.GetResourceManager().GetImage(r);null===o&&(o=s.GetResourceManager().GetOrCreateImage(r,t)),n.AddImage(o),l.SetTexture(n),l.SetCurrentGLContext(s.GetResourceManager().GetRenderContext()),5==a.length?(u.imageBoardList.splice(0,1),u.AddImage(l)):u[p]=l})}},K.SetMeasureUnit=function(e,t,r){switch(e){case 0:r="";break;case 1:r=" mm ";break;case 2:r=" cm";for(var i=0;i<t.length;i++)t[i]=t[i]/10;break;case 3:r=" m";for(i=0;i<t.length;i++)t[i]=t[i]/1e3;break;case 4:r=" in";for(i=0;i<t.length;i++)t[i]=t[i]/.0393701;break;case 5:r=" ft";for(i=0;i<t.length;i++)t[i]=.0032808*t[i];break;default:q.LOGE(" Invalid Unit Flag")}return r},K.SetMeasureAreaUnit=function(e,t,r){switch(e){case 0:r="";break;case 1:r=" mm²";break;case 2:r=" cm²";for(var i=0;i<t.length;i++)t[i]=t[i]/10/10;break;case 3:r=" m²";for(i=0;i<t.length;i++)t[i]=t[i]/1e3/1e3;break;case 4:r=" in²";for(i=0;i<t.length;i++)t[i]=t[i]/.0393701/.0393701;break;case 5:r=" ft²";for(i=0;i<t.length;i++)t[i]=.0032808*t[i]*.0032808;break;default:q.LOGE(" Invalid Unit Flag")}return r},K.SetMeasureVolumeUnit=function(e,t,r){switch(e){case 0:r="";break;case 1:r=" mm³";break;case 2:r=" cm³";for(var i=0;i<t.length;i++)t[i]=t[i]/10/10/10;break;case 3:r=" m³";for(i=0;i<t.length;i++)t[i]=t[i]/1e3/1e3/1e3;break;case 4:r=" in³";for(i=0;i<t.length;i++)t[i]=t[i]/.0393701/.0393701/.0393701;break;case 5:r=" ft³";for(i=0;i<t.length;i++)t[i]=.0032808*t[i]*.0032808*.0032808;break;default:q.LOGE(" Invalid Unit Flag")}return r},K.CreateDesignerAngleMark=function(e,t,r,i,n,o,a,s){if(!(a<1e-6&&-1e-6<a)){t.Sub(e).Length(),i.Sub(r).Length();var l=Math.abs(a/10),h=a/l,u=t.Sub(e).Normalized(),p=i.Sub(r).Normalized(),c=u.CrossProduct(p);c=c.Normalized();u.DotProduct(p);var d=n.Add(u.Multiply(o));s.push(d);for(var S=0;S<l-1;S++){var f=new q.Quaternion(h*(S+1),c);f.Normalize();var m=new q.Quaternion(0,u.x,u.y,u.z),y=f.Multiply(m).Multiply(f.Conjugate()),T=new q.Vector3(y.x,y.y,y.z);T.Normalize();var M=n.Add(T.Multiply(o)).Clone();s.push(M)}var g=n.Add(p.Multiply(o)).Clone();s.push(g)}},K.CreateAngleMark=function(e,t,r,i,n,o){if(!(n<1e-6&&-1e-6<n)){var a=t.Sub(e).Length(),s=i.Sub(r).Length(),l=s<a?s/3:a/3,h=r,u=n/5,p=t.Sub(e).Normalized(),c=i.Sub(r).Normalized(),d=p.CrossProduct(c);d=d.Normalized();p.DotProduct(c);var S=h.Add(p.Multiply(l));if(o.push(S),n<90||90<n&&n<180)for(var f=0;f<4;f++){var m=new q.Quaternion(u*(f+1),d);m.Normalize();var y=new q.Quaternion(0,p.x,p.y,p.z),T=m.Multiply(y).Multiply(m.Conjugate()),M=new q.Vector3(T.x,T.y,T.z);M.Normalize();var g=h.Add(M.Multiply(l)).Clone();o.push(g)}else{var v=S.Add(c.Multiply(l)).Clone();o.push(v)}if(0<=n){var C=h.Add(c.Multiply(l)).Clone();o.push(C)}else{C=h.Sub(c.Multiply(l));o.push(C)}}},K.CreateSelectFaceMark=function(e,t,r,i,n){var o=r.Normalized(),a=(i.Normalized(),r.CrossProduct(i).Normalized()),s=t.Add(o.Add(a).Multiply(n));e.push(s);var l=t.Add(o.Sub(a).Multiply(n));e.push(l);var h=t.Add(a.Sub(o).Multiply(n));e.push(h);var u=t.Sub(o.Add(a).Multiply(n));e.push(u)},K}();q.MeasureDisplayHelper=e}(M3D||(M3D={})),function(e){var t=function(){function e(){this.view=null,this.commandType=-1,this.commandType=e.TYPE}return e.prototype.GetType=function(){return this.commandType},e.prototype.execute=function(){return this.OnExecute()},e.prototype.OnExecute=function(){return!1},e.prototype.Undo=function(){return!1},e.prototype.Redo=function(){return!1},e.prototype.ToJsonString=function(){return""},e.prototype.GetView=function(){return this.view},e.prototype.SetView=function(e){this.view=e},e.TYPE=0,e}();e.Operation=t}(M3D||(M3D={})),function(p){var e=function(n){function o(e,t,r){var i=n.call(this)||this;return i.srcPlcPath="",i.destPlcPath="",i.srcModel=null,i.desModel=null,i.newModel=null,i.commandType=o.TYPE,i.view=e,i.srcModel=t,i.desModel=r,i.newModel=null,i}return __extends(o,n),o.prototype.OnExecute=function(){var e=!1;if(this.view){var t=this.srcModel,r=this.desModel;if(this.newModel=new p.Model,t&&r){this.newModel.CopyData(t);var i=this.view.GetSceneManager();if(!(e=p.ModelTransformHelper.InsertBefore(this.view,this.newModel,r)))return this.newModel=null,e;var n=p.ModelTransformHelper.GetPlaceMatrix(t),o=i.GetSceneBox(),a=(o.Center().Clone(),p.Vector3.LEFT().Clone().Multiply(.8*o.Length())),s=p.M3DTOOLS.Random(10,350);a=new p.Quaternion(s,p.Vector3.UP().Clone()).Multiply(a);var l=new p.Matrix3x4;l.MultiTranslate(a);var h=p.ModelTransformHelper.GetWorldMatrix(r),u=p.ModelTransformHelper.GetWorldMatrix(t);n=h.Inverse().Multiply(l.Multiply(u)),this.newModel.SetOrigPlcMatrix(n),e=!0}else this.newModel=null,e=!1}else e=!1;return e},o.prototype.GetNewMode=function(){return this.newModel},o.prototype.GetDestPlcPath=function(){return this.destPlcPath},o.prototype.GetSrcPlcPath=function(){return this.srcPlcPath},o.TYPE=10,o}(p.Operation);p.CopyModelOperation=e}(M3D||(M3D={})),function(a){var e;(e=a.AssambleMsg||(a.AssambleMsg={}))[e.ASSAMBLY_BASE=-1]="ASSAMBLY_BASE",e[e.ASSAMBLY_INS_BEFO_ERR=0]="ASSAMBLY_INS_BEFO_ERR",e[e.ASSAMBLY_INS_AFTR_ERR=1]="ASSAMBLY_INS_AFTR_ERR",e[e.ASSAMBLY_DET_ERR=2]="ASSAMBLY_DET_ERR",e[e.ASSAMBLY_MOVTO_ERR=3]="ASSAMBLY_MOVTO_ERR",e[e.ASSAMBLY_CPYTO_ERR=4]="ASSAMBLY_CPYTO_ERR",e[e.ASSAMBLY_ADD_ERR=5]="ASSAMBLY_ADD_ERR",e[e.ASSAMBLY_DEL_ERR=6]="ASSAMBLY_DEL_ERR",e[e.ASSAMBLY_INS_BEFO_SUCES=20]="ASSAMBLY_INS_BEFO_SUCES",e[e.ASSAMBLY_INS_AFTR_SUCES=21]="ASSAMBLY_INS_AFTR_SUCES",e[e.ASSAMBLY_DET_SUCES=22]="ASSAMBLY_DET_SUCES",e[e.ASSAMBLY_MOVTO_SUCES=23]="ASSAMBLY_MOVTO_SUCES",e[e.ASSAMBLY_CPYTO_SUCES=24]="ASSAMBLY_CPYTO_SUCES",e[e.ASSAMBLY_ADD_SUCES=25]="ASSAMBLY_ADD_SUCES",e[e.ASSAMBLY_DEL_SUCES=26]="ASSAMBLY_DEL_SUCES";var t=function(){function e(e){this.view=null,this.view=e}return e.prototype.Delete=function(e){return new a.RemoveModelOperation(this.view,e).execute()},e.prototype.MoveTo=function(e,t){return new a.MoveModelOperation(this.view,e,t).execute()},e.prototype.CopyTo=function(e,t){var r=new a.CopyModelOperation(this.view,e,t);return[r.execute(),r.GetNewMode()]},e.prototype.AddTo=function(e,t,r){var i,n=new a.AddFileOperation(this.view,e,t);return i=n.execute(),n.GetNewModel(),i},e.prototype.ReName=function(e,t){return new a.RenameOperation(this.view,e,t).execute()},e.prototype.Move=function(e,t){var r=t.split(","),i=this.view.GetModelBySVLPath(e),n=new a.Matrix4(Number(r[0]),Number(r[1]),Number(r[2]),Number(r[3]),Number(r[4]),Number(r[5]),Number(r[6]),Number(r[7]),Number(r[8]),Number(r[9]),Number(r[10]),Number(r[11]),Number(r[12]),Number(r[13]),Number(r[14]),Number(r[15])),o=new a.Matrix3x4(n);a.ModelTransformHelper.SetWorldMatrix(i,o)},e}();a.ModelManager=t}(M3D||(M3D={})),function(A){var e=function(){function _(){}return _.GetPlaceMatrix=function(e){return new A.Matrix3x4},_.GetWorldMatrix=function(e){var t;return e&&(t=e.GetWorldTransform().ToMatrix3x4()),t},_.GetPlacePath=function(e){return""},_.SetPlacePath=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(2===e.length&&e[1]instanceof A.Model&&e[0]&&e[1]){var r=_.GetPlacePath(e[1])+"|"+e[0].GetPlcId().toString(16);_.SetPlacePath(e[0],r);var i=e[0];if(0<i.GetSubModels().length)for(var n=0;n<i.GetSubModels().length;n++)_.SetPlacePath(i.GetSubModels()[n],i)}},_.SetPlaceMatrix=function(e,t){},_.ComputePlaceMatrix=function(e){},_.SetWorldMatrix=function(e,t){},_.GetMaxPlcId=function(e){},_.GetModelFromId=function(e,t){},_.InsertBefore=function(e,t,r){var i=!1;if(t&&r){var n=r.GetUseablePlcId();r.AddSubModel(t),t.SetPlcId(n),e.GetSceneManager().AsynUpdateModelCacheInfo(t,!0),e.GetSceneManager().RequestUpdateWhenSceneBoxChanged(),i=!0}else i=!1;return i},_.DetachModel=function(e){var t=!1;if(e){var r=e.GetParent();r&&r.DetachSubModel(e),t=!0}else t=!1;return t},_.DeleteModel=function(e,t){var r=!1;if(t){e.GetSceneManager();r=e.GetSceneManager().AsynRemoveModelFromeScene(t.GetParent(),t),r=!0}else r=!1;return r},_.AddModel=function(e,t){var r=t.GetSceneManager().GetModel(),i=t.GetSceneManager(),n=r.GetSubModelCount()-1,o=r.GetSceneNode().GetParent();if(o&&o instanceof A.ModelNode){var a=o;i.CreateModelNodes(e,a.GetName(),n)}return e},_.GetParentNode=function(e){var t=null;if(e){var r=e.GetSceneNode().GetParent();if(r){var i=r.GetParent();i&&i instanceof A.ModelNode&&(t=i)}}return t},_.GetModelNode=function(e){var t=null;if(null!==e){var r=e.GetSceneNode().GetParent();r&&r instanceof A.ModelNode&&(t=r)}return t},_.RotateModel=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(5===e.length||4===e.length){var r=e[0],i=e[1],n=e[2]/2,o=e[3],a=e[4];a||(o===A.TRANSAXIS.AXIS_Z?a=new A.Vector3(0,0,1):o===A.TRANSAXIS.AXIS_Y?a=new A.Vector3(0,1,0):o===A.TRANSAXIS.AXIS_X&&(a=new A.Vector3(1,0,0)));var s=new A.Quaternion;s.FromAngleAxis(n,a);var l=new A.Quaternion(r.GetSceneManager().GetCamera().GetView().ToMatrix3());if(l.Normalize(),!i)throw Error("'Model' parameter is null");if(i.GetType()!==A.ShapeType.SHAPE_MODEL)throw Error("the shape type of 'Model' must be SHAPE_MODEL");var h=l.Inverse().Multiply(s).Multiply(s);if(o===A.TRANSAXIS.AXIS_FACE)_.RotateModel(i,h);else if(o===A.TRANSAXIS.AXIS_Z){var u=new A.Quaternion(h.w,0,0,h.z);u.Normalize(),_.RotateModel(i,u)}else if(o===A.TRANSAXIS.AXIS_Y){var p=new A.Quaternion(h.w,0,h.y,0);p.Normalize(),_.RotateModel(i,p)}else if(o===A.TRANSAXIS.AXIS_X){var c=new A.Quaternion(h.w,h.x,0,0);c.Normalize(),_.RotateModel(i,c)}}else{i=e[0];var d=e[1];if(!i||!d)throw Error("one of parameters is null");if(i.GetType()!==A.ShapeType.SHAPE_MODEL)throw Error("the shape type of 'Model' must be SHAPE_MODEL");var S=i.GetParent(),f=i.GetWorldTransform(),m=S?S.GetWorldTransform().Clone():new A.Matrix3x4,y=this.GetModelWorldBoundingBox(i).Center(),T=new A.Matrix3x4,M=new A.Matrix3x4,g=new A.Matrix3x4;T.MultiTranslate(y.Nagative()),g.MultiRotatiton(d),M.MultiTranslate(y);var v=M.Multiply(g.Multiply(T)),C=m.Inverse().Multiply(v.Multiply(f));i.SetPlaceMatrix(C)}},_.TranslateModel=function(e,t){if(e){var r=e.GetParent(),i=e.GetWorldTransform(),n=r?r.GetWorldTransform():new A.Matrix3x4,o=new A.Matrix3x4;o.MultiTranslate(t);var a=n.Inverse().Multiply(o.Multiply(i));e.SetPlaceMatrix(a)}},_.ScaleModel=function(e,t){var r=e.GetParent(),i=e.GetWorldTransform(),n=r?r.GetWorldTransform():new A.Matrix3x4,o=_.GetModelWorldBoundingBox(e).Center(),a=new A.Matrix3x4,s=new A.Matrix3x4,l=new A.Matrix3x4;a.MultiTranslate(o.Nagative()),l.MultiScale(t),s.MultiTranslate(o);var h=s.Multiply(l).Multiply(a),u=n.Inverse().Multiply(h).Multiply(i);e.SetPlaceMatrix(u)},_.GetModelWorldBoundingBox=function(e){var t=e.GetWorldBoundingBox();if(t||(t=new A.BoundingBox),0<e.GetSubModelCount())for(var r=0;r<e.GetSubModels().length;r++)t.Merge(_.GetModelWorldBoundingBox(e.GetSubModels()[r]));return t},_}();A.ModelTransformHelper=e}(M3D||(M3D={})),function(a){var e=function(n){function o(e,t,r){var i=n.call(this)||this;return i.ForwPlcPath="",i.AfterPlcpath="",i.srcModel=null,i.destModel=null,i.srcModel=t,i.destModel=r,i.commandType=o.TYPE,i.ForwPlcPath=a.PathHelper.GetM3DPath(i.srcModel),i.view=e,i}return __extends(o,n),o.prototype.OnExecute=function(){var e=!1;if(this.view){var t=this.srcModel,r=this.destModel;if(t&&r){if(!(e=a.ModelTransformHelper.DetachModel(t)))return e;if(!(e=a.ModelTransformHelper.InsertBefore(this.view,t,r)))return e;this.AfterPlcpath=a.PathHelper.GetM3DPath(r),a.ModelTransformHelper.ComputePlaceMatrix(t)}e=!0}else e=!1;return e},o.prototype.GetForwPlcPath=function(){this.ForwPlcPath},o.prototype.GetAfterPlcPath=function(){this.AfterPlcpath},o.TYPE=11,o}(a.Operation);a.MoveModelOperation=e}(M3D||(M3D={})),function(r){var e=function(i){function n(e,t){var r=i.call(this)||this;return r.plcPath="",r.model=null,r.commandType=n.TYPE,r.Init(e,t),r}return __extends(n,i),n.prototype.OnExecute=function(){return!!this.view&&(!!this.model&&r.ModelTransformHelper.DeleteModel(this.view,this.model))},n.prototype.ToJsonString=function(){return""},n.prototype.GetPlcPath=function(){},n.prototype.Init=function(e,t){this.plcPath="",this.model=t,this.view=e,this.model&&(this.plcPath=r.PathHelper.GetM3DPath(this.model))},n.TYPE=12,n}(r.Operation);r.RemoveModelOperation=e}(M3D||(M3D={})),function(r){var e=function(n){function e(e,t,r){var i=n.call(this)||this;return i.desModel=null,i.retModel=null,i.Init(e,t,r),i}return __extends(e,n),e.prototype.Init=function(e,t,r){this.sourceModel=t,this.desModel=r,this.view=e},e.prototype.GetUpperPlcPath=function(){return this.upperPlcPath},e.prototype.GetSourceModel=function(){return this.sourceModel},e.prototype.OnExecute=function(){var e=!1;if(this.view){var t=this.desModel;if(t){if(this.desModel&&(this.upperPlcPath=r.PathHelper.GetM3DPath(this.desModel)),!(e=r.ModelTransformHelper.InsertBefore(this.view,this.GetSourceModel(),t)))return e;e=!0}else e=!1}else e=!1;return e},e.prototype.GetNewModel=function(){return this.retModel},e.TYPE=9,e}(r.Operation);r.AddFileOperation=e}(M3D||(M3D={})),function(e){var t=function(n){function e(e,t,r){var i=n.call(this)||this;return i.model=null,i.lastName="",i.newName="",i.newName=r,i.model=t,i.view=e,i.lastName=t.GetName(),i}return __extends(e,n),e.prototype.OnExecute=function(){var e=!1;return this.view&&(e=!!this.model&&(this.model.SetName(this.newName),!0)),e},e}(e.Operation);e.RenameOperation=t}(M3D||(M3D={})),function(r){var e=function(){this.m_pointSet=[],this.m_colorSet=[],this.m_lineWidthSet=[]};r.Gesture3DInfo=e;var t=function(){this.m_start=new r.Vector3,this.m_end=new r.Vector3,this.m_imageSize=new r.Vector2,this.m_imagePath=""};r.CommonNoteInfo=t;var i=function(t){function e(){var e=t.call(this)||this;return e.m_isShowSpacePoint=!1,e.m_line3DIndex=[],e.m_origin3DPointIndex=[],e.m_originalProjPnts=[],e.m_originalProjColors=[],e.m_originalProjWidths=[],e.SetType(r.ShapeType.SHAPE_THREED_GESTURE_NOTE),e}return __extends(e,t),e.prototype.SetLine3DIndex=function(e,t){this.m_line3DIndex.push(e),this.m_line3DIndex.push(t)},e.prototype.GetLine3DIndex=function(){return this.m_line3DIndex},e.prototype.SetOrigin3DPointIndex=function(e){this.m_origin3DPointIndex.push(e)},e.prototype.GetOrigin3DPointIndex=function(){return this.m_origin3DPointIndex},e.prototype.GetOriginalProjectPns=function(){return this.m_originalProjPnts},e.prototype.SetOriginalProjectPns=function(e){this.m_originalProjPnts.push(e)},e.prototype.GetOriginalProjectColors=function(){return this.m_originalProjColors},e.prototype.SetOriginalProjectColors=function(e){this.m_originalProjColors.push(e)},e.prototype.GetOriginalProjectWidths=function(){return this.m_originalProjWidths},e.prototype.SetOriginalProjectWidths=function(e){this.m_originalProjWidths.push(e)},e.prototype.GetIsShowSpacePoint=function(){return this.m_isShowSpacePoint},e.prototype.SetIsShowSpacePoint=function(e){this.m_isShowSpacePoint=e},e}(r.Note);r.ThreeDGesturesNote=i;var n=function(t){function e(){var e=t.call(this)||this;return e.SetType(r.ShapeType.SHAPE_COMMON_NOTE),e}return __extends(e,t),e}(r.Note);r.CommonNote=n}(M3D||(M3D={})),function(e){var t=function(){};(M3D||(M3D={})).OperationHistoryManager=t}(),function(g){var l=function(){this.volume=0,this.area=0,this.isFirstGetProperties=!0,this.placePath=""};g.ModelExtInfo=l;var e=function(){function e(){this.instanceId=-1,this.partId=-1}return e.prototype.getInstanceId=function(){return this.instanceId},e.prototype.setInstanceId=function(e){this.instanceId=e},e.prototype.getPartId=function(){return this.partId},e.prototype.setPartId=function(e){this.partId=e},e}();g.ModelFileInfo=e;var t=function(i){function a(){var e=i.call(this)||this;return e.worldMatrix=null,e.dirty=!0,e.SubModelArray=[],e.userData=null,e.PlaceID=-1,e.InstanceID=-1,e.plcMatrix=new g.Matrix4,e.ParentModel=null,e.SectionPlaneList=[],e.userPlcId=-1,e.origVisible=!0,e.ModleViewList=[],e.modelShape=null,e.modelFileInfo=null,e.modelExtInfo=null,e.SetType(g.ShapeType.SHAPE_MODEL),e}return __extends(a,i),a.prototype.IsDirty=function(){return this.dirty},a.prototype.MarkDirty=function(){this.dirty=!0,this.OnMarkedDirty(),this.modelShape&&this.modelShape.MarkDirty();for(var e=0;e<this.SubModelArray.length;++e)this.SubModelArray[e].MarkDirty()},a.prototype.OnMarkedDirty=function(){},a.prototype.GetWorldTransform=function(){return this.IsDirty()&&this.UpdateWorldTransform(),this.worldMatrix},a.prototype.UpdateWorldTransform=function(){var e=this.GetLocalTransform();null==this.ParentModel?this.worldMatrix=e:this.worldMatrix=this.ParentModel.GetWorldTransform().Multiply(e),this.dirty=!1},a.prototype.GetTransform=function(){return this.GetPlaceMatrix()},a.prototype.GetLocalTransform=function(){return this.GetTransform()},a.prototype.UpdateHardWareBuffer=function(e){},a.prototype.SetInitHightlight=function(e){null!==this.modelShape&&this.modelShape.SetInitHightlight(e)},a.prototype.GetModelShape=function(){return this.modelShape},a.prototype.SetModelShape=function(e){(this.modelShape=e)&&this.modelShape.SetModel(this)},a.prototype.GetOrigPlcMartirx=function(){return this.modelExtInfo?this.modelExtInfo.origPlcMatrix:null},a.prototype.SetOrigPlcMatrix=function(e){this.modelExtInfo||(this.modelExtInfo=new l),this.modelExtInfo&&(this.modelExtInfo.origPlcMatrix=e,this.SetPlaceMatrix(e.ToMatrix4())),this.MarkDirty()},a.prototype.GetWorldPosition=function(){return this.dirty&&this.UpdateWorldTransform(),this.worldMatrix.Translation()},a.prototype.SetWorldScale=function(e){},a.prototype.SetScale=function(e){},a.prototype.SetWorldRotation=function(e){this.SetRotation(null==this.ParentModel?e:this.ParentModel.GetWorldRotation().Inverse().Multiply(e))},a.prototype.SetRotation=function(e){var t=new g.Vector3,r=e.Clone(),i=new g.Vector3;this.GetPlaceMatrix().Decompose(t,r,i),this.SetTransform(t,e,i)},a.prototype.SetWorldPosition=function(e){this.SetPosition(null==this.ParentModel?e:this.ParentModel.GetWorldTransform().Inverse().Multiply(e))},a.prototype.SetPosition=function(e){var t=new g.Vector3,r=new g.Quaternion,i=new g.Vector3;this.GetPlaceMatrix().Decompose(t,r,i),this.SetTransform(e,r,i)},a.prototype.SetTransform=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(2==e.length)this.SetTransform(e[0],e[1],new g.Vector3(1,1,1)),this.MarkDirty();else if(3==e.length)if(e[2]instanceof g.Vector3){var r=new g.Matrix3x4(e[0],e[1],e[2]);this.SetPlaceMatrix(r.ToMatrix4())}else this.SetTransform(e[0],e[1],new g.Vector3(e[2],e[2],e[2]))},a.prototype.RendreVisible=function(){return this.modelExtInfo,!0},a.prototype.ClearLineData=function(){this.modelShape&&(this.modelShape=null)},a.prototype.AddLineData=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(2==e.length){var r=e[0],i=e[1];if(null==(a=(o=new g.Body).GetPolyLine()))if(a=new g.SPolyLine,o.SetPolyLine(a),(s=new g.RefPolyLine(a)).SetDataOffset(a.GetPoints().length),s.SetDataLength(2*(i.length-1)),(l=new g.Edge).AddData(s,0),o.AddEdge(l),2<=(h=i.length)){a.AddPoint(r[0]);for(var n=1;n<h-1;n++)a.AddPoint(r[i[n]]),a.AddPoint(r[i[n]]);a.AddPoint(r[h-1])}this.AddBody(o)}else{var o,a,s,l,h;r=e[0];if(null==(a=(o=new g.Body).GetPolyLine()))if(a=new g.SPolyLine,o.SetPolyLine(a),(s=new g.RefPolyLine(a)).SetDataOffset(a.GetPoints().length),s.SetDataLength(2*(r.length-1)),(l=new g.Edge).AddData(s,0),o.AddEdge(l),2<=(h=r.length)){a.AddPoint(r[0]);for(n=1;n<h-1;n++)a.AddPoint(r[n]),a.AddPoint(r[n]);a.AddPoint(r[h-1])}this.AddBody(o)}},a.prototype.GetWorldRotation=function(){return this.dirty&&this.UpdateWorldTransform(),this.worldMatrix.Rotation()},a.prototype.GetExtendInfoManager=function(){return this.extInfoMgr},a.prototype.SetModelExtInfo=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(1==e.length){var r=e[0];this.extInfoMgr&&this.extInfoMgr==e[0]||(this.extInfoMgr=r,this.modelExtInfo||(this.modelExtInfo=new l),this.modelExtInfo.origVisible=this.IsVisible(),this.modelExtInfo.origPlcMatrix=this.plcMatrix.ToMatrix3x4(),this.SetModelExtInfo())}else if(2==e.length){r=e[0];var i=e[1];if(this.SetModelExtInfo(e[0]),i)for(var n=0;n<this.SubModelArray.length;n++)this.SubModelArray[n].SetModelExtInfo(r,i)}else{var o=this.GetBodys();if(o)for(var a=0;a<o.length;a++){var s=o[a];s&&s.SetBodyExtInfo()}}},a.prototype.getModelFileInfo=function(){return this.modelFileInfo},a.prototype.setModelFileInfo=function(e){this.modelFileInfo=e},a.prototype.AddBody=function(e){null===this.modelShape&&(this.modelShape=new g.ModelShape,this.modelShape.SetModel(this)),null!==this.modelShape&&this.modelShape.AddBody(e)},a.prototype.GetPlacePath=function(){return this.GetPlcPath()},a.prototype.GetPlcPath=function(){return this.modelExtInfo?0<this.modelExtInfo.placePath.length?this.modelExtInfo.placePath:(this.ParentModel?this.SetPlcPath(this.ParentModel.GetPlcPath()+"|"+this.PlaceID.toString(16)):this.SetPlcPath(g.MAINMODELROOT+"|0"),this.GetPlcPath()):g.MAINMODELROOT},a.prototype.SetPlcPath=function(e){this.modelExtInfo||(this.modelExtInfo=new l),this.modelExtInfo.placePath=e},a.prototype.GetInstatnceID=function(){return this.InstanceID},a.prototype.SetInstanceID=function(e){this.InstanceID=e},a.prototype.AddSubModel=function(e){null!==e&&e instanceof a&&(this.SubModelArray.push(e),e.SetParent(this))},a.prototype.GetModelById=function(e){var t=null;if(this.GetID()===e)return this;for(var r=0,i=this.SubModelArray;r<i.length;r++){if(null!=(t=i[r].GetModelById(e)))return t}return null},a.prototype.GetModelByPlacePath=function(e){var t=null;if(this.GetPlacePath()===e)return this;for(var r=0,i=this.SubModelArray;r<i.length;r++){if(null!=(t=i[r].GetModelByPlacePath(e)))return t}return null},a.prototype.GetSubModels=function(){return this.SubModelArray},a.prototype.GetAllSubModels=function(e){for(var t=0;t<this.SubModelArray.length;t++){var r=this.SubModelArray[t];e.push(r),r.GetAllSubModels(e)}},a.prototype.RemoveSubModel=function(e){for(var t=0;t<this.SubModelArray.length;t++)if(this.SubModelArray[t]===e)return void this.SubModelArray.splice(t,1)},a.prototype.GetSubModelCount=function(){return this.SubModelArray.length},a.prototype.IsAssembly=function(){return 0!=this.GetSubModelCount()},a.prototype.SetPlaceMatrix=function(e){this.plcMatrix.copyFrom(e),this.MarkDirty()},a.prototype.SetWorldMatrix=function(e){this.worldMatrix.copyFrom(e),this.MarkDirty()},a.prototype.GetPlaceMatrix=function(){return this.plcMatrix},a.prototype.GetParent=function(){return this.ParentModel},a.prototype.SetParent=function(e){this.ParentModel=e},a.prototype.InsertChild=function(e,t){this.SubModelArray.length},a.prototype.Clear=function(){},a.prototype.SetPlcId=function(e){this.PlaceID=e},a.prototype.GetPlcId=function(){return this.PlaceID},a.prototype.SetProtoTypeId=function(e){this.ProtoTypeID=e},a.prototype.GetProtoTypeId=function(){return this.ProtoTypeID},a.prototype.CopyData=function(e){if(0<e.GetSubModelCount())for(var t=e.GetSubModels(),r=0;r<t.length;r++){var i=new a;i.CopyData(t[r]),this.AddSubModel(i)}if(null!==e.modelShape)for(var n=0;n<e.GetBodys().length;n++){var o=new g.Body;o.AssignOperator(e.GetBodys()[n]),this.AddBody(o)}this.SetName(e.GetName()),this.SetPlaceMatrix(e.GetPlaceMatrix()),this.SetPlcId(e.GetPlcId()),this.SetProtoTypeId(e.GetProtoTypeId()),e.GetOrigPlcMartirx()&&this.SetOrigPlcMatrix(e.GetOrigPlcMartirx())},a.prototype.CopyRenderData=function(e){if(null!==e.modelShape)for(var t=0;t<e.GetBodys().length;t++){var r=new g.Body;r.AssignOperator(e.GetBodys()[t]),this.AddBody(r)}},a.prototype.FindVisiableObject=function(e){if(this.IsVisible()){null!==this.modelShape&&this.modelShape.FindVisiableObject(e);for(var t=0;t<this.SubModelArray.length;++t)this.SubModelArray[t].FindVisiableObject(e)}},a.prototype.RayPick=function(e){if(this.Visible&&this.selectAble){null!==this.modelShape&&this.modelShape.RayPick(e);for(var t=0;t<this.SubModelArray.length;++t)this.SubModelArray[t].RayPick(e)}},a.prototype.SetSelected=function(e){i.prototype.SetSelected.call(this,e),null!==this.modelShape&&this.modelShape.SetSelected(e);for(var t=0;t<this.SubModelArray.length;t++){var r=this.SubModelArray[t];null!==r&&r.SetSelected(e)}},a.prototype.SetSelectAble=function(e,t){if(void 0===t&&(t=!1),i.prototype.SetSelectAble.call(this,e),null===this.modelShape&&(this.modelShape=new g.ModelShape,this.modelShape.SetModel(this)),this.modelShape.SetSelectAble(e),t)for(var r=0;r<this.SubModelArray.length;r++)this.SubModelArray[r].SetSelectAble(e,t)},a.prototype.SetVisible=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(1===e.length)this.SetVisible(e[0],!0);else if(i.prototype.SetVisible.call(this,e[0]),this.modelShape&&this.modelShape.SetVisible(e[0]),e[1])for(var r=0;r<this.SubModelArray.length;r++)this.SubModelArray[r].SetVisible(e[0],e[1])},a.prototype.ComputeBox=function(){null!==this.modelShape&&this.modelShape.ComputeBox()},a.prototype.ResetAlpha=function(){null!==this.modelShape&&this.modelShape.ResetAlpha();for(var e=0;e<this.SubModelArray.length;e++)this.SubModelArray[e].ResetAlpha()},a.prototype.ResetColor=function(){i.prototype.ResetColor.call(this),null!==this.modelShape&&this.modelShape.ResetColor();for(var e=0;e<this.SubModelArray.length;e++)this.SubModelArray[e].ResetColor()},a.prototype.SetFaceMaterial=function(e){for(var t=0;t<this.GetBodys().length;t++)for(var r=this.GetBodys()[t],i=0;i<r.GetFaces().length;i++)r.GetFaces()[i].SetMaterial(e);for(t=0;t<this.SubModelArray.length;t++)this.SubModelArray[t].SetFaceMaterial(e)},a.prototype.GetFaceMaterial=function(){for(var e=null,t=0;t<this.GetBodys().length;t++){var r=this.GetBodys()[t];if(r&&0<r.GetFaces().length){var i=r.GetFaces()[0];if(i&&(e=i.GetMaterial()))break}}return e},a.prototype.SetInitColor=function(e){null!==this.modelShape&&this.modelShape.SetInitColor(e),this.Color=e.Clone()},a.prototype.GetTotalWorldBoundingBox=function(){var e=[];this.GetAllSubModels(e);for(var t=new g.BoundingBox,r=0;r<e.length;r++){var i=e[r];i.GetWorldBoundingBox()&&i.GetWorldBoundingBox().Defined()&&t.Merge(i.GetWorldBoundingBox())}return this.GetWorldBoundingBox()&&this.GetWorldBoundingBox().Defined()&&t.Merge(this.GetWorldBoundingBox()),t},a.prototype.GetTotalBoundingBox=function(){var e=[];this.GetAllSubModels(e);for(var t=new g.BoundingBox,r=0;r<e.length;r++){var i=e[r];i.GetBoundingBox().Defined()&&t.Merge(i.GetBoundingBox())}return this.GetBoundingBox().Defined()&&t.Merge(this.GetBoundingBox()),t},a.prototype.GetBoundingBox=function(){return this.modelShape?this.modelShape.GetBoundingBox():g.BoundingBox.NO_BOX()},a.prototype.SetColor=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(1===e.length)this.SetColor(e[0],!0);else if(this.Color=e[0].Clone(),null!==this.modelShape&&this.modelShape.SetColor(this.Color),e[1])for(var r=0;r<this.SubModelArray.length;r++)this.SubModelArray[r].SetColor(e[0])},a.prototype.SetAlpha=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(1===e.length)this.SetAlpha(e[0],!0);else{var r=e[0];if(e[1])for(var i=0;i<this.SubModelArray.length;i++)this.SubModelArray[i].SetAlpha(r,!0);if(this.modelShape){var n=this.GetFaceMaterial();if(n){var o=null,a=this.GetExtendInfoManager();if(a){var s=a.GetScene();s&&(o=s.GetResourceManager())}if(!o)return;var l=this.GetExtendInfoManager().GetScene().GetModel();switch(n.GetMaterialType()){case g.MaterialType.MaterialType_Phong:var h,u=n,p=u.GetDiffuse();if(h=o.IsMaterialExisted(p,r))this.SetFaceMaterial(h),this.modelShape.SetAlpha(r);else if(o.IsMaterialUsed(l,u,this)){var c="material_phong_uuid_"+g.IDCreator.GetUUID(),d=u.Clone();p.a=r,d.SetDiffuse(p),d.Opacity(r),d.SetAmbient(u.GetAmbient()),d.SetSpecular(u.GetSpecular()),d.SetEmissive(u.GetEmissive()),d.SetName(c);o.AddMaterial(c,d);d.SetResourceManager(o),this.SetFaceMaterial(d),this.modelShape.SetAlpha(r)}else u.Opacity(r),p.a=r,u.SetDiffuse(p),this.SetFaceMaterial(u),this.modelShape.SetAlpha(r);break;case g.MaterialType.MaterialType_Pbr:var S,f=n;p=f.AlbedoColor();if(S=o.IsMaterialExisted(p,r))this.SetFaceMaterial(S),this.modelShape.SetAlpha(r);else if(o.IsMaterialUsed(l,f,this)){c="material_pbr_uuid_"+g.IDCreator.GetUUID();var m=f.Clone();p.a=r,m.SetOpacity(r),f.SetAlbedoColor(p),m.SetName(c);o.AddMaterial(c,m);m.setResourceManager(o),this.SetFaceMaterial(m),this.modelShape.SetAlpha(r)}else f.SetOpacity(r),p.a=r,f.SetAlbedoColor(p),this.SetFaceMaterial(f),this.modelShape.SetAlpha(r);break;case g.MaterialType.MaterialType_MatCap:var y,T=n;p=T.GetAmbient();if(y=o.IsMaterialExisted(p,r))this.SetFaceMaterial(y),this.modelShape.SetAlpha(r);else if(o.IsMaterialUsed(l,T,this)){c="material_matCap_uuid_"+g.IDCreator.GetUUID();var M=T.Clone();p.a=r,M.Opacity(r),M.SetName(c),M.SetAmbient(p);o.AddMaterial(c,M);M.SetResourceManager(o),this.SetFaceMaterial(M),this.modelShape.SetAlpha(r)}else T.Opacity(r),p.a=r,T.SetAmbient(p),this.SetFaceMaterial(T),this.modelShape.SetAlpha(r)}}else this.modelShape.SetAlpha(r)}}},a.prototype.GetColor=function(){return i.prototype.GetColor.call(this).Clone()},a.prototype.GetDrawColor=function(){return i.prototype.GetDrawColor.call(this).Clone()},a.prototype.GetAlpha=function(){return this.Color.a},a.prototype.GetSceneNode=function(){return this.node},a.prototype.SetOrigVisible=function(e){this.origVisible=e,this.SetVisible(e)},a.prototype.IsOrigVisible=function(){return this.origVisible},a.prototype.Restore=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(1===e.length){if(e[0])for(var r=0;r<this.SubModelArray.length;r++)this.SubModelArray[r].Restore();this.Restore()}else null!==this.modelShape&&this.modelShape.Restore(),this.ResetColor(),this.SetVisible(this.IsOrigVisible()),this.SetSelected(!1),this.GetPlaceMatrix().Equals(this.GetOrigPlcMartirx().ToMatrix4())||this.SetPlaceMatrix(this.GetOrigPlcMartirx().ToMatrix4())},a.prototype.ResetMovement=function(){this.GetOrigPlcMartirx()&&(this.plcMatrix=this.GetOrigPlcMartirx().ToMatrix4()),this.MarkDirty()},a.prototype.GetSVLPath=function(){return g.AnimationHelper.AniDecPathToM3DHexPath(this.GetPlcPath())},a.prototype.GetUserSVLPath=function(){var e=this.GetSVLPath();return e.substring(e.indexOf("PATH"))},a.prototype.GetWorldBoundingBox=function(){return null!==this.modelShape?this.modelShape.GetWorldBoundingBox():null},a.prototype.SetBox=function(e){null===this.modelShape&&(this.modelShape=new g.ModelShape,this.modelShape.SetModel(this)),this.modelShape.SetBoundingBox(e)},a.prototype.SetDrawDataPrepared=function(e){null!==this.modelShape&&this.modelShape.SetDrawDataPrepared(e)},a.prototype.Traverse=function(e){if(!e.IsFinish()){e.Apply(this);for(var t=0;t<this.SubModelArray.length;++t)this.SubModelArray[t].Traverse(e)}},a.prototype.GetUseablePlcId=function(){for(var e=0;e<this.SubModelArray.length;e++){var t=this.SubModelArray[e].GetPlcId();this.userPlcId<t&&(this.userPlcId=t)}return this.userPlcId++,this.userPlcId},a.prototype.GetBodys=function(){return null!==this.modelShape?this.modelShape.GetBodys():[]},a.prototype.DetachSubModel=function(e){for(var t=0;t<this.SubModelArray.length;t++)if(this.SubModelArray[t]===e){e.SetParent(null),this.SubModelArray.splice(t,1),e=null;break}},a.prototype.GetSectionPlaneList=function(){return this.extInfoMgr?this.extInfoMgr.GetModelSectionPlane(this.Id):this.SectionPlaneList},a.prototype.AddSectionPlane=function(e){var t,r=!1,i=this.extInfoMgr.GetModelSectionPlane(this.Id);if(!i){var n=[];return n.push(e),this.extInfoMgr.AddModelSectionPlane(this.Id,n),void(i=this.extInfoMgr.GetModelSectionPlane(this.Id))}for(var o=0,a=i;o<a.length;o++){var s=a[o];if(s.GetID()===e.GetID()){t=s,r=!0;break}}if(r){var l=i.indexOf(t);i.splice(l,1)}i.push(e),i=this.extInfoMgr.GetModelSectionPlane(this.Id)},a.prototype.GetSectionPlane=function(e){var t=null,r=this.GetSectionPlaneList();if(r)for(var i=0;i<r.length;i++)if(r[i].GetID()===e){t=r[i];break}return t},a.prototype.GetModelViewList=function(){return this.ModleViewList},a.prototype.GetModleViews=function(e,t){if(0!==this.ModleViewList.length)for(var r=0;r<this.ModleViewList.length;r++)e.push(this.ModleViewList[r].GetID()),t.push(this.ModleViewList[r].GetName())},a.prototype.SetModleViewList=function(e){this.ModleViewList=e},a.prototype.GetModleView=function(e){var t=null;if(this.ModleViewList.length)for(var r=0;r<this.ModleViewList.length;r++)if(this.ModleViewList[r].GetID()==e){t=this.ModleViewList[r];break}return t},a.prototype.AddModelView=function(e){var t=!1,r=0;if(this.ModleViewList.length)for(var i=0;i<this.ModleViewList.length;i++)if(this.ModleViewList[i].GetID()===e.GetID()){console.log("Exist View Id is ===== "+this.ModleViewList[i].GetID()),t=!0,r=i;break}t&&(g.LOGI("Model::addModelView: error：Id已经存在！将替换。"),this.ModleViewList[r]=e),this.ModleViewList.push(e)},a.prototype.RemoveModelView=function(e){if(this.ModleViewList.length)for(var t=0;t<this.ModleViewList.length;t++)if(this.ModleViewList[t].GetID()===e){this.ModleViewList.splice(t,1);break}},a.prototype.GetVertexCount=function(e){for(var t=0,r=0;r<this.GetBodys().length;r++)t+=this.GetBodys()[r].GetVertexCount(e);for(r=0;r<this.GetSubModels().length;r++)t+=this.GetSubModels()[r].GetVertexCount(e);return t},a.prototype.SetProperties=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(1===e.length){var r=e[0];JSON.parse(r)}else{var i=e[0],n=e[1];switch(i){case"nameStr":this.SetName(n);break;case"ID":this.SetID(Number(n));break;case"PlaceID":this.SetPlcId(Number(n));break;case"ProtoTypeID":this.SetProtoTypeId(Number(n));break;case"Color":var o=n.split(",");this.SetColor(new g.Color(Number(o[0]),Number(o[1]),Number(o[2]),Number(o[3])))}}},a.prototype.GetProperty=function(e){var t="";switch(e){case"nameStr":t=this.Name;break;case"ID":t=String(this.Id);break;case"PlaceID":t=String(this.PlaceID);break;case"ProtoTypeID":t=String(this.ProtoTypeID);break;case"Color":t=String(this.Color.r)+","+String(this.Color.g)+","+String(this.Color.b)+","+String(this.Color.a);break;case"SubModelNumber":t=String(this.SubModelArray.length);break;case"InstanceCount":t=String(this.GetInstanceCount());break;case"ModleViewCount":t=String(this.GetModelViewList().length);break;case"PMICount":if(this.extInfoMgr){var r=this.extInfoMgr.GetModelPMIRef(this.GetProtoTypeId());null!=r&&(t=String(r.length))}break;case"LOD0PatchNumber":t=String(this.GetVertexCount(0)/3);break;case"LOD1PatchNumber":t=String(this.GetVertexCount(1)/3);break;case"Volume":this.GetVolumeAndArea();var i=new Array;i.push(this.modelExtInfo.volume);var n="";n=g.MeasureDisplayHelper.SetMeasureVolumeUnit(g.Parameters.Instance().measureUnitStyle,i,n),t=String(i[0].toFixed(3))+n;break;case"Area":this.GetVolumeAndArea();var o=new Array;o.push(this.modelExtInfo.area);var a="";a=g.MeasureDisplayHelper.SetMeasureAreaUnit(g.Parameters.Instance().measureUnitStyle,o,a),t=String(o[0].toFixed(3))+a}return t},a.prototype.InitProperties=function(){this.AddProperty("Name",this.Name),this.AddProperty("ID",String(this.Id)),this.AddProperty("PlaceID",String(this.PlaceID)),this.AddProperty("ProtoTypeID",String(this.ProtoTypeID));var e=String(this.Color.r.toFixed(3))+","+String(this.Color.g.toFixed(3))+","+String(this.Color.b.toFixed(3))+","+String(this.Color.a.toFixed(3));if(this.AddProperty("Color",e),this.AddProperty("SubmodelsCount",String(this.SubModelArray.length)),this.AddProperty("InstanceCount",String(this.GetInstanceCount())),this.AddProperty("ModleViewCount",String(this.GetModelViewList().length)),this.extInfoMgr){var t=this.extInfoMgr.GetModelPMIRef(this.GetProtoTypeId());null!=t&&this.AddProperty("PMICount",String(t.length))}this.GetVolumeAndArea();var r=new Array;r.push(this.modelExtInfo.area);var i="";i=g.MeasureDisplayHelper.SetMeasureAreaUnit(g.Parameters.Instance().measureUnitStyle,r,i);var n=String(r[0].toFixed(3))+i;(r=new Array).push(this.modelExtInfo.volume),i=g.MeasureDisplayHelper.SetMeasureVolumeUnit(g.Parameters.Instance().measureUnitStyle,r,i);var o=String(r[0].toFixed(3))+i;this.AddProperty("Volume",String(o)),this.AddProperty("Area",String(n)),this.AddProperty("LOD0PatchCount",String(this.GetVertexCount(0)/3));var a=this.GetExtendInfoManager().GetModelFileAttribute(this.GetProtoTypeId());for(var s in a)this.AddProperty(s,a[s])},a.prototype.GetInstanceCount=function(){var e=this.SubModelArray.length;for(var t in this.SubModelArray)e+=this.SubModelArray[t].GetInstanceCount();return e},a.prototype.FramePick=function(e){this.IsVisible()&&e.CanPickShape(this.GetType())&&e.FrustumIntersetWithWorldBox(this.GetWorldBoundingBox())&&e.AddToFramePickCollection(this)},a.prototype.GetUserData=function(){return this.userData},a.prototype.SetUserData=function(e){this.userData=e},a.prototype.GetVolumeAndArea=function(){if(this.modelExtInfo.volume=0,this.modelExtInfo.area=0,this.modelShape){var e=this.modelShape.GetVolumeAndArea();this.modelExtInfo.volume+=e[0],this.modelExtInfo.area+=e[1]}for(var t=0;t<this.GetSubModelCount();t++){this.GetSubModels()[t].GetVolumeAndArea(),this.modelExtInfo.volume+=this.GetSubModels()[t].modelExtInfo.volume,this.modelExtInfo.area+=this.GetSubModels()[t].modelExtInfo.area}return[this.modelExtInfo.area,this.modelExtInfo.volume]},a}(g.Shape),r=function(e){function t(){return e.call(this)||this}return __extends(t,e),t.prototype.GetType=function(){return g.ShapeType.SHAPE_IMAGE_MODEL},t.prototype.SetImage=function(e){this.CreateModelShape();var t=this.GetImageModelShape();t&&t.SetImage(e)},t.prototype.SetImagePath=function(e){this.CreateModelShape();var t=this.GetImageModelShape();t&&t.SetImagePath(e)},t.prototype.SetImageData=function(e,t){this.CreateModelShape();var r=this.GetImageModelShape();r&&r.SetImageData(e,t)},t.prototype.SetImageSize=function(e,t){this.modelShape&&this.modelShape.SetImageSize(e,t)},t.prototype.SetImagePosition=function(e){this.modelShape&&this.modelShape.SetImagePosition(e)},t.prototype.SetImageGPUID=function(e){(this.CreateModelShape(),this.modelShape)&&this.modelShape.SetImageGPUID(e)},t.prototype.SetFlipImage=function(e){(this.CreateModelShape(),this.modelShape)&&this.modelShape.SetFlipImage(e)},t.prototype.SetAllowScall=function(e){this.modelShape&&this.modelShape.SetAllowScall(e)},t.prototype.SetAllowRotate=function(e){this.modelShape&&this.modelShape.SetAllowRotate(e)},t.prototype.SetInTopShow=function(e){this.modelShape&&this.modelShape.SetInTopShow(e)},t.prototype.SetFixShowInScreen=function(e){this.modelShape&&this.modelShape.SetFixShowInScreen(e)},t.prototype.SetAllowTran=function(e){this.modelShape&&this.modelShape.SetAllowTran(e)},t.prototype.GetImageModelShape=function(){return this.modelShape},t.prototype.CreateModelShape=function(){null==this.modelShape&&(this.modelShape=new g.ImageModelShape,this.modelShape.SetModel(this))},t}(g.Model=t);g.ImageModel=r;var i=function(t){function e(){var e=t.call(this)||this;return e.SetSimpleSignModel(null),e.SetAllSignModel(null),e.SetNeedUpdataSign(!1),e.m_showSimpleSign=!1,e.m_ShowAllSign=!1,e}return __extends(e,t),e.prototype.GetShowSimpleSign=function(){return this.m_showSimpleSign},e.prototype.SetShowSimpleSign=function(e){this.m_showSimpleSign=e,this.m_allSignModel&&this.m_allSignModel.SetVisible(e)},e.prototype.GetShowAllSign=function(){return this.m_ShowAllSign},e.prototype.SetShowAllSign=function(e){this.m_ShowAllSign=e,this.m_allSignModel&&this.m_allSignModel.SetVisible(e)},e.prototype.OnMarkedDirty=function(){this.SetNeedUpdataSign(!0)},e.prototype.GetNeedUpdataSign=function(){return this.m_needUpdataSign},e.prototype.SetNeedUpdataSign=function(e){this.m_needUpdataSign=e},e.prototype.GetSimpleSignModel=function(){return this.m_simpleSignModel},e.prototype.SetSimpleSignModel=function(e){this.m_simpleSignModel=e},e.prototype.GetAllSignModel=function(){return this.m_allSignModel},e.prototype.SetAllSignModel=function(e){this.m_allSignModel=e},e}(t);g.SignModel=i}(M3D||(M3D={})),function(r){var e;(e=r.LightType||(r.LightType={}))[e.LightType_Base=0]="LightType_Base",e[e.LightType_Ambient=1]="LightType_Ambient",e[e.LightType_Directional=2]="LightType_Directional",e[e.LightType_Point=3]="LightType_Point",e[e.LightType_Spot=4]="LightType_Spot",e[e.LightType_Hemisphere=5]="LightType_Hemisphere";var t=function(t){function e(){var e=t.call(this)||this;return e.renderWorldMatrix=null,e.vertexOffset=0,e.hardwareVertexBuffer=null,e.texCoodrsOffset=0,e.m_lightColor=new r.Color(1,1,1),e.m_intensity=1,e.m_direction=new r.Vector3(0,0,1),e.m_castShadow=!1,e.m_allSignModel=null,e.m_simpleSignModel=null,e.m_needUpdateInfo=!0,e.m_isTurnOn=!0,e}return __extends(e,t),e.prototype.GetLightShadow=function(){return null},e.prototype.GetNodeWorldPosition=function(){new r.Vector3;return this.GetWorldPosition()},e.prototype.IsInWorld=function(){return this.m_isInWorld},e.prototype.SetIsInWorld=function(e){this.m_isInWorld=e},e.prototype.SetIsTurnOn=function(e){this.m_isTurnOn=e},e.prototype.IsTurnOn=function(){return this.m_isTurnOn},e.prototype.SetNodeWorldPosition=function(e){this.SetWorldPosition(e)},e.prototype.GetWorldDirection=function(){return this.GetWorldRotation().Multiply(this.m_direction)},e.prototype.RayPick=function(e){this.IsVisible()&&this.RendreVisible()&&(e.BeginPickAsGroup(this),t.prototype.RayPick.call(this,e),e.EndPickAsGroup(this,1))},e.prototype.FramePick=function(e){this.IsVisible()&&this.RendreVisible()},e.prototype.SetUpHelperData=function(){},e.prototype.GetLightSourceType=function(){return this.m_lightType},e.prototype.SetLightSourceType=function(e){this.m_lightType=e},e.prototype.GetLightColor=function(){return this.m_lightColor},e.prototype.SetLightColor=function(e){this.m_lightColor=e},e.prototype.GetIntensity=function(){return this.m_intensity},e.prototype.SetIntensity=function(e){this.m_intensity=e},e.prototype.SetCastShadow=function(e){this.m_castShadow=e},e.prototype.CastShadow=function(){return this.m_castShadow},e.prototype.NeedUpdateInfo=function(){return this.m_needUpdateInfo},e.prototype.SetNeedUpdateInfo=function(e){this.m_needUpdateInfo=e},e.prototype.GetType=function(){return r.ShapeType.SHAPE_LIGHT_BASE},e.prototype.SetRenderWorldMatrix=function(e){this.renderWorldMatrix=e.Clone()},e.prototype.GetRenderWorldMatrix=function(){return this.renderWorldMatrix},e.prototype.GetRenderColor=function(){var e=r.Color.WHITE().Clone();return this.IsSelected()?r.Color.SelectColor().Clone():e},e.prototype.GetRenderMaterial=function(){return new r.Material},e.prototype.SetRenderMesh=function(e){},e.prototype.GetDataLength=function(){return-1},e.prototype.IsUseIndex=function(){return!1},e.prototype.SetIndexOffset=function(e){},e.prototype.GetIndexOffset=function(){return-1},e.prototype.SetNormalOffset=function(e){},e.prototype.GetNormalOffset=function(){return-1},e.prototype.SetVertexOffset=function(e){this.vertexOffset=e},e.prototype.GetVertexOffset=function(){return this.vertexOffset},e.prototype.SetTextureCoordsOffset=function(e){this.texCoodrsOffset=e},e.prototype.GetTextureCoordsOffset=function(){return this.texCoodrsOffset},e.prototype.SetCentersCoordsOffset=function(e){},e.prototype.GetCentersCoordsOffset=function(){return-1},e.prototype.GetHardWareVertexBuffer=function(){return null},e.prototype.GetHardWareIndexBuffer=function(){return null},e}(r.SignModel);r.BaseLight=t}(M3D||(M3D={})),function(r){var e=function(t){function e(){var e=t.call(this)||this;return e.m_lightColor=new r.Color(1,1,1),e.m_lightType=r.LightType.LightType_Ambient,e}return __extends(e,t),e}(r.BaseLight);r.AmbientLight=e}(M3D||(M3D={})),function(e){var t=function(){function e(){this.resourceManager=null,this.Init()}return e.prototype.setResourceManager=function(e){this.resourceManager=e},e.prototype.Init=function(){this.setResourceManager(null),this.SetSvlId(-1)},e.prototype.SetSvlId=function(e){this.m_svlId=e},e.prototype.GetSvlId=function(){return this.m_svlId},e}();e.Resource=t}(M3D||(M3D={})),function(u){var p,e,t;(e=p=u.MaterialType||(u.MaterialType={}))[e.MaterialType_Base=0]="MaterialType_Base",e[e.MaterialType_Phong=1]="MaterialType_Phong",e[e.MaterialType_Pbr=2]="MaterialType_Pbr",e[e.MaterialType_Shader=3]="MaterialType_Shader",e[e.MaterialType_MatCap=4]="MaterialType_MatCap",e[e.MaterialType_Inner=5]="MaterialType_Inner",e[e.MaterialType_Depth=6]="MaterialType_Depth",(t=u.EnvTextureMappingType||(u.EnvTextureMappingType={}))[t.CubeReflectionMapping=0]="CubeReflectionMapping",t[t.CubeRefractionMapping=1]="CubeRefractionMapping",t[t.EquirectangularReflectionMapping=2]="EquirectangularReflectionMapping",t[t.EquirectangularRefractionMapping=3]="EquirectangularRefractionMapping",t[t.SphericalReflectionMapping=4]="SphericalReflectionMapping",t[t.CubeUVReflectionMapping=5]="CubeUVReflectionMapping",t[t.CubeUVRefractionMapping=6]="CubeUVRefractionMapping";var r=function(h){function e(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=h.call(this)||this;if(r.m_uniformPatameters={},1===e.length){var i=e[0];r.m_uuid=u.IDCreator.GetUUID(),r.m_materialType=i.m_materialType,r.m_useLight=i.m_useLight,r.m_program=i.m_program,r.m_needUpdate=i.m_needUpdate,r.m_define=i.m_define,r.m_lightHash=i.m_lightHash,r.needsUpdateUniformParameters=i.needsUpdateUniformParameters;var n=i.m_uniformPatameters;for(var o in n){var a=new u.Uniform(null,null),s=n[o].uniformType;if("Texture2D"===(a.uniformType=s)){var l=n[o].value;a.value=l}else if("TextureCube"===s){l=n[o].value;a.value=l}else if("Float"===s){l=n[o].value;a.value=l}else if("Int"===s){l=n[o].value;a.value=l}else if("Vector3"===s){l=n[o].value;a.value=l.Clone()}else if("Vector4"===s){l=n[o].value;a.value=l.Clone()}else if("Bool"===s){l=n[o].value;a.value=l}r.SetUniformParameter(o,a)}}else r.m_materialType=p.MaterialType_Base,r.m_useLight=!0,r.m_uuid=u.IDCreator.GetUUID(),r.m_program=null,r.m_needUpdate=!0,r.m_define={},r.m_lightHash="",r.needsUpdateUniformParameters=!0;return r}return __extends(e,h),e.prototype.GetMaterialTypeStr=function(e){return e==p.MaterialType_Phong?"PhongMaterial":e==p.MaterialType_Pbr?"PbrMaterial":p.MaterialType_Depth?"DepthMaterial":p.MaterialType_MatCap?"MatCapMaterial":"ShaderMaterial"},e.prototype.SetName=function(e){this.m_name=e},e.prototype.GetName=function(){return this.m_name},e.prototype.GetMaterialType=function(){return this.m_materialType},e.prototype.SetMaterialType=function(e){this.m_materialType=e},e.prototype.SetUniformParameter=function(e,t){var r=!1;return null!==this.m_uniformPatameters[e]&&void 0!==this.m_uniformPatameters[e]||(this.m_uniformPatameters[e]=t,r=!0),r},e.prototype.GetUniformParameter=function(e){return null!==this.m_uniformPatameters[e]||void 0!==this.m_uniformPatameters[e]?this.m_uniformPatameters[e]:null},e.prototype.GetUnifomParameters=function(){return this.m_uniformPatameters},e.prototype.GetNeedsUpdateUniformParamerers=function(){return this.needsUpdateUniformParameters},e.prototype.SetNeedsUpdateUniformParamerers=function(e){this.needsUpdateUniformParameters=e},e.prototype.GetUseLight=function(){return this.m_useLight},e.prototype.SetUseLight=function(e){this.m_useLight=e},e.prototype.NeedUpdate=function(){return this.m_needUpdate},e.prototype.SetNeedUpdate=function(e){this.m_needUpdate=e},e.prototype.GetProgram=function(){return this.m_program},e.prototype.SetProgram=function(e){this.m_program=e},e.prototype.Uuid=function(){return this.m_uuid},e.prototype.SetUuid=function(e){this.m_uuid=e},e.prototype.Define=function(){return this.m_define},e.prototype.SetDefine=function(e,t){this.m_define[e]=t},e.prototype.LightHash=function(){return this.m_lightHash},e.prototype.SetDisplayName=function(e){this.m_displayName=e},e.prototype.GetDisplayName=function(){return this.m_displayName},e.prototype.SetLightHash=function(e){this.m_lightHash=e},e.prototype.GetLightHash=function(){return this.m_lightHash},e.prototype.Rename=function(e){},e.prototype.IsGammaOutpute=function(){return this.m_isGammaOutpute},e.prototype.SetIsGammaOutpute=function(e){this.m_isGammaOutpute=e},e.prototype.SetAcceptLight=function(e){this.m_acceptLight=e},e.prototype.AcceptLight=function(){return this.m_acceptLight},e.prototype.Compare=function(e){return!!e&&this.GetMaterialType()===e.GetMaterialType()},e.prototype.Clone=function(){return new e(this)},e}(u.Resource);u.BaseMaterial=r}(M3D||(M3D={})),function(u){var e=function(){function e(){this.worldMatrix=new u.Matrix3x4,this.glWorldMatrix=new u.Matrix4,this.center=new u.Vector3,this.AllowRotate(!1),this.AllowTran(!0),this.AllowScale(!1)}return e.prototype.GetWorldMatrix=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(0===e.length)return this.worldMatrix;if(1===e.length&&e[0]instanceof u.RenderAction){if(this.worldMatrix=u.Matrix3x4.IDENTITY().Clone(),this.GetScale()&&this.GetRotate()&&this.IsAllowTran())return this.worldMatrix;var r=e[0].GetWorldMatrix(),i=e[0].GetCamera(),n=i.GetView().Multiply(r).Inverse();if(this.worldMatrix.MultiTranslate(this.center),!this.GetScale()){var o=1;if(i.IsOrthographic())this.worldMatrix.MultiScale(o/i.GetZoom());else{var a=i.GetWorldPosition().Clone(),s=i.GetOrthoSize().y;o=1.2*a.Sub(this.GetCenter()).Length()/s;var l=1;l=i.GetViewPort().GetRect().Height(),(l=i.GetViewPort().GetRect().Width())&&(l=i.GetViewPort().GetRect().Width()),l=i.GetViewPort().GetRect().Height()>i.GetViewPort().GetRect().Width()?i.GetViewPort().GetRect().Width()/l:i.GetViewPort().GetRect().Height()/l,this.worldMatrix.MultiScale(o*l/i.GetZoom())}}if(!this.GetRotate()){var h=n.Rotation().Clone();this.worldMatrix.MultiRotatiton(h)}return this.IsAllowTran()||this.worldMatrix.MultiTranslate(n.Translation().Nagative()),this.worldMatrix.MultiTranslate(this.center.Nagative()),this.worldMatrix}},e.prototype.GetGLWorldMatrix=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return 0===e.length?this.glWorldMatrix:1===e.length&&e[0]instanceof u.RenderAction?(this.glWorldMatrix=this.GetWorldMatrix(e[0]).ToMatrix4().Transpose(),this.glWorldMatrix):void 0},e.prototype.AllowTran=function(e){this.allowTran=e},e.prototype.AllowRotate=function(e){this.allowRotate=e},e.prototype.AllowScale=function(e){this.allowScale=e},e.prototype.IsAllowTran=function(){return this.allowTran},e.prototype.GetRotate=function(){return this.allowRotate},e.prototype.GetScale=function(){return this.allowScale},e.prototype.SetCenter=function(e){this.center=e.Clone()},e.prototype.GetCenter=function(){return this.center},e.GetFitShowScale=function(e,t){var r=1,i=e.GetCamera();if(!i.IsOrthographic()){var n=i.GetWorldPosition(),o=i.GetOrthoSize().y;r=2*n.Sub(t).Length()/o}var a=1;(a=i.GetViewPort().GetRect().Height())<i.GetViewPort().GetRect().Width()&&(a=i.GetViewPort().GetRect().Width());var s=i.GetViewPort().GetRect().Height(),l=i.GetViewPort().GetRect().Width();return r*(a=l<s?l/a:s/a)/i.GetZoom()},e}();u.Billboard=e}(M3D||(M3D={})),function(a){var e=function(n){function e(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=this;if(1===e.length){var i=e[0];(r=n.call(this,i)||this).m_updateUvTransform=i.m_updateUvTransform,r.m_uvTransform=i.m_uvTransform,r.m_uvScale=i.m_uvScale,r.m_uvTranslate=i.m_uvTranslate,r.m_uvRotate=i.m_uvRotate,r.m_materialType=i.m_materialType,r.m_acceptLight=i.m_acceptLight}else(r=n.call(this)||this).m_updateUvTransform=!0,r.m_uvScale=new a.Vector2(1,1),r.m_uvTranslate=new a.Vector2(0,0),r.m_uvRotate=0,r.m_materialType=a.MaterialType.MaterialType_Inner,r.m_acceptLight=!0;return r}return __extends(e,n),e.prototype.UpdateUvTransform=function(){var e=Math.cos(this.m_uvRotate),t=Math.sin(this.m_uvRotate),r=this.m_uvScale.x,i=this.m_uvScale.y,n=this.m_uvTranslate.x,o=this.m_uvTranslate.y;this.m_uvTransform=new a.Matrix3(r*e,r*t,n,-i*t,i*e,o,0,0,1),this.m_updateUvTransform=!1},e.prototype.SetUvTranslate=function(e){this.m_uvTranslate=e,this.m_updateUvTransform=!0},e.prototype.SetUvScale=function(e){this.m_uvScale=e,this.m_updateUvTransform=!0},e.prototype.SetUvRotate=function(e){this.m_uvRotate=e,this.m_updateUvTransform=!0},e.prototype.GetUvTransform=function(){return this.m_updateUvTransform&&this.UpdateUvTransform(),this.m_uvTransform},e.prototype.GetUvTranslate=function(){return this.m_uvTranslate},e.prototype.GetUvScale=function(){return this.m_uvScale},e.prototype.GetUvRotate=function(){return this.m_uvRotate},e.prototype.Clone=function(){return new e(this)},e.prototype.Compare=function(e){return n.prototype.Compare.call(this,e)},e}(a.BaseMaterial);a.InnerMaterial=e}(M3D||(M3D={})),function(n){var e=function(i){function e(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=this;return 1===e.length?r=i.call(this,e[0])||this:((r=i.call(this)||this).m_materialType=n.MaterialType.MaterialType_Depth,r.m_useLight=!1),r}return __extends(e,i),e.prototype.GetUseLight=function(){return this.m_useLight},e.prototype.SetUseLight=function(e){this.m_useLight=e},e.prototype.Clone=function(){return new e(this)},e}(n.InnerMaterial);n.DepthMaterial=e}(M3D||(M3D={})),function(f){var e=function(S){function e(){var e=S.call(this)||this;return e.m_squarePoints=[],e.m_spotExponent=20,e.m_spotCutoff=180,e.m_spotCosCutoff=.5,e.m_constantAttenuation=1,e.m_linearAttenuation=0,e.m_quadraticAttenuation=0,e.m_specularIntensity=1,e.m_diffuse=f.Color.WHITE().Clone(),e.m_intensity=1,e.m_ShowAllSign=!0,e.m_showSimpleSign=!0,e.SetLightSourceType(f.LightType.LightType_Directional),e.m_lightShadow=new f.DirectionalLightShadow,e.m_castShadow=!0,e}return __extends(e,S),e.prototype.GetLightShadow=function(){return this.m_lightShadow},e.prototype.GetType=function(){return f.ShapeType.SHAPE_LIGHT_DIRECTIONAL},e.prototype.FindVisiableObject=function(e){if(this.m_needUpdataSign){var t=this.GetWorldTransform();this.m_glworldMatrix=t.Transpose();var r=f.Vector3.ZERO();if(this.m_showSimpleSign&&!this.m_simpleSignModel){this.m_simpleSignModel=new f.ImageModel;var i=f.Parameters.Instance().appWorkPath+"\\data\\pic\\directional.png";this.m_simpleSignModel.SetImagePath(i),this.m_simpleSignModel.SetImageSize(r,new f.Vector2(.5,.5)),this.AddSubModel(this.m_simpleSignModel)}if(this.m_ShowAllSign){this.m_allSignModel||(this.m_allSignModel=new f.Model,this.AddSubModel(this.m_allSignModel)),this.m_allSignModel.ClearLineData();var n=[],o=r.Clone(),a=this.m_direction.Clone();a.Normalize();var s=e.GetScene().GetSceneBox().Length();n.push(o.Sub(a.Multiply(.5*s))),n.push(o),this.m_allSignModel.AddLineData(n);var l=[],h=.02*s,u=new f.Vector3(-h,h,0),p=new f.Vector3(-h,-h,0),c=new f.Vector3(h,-h,0),d=new f.Vector3(h,h,0);l.push(u),l.push(p),l.push(c),l.push(d),l.push(u),this.m_allSignModel.AddLineData(l)}this.m_needUpdataSign=!1}this.SetRenderWorldMatrix(this.m_glworldMatrix),S.prototype.FindVisiableObject.call(this,e)},e.prototype.InitProperties=function(){},e.prototype.SetLightType=function(e){this.SetType(e)},e.prototype.SetPerVertex=function(e){this.m_perVertex=e},e.prototype.SetSpecularIntensity=function(e){this.m_intensity=f.Max(e,0)},e.prototype.SetBrightness=function(e){this.m_brightness=e},e.prototype.SetRange=function(e){this.m_range=f.Max(e,0)},e.prototype.SetFov=function(e){this.m_fov=f.Clamp(e,0,f.MAX_FOV)},e.prototype.SetAspectRatio=function(e){this.m_aspectRatio=f.Max(e,f.EPSILON)},e.prototype.GetLinearAttenuation=function(){return this.m_linearAttenuation},e.prototype.SetLinearAttenuation=function(e){this.m_linearAttenuation=e},e.prototype.GetAmbient=function(){return this.m_ambient},e.prototype.SetAmbient=function(e){this.m_ambient=e},e.prototype.GetConstantAttenuation=function(){return this.m_constantAttenuation},e.prototype.SetConstantAttenuation=function(e){this.m_constantAttenuation=e},e.prototype.GetDiffuse=function(){return this.m_diffuse},e.prototype.SetDiffuse=function(e){this.m_diffuse=e},e.prototype.GetLightModelAmbient=function(){return this.m_lightModelAmbient},e.prototype.SetLightModelAmbient=function(e){this.m_lightModelAmbient=e},e.prototype.GetQuadraticAttenuation=function(){return this.m_quadraticAttenuation},e.prototype.SetQuadraticAttenuation=function(e){this.m_quadraticAttenuation=e},e.prototype.GetSpecular=function(){return this.m_specular},e.prototype.SetSpecular=function(e){this.m_specular=e},e.prototype.GetSpotCosCutoff=function(){return this.m_spotCosCutoff},e.prototype.SetSpotCosCutoff=function(e){this.m_spotCosCutoff=e},e.prototype.GetSpotCutoff=function(){return this.m_spotCutoff},e.prototype.SetSpotCutoff=function(e){this.m_spotCutoff=e},e.prototype.GetSpotDirection=function(){return this.m_spotDirection},e.prototype.SetSpotDirection=function(e){this.m_spotDirection=e},e.prototype.GetSpotExponent=function(){return this.m_spotExponent},e.prototype.SetSpotExponent=function(e){this.m_spotExponent=e},e.prototype.GetPositionOld=function(){return this.m_position_old},e.prototype.SetPositionOld=function(e){this.m_position_old=e},e.prototype.GetLightType=function(){return this.m_lightType},e.prototype.GetPerVertex=function(){return this.m_perVertex},e.prototype.GetSpecularIntensity=function(){return this.m_intensity},e.prototype.GetBrightness=function(){return this.m_brightness},e.prototype.GetEffectiveColor=function(){return new f.Color(this.m_lightColor.Multiply(this.m_brightness),1)},e.prototype.GetEffectiveSpecularIntensity=function(){return this.m_specularIntensity*f.Abs(this.m_brightness)},e.prototype.GetRange=function(){return this.m_range},e.prototype.GetFov=function(){return this.m_fov},e.prototype.GetAspectRatio=function(){return this.m_aspectRatio},e}(f.BaseLight);f.DirectionalLight=e}(M3D||(M3D={})),function(e){var t=function(){function e(){this.m_camera=null,this.renderTarget=null}return e.prototype.Update=function(e,t,r){},e.prototype.SetMapSize=function(e){this.m_mapSize=e.Clone()},e.prototype.GetMapSize=function(){return this.m_mapSize},e.prototype.GetCamera=function(){return this.m_camera},e.prototype.SetBias=function(e){this.m_bias=e},e.prototype.Bias=function(){return this.m_bias},e.prototype.SetRadius=function(e){this.m_radius=e},e.prototype.Radius=function(){return this.m_radius},e.prototype.Matrix=function(){return this.m_matrix},e.prototype.SetRenderTarget=function(e){this.renderTarget=e},e.prototype.RenderTarget=function(){return this.renderTarget},e}();e.LightShadow=t}(M3D||(M3D={})),function(l){var e=function(t){function e(){var e=t.call(this)||this;return e.Init(),e}return __extends(e,t),e.prototype.SetCameraInfo=function(e,t,r){this.orthoSize=e,this.cameraNear=t,this.cameraFar=r,this.needUpdata=!0},e.prototype.Update=function(e,t,r){this.UpdateCamera(e,t),this.UpdateMatrix()},e.prototype.UpdateCamera=function(e,t){var r=e.GetNodeWorldPosition(),i=e.GetWorldDirection().Nagative();i.Normalize();var n=new l.Vector3,o=t.GetSceneManager().GetSceneBox(),a=o.Center(),s=o.Length();e.IsInWorld()?n=r.Add(i):(i=t.GetView().Inverse().Multiply(new l.Vector4(i,0)),n=a.Clone(),r=i.Nagative().Multiply(s).Multiply(.5).Add(a));this.m_camera.SetWorldPosition(r),this.m_camera.LookAt(n,new l.Vector3(0,1,0),l.SceneNode.TS_WORLD),this.needUpdata&&(this.m_camera.SetOrthoSize(new l.Vector2(this.orthoSize,this.orthoSize)),this.m_camera.SetNearClip(this.cameraNear),this.m_camera.SetFarClip(this.cameraFar),this.needUpdata=!1)},e.prototype.UpdateMatrix=function(){this.m_matrix=new l.Matrix4(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),this.m_matrix=this.m_matrix.Multiply(this.m_camera.GetProjection()),this.m_matrix=this.m_matrix.Multiply(this.m_camera.GetView().ToMatrix4())},e.prototype.Init=function(){this.orthoSize=64,this.cameraNear=.1,this.cameraFar=1e4,this.m_mapSize=new l.Vector2(2048,2048),this.m_camera=new l.Camera,this.m_camera.SetOrthographic(!0),this.m_camera.SetOrthoSize(new l.Vector2(this.orthoSize,this.orthoSize)),this.m_camera.SetNearClip(this.cameraNear),this.m_camera.SetFarClip(this.cameraFar),this.needUpdata=!1,this.m_bias=0,this.m_radius=4},e}(l.LightShadow);l.DirectionalLightShadow=e}(M3D||(M3D={})),function(r){var e,t,i,n,o=function(){this.filterMin=r.GL.LINEAR,this.filterMag=r.GL.LINEAR,this.wrapS=r.GL.REPEAT,this.wrapT=r.GL.REPEAT,this.isUseMinMap=!1,this.width=512,this.height=512,this.format=r.GL.RGBA,this.internalrFromat=r.GL.RGBA,this.imagePath=""};r.TextureParameter=o,(e=r.TEXTURE_LOAD||(r.TEXTURE_LOAD={}))[e.TEXTURE_LOAD_AUTO=0]="TEXTURE_LOAD_AUTO",e[e.TEXTURE_LOAD_L=1]="TEXTURE_LOAD_L",e[e.TEXTURE_LOAD_LA=2]="TEXTURE_LOAD_LA",e[e.TEXTURE_LOAD_RGB=3]="TEXTURE_LOAD_RGB",e[e.TEXTURE_LOAD_RGBA=4]="TEXTURE_LOAD_RGBA",(i=t=r.TextureEncodingType||(r.TextureEncodingType={}))[i.TEXEL_ENCODING_TYPE_LINEAR=0]="TEXEL_ENCODING_TYPE_LINEAR",i[i.TEXEL_ENCODING_TYPE_SRGB=1]="TEXEL_ENCODING_TYPE_SRGB",i[i.TEXEL_ENCODING_TYPE_RGBE=2]="TEXEL_ENCODING_TYPE_RGBE",i[i.TEXEL_ENCODING_TYPE_RGBM7=3]="TEXEL_ENCODING_TYPE_RGBM7",i[i.TEXEL_ENCODING_TYPE_RGBM16=4]="TEXEL_ENCODING_TYPE_RGBM16",i[i.TEXEL_ENCODING_TYPE_RGBD=5]="TEXEL_ENCODING_TYPE_RGBD",i[i.TEXEL_ENCODING_TYPE_GAMMA=6]="TEXEL_ENCODING_TYPE_GAMMA",(n=r.TEXTURE_FLAG||(r.TEXTURE_FLAG={}))[n.TEXTURE_FLAG_POWER_OF_TWO=1]="TEXTURE_FLAG_POWER_OF_TWO",n[n.TEXTURE_FLAG_MIPMAPS=2]="TEXTURE_FLAG_MIPMAPS",n[n.TEXTURE_FLAG_TEXTURE_REPEATS=4]="TEXTURE_FLAG_TEXTURE_REPEATS",n[n.TEXTURE_FLAG_MULTIPLY_ALPHA=8]="TEXTURE_FLAG_MULTIPLY_ALPHA",n[n.TEXTURE_FLAG_INVERT_Y=16]="TEXTURE_FLAG_INVERT_Y",n[n.TEXTURE_FLAG_COMPRESS_TO_DXT=32]="TEXTURE_FLAG_COMPRESS_TO_DXT",n[n.TEXTURE_FLAG_DDS_LOAD_DIRECT=64]="TEXTURE_FLAG_DDS_LOAD_DIRECT",n[n.TEXTURE_FLAG_NTSC_SAFE_RGB=128]="TEXTURE_FLAG_NTSC_SAFE_RGB",n[n.TEXTURE_FLAG_CoCg_Y=256]="TEXTURE_FLAG_CoCg_Y",n[n.TEXTURE_FLAG_TEXTURE_RECTANGLE=512]="TEXTURE_FLAG_TEXTURE_RECTANGLE";var a=function(){function e(e){this.gl=null,this.texObj=null,this.textureParameter=new o,this.isTextureDirty=!0,this.m_textures=[],this.resourceManager=null,this.name="",this.isNeedInit=!0,this.imageArray=[],this.isLoaded=!1,this.m_textureEncoding=t.TEXEL_ENCODING_TYPE_LINEAR,this.m_gammaInput=!1,this._textureRepeat=!1,this._isUseMipmap=!0,this.currentTarget=0,this.lastUnit=0,e&&(this.textureParameter=e)}return e.prototype.SetTextureParameter=function(e){e&&(this.textureParameter=e),this.MakeDirty()},e.prototype.SetResourceManager=function(e){this.resourceManager=e},e.prototype.UpdateOGLObj=function(){},e.prototype.Init=function(){this.MakeDirty(),this.name="",this.m_isMipMap=!1,this.m_minFliter=r.GL.LINEAR,this.m_magFliter=r.GL.LINEAR,this.m_wrapS=r.GL.REPEAT,this.m_wrapT=r.GL.REPEAT,this.m_textureEncoding=t.TEXEL_ENCODING_TYPE_LINEAR,this.m_gammaInput=!1},e.prototype.AddImage=function(e){if(0<this.imageArray.length)if(this instanceof r.Texture2D)this.GetImageArray[0]=e;else for(var t=0;t<this.imageArray.length;t++)this.imageArray[t].GetImagePath()!==e.GetImagePath()&&this.imageArray.push(e);else 0===this.imageArray.length&&this.imageArray.push(e)},e.prototype.GetImageArray=function(){return this.imageArray},e.prototype.SetImageParameter=function(e,t){this.m_forceChannels=e,this.m_flags=t},e.prototype.SetImagePathes=function(e){if(this.imageArray.length<=e.length)for(var t=0;t<this.imageArray.length;t++)this.imageArray[t].SetImagePath(e[t])},e.prototype.GetImagePathes=function(){var e=[];if(0<this.imageArray.length){for(var t=0;t<this.imageArray.length;t++)e.push(this.imageArray[t].GetImagePath());return e}},e.prototype.MakeDirty=function(){this.isTextureDirty=!0},e.prototype.GetOGLObj=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(0===e.length)return this.isTextureDirty&&(this.UpdateOGLObj(),this.isTextureDirty=!1),this.m_textures[0];var r=e[0];return this.isNeedInit&&(this.gl=r,this.Init(),this.isNeedInit=!1),this.isTextureDirty&&(this.UpdateOGLObj(),this.isTextureDirty=!1),this.isLoaded?this.texObj:null},e.prototype.SetName=function(e){this.name=e},e.prototype.GetName=function(){return this.name},e.prototype.ClearResource=function(){this.gl.deleteTexture(this.texObj),this.texObj=null,this.isNeedInit=!0,this.isTextureDirty=!0,this.isLoaded=!1},e.prototype.bind=function(){},e.prototype.SetTextureUnit=function(e){this.currentTarget!=e&&(this.lastUnit=this.currentTarget,this.currentTarget=e)},e.prototype.Equals=function(e){return!!e&&(this.GetImagePathes()===[]&&e.GetImagePathes()===[]&&this.GetImageArray()===[]&&e.GetImageArray()===[]||this.GetImagePathes()===e.GetImagePathes()&&this.GetImageArray()===e.GetImageArray())},e.prototype.unbind=function(){},e.prototype.MarkDirty=function(){this.isTextureDirty=!0},Object.defineProperty(e.prototype,"IsUseMipMap",{get:function(){return this._isUseMipmap},set:function(e){this._isUseMipmap=e},enumerable:!0,configurable:!0}),e.prototype.TextureEncoding=function(){return this.m_textureEncoding},e.prototype.SetTextureEncoding=function(e){this.m_textureEncoding=e},e.prototype.MinFliter=function(){return this.m_minFliter},e.prototype.SetMinFliter=function(e){this.m_minFliter=e},e.prototype.MagFliter=function(){return this.m_magFliter},e.prototype.SetMagFliter=function(e){this.m_magFliter=e},e.prototype.WrapS=function(){return this.m_wrapS},e.prototype.SetWrapS=function(e){this.m_wrapS=e},e.prototype.WrapT=function(){return this.m_wrapT},e.prototype.SetWrapT=function(e){this.m_wrapT=e},e.prototype.MipMap=function(){return this.m_isMipMap},e.prototype.SetMipMap=function(e){this.m_isMipMap=e},e.prototype.IsGammaInput=function(){return this.m_gammaInput},e.prototype.SetIsGammaInput=function(e){this.m_gammaInput=e},Object.defineProperty(e.prototype,"textureRepeat",{get:function(){return this._textureRepeat},set:function(e){this._textureRepeat=e},enumerable:!0,configurable:!0}),e.TEXTURE_BASE=0,e.TEXTURE_2D=1,e.TEXTURE_3D=2,e.TEXTURE_CUBE=3,e.TEXTURE_GEO=4,e}();r.Texture=a}(M3D||(M3D={})),function(i){var e=function(t){function e(){var e=t.call(this)||this;return e.Init(),e}return __extends(e,t),e.prototype.GetType=function(){return e.TEXTURE_GEO},e.prototype.UpdataOGLObj=function(){var e=this.resourceManager,t=this.GetName(),r=this.m_textures[0];0==r&&(this.gl.bindTexture(i.GL.TEXTURE_2D,r),this.gl.texParameteri(i.GL.TEXTURE_2D,i.GL.TEXTURE_MIN_FILTER,i.GL.LINEAR),this.gl.texParameteri(i.GL.TEXTURE_2D,i.GL.TEXTURE_MAG_FILTER,i.GL.LINEAR),this.gl.texParameteri(i.GL.TEXTURE_2D,i.GL.TEXTURE_WRAP_S,i.GL.CLAMP_TO_EDGE),this.gl.texParameteri(i.GL.TEXTURE_2D,i.GL.TEXTURE_WRAP_T,i.GL.CLAMP_TO_EDGE),this.gl.bindTexture(i.GL.TEXTURE_2D,0),0!=r&&e.AddOGLTexture(t,r)),this.m_textures[0]=r},e.prototype.Init=function(){this.m_targetType=i.RenderTargetType.TEXTURE_TARGET,this.m_textures[0]=0,this.SetImageParameter(i.TEXTURE_LOAD.TEXTURE_LOAD_RGBA,i.TEXTURE_FLAG.TEXTURE_FLAG_MIPMAPS),this.MarkDirty()},e.prototype.GenerateMipMap=function(){this.m_isMipMap&&this.gl.generateMipmap(i.GL.TEXTURE_2D)},e.LoadOGLTexture=function(e,t,r,i,n){},e}(i.Texture);i.GeometryBuffer=e}(M3D||(M3D={})),function(e){var t=function(r){function e(e){var t=r.call(this)||this;return t.gl=null,t.gl=e,t}return __extends(e,r),e.prototype.GetObject=function(){return this.object},e.prototype.GetGLRenderContext=function(){return this.gl},e.DISK_CACHE=2,e.GPU_CACHE=1,e.NO_CACHE=0,e}(e.Resource);e.GPUObject=t}(M3D||(M3D={})),function(a){var e=function(r){function i(e){var t=r.call(this,e)||this;return t.width=512,t.height=512,t.m_maxColorAttachNum=4,t.m_colorAttachments=new Array(4),t.dirty=!0,t._usedColorAttachment=0,t.framebufferObj=null,t.originalFBO=null,t.colorTargets={},t.depthTarget=null,t.colorAttachmentNumber=1,t.m_colorUseRenderBuffer=!1,t.colorUseRenderBuffer=!1,t.m_depthUseRenderBuffer=!1,t.m_multisamplerNumber=4,t.m_useMultisample=!1,t.m_colorInternalFormat=a.GL.RGBA,t.m_depthInternalFormat=a.GL.DEPTH_COMPONENT,t.m_outColorTexture=null,t.m_outColorTextureLevel=-1,t.m_colorTextureMipmap=!1,t.useDepthBuffer=!0,t.useStencilBuffer=!0,i.id++,t}return __extends(i,r),i.prototype.markDirty=function(){this.dirty=!0},i.prototype.SetSize=function(e,t){this.width==e&&this.height==t||(this.width=e,this.height=t,this.markDirty())},i.prototype.allocColorAttachment=function(){var e=this._usedColorAttachment;return this._usedColorAttachment+=1,e},i.prototype.keepOriginalFBO=function(){this.originalFBO=this.gl.getParameter(a.GL.FRAMEBUFFER_BINDING)},i.prototype.restoreOriginalFBO=function(){this.gl.bindFramebuffer(a.GL.FRAMEBUFFER,this.originalFBO)},i.prototype.create=function(){this.keepOriginalFBO(),this.framebufferObj=this.gl.createFramebuffer()},i.prototype.destroy=function(){if(this.depthTarget){var e=this.depthTarget.getRBO();this.gl.deleteRenderbuffer(e),this.depthTarget=null}for(var t in this.colorTargets){var r=this.colorTargets[t];if(r instanceof a.TextureTarget){e=r.GetOGLObj(this.gl);this.gl.deleteTexture(e),this.resourceManager.RemoveTexture(r.GetName())}else if(r instanceof a.HardWareRenderBuffer){e=r.getRBO();this.gl.deleteRenderbuffer(e)}delete this.colorTargets[t]}this.framebufferObj&&(this.gl.deleteFramebuffer(this.framebufferObj),this.framebufferObj=null)},i.prototype.bind=function(){this.framebufferObj&&this.gl.bindFramebuffer(a.GL.FRAMEBUFFER,this.framebufferObj)},i.prototype.unbind=function(){this.framebufferObj&&this.gl.bindFramebuffer(a.GL.FRAMEBUFFER,null),this.restoreOriginalFBO()},i.prototype.setSize=function(e,t){this.width=e,this.height=t,this.markDirty()},i.prototype.reShape=function(){this.dirty&&(this.destroy(),this._usedColorAttachment=0,this.generateNormalFramerBuffer())},i.prototype.generateNormalFramerBuffer=function(){this.create(),this.generateColorAttatchment(),this.generateDepthAttatchment(),this.dirty=!1},i.prototype.generateMultisampleFramerBuffer=function(e,t,r){},i.prototype.setCreationParameters=function(e,t,r){void 0===e&&(e=1),void 0===t&&(t=!0),void 0===r&&(r=!0),this.colorAttachmentNumber=e,this.useDepthBuffer=t,this.useStencilBuffer=r},i.prototype.generateColorAttatchment=function(){for(var e=0;e<this.colorAttachmentNumber;e++)this.colorUseRenderBuffer?this.attachRenderBufferToColor():this.attachTextureToColor()},i.prototype.generateDepthAttatchment=function(){this.useDepthBuffer&&!this.useStencilBuffer&&this.attachRenderBufferToDepth(!1)},i.prototype.attachTextureToColor=function(){this.gl.bindFramebuffer(a.GL.FRAMEBUFFER,this.framebufferObj);var e=this.allocColorAttachment(),t=a.IDCreator.GetUUID()+"_colorAttachment",r=this.resourceManager.GetOrCreateTexture(t,a.Texture.TEXTURE_GEO);r.IsUseMipMap=!1,r.setSize(this.width,this.height);var i=r.GetOGLObj(this.gl);r.bind(),this.gl.framebufferTexture2D(a.GL.FRAMEBUFFER,a.GL.COLOR_ATTACHMENT0+e,a.GL.TEXTURE_2D,i,0),r.unbind(),this.gl.bindFramebuffer(a.GL.FRAMEBUFFER,null),this.colorTargets[e]=r},i.prototype.attachRenderBufferToColor=function(){this.gl.bindFramebuffer(a.GL.FRAMEBUFFER,this.framebufferObj);var e=this.allocColorAttachment(),t=new a.HardWareRenderBuffer(this.gl);t.generateRenderBuffer(this.width,this.height);var r=t.getRBO();t.bind(),this.gl.framebufferRenderbuffer(a.GL.FRAMEBUFFER,a.GL.COLOR_ATTACHMENT0+e,a.GL.RENDERBUFFER,r),this.gl.bindFramebuffer(a.GL.FRAMEBUFFER,null),this.colorTargets[e]=t},i.prototype.attachRenderBufferToDepth=function(e){void 0===e&&(e=!1);var t=new a.HardWareRenderBuffer(this.gl);if(this.gl.bindFramebuffer(a.GL.FRAMEBUFFER,this.framebufferObj),e){t.generateRenderBuffer(this.width,this.height,a.GL.DEPTH_STENCIL);r=t.getRBO();t.bind(),this.gl.framebufferRenderbuffer(a.GL.FRAMEBUFFER,a.GL.DEPTH_STENCIL_ATTACHMENT,a.GL.RENDERBUFFER,r)}else{t.generateRenderBuffer(this.width,this.height,a.GL.DEPTH_COMPONENT16);var r=t.getRBO();t.bind(),this.gl.framebufferRenderbuffer(a.GL.FRAMEBUFFER,a.GL.DEPTH_ATTACHMENT,a.GL.RENDERBUFFER,r)}this.depthTarget=t,this.gl.bindFramebuffer(a.GL.FRAMEBUFFER,null)},i.prototype.getColorTarget=function(e){return this.colorTargets[e]},i.prototype.checkStatus=function(){this.gl.bindFramebuffer(a.GL.FRAMEBUFFER,this.framebufferObj);var e=this.gl.checkFramebufferStatus(a.GL.FRAMEBUFFER);e!==a.GL.FRAMEBUFFER_COMPLETE&&(e===a.GL.FRAMEBUFFER_INCOMPLETE_ATTACHMENT?console.error("Framer buffer not complete! code is FRAMEBUFFER_INCOMPLETE_ATTACHMENT"):e===a.GL.FRAMEBUFFER_INCOMPLETE_DIMENSIONS?console.error("Framer buffer not complete! code is FRAMEBUFFER_INCOMPLETE_DIMENSIONS"):e===a.GL.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT?console.error("Framer buffer not complete! code is FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT"):e===a.GL.FRAMEBUFFER_UNSUPPORTED&&console.error("Framer buffer not complete! code is FRAMEBUFFER_UNSUPPORTED")),this.gl.bindFramebuffer(a.GL.FRAMEBUFFER,null)},i.prototype.SetMaxColorAttachmentNumber=function(e){this.m_maxColorAttachNum=e},i.prototype.GetWidth=function(){return this.width},i.prototype.GetHeight=function(){return this.height},i.prototype.GetDepthTarget=function(){return this.depthTarget},i.prototype.GetColorTarget=function(e){return this.colorTargets[e]},i.prototype.ClearResource=function(){if(this.m_depthAttachment)if(this.m_depthAttachment.GetTargetType()==a.RenderTargetType.RBO_TARGET)this.m_depthAttachment;else if(this.m_depthAttachment.GetTargetType()==a.RenderTargetType.TEXTURE_TARGET){this.m_depthAttachment&&null}this.m_depthAttachment=null;for(var e=0;e<this.m_maxColorAttachNum;e++)this.m_colorAttachments[e]&&(this.m_colorAttachments[e].GetTargetType()==a.RenderTargetType.RBO_TARGET?this.m_colorAttachments[e]=null:this.m_colorAttachments[e].GetTargetType()==a.RenderTargetType.TEXTURE_TARGET&&(this.m_colorAttachments[e]=null)),this.m_colorAttachments[e]=null;this.destroy(),this.markDirty()},i.prototype.SetParameters=function(e,t,r,i,n,o,a){this.colorAttachmentNumber=e,this.useDepthBuffer=i,this.useStencilBuffer=n,this.m_useMultisample=o,this.m_multisamplerNumber=a,this.m_colorUseRenderBuffer=t,this.m_depthUseRenderBuffer=r},i.prototype.ReShape=function(){this.dirty&&(this.destroy(),this.framebufferObj&&(this.gl.deleteFramebuffer(this.framebufferObj),this.framebufferObj=0),this._usedColorAttachment=0,this.GenerateFramerBuffer())},i.prototype.GenerateFramerBuffer=function(){this.create(),this.GenerateColorAttatchment(),this.GenerateDepthAttatchment(),this.dirty=!1},i.prototype.GenerateColorAttatchment=function(){for(var e=0;e<this.colorAttachmentNumber;e++)this.m_colorUseRenderBuffer?this.attachRenderBufferToColor():this.attachTextureToColor()},i.prototype.GenerateDepthAttatchment=function(){this.m_useMultisample&&(this.m_depthUseRenderBuffer=!0),this.m_depthUseRenderBuffer},i.prototype.AttachRenderBufferToDepth=function(){this.gl.bindFramebuffer(a.GL.FRAMEBUFFER,this.framebufferObj);var e=new a.HardWareRenderBuffer(this.gl);e.generateRenderBuffer(this.GetWidth(),this.GetHeight()),e.setResourceManager(this.resourceManager),this.gl.framebufferRenderbuffer(a.GL.FRAMEBUFFER,a.GL.DEPTH_ATTACHMENT,a.GL.RENDERBUFFER,e.GetObject()),this.gl.framebufferRenderbuffer(a.GL.FRAMEBUFFER,a.GL.STENCIL_ATTACHMENT,a.GL.RENDERBUFFER,e.GetObject()),this.gl.bindFramebuffer(a.GL.FRAMEBUFFER,0),this.depthTarget=e},i.prototype.AttachTextureToDepth=function(e){var t,r;switch(this.m_depthInternalFormat){case a.GL.DEPTH_COMPONENT:t=a.GL.DEPTH_COMPONENT,r=a.GL.UNSIGNED_INT}this.gl.bindFramebuffer(a.GL.FRAMEBUFFER,this.framebufferObj);var i=a.IDCreator.GetUUID()+"_depthAttachment",n=this.resourceManager.GetOrCreateTexture(i,a.Texture.TEXTURE_GEO),o=n.GetOGLObj();o&&(this.gl.bindTexture(a.GL.TEXTURE_2D,o),this.gl.texParameteri(a.GL.TEXTURE_2D,a.GL.TEXTURE_MIN_FILTER,a.GL.NEAREST),this.gl.texParameteri(a.GL.TEXTURE_2D,a.GL.TEXTURE_MAG_FILTER,a.GL.NEAREST),this.gl.texParameteri(a.GL.TEXTURE_2D,a.GL.TEXTURE_WRAP_S,a.GL.CLAMP_TO_EDGE),this.gl.texParameteri(a.GL.TEXTURE_2D,a.GL.TEXTURE_WRAP_T,a.GL.CLAMP_TO_EDGE),this.gl.texImage2D(a.GL.TEXTURE_2D,0,this.m_depthInternalFormat,this.width,this.height,0,t,r,null),this.gl.framebufferTexture2D(a.GL.FRAMEBUFFER,a.GL.DEPTH_ATTACHMENT,a.GL.TEXTURE_2D,o,0),this.gl.bindTexture(a.GL.TEXTURE_2D,0)),this.gl.bindFramebuffer(a.GL.FRAMEBUFFER,0),this.depthTarget=n},i.id=0,i}(a.GPUObject);a.HardWareFrameBuffer=e}(M3D||(M3D={})),function(i){var e=function(r){function e(e){var t=r.call(this,e)||this;return t.width=512,t.height=512,t.innerForamt=i.GL.RGBA,t.renderBufferObj=null,t}return __extends(e,r),e.prototype.generateRenderBuffer=function(e,t,r){this.width=e,this.height=t,this.innerForamt=void 0===r?i.GL.RGBA:r,this.renderBufferObj=this.gl.createRenderbuffer(),this.gl.bindRenderbuffer(i.GL.RENDERBUFFER,this.renderBufferObj),this.gl.renderbufferStorage(i.GL.RENDERBUFFER,this.innerForamt,this.width,this.height),this.gl.bindRenderbuffer(i.GL.RENDERBUFFER,null)},e.prototype.Create=function(e,t){},e.prototype.getRBO=function(){return this.renderBufferObj},e.prototype.bind=function(){this.gl.bindRenderbuffer(i.GL.RENDERBUFFER,this.renderBufferObj)},e.prototype.unbind=function(){this.gl.bindRenderbuffer(i.GL.RENDERBUFFER,null)},e}(i.GPUObject);i.HardWareRenderBuffer=e}(M3D||(M3D={})),function(r){var e=function(t){function e(){var e=t.call(this)||this;return e.m_lightColor=new r.Color(1,1,1),e.m_groundColor=new r.Color(1,1,1),e.m_lightType=r.LightType.LightType_Hemisphere,e}return __extends(e,t),e.prototype.GroundColor=function(){return this.m_groundColor},e.prototype.SetGroundColor=function(e){this.m_groundColor=e},e}(r.BaseLight);r.HemisphereLight=e}(M3D||(M3D={})),function(e){var t,r;(r=t=e.ImageSource||(e.ImageSource={}))[r.FromURL=0]="FromURL",r[r.FromArray=1]="FromArray",r[r.FromeZip=2]="FromeZip";var i=function(){function e(){this.mode=t.FromURL,this.urlImage=new Image,this.imagePath=""}return e.prototype.GetSourceMode=function(){return this.mode},e.prototype.SetSourceMode=function(e){this.mode=e},e.prototype.GetImage=function(){return this.urlImage},e.prototype.SetImageFromURL=function(e){this.urlImage=e},e.prototype.GetImagePath=function(){return this.imagePath},e.prototype.SetImagePath=function(e){this.imagePath=e},e.prototype.GetId=function(){return this.id},e.prototype.SetId=function(e){this.id=e},e}();e.ImageM3D=i}(M3D||(M3D={})),function(s){var e=function(i){function e(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=i.call(this)||this;return r.position_=new s.Vector3,r.size_=new s.Vector2,r.origSize=new s.Vector2,r.localPos=new s.Vector2,r.bLocalPos=!1,r.uv_=new s.Rect,r.points=[],r.textCoords=[],r.bindBillboard=new s.Billboard,r.texture=null,r.m_bAllowClip=!0,r.hardwareVertexBuffer=null,r.gl=null,r.isNeedUpdateEdge=!0,r.vertexOffset=0,r.texCoodrsOffset=0,r.renderWorldMatrix=null,r.m_fixShowInScreen=!1,0===e.length?(r.uv_=new s.Rect(new s.Vector2(0,0),new s.Vector2(1,1)),r.texture=null,r.points=[],r.textCoords=[],r.bindBillboard.AllowRotate(!1),r.bindBillboard.AllowTran(!0),r.bindBillboard.AllowScale(!1)):2===e.length&&e[0]instanceof s.Vector3&&e[1]instanceof s.Vector2&&(r.uv_=new s.Rect(new s.Vector2(0,0),new s.Vector2(1,1)),r.texture=null,r.origSize=e[1],r.points=[],r.textCoords=[],r.bindBillboard.AllowRotate(!1),r.bindBillboard.AllowTran(!0),r.bindBillboard.AllowScale(!1),r.Set(e[0],e[1])),r}return __extends(e,i),e.prototype.SetCurrentGLContext=function(e){this.gl=e},e.prototype.SetRenderWorldMatrix=function(e){this.renderWorldMatrix=e.Clone()},e.prototype.GetRenderWorldMatrix=function(){return this.renderWorldMatrix},e.prototype.GetRenderColor=function(){var e=s.Color.WHITE().Clone();return this.IsSelected()?s.Color.SelectColor().Clone():e},e.prototype.GetRenderMaterial=function(){return new s.Material},e.prototype.SetRenderMesh=function(e){},e.prototype.GetDataLength=function(){return-1},e.prototype.IsUseIndex=function(){return!1},e.prototype.SetIndexOffset=function(e){},e.prototype.GetIndexOffset=function(){return-1},e.prototype.SetNormalOffset=function(e){},e.prototype.GetNormalOffset=function(){return-1},e.prototype.SetVertexOffset=function(e){this.vertexOffset=e},e.prototype.GetVertexOffset=function(){return this.vertexOffset},e.prototype.SetTextureCoordsOffset=function(e){this.texCoodrsOffset=e},e.prototype.GetTextureCoordsOffset=function(){return this.texCoodrsOffset},e.prototype.SetCentersCoordsOffset=function(e){},e.prototype.GetCentersCoordsOffset=function(){return-1},e.prototype.GetHardWareVertexBuffer=function(){if(null===this.gl)return null;if(null===this.hardwareVertexBuffer&&(this.hardwareVertexBuffer=new s.HardWareVertexBuffer(this.gl)),this.isNeedUpdateEdge){var e=s.ArrayHelper.ConvertToFloat32Array(this.GetVertexs()).length,t=s.ArrayHelper.ConvertToFloat32ArrayV2(this.GetTextureCoords()).length;this.hardwareVertexBuffer.Create(0,e+t);var r=s.ArrayHelper.ConvertToFloat32Array(this.GetVertexs());this.hardwareVertexBuffer.SetDataRange(r,0);var i=s.ArrayHelper.ConvertToFloat32ArrayV2(this.GetTextureCoords());this.hardwareVertexBuffer.SetDataRange(i,e),this.SetVertexOffset(0),this.SetTextureCoordsOffset(4*e),this.hardwareVertexBuffer.WriteBuffer(),this.isNeedUpdateEdge=!1}return this.hardwareVertexBuffer},e.prototype.GetHardWareIndexBuffer=function(){return null},e.prototype.SetOrigSize=function(e,t){this.uv_=new s.Rect(new s.Vector2(0,0),new s.Vector2(1,1)),this.points=[],this.textCoords=[],this.origSize=t,this.Set(e,t)},e.prototype.Set=function(e,t){this.bindBillboard.SetCenter(e),this.position_=e.Clone(),this.size_=t.Clone(),this.points=[],this.textCoords=[],this.isNeedUpdateEdge=!0},e.prototype.SetPlan=function(e){},e.prototype.GetVertexs=function(){if(0===this.points.length){var e=this.size_.x/2,t=this.size_.y/2;this.points.push(new s.Vector3(this.position_.x-e,this.position_.y-t,this.position_.z)),this.points.push(new s.Vector3(this.position_.x+e,this.position_.y-t,this.position_.z)),this.points.push(new s.Vector3(this.position_.x-e,this.position_.y+t,this.position_.z)),this.points.push(new s.Vector3(this.position_.x-e,this.position_.y+t,this.position_.z)),this.points.push(new s.Vector3(this.position_.x+e,this.position_.y-t,this.position_.z)),this.points.push(new s.Vector3(this.position_.x+e,this.position_.y+t,this.position_.z))}return this.points},e.prototype.GetTextureCoords=function(){if(0===this.textCoords.length){var e=this.uv_.min.Clone(),t=this.uv_.max.Clone();this.textCoords.push(new s.Vector2(e.x,t.y)),this.textCoords.push(new s.Vector2(t.x,t.y)),this.textCoords.push(new s.Vector2(e.x,e.y)),this.textCoords.push(new s.Vector2(e.x,e.y)),this.textCoords.push(new s.Vector2(t.x,t.y)),this.textCoords.push(new s.Vector2(t.x,e.y))}return this.textCoords},e.prototype.ComputeBox=function(){this.BoundingBox.Clear(),0<this.points.length&&(this.BoundingBox.Merge(this.points[0]),this.BoundingBox.Merge(this.points[this.points.length-1]))},e.prototype.RayPick=function(e){var t=this.GetIntersects(e);if(0<t.length){for(var r=0;r<t.length;r++)e.AddIntersectPnt(t[r]);e.AddShape(this)}},e.prototype.GetIntersects=function(e){var t=[],r=e.GetData().GetModelRay().Clone(),i=this.bindBillboard.GetWorldMatrix().Inverse();r=r.Transformed(i);for(var n=this.points,o=new s.Vector3,a=0;a<this.points.length/3;a++)s.RayPickAction.ISintersectRayAndTriangle(n[3*a],n[3*a+1],n[3*a+2],r,o)&&(o=this.bindBillboard.GetWorldMatrix().Multiply(o),t.push(o));return t},e.prototype.UpdateRenderData=function(e){if(this.bLocalPos){var t=s.Matrix4.IDENTITY();this.SetRenderWorldMatrix(t);var r=this.origSize.Multiply(5),i=e.GetScene().GetHudCamera(),n=new s.Vector3(this.localPos.x,this.localPos.y,1);n=i.ScreenToWorldPoint(n),this.position_=n,this.Set(this.position_,r),this.GetVertexs()}else{if((e.GetSceneBoxChanged()||0===this.points.length)&&!this.m_fixShowInScreen){r=new s.Vector2;r=s.ShapeHelper.GetCommonSize(e.GetScene(),this.origSize),this.Set(this.GetPosition(),r),this.GetVertexs()}var o=this.bindBillboard.GetGLWorldMatrix(e);this.SetRenderWorldMatrix(o)}},e.prototype.SetTexture=function(e){this.texture&&(this.texture=null),this.texture=e},e.prototype.GetTexture=function(){return this.texture},e.prototype.SetPosition=function(e){return this.bindBillboard.SetCenter(e),this.position_=e.Clone(),this.points=[],this.isNeedUpdateEdge=!0},e.prototype.GetPosition=function(){return this.position_},e.prototype.AllowTran=function(e){return this.bindBillboard.AllowTran(e)},e.prototype.AllowRotate=function(e){return this.bindBillboard.AllowRotate(e)},e.prototype.AllowScale=function(e){return this.bindBillboard.AllowScale(e)},e.prototype.IsAllowTran=function(){return this.bindBillboard.IsAllowTran()},e.prototype.IsAllowRotate=function(){return this.bindBillboard.GetRotate()},e.prototype.IsAllowScale=function(){return this.bindBillboard.GetScale()},e.prototype.GetInTop=function(){return this.IsFrontShow()},e.prototype.SetInTop=function(e){this.SetFrontShow(e)},e.prototype.GetFlipV=function(){return this.m_flipV},e.prototype.SetFlipV=function(e){this.m_flipV=e},e.prototype.GetAllowClip=function(){return this.m_bAllowClip},e.prototype.SetAllowClip=function(e){return this.m_bAllowClip},e.prototype.SetLocalPos=function(e){this.localPos=e,this.bLocalPos=!0},e.prototype.GetLocalPos=function(){return this.localPos},e.prototype.SetFixShowInScreen=function(e){this.m_fixShowInScreen=e},e.prototype.GetFixShowInScreen=function(){return this.m_fixShowInScreen},e}(s.Shape);s.ImageBoard=e}(M3D||(M3D={})),function(o){var e,t,r,i,n;(e=o.TextureOp||(o.TextureOp={}))[e.TextureOp_Multiply=0]="TextureOp_Multiply",e[e.TextureOp_Add=1]="TextureOp_Add",e[e.TextureOp_Subtract=2]="TextureOp_Subtract",e[e.TextureOp_Divide=3]="TextureOp_Divide",e[e.TextureOp_SmoothAdd=4]="TextureOp_SmoothAdd",e[e.TextureOp_SignedAdd=5]="TextureOp_SignedAdd",(t=o.TextureMapMode||(o.TextureMapMode={}))[t.TextureMapMode_Wrap=0]="TextureMapMode_Wrap",t[t.TextureMapMode_Clamp=1]="TextureMapMode_Clamp",t[t.TextureMapMode_Decal=3]="TextureMapMode_Decal",t[t.TextureMapMode_Mirror=2]="TextureMapMode_Mirror",(r=o.TextureMapping||(o.TextureMapping={}))[r.TextureMapping_UV=0]="TextureMapping_UV",r[r.TextureMapping_SPHERE=1]="TextureMapping_SPHERE",r[r.TextureMapping_CYLINDER=2]="TextureMapping_CYLINDER",r[r.TextureMapping_BOX=3]="TextureMapping_BOX",r[r.TextureMapping_PLANE=4]="TextureMapping_PLANE",r[r.TextureMapping_OTHER=5]="TextureMapping_OTHER",(i=o.TextureType||(o.TextureType={}))[i.TextureType_NONE=0]="TextureType_NONE",i[i.TextureType_DIFFUSE=1]="TextureType_DIFFUSE",i[i.TextureType_SPECULAR=2]="TextureType_SPECULAR",i[i.TextureType_AMBIENT=3]="TextureType_AMBIENT",i[i.TextureType_EMISSIVE=4]="TextureType_EMISSIVE",i[i.TextureType_HEIGHT=5]="TextureType_HEIGHT",i[i.TextureType_NORMALS=6]="TextureType_NORMALS",i[i.TextureType_SHININESS=7]="TextureType_SHININESS",i[i.TextureType_OPACITY=8]="TextureType_OPACITY",i[i.TextureType_DISPLACEMENT=9]="TextureType_DISPLACEMENT",i[i.TextureType_LIGHTMAP=10]="TextureType_LIGHTMAP",i[i.TextureType_REFLECTION=11]="TextureType_REFLECTION",i[i.TextureType_UNKNOWN=12]="TextureType_UNKNOWN",(n=o.ShadingMode||(o.ShadingMode={}))[n.ShadingMode_Flat=1]="ShadingMode_Flat",n[n.ShadingMode_Gouraud=2]="ShadingMode_Gouraud",n[n.ShadingMode_Phong=3]="ShadingMode_Phong",n[n.ShadingMode_Blinn=4]="ShadingMode_Blinn",n[n.ShadingMode_Toon=5]="ShadingMode_Toon",n[n.ShadingMode_OrenNayar=6]="ShadingMode_OrenNayar",n[n.ShadingMode_Minnaert=7]="ShadingMode_Minnaert",n[n.ShadingMode_CookTorrance=8]="ShadingMode_CookTorrance",n[n.ShadingMode_NoShading=9]="ShadingMode_NoShading",n[n.ShadingMode_Fresnel=10]="ShadingMode_Fresnel";var a=function(n){function e(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=this;if(1===e.length){var i=e[0];(r=n.call(this,i)||this).SetAmbient(i.ambient),r.SetDiffuse(i.diffuse),r.SetSpecular(i.specular),r.SetEmissive(i.emissive),r.m_texture=new o.Texture,i.m_texture?r.m_texture=i.m_texture:r.m_texture&&(r.m_texture=null),r.m_normalMap=new o.Texture,i.m_normalMap?r.m_normalMap=i.m_normalMap:r.m_normalMap&&(r.m_normalMap=null),r.m_specularMap=new o.Texture,i.m_specularMap?r.m_specularMap=i.m_specularMap:r.m_specularMap=null,r.m_displacementMap=new o.Texture,i.m_displacementMap?r.m_displacementMap=i.m_displacementMap:r.m_displacementMap=null,r.m_matcapMap=new o.Texture,i.m_matcapMap?r.m_matcapMap=i.m_matcapMap:r.m_matcapMap&&(r.m_matcapMap=null),r.m_displacementScale=i.m_displacementScale,r.m_displacementBias=i.m_displacementBias,r.m_normalMapScale=i.m_normalMapScale,r.m_bumpmap=new o.Texture,i.m_bumpmap?r.m_bumpmap=i.m_bumpmap:r.m_bumpmap&&(r.m_bumpmap=null),i.textureTransform?(r.textureTransform=new o.Matrix4,r.textureTransform=i.textureTransform):r.textureTransform=null,r.ambientTexture=new o.Texture,i.ambientTexture?r.ambientTexture=i.ambientTexture:r.ambientTexture&&(r.ambientTexture=null),r.m_shininess=i.m_shininess,r.m_reflectiveTexture=new o.Texture,i.m_reflectiveTexture?r.m_reflectiveTexture=i.m_reflectiveTexture:r.m_reflectiveTexture&&(r.m_reflectiveTexture=null),r.needsUpdateUniformParameters=i.needsUpdateUniformParameters,r.m_materialType=i.m_materialType,r.m_opacity=i.m_opacity,r.m_isGammaOutpute=i.m_isGammaOutpute}else(r=n.call(this)||this).Init();return r}return __extends(e,n),e.prototype.Init=function(){var e=new o.Color(.8,.8,.8,1);this.SetAmbient(e),this.SetDiffuse(e),this.SetSpecular(new o.Color(.067,.067,.067)),this.m_iSpecular=200,this.SetEmissive(new o.Color(0,0,0)),this.m_texture=null,this.m_normalMap=null,this.m_specularMap=null,this.m_displacementMap=null,this.m_matcapMap=null,this.m_displacementScale=5,this.m_displacementBias=0,this.m_normalMapScale=new o.Vector2(2,2),this.SetDiffuseMap(null),this.SetBumpMap(null),this.textureTransform=null,this.ambientTexture=null,this.m_shininess=30,this.m_reflectiveTexture=null,this.needsUpdateUniformParameters=!0,this.m_materialType=o.MaterialType.MaterialType_Phong,this.Opacity(1),this.m_isGammaOutpute=!1},e.prototype.SetResourceManager=function(e){this.resourceManager=e},e.prototype.SetAmbient=function(e){this.ambient=e.Clone()},e.prototype.SetDiffuse=function(e){this.diffuse=e.Clone()},e.prototype.SetSpecular=function(e){this.specular=e.Clone()},e.prototype.SetEmissive=function(e){this.emissive=e.Clone()},e.prototype.GetAmbient=function(){return this.ambient},e.prototype.GetDiffuse=function(){return this.diffuse},e.prototype.GetSpecular=function(){return this.specular},e.prototype.GetEmissive=function(){return this.emissive},e.prototype.SetShadingMode=function(e){this.m_shadingMode=e},e.prototype.SetTextureOp=function(e){this.m_textureOp=e},e.prototype.SetTextureMapMode=function(e){this.m_textureMapMode=e},e.prototype.SetTextureMapping=function(e){this.m_textureMapping=e},e.prototype.GetShadingMode=function(){return this.m_shadingMode},e.prototype.GetTextureOp=function(){return this.m_textureOp},e.prototype.GetTextureMapMode=function(){return this.m_textureMapMode},e.prototype.GetTextureMapping=function(){return this.m_textureMapping},e.prototype.SetDiffuseMap=function(e){this.m_texture&&(this.m_texture=null),this.m_texture=e,this.m_texture&&this.SetNeedUpdate(!0)},e.prototype.SetMatcapMap=function(e){this.m_matcapMap&&(this.m_matcapMap=null),this.m_matcapMap=e,this.m_matcapMap&&this.SetNeedUpdate(!0)},e.prototype.GetMatcapMap=function(){return this.m_matcapMap},e.prototype.GetDiffuseMap=function(){return this.m_texture},e.prototype.SetSpecularMap=function(e){this.m_specularMap&&(this.m_specularMap=null),this.m_specularMap=e,this.m_specularMap&&this.SetNeedUpdate(!0)},e.prototype.GetSpecularMap=function(){return this.m_specularMap},e.prototype.SetEmissiveMap=function(e){},e.prototype.GetEmissiveMap=function(){return null},e.prototype.SetNormalMap=function(e){this.m_normalMap&&(this.m_normalMap=null),this.m_normalMap=e,this.m_normalMap&&this.SetNeedUpdate(!0)},e.prototype.GetNormalMap=function(){return this.m_normalMap},e.prototype.SetEvnMap=function(e){},e.prototype.GetEvnMap=function(){return null},e.prototype.SetBumpMap=function(e){this.m_bumpmap=e},e.prototype.GetBumpMap=function(){return this.m_bumpmap},e.prototype.SetAmbientMap=function(e){this.ambientTexture=e},e.prototype.GetAmbientMap=function(){return this.ambientTexture},e.prototype.CreateTexture2DTransform=function(){this.textureTransform||(this.textureTransform=new o.Matrix4)},e.prototype.GetTexture2DTransform=function(){return this.textureTransform},e.prototype.SetShininess=function(e){this.m_shininess=e},e.prototype.GetShininess=function(){return this.m_shininess},e.prototype.GetEnvTextureMapping=function(){return this.m_envTextureMapping},e.prototype.EnvTextureMapping=function(e){this.m_envTextureMapping=e},e.prototype.GetNormalMapScale=function(){return this.m_normalMapScale},e.prototype.NormalMapScale=function(e){this.m_normalMapScale=e},e.prototype.GetDisplacementMap=function(){return this.m_displacementMap},e.prototype.DisplacementMap=function(e){},e.prototype.GetDisplacementScale=function(){return this.m_displacementScale},e.prototype.DisplacementScale=function(e){this.m_displacementScale=e},e.prototype.GetDisplacementBias=function(){return this.m_displacementBias},e.prototype.DisplacementBias=function(e){this.m_displacementBias=e},e.prototype.GetOpacity=function(){return this.m_opacity},e.prototype.Opacity=function(e){this.m_opacity=e},e.prototype.TempOpacity=function(e){this.m_opacity=e},e.prototype.SetAmbientTexture=function(e){this.ambientTexture=e,this.SetUniformParameter("ambientTexture",this.ambientTexture)},e.prototype.SetDiffuseTexture=function(e){this.diffuseTexture=e,this.SetUniformParameter("diffuseTexture",this.diffuseTexture)},e.prototype.SetSpecularTexture=function(e){this.specularTexture=e,this.SetUniformParameter("specularTexture",this.specularTexture)},e.prototype.GetAmbientTexture=function(){return this.ambientTexture},e.prototype.GetDiffuseTexture=function(){return this.diffuseTexture},e.prototype.GetSpecularTexture=function(){return this.specularTexture},e.prototype.SetName=function(e){this.name=e},e.prototype.GetName=function(){return this.name},e.prototype.SetTexture2DTransform=function(e){this.textureTransform=e.Clone()},e.prototype.GHetTexture2DTransform=function(){return this.textureTransform},e.prototype.GetReflectiveTextureTexture=function(){return this.reflectiveTexture},e.prototype.SetReflectiveTexture=function(e){this.reflectiveTexture=e},e.prototype.SetUniformParameter=function(e,t){var r=!1;return void 0===this.uniformPatameters[e]&&(this.uniformPatameters[e]=t,r=!0),r},e.prototype.Clone=function(){return new e(this)},e.prototype.GetUniformParameter=function(e){return this.uniformPatameters.hasOwnProperty(e)?this.uniformPatameters[e]:null},e.prototype.GetUnifomParameters=function(){return this.uniformPatameters},e.prototype.GetiSpecular=function(){return this.m_iSpecular},e.prototype.SetiSpecular=function(e){this.m_iSpecular=e},e.prototype.Compare=function(e){if(null==e)return!1;n.prototype.Compare.call(this,e);var t=e;return!!n.prototype.Compare.call(this,t)&&(!!this.GetDiffuse().Equals(t.GetDiffuse())&&(!!this.GetEmissive().Equals(t.GetEmissive())&&(!!this.GetAmbient().Equals(t.GetAmbient())&&(!!this.GetSpecular().Equals(t.GetSpecular())&&(this.GetShadingMode()===t.GetShadingMode()&&(this.GetTextureOp()===t.GetTextureOp()&&(this.GetTextureMapMode()===t.GetTextureMapMode()&&(this.GetTextureMapping()===t.GetTextureMapping()&&(!(this.GetDiffuseMap()&&t.GetDiffuseMap()&&!this.GetDiffuseMap().Equals(t.GetDiffuseMap()))&&(!(this.GetAmbientMap()&&t.GetAmbientMap()&&!this.GetAmbientMap().Equals(t.GetAmbientMap()))&&(!(this.GetBumpMap()&&t.GetBumpMap()&&!this.GetBumpMap().Equals(t.GetBumpMap()))&&(!(this.GetNormalMap()&&t.GetNormalMap()&&!this.GetNormalMap().Equals(t.GetNormalMap()))&&(!(this.GetSpecularMap()&&t.GetSpecularMap()&&!this.GetSpecularMap().Equals(t.GetSpecularMap()))&&(!(this.GetReflectiveTextureTexture()&&t.GetReflectiveTextureTexture()&&!this.GetReflectiveTextureTexture().Equals(t.GetReflectiveTextureTexture()))&&(!(this.GetTexture2DTransform()&&t.GetTexture2DTransform()&&!this.GetTexture2DTransform().Equals(t.GetTexture2DTransform()))&&(!!o.Equals(this.GetShininess(),t.GetShininess())&&(!(this.GetMatcapMap()&&t.GetMatcapMap()&&!this.GetMatcapMap().Equals(t.GetMatcapMap()))&&(!(this.GetEmissiveMap()&&t.GetEmissiveMap()&&!this.GetEmissiveMap().Equals(t.GetEmissiveMap()))&&!!o.Equals(this.GetOpacity(),t.GetOpacity())))))))))))))))))))},e}(o.InnerMaterial);o.Material=a}(M3D||(M3D={})),function(r){var e=function(i){function e(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=this;return 1===e.length?r=i.call(this,e[0])||this:(r=i.call(this)||this).Init(),r}return __extends(e,i),e.prototype.Init=function(){var e=new r.Color(0,0,0,1),t=r.Color.WHITE().Clone();this.SetAmbient(e),this.SetDiffuse(t),this.SetSpecular(e),this.SetEmissive(e),this.m_texture=null,this.m_normalMap=null,this.m_specularMap=null,this.m_displacementMap=null,this.m_matcapMap=null,this.m_displacementScale=5,this.m_displacementBias=0,this.m_normalMapScale=new r.Vector2(1,1),this.SetDiffuseMap(null),this.SetBumpMap(null),this.textureTransform=null,this.ambientTexture=null,this.m_shininess=0,this.m_reflectiveTexture=null,this.needsUpdateUniformParameters=!0,this.Opacity(1),this.m_isGammaOutpute=!1,this.m_materialType=r.MaterialType.MaterialType_MatCap},e.prototype.Clone=function(){return new e(this)},e}(r.Material);r.MatCapMaterial=e}(M3D||(M3D={})),function(n){var e=function(i){function e(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=i.call(this)||this;return r.hardwareVertexBuffer=null,r.gl=null,r.isNeedUpdateEdge=!0,r.vertexOffset=0,r.position_=new n.Vector3,r.size_=new n.Vector2,r.points=[],r.bindBillboard=new n.Billboard,0===e.length?(r.points=[],r.bindBillboard.AllowRotate(!1),r.bindBillboard.AllowTran(!0),r.bindBillboard.AllowScale(!1)):2===e.length&&e[0]instanceof n.Vector3&&e[1]instanceof n.Vector2&&(r.points=[],r.bindBillboard.AllowRotate(!1),r.bindBillboard.AllowTran(!0),r.bindBillboard.AllowScale(!1),r.Set(e[0],e[1])),r}return __extends(e,i),e.prototype.SetCurrentGLContext=function(e){this.gl=e},e.prototype.SetRenderWorldMatrix=function(e){},e.prototype.GetRenderWorldMatrix=function(){return new n.Matrix4},e.prototype.GetRenderColor=function(){var e=n.Color.WHITE().Clone();return this.IsSelected()?n.Color.SelectColor().Clone():e},e.prototype.GetRenderMaterial=function(){return new n.Material},e.prototype.SetRenderMesh=function(e){},e.prototype.GetDataLength=function(){return-1},e.prototype.IsUseIndex=function(){return!1},e.prototype.SetIndexOffset=function(e){},e.prototype.GetIndexOffset=function(){return-1},e.prototype.SetNormalOffset=function(e){},e.prototype.GetNormalOffset=function(){return-1},e.prototype.SetVertexOffset=function(e){this.vertexOffset=e},e.prototype.GetVertexOffset=function(){return this.vertexOffset},e.prototype.SetTextureCoordsOffset=function(e){},e.prototype.GetTextureCoordsOffset=function(){return-1},e.prototype.SetCentersCoordsOffset=function(e){},e.prototype.GetCentersCoordsOffset=function(){return-1},e.prototype.GetHardWareVertexBuffer=function(){if(null===this.gl)return null;if(null===this.hardwareVertexBuffer&&(this.hardwareVertexBuffer=new n.HardWareVertexBuffer(this.gl)),this.isNeedUpdateEdge){var e=this.GetLinesVertexs().length;this.hardwareVertexBuffer.Create(0,e);var t=n.ArrayHelper.ConvertToFloat32Array(this.GetLinesVertexs());this.hardwareVertexBuffer.SetDataRange(t,0),this.SetVertexOffset(0),this.hardwareVertexBuffer.WriteBuffer(),this.isNeedUpdateEdge=!1}return this.hardwareVertexBuffer},e.prototype.GetHardWareIndexBuffer=function(){return null},e.prototype.Set=function(e,t){this.bindBillboard.SetCenter(e),this.position_=e.Clone(),this.size_=t.Clone(),this.points=[]},e.prototype.GetLinesVertexs=function(){if(0==this.points.length){var e=this.size_.x/2,t=this.size_.y/2;this.points.push(new n.Vector3(this.position_.x,this.position_.y-t,this.position_.z)),this.points.push(new n.Vector3(this.position_.x,this.position_.y+t,this.position_.z)),this.points.push(new n.Vector3(this.position_.x-e,this.position_.y,this.position_.z)),this.points.push(new n.Vector3(this.position_.x+e,this.position_.y,this.position_.z))}return this.points},e.prototype.ComputeBox=function(){this.BoundingBox.Clear(),0<this.points.length&&(this.BoundingBox.Merge(this.points[0]),this.BoundingBox.Merge(this.points[this.points.length-1]))},e.prototype.UpdateRenderData=function(e){var t=this.bindBillboard.GetGLWorldMatrix(e);this.SetRenderWorldMatrix(t)},e}(n.Shape);n.MeshBoard=e}(M3D||(M3D={})),function(o){var e=function(n){function e(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=this;if(1===e.length){r=n.call(this,e[0])||this;var i=e[0];r.m_materialType=i.m_materialType,r.m_rougthnessFactor=i.m_rougthnessFactor,r.m_metalnessFactor=i.m_metalnessFactor,r.m_aoMapIntensity=i.m_aoMapIntensity,r.m_emissiveColor=i.m_emissiveColor,r.m_normalMapScale=i.m_normalMapScale,r.m_displacementMap=new o.Texture,i.m_displacementMap?r.m_displacementMap=i.m_displacementMap:r.m_displacementMap&&(r.m_displacementMap=null),r.m_displacementScale=i.m_displacementScale,r.m_displacementBias=i.m_displacementBias,r.m_envMapIntensity=i.m_envMapIntensity,r.m_clearCoat=i.m_clearCoat,r.m_clearCoatRoughness=i.m_clearCoatRoughness,r.m_isUseClearCoat=i.m_isUseClearCoat,r.m_albedoMap=new o.Texture,i.m_albedoMap?r.m_albedoMap=i.m_albedoMap:r.m_albedoMap&&(r.m_albedoMap=null),r.m_metalnessRoughnessMap=new o.Texture,i.m_metalnessRoughnessMap?r.m_metalnessRoughnessMap=i.m_metalnessRoughnessMap:r.m_metalnessRoughnessMap&&(r.m_metalnessRoughnessMap=null),r.m_envMap=new o.Texture,i.m_envMap?r.m_envMap=i.m_envMap:r.m_envMap&&(r.m_envMap=null),r.m_envIrradianceMap=new o.Texture,i.m_envIrradianceMap?r.m_envIrradianceMap=i.m_envIrradianceMap:r.m_envIrradianceMap&&(r.m_envIrradianceMap=null),r.m_emissiveMap=new o.Texture,i.m_emissiveMap?r.m_emissiveMap=i.m_emissiveMap:r.m_emissiveMap&&(r.m_emissiveMap=null),r.m_ambientOcclusiontMap=new o.Texture,i.m_ambientOcclusiontMap?r.m_ambientOcclusiontMap=i.m_ambientOcclusiontMap:r.m_ambientOcclusiontMap&&(r.m_ambientOcclusiontMap=null),r.m_normalMap=new o.Texture,i.m_normalMap?r.m_normalMap=i.m_normalMap:r.m_normalMap&&(r.m_normalMap=null),r.SetDefine("PHYSICALLY_CORRECT_LIGHTSS","#define PHYSICALLY_CORRECT_LIGHTSS"),r.m_envTextureMapping=i.m_envTextureMapping,r.m_opacity=i.m_opacity,r.m_isGammaOutpute=i.m_isGammaOutpute,r.SetUseClearCoat(!1)}else(r=n.call(this)||this).m_materialType=o.MaterialType.MaterialType_Pbr,r.m_rougthnessFactor=.5,r.m_metalnessFactor=.04,r.m_aoMapIntensity=1,r.m_emissiveColor=new o.Color(0,0,0),r.m_normalMapScale=new o.Vector2(2,2),r.m_displacementMap=null,r.m_displacementScale=5,r.m_displacementBias=0,r.m_envMapIntensity=1,r.m_clearCoat=.9,r.m_clearCoatRoughness=.04,r.m_isUseClearCoat=!0,r.m_albedoMap=null,r.m_metalnessRoughnessMap=null,r.m_envMap=null,r.m_envIrradianceMap=null,r.m_emissiveMap=null,r.m_ambientOcclusiontMap=null,r.m_normalMap=null,r.SetDefine("PHYSICALLY_CORRECT_LIGHTSS","#define PHYSICALLY_CORRECT_LIGHTSS"),r.m_envTextureMapping=o.EnvTextureMappingType.CubeReflectionMapping,r.SetOpacity(1),r.m_isGammaOutpute=!0,r.SetUseClearCoat(!1);return r}return __extends(e,n),e.prototype.Rename=function(e){},e.prototype.AlbedoMap=function(){return this.m_albedoMap},e.prototype.SetAlbedoMap=function(e){this.m_albedoMap&&(this.m_albedoMap=null),this.m_albedoMap=e,this.m_albedoMap&&(this.m_albedoMap.SetIsGammaInput(!0),this.SetNeedUpdate(!0))},e.prototype.EnvMap=function(){return this.m_envMap},e.prototype.SetEnvMap=function(e){this.m_envMap!==e&&(this.m_envMap&&(this.m_envMap=null),this.m_envMap=e,this.m_envMap&&this.m_envMap.SetIsGammaInput(!0),this.SetNeedUpdate(!0))},e.prototype.EnvIrradianceMap=function(){return this.m_envIrradianceMap},e.prototype.SetEnvIrradianceMap=function(e){this.m_envIrradianceMap!==e&&(this.m_envIrradianceMap&&(this.m_envIrradianceMap=null),this.m_envIrradianceMap=e,this.m_envIrradianceMap&&this.m_envIrradianceMap.SetIsGammaInput(!0),this.SetNeedUpdate(!0))},e.prototype.EmissiveMap=function(){return this.m_emissiveMap},e.prototype.SetEmissiveMap=function(e){this.m_emissiveMap&&(this.m_emissiveMap=null),this.m_emissiveMap=e,this.m_emissiveMap&&(this.m_emissiveMap.SetIsGammaInput(!0),this.SetNeedUpdate(!0))},e.prototype.AmbientOcclusiontMap=function(){return this.m_ambientOcclusiontMap},e.prototype.SetAmbientOcclusiontMap=function(e){this.m_ambientOcclusiontMap&&(this.m_ambientOcclusiontMap=null),this.m_ambientOcclusiontMap=e,this.m_ambientOcclusiontMap&&(this.m_ambientOcclusiontMap.SetIsGammaInput(!0),this.SetNeedUpdate(!0))},e.prototype.NormalMap=function(){return this.m_normalMap},e.prototype.SetNormalMap=function(e){this.m_normalMap&&(this.m_normalMap=null),this.m_normalMap=e,this.m_normalMap&&(this.m_normalMap.SetIsGammaInput(!0),this.SetNeedUpdate(!0))},e.prototype.EnvTextureMapping=function(){return this.m_envTextureMapping},e.prototype.SetEnvTextureMapping=function(e){this.m_envTextureMapping=e},e.prototype.MetalnessRoughnessMap=function(){return this.m_metalnessRoughnessMap},e.prototype.SetMetalnessRoughnessMap=function(e){this.m_metalnessRoughnessMap&&(this.m_metalnessRoughnessMap=null),this.m_metalnessRoughnessMap=e,this.m_metalnessRoughnessMap&&(this.m_metalnessRoughnessMap.SetIsGammaInput(!0),this.SetNeedUpdate(!0))},e.prototype.RougthnessFactor=function(){return this.m_rougthnessFactor},e.prototype.SetRougthnessFactor=function(e){this.m_rougthnessFactor=e},e.prototype.MetalnessFactor=function(){return this.m_metalnessFactor},e.prototype.SetMetalnessFactor=function(e){this.m_metalnessFactor=e},e.prototype.AlbedoColor=function(){return this.m_albedoColor},e.prototype.SetAlbedoColor=function(e){this.m_albedoColor=e},e.prototype.EmissiveColor=function(){return this.m_emissiveColor},e.prototype.SetEmissiveColor=function(e){this.m_emissiveColor=e},e.prototype.AoMapIntensity=function(){return this.m_aoMapIntensity},e.prototype.SetAoMapIntensity=function(e){this.m_aoMapIntensity=e},e.prototype.NormalMapScale=function(){return this.m_normalMapScale},e.prototype.SetNormalMapScale=function(e){this.m_normalMapScale=e},e.prototype.DisplacementMap=function(){return this.m_displacementMap},e.prototype.SetDisplacementMap=function(e){this.m_displacementMap&&(this.m_displacementMap=null),this.m_displacementMap=e,this.m_displacementMap&&(this.m_displacementMap.SetIsGammaInput(!0),this.SetNeedUpdate(!0))},e.prototype.DisplacementScale=function(){return this.m_displacementScale},e.prototype.SetDisplacementScale=function(e){this.m_displacementScale=e},e.prototype.DisplacementBias=function(){return this.m_displacementBias},e.prototype.SetDisplacementBias=function(e){this.m_displacementBias=e},e.prototype.EnvMapIntensity=function(){return this.m_envMapIntensity},e.prototype.SetEnvMapIntensity=function(e){this.m_envMapIntensity=e},e.prototype.ClearCoat=function(){return this.m_clearCoat},e.prototype.SetClearCoat=function(e){this.m_clearCoat=e},e.prototype.ClearCoatRoughness=function(){return this.m_clearCoatRoughness},e.prototype.SetClearCoatRoughness=function(e){this.m_clearCoatRoughness=e},e.prototype.UseClearCoat=function(){return this.m_isUseClearCoat},e.prototype.SetUseClearCoat=function(e){this.m_isUseClearCoat=e,this.SetDefine("STANDARD",this.m_isUseClearCoat?"":"#define STANDARD\n"),this.SetNeedUpdate(!0)},e.prototype.Opacity=function(){return this.m_opacity},e.prototype.SetOpacity=function(e){this.m_opacity=e},e.prototype.Clone=function(){return new e(this)},e.prototype.Compare=function(e){if(null==e)return!1;n.prototype.Compare.call(this,e);var t=e;return!!n.prototype.Compare.call(this,t)&&(!(this.AlbedoMap()&&!this.AlbedoMap().Equals(t.AlbedoMap()))&&(!(!this.AlbedoMap()&&t.AlbedoMap())&&(!(this.MetalnessRoughnessMap()&&!this.MetalnessRoughnessMap().Equals(t.MetalnessRoughnessMap()))&&(!(!this.MetalnessRoughnessMap()&&t.MetalnessRoughnessMap())&&(!(this.EnvMap()&&!this.EnvMap().Equals(t.EnvMap()))&&(!(!this.EnvMap()&&t.EnvMap())&&(!(this.EnvIrradianceMap()&&!this.EnvIrradianceMap().Equals(t.EnvIrradianceMap()))&&(!(!this.EnvIrradianceMap()&&t.EnvIrradianceMap())&&(!(this.EmissiveMap()&&!this.EmissiveMap().Equals(t.EmissiveMap()))&&(!(!this.EmissiveMap()&&t.EmissiveMap())&&(!(this.AmbientOcclusiontMap()&&!this.AmbientOcclusiontMap().Equals(t.AmbientOcclusiontMap()))&&(!(!this.AmbientOcclusiontMap()&&t.AmbientOcclusiontMap())&&(!!o.Equals(this.AoMapIntensity(),t.AoMapIntensity())&&(!(this.NormalMap()&&!this.NormalMap().Equals(t.NormalMap()))&&(!(!this.NormalMap()&&t.NormalMap())&&(!(this.DisplacementMap()&&!this.DisplacementMap().Equals(t.DisplacementMap()))&&(!(!this.DisplacementMap()&&t.DisplacementMap())&&(!!o.Equals(this.DisplacementScale(),t.DisplacementScale())&&(!!o.Equals(this.DisplacementBias(),t.DisplacementBias())&&(!!this.AlbedoColor().Equals(t.AlbedoColor())&&(!!this.EmissiveColor().Equals(t.EmissiveColor())&&(!!o.Equals(this.RougthnessFactor(),t.RougthnessFactor())&&(!!o.Equals(this.MetalnessFactor(),t.MetalnessFactor())&&(this.NormalMapScale()===t.NormalMapScale()&&(this.EnvTextureMapping()===t.EnvTextureMapping()&&(!!o.Equals(this.EnvMapIntensity(),t.EnvMapIntensity())&&(!!o.Equals(this.ClearCoat(),t.ClearCoat())&&(!o.Equals(this.ClearCoatRoughness(),t.ClearCoatRoughness())&&(!(!this.UseClearCoat()||!t.UseClearCoat())&&!!o.Equals(this.Opacity(),t.Opacity()))))))))))))))))))))))))))))))},e}(o.InnerMaterial);o.PbrMaterial=e}(M3D||(M3D={})),function(p){var e=function(u){function e(){var e=u.call(this)||this;return e.m_intensity=1,e.m_lightColor=p.Color.WHITE().Clone(),e.m_ShowAllSign=!1,e.m_showSimpleSign=!0,e.m_lightType=p.LightType.LightType_Point,e}return __extends(e,u),e.prototype.FindVisiableObject=function(e){if(this.m_needUpdataSign){var t=this.GetWorldTransform().ToMatrix3x4();this.m_glworldMatrix=t.ToMatrix4().Transpose();var r=p.Vector3.ZERO();if(this.m_showSimpleSign&&!this.m_simpleSignModel){this.m_simpleSignModel=new p.ImageModel;var i=p.Parameters.Instance().appWorkPath+"\\data\\pic\\point.png";this.m_simpleSignModel.SetImagePath(i),this.m_simpleSignModel.SetImageSize(r,new p.Vector2(.5,.5)),this.AddSubModel(this.m_simpleSignModel)}if(this.m_ShowAllSign){this.m_allSignModel||(this.m_allSignModel=new p.Model,this.AddSubModel(this.m_allSignModel)),this.m_allSignModel.ClearLineData();e.GetScene().GetSceneBox().Length();for(var n=[],o=[],a=this.m_distance,s=0;s<32;s++){var l=s/32*p.PI*2,h=new p.Vector3(p.Cos(l),p.Sin(l),0);n.push(h.Multiply(a)),o.push(new p.Vector3(p.Cos(l),0,p.Sin(l)).Multiply(a))}n.push(new p.Vector3(p.Cos(0),p.Sin(0),0).Multiply(a)),o.push(new p.Vector3(p.Cos(0),0,p.Sin(0)).Multiply(a)),this.m_allSignModel.AddLineData(n),this.m_allSignModel.AddLineData(o)}this.m_needUpdataSign=!1}this.SetRenderWorldMatrix(this.m_glworldMatrix),u.prototype.FindVisiableObject.call(this,e)},e.prototype.GetType=function(){return p.ShapeType.SHAPE_LIGHT_POINT},e.prototype.Decay=function(){return this.m_decay},e.prototype.SetDecay=function(e){this.m_decay=e},e.prototype.Distance=function(){return this.m_distance},e.prototype.SetDistance=function(e){this.m_distance=e},e}(p.BaseLight);p.PointLight=e}(M3D||(M3D={})),function(o){var e=function(n){function e(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=this;if(1===e.length){r=n.call(this,e[0])||this;var i=e[0];r.m_fragmentShader=i.m_fragmentShader,r.m_vertexShader=i.m_vertexShader}else(r=n.call(this)||this).m_materialType=o.MaterialType.MaterialType_Shader;return r}return __extends(e,n),e.prototype.FragmentShader=function(){return this.m_fragmentShader},e.prototype.SetFragmentShader=function(e){this.m_fragmentShader=e},e.prototype.VertexShader=function(){return this.m_vertexShader},e.prototype.SetVertexShader=function(e){this.m_vertexShader=e},e.prototype.RealeseParameters=function(){for(var e in this.m_uniformPatameters){var t=this.m_uniformPatameters[e];if(t instanceof o.Texture2D)t&&null;else if(t instanceof o.TextureCube){t&&null}else if(t instanceof Number);else if(t instanceof o.Vector3){t&&null}else if(t instanceof o.Vector4){t&&null}else Boolean}},e.prototype.Clone=function(){return new e(this)},e}(o.BaseMaterial);o.ShaderMaterial=e}(M3D||(M3D={})),function(T){var e=function(y){function e(){var e=y.call(this)||this;return e.m_intensity=1,e.m_lightColor=T.Color.WHITE().Clone(),e.m_ShowAllSign=!1,e.m_showSimpleSign=!0,e.m_lightType=T.LightType.LightType_Spot,e}return __extends(e,y),e.prototype.GetType=function(){return T.ShapeType.SHAPE_LIGHT_SPOT},e.prototype.Decay=function(){return this.m_decay},e.prototype.SetDecay=function(e){this.m_decay=e},e.prototype.Distance=function(){return this.m_distance},e.prototype.SetDistance=function(e){this.m_distance=e},e.prototype.Angle=function(){return this.m_angle},e.prototype.SetAngle=function(e){this.m_angle=e},e.prototype.Penumbra=function(){return this.m_penumbra},e.prototype.SetPenumbra=function(e){this.m_penumbra=e},e.prototype.FindVisiableObject=function(e){if(this.m_needUpdataSign){var t=this.GetWorldTransform();this.m_glworldMatrix=t.Transpose();var r=T.Vector3.ZERO().Clone();if(this.m_showSimpleSign&&!this.m_simpleSignModel){this.m_simpleSignModel=new T.ImageModel;var i=T.Parameters.Instance().appWorkPath+"\\data\\pic\\spot.png";this.m_simpleSignModel.SetImagePath(i),this.m_simpleSignModel.SetImageSize(r,new T.Vector2(.5,.5)),this.AddSubModel(this.m_simpleSignModel)}if(this.m_ShowAllSign){this.m_allSignModel||(this.m_allSignModel=new T.Model,this.AddSubModel(this.m_allSignModel)),this.m_allSignModel.ClearLineData();var n=this.m_distance,o=this.m_angle,a=T.Tan(o)*n,s=[],l=r.Clone(),h=this.m_direction;h.Normalize(),s.push(l.Sub(h.Multiply(n))),s.push(l),this.m_allSignModel.AddLineData(s);var u=[];u.push(new T.Vector3(0,0,0)),u.push(new T.Vector3(T.Cos(0)*a,T.Sin(0)*a,-n)),this.m_allSignModel.AddLineData(u);var p=[];p.push(new T.Vector3(0,0,0)),p.push(new T.Vector3(T.Cos(T.HALF_PI)*a,T.Sin(T.HALF_PI)*a,-n)),this.m_allSignModel.AddLineData(p);var c=[];c.push(new T.Vector3(0,0,0)),c.push(new T.Vector3(T.Cos(T.PI)*a,T.Sin(T.PI)*a,-n)),this.m_allSignModel.AddLineData(c);var d=[];d.push(new T.Vector3(0,0,0)),d.push(new T.Vector3(T.Cos(3*T.HALF_PI)*a,T.Sin(3*T.HALF_PI)*a,-n)),this.m_allSignModel.AddLineData(d);for(var S=[],f=0;f<32;f++){var m=f/32*T.PI*2;S.push(new T.Vector3(T.Cos(m)*a,T.Sin(m)*a,-n))}S.push(new T.Vector3(T.Cos(0)*a,T.Sin(0)*a,-n)),this.m_allSignModel.AddLineData(S)}this.m_needUpdataSign=!1}this.SetRenderWorldMatrix(this.m_glworldMatrix),y.prototype.FindVisiableObject.call(this,e)},e}(T.BaseLight);T.SpotLight=e}(M3D||(M3D={})),function(i){var e=function(t){function e(e){return t.call(this,e)||this}return __extends(e,t),e.prototype.AddImage=function(e){0<this.imageArray.length?this.imageArray[0]=e:0===this.imageArray.length&&this.imageArray.push(e)},e.prototype.UpdateOGLObj=function(){for(var r=this,e=function(e,t){r.gl.bindTexture(i.GL.TEXTURE_2D,r.texObj),r.gl.pixelStorei(r.gl.UNPACK_FLIP_Y_WEBGL,!1),r.IsUseMipMap&&(r.gl.texParameteri(r.gl.TEXTURE_2D,r.gl.TEXTURE_MIN_FILTER,r.gl.LINEAR_MIPMAP_LINEAR),r.gl.texParameteri(r.gl.TEXTURE_2D,r.gl.TEXTURE_MAG_FILTER,r.gl.LINEAR)),r.gl.texImage2D(r.gl.TEXTURE_2D,0,r.textureParameter.internalrFromat,r.textureParameter.format,r.gl.UNSIGNED_BYTE,e),r.IsUseMipMap&&r.gl.generateMipmap(i.GL.TEXTURE_2D),r.isLoaded=!0},t=0;t<this.imageArray.length;t++)this.imageArray[t].GetSourceMode()===i.ImageSource.FromURL?(i.ImageLoader.LoadImage(this.imageArray[t],e,t),this.resourceManager.AddOGLTexture(this.imageArray[t].GetImagePath(),this.texObj)):this.imageArray[t].GetSourceMode()===i.ImageSource.FromeZip&&i.ImageLoader.LoadImage(this.imageArray[t],e,t)},e.prototype.Init=function(){t.prototype.Init.call(this),this.texObj=this.gl.createTexture(),this.gl.bindTexture(i.GL.TEXTURE_2D,this.texObj),this.gl.texParameteri(i.GL.TEXTURE_2D,i.GL.TEXTURE_MAG_FILTER,this.textureParameter.filterMag),this.gl.texParameteri(i.GL.TEXTURE_2D,i.GL.TEXTURE_MIN_FILTER,this.textureParameter.filterMin),this.gl.texParameteri(i.GL.TEXTURE_2D,i.GL.TEXTURE_WRAP_S,this.textureParameter.wrapS),this.gl.texParameteri(i.GL.TEXTURE_2D,i.GL.TEXTURE_WRAP_T,this.textureParameter.wrapT),this.gl.bindTexture(i.GL.TEXTURE_2D,null)},e}(i.Texture);i.Texture2D=e;var t=function(t){function e(){var e=t.call(this)||this;return e.m_textures[0]=0,e}return __extends(e,t),e.prototype.GetType=function(){return i.Texture.TEXTURE_2D},e.prototype.SetTexture2DID=function(e){this.m_textures[0]=e},e.prototype.GetTexture2DID=function(){return this.m_textures[0]},e}(i.Texture);i.Texture2DPackaging=t}(M3D||(M3D={})),function(o){var e=function(r){function e(e){var t=r.call(this,e)||this;return t.mipArray=[],t.miplevels=1,t.texCount=0,t}return __extends(e,r),e.prototype.AddImage=function(e){if(0<this.imageArray.length)for(var t=0;t<this.imageArray.length;t++)this.imageArray[t].GetImagePath()!==e.GetImagePath()&&this.imageArray.push(e);else 0===this.imageArray.length&&this.imageArray.push(e)},e.prototype.AddImages=function(e){this.mipArray.push(e)},e.prototype.UpdateOGLObj=function(){for(var n=this,e=function(e,t,r){void 0===r&&(r=0),n.texCount++;var i=n.gl;n.gl.bindTexture(o.GL.TEXTURE_CUBE_MAP,n.texObj),n.gl.pixelStorei(n.gl.UNPACK_FLIP_Y_WEBGL,!1),n.IsUseMipMap?(i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_MIN_FILTER,i.LINEAR_MIPMAP_LINEAR),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_MAG_FILTER,i.LINEAR)):(n.gl.texParameteri(o.GL.TEXTURE_CUBE_MAP,o.GL.TEXTURE_MAG_FILTER,n.textureParameter.filterMag),n.gl.texParameteri(o.GL.TEXTURE_CUBE_MAP,o.GL.TEXTURE_MIN_FILTER,n.textureParameter.filterMin),n.gl.texParameteri(o.GL.TEXTURE_CUBE_MAP,o.GL.TEXTURE_WRAP_S,n.textureParameter.wrapS),n.gl.texParameteri(o.GL.TEXTURE_CUBE_MAP,o.GL.TEXTURE_WRAP_T,n.textureParameter.wrapT)),n.gl.texImage2D(n.gl.TEXTURE_CUBE_MAP_POSITIVE_X+t,r,n.textureParameter.internalrFromat,n.textureParameter.format,n.gl.UNSIGNED_BYTE,e),n.texCount===6*n.miplevels&&(n.IsUseMipMap&&(n.gl.generateMipmap(o.GL.TEXTURE_CUBE_MAP),i.bindTexture(i.TEXTURE_2D,null)),n.isLoaded=!0,n.texCount=0)},t=0;t<this.mipArray.length;t++){this.miplevels=this.mipArray.length;for(var r=this.mipArray[t],i=0;i<r.length;i++)r[i].GetSourceMode()===o.ImageSource.FromURL&&o.ImageLoader.LoadImage(r[i],e,i,t)}},e.prototype.Init=function(){this.texObj=this.gl.createTexture()},e}(o.Texture);o.TextureCube=e}(M3D||(M3D={})),function(t){var e=function(r){function e(e){var t=r.call(this,e)||this;return t.width=512,t.height=512,t}return __extends(e,r),e.prototype.UpdateOGLObj=function(){this.gl.bindTexture(t.GL.TEXTURE_2D,this.texObj),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.textureParameter.internalrFromat,this.width,this.height,0,this.textureParameter.format,this.gl.UNSIGNED_BYTE,null),this.isLoaded=!0},e.prototype.Init=function(){this.texObj=this.gl.createTexture(),this.gl.bindTexture(t.GL.TEXTURE_2D,this.texObj),this.gl.texParameteri(t.GL.TEXTURE_2D,t.GL.TEXTURE_MAG_FILTER,this.textureParameter.filterMag),this.gl.texParameteri(t.GL.TEXTURE_2D,t.GL.TEXTURE_MIN_FILTER,this.textureParameter.filterMin),this.gl.texParameteri(t.GL.TEXTURE_2D,t.GL.TEXTURE_WRAP_S,t.GL.CLAMP_TO_EDGE),this.gl.texParameteri(t.GL.TEXTURE_2D,t.GL.TEXTURE_WRAP_T,t.GL.CLAMP_TO_EDGE),this.gl.bindTexture(t.GL.TEXTURE_2D,null)},e.prototype.setSize=function(e,t){this.width=e,this.height=t},e.prototype.bind=function(){this.texObj||console.warn("Texture object is null"),this.gl.bindTexture(this.gl.TEXTURE_2D,this.texObj)},e.prototype.unbind=function(){this.gl.bindTexture(this.gl.TEXTURE_2D,null)},e}(t.Texture);t.TextureTarget=e}(M3D||(M3D={})),function(l){var e=function(){function s(){this.worldMatrix=l.Matrix3x4.IDENTITY().Clone(),this.glRenderMatrix=l.Matrix4.IDENTITY().Clone(),this.plcMatrix=l.Matrix3x4.IDENTITY().Clone(),this.oldPlcMatrix=l.Matrix3x4.IDENTITY().Clone(),this.position=new l.Vector3,this.oldPosition=new l.Vector3,this.rotation=new l.Quaternion,this.oldRotation=new l.Quaternion,this.scale=l.Vector3.ONE().Clone(),this.oldScale=l.Vector3.ONE().Clone(),this.pParent=null,this.bdBox=new l.BoundingBox,this.worldBox=new l.BoundingBox,this.pParent=null,this.strNodeName="NONAME",this.position.ToZero(),this.rotation.ToZero(),this.scale.ToOne(),this.oldPosition=this.position,this.oldRotation=this.rotation,this.oldScale=this.scale,this.m_bVisible=!0,this.cullerState=l.Camera.FRUSTUINER,this.ID=l.IDCreator.GetDefaultID(),this.MarkDirty()}return s.prototype.Traverse=function(e){e.IsFinish()||e.Apply(this)},s.prototype.Reset=function(){this.position=this.oldPosition.Clone(),this.scale=this.oldScale.Clone(),this.rotation=this.oldRotation.Clone(),this.plcMatrix=this.oldPlcMatrix.Clone(),this.worldMatrix=l.Matrix3x4.IDENTITY().Clone(),this.MarkDirty()},s.prototype.Search=function(r){var e=null,t=new l.SearchAction(null);return t.SetCompare(function(e,t){return r===e.strNodeName}),this.Traverse(t),0<t.result.length&&(e=t.result[0]),e},s.prototype.SetID=function(e){this.ID=e},s.prototype.GetID=function(){return this.ID},s.prototype.GetType=function(){return l.SCENE_NODE},s.prototype.SetName=function(e){this.strNodeName=e},s.prototype.GetName=function(){return this.strNodeName},s.prototype.GetOldPosition=function(){return this.oldPosition},s.prototype.GetOldRotation=function(){return this.oldRotation},s.prototype.SetScale=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];"number"==typeof e[0]?.001<e[0]&&(this.scale=this.scale.Divide(e[0]),this.oldScale=this.scale):e[0]instanceof l.Vector3&&(this.scale=e[0].Abs(),this.MarkDirty())},s.prototype.ResetMovement=function(){this.position.ToZero(),this.rotation.ToZero(),this.plcMatrix=this.oldPlcMatrix.Clone()},s.prototype.SetPlcMatrix=function(e){this.plcMatrix=e.Clone(),this.MarkDirty()},s.prototype.SetOrigPlcMatrix=function(e){this.plcMatrix=e.Clone(),this.oldPlcMatrix=this.plcMatrix.Clone(),this.MarkDirty()},s.prototype.GetOrigPlcMartirx=function(){return this.oldPlcMatrix},s.prototype.IsVisible=function(){return this.m_bVisible},s.prototype.SetVisible=function(e){this.m_bVisible=e},s.prototype.GetBoundingBox=function(){return this.ComputeBox(),this.bdBox},s.prototype.GetWorldBoundingBox=function(){if(!this.worldBox.Defined()){var e=this.GetBoundingBox().Clone();e.Defined()&&(e.Transform(this.GetWorldTransform()),this.worldBox=e)}return this.worldBox},s.prototype.SetBoundingBox=function(e){this.bdBox=e},s.prototype.RayPick=function(e){},s.prototype.ComputeBox=function(){if(!this.bdBox.Defined()){var e=this.GetShape();if(null!=e){var t=e.GetBoundingBox();t.Defined()&&(this.bdBox=t)}}},s.prototype.GetShape=function(){return this.shape},s.prototype.SetCullerState=function(e){this.cullerState=e},s.prototype.GetCullerState=function(){return this.cullerState},s.prototype.GetPickType=function(){return 0},s.prototype.GetParent=function(){return this.pParent},s.prototype.SetParent=function(e){this.pParent=e},s.prototype.SetLocalTransform=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(e[0]instanceof l.Matrix4){var r=e[0],i=this.GetPlcMatrix().Inverse().Multiply(r);this.SetTransform(i.Translation(),i.Rotation(),i.Scale()),this.MarkDirty()}else{if(!(e[0]instanceof l.Matrix3x4))return null;r=e[0],i=this.GetPlcMatrix().Inverse().Multiply(r);this.SetTransform(i.Translation(),i.Rotation(),i.Scale()),this.MarkDirty()}},s.prototype.GetLocalTransform=function(){return this.GetPlcMatrix().Multiply(this.GetTransform())},s.prototype.GetTransform=function(){return new l.Matrix3x4(this.position,this.rotation,this.scale)},s.prototype.SetWorldTransform=function(e){var t=new l.Matrix3x4;t=null===this.pParent?e:this.pParent.GetWorldTransform().Inverse().Multiply(e),this.SetLocalTransform(t)},s.prototype.GetWorldTransform=function(){return this.IsDirty()&&this.UpdateWorldTransform(),this.worldMatrix},s.prototype.GetGLWorldTransform=function(){return this.GetWorldTransform(),this.glRenderMatrix},s.prototype.UpdateWorldTransform=function(){var e=this.GetLocalTransform();null===this.pParent?this.worldMatrix=e:this.worldMatrix=this.pParent.GetWorldTransform().Multiply(e),this.glRenderMatrix=this.worldMatrix.ToMatrix4().Transpose(),this.dirty=!1},s.prototype.FindVisiableObject=function(e){},s.prototype.GetPlcMatrix=function(){return this.plcMatrix},s.prototype.GetPosition=function(){return this.position},s.prototype.SetPosition=function(e){this.position=e,this.MarkDirty()},s.prototype.GetRotation=function(){return this.rotation},s.prototype.SetRotation=function(e){this.rotation=e,this.MarkDirty()},s.prototype.GetDirection=function(){return this.rotation.Multiply(l.Vector3.FORWARD())},s.prototype.SetDirection=function(e){this.SetRotation(new l.Quaternion(l.Vector3.FORWARD(),e))},s.prototype.SetTransform=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(2===e.length)this.position=e[0],this.rotation=e[1];else if(3===e.length)if(e[2]instanceof Number){var r=e[0],i=e[1],n=e[2];this.SetTransform(r,i,new l.Vector3(n,n,n))}else if(e[2]instanceof l.Vector3){r=e[0],i=e[1],n=e[2];this.position=r,this.rotation=i,this.scale=n}this.MarkDirty()},s.prototype.GetWorldRotation=function(){return this.dirty&&this.UpdateWorldTransform(),this.worldMatrix.Rotation()},s.prototype.GetWorldDirection=function(){return this.dirty&&this.UpdateWorldTransform(),this.worldMatrix.Rotation().Multiply(l.Vector3.FORWARD().Clone())},s.prototype.GetWorldPosition=function(){return this.dirty&&this.UpdateWorldTransform(),this.worldMatrix.Translation()},s.prototype.SetWorldPosition=function(e){var t=null===this.pParent?e:this.pParent.GetWorldTransform().Inverse().Multiply(e);this.SetPosition(t)},s.prototype.SetWorldRotation=function(e){this.SetRotation(null===this.pParent?e:this.pParent.GetWorldRotation().Inverse().MultiplyED(e))},s.prototype.SetWorldDirection=function(e){var t=null===this.pParent?e:this.pParent.GetWorldRotation().Inverse().Multiply(e);this.SetRotation(new l.Quaternion(l.Vector3.FORWARD(),t))},s.prototype.SetWorldScale=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(1===e.length)if(e[0]instanceof l.Vector3){var r=e[0];this.SetScale(null===this.pParent?r:r.Divide(this.pParent.GetWorldScale()))}else{r=e[0];this.SetWorldScale(new l.Vector3(r,r,r))}},s.prototype.GetWorldScale=function(){return this.IsDirty()&&this.UpdateWorldTransform(),this.worldMatrix.Scale()},s.prototype.Translate=function(e,t){switch(t){case s.TS_LOCAL:this.position.AddED(this.rotation.Multiply(e));break;case s.TS_PARENT:this.position.AddED(e);break;case s.TS_WORLD:this.position.AddED(null===this.pParent?e:this.pParent.GetWorldTransform().Inverse().Multiply(e))}this.MarkDirty()},s.prototype.Rotate=function(e,t){switch(void 0===t&&(t=s.TS_LOCAL),t){case s.TS_LOCAL:this.rotation=this.rotation.Multiply(e).Normalized();break;case s.TS_PARENT:this.rotation=e.Multiply(this.rotation).Normalized();break;case s.TS_WORLD:if(null===this.pParent)this.rotation=e.Multiply(this.rotation).Normalized();else{var r=this.GetWorldRotation();this.rotation=this.rotation.Multiply(r.Inverse()).Multiply(e).Multiply(r).Clone()}}this.MarkDirty()},s.prototype.RotateAround=function(e,t,r){var i=new l.Vector3,n=this.rotation.Clone();switch(r){case s.TS_LOCAL:i=this.GetTransform().Multiply(e),this.rotation=this.rotation.Multiply(t).Normalized();break;case s.TS_PARENT:i=e.Clone(),this.rotation=t.Multiply(this.rotation).Normalized();break;case s.TS_WORLD:if(null===this.pParent)i=e.Clone(),this.rotation=t.Multiply(this.rotation).Normalized();else{i=this.pParent.GetWorldTransform().Inverse().Multiply(e);var o=this.GetWorldRotation();this.rotation=this.rotation.Multiply(o.Inverse()).Multiply(t).Multiply(o)}}var a=n.Inverse().Multiply(this.position.Sub(i));this.position=this.rotation.Multiply(a).AddED(i),this.MarkDirty()},s.prototype.Yaw=function(e,t){this.Rotate(new l.Quaternion(e,l.Vector3.UP()),t)},s.prototype.Pitch=function(e,t){this.Rotate(new l.Quaternion(e,l.Vector3.RIGHT()),t)},s.prototype.Roll=function(e,t){this.Rotate(new l.Quaternion(e,l.Vector3.FORWARD()),t)},s.prototype.LookAt=function(e,t,r){var i=new l.Vector3;switch(r){case s.TS_LOCAL:i=this.GetWorldTransform().Multiply(e);break;case s.TS_PARENT:i=null===this.pParent?e.Clone():this.pParent.GetWorldTransform().Multiply(e);break;case s.TS_WORLD:i=e.Clone()}var n=i.Sub(this.GetWorldPosition());if(n.Equals(l.Vector3.ZERO().Clone()))return!1;var o=new l.Quaternion;return!!o.FromLookRotation(n,t)&&(this.SetWorldRotation(o),!0)},s.prototype.Scale=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(1===e.length)if(e instanceof l.Vector3){var r=e[0];this.scale.Multiply(r),this.MarkDirty()}else{r=e[0];this.Scale(new l.Vector3(r,r,r))}},s.prototype.MarkDirty=function(){this.dirty=!0,this.OnMarkedDirty()},s.prototype.IsDirty=function(){return this.dirty},s.prototype.OnMarkedDirty=function(){},s.prototype.LocalToWorld=function(e){return this.GetWorldTransform().Multiply(e)},s.prototype.WorldToLocal=function(e){return this.GetWorldTransform().Inverse().Multiply(e)},s.prototype.UpdateName=function(){return!1},s.TS_LOCAL=0,s.TS_PARENT=1,s.TS_WORLD=2,s}();l.SceneNode=e}(M3D||(M3D={})),function(r){var e=function(t){function e(){var e=t.call(this)||this;return e.pChildrenList=[],e}return __extends(e,t),e.prototype.GetType=function(){return r.GROUP_NODE},e.prototype.Traverse=function(e){if(!e.IsFinish()){e.Apply(this);for(var t=0,r=this.pChildrenList;t<r.length;t++){r[t].Traverse(e)}}},e.prototype.Size=function(){return this.pChildrenList.length},e.prototype.GetChild=function(e){return this.pChildrenList[e]},e.prototype.GetChildren=function(){return this.pChildrenList},e.prototype.AddChild=function(e){null!==e&&(e.SetParent(this),this.pChildrenList.push(e))},e.prototype.RayPick=function(e){for(var t=0,r=this.pChildrenList;t<r.length;t++){r[t].RayPick(e)}},e.prototype.FindVisiableObject=function(e){if(this.IsVisible())for(var t=0,r=this.pChildrenList;t<r.length;t++){r[t].FindVisiableObject(e)}},e.prototype.OnMarkedDirty=function(){if(this.pChildrenList)for(var e=0;e<this.pChildrenList.length;e++){this.pChildrenList[e].MarkDirty()}},e.prototype.DeleteAllChildren=function(){this.pChildrenList=[]},e.prototype.DeleteChild=function(e){null!=e&&(0===this.pChildrenList.length&&null===this.pChildrenList||r.ArrayHelper.RemoveByValue(this.pChildrenList,e))},e.prototype.UpdateName=function(){for(var e=0;e<this.pChildrenList.length;e++)this.pChildrenList[e].UpdateName();return!0},e.prototype.DetachChild=function(e){if(null!=e&&null!==this.pChildrenList)for(var t=0;t<this.pChildrenList.length;t++)this.pChildrenList[t]===e&&(e.SetParent(null),this.pChildrenList.splice(t,1))},e}(r.SceneNode);r.GroupNode=e}(M3D||(M3D={})),function(u){var r=function(){function e(){this._nearPoint=new u.Vector3,this._farPoint=new u.Vector3,this._eyeDir=new u.Vector3(0,0,1)}return e.prototype.reset=function(){this.setCamera(null),this._pickDragger=null},e.prototype.setNearFarPoints=function(e,t){this._nearPoint=e,this._farPoint=t,this._eyeDir=t.Sub(e).Clone()},e.prototype.getNearFarPoints=function(){return[this._nearPoint.Clone(),this._farPoint.Clone()]},e.prototype.contains=function(e){return this._pickDragger==e},e.prototype.setCamera=function(e){if(e){this.m_camera=e;var t=new u.Vector3,r=new u.Vector3,i=new u.Vector3,n=e.GetView().GetLookAt(t,r,i,1);t=n[0],r=n[1],this._eyeDir=t.Sub(r).Clone()}else this._eyeDir=u.Vector3.FORWARD().Clone()},e.prototype.setIntersection=function(e,t){this._pickDragger=e,this._intersectPoint=t;var r=this._pickDragger.GetWorldTransform();this._LocalIntersectPoint=r.Inverse().Multiply(t)},e.prototype.setMousePosition=function(e,t){this.projectWindowXYIntoObject(new u.Vector2(e,t),this._nearPoint,this._farPoint)},e.prototype.projectWindowXYIntoObject=function(e,t,r){if(this.m_camera){var i=this.m_camera.GetViewPort();this._nearPoint=i.ScreenToWorldPoint(e.x,e.y,0),this._farPoint=i.ScreenToWorldPoint(e.x,e.y,1)}return!0},e.prototype.getEyeDir=function(){return this._eyeDir.Clone()},e.prototype.getLocalIntersectPoint=function(){return this._LocalIntersectPoint},e.prototype.setLocalIntersectPoint=function(e){this._LocalIntersectPoint=e},e}();u.PointerInfo=r;var e=function(t){function h(){var e=t.call(this)||this;return(e._parentDragger=e)._draggerCallbacks=new Array,e._pointer=new r,e._selfUpdater=new i(e),e.preSelected=!1,e._handleEvents=!1,e._draggerActive=!1,e._activationModKeyMask=0,e._activationKeyEvent=0,e._activationPermittedByModKeyMask=!1,e._activationPermittedByKeyEvent=!1,e}return __extends(h,t),h.prototype.setParentDragger=function(e){this._parentDragger=e},h.prototype.getParentDragger=function(){return this._parentDragger},h.prototype.getComposite=function(){return null},h.prototype.setActivationModKeyMask=function(e){this._activationModKeyMask=e},h.prototype.getActivationModKeyMask=function(){return this._activationModKeyMask},h.prototype.setActivationKeyEvent=function(e){this._activationKeyEvent=e},h.prototype.getActivationKeyEvent=function(){return this._activationKeyEvent},h.prototype.getDraggerCallbacks=function(){return this._draggerCallbacks},h.prototype.setDraggerActive=function(e){this._draggerActive=e},h.prototype.getDraggerActive=function(){return this._draggerActive},h.prototype.GetScene=function(){return this._scene},h.prototype.SetScene=function(e){this._scene=e},h.prototype.GetOrigScale=function(){return this._OrigScale},h.prototype.GetNeedScale=function(){return this._needScale},h.prototype.SetNeedScale=function(e){this._needScale=e},h.prototype.GetPreSelectColor=function(){return this._PreSelectColor},h.prototype.SetPreSelectColor=function(e){this._PreSelectColor=e},h.prototype.setColor=function(e){this._color=e},h.prototype.SetVisible=function(e){t.prototype.SetVisible.call(this,e),this.SetNeedScale(!0)},h.prototype.getColor=function(){return this._color},h.prototype.setPickColor=function(e){this._pickColor=e},h.prototype.getPickColor=function(){return this._pickColor},h.prototype.GetPreSelected=function(){return this.preSelected},h.prototype.SetPreSelected=function(e){this.preSelected=e},h.prototype.ClearDraggerCallbacks=function(){for(var e=0;e<this._draggerCallbacks.length;e++)this._draggerCallbacks[e]=null;this._draggerCallbacks=new Array},h.prototype.addDraggerCallback=function(e){for(var t=0;t<this._draggerCallbacks.length;t++){if(e==this._draggerCallbacks[t])return}this._draggerCallbacks.push(e)},h.prototype.removeDraggerCallback=function(e){for(var t=0;t<this._draggerCallbacks.length;t++){if(e==this._draggerCallbacks[t])return void this._draggerCallbacks.splice(t,1)}},h.prototype.handle=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(2==e.length)return!1;for(var r=e[0],i=0;i<this.Size();i++){var n=this.GetChild(i);n&&n instanceof h&&n.handle(r)}if(r.getHandled())return!1;var o=r.GetView();if(!o)return!1;var a=!1;switch(r.getEventType()){case u.EventType.PUSH:this._pointer.reset();var s=this.GetPickDragger(o,r,this._pointer);if(s&&s==this){var l=o.GetSceneManager().GetCamera();this._pointer.setCamera(l),this._pointer.setMousePosition(r.getX(),r.getY()),s.handle(this._pointer,r),s.setDraggerActive(!0),a=!0}case u.EventType.DRAG:case u.EventType.RELEASE:this._draggerActive&&(this._pointer.setMousePosition(r.getX(),r.getY()),this.handle(this._pointer,r),a=!0)}return this._draggerActive&&r.getEventType()==u.EventType.RELEASE&&(this.setDraggerActive(!1),this._pointer.reset()),a&&r.setHandled(a),a},h.prototype.SetPreSelect=function(e){},h.prototype.receive=function(e){return null!=this._selfUpdater&&this._selfUpdater.receive(e)},h.prototype.dispatch=function(e){var t=this.getParentDragger();if(t){t.receive(e);for(var r=0;r<t.getDraggerCallbacks().length;r++){t.getDraggerCallbacks()[r].receive(e)}}},h.prototype.GetPickDragger=function(e,t,r){var i=null,n=e.GetSceneManager(),o=new u.RayPickAction(n);o.SetPickShapeType(u.ShapeType.SHAPE_MODEL),o.SetPickGeoType(0),o.SetInterctType(1),o.SetRay(t.getX(),t.getY()),o.SetUseclipPlane(!1),e.GetSceneManager().GetHandlerGroup().RayPick(o);var a=o.GetNearPickShape();a&&(a.GetType()==u.ShapeType.SHAPE_MODEL&&(i=a.GetUserData(),r.setIntersection(i,o.GetNearestPickPoint())));return o=null,i},h.prototype.SetOrigScale=function(e){this._OrigScale=e,this.SetScale(this._OrigScale)},h.prototype.FindVisiableObject=function(e){this._drawModel&&(this.getDraggerActive()?this._drawModel.SetColor(this.getPickColor()):this.GetPreSelected()?this._drawModel.SetColor(this.GetPreSelectColor()):this._drawModel.SetColor(this.getColor())),t.prototype.FindVisiableObject.call(this,e)},h}(u.GroupNode);u.Dragger=e;var t=function(){function e(){}return e.prototype.receive=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=e[0];r instanceof u.MotionCommand&&this.receive(r)},e}(),i=function(i){function e(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=i.call(this)||this;return 1==e.length?r.SetDragger(e[0]):r.SetDragger(null),r}return __extends(e,i),e.prototype.receive=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=e[0];if(r.getStage()==u.Stage.MOVE){if(r instanceof u.TranslateInLineCommand){if(this.m_dragger){var i=r.getTranslation();i=r.getLocalToWorld().Multiply(new u.Vector4(i,0)),this.m_dragger.Translate(i,u.SceneNode.TS_WORLD)}return!0}if(r instanceof u.TranslateInPlaneCommand){if(this.m_dragger){i=r.getTranslation();i=r.getLocalToWorld().Multiply(new u.Vector4(i,0)),this.m_dragger.Translate(i,u.SceneNode.TS_WORLD)}return!0}if(r instanceof u.Scale1DCommand){if(this.m_dragger){i=r.getTranslation();i=r.getLocalToWorld().Multiply(new u.Vector4(i,0))}}else if(r instanceof u.Scale2DCommand){if(this.m_dragger){i=r.getTranslation();i=r.getLocalToWorld().Multiply(new u.Vector4(i,0))}}else if(r instanceof u.ScaleUniformCommand){if(this.m_dragger){i=r.getTranslation();i=r.getLocalToWorld().Multiply(new u.Vector4(i,0))}}else if(r instanceof u.Rotate3DCommand&&this.m_dragger){var n=r.getDeltaRotation();n=r.getLocalToWorld().Rotation().Multiply(n).Multiply(r.getLocalToWorld().Rotation().Inverse()).Clone(),this.m_dragger.Rotate(n,u.SceneNode.TS_WORLD)}}return!1},e.prototype.SetDragger=function(e){this.m_dragger=e},e.prototype.GetDragger=function(){return this.m_dragger},e}(u.DraggerCallback=t);u.DraggerTransformCallback=i;var n=function(o){function e(){var e=o.call(this)||this;return e._draggerList=new Array,e}return __extends(e,o),e.prototype.getComposite=function(){return this},e.prototype.getDragger=function(e){return this._draggerList[e]},e.prototype.handle=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(1!=e.length){var r=e[0],i=e[1];if(!r.contains(this))return!1;for(var n=0;n<this._draggerList.length;n++){if(this._draggerList[n].handle(r,i))return!0}return!1}o.prototype.handle.call(this,e[0])},e.prototype.containsDragger=function(e){for(var t=0;t<this._draggerList.length;t++)if(this._draggerList[t]==e)return!0;return!1},e.prototype.findDragger=function(e){for(var t=0;t<this._draggerList.length;t++)if(this._draggerList[t]==e)return this._draggerList[t];return this._draggerList[this._draggerList.length-1]},e.prototype.CompositeDragger=function(){},e.prototype.addDragger=function(e){return!(!e||this.containsDragger(e))&&(this._draggerList.push(e),!0)},e.prototype.removeDragger=function(e){for(var t=0;t<this._draggerList.length;t++)if(this._draggerList[t]==e&&t!==this._draggerList.length-1)return this._draggerList.splice(t,1),!0;return!1},e.prototype.setParentDragger=function(e){for(var t=0;t<this._draggerList.length;t++){this._draggerList[t].setParentDragger(e)}o.prototype.setParentDragger.call(this,e)},e}(e);u.CompositeDragger=n}(M3D||(M3D={})),function(u){var e=function(t){function e(){var e=t.call(this)||this;return e.m_draggerModels=new Array,e}return __extends(e,t),e.prototype.receive=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=e[0];if(r.getStage()==u.Stage.MOVE){if(r instanceof u.TranslateInLineCommand){if(this.m_draggerModels.length){var i=r.getTranslation();i=r.getLocalToWorld().Multiply(new u.Vector4(i,0));for(var n=0;n<this.m_draggerModels.length;n++){var o=this.m_draggerModels[n];u.ModelTransformHelper.TranslateModel(o,i)}}return!0}if(r instanceof u.TranslateInPlaneCommand){if(this.m_draggerModels.length){i=r.getTranslation();i=r.getLocalToWorld().Multiply(new u.Vector4(i,0));for(n=0;n<this.m_draggerModels.length;n++){o=this.m_draggerModels[n];u.ModelTransformHelper.TranslateModel(o,i)}}return!0}if(r instanceof u.Scale1DCommand){if(this.m_draggerModels.length){var a=new u.Vector3(r.getDeltaScale(),0,0);a=r.getLocalToWorld().Rotation().Multiply(a).Add(new u.Vector3(1,1,1)).Clone();for(n=0;n<this.m_draggerModels.length;n++){o=this.m_draggerModels[n];u.ModelTransformHelper.ScaleModel(o,a)}}return!0}if(r instanceof u.Scale2DCommand){if(this.m_draggerModels.length){var s=r.getDeltaScale();a=new u.Vector3(s.x,s.y,0);a=r.getLocalToWorld().Rotation().Multiply(a).Add(new u.Vector3(1,1,1)).Clone();for(n=0;n<this.m_draggerModels.length;n++){o=this.m_draggerModels[n];u.ModelTransformHelper.ScaleModel(o,a)}}return!0}if(r instanceof u.ScaleUniformCommand){if(this.m_draggerModels.length){var l=r.getDeltaScale();a=new u.Vector3(l,l,l);a=r.getLocalToWorld().Rotation().Multiply(a).Add(new u.Vector3(1,1,1)).Clone();for(n=0;n<this.m_draggerModels.length;n++){o=this.m_draggerModels[n];u.ModelTransformHelper.ScaleModel(o,a)}}return!0}if(r instanceof u.Rotate3DCommand){if(this.m_draggerModels.length){var h=r.getDeltaRotation();h=r.getLocalToWorld().Rotation().Multiply(h).Multiply(r.getLocalToWorld().Rotation().Inverse()).Clone();for(n=0;n<this.m_draggerModels.length;n++){o=this.m_draggerModels[n];u.ModelTransformHelper.RotateModel(o,h)}}return!0}}},e.prototype.AddModel=function(e){for(var t=0;t<this.m_draggerModels.length;t++)if(this.m_draggerModels[t]==e)return!1;return this.m_draggerModels.push(e),!0},e.prototype.AddModels=function(e){for(var t=0;t<e.length;t++)this.AddModel(e[t])},e.prototype.ClearModel=function(){for(var e=0;e<this.m_draggerModels.length;e++)this.m_draggerModels[e]=null;this.m_draggerModels=new Array},e}(u.DraggerCallback);u.ModelDraggerCallback=e;var t=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.receive=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=e[0];if(r.getStage()==u.Stage.MOVE){if(r instanceof u.TranslateInLineCommand){if(this.m_draggerNodes.length){var i=r.getTranslation();i=r.getLocalToWorld().Multiply(new u.Vector4(i,0));for(var n=0;n<this.m_draggerNodes.length;n++){this.m_draggerNodes[n].Translate(i,u.SceneNode.TS_WORLD)}}return!0}if(r instanceof u.TranslateInPlaneCommand){if(this.m_draggerNodes.length){i=r.getTranslation();i=r.getLocalToWorld().Multiply(new u.Vector4(i,0));for(n=0;n<this.m_draggerNodes.length;n++){this.m_draggerNodes[n].Translate(i,u.SceneNode.TS_WORLD)}}return!0}if(r instanceof u.Scale1DCommand){if(this.m_draggerNodes.length){var o=new u.Vector3(r.getDeltaScale(),0,0);o=r.getLocalToWorld().Rotation().Multiply(o).Add(new u.Vector3(1,1,1)).Clone();for(n=0;n<this.m_draggerNodes.length;n++){this.m_draggerNodes[n].Scale(o)}}return!0}if(r instanceof u.Scale2DCommand){if(this.m_draggerNodes.length){var a=r.getDeltaScale();o=new u.Vector3(a.x,a.y,0);o=r.getLocalToWorld().Rotation().Multiply(o).Add(new u.Vector3(1,1,1)).Clone();for(n=0;n<this.m_draggerNodes.length;n++){this.m_draggerNodes[n].Scale(o)}}return!0}if(r instanceof u.ScaleUniformCommand){if(this.m_draggerNodes.length){var s=r.getDeltaScale();o=new u.Vector3(s,s,s);o=r.getLocalToWorld().Rotation().Multiply(o).Add(new u.Vector3(1,1,1)).Clone();for(n=0;n<this.m_draggerNodes.length;n++){this.m_draggerNodes[n].Scale(o)}}return!0}if(r instanceof u.Rotate3DCommand){if(this.m_draggerNodes.length){var l=r.getDeltaRotation();l=r.getLocalToWorld().Rotation().Multiply(l).Multiply(r.getLocalToWorld().Rotation().Inverse()).Clone();for(n=0;n<this.m_draggerNodes.length;n++){this.m_draggerNodes[n].Rotate(l,u.SceneNode.TS_WORLD)}}return!0}}},t.prototype.AddNode=function(e){for(var t=0;t<this.m_draggerNodes.length;t++)if(this.m_draggerNodes[t]==e)return!1;return this.m_draggerNodes.push(e),!0},t.prototype.AddNodes=function(e){for(var t=0;t<e.length;t++)this.AddNode(e[t])},t.prototype.ClearNodes=function(){for(var e=0;e<this.m_draggerNodes.length;e++)this.m_draggerNodes[e]=null;this.m_draggerNodes=new Array},t}(u.DraggerCallback);u.SceneNodeDraggerCallback=t}(M3D||(M3D={})),function(o){var e=function(){function e(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];1==e.length&&(this.m_view=e[0])}return e.prototype.GetCommandHistoryManager=function(){return this.m_commandHistoryManager},e.prototype.BindDragger=function(e,t){var r=null;switch(t){case 1:r=this.BindAxisDragger(e);break;case 2:r=this.BindRotateDragger(e);break;case 3:r=this.BindScaleDragger(e)}return r},e.prototype.UnBindDragger=function(e){return e&&(e.ClearDraggerCallbacks(),e.SetVisible(!1)),!0},e.prototype.BindSectionDragger=function(e){var t=null;switch(e){case 1:t=this.BindSectionAxisDragger();break;case 2:t=this.BindSectionRotateDragger()}return t},e.prototype.BindAxisDragger=function(e){var t=null,r=e.GetWorldBoundingBox().Center().Clone();if(this.m_view){(t=this.m_view.GetSceneManager().GetHandlerGroup().GetTransformHandler()).SetName("TranslateAxisDragger"),t.SetVisible(!0),t.SetWorldPosition(r);var i=new o.ModelDraggerCallback;i.AddModel(e),t.addDraggerCallback(i)}return t},e.prototype.BindScaleDragger=function(e){var t=null,r=e.GetWorldBoundingBox().Center().Clone();if(this.m_view){(t=this.m_view.GetSceneManager().GetHandlerGroup().GetScaleAxisDragger()).SetName("TranslateAxisDragger"),t.SetVisible(!0),t.SetWorldPosition(r);var i=new o.ModelDraggerCallback;i.AddModel(e),t.addDraggerCallback(i)}return t},e.prototype.BindRotateDragger=function(e){var t=null,r=e.GetWorldBoundingBox().Center();if(this.m_view){(t=this.m_view.GetSceneManager().GetHandlerGroup().GetRotateCylinderAxisDragger()).SetName("TranslateAxisDragger"),t.SetVisible(!0),t.SetWorldPosition(r);var i=new o.ModelDraggerCallback;i.AddModel(e),t.addDraggerCallback(i)}return t},e.prototype.BindSectionAxisDragger=function(){var e=null,t=this.m_view.GetSceneManager(),r=t.GetSceneBox().Center();if(this.m_view){(e=this.m_view.GetSceneManager().GetHandlerGroup().GetTransformHandler()).SetName("TranslateAxisDragger"),e.SetVisible(!0),e.SetWorldPosition(r);var i=new o.SceneNodeDraggerCallback,n=t.GetSectionNode();i.AddNode(n),e.addDraggerCallback(i)}return e},e.prototype.BindSectionRotateDragger=function(){var e=null,t=this.m_view.GetSceneManager(),r=t.GetSceneBox().Center();if(this.m_view){(e=this.m_view.GetSceneManager().GetHandlerGroup().GetRotateCylinderAxisDragger()).SetName("TranslateAxisDragger"),e.SetVisible(!0),e.SetWorldPosition(r);var i=new o.SceneNodeDraggerCallback,n=t.GetSectionNode();i.AddNode(n),e.addDraggerCallback(i)}return e},e}();o.DraggerManager=e}(M3D||(M3D={})),function(r){var e,t=function(t){function e(){var e=t.call(this)||this;return e.renderWorldMatrix=null,e.Mesh=null,e.SetAlloewExculding(!1),e.SetType(r.ShapeType.SHAPE_HANDLE),e.SetMesh(null),e}return __extends(e,t),e.prototype.SetRenderWorldMatrix=function(e){this.renderWorldMatrix=e.Clone()},e.prototype.GetRenderWorldMatrix=function(){return this.renderWorldMatrix},e.prototype.GetRenderColor=function(){return this.GetDrawColor()},e.prototype.GetRenderMaterial=function(){return null},e.prototype.SetRenderMesh=function(e){},e.prototype.GetDataLength=function(){return-1},e.prototype.IsUseIndex=function(){return!1},e.prototype.SetIndexOffset=function(e){},e.prototype.GetIndexOffset=function(){return-1},e.prototype.SetNormalOffset=function(e){},e.prototype.GetNormalOffset=function(){return-1},e.prototype.SetVertexOffset=function(e){},e.prototype.GetVertexOffset=function(){return-1},e.prototype.SetTextureCoordsOffset=function(e){},e.prototype.GetTextureCoordsOffset=function(){return-1},e.prototype.SetCentersCoordsOffset=function(e){},e.prototype.GetCentersCoordsOffset=function(){return-1},e.prototype.GetHardWareVertexBuffer=function(){return null},e.prototype.GetHardWareIndexBuffer=function(){return null},e.prototype.ComputeBox=function(){if(this.BoundingBox.Clear(),!this.BoundingBox.Defined()){var e=new r.BoundingBox;this.BoundingBox=e.Clone();var t=this.Mesh;null!==t&&t.GetBoundingBox().Defined()&&(e=t.GetBoundingBox(),this.BoundingBox=e.Clone())}},e.prototype.RayPick=function(e){},e.prototype.FindVisiableObject=function(e){},e.prototype.GetWorldTransform=function(){var e=this.GetSceneNode(),t=this.ComputeTransform().Clone();e&&(t=this.GetSceneNode().GetWorldTransform().Multiply(t));return t},e.prototype.SetMesh=function(e){this.Mesh=e},e.prototype.GetMesh=function(){return this.Mesh},e.prototype.ComputeTransform=function(){return r.Matrix3x4.IDENTITY().Clone()},e}(r.Shape);r.Handler=t,(e=r.EventType||(r.EventType={}))[e.NONE=0]="NONE",e[e.PUSH=1]="PUSH",e[e.RELEASE=2]="RELEASE",e[e.DOUBLECLICK=4]="DOUBLECLICK",e[e.DRAG=8]="DRAG",e[e.MOVE=16]="MOVE",e[e.KEYDOWN=32]="KEYDOWN",e[e.KEYUP=64]="KEYUP",e[e.FRAME=128]="FRAME",e[e.RESIZE=256]="RESIZE",e[e.SCROLL=512]="SCROLL",e[e.PEN_PRESSURE=1024]="PEN_PRESSURE",e[e.PEN_ORIENTATION=2048]="PEN_ORIENTATION",e[e.PEN_PROXIMITY_ENTER=4096]="PEN_PROXIMITY_ENTER",e[e.PEN_PROXIMITY_LEAVE=8192]="PEN_PROXIMITY_LEAVE",e[e.CLOSE_WINDOW=16384]="CLOSE_WINDOW",e[e.QUIT_APPLICATION=32768]="QUIT_APPLICATION",e[e.USER=65536]="USER";var i=function(){function e(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];2==e.length?(this.touchPoints=e[1],this.handled=!1,this.touchPointsData=e[0]):(this.touchPoints=0,this.handled=!1,this.touchPointsData=null)}return e.prototype.getX=function(){return 0<this.touchPoints?this.touchPointsData[0]:0},e.prototype.getY=function(){return 0<this.touchPoints?this.touchPointsData[1]:0},e.prototype.GetView=function(){return this.view},e.prototype.SetView=function(e){this.view=e},e.prototype.setHandled=function(e){this.handled=e},e.prototype.getHandled=function(){return this.handled},e.prototype.setEventType=function(e){this.eventType=e},e.prototype.getEventType=function(){return this.eventType},e}();r.MotionEvent=i}(M3D||(M3D={})),function(o){var e=function(n){function e(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=n.call(this)||this;if(r.point=null,0===e.length){var i=new o.Vector3;r.InitHandlerPoint(i,1)}else r.InitHandlerPoint(e[0],e[1]);return r}return __extends(e,n),e.prototype.RayPick=function(e){if(this.IsVisible()&&this.point){var t=this.point.GetCoordinate().Clone();e.Intersect(t)&&e.AddIntersectPnt(t)}},e.prototype.FindVisiableObject=function(e){this.IsVisible()&&(this.SetRenderWorldMatrix(e.GetGLWorldMatrix()),this.point&&(this.point.UpdateRenderData(e),e.PushRenderable(this,o.RenderableType.RGT_HANDLER)))},e.prototype.InitHandlerPoint=function(e,t){this.SetType(o.ShapeType.SHAPE_POINT_HANDLE),this.drawType=3,this.point=new o.Point(e),this.point.SetDrawType(this.drawType),this.point.SetSize(t)},e.prototype.SetDrawType=function(e){this.point&&this.point.SetDrawType(e)},e.prototype.GetPosition=function(){return this.point.GetCoordinate()},e.prototype.GetPoint=function(){return this.point},e.prototype.ComputeBox=function(){this.point&&this.SetBox(this.point.GetBoundingBox())},e}(o.Handler);o.HandlerPoint=e}(M3D||(M3D={})),function(n){var t,e,r,i;(e=t=n.Stage||(n.Stage={}))[e.NONE=0]="NONE",e[e.START=1]="START",e[e.MOVE=2]="MOVE",e[e.FINISH=3]="FINISH",(i=r=n.Type||(n.Type={}))[i.Type_NONE=0]="Type_NONE",i[i.TYPE_TRANSLATELINE=1]="TYPE_TRANSLATELINE",i[i.TYPE_TRANSLATEINPLANE=2]="TYPE_TRANSLATEINPLANE",i[i.TYPE_SCALE1D=3]="TYPE_SCALE1D",i[i.TYPE_SCALE2D=4]="TYPE_SCALE2D",i[i.TYPE_SCALEUNIFROM=5]="TYPE_SCALEUNIFROM",i[i.TYPE_ROTATE3D=6]="TYPE_ROTATE3D";var o=function(){function e(){this._stage=t.NONE,this._localToWorld=new n.Matrix3x4,this._worldToLocal=new n.Matrix3x4}return e.prototype.setLocalToWorldAndWorldToLocal=function(e,t){this._localToWorld=e.Clone(),this._worldToLocal=t.Clone()},e.prototype.getLocalToWorld=function(){return this._localToWorld.Clone()},e.prototype.getWorldToLocal=function(){return this._worldToLocal.Clone()},e.prototype.createCommandInverse=function(){},e.prototype.setStage=function(e){this._stage=e},e.prototype.getStage=function(){return this._stage},e.prototype.GetType=function(){return r.Type_NONE},e}(),a=function(i){function e(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=i.call(this)||this;return 1==e.length&&(r._plane=e[0]),r}return __extends(e,i),e.prototype.createCommandInverse=function(){},e.prototype.setPlane=function(e){this._plane=e},e.prototype.getPlane=function(){return this._plane},e.prototype.setTranslation=function(e){this._translation=e},e.prototype.getTranslation=function(){return this._translation},e.prototype.setReferencePoint=function(e){this._referencePoint=e},e.prototype.getReferencePoint=function(){return this._referencePoint},e.prototype.GetType=function(){return r.TYPE_TRANSLATEINPLANE},e}(n.MotionCommand=o);n.TranslateInPlaneCommand=a;var s=function(t){function e(){var e=t.call(this)||this;return e._deltaScale=1,e._scaleCenter=0,e._referencePoint=0,e._minScale=1,e._scale=1,e._translation=new n.Vector3,e}return __extends(e,t),e.prototype.createCommandInverse=function(){},e.prototype.setDeltaScale=function(e){this._deltaScale=e},e.prototype.getDeltaScale=function(){return this._deltaScale},e.prototype.setScaleCenter=function(e){this._scaleCenter=e},e.prototype.getScaleCenter=function(){return this._scaleCenter},e.prototype.setReferencePoint=function(e){this._referencePoint=e},e.prototype.getReferencePoint=function(){return this._referencePoint},e.prototype.setMinScale=function(e){this._minScale=e},e.prototype.getMinScale=function(){return this._minScale},e.prototype.GetType=function(){return r.TYPE_SCALE1D},e.prototype.getTranslation=function(){return this._translation},e.prototype.setTranslation=function(e){this._translation=e},e.prototype.GetScale=function(){return this._scale},e.prototype.SetScale=function(e){this._scale=e},e}(o);n.Scale1DCommand=s;var l=function(t){function e(){var e=t.call(this)||this;return e._scale=new n.Vector2(1,1),e}return __extends(e,t),e.prototype.setDeltaScale=function(e){this._scale=e},e.prototype.getDeltaScale=function(){return this._scale},e.prototype.setScaleCenter=function(e){this._scaleCenter=e},e.prototype.getScaleCenter=function(){return this._scaleCenter},e.prototype.setReferencePoint=function(e){this._referencePoint=e},e.prototype.getReferencePoint=function(){return this._referencePoint},e.prototype.setMinScale=function(e){this._minScale=e},e.prototype.getMinScale=function(){return this._minScale},e.prototype.GetType=function(){return r.TYPE_SCALE2D},e.prototype.getTranslation=function(){return this._translation},e.prototype.setTranslation=function(e){this._translation=e},e.prototype.createCommandInverse=function(){},e}(o);n.Scale2DCommand=l;var h=function(t){function e(){var e=t.call(this)||this;return e._scale=1,e._scaleCenter=new n.Vector3,e._translation=new n.Vector3,e}return __extends(e,t),e.prototype.setDeltaScale=function(e){this._scale=e},e.prototype.getDeltaScale=function(){return this._scale},e.prototype.setScaleCenter=function(e){this._scaleCenter=e},e.prototype.getScaleCenter=function(){return this._scaleCenter},e.prototype.GetType=function(){return r.TYPE_SCALEUNIFROM},e.prototype.getTranslation=function(){return this._translation.Clone()},e.prototype.setTranslation=function(e){this._translation=e},e.prototype.createCommandInverse=function(){},e}(o);n.ScaleUniformCommand=h;var u=function(t){function e(){var e=t.call(this)||this;return e._rotation=new n.Quaternion,e._deltarotation=new n.Quaternion,e}return __extends(e,t),e.prototype.setRotation=function(e){this._rotation=e},e.prototype.getRotation=function(){return this._rotation},e.prototype.setDeltaRotation=function(e){this._deltarotation=e.Clone()},e.prototype.getDeltaRotation=function(){return this._deltarotation.Clone()},e.prototype.GetType=function(){return r.TYPE_ROTATE3D},e.prototype.createCommandInverse=function(){},e}(o);n.Rotate3DCommand=u;var p=function(i){function e(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=i.call(this)||this;return 2==e.length&&(r._line=new n.Line3D(e[0],e[1])),r._translation=new n.Vector3,r}return __extends(e,i),e.prototype.createCommandInverse=function(){},e.prototype.setLine=function(e,t){this._line.StartPoint=e,this._line.EndPoint=t},e.prototype.getLineStart=function(){return this._line.StartPoint},e.prototype.getLineEnd=function(){return this._line.EndPoint},e.prototype.setTranslation=function(e){this._translation=e},e.prototype.getTranslation=function(){return this._translation},e.prototype.GetType=function(){return r.TYPE_TRANSLATELINE},e}(o);n.TranslateInLineCommand=p}(M3D||(M3D={})),function(T){var M=function(){function d(){}return d.computeClosestPoints=function(e,t,r,i){var n=e.GetEndPoint().Sub(e.GetPosition()).Clone();n.Normalize();var o=t.GetEndPoint().Sub(t.GetPosition()).Clone();o.Normalize();var a=e.GetPosition().Sub(t.GetPosition()).Clone(),s=n.DotProduct(n),l=n.DotProduct(o),h=o.DotProduct(o),u=n.DotProduct(a),p=o.DotProduct(a),c=s*h-l*l;if(Math.abs(c)<1e-5)return!1;var d=(l*p-h*u)/c,S=(s*p-l*u)/c;return[!0,e.GetPosition().Add(n.Multiply(d).Clone()).Clone(),t.GetPosition().Add(o.Multiply(S).Clone()).Clone()]},d.getPlaneLineIntersection=function(e,t,r,i){var n=r.x-t.x,o=r.y-t.y,a=r.z-t.z,s=e.Data(),l=s[0]*n+s[1]*o+s[2]*a;if(!l)return[!1,new T.Vector3];var h=(s[0]*t.x+s[1]*t.y+s[2]*t.z+s[3])/l;return i.x=t.x-n*h,i.y=t.y-o*h,i.z=t.z-a*h,[!0,i]},d.computeClosestPointOnLine=function(e,t,r,i){var n=t.Sub(e).Clone(),o=r.Sub(e).Clone().DotProduct(n),a=n.DotProduct(n);if(a<1e-6)return!1;var s=o/a;return[!0,e.Add(n.Multiply(s))]},d.getSphereLineIntersection=function(e,t,r,i,n){var o=r.Sub(t).Clone();o.Normalize();var a=t.Sub(e.GetCenter()).Clone(),s=2*o.DotProduct(a),l=s*s-4*(a.DotProduct(a)-e.GetRadius()*e.GetRadius());if(l<0)return!1;var h=Math.sqrt(l),u=.5*(-s-h),p=.5*(-s+h);return[!0,t.Add(o.Multiply(u).Clone()).Clone(),t.Add(o.Multiply(p).Clone()).Clone()]},d.getUnitCylinderLineIntersection=function(e,t,r,i){var n=t.Sub(e).Clone();n.Normalize();var o=n.Data()[0]*n.Data()[0]+n.Data()[1]*n.Data()[1],a=2*(e.Data()[0]*n.Data()[0]+e.Data()[1]*n.Data()[1]),s=e.Data()[0]*e.Data()[0]+e.Data()[1]*e.Data()[1]-1,l=a*a-4*o*s;if(l<0)return[!1,r,i];var h,u,p=Math.sqrt(l);return u=0<a?(h=-2*s/(p+a),-(p+a)/(2*o)):(h=2*s/(p-a),(p-a)/(2*o)),[!0,r=e.Add(n.Multiply(h).Clone()).Clone(),i=e.Add(n.Multiply(u).Clone()).Clone()]},d.getCylinderLineIntersection=function(e,t,r,i,n){var o=1/e.GetRadius(),a=new T.Matrix3x4;a.MultiRotatiton(e.GetRotation().Inverse()),a.MultiScale(o),a.MultiTranslate(e.GetCenter().NagativeED().Clone());var s=a.Multiply(t).Clone(),l=a.Multiply(r).Clone(),h=new T.Vector3,u=new T.Vector3,p=d.getUnitCylinderLineIntersection(s,l,h,u);if(!p[0])return[!1,i,n];h=p[1],u=p[2];var c=a.Inverse();return[!0,i=c.Multiply(h).Clone(),n=c.Multiply(u).Clone()]},d.getLocalEyeDirection=function(e,t){var r=t.Multiply(new T.Vector4(e,0)).Clone();return r.Normalize(),r},d.computePlaneThruPointAndOrientedToEye=function(e,t,r,i){var n=d.getLocalEyeDirection(e,t);return i||(n=n.NagativeED()),new T.Plane(n,r)},d.computePlaneParallelToAxisAndOrientedToEye=function(e,t,r,i,n,o,a){var s=r.CrossProduct(d.getLocalEyeDirection(e,t)).CrossProduct(r);s.Normalize(),a||(s=s.NagativeED());var l=s.Multiply(i).Clone().Add(r).Clone();return[new T.Plane(s,l),l.Clone(),l.Add(r).Clone()]},d}();T.ProjectorHelper=M;var e=function(){function e(){this._worldToLocalDirty=!1}return e.prototype.setLocalToWorld=function(e){this._localToWorld=e.Clone(),this._worldToLocalDirty=!0},e.prototype.getLocalToWorld=function(){return this._localToWorld.Clone()},e.prototype.getWorldToLocal=function(){return this._worldToLocalDirty&&(this._worldToLocal=this._localToWorld.Inverse().Clone(),this._worldToLocalDirty=!1),this._worldToLocal.Clone()},e}(),t=function(i){function e(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=i.call(this)||this;return 0==e.length?r._line=new T.Line3D(new T.Vector3(0,0,0),new T.Vector3(0,0,0)):r._line=new T.Line3D(e[0],e[1]),r}return __extends(e,i),e.prototype.setLine=function(e,t){this._line.StartPoint=e,this._line.EndPoint=t},e.prototype.getLineStart=function(){return this._line.StartPoint},e.prototype.getLineEnd=function(){return this._line.EndPoint},e.prototype.setLineEnd=function(e){this._line.EndPoint=e.Clone()},e.prototype.setLineStart=function(e){this._line.StartPoint=e.Clone()},e.prototype.project=function(e,t){var r=this.getLocalToWorld().Multiply(this._line.GetPosition()).Clone(),i=this.getLocalToWorld().Multiply(this._line.GetEndPoint()).Clone(),n=new T.Line3D(r,i),o=e.getNearFarPoints(),a=o[0].Clone(),s=o[1].Clone(),l=new T.Line3D(a,s),h=new T.Vector3,u=new T.Vector3,p=M.computeClosestPoints(n,l,h,u);if(!p[0])return!1;var c=p[1];return[!0,this.getWorldToLocal().Multiply(c).Clone().Clone()]},e}(T.Projector=e);T.LineProjector=t;var r=function(i){function e(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=i.call(this)||this;return 1==e.length&&(r._plane=e[0].Clone()),r}return __extends(e,i),e.prototype.setPlane=function(e){this._plane=e.Clone()},e.prototype.getPlane=function(){return this._plane},e.prototype.project=function(e,t){var r=e.getNearFarPoints(),i=r[0].Clone(),n=r[1].Clone(),o=new T.Vector3,a=new T.Vector3;return o=this.getWorldToLocal().Multiply(i).Clone(),a=this.getWorldToLocal().Multiply(n).Clone(),M.getPlaneLineIntersection(this._plane.ToVector4(),o,a,t)},e}(e);T.PlaneProjector=r;var i=function(i){function e(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=i.call(this)||this;return 1==e.length?r._sphere=e[0]:r._sphere=new T.Sphere,r}return __extends(e,i),e.prototype.project=function(e,t){if(!this._sphere)return!1;var r=e.getNearFarPoints(),i=r[0].Clone(),n=r[1].Clone(),o=new T.Vector3,a=new T.Vector3;o=this.getWorldToLocal().Multiply(i).Clone(),a=this.getWorldToLocal().Multiply(n).Clone();var s,l=new T.Vector3;return this._front?[(s=M.getSphereLineIntersection(this._sphere,o,a,t,l))[0],s[1]]:[(s=M.getSphereLineIntersection(this._sphere,o,a,l,t))[0],s[2]]},e.prototype.isPointInFront=function(e,t){return!(this.getSphere().GetCenter().Sub(e.getLocalIntersectPoint()).Clone().DotProduct(M.getLocalEyeDirection(e.getEyeDir(),t))<0)},e.prototype.getSphere=function(){return this._sphere},e.prototype.setSphere=function(e){this._sphere=e},e.prototype.setFront=function(e){this._front=e},e}(e),n=function(r){function e(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return 0==e.length?r.call(this)||this:r.call(this,e[0])||this}return __extends(e,r),e.prototype.isProjectionOnSphere=function(){return this._onSphere},e.prototype.getRotation=function(e,t,r,i,n){if(t&&i){return this._front?new T.Quaternion(e.Sub(this.getSphere().GetCenter()).Clone(),r.Sub(this.getSphere().GetCenter()).Clone()):new T.Quaternion(r.Sub(this.getSphere().GetCenter()).Clone(),e.Sub(this.getSphere().GetCenter()).Clone())}if(t||i){var o=this.getSphere().GetCenter(),a=new T.Vector3,s=new T.Vector3;a=(t?M.getSphereLineIntersection(this.getSphere(),r,o,a,s):M.getSphereLineIntersection(this.getSphere(),e,o,a,s))[1];return t?new T.Quaternion(e.Sub(this.getSphere().GetCenter()).Clone(),a.Sub(this.getSphere().GetCenter()).Clone()):new T.Quaternion(a.Sub(this.getSphere().GetCenter()).Clone(),r.Sub(this.getSphere().GetCenter())).Clone()}new T.Quaternion(e.Sub(this.getSphere().GetCenter()).Clone(),r.Sub(this.getSphere().GetCenter()).Clone());var l=new T.Vector3;new T.Quaternion(void 0,l);var h=void 0;h=(l.DotProduct(this._plane.normal),this._plane.normal.Clone());var u=new T.Quaternion(void 0,h),p=e.Sub(this.getSphere().GetCenter()).Clone(),c=(r.Sub(this.getSphere().GetCenter()).Clone().Length()-p.Length())/this.getSphere().GetRadius();if(Math.abs(c)<1e-6||1<Math.abs(c))return u;p.Normalize();var d=p.CrossProduct(this._plane.normal.Clone());return d.Normalize(),new T.Quaternion(n*c,d).Multiply(u).Clone()},e.prototype.project=function(e,t){if(!this._sphere)return!1;var r=e.getNearFarPoints(),i=r[0].Clone(),n=r[1].Clone(),o=new T.Vector3,a=new T.Vector3;o=this.getWorldToLocal().Multiply(i).Clone(),a=this.getWorldToLocal().Multiply(n).Clone();var s,l=new T.Vector3,h=new T.Vector3;l=this._front?(s=M.getSphereLineIntersection(this._sphere,o,a,l,h))[1]:(s=M.getSphereLineIntersection(this._sphere,o,a,h,l))[2],this._plane=M.computePlaneThruPointAndOrientedToEye(e.getEyeDir(),this.getLocalToWorld(),this.getSphere().GetCenter().Clone(),this._front);var u=new T.Vector3;if(s[0]){var p=M.getPlaneLineIntersection(this._plane.ToVector4(),l,l.Add(this._plane.normal).Clone(),u);if(!p[0])return p}else{var c=M.getPlaneLineIntersection(this._plane.ToVector4(),o,a,u);if(!c[0])return c}if(u.Sub(this.getSphere().GetCenter()).Clone().Length()<this.getSphere().GetRadius()){if(!s)return[!1,u];l,this._onSphere=!0}else u,this._onSphere=!1;return[!0,u]},e}(T.SphereProjector=i);T.SpherePlaneProjector=n;var o=function(i){function e(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=i.call(this)||this;return r._front=!0,1==e.length?r.setCylinder(e[0]):(r._cylinder=new T.Cylinder,r._cylinderAxis=new T.Vector3(0,0,1)),r}return __extends(e,i),e.prototype.setFront=function(e){this._front=e},e.prototype.getCylinder=function(){return this._cylinder},e.prototype.setCylinder=function(e){this._cylinder=e,this._cylinderAxis=e.GetRotation().Multiply(new T.Vector3(0,0,1)),this._cylinderAxis.Normalize()},e.prototype.project=function(e,t){if(!this._cylinder)return!1;var r,i,n=e.getNearFarPoints(),o=n[0].Clone(),a=n[1].Clone();r=this.getWorldToLocal().Multiply(o).Clone(),i=this.getWorldToLocal().Multiply(a).Clone();var s=new T.Vector3,l=M.getCylinderLineIntersection(this._cylinder,r,i,t,s);return[l[0],l[1]]},e.prototype.isPointInFront=function(e,t){var r=new T.Vector3;return r=M.computeClosestPointOnLine(this.getCylinder().GetCenter().Clone(),this.getCylinder().GetCenter().Add(this._cylinderAxis).Clone(),e.getLocalIntersectPoint(),r)[1],!(e.getLocalIntersectPoint().Sub(r).Clone().DotProduct(M.getLocalEyeDirection(e.getEyeDir(),t))<0)},e}(e),a=function(r){function e(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return 1==e.length?r.call(this,e[0])||this:r.call(this)||this}return __extends(e,r),e.prototype.isProjectionOnCylinder=function(){return this._onCylinder},e.prototype.project=function(e,t){if(!this._cylinder)return!1;var r,i,n=e.getNearFarPoints(),o=n[0].Clone(),a=n[1].Clone();r=this.getWorldToLocal().Multiply(o).Clone(),i=this.getWorldToLocal().Multiply(a).Clone();var s,l=new T.Vector3,h=new T.Vector3;h=this._front?(l=(s=M.getCylinderLineIntersection(this._cylinder,r,i,l,h))[1],s[2]):(l=(s=M.getCylinderLineIntersection(this._cylinder,r,i,h,l))[2],s[1]);var u=M.computePlaneParallelToAxisAndOrientedToEye(e.getEyeDir(),this.getLocalToWorld(),this._cylinderAxis,this.getCylinder().GetRadius(),this._planeLineStart,this._planeLineEnd,this._front);this._plane=u[0],this._planeLineStart=u[1],this._planeLineEnd=u[2];var p=new T.Vector3,c=M.getPlaneLineIntersection(this._plane.ToVector4(),r,i,p);if(p=c[1],s[0]){var d=new T.Vector3;d=(c=M.getPlaneLineIntersection(this._plane.ToVector4(),l,l.Add(this._plane.normal).Clone(),d))[1];var S=new T.Vector3;if(S=M.computeClosestPointOnLine(this.getCylinder().GetCenter(),this.getCylinder().GetCenter().Add(this._cylinderAxis).Clone(),d,S)[1],d.Sub(S).Clone().Length()<this.getCylinder().GetRadius()){if(!s[0])return!1;t=l,this._onCylinder=!0}else t=p,this._onCylinder=!1}else t=p,this._onCylinder=!1;return[!0,t]},e.prototype.getRotation=function(e,t,r,i){if(t&&i){var n=new T.Vector3,o=new T.Vector3;n=M.computeClosestPointOnLine(this.getCylinder().GetCenter().Clone(),this.getCylinder().GetCenter().Add(this._cylinderAxis.Multiply(this.getCylinder().GetHeight()).Clone()),e,n)[1],o=M.computeClosestPointOnLine(this.getCylinder().GetCenter().Clone(),this.getCylinder().GetCenter().Add(this._cylinderAxis.Multiply(this.getCylinder().GetHeight()).Clone()),r,o)[1];var a=e.Sub(n).Clone(),s=r.Sub(o).Clone(),l=a.DotProduct(s)/(a.Length()*s.Length());if(1<l||l<-1)return new T.Quaternion;var h=Math.acos(l),u=a.CrossProduct(s);return new T.Quaternion(h/T.DEGTORAD,u)}if(t||i){var p=t?r:e,c=new T.Vector3;c=M.computeClosestPointOnLine(this._planeLineStart,this._planeLineEnd,p,c)[1];var d=p.Sub(c).Clone();d.Normalize();var S=c.Add(d.Multiply(this.getCylinder().GetRadius()).Clone()).Clone();return t?this.getRotation(S,!1,r,!1).Multiply(this.getRotation(e,!0,S,!0)).Clone():this.getRotation(S,!0,r,!0).Multiply(this.getRotation(e,!1,S,!1).Clone())}var f=new T.Vector3,m=new T.Vector3;f=M.computeClosestPointOnLine(this._planeLineStart,this._planeLineEnd,e,f)[1],m=M.computeClosestPointOnLine(this._planeLineStart,this._planeLineEnd,r,m)[1];a=e.Sub(f).Clone();var y=(s=r.Sub(m).Clone()).Sub(a).Clone().Length();h=0===this.getCylinder().GetRadius()?0:y/this.getCylinder().GetRadius(),u=this._plane.normal.CrossProduct(a);return s.Length()>a.Length()?new T.Quaternion(h/T.DEGTORAD,u):new T.Quaternion(-h/T.DEGTORAD,u)},e}(T.CylinderProjector=o);T.CylinderPlaneProjector=a}(M3D||(M3D={})),function(r){var e=function(t){function e(){var e=t.call(this)||this;return e._xDragger=new r.RotateCylinderDragger,e.AddChild(e._xDragger),e.addDragger(e._xDragger),e._yDragger=new r.RotateCylinderDragger,e.AddChild(e._yDragger),e.addDragger(e._yDragger),e._zDragger=new r.RotateCylinderDragger,e.AddChild(e._zDragger),e.addDragger(e._zDragger),e.setParentDragger(e.getParentDragger()),e}return __extends(e,t),e.prototype.setupDefaultGeometry=function(){this._xDragger.setupDefaultGeometry(),this._yDragger.setupDefaultGeometry(),this._zDragger.setupDefaultGeometry();var e=new r.Quaternion(new r.Vector3(0,0,1),new r.Vector3(1,0,0));this._xDragger.SetRotation(e);e=new r.Quaternion(new r.Vector3(0,0,1),new r.Vector3(0,1,0));this._yDragger.SetRotation(e),this._xDragger.setColor(new r.Color(1,0,0,1)),this._yDragger.setColor(new r.Color(0,1,0,1)),this._zDragger.setColor(new r.Color(0,0,1,1)),this._xDragger.setPickColor(r.Color.YELLOW().Clone()),this._yDragger.setPickColor(r.Color.YELLOW().Clone()),this._zDragger.setPickColor(r.Color.YELLOW().Clone()),this._xDragger.SetPreSelectColor(r.Color.YELLOW().Clone()),this._yDragger.SetPreSelectColor(r.Color.YELLOW().Clone()),this._zDragger.SetPreSelectColor(r.Color.YELLOW().Clone())},e}(r.CompositeDragger);r.RotateCylinderAxisDragger=e}(M3D||(M3D={})),function(c){var e=function(p){function e(){var e=p.call(this)||this;return e._drawModel=null,e._projector=new c.CylinderPlaneProjector,e.setColor(new c.Color(0,1,0,1)),e.setPickColor(new c.Color(1,1,0,1)),e}return __extends(e,p),e.prototype.handle=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(2==e.length){var r=e[1],i=e[0];switch(r.getEventType()){case c.EventType.PUSH:var n=this.GetWorldTransform();this._projector.setLocalToWorld(n),this._startLocalToWorld=this._projector.getLocalToWorld().Clone(),this._startWorldToLocal=this._projector.getWorldToLocal().Clone(),this._projector.isPointInFront(i,this._startLocalToWorld)?this._projector.setFront(!0):this._projector.setFront(!1);var o=new c.Vector3;if((a=this._projector.project(i,o))[0])o=a[1].Clone(),(u=new c.Rotate3DCommand).setStage(c.Stage.START),u.setLocalToWorldAndWorldToLocal(this._startLocalToWorld,this._startWorldToLocal),this.dispatch(u),this._prevWorldProjPt=o.Clone(),this._prevRotation=new c.Quaternion,this._prevPtOnCylinder=this._projector.isProjectionOnCylinder();return!0;case c.EventType.DRAG:var a;n=this.GetWorldTransform(),o=new c.Vector3;if((a=this._projector.project(i,o))[0]){o=a[1].Clone();var s=this._prevWorldProjPt.Clone(),l=this._projector.getRotation(s,this._prevPtOnCylinder,o,this._projector.isProjectionOnCylinder()),h=this._prevRotation.Multiply(l).Clone();s.Sub(o).Clone().Length();(u=new c.Rotate3DCommand).setStage(c.Stage.MOVE),u.setLocalToWorldAndWorldToLocal(this._startLocalToWorld,this._startWorldToLocal),u.setRotation(h),u.setDeltaRotation(l),this.dispatch(u),this._prevWorldProjPt=o.Clone(),this._prevRotation=h,this._prevPtOnCylinder=this._projector.isProjectionOnCylinder()}return!0;case c.EventType.RELEASE:var u;return(u=new c.Rotate3DCommand).setStage(c.Stage.FINISH),u.setLocalToWorldAndWorldToLocal(this._startLocalToWorld,this._startWorldToLocal),this.dispatch(u),!0;default:return!1}}else p.prototype.handle.call(this,e[0])},e.prototype.setupDefaultGeometry=function(){var i=this;this._drawModel=null,c.MeshHelper.ReadSingleModel("CyicleXYHandler.stl",this._drawModel,function(e,t){if(t){i._drawModel=t,i._drawModel.SetAlloewExculding(!1);var r=new c.ShapeNode;i.AddChild(r),r.SetShape(i._drawModel),i._drawModel.SetInitHightlight(!0),i._drawModel.SetUserData(i)}})},e}(c.Dragger);c.RotateCylinderDragger=e}(M3D||(M3D={})),function(c){var e=function(p){function e(){var e=p.call(this)||this;return e._prevPtOnSphere=!0,e._projector=new c.SpherePlaneProjector,e.setColor(new c.Color(0,1,0,1)),e.setPickColor(new c.Color(1,1,0,1)),e}return __extends(e,p),e.prototype.getPickColor=function(){return this._pickColor},e.prototype.setPickColor=function(e){this._pickColor=e},e.prototype.getColor=function(){return this._color},e.prototype.setColor=function(e){this._color=e},e.prototype.handle=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(2==e.length){var r=e[1],i=e[0];if(!i.contains(this))return!1;switch(r.getEventType()){case c.EventType.PUSH:var n=this.GetWorldTransform();this._projector.setLocalToWorld(n),this._startLocalToWorld=this._projector.getLocalToWorld(),this._startWorldToLocal=this._projector.getWorldToLocal(),this._projector.isPointInFront(i,this._startLocalToWorld)?this._projector.setFront(!0):this._projector.setFront(!1);var o=new c.Vector3;if((s=this._projector.project(i,o))[0])o=s[1].Clone(),(u=new c.Rotate3DCommand).setStage(c.Stage.START),u.setLocalToWorldAndWorldToLocal(this._startLocalToWorld,this._startWorldToLocal),this.dispatch(u),this._prevRotation=new c.Quaternion,this._prevWorldProjPt=this._projector.getLocalToWorld().Multiply(o).Clone(),this._prevPtOnSphere=this._projector.isProjectionOnSphere();return!0;case c.EventType.DRAG:var a=new c.Matrix3x4;a.SetRotation(this._prevRotation.RotationMatrix());n=this._startLocalToWorld.Multiply(a).Clone();this._projector.setLocalToWorld(n);var s;o=new c.Vector3;if((s=this._projector.project(i,o))[0]){o=s[1].Clone();var l=this._projector.getWorldToLocal().Multiply(this._prevWorldProjPt).Clone(),h=this._projector.getRotation(l,this._prevPtOnSphere,o,this._projector.isProjectionOnSphere(),1).Multiply(this._prevRotation).Clone();(u=new c.Rotate3DCommand).setStage(c.Stage.MOVE),u.setLocalToWorldAndWorldToLocal(this._startLocalToWorld,this._startWorldToLocal),u.setRotation(h),this.dispatch(u),this._prevWorldProjPt=this._projector.getLocalToWorld().Multiply(o).Clone(),this._prevRotation=h,this._prevPtOnSphere=this._projector.isProjectionOnSphere()}return!0;case c.EventType.RELEASE:var u;return(u=new c.Rotate3DCommand).setStage(c.Stage.FINISH),u.setLocalToWorldAndWorldToLocal(this._startLocalToWorld,this._startWorldToLocal),this.dispatch(u),!0;default:return!1}}else p.prototype.handle.call(this,e[0])},e.prototype.setupDefaultGeometry=function(){},e}(c.Dragger);c.RotateSphereDragger=e}(M3D||(M3D={})),function(c){var e;(e=c.ScaleMode||(c.ScaleMode={}))[e.SCALE_WITH_ORIGIN_AS_PIVOT=0]="SCALE_WITH_ORIGIN_AS_PIVOT",e[e.SCALE_WITH_OPPOSITE_HANDLE_AS_PIVOT=1]="SCALE_WITH_OPPOSITE_HANDLE_AS_PIVOT";var d=function(){function e(){}return e.computeScale=function(e,t,r){var i=e.Data()[0]-r;return i?(t.Data()[0]-r)/i:1},e}();c.Scale1DDraggerHelper=d;var t=function(p){function e(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=p.call(this)||this;return r._drawModel=null,r._projector=new c.LineProjector(new c.Vector3(-.5,0,0),new c.Vector3(.5,0,0)),r.setColor(new c.Color(0,1,0,1)),r.setPickColor(new c.Color(1,1,0,1)),r.SetScales(0),r._minScale=.001,1==e.length?r._scaleMode=e[0]:r._scaleMode=0,r}return __extends(e,p),e.prototype.setLeftHandlePosition=function(e){this._projector.setLineStart(new c.Vector3(e,0,0))},e.prototype.getLeftHandlePosition=function(){return this._projector.getLineStart().Data()[0]},e.prototype.setRightHandlePosition=function(e){this._projector.setLineEnd(new c.Vector3(e,0,0))},e.prototype.getRightHandlePosition=function(){return this._projector.getLineEnd().Data()[0]},e.prototype.setMinScale=function(e){this._minScale=e},e.prototype.getMinScale=function(){return this._minScale},e.prototype.GetScales=function(){return this._scale},e.prototype.SetScales=function(e){this._scale=e},e.prototype.handle=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(2==e.length){var r=e[1],i=e[0];if(!i.contains(this))return!1;switch(r.getEventType()){case c.EventType.PUSH:this._priProjectedPoint=c.Vector3.ZERO().Clone();var n=this.GetWorldTransform();if(this._projector.setLocalToWorld(n),(a=this._projector.project(i,this._startProjectedPoint))[0])this._startProjectedPoint=a[1],this.SetScales(0),this._scaleCenter=0,(s=new c.Scale1DCommand).setStage(c.Stage.START),s.setLocalToWorldAndWorldToLocal(this._projector.getLocalToWorld(),this._projector.getWorldToLocal()),this._priProjectedPoint=this._startProjectedPoint,this.dispatch(s);return!0;case c.EventType.DRAG:var o,a;n=this.GetWorldTransform();if(this._projector.setLocalToWorld(n),(a=this._projector.project(i,o))[0]){o=a[1];var s=new c.Scale1DCommand,l=o.Sub(this._priProjectedPoint).Clone(),h=d.computeScale(this._startProjectedPoint,this._priProjectedPoint,this._scaleCenter);this._priProjectedPoint=o;var u=d.computeScale(this._startProjectedPoint,o,this._scaleCenter)-h;this.SetScales(this.GetScales()+u),s.setStage(c.Stage.MOVE),s.setLocalToWorldAndWorldToLocal(this._projector.getLocalToWorld(),this._projector.getWorldToLocal()),s.setDeltaScale(u),s.SetScale(this.GetScales()),s.setScaleCenter(this._scaleCenter),s.setMinScale(this.getMinScale()),s.setTranslation(l),this.dispatch(s)}return!0;case c.EventType.RELEASE:return(s=new c.Scale1DCommand).setStage(c.Stage.FINISH),s.setLocalToWorldAndWorldToLocal(this._projector.getLocalToWorld(),this._projector.getWorldToLocal()),this.dispatch(s),!0;default:return!1}}else p.prototype.handle.call(this,e[0])},e.prototype.setupDefaultGeometry=function(){var i=this;this._drawModel=null,c.MeshHelper.ReadSingleModel("ScaleHandler.stl",this._drawModel,function(e,t){if(t){i._drawModel=t,i._drawModel.SetAlloewExculding(!1);var r=new c.ShapeNode;i.AddChild(r),r.SetShape(i._drawModel),i._drawModel.SetInitHightlight(!0),i._drawModel.SetUserData(i)}})},e}(c.Dragger);c.Scale1DDragger=t}(M3D||(M3D={})),function(u){var p=function(){function e(){}return e.computeScale=function(e,t,r){var i=new u.Vector2(1,1);return e.Data()[0]-r.Data()[0]!=0&&(i.x=(t.Data()[0]-r.Data()[0])/(e.Data()[0]-r.Data()[0])),e.Data()[2]-r.Data()[1]!=0&&(i.y=(t.Data()[2]-r.Data()[1])/(e.Data()[2]-r.Data()[1])),i},e}();u.Scale2DDrageerHelper=p;var e=function(h){function e(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=h.call(this)||this;return r._projector=new u.PlaneProjector(new u.Plane(new u.Vector3(0,1,0),0)),r.setColor(new u.Color(0,1,0,1)),r.setPickColor(new u.Color(1,1,0,1)),r._topLeftHandlePosition=new u.Vector2(-.5,.5),r._bottomLeftHandlePosition=new u.Vector2(-.5,-.5),r._bottomRightHandlePosition=new u.Vector2(.5,-.5),r._topRightHandlePosition=new u.Vector2(.5,.5),r._minScale=new u.Vector2(.001,.001),1==e.length&&(r._scaleMode=e[0]),r}return __extends(e,h),e.prototype.setTopLeftHandlePosition=function(e){this._topLeftHandlePosition=e},e.prototype.getTopLeftHandlePosition=function(){return this._topLeftHandlePosition},e.prototype.setBottomLeftHandlePosition=function(e){this._bottomLeftHandlePosition=e},e.prototype.getBottomLeftHandlePosition=function(){return this._bottomLeftHandlePosition},e.prototype.setTopRightHandlePosition=function(e){this._topRightHandlePosition=e},e.prototype.getTopRightHandlePosition=function(){return this._topRightHandlePosition},e.prototype.setBottomRightHandlePosition=function(e){this._bottomRightHandlePosition=e},e.prototype.getBottomRightHandlePosition=function(){return this._bottomRightHandlePosition},e.prototype.setPickColor=function(e){this._pickColor=e},e.prototype.getPickColor=function(){return this._pickColor},e.prototype.setColor=function(e){this._color=e},e.prototype.getColor=function(){return this._color},e.prototype.setMinScale=function(e){this._minScale=e},e.prototype.getMinScale=function(){return this._minScale},e.prototype.handle=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(2==e.length){var r=e[1],i=e[0];if(!i.contains(this))return!1;switch(r.getEventType()){case u.EventType.PUSH:var n=this.GetWorldTransform();if(this._projector.setLocalToWorld(n),(o=this._projector.project(i,this._startProjectedPoint))[0])this._startProjectedPoint=o[1],this._scaleCenter=new u.Vector2(0,0),(l=new u.Scale2DCommand).setStage(u.Stage.START),l.setLocalToWorldAndWorldToLocal(this._projector.getLocalToWorld(),this._projector.getWorldToLocal()),l.setReferencePoint(this._referencePoint),this.dispatch(l);return!0;case u.EventType.DRAG:n=this.GetWorldTransform();this._projector.setLocalToWorld(n);var o,a=new u.Vector3;if((o=this._projector.project(i,a))[0]){a=o[1];var s=p.computeScale(this._startProjectedPoint,a,this._scaleCenter);s.Data()[0]<this.getMinScale().Data()[0]&&(s.x=this.getMinScale().Data()[0]),s.Data()[1]<this.getMinScale().Data()[1]&&(s.y=this.getMinScale().Data()[1]),(l=new u.Scale2DCommand).setStage(u.Stage.MOVE),l.setLocalToWorldAndWorldToLocal(this._projector.getLocalToWorld(),this._projector.getWorldToLocal()),l.setDeltaScale(s),l.setScaleCenter(this._scaleCenter),l.setReferencePoint(this._referencePoint),l.setMinScale(this.getMinScale()),this.dispatch(l)}return!0;case u.EventType.RELEASE:var l;return(l=new u.Scale2DCommand).setStage(u.Stage.FINISH),l.setReferencePoint(this._referencePoint),l.setLocalToWorldAndWorldToLocal(this._projector.getLocalToWorld(),this._projector.getWorldToLocal()),this.dispatch(l),!0;default:return!1}}else h.prototype.handle.call(this,e[0])},e.prototype.setupDefaultGeometry=function(){var i=this,n=null;u.MeshHelper.ReadSingleModel("PlanXYHandler.stl",n,function(e,t){if(t){n=t,i._drawModel.SetAlloewExculding(!1);var r=new u.ShapeNode;i.AddChild(r),r.SetShape(n),n.SetUserData(i)}})},e}(u.Dragger);u.Scale2DDragger=e}(M3D||(M3D={})),function(r){var e=function(t){function e(){var e=t.call(this)||this;return e._xDragger=new r.Scale1DDragger,e.comPositeDragger=new r.CompositeDragger,e.comPositeDragger.AddChild(e._xDragger),e.comPositeDragger.addDragger(e._xDragger),e.AddChild(e.comPositeDragger),e.comPositeDragger.setParentDragger(e.comPositeDragger.getParentDragger()),e.comPositeDragger1=new r.CompositeDragger,e._yDragger=new r.Scale1DDragger,e.comPositeDragger1.AddChild(e._yDragger),e.comPositeDragger1.addDragger(e._yDragger),e.AddChild(e.comPositeDragger1),e.comPositeDragger1.setParentDragger(e.comPositeDragger1.getParentDragger()),e.comPositeDragger2=new r.CompositeDragger,e._zDragger=new r.Scale1DDragger,e.comPositeDragger2.AddChild(e._zDragger),e.comPositeDragger2.addDragger(e._zDragger),e.AddChild(e.comPositeDragger2),e.comPositeDragger2.setParentDragger(e.comPositeDragger2.getParentDragger()),e}return __extends(e,t),e.prototype.addDraggerCallback=function(e){this.comPositeDragger.addDraggerCallback(e),this.comPositeDragger1.addDraggerCallback(e),this.comPositeDragger2.addDraggerCallback(e)},e.prototype.removeDraggerCallback=function(e){this.comPositeDragger.removeDraggerCallback(e),this.comPositeDragger1.removeDraggerCallback(e),this.comPositeDragger2.removeDraggerCallback(e)},e.prototype.setupDefaultGeometry=function(){this._xDragger.setupDefaultGeometry(),this._yDragger.setupDefaultGeometry(),this._zDragger.setupDefaultGeometry();var e=new r.Quaternion(new r.Vector3(1,0,0),new r.Vector3(0,1,0));this._yDragger.SetRotation(e);e=new r.Quaternion(new r.Vector3(1,0,0),new r.Vector3(0,0,1));this._zDragger.SetRotation(e),this._xDragger.setColor(new r.Color(1,0,0,1)),this._yDragger.setColor(new r.Color(0,1,0,1)),this._zDragger.setColor(new r.Color(0,0,1,1)),this._xDragger.setPickColor(r.Color.YELLOW().Clone()),this._yDragger.setPickColor(r.Color.YELLOW().Clone()),this._zDragger.setPickColor(r.Color.YELLOW().Clone())},e}(r.CompositeDragger);r.ScaleAxisDragger=e}(M3D||(M3D={})),function(h){var e=function(l){function e(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=l.call(this)||this;return 2==e.length?r._projector=new h.LineProjector(e[0],e[1]):r._projector=new h.LineProjector,r._startProjectedPoint=new h.Vector3,r.setColor(new h.Color(0,1,0,1)),r.setPickColor(new h.Color(1,1,0,1)),r}return __extends(e,l),e.prototype.handle=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(2==e.length){var r=e[1],i=e[0];switch(this._checkForNodeInNodePath,r.getEventType()){case h.EventType.PUSH:var n=this.GetWorldTransform();if(this._projector.setLocalToWorld(n),(a=this._projector.project(i,this._startProjectedPoint))[0])this._startProjectedPoint=a[1],(s=new h.TranslateInLineCommand(this._projector.getLineStart(),this._projector.getLineEnd())).setStage(h.Stage.START),s.setLocalToWorldAndWorldToLocal(this._projector.getLocalToWorld(),this._projector.getWorldToLocal()),this.dispatch(s);return!0;case h.EventType.DRAG:n=this.GetWorldTransform();this._projector.setLocalToWorld(n);var o=new h.Vector3;if((a=this._projector.project(i,o))[0])o=a[1],(s=new h.TranslateInLineCommand(this._projector.getLineStart(),this._projector.getLineEnd())).setStage(h.Stage.MOVE),s.setLocalToWorldAndWorldToLocal(this._projector.getLocalToWorld(),this._projector.getWorldToLocal()),s.setTranslation(o.Sub(this._startProjectedPoint)),this.dispatch(s);return!0;case h.EventType.RELEASE:var a,s;if((a=this._projector.project(i,this._startProjectedPoint))[0])this._startProjectedPoint=a[1],(s=new h.TranslateInLineCommand(this._projector.getLineStart(),this._projector.getLineEnd())).setStage(h.Stage.FINISH),s.setLocalToWorldAndWorldToLocal(this._projector.getLocalToWorld(),this._projector.getWorldToLocal()),this.dispatch(s);return!0;default:return!1}}else l.prototype.handle.call(this,e[0])},e.prototype.setupDefaultGeometry=function(){var i=this;this._projector.getLineEnd().Sub(this._projector.getLineStart()).Clone();this._drawModel=null,h.MeshHelper.ReadSingleModel("AxisHandler.stl",this._drawModel,function(e,t){if(t){i._drawModel=t,i._drawModel.SetAlloewExculding(!1);var r=new h.ShapeNode;i.AddChild(r),r.SetShape(i._drawModel),i._drawModel.SetInitHightlight(!0),i._drawModel.SetUserData(i)}})},e}(h.Dragger);h.Translate1DDragger=e}(M3D||(M3D={})),function(h){var e=function(l){function e(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=l.call(this)||this;return 1==e.length?r._projector=new h.PlaneProjector(e[0]):r._projector=new h.PlaneProjector(new h.Plane(new h.Vector3(0,1,0),0)),r._startProjectedPoint=new h.Vector3,r._drawModel=null,r.setColor(new h.Color(0,1,0,1)),r.setPickColor(new h.Color(1,1,0,1)),r}return __extends(e,l),e.prototype.handle=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(2==e.length){var r=e[0],i=e[1];if(!r.contains(this))return!1;switch(i.getEventType()){case h.EventType.PUSH:var n=this.GetWorldTransform();if(this._projector.setLocalToWorld(n),(o=this._projector.project(r,this._startProjectedPoint))[0])this._startProjectedPoint=o[1],(s=new h.TranslateInPlaneCommand(this._projector.getPlane())).setStage(h.Stage.START),s.setReferencePoint(this._startProjectedPoint),s.setLocalToWorldAndWorldToLocal(this._projector.getLocalToWorld(),this._projector.getWorldToLocal()),this.dispatch(s);return!0;case h.EventType.DRAG:n=this.GetWorldTransform();this._projector.setLocalToWorld(n);var o,a=new h.Vector3;if((o=this._projector.project(r,a))[0])a=o[1],(s=new h.TranslateInPlaneCommand(this._projector.getPlane())).setStage(h.Stage.MOVE),s.setLocalToWorldAndWorldToLocal(this._projector.getLocalToWorld(),this._projector.getWorldToLocal()),s.setTranslation(a.Sub(this._startProjectedPoint).Clone()),s.setReferencePoint(this._startProjectedPoint),this.dispatch(s);case h.EventType.RELEASE:var s;return(s=new h.TranslateInPlaneCommand(this._projector.getPlane())).setStage(h.Stage.FINISH),s.setReferencePoint(this._startProjectedPoint),s.setLocalToWorldAndWorldToLocal(this._projector.getLocalToWorld(),this._projector.getWorldToLocal()),this.dispatch(s),!0;default:return!1}}else l.prototype.handle.call(this,e[0])},e.prototype.setupDefaultGeometry=function(){var i=this;this._drawModel=null,h.MeshHelper.ReadSingleModel("PlanXYHandler.stl",this._drawModel,function(e,t){if(t){i._drawModel=t,i._drawModel.SetAlloewExculding(!1);var r=new h.ShapeNode;i.AddChild(r),i._drawModel.SetInitHightlight(!0),r.SetShape(i._drawModel),i._drawModel.SetUserData(i)}})},e}(h.Dragger);h.Translate2DDragger=e}(M3D||(M3D={})),function(n){var e=function(t){function e(){var e=t.call(this)||this;return e._xDragger=new n.Translate1DDragger(new n.Vector3(0,0,0),new n.Vector3(0,0,1)),e.AddChild(e._xDragger),e.addDragger(e._xDragger),e._yDragger=new n.Translate1DDragger(new n.Vector3(0,0,0),new n.Vector3(0,0,1)),e.AddChild(e._yDragger),e.addDragger(e._yDragger),e._zDragger=new n.Translate1DDragger(new n.Vector3(0,0,0),new n.Vector3(0,0,1)),e.AddChild(e._zDragger),e.addDragger(e._zDragger),e._xzDragger=new n.Translate2DDragger,e.AddChild(e._xzDragger),e.addDragger(e._xzDragger),e._xyDragger=new n.Translate2DDragger,e.AddChild(e._xyDragger),e.addDragger(e._xyDragger),e._yzDragger=new n.Translate2DDragger,e.AddChild(e._yzDragger),e.addDragger(e._yzDragger),e.setParentDragger(e.getParentDragger()),e}return __extends(e,t),e.prototype.setupDefaultGeometry=function(){this._xDragger.setupDefaultGeometry(),this._yDragger.setupDefaultGeometry(),this._zDragger.setupDefaultGeometry(),this._xzDragger.setupDefaultGeometry(),this._xyDragger.setupDefaultGeometry(),this._yzDragger.setupDefaultGeometry();var e=new n.Quaternion(new n.Vector3(0,0,1),new n.Vector3(1,0,0));this._xDragger.SetRotation(e);var t=new n.Quaternion(new n.Vector3(0,0,1),new n.Vector3(0,1,0));this._xyDragger.SetRotation(t);e=new n.Quaternion(new n.Vector3(0,0,1),new n.Vector3(0,1,0));this._yDragger.SetRotation(e);t=new n.Quaternion(new n.Vector3(1,0,0),new n.Vector3(0,1,0));this._yzDragger.SetRotation(t);for(var r=0,i=this._draggerList;r<i.length;r++){i[r]._drawModel}this.totalBoundingBox,this._xDragger.setColor(new n.Color(1,0,0,1)),this._yDragger.setColor(new n.Color(0,1,0,1)),this._zDragger.setColor(new n.Color(0,0,1,1)),this._xzDragger.setColor(new n.Color(1,0,0,1)),this._xyDragger.setColor(new n.Color(0,1,0,1)),this._yzDragger.setColor(new n.Color(0,0,1,1)),this._xDragger.setPickColor(n.Color.YELLOW().Clone()),this._yDragger.setPickColor(n.Color.YELLOW().Clone()),this._zDragger.setPickColor(n.Color.YELLOW().Clone()),this._xDragger.SetPreSelectColor(n.Color.YELLOW().Clone()),this._yDragger.SetPreSelectColor(n.Color.YELLOW().Clone()),this._zDragger.SetPreSelectColor(n.Color.YELLOW().Clone()),this._xzDragger.setPickColor(n.Color.YELLOW().Clone()),this._xyDragger.setPickColor(n.Color.YELLOW().Clone()),this._yzDragger.setPickColor(n.Color.YELLOW().Clone()),this._xzDragger.SetPreSelectColor(n.Color.YELLOW().Clone()),this._xyDragger.SetPreSelectColor(n.Color.YELLOW().Clone()),this._yzDragger.SetPreSelectColor(n.Color.YELLOW().Clone())},e}(n.CompositeDragger);n.TranslateAxisDragger=e}(M3D||(M3D={})),function(o){var e=function(t){function e(){var e=t.call(this)||this;return e._usingTranslate1DDragger=!1,e._translate2DDragger=new o.Translate2DDragger,e._translate2DDragger.setColor(new o.Color(.7,.7,.7,1)),e.addDragger(e._translate2DDragger),e._translate1DDragger=new o.Translate1DDragger(new o.Vector3(0,0,0),new o.Vector3(0,1,0)),e.addDragger(e._translate1DDragger),e.setParentDragger(e.getParentDragger()),e}return __extends(e,t),e.prototype.getTranslate1DDragger=function(){return this._translate1DDragger},e.prototype.getTranslate2DDragger=function(){return this._translate2DDragger},e.prototype.setColor=function(e){this._translate2DDragger&&this._translate2DDragger.setColor(e)},e.prototype.handle=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(2==e.length){var r=e[0],i=e[1];if(!r.contains(this))return!1;var n=!1;return this._usingTranslate1DDragger?this._translate1DDragger.handle(r,i)&&(n=!0):this._translate2DDragger.handle(r,i)&&(n=!0),i.getEventType()==o.EventType.RELEASE&&(this._usingTranslate1DDragger=!1),n}},e.prototype.setupDefaultGeometry=function(){},e}(o.CompositeDragger);o.TranslatePlaneDragger=e}(M3D||(M3D={})),function(r){var e=function(){function e(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this.linkStr=new Array,this.actionList=new Array,this.relationShape=null,0===e.length||(8===e.length?(this.ID=e[0],this.name=e[1],this.refs=e[2],this.describe=e[3],this.isEnable=e[4],this.isVisible=e[5],this.startPos=e[6],this.endPos=e[7]):(this.ID=e[0],this.name=e[1],this.describe=e[2],null!=this.describe&&""!==this.describe&&this.action.push(new r.SHotSpotDescriptionAction(this.ID,r.SHotSpotActionType.SHOWDESCRIPTION,this.describe)),this.viewName=e[3],""!==this.viewName&&null!=this.viewName&&this.action.push(new r.SHotSpotOpenViewAction(this.ID,r.SHotSpotActionType.OPENVIEW,this.viewName)),this.animationName=e[4],""!==this.animationName&&null!=this.animationName&&this.action.push(new r.SHotSpotOpenAniAction(this.ID,r.SHotSpotActionType.PLAYANIMATION,this.animationName)),this.voiceFileName=e[5],this.modelViewID=e[6],null!=this.modelViewID&&-1!==this.modelViewID&&this.action.push(new r.SHotSpotOpenViewAction(this.ID,r.SHotSpotActionType.OPENVIEW,this.modelViewID)),this.animationProcessID=e[7],this.animationStepID=e[8],-1!==this.animationProcessID&&null!=this.animationProcessID&&this.action.push(new r.SHotSpotOpenAniAction(this.ID,r.SHotSpotActionType.PLAYANIMATION,this.animationProcessID,this.animationStepID)),this.posX=e[9],this.posY=e[10],this.posZ=e[11],this.cameraPositionX=e[12],this.cameraPositionY=e[13],this.cameraPositionZ=e[14],this.cameraRotationW=e[15],this.cameraRotationX=e[16],this.cameraRotationY=e[17],this.cameraRotationZ=e[18],this.cameraZoomX=e[19],this.cameraZoomY=e[20],this.cameraZoomZ=e[21],this.cameraProjectionType=e[22],this.hotspotImage=e[23]))}return e.prototype.GetID=function(){return this.ID},e.prototype.SetID=function(e){this.ID=e},e.prototype.GetPointShape=function(){return this.pointShapeId},e.prototype.SetPointShape=function(e){this.pointShapeId=e},e.prototype.GetName=function(){return this.name},e.prototype.SetName=function(e){this.name=e},e.prototype.GetType=function(){return this.type},e.prototype.SetType=function(e){this.type=e},e.prototype.GetRef=function(){return this.refs},e.prototype.SetRef=function(e){this.refs=e},e.prototype.GetIsEnable=function(){return this.isEnable},e.prototype.SetIsEnable=function(e){this.isEnable=e},e.prototype.GetDescribe=function(){return this.describe},e.prototype.SetDescribe=function(e){this.describe=e},e.prototype.IsVisible=function(){return this.isVisible},e.prototype.SetIsVisible=function(e){this.isVisible=e},e.prototype.SetVisible=function(e){this.isVisible=e},e.prototype.GetLinkStr=function(){return this.linkStr},Object.defineProperty(e.prototype,"action",{get:function(){return this.actionList},set:function(e){this.actionList=e},enumerable:!0,configurable:!0}),e.prototype.onExecute=function(){if(0<this.action.length){r.SHotSpotManager.Instance().view.view.StopModelViewAnimation(),r.SHotSpotManager.Instance().view.GetAnimationPlayer().StopPlayer(),r.SHotSpotManager.Instance().view.showShotSpotDescribe(null);for(var e=0,t=this.action;e<t.length;e++){t[e].Execute()}}},e.prototype.SetLinkStr=function(e){this.linkStr=e},e.prototype.GetRelationShape=function(){return this.relationShape},e.prototype.SetRelationShape=function(e){this.relationShape=e},e.prototype.GetPosX=function(){return this.posX},e.prototype.SetPosX=function(e){this.posX=e},e.prototype.GetPosY=function(){return this.posY},e.prototype.SetPosY=function(e){this.posY=e},e.prototype.GetPosZ=function(){return this.posZ},e.prototype.SetPosZ=function(e){this.posZ=e},e.prototype.GetCameraPositionX=function(){return this.cameraPositionX},e.prototype.SetCameraPositionX=function(e){this.cameraPositionX=e},e.prototype.GetCameraPositionY=function(){return this.cameraPositionY},e.prototype.SetCameraPositionY=function(e){this.cameraPositionY=e},e.prototype.GetCameraPositionZ=function(){return this.cameraPositionZ},e.prototype.SetCameraPositionZ=function(e){this.cameraPositionZ=e},e.prototype.GetCameraRotationX=function(){return this.cameraRotationX},e.prototype.SetCameraRotationX=function(e){this.cameraRotationX=e},e.prototype.GetCameraRotationY=function(){return this.cameraRotationY},e.prototype.SetCameraRotationY=function(e){this.cameraRotationY=e},e.prototype.GetCameraRotationZ=function(){return this.cameraRotationZ},e.prototype.SetCameraRotationZ=function(e){this.cameraRotationZ=e},e.prototype.GetCameraRotationW=function(){return this.cameraRotationW},e.prototype.SetCameraRotationW=function(e){this.cameraRotationW=e},e.prototype.GetCameraZoomX=function(){return this.cameraZoomX},e.prototype.SetCameraZoomX=function(e){this.cameraZoomX=e},e.prototype.GetCameraZoomY=function(){return this.cameraZoomY},e.prototype.SetCameraZoomY=function(e){this.cameraZoomY=e},e.prototype.GetCameraZoomZ=function(){return this.cameraZoomZ},e.prototype.SetCameraZoomZ=function(e){this.cameraZoomZ=e},e.prototype.GetCameraProjectionType=function(){return this.cameraProjectionType},e.prototype.SetCameraProjectionType=function(e){this.cameraProjectionType=e},e.prototype.GetStartPos=function(){return this.startPos},e.prototype.SetStartPos=function(e){this.startPos=e},e.prototype.GetEndPos=function(){return this.endPos},e.prototype.SetEndPos=function(e){this.endPos=e},e.prototype.GetViewName=function(){return this.viewName},e.prototype.SetViewName=function(e){this.viewName=e},e.prototype.GetHotSpotImage=function(){return this.hotspotImage},e.prototype.SetHotSpotImage=function(e){this.hotspotImage=e},e.prototype.GetAnimationName=function(){return this.animationName},e.prototype.SetAnimationName=function(e){this.animationName=e},e.prototype.GetVoiceFileName=function(){return this.voiceFileName},e.prototype.SetVoiceFileName=function(e){this.voiceFileName=e},e.prototype.GetModelViewID=function(){return this.modelViewID},e.prototype.SetModelViewID=function(e){this.modelViewID=e},e.prototype.GetAnimationProcess=function(){return this.animationProcessID},e.prototype.SetAnimationProcessID=function(e){this.animationProcessID=e},e.prototype.GetAnimationStepID=function(){return this.animationStepID},e.prototype.SetAnimationStepID=function(e){this.animationStepID=e},e}();r.SHotSpot=e}(SView||(SView={})),function(e){var t;(t=e.SHotSpotActionType||(e.SHotSpotActionType={}))[t.OPENFILE=0]="OPENFILE",t[t.OPENWEB=1]="OPENWEB",t[t.OPENFTP=2]="OPENFTP",t[t.OPENVIEW=3]="OPENVIEW",t[t.SHOWNOTE=4]="SHOWNOTE",t[t.PLAYANIMATION=5]="PLAYANIMATION",t[t.HIGHLIGHTPARTS=6]="HIGHLIGHTPARTS",t[t.SHOWDESCRIPTION=7]="SHOWDESCRIPTION";var r=function(){function e(){}return e.prototype.GetId=function(){return this.id},e.prototype.Execute=function(){},e.prototype.GetActionType=function(){return this.type},e}();e.SHotSpotAction=r}(SView||(SView={})),function(e){var t=function(i){function e(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=i.call(this)||this;return 0===e.length||(r.id=e[0],r.type=e[1],r.descriptionStr=e[2]),r}return __extends(e,i),e.prototype.getDescriptionStr=function(){return this.descriptionStr},e.prototype.Execute=function(){this.view.showShotSpotDescribe(this.descriptionStr)},e}(e.SHotSpotAction);e.SHotSpotDescriptionAction=t}(SView||(SView={})),function(e){var t=function(i){function e(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=i.call(this)||this;return r.parts=new Array,0===e.length||(r.id=e[0],r.type=e[1],r.parts=e[2]),r}return __extends(e,i),e.prototype.getParts=function(){return this.parts},e.prototype.Execute=function(){},e}(e.SHotSpotAction);e.SHotSpotHighLightPartAction=t}(SView||(SView={})),function(e){var t=function(){function e(){this.hotSpots=new Array}return e.Instance=function(){return null==e.instance&&(e.instance=new e),e.instance},Object.defineProperty(e.prototype,"view",{get:function(){return this._view},set:function(e){this._view=e},enumerable:!0,configurable:!0}),e.prototype.readFile=function(){},e.prototype.ShowHotSpotOnPart=function(e){return null},e.prototype.GetHotSpotByPart=function(e){for(var t=new Array,r=this.GetAllHotSpotList(),i=0;i<r.length;i++)for(var n=r[i].GetLinkStr(),o=0;o<n.length;o++)if(n[o].indexOf("INS:")){n[o].substring(n[o].lastIndexOf(":")+1);""===e&&t.indexOf(r[i])<0&&t.push(r[i])}return t},e.prototype.GetHotSpotByPostion=function(e){for(var t=new Array,r=this.GetAllHotSpotList(),i=0;i<r.length;i++)r[i].GetPosX().toFixed(2)===e.x.toFixed(2)&&r[i].GetPosY().toFixed(2)===e.y.toFixed(2)&&r[i].GetPosZ().toFixed(2)===e.z.toFixed(2)&&t.push(r[i]);return t},e.prototype.GetAllHotSpotList=function(){return this.hotSpots},e.prototype.ClearData=function(){this.hotSpots.splice(0,this.hotSpots.length)},e.prototype.AddHotSpot=function(e){for(var t=0,r=e.action;t<r.length;t++){r[t].view=this.view}this.hotSpots.push(e)},e.prototype.DeleteHotspot=function(e){var t=this.hotSpots.indexOf(e);-1<t&&this.hotSpots.splice(t,1)},e.prototype.DeleteHotspotByName=function(e){for(var t=0,r=this.hotSpots;t<r.length;t++){var i=r[t];if(i.GetName()===e)return void this.hotSpots.splice(this.hotSpots.indexOf(i),1)}},e.prototype.GetHotspot=function(e){for(var t=0,r=this.hotSpots;t<r.length;t++){var i=r[t];if(i.GetName()===e)return i}return null},e.instance=null,e}();e.SHotSpotManager=t}(SView||(SView={})),function(e){var t=function(i){function e(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=i.call(this)||this;return 0===e.length||(3===e.length?(r.id=e[0],r.type=e[1],r.taskName=e[2]):4===e.length?(r.id=e[0],r.type=e[1],r.processID=e[2],r.stepID=e[3]):(r.id=e[0],r.type=e[1],r.playMode=e[2],r.processID=e[3],r.stepID=e[4])),r}return __extends(e,i),e.prototype.GetStepID=function(){return this.stepID},e.prototype.GetPlayMode=function(){return this.playMode},e.prototype.GetProcessID=function(){return this.processID},e.prototype.Execute=function(){this.view.AnimationOpenFile();var e=this.view.GetAnimationPlayer().GetTaskList();this.taskName&&this.GetAni(e),this.view.animationPlayer.SetAutoWalkCamera(!0),this.view.animationPlayer.SetSpeed(1),this.view.animationPlayer.SetLoop(!1),-1!==Number(this.stepID)&&this.stepID?this.view.GetAnimationPlayer().playAnimation(Number(this.processID),Number(this.stepID)):this.view.GetAnimationPlayer().playAnimation(Number(this.processID),null)},e.prototype.GetAni=function(e){for(var t=0,r=e;t<r.length;t++){var i=r[t];if(i.GetName()===this.taskName){this.processID=i.GetId().toString();break}var n=i.GetChildProcessList();0<n.length&&this.GetAni(n);for(var o=0,a=i.GetStepList();o<a.length;o++){var s=a[o];if(s.GetName()===this.taskName){this.processID=s.GetProcessId(),this.stepID=s.GetId().toString();break}}}},e}(e.SHotSpotAction);e.SHotSpotOpenAniAction=t}(SView||(SView={})),function(e){var t=function(i){function e(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=i.call(this)||this;return 0===e.length||(r.id=e[0],r.type=e[1],r.url=e[2],r.bytes=e[3]),r}return __extends(e,i),e.prototype.GetUrl=function(){return this.url},e.prototype.GetByte=function(){return this.bytes},e.prototype.Execute=function(){},e}(e.SHotSpotAction);e.SHotSpotOpenUrlAction=t}(SView||(SView={})),function(e){var t=function(i){function e(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=i.call(this)||this;return 0===e.length||3===e.length&&(e[2]instanceof Number?(r.id=e[0],r.type=e[1],r.viewID=e[2]):(r.id=e[0],r.type=e[1],r.viewName=e[2])),r}return __extends(e,i),e.prototype.getViewID=function(){return this.viewID},e.prototype.Execute=function(){var e=this.view.view.GetModelViewsList();if(this.viewName)for(var t=0,r=e;t<r.length;t++){var i=r[t];if(i.GetName()===this.viewName){this.viewID=i.GetID();break}}this.view.view.ShowModelView(Number(this.getViewID()),!0,!0)},e}(e.SHotSpotAction);e.SHotSpotOpenViewAction=t}(SView||(SView={})),function(e){var t=function(i){function e(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=i.call(this)||this;return 0===e.length||(r.id=e[0],r.type=e[1],r.part=e[2],r.noteID=e[3]),r}return __extends(e,i),e.prototype.GetNoteID=function(){return this.noteID},e.prototype.GetPart=function(){return this.part},e.prototype.Execute=function(){},e}(e.SHotSpotAction);e.SHotSpotShowNoteAction=t}(SView||(SView={})),function(e){var t=function(){function o(){}return o.createPowerTwoImage=function(e){var t=e;if(o.isPowerOfTwo(e.width)&&o.isPowerOfTwo(e.height))return t;var r=document.createElement("canvas");return r.width=o.nearestPowerOfTwo(e.width),r.height=o.nearestPowerOfTwo(e.height),r.getContext("2d").drawImage(e,0,0,r.width,r.height),r},o.LoadImage=function(e,t,r,i){void 0===i&&(i=0);var n=e.GetImage();n.onload=function(){var e=o.createPowerTwoImage(n);t&&t(e,r,i)},n.src=e.GetImagePath()},o.isPowerOfTwo=function(e){return 0==(e&e-1)&&0!==e},o.nearestPowerOfTwo=function(e){return Math.pow(2,Math.round(Math.log(e)/Math.LN2))},o.nextPowerOfTwo=function(e){return e--,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,++e},o}();e.ImageLoader=t}(M3D||(M3D={})),function(l){var e=function(){function e(){this.readListeners=[],this.readNextListener=null,this.readModelListener=null,this.option={readPMI:!1},this.Id=e.globalId++,this.view=null,this.topModel=null,this.readPercent=0,this.allFilesCount=1,this.currentFileIndex=0,this.currentFilesName="",this.File="",this.isCancel=!1}return e.GetReader=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r="ERROR",i=null;if(!(e[0]instanceof FileList)){var n=l.FileHelper.GetSuffix(e[0]),o=e[0];switch(n){case"svl":(i=new l.SvlReader).fileName=o;break;case"stl":(i=new l.StlReader).fileName=o;break;case"obj":(i=new l.ObjReader).fileName=o;break;case"svlx":(i=new l.SvlxReader).fileName=o}return null!==i&&(r="OK"),[i,r]}var a=e[0];if(2===a.length){n=l.FileHelper.GetSuffix(a[0].name);var s=l.FileHelper.GetSuffix(a[1].name);if("jsvl"===n&&"bin"===s)(i=new l.JSvlReader).fileName=a[0].name;else if("jsvl"===s&&"bin"===n)return(i=new l.JSvlReader).fileName=a[1].name,[i,r]}else if(1===a.length){switch(n=l.FileHelper.GetSuffix(a[0].name)){case"svl":(i=new l.SvlReader).fileName=a[0].name;break;case"stl":(i=new l.StlReader).fileName=a[0].name;break;case"obj":(i=new l.ObjReader).fileName=a[0].name;break;case"svlx":(i=new l.SvlxReader).fileName=a[0].name}}return null!==i&&(r="OK"),[i,r]},e.prototype.ReadFile=function(e){return new l.Model},e.prototype.SetView=function(e){this.view=e},e.prototype.GetResourceManager=function(){return this.view.GetSceneManager().GetResourceManager()},e.prototype.GetView=function(){return this.view},e.prototype.GetModel=function(){return this.topModel},e.prototype.SetModel=function(e){this.topModel=e},e.prototype.GetReadPercent=function(){return this.readPercent},e.prototype.SetReadPercent=function(e){null!=this.readNextListener&&(this.allFilesCount=this.readNextListener.allFilesCount,this.currentFileIndex=this.readNextListener.currentFileIndex,this.currentFilesName=this.readNextListener.currentFilesName),this.readPercent=e;for(var t=0,r=this.readListeners;t<r.length;t++){r[t].onReading(this)}},e.prototype.BeginRead=function(){this.SetReadPercent(0);for(var e=0,t=this.readListeners;e<t.length;e++){t[e].onReadBegin(this)}},e.prototype.EndRead=function(){if(null!=this.readModelListener&&this.readModelListener.onReadEnd(this),null==this.readNextListener){this.SetReadPercent(1);for(var e=0,t=this.readListeners;e<t.length;e++){t[e].onReadEnd(this)}}else{for(var r=0,i=this.readListeners;r<i.length;r++){i[r].onSingleFileReadEnd(this)}this.readNextListener.onReadEnd(this)}if(this.view){var n=this.view.GetSceneManager().GetModelFillManager();n.AddSVLXreader(this),n.doNextReaderFill()}},e.prototype.Cancel=function(){for(var e=0,t=this.readListeners;e<t.length;e++){t[e].onReadCancel(this)}},e.prototype.SetListeners=function(e){this.readListeners=e},e.prototype.GetListeners=function(){return this.readListeners},e.prototype.AddListener=function(e){return null!=e&&-1===this.readListeners.indexOf(e)&&this.readListeners.push(e),!0},e.prototype.RemoveListener=function(e){return null!=e&&-1!==this.readListeners.indexOf(e)&&this.readListeners.splice(this.readListeners.indexOf(e),1),!0},e.prototype.coverColorToMaterial=function(e){var t="ColorBaseMaterial"+e.Tostring(),r=this.GetView().GetSceneManager().GetResourceManager().GetMaterial(t);if(r)return r;var i=r=this.GetView().GetSceneManager().GetResourceManager().GetOrCreateMaterial(t,l.MaterialType.MaterialType_Phong);i.SetName(t),i.SetDiffuse(e),i.Opacity(e.a);return i.SetShininess(20),r},e.globalId=0,e}();l.Reader=e}(M3D||(M3D={})),function(V){var e=function(t){function e(){var e=t.call(this)||this;return e.delay=50,e.instanceCount=0,e.currentReadInstanceCount=0,e}return __extends(e,t),e.prototype.ReadJSvl=function(e,t){var r,i,n,o;return this.text=e,this.mapObj=t,(r=this).BeginRead(),r.SetReadPercent(.02),(i=r).asm=JSON.parse(i.text),(o=i).map=o.parseBinary(o.mapObj),o.SetReadPercent(.22),(n=o).proto=void 0!==n.asm.ProtoTypes.TopProto?n.asm.ProtoTypes.TopProto:n.asm.ProtoTypes,void 0!==n.proto&&void 0!==n.proto.ChildIns&&n.GetInstanceCount(n.asm,n.proto),n.SetReadPercent(.25),function(e){if(e.topModel=new V.Model,e.topModel.SetName(e.proto.Name),e.topModel.SetPlcId(0),void 0!==e.proto.ChildIns)e.SearchInstance(e.asm,e.map,e.proto,e.topModel,e);else{var t=void 0,r=new V.Matrix4,i=e.proto.Name;if(e.map.contains(i)){var n=e.map.get(i);""!=n?e.AddMesh(e.topModel,n[0],n[1],n[2],n[3],!1):(t=new V.Body,e.topModel.AddBody(t))}else t=new V.Body,e.topModel.AddBody(t);e.topModel.SetPlaceMatrix(r)}var o;(o=e).SetReadPercent(.9),o.EndRead()}(n),i.SetReadPercent(.12),null},e.prototype.ReadFile=function(e){return new V.Model},e.prototype.GetInstanceCount=function(e,t){var r=t.ChildIns;this.instanceCount++;for(var i=0;i<r.length;i++){var n="ChildIns"+(i+1),o=r[i][n].PointProtoName,a=e.ProtoTypes[o];void 0!==a&&void 0!==a.ChildIns&&this.GetInstanceCount(e,a)}},e.prototype.SearchInstance=function(e,t,r,i,n){n.SetReadPercent(.25+.65*n.currentReadInstanceCount++/n.instanceCount);for(var o=r.ChildIns,a=0;a<o.length;a++){var s="ChildIns"+(a+1),l=o[a][s],h=n.CreateInstance(t,l);i.AddSubModel(h);var u=l.PointProtoName,p=e.ProtoTypes[u];void 0!==p&&void 0!==p.ChildIns&&n.SearchInstance(e,t,p,h,n),h=null}},e.prototype.CreateInstance=function(e,t){var r,i,n=new V.Model,o=!1,a=new V.Matrix4,s=t.InsName;n.SetName(s),n.SetPlcId(t.PlcID),1==t.HasColor&&(o=t.Color),void 0===(r=t.PlcMatrix)?console.log("Warning: the ProtoType "+s+" have not PlacementMatrix!"):a=new V.Matrix4(r[0],r[1],r[2],r[3],r[4],r[5],r[6],r[7],r[8],r[9],r[10],r[11],r[12],r[13],r[14],r[15]);var l=t.PointProtoName;if(e.contains(l)){var h=e.get(l);""!=h?this.AddMesh(n,h[0],h[1],h[2],h[3],o):(i=new V.Body,n.AddBody(i))}else i=new V.Body,n.AddBody(i);return n.SetPlaceMatrix(a),n},e.prototype.AddMesh=function(e,t,r,i,n,o){var a,s;if(!t||t&&t.length<3)console.log("vertex array length is too short!");else{var l=new V.Color(.5,.5,.5,1),h=0;if(i&&2<i.length){for(var u=void 0,p=0,c=i.length;p<c;p+=1)if(!1!==o&&-1e-5<o[0]&&o[0]<1.00001?u=new V.Color(o[0],o[1],o[2],1-o[3]):n.length>p/3*4&&-1e-5<n[p/3*4]&&n[p/3*4]<1.00001&&(u=new V.Color(n[p/3*4],n[p/3*4+1],n[p/3*4+2],1-n[p/3*4+3])),u||(u=new V.Color(.5,.5,.5,1)),0==p)l=u,h=p;else if(!u.Equals(l)||p==i.length-1){var d=p-h;p==i.length-1&&++d,a=new Float32Array(3*d),r&&(s=new Float32Array(3*d));for(var S=0;S<d;++S)a[3*S]=t[3*i[S+h]],a[3*S+1]=t[3*i[S+h]+1],a[3*S+2]=t[3*i[S+h]+2],s&&(s[3*S]=r[3*i[S+h]],s[3*S+1]=r[3*i[S+h]+1],s[3*S+2]=r[3*i[S+h]+2]);(g=new V.VertexSet).SetUseIndex(!1),g.SetPositionArray(a);var f=new V.Body;s&&a.length==s.length?g.SetNormalArray(s):g.computeVertexNormals(),f.SetVertexSet(g),(v=new V.Face).SetInitColor(l),f.AddFace(v);var m=new V.Mesh(g),y=g.GetPositionArray().length/3;m.SetDataOffset(0),m.SetDataLength(y),v.SetMesh(m),e.AddBody(f),l=u,h=p}}else{var T=new V.Color(.5,.5,.5,1),M=0;for(u=void 0,p=0;p<t.length;++p)if(!1!==o&&-1e-5<o[0]&&o[0]<1.00001?u=new V.Color(o[0],o[1],o[2],1-o[3]):n.length>p/9*4&&-1e-5<n[p/9*4]&&n[p/9*4]<1.00001&&(u=new V.Color(n[p/9*4],n[p/9*4+1],n[p/9*4+2],1-n[p/9*4+3])),u||(u=new V.Color(.5,.5,.5,1)),0==p)T=u,M=p;else if(!u.Equals(T)||p==i.length-1){d=p-M;p==i.length-1&&++d,a=new Float32Array(d),r&&(s=new Float32Array(d));for(S=0;S<d;++S)a[S]=t[S+M],s&&(s[S]=r[S+M]);var g;(g=new V.VertexSet).SetUseIndex(!1),g.SetPositionArray(a);var v;f=new V.Body;s&&a.length==s.length?g.SetNormalArray(s):g.computeVertexNormals(),f.SetVertexSet(g),(v=new V.Face).SetRenderColor(T),f.AddFace(v);m=new V.Mesh(g),y=g.GetPositionArray().length/3;m.SetDataOffset(0),m.SetDataLength(y),v.SetMesh(m),e.AddBody(f),T=u,M=p}}}},e.prototype.parseBinary=function(e){var t=e.length;new V.Dictionary;if(552<t){for(var r=new V.Dictionary,i=void 0,n=void 0,o=0,a=0;o<t;){a=o+24;var s=e.charCodeAt(a),l=e.charCodeAt(a+1)<<8,h=e.charCodeAt(a+2)<<16,u=e.charCodeAt(a+3)<<24;if(t<(o+=(s|l|h|u)+28))return console.log("RangeError: offset is outside the bounds of the DataView!"),console.log("Failed to read the prototype name!"),r;a+=16;var p=e.slice(a,a+512);if(i=this.getProtoName(p),a=o,a+=24,t<(o+=((s=e.charCodeAt(a))|(l=e.charCodeAt(a+1)<<8)|(h=e.charCodeAt(a+2)<<16)|(u=e.charCodeAt(a+3)<<24))+28))return console.log("RangeError: offset is outside the bounds of the DataView!"),console.log("Failed to read the prototype MeshDate!"),r;a+=16;var c=(s=e.charCodeAt(a))|(l=e.charCodeAt(a+1)<<8)|(h=e.charCodeAt(a+2)<<16)|(u=e.charCodeAt(a+3)<<24);if(0!==c){var d=0;n=new Array(4);var S=new Array(3*c);a+=4;for(var f=0;f<c;f++){var m=a+12*f,y=new ArrayBuffer(4),T=new Int8Array(y);T[0]=e.charCodeAt(m+0),T[1]=e.charCodeAt(m+1),T[2]=e.charCodeAt(m+2),T[3]=e.charCodeAt(m+3);var M=new DataView(y);S[d]=M.getFloat32(0,!0),T[0]=e.charCodeAt(m+4),T[1]=e.charCodeAt(m+5),T[2]=e.charCodeAt(m+6),T[3]=e.charCodeAt(m+7),M=new DataView(y),S[d+1]=M.getFloat32(0,!0),T[0]=e.charCodeAt(m+8),T[1]=e.charCodeAt(m+9),T[2]=e.charCodeAt(m+10),T[3]=e.charCodeAt(m+11),M=new DataView(y),S[d+2]=M.getFloat32(0,!0),d+=3}n[0]=S,d=0,a+=12*c,a+=12,a+=4;for(var g=new Array(3*c),v=0;v<c;v++){var C=a+12*v,_=void 0,A=new ArrayBuffer(4),E=new Int8Array(A);E[0]=e.charCodeAt(C+0),E[1]=e.charCodeAt(C+1),E[2]=e.charCodeAt(C+2),E[3]=e.charCodeAt(C+3),_=new DataView(A),g[d]=_.getFloat32(0,!0),E[0]=e.charCodeAt(C+4),E[1]=e.charCodeAt(C+5),E[2]=e.charCodeAt(C+6),E[3]=e.charCodeAt(C+7),_=new DataView(A),g[d+1]=_.getFloat32(0,!0),E[0]=e.charCodeAt(C+8),E[1]=e.charCodeAt(C+9),E[2]=e.charCodeAt(C+10),E[3]=e.charCodeAt(C+11),_=new DataView(A),g[d+2]=_.getFloat32(0,!0),d+=3}n[1]=g,a+=12*c,a+=12;var G=void 0,P=new ArrayBuffer(4),w=new Int8Array(P);w[0]=e.charCodeAt(a+0),w[1]=e.charCodeAt(a+1),w[2]=e.charCodeAt(a+2),w[3]=e.charCodeAt(a+3);var D=(G=new DataView(P)).getUint32(0,!0);a+=4;for(var x=new Array(D),R=0;R<D;R++){var I=a+4*R;w[0]=e.charCodeAt(I+0),w[1]=e.charCodeAt(I+1),w[2]=e.charCodeAt(I+2),w[3]=e.charCodeAt(I+3),G=new DataView(P),x[R]=G.getUint32(0,!0)}n[2]=x,a+=4*D,a+=12,w[d=0]=e.charCodeAt(a+0),w[1]=e.charCodeAt(a+1),w[2]=e.charCodeAt(a+2),w[3]=e.charCodeAt(a+3);var L=(G=new DataView(P)).getUint32(0,!0);a+=4;for(var N=new Array(D/3*4),O=0;O<L;O++){var b=a+16*O;w[0]=e.charCodeAt(b+0),w[1]=e.charCodeAt(b+1),w[2]=e.charCodeAt(b+2),w[3]=e.charCodeAt(b+3),G=new DataView(P),N[d]=G.getFloat32(0,!0),w[0]=e.charCodeAt(b+4),w[1]=e.charCodeAt(b+5),w[2]=e.charCodeAt(b+6),w[3]=e.charCodeAt(b+7),G=new DataView(P),N[d+1]=G.getFloat32(0,!0),w[0]=e.charCodeAt(b+8),w[1]=e.charCodeAt(b+9),w[2]=e.charCodeAt(b+10),w[3]=e.charCodeAt(b+11),G=new DataView(P),N[d+2]=G.getFloat32(0,!0),w[0]=e.charCodeAt(b+12),w[1]=e.charCodeAt(b+13),w[2]=e.charCodeAt(b+14),w[3]=e.charCodeAt(b+15),G=new DataView(P),N[d+3]=G.getFloat32(0,!0),d+=4}n[3]=N}else n="";r.getOrAdd(i,n)}return n=null,r}return console.log("Warning: Not Find MeshData!!!"),""},e.prototype.getProtoName=function(e){for(var t="",r=String.fromCharCode(0),i=0;i<e.length;i+=2){var n=String.fromCharCode(e.charCodeAt(i)|e.charCodeAt(i+1)<<8);if(n===r)break;t+=n}return t},e}(V.Reader);V.AsyJSvlReader=e}(M3D||(M3D={})),function(S){String.prototype.trim=function(){return this.replace(/(^\s*)|(\s*$)/g,"")};var e=function(){function e(){}return e.Instance=function(){return e.instance||(e.instance=new e),e.instance},e.prototype.LoadMtl=function(e,t){for(var r,i=e.split("\n"),n=t,o=/([\-+]?[0-9]+\.?[0-9]*([eE][\-+]?[0-9]+)?)+[\s]+([\-+]?[0-9]*\.?[0-9]+([eE][\-+]?[0-9]+)?)+[\s]+([\-+]?[0-9]*\.?[0-9]+([eE][\-+]?[0-9]+)?)+/,a=0;a<i.length;++a){var s=i[a];if(null!=(s=s.trim())&&0!=s.length){var l=s.substr(0,7);if("newmtl "!==(l=l.toLowerCase())){if(null!=r){var h=void 0;switch(l=(l=s.substr(0,3)).toLowerCase()){case"ka ":if(null===(h=o.exec(s.substr(3))))continue;r.SetAmbient(new S.Color(parseFloat(h[1]),parseFloat(h[3]),parseFloat(h[5])));continue;case"kd ":if(null===(h=o.exec(s.substr(3))))continue;r.SetDiffuse(new S.Color(parseFloat(h[1]),parseFloat(h[3]),parseFloat(h[5])));continue;case"ks ":if(null===(h=o.exec(s.substr(3))))continue;r.SetSpecular(new S.Color(parseFloat(h[1]),parseFloat(h[3]),parseFloat(h[5])));continue;case"kt ":case"ni ":case"ke ":case"ns ":continue}l=(l=s.substr(0,7)).toLowerCase();var u=void 0;switch(u=s.substr(7),l){case"map_ka ":"."!==u.charAt(0)||"\\"!==u.charAt(1)&&"/"!==u.charAt(1)?"\\"!==u.charAt(0)&&"/"!==u.charAt(0)||(u=u.substr(1)):u=u.substr(2),u=u.trim();var p=n.GetOrCreateTexture(u);null===(c=n.GetImage(u))&&(c=n.GetOrCreateImage(u)),p.AddImage(c),r.SetAmbientTexture(p);continue;case"map_kd ":"."!==u.charAt(0)||"\\"!==u.charAt(1)&&"/"!==u.charAt(1)?"\\"!==u.charAt(0)&&"/"!==u.charAt(0)||(u=u.substr(1)):u=u.substr(2),u=u.trim();p=n.GetOrCreateTexture(u);null===(c=n.GetImage(u))&&(c=n.GetOrCreateImage(u)),p.AddImage(c),r.SetDiffuseTexture(p);continue;case"map_ks ":"."!==u.charAt(0)||"\\"!==u.charAt(1)&&"/"!==u.charAt(1)?"\\"!==u.charAt(0)&&"/"!==u.charAt(0)||(u=u.substr(1)):u=u.substr(2),u=u.trim();var c;p=n.GetOrCreateTexture(u);null===(c=n.GetImage(u))&&(c=n.GetOrCreateImage(u)),p.AddImage(c),r.SetSpecularTexture(p);continue}}}else{var d=s.substr(7);null===(r=n.GetMaterial(d))&&((r=new S.Material).SetName(d),n.AddMaterial(d,r))}}}},e.prototype.fillMaterial=function(e,t,r){var i=e.GetSceneManager().GetResourceManager(),n=i.GetOrCreateTexture(r),o=i.GetImage(r);null===o&&(o=i.GetOrCreateImage(r,r)),n.AddImage(o);var a=[];this.getAllModelFace(a,t),a.forEach(function(e){e.SetDiffuseMap(n)})},e.prototype.getAllModelFace=function(t,e){var r=e.GetModelShape();if(r)for(var i=r.GetBodys(),n=0;n<i.length;n++)for(var o=i[n].GetFaces(),a=0;a<o.length;a++){var s=o[a].GetMaterial(),l=t.indexOf(s);-1<l||l<0&&t.push(s)}var h=e.GetSubModels(),u=this;h.forEach(function(e){u.getAllModelFace(t,e)})},e.instance=null,e}();S.MaterialReader=e}(M3D||(M3D={})),function(x){var R,e,I,t,L,r;(e=R=x.StkPMISourceEnum||(x.StkPMISourceEnum={}))[e.PMISourceUnknown=0]="PMISourceUnknown",e[e.PMI_SOURCE_CONVERT=1]="PMI_SOURCE_CONVERT",e[e.PMI_SOURCE_CREATE=2]="PMI_SOURCE_CREATE",(t=I=x.StkPMITypeEnum||(x.StkPMITypeEnum={}))[t.PMI_TYPE_UNKNOWN=0]="PMI_TYPE_UNKNOWN",t[t.PMI_TYPE_LinearDimension=1]="PMI_TYPE_LinearDimension",t[t.PMI_TYPE_AngularDimension=2]="PMI_TYPE_AngularDimension",t[t.PMI_TYPE_CurvilinearDimension=3]="PMI_TYPE_CurvilinearDimension",t[t.PMI_TYPE_DiameterDimension=4]="PMI_TYPE_DiameterDimension",t[t.PMI_TYPE_LinearDiameterDimension=5]="PMI_TYPE_LinearDiameterDimension",t[t.PMI_TYPE_RadiusDimension=6]="PMI_TYPE_RadiusDimension",t[t.PMI_TYPE_LinearRadiusDimension=7]="PMI_TYPE_LinearRadiusDimension",t[t.PMI_TYPE_CumulatedDimension=8]="PMI_TYPE_CumulatedDimension",t[t.PMI_TYPE_ChamferDimension=9]="PMI_TYPE_ChamferDimension",t[t.PMI_TYPE_DistanceDimension=10]="PMI_TYPE_DistanceDimension",t[t.PMI_TYPE_LengthDimension=11]="PMI_TYPE_LengthDimension",t[t.PMI_TYPE_TypeNote=12]="PMI_TYPE_TypeNote",t[t.PMI_TYPE_TypeDatum=13]="PMI_TYPE_TypeDatum",t[t.PMI_TYPE_TypeBalloon=14]="PMI_TYPE_TypeBalloon",t[t.PMI_TYPE_TypeDatumTarget=15]="PMI_TYPE_TypeDatumTarget",t[t.PMI_TYPE_TypeRoughness=16]="PMI_TYPE_TypeRoughness",t[t.PMI_TYPE_TypeDimension=17]="PMI_TYPE_TypeDimension",t[t.PMI_TYPE_TypeFlagNote=18]="PMI_TYPE_TypeFlagNote",t[t.PMI_TYPE_TypeGeometricalTolerance=19]="PMI_TYPE_TypeGeometricalTolerance",t[t.PMI_TYPE_TypeAnnotationTable=20]="PMI_TYPE_TypeAnnotationTable",t[t.PMI_TYPE_TypeCell=21]="PMI_TYPE_TypeCell",t[t.PMI_TYPE_TypeTable=22]="PMI_TYPE_TypeTable",t[t.PMI_TYPE_TypeCallout=23]="PMI_TYPE_TypeCallout",t[t.PMI_TYPE_TypeWelding=24]="PMI_TYPE_TypeWelding",t[t.PMI_TYPE_TypeCoordinateDimension=25]="PMI_TYPE_TypeCoordinateDimension",t[t.PMI_TYPE_Symbol=26]="PMI_TYPE_Symbol",t[t.PMI_TYPE_SVIEW_3DNOTE=27]="PMI_TYPE_SVIEW_3DNOTE",t[t.PMI_TYPE_SVIEW_ARC=28]="PMI_TYPE_SVIEW_ARC",t[t.PMI_TYPE_SVIEW_NOTE_COMPONENT=29]="PMI_TYPE_SVIEW_NOTE_COMPONENT",t[t.PMI_TYPE_SVIEW_NOTE_WELD=30]="PMI_TYPE_SVIEW_NOTE_WELD",t[t.PMI_TYPE_SVIEW_NOTE_COMPONENT_SN=31]="PMI_TYPE_SVIEW_NOTE_COMPONENT_SN",t[t.PMI_TYPE_SVIEW_NOTE_WELD_SN=32]="PMI_TYPE_SVIEW_NOTE_WELD_SN",t[t.PMI_TYPE_SVIEW_PICTURE=33]="PMI_TYPE_SVIEW_PICTURE",t[t.PMI_TYPE_DISTANCE_POINT_TO_POINT=34]="PMI_TYPE_DISTANCE_POINT_TO_POINT",t[t.PMI_TYPE_DISTANCE_POINT_TO_LINE=35]="PMI_TYPE_DISTANCE_POINT_TO_LINE",t[t.PMI_TYPE_DISTANCE_POINT_TO_FACE=36]="PMI_TYPE_DISTANCE_POINT_TO_FACE",t[t.PMI_TYPE_DISTANCE_LINE_TO_LINE=37]="PMI_TYPE_DISTANCE_LINE_TO_LINE",t[t.PMI_TYPE_DISTANCE_LINE_TO_FACE=38]="PMI_TYPE_DISTANCE_LINE_TO_FACE",t[t.PMI_TYPE_DISTANCE_FACE_TO_FACE=39]="PMI_TYPE_DISTANCE_FACE_TO_FACE",t[t.PMI_TYPE_DISTANCE_CENTER_TO_CENTER=40]="PMI_TYPE_DISTANCE_CENTER_TO_CENTER",t[t.PMI_TYPE_DISTANCE_WHEELBASE=41]="PMI_TYPE_DISTANCE_WHEELBASE",(r=L=x.StkCurveTypeEnum||(x.StkCurveTypeEnum={}))[r.CURVE_TYPE_UNKNOWN=0]="CURVE_TYPE_UNKNOWN",r[r.CURVE_TYPE_POLYLINE=1]="CURVE_TYPE_POLYLINE",r[r.CURVE_TYPE_ELLIPSE=2]="CURVE_TYPE_ELLIPSE",r[r.CURVE_TYPE_LINE=3]="CURVE_TYPE_LINE",r[r.CURVE_TYPE_NURBSCURVE=4]="CURVE_TYPE_NURBSCURVE",r[r.CURVE_TYPE_HYPERBOLA=5]="CURVE_TYPE_HYPERBOLA",r[r.CURVE_TYPE_PARABOLA=6]="CURVE_TYPE_PARABOLA";var i=function(){function M(){}return M.CreateExtensionLines=function(e,t){var r=e.length;if(0==r)return!1;for(var i=0;i<r;i++){var n=e[i];if(null!=n){var o=n.exLineType;if(L.CURVE_TYPE_POLYLINE==o){var a=n.curves.polylines[0];if(null==a)continue;for(var s=[],l=0;l<a.points.length/3;l++){var h=new x.Vector3;h.x=a.points[3*l],h.y=a.points[3*l+1],h.z=a.points[3*l+2],s.push(h)}t.push(s)}else if(L.CURVE_TYPE_LINE==o){var u=n.curves.line;(s=[]).push(u.startPnt[0],u.startPnt[1],u.startPnt[2]),s.push(u.endPnt[0],u.endPnt[1],u.endPnt[2]),t.push(s)}}}return!0},M.CreateOutFrame=function(e,t,r){for(var i=0,n=0;n<e.length;n++)for(var o=e[n],a=o.GetFrameData(),s=(o.GetFrameType(),0);s<a.length;s++){var l=a[s],h=l.GetCurveType(),u=void 0;if(1==h)u=l.GetPoints();else if(2==h){var p=new x.Stk_Arc;p.fromJson(l),x.TessCircle.GetCircleDiscretization(p,0,u)}if(0!=u.length){for(var c=0;c<u.length;c++)t.push(u[c]),r.push(i),i++;r.push(M.SO_END_FACE_INDEX)}}return!0},M.CreateAnchorPoints=function(e,t,r){return!0},M.CreateEndSymbol=function(e,t,r){var i,n=[],o=[],a=[],s=[],l=[],h=new x.Vector3,u=new x.Vector3;if(null==e)return!1;var p=e.leaders;if(null==p)return!1;var c=0,d=p.length;if(d<=0)return!1;var S,f,m=[],y=p[0],T=L.CURVE_TYPE_UNKNOWN;if(null==y)return!1;if(null!=y.curves.polylines?S=y.curves.polylines:null!=y.curves.arcs?S=y.curves.arcs:null!=y.curves.lines&&(S=y.curves.lines),0==S.length)return!1;if(null==(f=S[S.length-1]))return!1;T=f.type,i=x.PMIUtility.GetEndSymbolDirection(p,m);for(var M=0;M<d;M++){if(a.length=0,s.length=0,null==(y=p[M]))return!1;r=y.termType;for(var g=0,v=y.termSize.split(" ");g<v.length;g++){var C=v[g];l.push(parseFloat(C))}if(h.fromString(y.termLoc),u.fromString(y.termDir),u.x!=u.x||u.y!=u.y)return!1;T==L.CURVE_TYPE_POLYLINE&&i&&(u.x=u.x*m[M],u.y=u.y*m[M],u.z=u.z*m[M]),n[0]=h.x,n[1]=h.y,n[2]=h.z,o[0]=u.x,o[1]=u.y,o[2]=u.z;var _=[0,0,0],A=[0,0,0],E=Math.sqrt(o[0]*o[0]+o[1]*o[1]+o[2]*o[2]);A[0]=o[0]/E,A[1]=o[1]/E,A[2]=o[2]/E,_[0]=-1*A[1],_[1]=A[0],_[2]=0,x.PMIESymbol.SetESymbolInfo(l[0],l[1],n,o,_,r,a,s);var G=a.length,P=[];for(c=0;c<G;c++){(w=new x.Vector3).x=a[c].x,w.y=a[c].y,w.z=a[c].z,P.push(w)}for(0<G&&t.push(P),P=[],G=s.length,c=0;c<G;c++){var w;(w=new x.Vector3).x=s[c].x,w.y=s[c].y,w.z=s[c].z,P.push(w)}0<G&&t.push(P)}return!0},M.CreateLeader=function(e,t,r,i){var n=[],o=[],a=[],s=!1,l=i.Source,h=i.Type,u=[];if(u.push(t),h==I.PMI_TYPE_TypeNote&&(u.length=0),e.length<=0)return!1;var p=e[0],c=[];if(null!=p.curves.polylines?c=p.curves.polylines:null!=p.curves.arcs?c=p.curves.arcs:null!=p.curves.lines&&(c=p.curves.lines),0==c.length)return!1;c[c.length-1].type==L.CURVE_TYPE_ELLIPSE&&(s=x.TessCircle.GetCircleDrawData(e,o,a,0,n)),x.PMIUtility.GetEndSymbolDirection(e,[]);var d=new x.Vector3;d.x=.5*(t.BoundBox[0][0]+t.BoundBox[1][0]),d.y=.5*(t.BoundBox[0][1]+t.BoundBox[1][1]),d.z=.5*(t.BoundBox[0][2]+t.BoundBox[1][2]);for(var S=new Array,f=0;f<e.length;f++){var m=e[f],y=[],T=[],M=0,g=[],v=[];null!=m.curves.polylines?v=m.curves.polylines:null!=m.curves.arcs?v=m.curves.arcs:null!=m.curves.lines&&(v=m.curves.lines);var C=v[0];if(null!=C)if(L.CURVE_TYPE_POLYLINE==C.type){for(var _=[],A=0;A<C.points.length/3;A++){var E=new x.Vector3;E.x=C.points[3*A],E.y=C.points[3*A+1],E.z=C.points[3*A+2],_.push(E)}if(l!=R.PMI_SOURCE_CREATE||h!=I.PMI_TYPE_RadiusDimension&&h!=I.PMI_TYPE_DiameterDimension?x.PMIUtility.DivideLeader(2,u,_,g):2==_.length&&x.PMIUtility.DivideLeader(2,u,_,g),0!=_.length)if(0==g.length)for(var G=0;G<_.length;G++)y.push(_[G]),T.push(M),M++;else for(G=0;G<g.length;G++)y.push(g[G]),T.push(M),M++;r.push(y),M}else if(L.CURVE_TYPE_ELLIPSE==C.type){var P=[],w=new x.Stk_Arc;w.fromJson(C);if(s?x.TessCircle.GetCircleDiscretization2(w,o[f],a[f],0,n[f],P):x.TessCircle.GetCircleDiscretization(w,0,P),x.PMIUtility.DivideLeader(2,u,P,g),0!=P.length)if(0==g.length)for(G=0;G<3;G++)y.push(P[G]),T.push(M),M++;else for(G=0;G<g.length;G++)y.push(g[G]),T.push(M),M++;r.push(y),M,0<S.length&&(g.length=0,x.PMIUtility.DivideLeader(2,u,S,g),0==g.length?(r.push(S),S.length):(r.push(g),g.length))}else if(L.CURVE_TYPE_LINE==C.type){var D=[];D.push(new x.Vector3(C.StartPoint[0],C.StartPoint[1],C.StartPoint[2])),D.push(new x.Vector3(C.EndPoint[0],C.EndPoint[1],C.EndPoint[2])),r.push(D),2}}return!0},M.CreateSpeciallLines=function(e,t,r){for(var i=0,n=0;n<e.length;n++){var o=e[n];if(null!=o.curves.polylines)for(var a=o.curves.polylines,s=0;s<a.length;s++){for(var l=a[s],h=[],u=0;u<l.points.length/3;u++){var p=new x.Vector3;p.x=l.points[3*u],p.y=l.points[3*u+1],p.z=l.points[3*u+2],h.push(p)}if(0!=h.length){for(var c=0;c<h.length;c++)t.push(h[c]),r.push(i),i++;r.push(M.SO_END_FACE_INDEX)}}if(null!=o.curves.arcs)for(a=o.curves.arcs,s=0;s<a.length;s++){var d=new x.Stk_Arc;d.fromJson(a[s]);h=[];if(x.TessCircle.GetCircleDiscretization(d,0,h),0!=h.length){for(var S=0;S<h.length;S++)t.push(h[S]),r.push(i),i++;r.push(M.SO_END_FACE_INDEX)}}if(null!=o.curves.lines)for(a=o.curves.lines,s=0;s<a.length;s++){var f=a[s],m=(h=[],new x.Vector3);m.fromString(f.startPnt);var y=new x.Vector3;if(y.fromString(f.endPnt),h.push(m),h.push(y),0!=h.length){for(var T=0;T<h.length;T++)t.push(h[T]),r.push(i),i++;r.push(M.SO_END_FACE_INDEX)}}}return!0},M.SO_END_FACE_INDEX=-1,M}();x.PMICreator=i}(M3D||(M3D={})),function(Y){var e;(e=Y.StkTermTypeEnum||(Y.StkTermTypeEnum={}))[e.TERM_PATSMNONE=0]="TERM_PATSMNONE",e[e.TERM_PATSMOPENARROW=1]="TERM_PATSMOPENARROW",e[e.TERM_PATSMCLOSEARROW=2]="TERM_PATSMCLOSEARROW",e[e.TERM_PATSMFILLARROW=3]="TERM_PATSMFILLARROW",e[e.TERM_PATSMCROSSARROW=4]="TERM_PATSMCROSSARROW",e[e.TERM_PATSMCIRCLE=5]="TERM_PATSMCIRCLE",e[e.TERM_PATSMFILLEDCIRCLE=6]="TERM_PATSMFILLEDCIRCLE",e[e.TERM_PATSMSQUARE=7]="TERM_PATSMSQUARE",e[e.TERM_PATSMFILLEDSQUARE=8]="TERM_PATSMFILLEDSQUARE",e[e.TERM_PATSMSLASH=9]="TERM_PATSMSLASH",e[e.TERM_PATSMCROSSCIRCLE=10]="TERM_PATSMCROSSCIRCLE",e[e.TERM_PATSMXCIRCLE=11]="TERM_PATSMXCIRCLE",e[e.TERM_PATSMTRIANGLE=12]="TERM_PATSMTRIANGLE",e[e.TERM_PATSMFILLEDTRIANGLE=13]="TERM_PATSMFILLEDTRIANGLE",e[e.TERM_PATSMPLUS=14]="TERM_PATSMPLUS",e[e.TERM_PATSMXCROSS=15]="TERM_PATSMXCROSS",e[e.TERM_PATSMINTEGRAL=16]="TERM_PATSMINTEGRAL",e[e.TERM_PATSMCIRCLECENTER=17]="TERM_PATSMCIRCLECENTER",e[e.TERM_PATSMDOUBLEOPENCENTER=18]="TERM_PATSMDOUBLEOPENCENTER",e[e.TERM_PATSMDOUBLECLOSEARROW=19]="TERM_PATSMDOUBLECLOSEARROW",e[e.TERM_PATSMDOUBLEFILLARROW=20]="TERM_PATSMDOUBLEFILLARROW",e[e.TERM_PATSMDOUBLETRIANGLE=21]="TERM_PATSMDOUBLETRIANGLE",e[e.TERM_PATSMWHTTRI=22]="TERM_PATSMWHTTRI",e[e.TERM_PATSMBLKTRI=23]="TERM_PATSMBLKTRI",e[e.TERM_PATSMWHTTRI2=24]="TERM_PATSMWHTTRI2",e[e.TERM_PATSMSPACELIN=25]="TERM_PATSMSPACELIN";var t=function(){function W(){}return W.SetESymbolInfo=function(e,t,r,i,n,o,a,s){var l,h,u,p,c,d,S,f,m,y=[0,0,0],T=[0,0,0],M=0,g=0,v=0,C=t/2,_=[0,0,0],A=[0,0,0],E=37,G=Y.PI/18,P=0,w=Y.PI/4,D=[0,0,0],x=[[0,0,0],[0,0,0],[0,0,0],[0,0,0]],R=[[0,0,0],[0,0,0],[0,0,0],[0,0,0]],I=[1,0,0],L=[0,1,0],N=[0,0,0],O=[0,0,0],b=new Y.Vector3,V=new Y.Vector3,F=new Y.Vector3,B=new Y.Vector3,U=new Y.Vector3,H=new Y.Vector3;switch(this.LengthAndUnit(3,i,0,y),this.LengthAndUnit(3,n,0,T),M=e/(v=Math.sqrt(C*C+e*e)),g=C/v,_[0]=T[0],_[1]=T[1],_[2]=T[2],A[0]=-T[0],A[1]=-T[1],A[2]=-T[2],l=t/2,v/2,S=(c=u=h=t)/2,f=(d=p=e)/2,m=e/3*2,o){case W.TERM_PATSMARW:case W.TERM_PATSMWHTARW:case W.TERM_PATSMBLKARW:case W.PATCROSSARW:var k=new Y.Vector3;k.x=r[0]+e*i[0],k.y=r[1]+e*i[1],k.z=r[2]+e*i[2],b.x=k.x+t/2*_[0],b.y=k.y+t/2*_[1],b.z=k.z+t/2*_[2],a.push(b.Clone()),b.x=r[0],b.y=r[1],b.z=r[2],a.push(b.Clone()),b.x=k.x+t/2*A[0],b.y=k.y+t/2*A[1],b.z=k.z+t/2*A[2],a.push(b.Clone()),o==W.TERM_PATSMWHTARW&&(b.x=k.x+t/2*_[0],b.y=k.y+t/2*_[1],b.z=k.z+t/2*_[2],a.push(b.Clone()));break;case W.TERM_PATSMWHTCIR:case W.TERM_PATSMBLKCIR:case W.TERM_PATSMCROSSEDCIR:o==W.TERM_PATSMBLKCIR&&(E=6,G=2*Y.PI/6);for(var z=0;z<E;z++)b.x=r[0]+l*Math.cos(G*z),b.y=r[1]+l*Math.sin(G*z),b.z=r[2],a.push(b.Clone());break;case W.TERM_PATSMSLASH_TYPE:P=Math.sqrt(t*t+e*e),D[0]=y[0]*Math.cos(w)-y[1]*Math.sin(w),D[1]=y[0]*Math.sin(w)+y[1]*Math.cos(w),D[2]=0,b.x=r[0]+P/2*D[0],b.y=r[1]+P/2*D[1],b.z=r[2],a.push(b.Clone()),b.x=b.x-P*D[0],b.y=b.y-P*D[1],b.z=r[2],a.push(b.Clone());break;case W.TERM_PATSMWHTTRI_TYPE:case W.TERM_PATSMBLKTRI_TYPE:case W.TERM_PATSMWHTTRI2_TYPE:case W.PATSSPACELIN_TYPE:x[0][0]=r[0]+p*y[0],x[0][1]=r[1]+p*y[1],x[0][2]=0,x[2][2]=(x[2][1]=o==W.PATSSPACELIN_TYPE?(x[1][0]=r[0]+u/2*y[1]+1*y[0],x[1][1]=r[1]-u/2*y[0]+1*y[1],x[1][2]=0,x[2][0]=r[0]-u/2*y[1]+1*y[0],r[1]+u/2*y[0]+1*y[1]):(x[1][0]=r[0]+h/2*y[1],x[1][1]=r[1]-h/2*y[0],x[1][2]=0,x[2][0]=r[0]-h/2*y[1],r[1]+h/2*y[0]),0),x[3][0]=r[0]+p*y[0],x[3][1]=r[1]+p*y[1],x[3][2]=0,o==W.PATSSPACELIN_TYPE?(b.x=x[1][0],b.y=x[1][1],b.z=r[2],a.push(b.Clone()),b.x=x[2][0],b.y=x[2][1],b.z=r[2],a.push(b.Clone()),b.x=x[2][0],b.y=x[2][1],b.z=r[2],a.push(b.Clone())):(b.x=x[2][0],b.y=x[2][1],b.z=r[2],a.push(b.Clone()),b.x=x[0][0],b.y=x[0][1],b.z=r[2],a.push(b.Clone()),b.x=x[1][0],b.y=x[1][1],b.z=r[2],a.push(b.Clone()),o==W.TERM_PATSMWHTTRI_TYPE&&(b.x=x[2][0],b.y=x[2][1],b.z=r[2],a.push(b.Clone())));break;case W.TERM_PATSMCRSBIG:R[0][0]=r[0]-c/2*I[0],R[0][1]=r[1]-c/2*I[1],R[0][2]=0,R[1][0]=r[0]+c/2*I[0],R[1][1]=r[1]+c/2*I[1],R[1][2]=0,R[2][0]=r[0]-d/2*L[0],R[2][1]=r[1]-d/2*L[1],R[2][2]=0,R[3][0]=r[0]+d/2*L[0],R[3][1]=r[1]+d/2*L[1],R[3][2]=0,b.x=R[0][0],b.y=R[0][1],b.z=r[2],a.push(b.Clone()),b.x=R[1][0],b.y=R[1][1],b.z=r[2],a.push(b.Clone()),b.x=r[0],b.y=r[1],b.z=r[2],a.push(b.Clone()),b.x=R[2][0],b.y=R[2][1],b.z=r[2],a.push(b.Clone()),b.x=R[3][0],b.y=R[3][1],b.z=r[2],a.push(b.Clone());break;case W.TERM_PATSMWHTSQR:case W.TERM_PATSMBLKSQR:case W.TERM_PATSMCRSX:b.x=r[0]+v*_[0]-f*y[0],b.y=r[1]+v*_[1]-f*y[1],b.z=r[2],a.push(b.Clone()),b.x=r[0]+v*_[0]-3*f*y[0],b.y=r[1]+v*_[1]-3*f*y[1],b.z=r[2],o==W.TERM_PATSMCRSX?s.push(b.Clone()):a.push(b.Clone()),b.x=r[0]+v*A[0]-3*f*y[0],b.y=r[1]+v*A[1]-3*f*y[1],b.z=r[2],a.push(b.Clone()),b.x=r[0]+v*A[0]-f*y[0],b.y=r[1]+v*A[1]-f*y[1],b.z=r[2],o==W.TERM_PATSMCRSX?s.push(b.Clone()):a.push(b.Clone()),o==W.TERM_PATSMWHTSQR&&(b.x=r[0]+v*_[0]-f*y[0],b.y=r[1]+v*_[1]-f*y[1],b.z=r[2],a.push(b.Clone()));break;case W.TERM_PATSMWHTTRI3:case W.TERM_PATSMBLKTRI2:N[0]=-y[1],N[1]=y[0],O[N[2]=0]=r[0]+S*N[0],O[1]=r[1]+S*N[1],O[2]=0,b.x=r[0]-S*N[0],b.y=r[1]-S*N[1],b.z=r[2],a.push(b.Clone()),b.x=O[0]+f*y[0],b.y=O[1]+f*y[1],b.z=r[2],a.push(b.Clone()),b.x=O[0]-f*y[0],b.y=O[1]-f*y[1],b.z=r[2],a.push(b.Clone()),o==W.TERM_PATSMWHTTRI3&&(b.x=r[0]-S*N[0],b.y=r[1]-S*N[1],b.z=r[2],a.push(b.Clone()));break;case W.TERM_PATSMDBOPNARW:M=m/(v=Math.sqrt(m*m+C*C)),g=C/v,_[0]=y[0]*M-y[1]*g,_[1]=y[0]*g+y[1]*M,A[_[2]=0]=y[0]*M+y[1]*g,A[1]=-y[0]*g+y[1]*M,A[2]=0,b.x=r[0]+_[0]*v,b.y=r[1]+_[1]*v,b.z=r[2],a.push(b.Clone()),b.x=r[0],b.y=r[1],b.z=r[2],a.push(b.Clone()),b.x=r[0]+A[0]*v,b.y=r[1]+A[1]*v,b.z=r[2],a.push(b.Clone()),b.x=r[0]+y[0]*(m/2),b.y=r[1]+y[1]*(m/2),b.z=r[2],V.x=b.x+_[0]*v,V.y=b.y+_[1]*v,V.z=r[2],s.push(V.Clone()),s.push(b.Clone()),V.x=b.x+A[0]*v,V.y=b.y+A[1]*v,V.z=r[2],s.push(V.Clone());break;case W.TERM_PATSMDBCLSARW:case W.TERM_PATSMDBFILLARW:M=m/(v=Math.sqrt(m*m+C*C)),g=C/v,_[0]=y[0]*M-y[1]*g,_[1]=y[0]*g+y[1]*M,A[_[2]=0]=y[0]*M+y[1]*g,A[1]=-y[0]*g+y[1]*M,A[2]=0,b.x=r[0]+_[0]*v,b.y=r[1]+_[1]*v,b.z=r[2],U=b,a.push(b.Clone()),b.x=r[0],b.y=r[1],b.z=r[2],a.push(b.Clone()),b.x=r[0]+A[0]*v,b.y=r[1]+A[1]*v,b.z=r[2],H=b,a.push(b.Clone()),W.TERM_PATSMDBCLSARW==o&&(b.x=r[0]+_[0]*v,b.y=r[1]+_[1]*v,b.z=r[2],a.push(b.Clone())),B.x=r[0]+m/2*y[0],B.y=r[1]+m/2*y[1],B.z=0,U.x=U.x+m/2*y[0],U.y=U.y+m/2*y[1],U.z=r[2],W.TERM_PATSMDBCLSARW==o?s.push(U):a.push(U),F.x=U.x,F.y=U.y,F.z=U.z,H.x=H.x+m/2*y[0],H.y=H.y+m/2*y[1],H.z=r[2],W.TERM_PATSMDBCLSARW==o?s.push(H):a.splice(3,0,H),H.x=(H.x+B.x)/2,H.y=(H.y+B.y)/2,H.z=r[2],W.TERM_PATSMDBCLSARW==o?s.push(H):a.splice(3,0,H),U.x=(U.x+B.x)/2,U.y=(U.y+B.y)/2,U.z=r[2],W.TERM_PATSMDBCLSARW==o?s.push(U):a.push(U),W.TERM_PATSMDBCLSARW==o&&s.push(F);break;case W.TERM_PATSMDBFILLTRI:M=m/(v=Math.sqrt(m*m+C*C)),g=C/v,_[0]=y[0]*M-y[1]*g,_[1]=y[0]*g+y[1]*M,A[_[2]=0]=y[0]*M+y[1]*g,A[1]=-y[0]*g+y[1]*M,A[2]=0,b.x=r[0]+y[0]*e,b.y=r[1]+y[1]*e,b.z=r[2],V.x=b.x,V.y=b.y,V.z=b.z,b.x=b.x-_[0]*v,b.y=b.y-_[1]*v,b.z=r[2],a.push(b.Clone()),a.push(V),b.x=V.x-A[0]*v,b.y=V.y-A[1]*v,b.z=r[2],a.push(b.Clone()),B.x=r[0]+y[0]*m,B.y=r[1]+y[1]*m,B.z=0,H.x=r[0]+C*T[0],H.y=r[1]+C*T[1],H.z=r[2],a.push(H),U.x=r[0]-C*T[0],U.y=r[1]-C*T[1],U.z=r[2],a.push(U),H.x=(H.x+B.x)/2,H.y=(H.y+B.y)/2,H.z=r[2],a.splice(3,0,H),U.x=(U.x+B.x)/2,U.y=(U.y+B.y)/2,U.z=r[2],a.push(U);break;case W.TERM_PATSMNO:break;default:b.x=r[0]+v*_[0],b.y=r[1]+v*_[1],b.z=r[2],a.push(b.Clone()),b.x=r[0],b.y=r[1],b.z=r[2],a.push(b.Clone()),b.x=r[0]+v*A[0],b.y=r[1]+v*A[1],b.z=r[2],a.push(b.Clone()),b.x=r[0]+v*_[0],b.y=r[1]+v*_[1],b.z=r[2],a.push(b.Clone())}return 0},W.LengthAndUnit=function(e,t,r,i){var n=0,o=0,a=0,s=0;if(3==e)if((a=t[0]*t[0]+t[1]*t[1]+t[2]*t[2])<W.ZDEPS){i[0]=t[0],i[1]=t[1],i[2]=t[2],n=-2}else{s=Math.sqrt(a),i[0]=t[0]/s,i[1]=t[1]/s,i[2]=t[2]/s;n=0}else if(2==e)if((a=t[0]*t[0]+t[1]*t[1])<W.ZDEPS){i[0]=t[0],i[1]=t[1],n=-2}else{s=Math.sqrt(a),i[0]=t[0]/s,i[1]=t[1]/s;n=0}else if(0<e){for(o=a=0;o<e;o++)a+=t[o]*t[o];if(a<W.ZDEPS){for(o=0;o<e;o++)i[o]=t[o];n=-2}else{for(s=Math.sqrt(a),o=0;o<e;o++)i[o]=t[o]/s;n=0}}else n=-1;return n},W.TERM_PATSMNO=0,W.TERM_PATSMARW=1,W.TERM_PATSMWHTARW=2,W.TERM_PATSMBLKARW=3,W.PATCROSSARW=4,W.TERM_PATSMWHTCIR=5,W.TERM_PATSMBLKCIR=6,W.TERM_PATSMWHTSQR=7,W.TERM_PATSMBLKSQR=8,W.TERM_PATSMSLASH_TYPE=9,W.TERM_PATSMCROSSEDCIR=10,W.TERM_PATSMDBXCIRCLE=11,W.TERM_PATSMWHTTRI3=12,W.TERM_PATSMBLKTRI2=13,W.TERM_PATSMCRSBIG=14,W.TERM_PATSMCRSX=15,W.TERM_PATSMCIRCENT=17,W.TERM_PATSMDBOPNARW=18,W.TERM_PATSMDBCLSARW=19,W.TERM_PATSMDBFILLARW=20,W.TERM_PATSMDBFILLTRI=21,W.TERM_PATSMWHTTRI_TYPE=22,W.TERM_PATSMBLKTRI_TYPE=23,W.PATSSPACELIN_TYPE=24,W.TERM_PATSMWHTTRI2_TYPE=25,W.TERM_PATSMUSR=100,W.PI=3.141592653589793,W.USERNOTEIDSTART=5e5,W.ZDEPS=1e-18,W}();Y.PMIESymbol=t}(M3D||(M3D={})),function(C){var e=function(){function v(){}return v.GetEndSymbolDirection=function(e,t){var r,i,n,o;if(2!=e.length)return!1;for(var a=0;a<e.length;a++){var s=e[a];if(1!=s.type)return!1;r.length=0;var l=s.curves.polylines;if(0==l.length)return!1;r=l[l.length-1].points,i[a]=r[0],n[a]=r[1]}o[0]=o[1]=1,n[0].x==n[1].x&&n[0].y==n[1].y&&(i[0].x<i[1].x?n[0].x<i[0].x?o[0]=-1:n[0].x>i[1].x&&(o[1]=-1):i[0].x>i[1].x?n[0].x<i[1].x?o[1]=-1:n[0].x>i[0].x&&(o[0]=-1):i[0].y<i[1].y?n[0].y<i[0].y?o[0]=-1:n[0].y>i[1].y&&(o[1]=-1):i[0].y>i[1].y&&(n[0].y<i[1].y?o[1]=-1:n[0].y>i[0].y&&(o[0]=-1)));for(a=0;a<2;a++)t.push(o[a]);return!0},v.DivideLeader=function(e,t,r,i){var n,o,a,s=[],l=[],h=[],u=new C.Vector3,p=[],c=0,d=0,S=0,f=0,m=0;if(e!=v.PMIDIM2)return!1;for(d=0;d<t.length;d++)if(n=t[d],s.length=0,o=v.ResetTextBox(n),v.CheckPntFrmInter(e,r,o,s))for(l[0]=new C.Vector3,l[0].x=n.BoundBox[0][0],l[0].y=n.BoundBox[0][1],l[0].z=0,l[1]=new C.Vector3,l[1].x=n.BoundBox[0][0],l[1].y=n.BoundBox[1][1],l[1].z=0,l[2]=new C.Vector3,l[2].x=n.BoundBox[1][0],l[2].y=n.BoundBox[1][1],l[2].z=0,l[3]=new C.Vector3,l[3].x=n.BoundBox[1][0],l[3].y=n.BoundBox[0][1],l[3].z=0,l[4]=new C.Vector3,l[4].x=l[0].x,l[4].y=l[0].y,l[4].z=0,i.push(r[0]),f=1;f<r.length;f++)if(s[f-1]){for(h[p.length=0]=r[f-1],h[1]=r[f],S=0;S<4;S++){var y=[l[S],l[S+1]];v.GetLineCrossPoint(e,y,h,0,u)}if(0!=p.length){if(1==p.length)i.push(p[0]);else if(2<=p.length&&p.length<=v.ARAAYNUM){for(m=c=a[v.ARAAYNUM]=0;m<p.length;m++)a[m]=Math.sqrt((p[m].x-h[0].x)*(p[m].x-h[0].x)+(p[m].y-h[0].y)*(p[m].y-h[0].y)),0==m?(a[v.ARAAYNUM]=a[0],c=0):a[v.ARAAYNUM]>a[m]&&(a[v.ARAAYNUM]=a[m],c=m);i.push(p[c])}else i.push(p[0]);break}i.push(r[f])}else i.push(r[f]);return!0},v.ResetTextBox=function(e){var t=new C.STK_BOX32;return e.BoundBox[0][0]<e.BoundBox[1][0]?(t.BoundBox[0][0]=e.BoundBox[0][0],t.BoundBox[1][0]=e.BoundBox[1][0]):(t.BoundBox[0][0]=e.BoundBox[1][0],t.BoundBox[1][0]=e.BoundBox[0][0]),e.BoundBox[0][1]<e.BoundBox[1][1]?(t.BoundBox[0][1]=e.BoundBox[0][1],t.BoundBox[1][1]=e.BoundBox[1][1]):(t.BoundBox[0][1]=e.BoundBox[1][1],t.BoundBox[1][1]=e.BoundBox[0][1]),t.BoundBox[0][2]=0,t.BoundBox[1][2]=0,t},v.CheckPntFrmInter=function(e,t,r,i){var n,o=[],a=new C.STK_BOX32,s=!1;if(e!=v.PMIDIM2)return!1;i.length=0,a.BoundBox[0][2]=0,a.BoundBox[1][2]=0;for(var l=1;l<t.length;l++)n=!0,o[0]=t[l-1],o[1]=t[l],o[0].x<o[1].x?(a.BoundBox[0][0]=o[0].x,a.BoundBox[1][0]=o[1].x):(a.BoundBox[0][0]=o[1].x,a.BoundBox[1][0]=o[0].x),o[0].y<o[1].y?(a.BoundBox[0][1]=o[0].y,a.BoundBox[1][1]=o[1].y):(a.BoundBox[0][1]=o[1].y,a.BoundBox[1][1]=o[0].y),(a.BoundBox[1][0]<r.BoundBox[0][0]-v.ZTOL||a.BoundBox[0][0]>r.BoundBox[1][0]+v.ZTOL)&&(n=!1),(a.BoundBox[1][1]<r.BoundBox[0][1]-v.ZTOL||a.BoundBox[0][1]>r.BoundBox[1][1]+v.ZTOL)&&(n=!1),n&&(s=!0),i.push(n);return s},v.GetLineCrossPoint=function(e,t,r,i,n){var o,a,s,l,h,u,p,c,d=!0,S=0,f=0,m=!1,y=0,T=0,M=!1,g=new C.Vector3;if(o=h=0,a=u=0,s=p=0,l=c=0,m=M=!(i=-1),v.PMIDIM2!=e)return!1;if(t[1].x==t[0].x){if(t[1].y==t[0].y)return!1;m=!0,s=t[1].y>t[0].y?t[0].y:t[1].y,l=t[1].y<t[0].y?t[0].y:t[1].y}else S=(t[1].y-t[0].y)/(t[1].x-t[0].x),a=t[1].x>t[0].x?(o=t[0].x,t[1].x):(o=t[1].x,t[0].x);if(r[1].x==r[0].x){if(r[1].y==r[0].y)return!1;M=!0,p=r[1].y>r[0].y?r[0].y:r[1].y,c=r[1].y<r[0].y?r[0].y:r[1].y}else y=(r[1].y-r[0].y)/(r[1].x-r[0].x),u=r[1].x>r[0].x?(h=r[0].x,r[1].x):(h=r[1].x,r[0].x);return m||M?(i=2,m&&M?t[0].x==r[0].x?(i=1,g.x=t[0].x,g.y=t[0].y<=t[1].y?t[0].y:t[1].y):i=0:m?(T=r[0].y-r[0].x*y,g.x=t[0].x,g.y=y*g.x+T):M&&(f=t[0].y-t[0].x*S,g.x=r[0].x,g.y=S*g.x+f)):(f=t[0].y-t[0].x*S,T=r[0].y-r[0].x*y,S==y?(i=0,f==T&&(i=1,o=t[0].x<=t[1].x?t[0].x:t[1].x,h=r[0].x<=r[1].x?r[0].x:r[1].x,g.x=o<=h?o:h,g.y=S*g.x+f)):(i=2,g.y=f==T?(g.x=0,f):(g.x=(T-f)/(S-y),S*g.x+f))),0!=i&&(m?(g.y>l||g.y<s)&&(d=!1):(g.x>a||g.x<o)&&(d=!1),M?(g.y>c||g.y<p)&&(d=!1):(g.x>u||g.x<h)&&(d=!1)),g,d},v.ARAAYNUM=4,v.PMIDIM2=2,v.ZTOL=2e-10,v}();C.PMIUtility=e}(M3D||(M3D={})),function(t){var e=function(){function e(){}return e.prototype.fromJson=function(e){this.m_fStartPar=e.beginPar,this.m_pntStart=new t.Vector3,this.m_pntStart.fromString(e.beginPnt),this.m_pntCenter=new t.Vector3,this.m_pntCenter.fromString(e.center),this.m_fEndPar=e.endPar,this.m_pntEnd=new t.Vector3,this.m_pntEnd.fromString(e.endPnt),this.id=e.id,this.m_fMajorRadius=e.majorRadius,this.m_fUMax=e.max,this.m_fUMin=e.min,this.m_fMinorRadius=e.minorRadius,this.m_dirNormal=new t.Vector3,this.m_dirNormal.fromString(e.normal),this.m_dirOrigin=new t.Vector3,this.m_dirOrigin.fromString(e.originDir),this.type=e.type,this.m_dirX=new t.Vector3,this.m_dirX.fromString(e.xDir),this.m_dirY=new t.Vector3,this.m_dirY.fromString(e.yDir),this.m_dirZ=new t.Vector3,this.m_dirZ.fromString(e.zDir)},e}();t.Stk_Arc=e}(M3D||(M3D={})),function(e){var t=function(){this.BoundBox=[[0,0,0],[0,0,0]]};(M3D||(M3D={})).STK_BOX32=t}(),function(e){var t,r;(r=t||(t={}))[r.LEADER_TYPE_UNKNOWN=0]="LEADER_TYPE_UNKNOWN",r[r.LEADER_TYPE_LENGTH=1]="LEADER_TYPE_LENGTH",r[r.LEADER_TYPE_ANGULAR=2]="LEADER_TYPE_ANGULAR";var i=function(){};e.Stk_Leader=i}(M3D||(M3D={})),function(f){var e=function(){function S(){}return S.GetCircleDrawData=function(e,t,r,i,n){for(var o,a,s=0;s<e.length;s++){var l=e[s];if(2!=l.type)return!1;var h=l.curves.polylines;if(0==h.length)return!1;var u=h[h.length-1];u.GetRadius(void 0,void 0),u.GetCoordinatePnt(void 0,void 0),o=u.GetCenterPoint(),a=u.GetNormal(),this.GetCircleAngleParameter(2,void 0,o,void 0,void 0),this.GetCircleAngleParameter(2,void 0,o,void 0,void 0),(void 0).push(a.z),t.push(void 0),r.push(void 0)}},S.GetCircleAngleParameter=function(e,t,r,i,n){var o;return 2==e&&(1<(o=(t.x-r.x)/i)?o-1<S.ANGLEPARA_TOL&&(2*f.PI,!0):o<-1?Math.abs(1+o)<S.ANGLEPARA_TOL&&(f.PI,!0):(t.x-r.x<0&&t.y-r.y<0||0<t.x-r.x&&t.y-r.y<0?2*f.PI-Math.acos(o):t.x-r.x==0&&t.y-r.y<0?f.PI+Math.acos(o):Math.acos(o),!0))},S.GetCircleDiscretization=function(e,t,r){var i,n,o,a,s,l;return e.m_fMajorRadius,i=e.m_fMinorRadius,n=e.m_pntCenter,o=e.m_pntStart,a=e.m_pntEnd,s=e.m_dirNormal,S.GetCircleAngleParameter(S.PMIDIM2,o,n,i,void 0),S.GetCircleAngleParameter(S.PMIDIM2,a,n,i,void 0),l=0==t?0<s.z?1:-1:t,S.MakeArcDiscretization(n,i,void 0,void 0,0,l,r)},S.GetCircleDiscretization2=function(e,t,r,i,n,o){var a,s,l=new f.Vector3,h=new f.Vector3;return e.m_fMajorRadius,a=e.m_fMinorRadius,l=e.m_pntCenter,s=0==n?0<h.z?1:-1:n,S.MakeArcDiscretization(l,a,t,r,i,s,o)},S.MakeArcDiscretization=function(e,t,r,i,n,o,a){var s=new f.Vector3,l=0,h=0,u=0;0<n?u=n:r<i?u=0<o?i-r:2*f.PI-i+r:i<r?u=0<o?2*f.PI-r+i:r-i:i==r&&(u=2*f.PI);var p=S.DIVANGLE*(f.PI/180),c=u/p;c<4&&(p=u/(c=4));for(var d=0;d<c+1;d++)h=(l=r+o*p*d)<0?2*f.PI+l:l>2*f.PI?l-2*f.PI:l,d==c&&(h=i),s.x=e.x+t*Math.cos(h),s.y=e.y+t*Math.sin(h),s.z=0,a.push(s);return!0},S.IDXNUM=16384,S.ZDEPS=1e-18,S.MAXPNTVAL=1e8,S.ZTOL=2e-10,S.ANGLEPARA_TOL=.1,S.ARAAYNUM=4,S.PMIDIM2=2,S.DIVANGLE=2,S.PI=3.141592653589793,S}();f.TessCircle=e}(M3D||(M3D={})),function(o){var e=function(){function e(e){this.sceneMgr=null,this.allSubModels=[],this.currentreader=null,this.CurrentShowModel=null,this.openFileEnd=function(){},this.svlxReaderMap={},this.sceneMgr=e}return e.prototype.AddSVLXreader=function(e){this.svlxReaderMap[e.Id]=e,this.CurrentShowModel=e.GetModel()},e.prototype.AsynFillModelEnd=function(e,t){t.svlxReaderMap[e.Id]=null,t.doNextReaderFill(),t.sceneMgr.OptimizeCameraView(!0),t.CurrentShowModel=null},e.prototype.doNextReaderFill=function(){var e=Object.getOwnPropertyNames(this.svlxReaderMap);if(0<e.length){for(var t=!0,r=0;r<e.length;r++){var i=e[r],n=this.svlxReaderMap[i];if(null!==n){this.svlxReaderMap[i]=null,t=!(n instanceof o.SvlxReader)||(n.AsynFillModelMesh(),!1);break}}!0===t&&(this.svlxReaderMap={},this.openFileEnd&&(this.openFileEnd(),this.openFileEnd=null))}},e}();o.ModelFillManager=e}(M3D||(M3D={})),function(e){var t=function(){this.onReadBegin=function(e){},this.onReadCancel=function(e){},this.onReading=function(e){},this.onReadEnd=function(e){},this.onSingleFileReadEnd=function(e){}};e.ReadListener=t;var r=function(){this.allFilesCount=1,this.currentFileIndex=0,this.currentFilesName="",this.onReadEnd=function(e){}};e.ReadNextListener=r;var i=function(){this.onReadEnd=function(e){}};e.ReadModelListener=i}(M3D||(M3D={})),function(k){var e=function(t){function e(){var e=t.call(this)||this;return e.host="",e.animationsrc="",e.childAnimationSrc={},e.instanceIdMap={},e.parentId_subInstanceId={},e.topInstanceId=[],e.modelMap={},e.modelBoundingBox={},e.hasLoadedModelMap={},e.mergeFaceFlag=!1,e.delay=50,e.zipFile=null,e.asynFillModelFlag=!1,e.allMeshFaceMap={},e.allMeshEdgeMap={},e.parseModelsMap={},e.modelViewArray={},e.materialMap={},e.imagesMap={},e.m_protoTypeMaterialCache={},e.m_protoTypeColorCache={},e.m3dMaterialMap={},e.SaveMeasure=function(e){},e.instanceAttrMap={},e.pmiMap=new k.Map,e.modelPMIMap=new k.Map,e.storyList=null,e}return __extends(e,t),e.prototype.setHost=function(e){this.host=e},e.prototype.getHost=function(){return this.host},e.prototype.getFileName=function(){return this.fileName},e.prototype.setFileName=function(e){this.fileName=e},e.prototype.getAnimation=function(){return this.animationsrc},e.prototype.getChildAnimation=function(){return this.childAnimationSrc},e.prototype.getFileFromRemote=function(e,t,r,i,n,o,a){if(!i){var s=new XMLHttpRequest;e+=(/\?/.test(e)?"&":"?")+(new Date).getTime(),s.open("GET",e,!0),s.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),r&&(s.responseType=r),s.onreadystatechange=function(){if(4===s.readyState&&200===s.status){var e=s.response;n&&n(e)}},o&&(s.onprogress=o),s.send(t)}},e.prototype.GetDString=function(e,t){var r=CryptoJS.enc.Utf8.parse(CryptoJS.MD5(this.GetRandomString()).toString()),i=CryptoJS.enc.Utf8.parse(CryptoJS.MD5(this.GetRandomString()).toString().substring(0,16));return CryptoJS.AES.decrypt(e,r,{iv:i,mode:CryptoJS.mode.CBC,padding:CryptoJS.pad.Pkcs7}).toString(CryptoJS.enc.Utf8)},e.prototype.GetRandomString=function(e){if(this.random)return this.random;e=e||32;for(var t="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678oOLl9gqVvUuI1",r=t.length,i="",n=0;n<e;n++)i+=t.charAt(Math.floor(Math.random()*r));return this.random=i,this.random},e.prototype.instanceFormBin=function(e,t){var r=new Uint32Array(e,t,1)[0];t+=4;var i=new Uint32Array(e,t,1)[0];t+=4;var n=new Uint32Array(e,t,1)[0];t+=4;var o=new Uint32Array(e,t,1)[0];t+=4;var a=new Uint32Array(e,t,1)[0];t+=4;var s=new Uint32Array(e,t,1)[0];t+=4;var l=new Float32Array(e,t,16);t+=64;var h=new k.Matrix4(l),u=new k.Model;u.SetPlcId(o),u.SetProtoTypeId(n),u.SetPlaceMatrix(h),u.SetOrigVisible(1===a);var p=this.view.GetSceneManager().GetExtendInfoManager(),c=p.GetInstanceAttr(r,"name");null!=c&&u.SetName(c);var d=p.GetInstanceAttr(r,"selectable");null!=d&&0<d.length&&u.SetSelectAble("true"===d.toLowerCase(),!0);var S=[];return S[0]=i,S[1]=n,S[2]=s,S[3]=u,this.instanceIdMap[r]=S,void 0===this.parentId_subInstanceId[i]&&(this.parentId_subInstanceId[i]=[]),this.parentId_subInstanceId[i].push(r),4294967295===i&&this.topInstanceId.push(r),t},e.prototype.parseBom=function(e){for(var t=0,r=e.byteLength;t<r;)t=this.instanceFormBin(e,t);for(var i in this.parentId_subInstanceId)if("4294967295"!==i)for(var n=this.instanceIdMap[i][3],o=0;o<this.parentId_subInstanceId[i].length;o++){var a=this.parentId_subInstanceId[i][o],s=this.instanceIdMap[a][3];n.AddSubModel(s)}if(1===this.topInstanceId.length)this.topModel=this.instanceIdMap[this.topInstanceId[0]][3];else{this.topModel=new k.Model;for(var l=0;l<this.topInstanceId.length;l++)this.topModel.AddSubModel(this.instanceIdMap[this.topInstanceId[l]][3])}this.topModel.SetName(this.getFileName()),this.parentId_subInstanceId=null},e.prototype.loadBomFromRemote=function(e){var n=this;this.getFileFromRemote(e,null,"arraybuffer",!1,function(e){var t=new JSZip(e),r=new RegExp(".*.bom$","i"),i=t.file(r);n.parseBom(i[0].asArrayBuffer())})},e.prototype.fillModelBox=function(){for(var e=Object.getOwnPropertyNames(this.instanceIdMap),t=0;t<e.length;t++){var r=this.instanceIdMap[e[t]][3],i=this.instanceIdMap[e[t]][1];if(4294967295!==i){this.modelMap[i];var n=this.modelBoundingBox[i],o=new k.BoundingBox(new k.Vector3(n[0],n[1],n[2]),new k.Vector3(n[3],n[4],n[5]));o.Defined()&&o.Length()<1e6&&(r.SetBox(o),r.SetDrawDataPrepared(!1))}}},e.prototype.modelFromBin=function(e,t){var r=new Uint32Array(e,t,1)[0];t+=4;var i=new Float32Array(e,t,6);this.modelBoundingBox[r]=i,t+=24;var n=new Uint32Array(e,t,1)[0];t+=4;for(var o=[],a=0;a<n;a++){var s=[],l=new Uint32Array(e,t,1)[0];t+=4,s.push(l);var h=new Uint32Array(e,t,1)[0];t+=4,s.push(h);var u=new Uint32Array(e,t,1)[0];t+=4,s.push(u),o.push(s)}return this.modelMap[r]=o,t},e.prototype.parseModel=function(e){for(var t=0;t<e.byteLength;)t=this.modelFromBin(e,t);console.log("parseModel end")},e.prototype.loadModelFromRemote=function(e){var n=this;this.getFileFromRemote(e,"","arraybuffer",!1,function(e){var t=new JSZip(e),r=new RegExp(".*.lod$","i"),i=t.file(r);n.parseModel(i[0].asArrayBuffer())})},e.prototype.meshFromBin=function(e,t,r){new Uint32Array(t,r,1)[0];r+=4;var i=new Uint32Array(t,r,1)[0];r+=4;var n=new Uint32Array(t,r,1)[0];r+=4;var o=new Uint32Array(t,r,1)[0];r+=4;var a=new Uint32Array(t,r,1)[0];r+=4;var s=new Uint32Array(t,r,1)[0];r+=4;var l=new Uint32Array(t,r,1)[0];r+=4;var h=new Float32Array(t,r,i);r+=4*i;var u=new Float32Array(t,r,n);r+=4*n;var p=new Float32Array(t,r,o);r+=4*o;for(var c=new k.VertexSet,d=[],S=[],f=[],m=0;m<s;m++){var y=new Uint32Array(t,r,1)[0];r+=4;var T=new Uint32Array(t,r,1)[0];r+=4;var M=new Uint32Array(t,r,1)[0];r+=4;var g=new Uint32Array(t,r,1)[0];r+=4;var v=new Uint32Array(t,r,M);r+=4*M;new Uint32Array(t,r,g);if(r+=4*g,4294967295!==M&&!(M<=0)){var C=new k.Face;C.SetSVLId(y);var _=new k.Mesh(c),A=d.length,E=h,G=u,P=p,w=!1;0<P.length&&(f=[],w=!0);for(var D=[],x=0;x<M;x++)d.push(E[3*v[x]+0]),d.push(E[3*v[x]+1]),d.push(E[3*v[x]+2]),D.push(E[3*v[x]+0]),D.push(E[3*v[x]+1]),D.push(E[3*v[x]+2]),S.push(G[3*v[x]+0]),S.push(G[3*v[x]+1]),S.push(G[3*v[x]+2]),w&&(f.push(P[3*v[x]+0]),f.push(P[3*v[x]+1]),f.push(0));var R=M;_.SetDataOffset(A/3),_.SetDataLength(R);var I=this.getMaterial(T.toString());C.SetMaterial(I);var L=this.getMaterialColor(T.toString());C.SetInitColor(L),C.SetMesh(_),e.AddFace(C)}}c.SetPositionArray(new Float32Array(d)),c.SetNormalArray(new Float32Array(S)),0<f.length&&c.SetUVArray(new Float32Array(f));for(var N=0;N<a;N++){var O=new Uint32Array(t,r,1)[0];r+=4;M=new Uint32Array(t,r,1)[0];r+=4;v=new Uint32Array(t,r,M);if(r+=4*M,2<=M){var b=e.GetPolyLine();null===b&&(b=new k.SPolyLine,e.SetPolyLine(b));var V=new k.RefPolyLine(b);V.SetDataOffset(b.GetPoints().length),V.SetDataLength(2*(M-1));new Float32Array(3*M),E=h;var F=new k.Vector3(E[3*v[0]+0],E[3*v[0]+1],E[3*v[0]+2]);b.AddPoint(F);for(m=1;m<M-1;m++){var B=new k.Vector3(E[3*v[m]+0],E[3*v[m]+1],E[3*v[m]+2]);b.AddPoint(B),b.AddPoint(B)}var U=new k.Vector3(E[3*v[M-1]+0],E[3*v[M-1]+1],E[3*v[M-1]+2]);b.AddPoint(U);var H=new k.Edge;H.SetSVLId(O),H.AddData(V,0),e.AddEdge(H)}}new Uint32Array(t,r,l);return r+=4*l},e.prototype.parseMesh=function(e,t,r,i,n){var o=this.instanceIdMap[t][1],a=this.instanceIdMap[t][2];if(this.hasLoadedModelMap[o]){var s=this.hasLoadedModelMap[o];e.CopyRenderData(s)}else{for(var l=0+r;l<i+r;){var h=new k.Body;e.AddBody(h),l=this.meshFromBin(h,n,l)}this.hasLoadedModelMap[o]=e}if(e.SetDrawDataPrepared(!0),4294967295!==a&&0<a){var u=this.getMaterial(a),p=u.GetMaterialType(),c=void 0;if(u instanceof k.ShaderMaterial)return;0<=(c=p===k.MaterialType.MaterialType_Pbr?u.AlbedoColor().Clone():u.GetDiffuse().Clone()).r&&0<=c.g&&0<=c.b&&(e.SetFaceMaterial(u),e.SetInitColor(c))}},e.prototype.meshFromBinMergeFace=function(e,t,r,i,n,o,a){new Uint32Array(t,r,1)[0];r+=4;var s=new Uint32Array(t,r,1)[0];r+=4;var l=new Uint32Array(t,r,1)[0];r+=4;var h=new Uint32Array(t,r,1)[0];r+=4;var u=new Uint32Array(t,r,1)[0];r+=4;var p=new Uint32Array(t,r,1)[0];r+=4;var c=new Uint32Array(t,r,1)[0];r+=4;var d=new Float32Array(t,r,s);r+=4*s;var S=new Float32Array(t,r,l);r+=4*l;var f=new Float32Array(t,r,h);r+=4*h;for(var m=0;m<p;m++){new Uint32Array(t,r,1)[0];r+=4;var y=new Uint32Array(t,r,1)[0];r+=4;var T=new Uint32Array(t,r,1)[0];r+=4;var M=new Uint32Array(t,r,1)[0];r+=4;var g=new Uint32Array(t,r,T);r+=4*T;new Uint32Array(t,r,M);if(r+=4*M,4294967295!==T&&!(T<=0)){var v=[],C=d,_=S,A=f,E=!1;0<A.length&&([],E=!0);for(var G=0;G<T;G++)i.push(C[3*g[G]+0]),i.push(C[3*g[G]+1]),i.push(C[3*g[G]+2]),n.push(_[3*g[G]+0]),n.push(_[3*g[G]+1]),n.push(_[3*g[G]+2]),E&&(o.push(A[3*g[G]+0]),o.push(A[3*g[G]+1]));4294967295!==y&&0<y&&(a[0]=y)}}for(var P=0;P<u;P++){new Uint32Array(t,r,1)[0];r+=4;T=new Uint32Array(t,r,1)[0];r+=4;g=new Uint32Array(t,r,T);r+=4*T;for(v=new Float32Array(3*T),C=d,m=0;m<T;m++)v[3*m+0]=C[3*g[m]+0],v[3*m+1]=C[3*g[m]+1],v[3*m+2]=C[3*g[m]+2]}new Uint32Array(t,r,c);return r+=4*c},e.prototype.parseMeshMergeFace=function(e,t,r,i,n){var o=this.instanceIdMap[t][1],a=this.instanceIdMap[t][2];if(this.hasLoadedModelMap[o]){var s=this.hasLoadedModelMap[o];e.CopyRenderData(s)}else{var l=0+r,h=new k.Body;e.AddBody(h);for(var u=[],p=[],c=[],d=[];l<i+r;)l=this.meshFromBinMergeFace(h,n,l,u,p,c,d);var S=new k.Face,f=new k.VertexSet,m=new k.Mesh(f),y=new Float32Array(u),T=new Float32Array(p),M=new Float32Array(0);0<c.length&&(M=new Float32Array(c),!0),f.SetPositionArray(y),f.SetNormalArray(T),0<c.length&&f.SetUVArray(M);var g=f.GetPositionArray().length/3;m.SetDataOffset(0),m.SetDataLength(g);var v=this.getMaterialColor(d[0]);S.SetInitColor(v),S.SetMesh(m),h.AddFace(S),this.hasLoadedModelMap[o]=e}if(4294967295!==a&&0<a){v=this.getMaterialColor(a);e.SetInitColor(v)}},e.prototype.meshFromBinMergeFaceByMaterial=function(e,t,r,i){new Uint32Array(t,r,1)[0];r+=4;var n=new Uint32Array(t,r,1)[0];r+=4;var o=new Uint32Array(t,r,1)[0];r+=4;var a=new Uint32Array(t,r,1)[0];r+=4;var s=new Uint32Array(t,r,1)[0];r+=4;var l=new Uint32Array(t,r,1)[0];r+=4;var h=new Uint32Array(t,r,1)[0];r+=4;var u=new Float32Array(t,r,n);r+=4*n;var p=new Float32Array(t,r,o);r+=4*o;var c=new Float32Array(t,r,a);r+=4*a;for(var d=0;d<l;d++){new Uint32Array(t,r,1)[0];r+=4;var S=new Uint32Array(t,r,1)[0];r+=4;var f=new Uint32Array(t,r,1)[0];r+=4;var m=new Uint32Array(t,r,1)[0];r+=4;var y=new Uint32Array(t,r,f);r+=4*f;new Uint32Array(t,r,m);if(r+=4*m,4294967295!==f&&!(f<=0)){var T=null,M=null,g=null,v=i[S];v?(T=v[0],M=v[1],g=v[2]):(T=[],M=[],0<c.length&&(g=[]),i[S]=[T,M,g]);var C=u,_=p,A=c;0<A.length&&(g=new Float32Array(3*f));for(var E=0;E<f;E++)T.push(C[3*y[E]+0]),T.push(C[3*y[E]+1]),T.push(C[3*y[E]+2]),M.push(_[3*y[E]+0]),M.push(_[3*y[E]+1]),M.push(_[3*y[E]+2]),0<A.length&&(g[3*E+0]=A[3*y[E]+0],g[3*E+1]=A[3*y[E]+1]);0<f&&(i[S]=[T,M,g])}}for(var G=0;G<s;G++){new Uint32Array(t,r,1)[0];r+=4;f=new Uint32Array(t,r,1)[0];r+=4;y=new Uint32Array(t,r,f);if(r+=4*f,2<=f&&!k.Parameters.Instance().isIgnoreEdge){var P=e.GetPolyLine();null===P&&(P=new k.SPolyLine,e.SetPolyLine(P));var w=new k.RefPolyLine(P);w.SetDataOffset(P.GetPoints().length),w.SetDataLength(2*(f-1));T=new Float32Array(3*f),C=u;var D=new k.Vector3(C[3*y[0]+0],C[3*y[0]+1],C[3*y[0]+2]);P.AddPoint(D);for(d=1;d<f-1;d++){var x=new k.Vector3(C[3*y[d]+0],C[3*y[d]+1],C[3*y[d]+2]);P.AddPoint(x),P.AddPoint(x)}var R=new k.Vector3(C[3*y[f-1]+0],C[3*y[f-1]+1],C[3*y[f-1]+2]);P.AddPoint(R);var I=new k.Edge;I.AddData(w,0),e.AddEdge(I)}}new Uint32Array(t,r,h);return c=p=u=null,r+=4*h},e.prototype.parseMeshMergeFaceByMaterial=function(e,t,r,i,n){var o=this.instanceIdMap[t][1],a=this.instanceIdMap[t][2];if(this.hasLoadedModelMap[o]){var s=this.hasLoadedModelMap[o];e.CopyRenderData(s)}else{var l=0+r,h=new k.Body;e.AddBody(h);for(var u={};l<i+r;)l=this.meshFromBinMergeFaceByMaterial(h,n,l,u);for(var p=Object.getOwnPropertyNames(u),c=0;c<p.length;c++){var d=p[c],S=new k.Face,f=new k.VertexSet,m=new k.Mesh(f),y=u[d][0],T=u[d][1],M=u[d][2],g=new Float32Array(y),v=new Float32Array(T),C=new Float32Array(0);M&&0<M.length&&(C=new Float32Array(M),!0),f.SetPositionArray(g),f.SetNormalArray(v);var _=!1;M&&0<M.length&&(f.SetUVArray(C),_=!0);var A=f.GetPositionArray().length/3;if(m.SetDataOffset(0),m.SetDataLength(A),k.Parameters.Instance().genetateTexCood&&!_){var E=m.GetBoundingBox();f.computeVertexNormals();var G=f.GetNormalArray(),P=new Float32Array(k.MeshHelper.GetUVArrayByPositionArray(f.GetPositionArray(),E,G));f.SetUVArray(P)}var w=this.getMaterial(d);S.SetMaterial(w);var D=this.getMaterialColor(d);S.SetInitColor(D),S.SetMesh(m),h.AddFace(S),this.hasLoadedModelMap[o]=e}}if(e.SetDrawDataPrepared(!0),4294967295!==a&&0<a){var x=(w=this.getMaterial(a)).GetMaterialType();D=void 0;if(w instanceof k.ShaderMaterial)return;0<=(D=x===k.MaterialType.MaterialType_Pbr?w.AlbedoColor().Clone():w.GetDiffuse().Clone()).r&&0<=D.g&&0<=D.b&&(e.SetFaceMaterial(w),e.SetInitColor(D))}},e.prototype.fillM3DModelBuffer=function(e,t,r){for(var i=0;i<e.length;i++){var n=this.instanceIdMap[e[i]][3],o=this.instanceIdMap[e[i]][1];if(4294967295!==o){var a=this.modelMap[o],s=this.modelBoundingBox[o],l=new k.BoundingBox(new k.Vector3(s[0],s[1],s[2]),new k.Vector3(s[3],s[4],s[5]));if(l.Defined()&&l.Length()<1e6&&n.SetBox(l),0<a.length){var h=a[0][2],u=a[0][1];this.parseMeshMergeFaceByMaterial(n,e[i],u,h,t)}}}},e.prototype.asynFillM3DModelBuffer=function(e,t,r){this.asynFillModelFlag=!0;var i=e.length,n=Math.floor(i/100);e.length<1e3?n=Math.floor(i/50):e.length<5e3&&(n=Math.floor(i/100)),n<1&&(n=1),function e(t,r,i,n,o){if(t.asynFillModelFlag){for(var a=n,s=o,l=r,h=0;h<i;h++){l=r+h;var u=t.instanceIdMap[a[l]];if(u){var p=u[3],c=u[1];if(4294967295!==c){var d=t.modelMap[c];if(0<d.length){var S=d[0][2],f=d[0][1];k.Parameters.Instance().isMergeFace?t.parseMeshMergeFaceByMaterial(p,a[l],f,S,s):t.parseMesh(p,a[l],f,S,s)}}}}if((l=r+i)<a.length)k.Parameters.Instance().isProgressiveDisplay?setTimeout(e,1e-4,t,l,i,a,s):e(t,l,i,a,s);else{var m=t.view.GetSceneManager().GetModelFillManager();t.createM3dMaterial(t.zipFile);var y=new RegExp(".*.light$","i"),T=t.zipFile.file(y);0<T.length&&t.parseLight(T[0].asText());var M=new RegExp(".*.section$","i"),g=t.zipFile.file(M);0<g.length&&t.parseSectionPlane(g[0].asText());var v=new RegExp(".*.measure$","i"),C=t.zipFile.file(v);0<C.length&&t.parseMeasure(C[0].asText());var _=new RegExp(".*.annotation$","i"),A=t.zipFile.file(_);0<A.length&&t.parseAnnotation(A[0].asText()),m.AsynFillModelEnd(this,m)}}}(this,0,n,e,t)},e.prototype.fillM3DModelBuffer1=function(e,t,r){if(r){var i=e.getModelFileInfo().getPartId(),n=e.getModelFileInfo().getInstanceId();if(-1!==i){var o=this.modelMap[i];if(0<o.length){var a=o[0][2],s=o[0][1];this.parseMeshMergeFaceByMaterial(e,n,s,a,t)}}}for(var l=0;l<e.GetSubModels().length;l++){var h=e.GetSubModels()[l];this.fillM3DModelBuffer1(h,t,r)}},e.prototype.OpenZipModel=function(l,e){function h(e){var t=l.file(/\.bom$/i);e.parseBom(t[0].asArrayBuffer()),setTimeout(r,e.delay,e),e.SetReadPercent(.15)}function r(e){var t=new RegExp(".*.material$","i"),r=l.file(t);e.parseMaterial(r[0].asText()),setTimeout(i,e.delay,e),e.SetReadPercent(.25)}function i(e){var t=new RegExp(".*.lod$","i"),r=l.file(t);e.parseModel(r[0].asArrayBuffer()),e.fillModelBox(),setTimeout(n,e.delay,e),e.SetReadPercent(.5)}function n(e){var t=new RegExp(".*.mesh$","i"),r=(l.file(t),new RegExp(".*.geo$","i")),i=l.file(r);0<i.length&&e.parseGeo(i[0].asText()),setTimeout(o,e.delay,e),e.SetReadPercent(.9)}function o(e){e.createM3dMaterial(l),setTimeout(t,e.delay,e),e.SetReadPercent(.95)}function t(e){if(e.option.readPMI){var t=new RegExp(".*.pmi$","i"),r=l.file(t);e.parsePMI(r[0].asText())}e.EndRead()}this.zipFile=l,function(e){e.BeginRead();var t=l.file(/\.info$/i);if(t&&0<t.length){var r=t[0].asText();e.parseInfo(r)}var i=l.file(/\.scene/i);if(i&&0<i.length){var n=i[0].asText();e.parseScene(n)}var o=l.file(/\.animation$/i);o&&0<o.length&&(e.animationsrc=o[0].asText());var a=new RegExp(".*.model$","i"),s=l.file(a);e.parseInstanceAttribute(s[0].asText()),e.SetReadPercent(.02),setTimeout(h,e.delay,e)}(this)},e.prototype.requestData=function(e,t,r,i){var n=new XMLHttpRequest;n.open(t,e,!1),n.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),n.onreadystatechange=function(){if(4===n.readyState&&200===n.status){var e=JSON.parse(JSON.parse(JSON.stringify(n.response)));i&&i(e)}else alert("密钥文件请求错误")};try{"POST"===t?n.send("data="+this.random):n.send(null)}catch(e){console.log(e.code+"\n"+e.message)}},e.prototype.OpenUrl=function(e,t,r){this.random="",this.GetRandomString(),this.serverOptions=r,this.FillModelOnceTime(e,t)},e.prototype.FillModelOnceTime=function(e,t){var a=this,s=this;this.getFileFromRemote(e,null,"arraybuffer",!1,function(e){var d=new JSZip(e,{retrievePasswordCallback:function(){return s.GetDString(s.xd)},invalidPasswordCallback:function(e,t){return!0}}),c=(a.zipFile=d).file(/\.info$/i);function t(e){if(e.BeginRead(),c&&0<c.length){var t=c[0];e.setFileName(t.name.slice(0,t.name.lastIndexOf(".info")));var r=c[0].asText();e.parseInfo(r)}var i=d.file(/\.animation$/i);if(i&&0<i.length)for(var n=0;n<i.length;n++){var o,a;if(0===i[n].name.indexOf("ChildrenAnimation/"))1==(a=(o=i[n].asText().split("</SimulationAnimation>"))[o.length-1]).length?e.childAnimationSrc["'"+i[n].name+"'"]=i[n].asText().replace(a,""):e.childAnimationSrc[i[n].name]=i[n].asText();else 1==(a=(o=i[n].asText().split("</SimulationAnimation>"))[o.length-1]).length?e.animationsrc=i[n].asText().replace(a,""):e.animationsrc=i[n].asText()}var s=d.file(/\.scene/i);if(s&&0<s.length){var l=s[0].asText();e.parseScene(l)}var h=d.file(/\_sares\/.*$/i);e.parseAniImage(h,d);var u=new RegExp(".*.model$","i"),p=d.file(u)[0].asText();e.parseInstanceAttribute(p),e.parseModels(p),e.SetReadPercent(.02),setTimeout(S,e.delay,e)}function S(e){var t=d.file(/\.bom$/i);e.parseBom(t[0].asArrayBuffer()),setTimeout(r,e.delay,e),e.SetReadPercent(.15)}function r(e){var t=new RegExp(".*.material$","i"),r=d.file(t);0<r.length&&e.parseMaterial(r[0].asText()),setTimeout(i,e.delay,e),e.SetReadPercent(.25)}function i(e){var t=new RegExp(".*.lod$","i"),r=d.file(t);e.parseModel(r[0].asArrayBuffer()),e.fillModelBox(),setTimeout(n,e.delay,e),e.SetReadPercent(.5)}function n(e){var t=new RegExp(".*.geo$","i"),r=d.file(t);0<r.length&&e.parseGeo(r[0].asText());var i=new RegExp(".*.geometry$","i"),n=d.file(i);0<n.length&&e.parseGeometry(n[0].asText());var o=new RegExp(".*.story$","i"),a=d.file(o);0<a.length&&e.parseStory(a[0].asText());var s=new RegExp(".*.link$","i"),l=d.file(s);0<l.length&&e.parseRelated(l[0].asText());var h=new RegExp(".*.shotspot$","i"),u=d.file(h);0<u.length&&(k.Parameters.Instance().IsShowSHotSpot&&(e.parseSHotSpot(u[0].asText()),e.view.GetSceneManager().SetSceneType(k.SceneManagerType.MAINTENANCE)));var p=new RegExp(".*.image$","i"),c=d.file(p);0<c.length&&e.initImages(c[0].asText()),setTimeout(f,e.delay,e),e.SetReadPercent(.9)}function f(e){var t=new RegExp(".*.view$","i"),r=d.file(t);0<r.length&&e.parseNewModelView(r[0].asText()),setTimeout(o,e.delay,e),e.SetReadPercent(.95)}function o(e){if(e.option.readPMI){var t=new RegExp(".*.pmi$","i"),r=d.file(t);if(0<r.length)try{e.parsePMI(r[0].asText())}catch(e){}else console.log("no pmi file exist.")}e.EndRead()}c[0]._data.encrypted&&s.serverOptions?a.requestData(s.serverOptions,"POST",a.random,function(e){s.xd=e.key,t(s)}):c[0]._data.encrypted&&!s.serverOptions?alert("该文件为加密文件，请配置密钥信息"):c[0]._data.encrypted||t(s)},t)},e.prototype.AsynFillModelMesh=function(){var e=this.zipFile,t=new RegExp(".*.mesh$","i"),r=e.file(t),i=Object.getOwnPropertyNames(this.instanceIdMap);this.asynFillM3DModelBuffer(i,r[0].asArrayBuffer(),!0)},e.prototype.CancelAsynFillModel=function(){this.asynFillModelFlag=!1},e.prototype.parseGeo=function(e){for(var t=JSON.parse(e).geometries.models,r=0;r<t.length;r++){var i=t[r],n=i.meshFaces,o=i.meshEdges;for(var a in n){var s=n[a],l=this.allMeshFaceMap[i.id];l||(l={}),l[a]=s,this.allMeshFaceMap[i.id]=l}for(var h in o){s=o[h];var u=this.allMeshEdgeMap[i.id];u||(u={}),u[h]=s,this.allMeshEdgeMap[i.id]=u}}if(0<Object.keys(this.view.GetSceneManager().GetExtendInfoManager().allMeshFaceAttr).length)for(var p in this.allMeshFaceMap){var c=this.allMeshFaceMap[p];this.view.GetSceneManager().GetExtendInfoManager().allMeshFaceAttr[p]=c}else this.view.GetSceneManager().GetExtendInfoManager().SetAllMeshFaceAttr(this.allMeshFaceMap);if(0<Object.keys(this.view.GetSceneManager().GetExtendInfoManager().allMeshEdgeAttr).length)for(var p in this.allMeshEdgeMap){c=this.allMeshEdgeMap[p];this.view.GetSceneManager().GetExtendInfoManager().allMeshEdgeAttr[p]=c}else this.view.GetSceneManager().GetExtendInfoManager().SetAllMeshEdgeAttr(this.allMeshEdgeMap)},e.prototype.parseModels=function(e){for(var t=JSON.parse(e).models,r=0;r<t.length;r++){var i=t[r],n=void 0,o={};for(var a in i)if("id"!==a){var s=i[a];o[a]=s}else n=i[a];this.parseModelsMap[n]=o}this.view.GetSceneManager().GetExtendInfoManager().SetAllModelFileAttr(this.parseModelsMap)},e.prototype.parseModelView=function(e){var t=JSON.parse(JSON.parse(JSON.stringify(e)));if(t){var r=t.views;if(r){for(var i=0;i<r.length;i++){var n=r[i],o=this.parseOneModelView(n),a=t.view_sections;if(a)for(var s=0;s<a.length;s++)if(a[s].id===o.GetID()){var l=a[s].sections;o.SetSectionPlaneIDList(l)}var h=t.view_notes;if(h)for(s=0;s<h.length;s++)if(h[s].id===o.GetID()){var u=h[s].notes;o.SetNoteIds(u)}this.topModel.AddModelView(o)}var p=t.view_pmis;if(p&&0<p.length)for(i=0;i<p.length;i++){var c=p[i],d=c.id,S=c.pmis;if(d){var f=this.topModel.GetModleView(d);if(S&&0<S.length)for(var m=0;m<S.length;m++)S[m]&&f.AddPMIId(S[m])}}}}},e.prototype.parseOneModelView=function(e){var t=SView.ViewManager.GetInstance(),r=new k.ModleView;r.SetID(e.id),r.SetName(e.name),r.SetViewType(e.usageType);var i=e.camera;if(i){var n=new k.Camera;if(n.SetOrthographic("1"==i.projectType),i.angle){var o=i.angle;n.SetFov(o)}if(i.matix){var a=new k.Matrix4;a.fromString(i.matix);var s=new k.Quaternion,l=new k.Matrix3(a.data[0],a.data[4],a.data[8],a.data[1],a.data[5],a.data[9],a.data[2],a.data[6],a.data[10]);s.FromRotationMatrix(l),n.SetPosition(new k.Vector3(a.data[12],a.data[13],a.data[14])),n.SetRotation(s)}var h=1;i.aspectRatio&&(h=i.aspectRatio),n.SetAspectRatio(h),i.nearDistance&&n.SetNearClip(i.nearDistance),i.farDistance&&n.SetFarClip(i.farDistance),i.focalDistance,i.height&&n.IsOrthographic()&&n.SetOrthoSize(new k.Vector2(i.height*h,i.height)),n.SetZoom(1),r.SetCamera(n),r.SetUpDataCamera(!0)}var u=e.insAttributes;for(var p in u){var c=u[p],d=c.matix,S=new k.InstanceAttribute;S.id=c.plcPath;var f=c.visible;if(S.visible=0===f,S.path=k.PathHelper.SVLPathDecToHex(p),d){var m=void 0,y=d.split(" ");16==y.length?m=new k.Matrix4:12==y.length&&(m=new k.Matrix3x4),m.fromString(d),m.Equals(k.Matrix4.ZERO().Clone()),S.placeMatrix=m}var T=c.color;if(T){var M=T.split(" ");S.hasColor=!0;var g=new k.Color(Number(M[0]),Number(M[1]),Number(M[2]),Number(M[3]));S.insColor=g.Clone()}r.GetInstanceAttributeMap().Put(Number(c.plcPath),S)}return t.AddModleView(r),e.isActivated&&"true"===e.isActivated&&this.view.SetCurrentModelView(r),r},e.prototype.parseNewModelView=function(e){var t=JSON.parse(JSON.parse(JSON.stringify(e)));if(t){if(t.version)t.version;var r=new Array;if(t.model_views){var i=t.model_views;0<i.length&&(r=i[0].views)}var n=t.views;if(n)for(var o=0;o<n.length;o++){var a=n[o];if(!(r.indexOf(a.id)<0)){var s=this.parseOneModelView(a);if(t.view_pmis)for(var l=t.view_pmis,h=0;h<l.length;h++){if(l[h].id)if(l[h].id===s.GetID())for(var u=0;u<l[h].pmis.length;u++)s.AddPMIId(l[h].pmis[u])}if(t.view_notes){var p=t.view_notes;for(h=0;h<p.length;h++){if(p[h].id)if(p[h].id===s.GetID())for(u=0;u<p[h].notes.length;u++)s.AddNoteId(p[h].notes[u])}}if(t.view_sections){var c=t.view_sections;for(h=0;h<c.length;h++){if(c[h].id)if(c[h].id===s.GetID())for(u=0;u<c[h].sections.length;u++)s.AddSectionPlaneId(c[h].sections[u])}}this.topModel.AddModelView(s)}}}},e.prototype.parseSectionPlane=function(e){var t=JSON.parse(JSON.parse(JSON.stringify(e)));if(t){var r=t.sectionPlanes;if(r)for(var i=0;i<r.length;i++){var n=new k.SectionPlane,o=r[i];if(o){o.createID&&n.SetID(o.createID),o.name&&n.SetName(o.name),o.ShowClipPlane&&n.SetShowCutPlane(o.ShowClipPlane),o.ShowCappingPlane&&n.SetShowCappingPlane(o.ShowCappingPlane),n.SetEnable(o.visible);var a=void 0;o.normalPos&&(a=new k.Vector3(o.normalPos[0],o.normalPos[1],o.normalPos[2]));var s=void 0;if(o.selectPos&&(s=new k.Vector3(o.selectPos[0],o.selectPos[1],o.selectPos[2])),!a||!s)return;var l=-a.DotProduct(s);n.SetPlaneParam(a.x,a.y,a.z,l),this.topModel.AddSectionPlane(n)}}}},e.GetGeometryAttributeFromStk=function(e){var t=null;switch(Number(e.type)){case k.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_UNKNOWN:break;case k.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_PLANEFACE:t=this.GetPlanfaceGeoFromStk(e);break;case k.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_REVOLUTIONFACE:t=this.GetRevolutionfaceGeoFromStk(e);break;case k.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_CYLINDERFACE:t=this.GetCylinderfaceGeoFromStk(e);break;case k.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_CONICALFACE:t=this.GetConicalfaceGeoFromStk(e);break;case k.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_SPHEREFACE:t=this.GetSpherefaceGeoFromStk(e);break;case k.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_TOROIDALFACE:t=this.GetToroidaifaceFromStk(e);break;case k.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_LINE:t=this.GetLineGeoFromStk(e);break;case k.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_ELLIPSE:t=this.GetEllipseGeoFromStk(e)}return t},e.GetPlanfaceGeoFromStk=function(e){if(Number(e.type)!=k.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_PLANEFACE)return null;var t=new k.PlaneFaceAttribute,r=e.normal.split(" ");t.SetNormal(new k.Vector3(Number(r[0]),Number(r[1]),Number(r[2])));var i=e.origin.split(" ");return t.SetOrigin(new k.Vector3(Number(i[0]),Number(i[1]),Number(i[2]))),t},e.GetRevolutionfaceGeoFromStk=function(e){if(Number(e.type)!=k.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_REVOLUTIONFACE)return null;var t=new k.RevolutionFaceAttribute,r=e.radius;t.SetRadius(Number(r));var i=e.axisDirection.split(" ");t.SetRevoAxis(new k.Vector3(Number(i[0]),Number(i[1]),Number(i[2])));var n=e.axisOrigin.split(" ");return t.SetAxisOrigin(new k.Vector3(Number(n[0]),Number(n[1]),Number(n[2]))),t},e.GetCylinderfaceGeoFromStk=function(e){return Number(e.type)!=k.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_CYLINDERFACE?null:new k.CylinderFaceAttribute},e.GetConicalfaceGeoFromStk=function(e){return Number(e.type)!=k.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_CONICALFACE?null:new k.ConicalFaceAttribute},e.GetSpherefaceGeoFromStk=function(e){return Number(e.type)!=k.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_SPHEREFACE?null:new k.SphereFaceAttribute},e.GetToroidaifaceFromStk=function(e){return Number(e.type)!=k.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_TOROIDALFACE?null:new k.ToroidalFaceAttribute},e.GetLineGeoFromStk=function(e){if(Number(e.type)!=k.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_LINE)return null;var t=new k.LineAttribute,r=e.startPoint.split(" "),i=e.endPoint.split(" ");return t.SetCenterPoint(new k.Vector3((i[0]+r[0])/2,(i[1]+r[1])/2,(i[2]+r[2])/2)),t.SetDirection(new k.Vector3(i[0]-r[0],i[1]-r[1],i[2]-r[2])),t.SetStartPoint(new k.Vector3(r[0],r[1],r[2])),t.SetEndPoint(new k.Vector3(i[0],i[1],i[2])),t},e.GetEllipseGeoFromStk=function(e){if(Number(e.type)!=k.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_ELLIPSE)return null;var t=new k.EllipseAttribute,r=e.centerPoint.split(" "),i=Number(e.majorRadius),n=String(e.minorRadius);n=n.substring(0,n.length/2);var o=Number(n),a=e.startPoint.split(" "),s=e.endPoint.split(" "),l=e.xDirection.split(" "),h=e.yDirection.split(" "),u=e.zDirection.split(" ");return t.SetCenterPoint(new k.Vector3(r[0],r[1],r[2])),t.SetMajorRadius(i),t.SetMinorRadius(o),t.SetStartPoint(new k.Vector3(a[0],a[1],a[2])),t.SetEndPoint(new k.Vector3(s[0],s[1],s[2])),t.SetXYZDir(new k.Vector3(l[0],l[1],l[2]),new k.Vector3(h[0],h[1],h[2]),new k.Vector3(u[0],u[1],u[2])),t},e.prototype.parseMaterial=function(e){var t=JSON.parse(e);if(t){var r="";t.GlobalEffect&&(r=t.GlobalEffect),this.view.GetSceneManager().GetRenderManager().SetGlobalEffect(r),""!==r&&this.view.GetSceneManager().SetSceneType(k.SceneManagerType.RING);var i=t.materials;if(i){for(var n=0;n<i.length;n++){var o=i[n];this.materialMap[o.id+""]=o}var a=t.images;if(a)for(n=0;n<a.length;n++){var s=a[n];this.imagesMap[s.id+""]=s}}else console.error("Material file is empty!")}else console.error("Material file is empty!")},e.prototype.getMaterialColor=function(e){var t=k.Color.GRAY().Clone(),r=this.materialMap[e];if(r){var i=r.diffuseColor,n=r.transparency;if(void 0===i||void 0===n)return t;n=n<0?1:n,t=new k.Color(i[0],i[1],i[2],n)}return t},e.prototype.GetTexture2D=function(){},e.prototype.getMaterial=function(e){var t,r;if(4294967295===e)return t;if(void 0!==this.m_protoTypeMaterialCache[e]&&null!==this.m_protoTypeMaterialCache[e])return t=this.m_protoTypeMaterialCache[e];void 0!==this.m_protoTypeColorCache[e]&&null!==this.m_protoTypeColorCache[e]&&(r=this.m_protoTypeColorCache[e].Clone());var i=this.materialMap[e];if(i){i.diffuseColor,i.transparency;var n=i.diffuseTexture,o=i.reflectiveTexture,a=i.type;if(1===a||0===a){var s=t=this.view.GetSceneManager().GetResourceManager().GetOrCreateMaterial(e,1);(n||o)&&(this.m3dMaterialMap[e]=s),s.SetDisplayName(i.name),r=i.diffuseColor;var l=i.ambientColor,h=i.specularColor,u=i.emissiveColor;if(r&&(r=new k.Color(i.diffuseColor[0],i.diffuseColor[1],i.diffuseColor[2],i.diffuseColor[3]?i.diffuseColor[3]:i.transparency)).a<0&&(r.a=1),l&&(l=new k.Color(i.ambientColor[0],i.ambientColor[1],i.ambientColor[2],i.ambientColor[3]?i.ambientColor[3]:1)),h&&(h=new k.Color(i.specularColor[0],i.specularColor[1],i.specularColor[2],i.specularColor[3]?i.specularColor[3]:1)),u&&(u=new k.Color(i.emissiveColor[0],i.emissiveColor[1],i.emissiveColor[2],i.emissiveColor[3]?i.emissiveColor[3]:1)),r&&0<=r.r&&0<=r.g&&0<=r.b&&(s.SetDiffuse(r),s.Opacity(r.a)),l&&0<=l.r&&0<=l.g&&0<=l.b&&s.SetAmbient(l),h)if(0<=h.r&&0<=h.g&&0<=h.b)s.SetSpecular(h);else{var p=this.view.GetSceneManager().GetResourceManager().GetOrCreateMaterial(k.M3D_GLOBLE_MATERIAL,k.MaterialType.MaterialType_Phong).GetiSpecular()/255;s.SetSpecular(new k.Color(r.r*p,r.g*p,r.b*p))}if(u&&0<=u.r&&0<=u.g&&0<=u.b&&s.SetEmissive(u),i.shininess){var c=i.shininess;0<c?s.SetShininess(c):s.SetShininess(90)}else s.SetShininess(90);var d=!1,S=i.uvScale,f=i.uvRotate,m=i.uvTranslate;i.diffuseTexture&&(d=!0),i.matcapMap&&(d=!0),(v=i.normalMapScale)&&0<=v[0]&&0<=v[1]&&s.NormalMapScale(new k.Vector2(v[0],v[1])),d&&(m&&s.SetUvTranslate(new k.Vector2(m[0],m[1])),S&&s.SetUvScale(new k.Vector2(S[0],S[1])),null!=f&&s.SetUvRotate(f)),this.m_protoTypeMaterialCache[e]=s,this.m_protoTypeColorCache[e]=r.Clone()}else if(4===a){var y;s=t=this.view.GetSceneManager().GetResourceManager().GetOrCreateMaterial(e,a);(n||o||i.matcapMap)&&(this.m3dMaterialMap[e]=s),s.SetDisplayName(i.name),i.diffuseColor&&(y=new k.Color(i.diffuseColor[0],i.diffuseColor[1],i.diffuseColor[2],i.diffuseColor[3]?i.diffuseColor[3]:i.transparency)).a<0&&(y.a=1),y&&0<=y.r&&0<=y.g&&0<=y.b&&(s.SetDiffuse(y),s.Opacity(y.a));S=i.uvScale;this.m_protoTypeMaterialCache[e]=s,this.m_protoTypeColorCache[e]=y}else if(2===a){var T;(s=t=this.view.GetSceneManager().GetResourceManager().GetOrCreateMaterial(e,a)).SetDisplayName(i.name),(n||o)&&(this.m3dMaterialMap[e]=s),i.diffuseColor&&(T=new k.Color(i.diffuseColor[0],i.diffuseColor[1],i.diffuseColor[2],i.diffuseColor[3]?i.diffuseColor[3]:i.transparency)).a<0&&(T.a=1),T&&0<=T.r&&0<=T.g&&0<=T.b&&(s.SetAlbedoColor(T),s.SetOpacity(T.a));var M=i.metalnessFactor;M?0<=M&&s.SetMetalnessFactor(M):s.SetMetalnessFactor(0),(M=i.roughnessFactor)?0<=M&&s.SetRougthnessFactor(M):s.SetRougthnessFactor(0);var g=i.useClearCoat;s.SetUseClearCoat(g),0<=(M=i.clearCoat)?s.SetClearCoat(M):s.SetClearCoat(0),0<=(M=i.clearCoatRoughness)?s.SetClearCoatRoughness(M):s.SetClearCoatRoughness(0);var v;d=!1;i.diffuseTexture&&(d=!0),(v=i.normalMapScale)&&0<v[0]&&0<v[1]&&s.SetNormalMapScale(new k.Vector2(v[0],v[1]));S=i.uvScale,f=i.uvRotate,m=i.uvTranslate;d&&(m&&s.SetUvTranslate(new k.Vector2(m[0],m[1])),S&&s.SetUvScale(new k.Vector2(S[0],S[1])),f&&s.SetUvRotate(f)),this.m_protoTypeMaterialCache[e]=s,this.m_protoTypeColorCache[e]=T.Clone()}else{var C=i.parameters;if(!(t=this.view.GetSceneManager().GetResourceManager().GetOrCreateMaterial(e,k.MaterialType.MaterialType_Shader)).GetNeedsUpdateUniformParamerers())return t;t.SetUniformParameter("type",new k.Uniform("Int",[a])),this.ParseMaterialParameters(C,t),t.SetMaterialType(a)}t.SetSvlId(i.id)}else t=this.view.GetSceneManager().GetResourceManager().GetOrCreateMaterial(k.DEFAULT_MATERIAL,k.MaterialType.MaterialType_Phong);return t},e.prototype.fillTextureImageResouce=function(e,t,r,i){new Array;var n=e.GetOrCreateTexture(t),o=t.lastIndexOf("."),a=t.lastIndexOf("\\")+1,s=t.substring(a,o),l=new RegExp(s,"i"),h=r.file(l);if(h[0]){var u=h[0].asArrayBuffer(),p=new Blob([u],{type:"application/octet-binary"}),c=URL.createObjectURL(p),d=e.GetImage(t);null===d&&(d=e.GetOrCreateImageById(t,i,c)),n.AddImage(d)}else n=null;return n},e.prototype.createM3dMaterial=function(e){var t=this.view.GetSceneManager().GetResourceManager();for(var r in this.m3dMaterialMap){var i=this.m3dMaterialMap[r];if(this.materialMap[r].diffuseTexture){var n=this.imagesMap[this.materialMap[r].diffuseTexture.ref].uri,o=this.fillTextureImageResouce(t,n,e,this.materialMap[r].diffuseTexture.ref[0]);i.GetMaterialType()===k.MaterialType.MaterialType_Pbr?i.SetAlbedoMap(o):i.SetDiffuseMap(o)}if(this.materialMap[r].metalnessRoughnessMap){n=this.imagesMap[this.materialMap[r].metalnessRoughnessMap.ref].uri,o=this.fillTextureImageResouce(t,n,e,this.materialMap[r].diffuseTexture.ref[0]);i.SetMetalnessRoughnessMap(o)}if(this.materialMap[r].matcapMap){n=this.imagesMap[this.materialMap[r].matcapMap.ref].uri,o=this.fillTextureImageResouce(t,n,e,this.materialMap[r].matcapMap.ref[0]);i.SetMatcapMap(o)}if(this.materialMap[r].normalMap){n=this.imagesMap[this.materialMap[r].normalMap.ref].uri,o=this.fillTextureImageResouce(t,n,e,this.materialMap[r].normalMap.ref[0]);i.SetNormalMap(o)}}this.view.GetSceneManager().GetResourceManager().MaterialToJSON()},e.prototype.parseGeometry=function(e){var t=JSON.parse(JSON.parse(JSON.stringify(e)));if(t.version){var r=t.geometry;if(r)for(var i=0,n=r;i<n.length;i++){var o=n[i];this.parseGeometryItem(o)}}},e.prototype.parseGeometryItem=function(e){var t=this.GetView().GetSceneManager().getGeometryManager(this.GetView()),r=Number(e.type),i=String(e.name),n=Number(e.id),o=Number(e.parentId);if(r==Number(k.ShapeType.SHAPE_POINT)){var a=e.color;(m=new k.Color).r=a[0],m.g=a[1],m.b=a[2],m.a=a[3];var s=e.position,l=new k.Vector3;l.x=s[0],l.y=s[1],l.z=s[2];var h=new k.SPoint;h.SetName(i),h.SetID(n),h.SetParentID(o),h.SetPoint(l),h.SetColor(m),h.SetSize(Number(e.size)),h.SetStyle(Number(e.style)),t.AddGeoDataTreeRoot(h)}else if(r==Number(k.ShapeType.CURVE_LINE)){a=e.color;(m=new k.Color).r=a[0],m.g=a[1],m.b=a[2],m.a=a[3];var u=e.startPos,p=new k.Vector3;p.x=u[0],p.y=u[1],p.z=u[2];var c=e.endPos,d=new k.Vector3;d.x=c[0],d.y=c[1],d.z=c[2];var S=new k.SLine;S.SetName(i),S.SetID(n),S.SetParentID(o),S.SetStartPoint(p),S.SetEndPoint(d),S.SetColor(m),S.SetWidth(Number(e.size)),S.SetStyle(Number(e.style)),S.SetShowPoint(!1),t.AddGeoDataTreeRoot(S)}else if(r==Number(k.ShapeType.CURVE_POLYLINE)||r==Number(k.ShapeType.CURVE_NURBSCURVE)){var f=new k.SCurve(Number(k.ShapeType.CURVE_POLYLINE));f.SetSelectAble(!0);var m;a=e.color;(m=new k.Color).r=a[0],m.g=a[1],m.b=a[2],m.a=a[3];var y=void 0;y=r==Number(k.ShapeType.CURVE_POLYLINE)?e.points:e.pathPoints,f.SetName(i),f.SetID(n),f.SetParentID(o),f.SetColor(m),f.SetSetSelectable(!0),f.SetWidth(Number(e.size));for(var T=0,M=y;T<M.length;T++){var g=M[T],v=new k.Vector3;v.x=g[0],v.y=g[1],v.z=g[2],f.AddPoint(v)}f.SetShowPoint(!1),t.AddGeoDataTreeRoot(f)}else if(r==Number(k.ShapeType.SHAPE_SCANNINGBODY));else if(r==Number(k.ShapeType.VIRTUAL_GROUP)){var C=new k.SGeoGroup;C.SetName(i),C.SetID(n),C.SetParentID(o),t.AddGeoDataTreeRoot(C);for(var _=e.children,A=0;A<_.length;A++){g=_[A];this.parseGeometryItem(g)}}},e.prototype.parseMeasure=function(e){var t=JSON.parse(JSON.parse(JSON.stringify(e))).measures;if(t)for(var r=0,i=t;r<i.length;r++){var n=i[r];this.parseMeasureItem(n)}},e.prototype.parseMeasureItem=function(e){var t,r=null,i=SView.SMeasure.MEASURE_TYPE_BASE;if(null!=e.type?i=e.type:null!=e.Type&&(i=e.Type),i==SView.SMeasure.MEASURE_TYPE_PNT_PNT_DISTANCE||i==SView.SMeasure.MEASURE_TYPE_PNT_LINE_DISTANCE||i==SView.SMeasure.MEASURE_TYPE_PNT_FACE_DISTANCE||i==SView.SMeasure.MEASURE_TYPE_LINE_LINE_DISTANCE||i==SView.SMeasure.MEASURE_TYPE_LINE_FACE_DISTANCE||i==SView.SMeasure.MEASURE_TYPE_FACE_FACE_DISTANCE||i==SView.SMeasure.MEASURE_TYPE_SHAFT_SHAFT_DISTANCE||i==SView.SMeasure.MEASURE_TYPE_CENTER_CENTER_DISTANCE||i==SView.SMeasure.MEASURE_TYPE_LENGTH||i==SView.SMeasure.MEASURE_TYPE_ARC?r=new SView.SMeasureDistance:i==SView.SMeasure.MEASURE_TYPE_LINE_LINE_ANGLE||i==SView.SMeasure.MEASURE_TYPE_FACE_FACE_ANGLE||i==SView.SMeasure.MEASURE_TYPE_LINE_FACE_ANGLE?r=new SView.SMeasureAngle:i!=SView.SMeasure.MEASURE_TYPE_DIAMETRE&&i!=SView.SMeasure.MEASURE_TYPE_RADIUS||(r=new SView.SMeasureDiametre),r.SetMeasureType(i),r.SetView(this.GetView()),0==(t=r.CreateMeasure()))return t;r.SetCreateID(e.createID);var n="";null!=e.text?n=String(e.text):null!=e.Text&&(n=String(e.Text));var o=new k.Vector3;null!=e.position&&(o.x=e.position[0],o.y=e.position[1],o.z=e.position[2]),r.AddImageBoard(n,o);for(var a=e.lines,s=0;s<a.length;s++){var l=a[s],h=String(l.name),u=new k.Vector3,p=void 0;null!=l.startPoint?p=l.startPoint:null!=l.StartPoint&&(p=l.StartPoint),null!=p&&(u.x=p[0],u.y=p[1],u.z=p[2]);var c=new k.Vector3,d=void 0;null!=l.endPoint?d=l.endPoint:null!=l.EndPoint&&(d=l.EndPoint),null!=d&&(c.x=d[0],c.y=d[1],c.z=d[2]);var S=new k.Color,f=void 0;null!=l.color?f=l.color:null!=l.Color&&(f=l.Color),null!=d&&(S.r=f[0],S.g=f[1],S.b=f[2],S.a=f[3]);var m=new k.SLine(h,u,c,S);r.AddLines(m)}a=e.points;for(var y=0;y<a.length;y++){var T=(l=a[y]).type,M=l.size,g=new k.Vector3,v=void 0;null!=l.point?v=l.point:null!=l.Point&&(v=l.Point),null!=v&&(g.x=v[0],g.y=v[1],g.z=v[2]);var C=new k.SPoint(g,T,M);r.AddPoints(C)}return SView.SView.canvas.GetMeasureManager().Add(r),k.MeasureFactory.AddMeasureToScene(this.GetView().GetSceneManager(),r.GetMeasureObj()),t},e.prototype.parseLight=function(e){var t=this.GetView().GetSceneManager().GetLightManager();if(0<e.length){var r=JSON.parse(e),i=void 0,n=this.GetView().GetModel().GetWorldBoundingBox();if(n){var o=n.Center(),a=r.lights;t.RemoveAllLight();for(var s=0,l=a;s<l.length;s++){var h=l[s];switch(h.type){case 1:var u=t.CreateLight(k.LightType.LightType_Directional);if(u){(i=u).SetWorldPosition(n.max);var p=new k.Quaternion(45,new k.Vector3(-1,0,0));u.SetWorldRotation(p)}break;case 2:var c=t.CreateLight(k.LightType.LightType_Point);if(c)(i=c).SetWorldPosition(o),(f=h.distance)&&c.SetDistance(f),(m=h.decay)&&c.SetDecay(m);break;case 3:var d=t.CreateLight(k.LightType.LightType_Spot);if(null!=d){i=d;var S=new k.Vector3(1,1,1);S.Normalize(),d.SetWorldPosition(o.Add(S.Multiply(.2*n.Length())));var f,m;p=new k.Quaternion(45,new k.Vector3(-1,0,0));d.SetWorldRotation(p),(f=h.distance)&&d.SetDistance(f),(m=h.decay)&&d.SetDecay(m);var y=h.angle;y&&d.SetAngle(y);var T=h.penumbra;T&&d.SetPenumbra(T)}break;case 4:var M=t.CreateLight(k.LightType.LightType_Hemisphere);if(null!=M){(i=M).SetWorldPosition(new k.Vector3(0,1,0));var g=h.groundColor;if(g){var v=new k.Color;v.r=g[0],v.g=g[1],v.b=g[2],v.a=g[3],M.SetGroundColor(v)}}}if(i){var C=h.name;C&&i.SetName(C);var _=h.Intensity;_&&i.SetIntensity(_);var A=h.lightColor;if(A){var E=new k.Color;E.r=A[0],E.g=A[1],E.b=A[2],E.a=A[3],i.SetLightColor(E)}var G=h.castShadow;G&&i.SetShowSimpleSign(G);var P=h.showSimpleSign;P&&i.SetShowSimpleSign(P);var w=h.showAllSign;w&&i.SetShowSimpleSign(w);var D=h.lightPosition,x=h.lightRotation;if(D&&i.SetWorldPosition(new k.Vector3(D[0],D[1],D[2])),x){var R=new k.Quaternion;R.x=x[0],R.y=x[1],R.z=x[2],R.w=x[3],i.SetWorldRotation(R)}t.AddLight(i)}}}}},e.prototype.parseInstanceAttribute=function(e){for(var t=JSON.parse(e).instances,r=0;r<t.length;r++){var i=t[r];this.instanceAttrMap[i.id]=i}this.view.GetSceneManager().GetExtendInfoManager().SetAllInstanceAttr(this.instanceAttrMap)},e.prototype.parsePMI=function(e){var t=JSON.parse(e);if(t){var r=t.pmis;if(r){for(var i=0;i<r.length;i++){var n=r[i],o=new k.PMI;o.fromJson(n),o.SetParentModel(this.topModel),this.pmiMap.Put(o.GetID(),o)}this.view.GetSceneManager().extendinfoMgr.SetPMIs(this.pmiMap);for(i=0;i<t.model_pmis.length;i++){var a=t.model_pmis[i];this.modelPMIMap[a.id]=a.pmis}this.view.GetSceneManager().extendinfoMgr.SetModelPMIRefs(this.modelPMIMap),this.CreateAllPMITextMeshs()}else console.error("pmi file is empty!")}else console.error("pmi file is empty!")},e.prototype.CreateAllPMITextMeshs=function(){for(var e=[],t=0;t<this.pmiMap.Size();t++)for(var r=this.pmiMap.Values()[t],i=0;i<r.ComTexts.length;i++){var n=r.ComTexts[i];n.clearMesh();for(var o=0;o<n.GetCTextList().length;o++){var a={pmiID:t,comTextID:i,ctextID:o,text:n.GetCText(o).GetText()};e.push(a)}}var s=e.length;console.log("pmiText count:"+s);var l=k.ComText.option.pmiServer+"/getTextMeshAll",h=e;0<h.length&&this.SendRequest(this,l,"POST","application/json",h,"json",this.onReceiveTextMesh)},e.prototype.onReceiveTextMesh=function(e,t){for(var r=t,i=0;i<r.length;i++){var n=r[i];e.pmiMap.Values()[n.pmiID].ComTexts[n.comTextID].setTextMeshById(n.CTextID,n)}},e.prototype.SendRequest=function(t,e,r,i,n,o,a,s){void 0===r&&(r="GET"),void 0===n&&(n=null),void 0===o&&(o="text");var l=new XMLHttpRequest;l.open(r,e),l.setRequestHeader("Content-Type",i),o&&(l.responseType=o),l.onreadystatechange=function(){if(4===l.readyState&&200===l.status){var e=l.response;a&&a(t,e)}},s&&(l.onprogress=s),n&&"application/json"==i.toLowerCase()?l.send(JSON.stringify(n)):l.send()},e.prototype.travelModelTree=function(e,t){t(e);for(var r=0;r<e.GetSubModels().length;r++){var i=e.GetSubModels()[r];this.travelModelTree(i,t)}},e.prototype.parseInfo=function(e){var t=JSON.parse(JSON.stringify(e)).info;if(t){var r=t.scene;r&&this.loadInfoSceneNode(r)}},e.prototype.loadInfoSceneNode=function(e){var t=this.view.GetSceneManager().GetResourceManager(),r=e.background;if(r){var i=r.type,n=r.style;if(1===i){if(1===n){var o=r.items;for(var a in o){var s=o[a].split(","),l=s[0].split(" "),h=s[1].split(" "),u=new k.Color(parseFloat(l[0]),parseFloat(l[1]),parseFloat(l[2])),p=new k.Color(parseFloat(h[0]),parseFloat(h[1]),parseFloat(h[2]));this.view.SetBackgroundColor(u,p)}this.view.SetBackgroundUseImage(!1),this.view.SetBackgroundUseSkyBox(!1)}}else if(2===i){if(1===n){o=r.items;for(var a in o){var c=o[a],d=t.GetOrCreateTexture(c),S=c.lastIndexOf("."),f=c.lastIndexOf("\\")+1,m=c.substring(f,S),y=new RegExp(m,"i"),T=this.zipFile.file(y)[0].asArrayBuffer(),M=new Blob([T],{type:"application/octet-binary"}),g=URL.createObjectURL(M);null===(E=t.GetImage(c))&&(E=t.GetOrCreateImage(c,g)),d.AddImage(E),this.view.SetBackgroundTexture(d)}this.view.SetBackgroundUseImage(!0),this.view.SetBackgroundUseSkyBox(!1)}}else if(3===i&&1===n){o=r.items;for(var a in o){for(var v=a,C=o[v].replace(/\s+/g,"").split(","),_=[],A=0;A<C.length;A++){var E;S=(c=C[A]).lastIndexOf("."),f=c.lastIndexOf("\\")+1,m=c.substring(f,S),y=new RegExp(m,"i"),T=this.zipFile.file(y)[0].asArrayBuffer(),M=new Blob([T],{type:"application/octet-binary"}),g=URL.createObjectURL(M);null===(E=t.GetImage(c))&&(E=t.GetOrCreateImage(c,g)),_.push(E)}(d=t.GetOrCreateTexture(v,k.Texture.TEXTURE_CUBE)).AddImages(_),this.view.AddBackgroundSkyBoxTexture(v,d)}this.view.SetBackgroundUseImage(!1),this.view.SetBackgroundUseSkyBox(!0)}}},e.prototype.parseScene=function(e){var t=JSON.parse(JSON.parse(JSON.stringify(e))),r=(k.Parameters.Instance(),this.view.GetSceneManager().GetResourceManager());if(t.scene&&(t.scene.viewportBackground&&null!==t.scene.viewportBackground.type))switch(Number(t.scene.viewportBackground.type)){case 0:if(this.view.SetBackgroundUseImage(!1),this.view.SetBackgroundUseSkyBox(!1),t.scene.viewportBackground.backgroudTopColor&&t.scene.viewportBackground.backgroudBottomColor){var i=new k.Color;i.r=t.scene.viewportBackground.backgroudTopColor[0],i.g=t.scene.viewportBackground.backgroudTopColor[1],i.b=t.scene.viewportBackground.backgroudTopColor[2],i.a=t.scene.viewportBackground.backgroudTopColor[3];var n=new k.Color;n.r=t.scene.viewportBackground.backgroudBottomColor[0],n.g=t.scene.viewportBackground.backgroudBottomColor[1],n.b=t.scene.viewportBackground.backgroudBottomColor[2],n.a=t.scene.viewportBackground.backgroudBottomColor[3],this.view.SetBackgroundColor(i,n)}break;case 1:var o=t.scene.viewportBackground.imageName,a=r.GetOrCreateTexture(o),s=o.lastIndexOf("."),l=o.lastIndexOf("\\")+1,h=o.substring(l,s),u=new RegExp(h,"i"),p=this.zipFile.file(u)[0].asArrayBuffer(),c=new Blob([p],{type:"application/octet-binary"}),d=URL.createObjectURL(c),S=r.GetImage(o);null===S&&(S=r.GetOrCreateImage(o,d)),a.AddImage(S),this.view.SetBackgroundTexture(a),this.view.SetBackgroundUseImage(!0),this.view.SetBackgroundUseSkyBox(!1);break;case 2:var f=t.scene.viewportBackground.skyboxName;if(0<=f.indexOf("background/skyboxes")){var m=[f+"/posx.jpg",f+"/negx.jpg",f+"/posy.jpg",f+"/negy.jpg",f+"/posz.jpg",f+"/negz.jpg"];a=r.GetOrCreateCubeMappingTexture(f,m);this.view.AddBackgroundSkyBoxTexture(f,a)}else if("Street"===f||"BlueSky"===f){m=["./data/background/skyboxes/"+f+"/posx.jpg","./data/background/skyboxes/"+f+"/negx.jpg","./data/background/skyboxes/"+f+"/posy.jpg","./data/background/skyboxes/"+f+"/negy.jpg","./data/background/skyboxes/"+f+"/posz.jpg","./data/background/skyboxes/"+f+"/negz.jpg"],a=r.GetOrCreateCubeMappingTexture(f,m);this.view.AddBackgroundSkyBoxTexture(f,a)}else{m=[],o=t.scene.viewportBackground.skyboxName,u=new RegExp("background/skyboxes/"+o+"/posx","i"),p=this.zipFile.file(u)[0].asArrayBuffer(),c=new Blob([p],{type:"application/octet-binary"}),d=URL.createObjectURL(c);m.push(d),u=new RegExp("background/skyboxes/"+o+"/negx","i"),p=this.zipFile.file(u)[0].asArrayBuffer(),c=new Blob([p],{type:"application/octet-binary"}),d=URL.createObjectURL(c),m.push(d),u=new RegExp("background/skyboxes/"+o+"/posy","i"),p=this.zipFile.file(u)[0].asArrayBuffer(),c=new Blob([p],{type:"application/octet-binary"}),d=URL.createObjectURL(c),m.push(d),u=new RegExp("background/skyboxes/"+o+"/negy","i"),p=this.zipFile.file(u)[0].asArrayBuffer(),c=new Blob([p],{type:"application/octet-binary"}),d=URL.createObjectURL(c),m.push(d),u=new RegExp("background/skyboxes/"+o+"/posz","i"),p=this.zipFile.file(u)[0].asArrayBuffer(),c=new Blob([p],{type:"application/octet-binary"}),d=URL.createObjectURL(c),m.push(d),u=new RegExp("background/skyboxes/"+o+"/negz","i"),p=this.zipFile.file(u)[0].asArrayBuffer(),c=new Blob([p],{type:"application/octet-binary"}),d=URL.createObjectURL(c),m.push(d);a=r.GetOrCreateCubeMappingTexture(f,m);this.view.AddBackgroundSkyBoxTexture(f,a)}this.view.SetBackgroundUseImage(!1),this.view.SetBackgroundUseSkyBox(!0)}},e.prototype.ParseMaterialParameters=function(e,t){for(var r in e){var i=e[r],n=i.type,o=i.value,a=this.GetResourceManager();if("Texture2D"===n){var s=this.imagesMap[o].uri,l=this.GetResourceManager().GetOrCreateTexture(s),h=s.lastIndexOf("."),u=s.lastIndexOf("\\")+1,p=s.substring(u,h),c=new RegExp(p,"i"),d=this.zipFile.file(c)[0].asArrayBuffer(),S=new Blob([d],{type:"application/octet-binary"}),f=URL.createObjectURL(S);null===(M=a.GetImage(s))&&(M=a.GetOrCreateImage(s,f)),l.AddImage(M),t.SetUniformParameter(r,new k.Uniform(n,l))}else if("TextureCube"===n){for(var m=[],y="",T=0;T<o.length;T++){h=(s=this.imagesMap[o[T]].uri).lastIndexOf("."),u=s.lastIndexOf("\\")+1;y+=p=s.substring(u,h);var M;c=new RegExp(p,"i"),d=this.zipFile.file(c)[0].asArrayBuffer(),S=new Blob([d],{type:"application/octet-binary"}),f=URL.createObjectURL(S);null===(M=a.GetImage(s))&&(M=a.GetOrCreateImage(s,f)),m.push(M)}(l=a.GetOrCreateTexture(y,k.Texture.TEXTURE_CUBE)).AddImages(m),t.SetUniformParameter(r,new k.Uniform(n,l))}else if("Vector3"===n){var g=void 0;g=o&&o instanceof Array&&3===o.length?new k.Vector3(o[0],o[1],o[2]):new k.Vector3,t.SetUniformParameter(r,new k.Uniform(n,g))}else if("Vector4"===n){g=void 0;g=o&&o instanceof Array&&4===o.length?new k.Vector4(o[0],o[1],o[2],o[3]):new k.Vector4,t.SetUniformParameter(r,new k.Uniform(n,g))}else if("Float"===n){g=void 0;o instanceof Array?g=o:(g=[]).push(o),t.SetUniformParameter(r,new k.Uniform(n,g))}else if("Bool"===n){g=void 0;g=1==o?1:0,t.SetUniformParameter(r,new k.Uniform(n,g))}else if("Int"===n){g=void 0;o instanceof Array?g=o:(g=[]).push(o),t.SetUniformParameter(r,new k.Uniform(n,g))}}t.SetNeedsUpdateUniformParamerers(!1)},e.prototype.parseRelated=function(e){var t=JSON.parse(JSON.parse(JSON.stringify(e))),r=t.version;if(r){SView.LinkManager.Instance().version=r;for(var i=0,n=t.links;i<n.length;i++){var o=n[i],a=o.srcType,s=o.src,l=o.targetType,h=o.target,u=o.condition,p=null;if("story"==l)for(var c=0,d=this.storyList;c<d.length;c++){var S=d[c];S.id.toString()===h&&(p=S)}var f=new SView.Link(a,s,l,h,u,p);SView.LinkManager.Instance().AddLink(f)}}},e.prototype.parseStory=function(e){var t=JSON.parse(JSON.parse(JSON.stringify(e)));if(t.version){var r=t.storis;r&&(this.storyList=r)}},e.prototype.parseSHotSpot=function(e){for(var t=JSON.parse(JSON.parse(JSON.stringify(e))).hotspots,r=0;r<t.length;r++){var i=t[r],n=i.id,o=i.name,a=i.description,s="";null!=i.viewName&&(s=i.viewName);var l="";null!=i.animationName&&(l=i.animationName);var h=-1;null!=i.modelViewID&&(h=Number(i.modelViewID));var u=-1;null!=i.animationProcessID&&(u=Number(i.animationProcessID));null!=i.animationStepID&&(u=Number(i.animationProcessID));var p="";null===i.voiceFileName&&(p=i.voiceFileName);var c=i.position[0],d=i.position[1],S=i.position[2],f=i.camera[0],m=i.camera[1],y=i.camera[2],T=i.camera[3],M=i.camera[4],g=i.camera[5],v=i.camera[6],C=i.camera[7],_=i.camera[8],A=i.camera[9],E=0;null!=i.cameraProjectionType&&(E=i.cameraProjectionType);var G=new k.ImageModel,P="./Platform/Ctrls/SView/sview/css/images/hotspot.png",w=this.view.GetSceneManager().GetResourceManager(),D=w.GetImage(P);null===D&&(D=w.GetOrCreateImage(P,P)),G.SetImage(D);var x=k.Parameters.Instance().hotSpotImageSize;G.SetImageSize(new k.Vector3(c,d,S),new k.Vector2(x,x)),G.SetAllowScall(!1),G.SetAllowRotate(!1),G.SetInTopShow(!0),this.GetView().GetSceneManager().GetHandlerGroup().AddSVLTool(G,o);var R=new SView.SHotSpot(n,o,a,s,l,p,h,u,-1,c,d,S,f,m,y,T,M,g,v,C,_,A,E,G);SView.SHotSpotManager.Instance().AddHotSpot(R)}},e.prototype.initImages=function(e){for(var t=JSON.parse(JSON.parse(JSON.stringify(e))).images,r=0;r<t.length;r++){var i=t[r],n=i.ID,o=i.name,a=i.path,s=i.position[0],l=i.position[1],h=i.position[2],u=i.size[0],p=i.size[1],c=a.lastIndexOf("."),d=a.lastIndexOf("\\")+1,S=a.substring(d,c),f=new RegExp(S,"i"),m=this.zipFile.file(f)[0].asArrayBuffer(),y=new Blob([m],{type:"application/octet-binary"}),T=URL.createObjectURL(y),M=this.view.GetSceneManager().GetResourceManager(),g=M.GetImage(o);null===g&&(g=M.GetOrCreateImage(o,T));var v=new k.ImageModel;v.SetName(o),v.SetImage(g),v.SetImageSize(new k.Vector3(s,l,h),new k.Vector2(u,p)),v.SetAllowScall(!0),v.SetAllowRotate(!0),v.SetInTopShow(!0),v.SetFixShowInScreen(!0),null!=n&&v.SetID(n),SView.ScreenUILayerManager.Instance().AddHud(v),this.GetView().GetSceneManager().GetScreenUILayerGroup().AddHudModel(v)}},e.prototype.parseAnnotation=function(e){for(var t=JSON.parse(JSON.parse(JSON.stringify(e))).annotations,r=0;r<t.length;r++){var i=t[r],n=new SView.SAnnotation;null==i.type?n.SetAnnotationType(SView.SAnnotation.ANNOTATION_TYPE_BASE):"0"==i.type?(n=new SView.SAnnotationText).SetAnnotationType(SView.SAnnotation.ANNOTATION_TYPE_TEXT):"1"==i.type?(n=new SView.SAnnotation).SetAnnotationType(i.type):"2"==i.type&&(n=new SView.SAnnotationNumber).SetAnnotationType(i.type),n.CreateObject(),n.SetView(this.GetView()),n.SetCreateID(i.createID),n.SetText(i.text),n.SetHaveLenderLine(i.leaderLine),n.SetHaveEnvelope(i.envelope),n.SetHaveStub(i.stub),n.SetFixed(i.fixed);var o=new k.Color;o.r=i.frameColor[0],o.g=i.frameColor[1],o.b=i.frameColor[2],o.a=i.frameColor[3],n.SetFrameColor(o);var a=new k.Color;a.r=i.fillColor[0],a.g=i.fillColor[1],a.b=i.fillColor[2],a.a=i.fillColor[3],n.SetFillColor(a);var s=new k.Vector3;s.x=i.annotationPos[0],s.y=i.annotationPos[1],s.z=i.annotationPos[2],n.SetAnnotationPos(s);var l=new k.Vector3;if(l.x=i.centerPos[0],l.y=i.centerPos[1],l.z=i.centerPos[2],n.SetCenterPos(l),n.GetFixed()){var h=new k.Vector2;i.broadPos?(h.x=i.broadPos[0],h.y=i.broadPos[1],n.SetBroadPos(h)):n.SetFixed(!1)}n.ModifyObject()&&this.GetView().GetSAnnotationManager().Add(n)}},e.prototype.parseAniImage=function(e,t){if(e)for(var r=0;r<e.length;r++){var i=e[r].name,n=i.lastIndexOf("."),o=i.lastIndexOf("\\")+1,a=i.substring(o,n),s=new RegExp(a,"i"),l=t.file(s);if(l){var h=l[0].asArrayBuffer(),u=new Blob([h],{type:"application/octet-binary"}),p=URL.createObjectURL(u),c=this.view.GetSceneManager().GetResourceManager(),d=c.GetImage(i);null===d&&(d=c.GetOrCreateImageById(i,100001,p));var S=new k.ImageModel;0<=i.indexOf("ChildrenAnimation/")&&(i=i.slice(18,i.length)),S.SetName(i),S.SetImage(d),S.SetImageSize(new k.Vector3(0,0,0),new k.Vector2(0,0)),S.SetAllowScall(!0),S.SetAllowRotate(!0),S.SetInTopShow(!0),S.SetFixShowInScreen(!0),SView.ScreenUILayerManager.Instance().AddHud(S),this.GetView().GetSceneManager().GetScreenUILayerGroup().AddHudModel(S)}}},e}(k.Reader);k.SvlxReader=e}(M3D||(M3D={})),function(e){var t=function(){function e(){}return e.GetXMLDom=function(e){var t=e.asText(),r=t.indexOf("<");t=t.substr(r);var i=null;if(window.hasOwnProperty("DOMParser"))try{i=(new DOMParser).parseFromString(t,"text/xml")}catch(e){}else if(window.hasOwnProperty("ActiveXObject"))for(var n=["MSXML2.DOMDocument","Microsoft.XMLDOM"],o=0;o<n.length;o++)try{(i=new ActiveXObject(n[o])).async=!1,i.loadXML(t);break}catch(e){continue}return i},e}();e.XMLParser=t}(M3D||(M3D={})),function(e){var t=function(){function e(){this.XMLDom=null}return e.GetInstance=function(){return e.instance||(e.instance=new e),e.instance},e.prototype.GetModleViewByXmlStr=function(e){var t=new M3D.ModleView,r=new M3D.Map,i=new M3D.Camera,n=e.getElementsByTagName("Camera")[0],o=n.getAttribute("Position").split(" "),a=n.getAttribute("Rotation").split(" ");i.SetCamera(new M3D.Vector3(parseFloat(o[0]),parseFloat(o[1]),parseFloat(o[2])),new M3D.Quaternion(parseFloat(a[3]),parseFloat(a[0]),parseFloat(a[1]),parseFloat(a[2])),parseFloat(n.getAttribute("ZoomFactor")),"1"==n.getAttribute("Orthographic"),parseFloat(n.getAttribute("NearClip")),parseFloat(n.getAttribute("FarClip")),parseInt(n.getAttribute("FOV")));var s=e.getElementsByTagName("Instances");switch(s.length,e.getAttribute("Type")){case"DefaultView":this.Type=M3D.ViewTypeEnum.DefaultView;break;case"OrignalView":this.Type=M3D.ViewTypeEnum.OrignalView;break;case"UserView":this.Type=M3D.ViewTypeEnum.UserView;break;default:this.Type=M3D.ViewTypeEnum.DefaultView}return t.SetModleView(parseInt(e.getAttribute("ID")),e.getAttribute("Name"),this.Type,i,[],[],[],r),t},e.prototype.GetModleViewList=function(e,t){this.XMLDom=e,this.modleViewsArray=this.XMLDom.getElementsByTagName("SVL")[0].children[0].children[1].getElementsByTagName("View");for(var r=0;r<this.modleViewsArray.length;r++)t.push(this.GetModleViewByXmlStr(this.modleViewsArray[r]));return t},e.prototype.UpdateModleView=function(e){},e.prototype.DelateModleView=function(e){},e.prototype.AddModleView=function(e){},e.prototype.Create=function(){var e=(new Date).toISOString(),t=new M3D.ModleView;return t.SetName(e),t.SetViewType(2),t},e.prototype.parseOneModelView=function(e){var t=new M3D.ModleView;t.SetID(e.id),t.SetName(e.name),t.SetViewType(e.usageType);var r=e.camera;if(r){var i=new M3D.Camera;if(i.SetOrthographic("1"==r.projectType),r.angle){var n=r.angle;i.SetFov(n)}if(r.matix){var o=new M3D.Matrix4;o.fromString(r.matix);var a=new M3D.Quaternion,s=new M3D.Matrix3(o.data[0],o.data[4],o.data[8],o.data[1],o.data[5],o.data[9],o.data[2],o.data[6],o.data[10]);a.FromRotationMatrix(s),i.SetPosition(new M3D.Vector3(o.data[12],o.data[13],o.data[14])),i.SetRotation(a)}var l=1;r.aspectRatio&&(l=r.aspectRatio),i.SetAspectRatio(l),r.nearDistance&&i.SetNearClip(r.nearDistance),r.farDistance&&i.SetFarClip(r.farDistance),r.focalDistance,r.height&&i.IsOrthographic()&&i.SetOrthoSize(new M3D.Vector2(r.height*l,r.height)),i.SetZoom(1),t.SetCamera(i),t.SetUpDataCamera(!0)}var h=e.insAttributes;for(var u in h){var p=h[u],c=p.matix,d=new M3D.InstanceAttribute;d.id=p.plcPath;var S=p.visible;if(d.visible=0===S,d.path=M3D.PathHelper.SVLPathDecToHex(u),c){var f=void 0,m=c.split(" ");if(16==m.length?f=new M3D.Matrix4:12==m.length&&(f=new M3D.Matrix3x4),f.fromString(c),f.Equals(M3D.Matrix4.ZERO().Clone()))continue;d.placeMatrix=f}var y=p.color;if(y){var T=y.split(" ");d.hasColor=!0;var M=new M3D.Color(Number(T[0]),Number(T[1]),Number(T[2]),Number(T[3]));d.insColor=M.Clone()}t.GetInstanceAttributeMap().Put(Number(p.plcPath),d)}return t},e.prototype.FromJson=function(e){var t=[],r=JSON.parse(JSON.parse(JSON.stringify(e)));if(r){if(r.version)r.version;var i=new Array;if(r.model_views)i=r.model_views[0].views;var n=r.views;if(n)for(var o=0;o<n.length;o++){var a=n[o];if(!(i.indexOf(a.id)<0)){var s=this.parseOneModelView(a);if(r.view_pmis)for(var l=r.view_pmis,h=0;h<l.length;h++){if(l[h].id)if(l[h].id===s.GetID())for(var u=0;u<l[h].pmis.length;u++)s.AddPMIId(l[h].pmis[u])}if(r.view_notes){var p=r.view_notes;for(h=0;h<p.length;h++){if(p[h].id)if(p[h].id===s.GetID())for(u=0;u<p[h].notes.length;u++)s.AddNoteId(p[h].notes[u])}}if(r.view_sections){var c=r.view_sections;for(h=0;h<c.length;h++){if(c[h].id)if(c[h].id===s.GetID())for(u=0;u<c[h].sections.length;u++)s.AddSectionPlaneId(c[h].sections[u])}}t.push(s)}}return t}},e.prototype.ToJson=function(){for(var e=this.modleViewList,t="[",r=0;r<e.length;r++){var i=e[r];t+="{",t+='"id":'+i.GetID()+',"name":"'+i.GetName()+'","usageType":'+i.GetViewType()+',"isActivated":false,"isDefault":false,"transparency":1.0,';var n=i.GetCamera();if(n){t+='"camera":{"projectType":'+n.GetOrthographic()+',"angle":1.0,"matix":"';var o=new M3D.Matrix4(n.GetRotation().RotationMatrix().Inverse());o.data[12]=n.GetPosition().x,o.data[13]=n.GetPosition().y,o.data[14]=n.GetPosition().z;for(var a=o.data,s=0;s<a.length;s++)t+=a[s].toFixed(8),s<a.length-1?t+=" ":t+='"';t+="},"}var l=i.GetInstanceAttributeMap();t+='"insAttributes":{';for(s=0;s<l.Keys().length;s++){var h=l.Keys()[s],u=l.Values()[s];t+='"'+M3D.PathHelper.SVLPathHexToDec(u.path)+'":{"plcPath":'+h+',"visible":'+(u.visible?0:1)+',"matix":"'+u.placeMatrix.Tostring()+'"',u.hasColor?t+=',"color":"'+u.insColor.Tostring()+'"}':t+=',"color":"-1.00000000 -1.00000000 -1.000000000 -1.00000000"}',s<l.Keys().length-1&&(t+=",")}t+="}},"}return t+="]"},e.prototype.Remove=function(e){for(var t=0;t<this.modleViewList.length;t++)if(e.GetID()===this.modleViewList[t].GetID()){this.modleViewList.splice(t,1);break}},e.prototype.Get=function(e){for(var t=0;t<this.modleViewList.length;t++)if(e===this.modleViewList[t].GetID())return this.modleViewList[t]},e.instance=null,e}();e.ViewManager=t}(SView||(SView={})),function(f){var e,t;(t=e=f.TouchHandlerType||(f.TouchHandlerType={}))[t.HANDLER_WALKTHROUGH=0]="HANDLER_WALKTHROUGH",t[t.HANDLER_COMMON=1]="HANDLER_COMMON",t[t.HANDLER_ORBIT=2]="HANDLER_ORBIT",t[t.HANDLER_DRAGGER=3]="HANDLER_DRAGGER";var r=function(){function o(){this.m_restoreCamera=!0,this.trackBall=new f.Trackball,this.keepRotateTimer=new f.Timer,this.oribitControlTarget=f.Vector3.ZERO().Clone(),this.firstPersionSpeed=0,this.standardSpeed=0,this.modelRotation=f.Quaternion.IDENTITY().Clone(),this.rotateRadius=0,this.changeDisOnRotate=!0,this.oberveMode=0,this.freeViewMode=!1,this.controlLockXY=!0,this.oribitMode=!1,this.bLookaroundMode=!1,this.PriPointTwo1=f.Vector2.ZERO().Clone(),this.PriPointTwo2=f.Vector2.ZERO().Clone(),this.needInitRotOnFix=!0,this.rotTheta=.5,this.oldCameraPosOnOrigin=f.Vector3.ZERO().Clone(),this.birdEyeFixedPnt=f.Vector3.ZERO().Clone(),this.birdEyeSpeed=1,this.rotateOnFixedPointTimer=new f.Timer,this.rotateFixedAxis=f.Vector3.UP().Clone(),this.modelRotateOnFixedPointTimer=new f.Timer,this.modelRotateAngle=.5,this.modelRotateAxis=f.Vector3.UP().Clone(),this.circleCount=1,this.rotCirlceCount=0,this.isMatchCircleCount=!1,this.screenDepth=.001,this.sceneManager=null,this.pView=null,this.touchHandlerType=e.HANDLER_WALKTHROUGH,this.m_fYaw=0,this.m_fPitch=0,this.m_bfirstPersion=!1}return o.prototype.SetView=function(e){this.pView=e,this.keepRotateTimer.SetTimer(this.TimerTask,this,36),this.Reset()},o.prototype.Reset=function(){this.sceneManager=this.pView.GetSceneManager(),this.trackBall.SetSceneManager(this.sceneManager)},o.prototype.HandleTouchEvent=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(3===e.length)this.HandleTouchEvent(e[0],e[1],e[2],0);else if(4===e.length){this.width=this.sceneManager.GetRenderManager().GetWindowWidth(),this.height=this.sceneManager.GetRenderManager().GetWindowHeight();var r=[];if(null!=e[0][2]&&null!=e[0][3]?(r[0]=e[0][4],r[1]=e[0][5]):r=e[0],this.HandleDragger(r,e[1],e[2],e[3]))return;switch(this.selectedNodes=this.pView.GetWorkNodes(),e[2]){case o.TOUCHDOWN:this.TouchDown(e[0],e[1]);break;case o.TOUCHMOVE:this.TouchMove(e[3],e[0],e[1]);break;case o.TOUCHUP:this.TouchUp(e[0],e[1])}}},o.prototype.HandleDragger=function(e,t,r,i){var n=new f.MotionEvent(e,1);if(n.SetView(this.pView),this.pView){switch(r){case o.TOUCHDOWN:n.setEventType(f.EventType.PUSH);break;case o.TOUCHMOVE:n.setEventType(f.EventType.DRAG);break;case o.TOUCHUP:n.setEventType(f.EventType.RELEASE)}this.pView.GetSceneManager().GetHandlerGroup().HandleDragger(n)}return n.getHandled()},o.prototype.RefreshModelViewCamera=function(){this.InitModelViewCamera()},o.prototype.Open=function(){this.InitCamera()},o.prototype.Close=function(){},o.prototype.GetTouchHandlerType=function(){return this.touchHandlerType},o.prototype.GetDefaultView=function(){return f.Parameters.Instance().m_defaultViewType},o.prototype.SetDefaultView=function(e){f.Parameters.Instance().m_defaultViewType=e},o.prototype.OnUpDataTouchIntent=function(){},o.prototype.OnUpDateTouchIntent=function(e){},o.prototype.UpdateCamera=function(){},o.prototype.InitCamera=function(){if(null!=this.sceneManager){var e=this.sceneManager.GetCamera(),t=this.sceneManager.GetSceneBox();if(this.GetRestoreCamera()){e.ReSet();var r=t.Length(),i=t.Center();this.oribitControlTarget=i.Clone(),i.z+=t.Length()*f.CAMERA_POSFACTOR,e.SetWorldPosition(i),r=this.sceneManager.GetDefaultFocusLength(),e.SetNearClip(r*f.NEAR_CLIP_PLANE_FACTOR),e.SetFarClip(r*f.FAR_CLIP_PLANE_FACTOR),e.LookAt(t.Center(),new f.Vector3(0,1,0),f.SceneNode.TS_WORLD),this.trackBall.SetRotateSpeed(2)}else{var n=t.Length(),o=e.GetRotateCenter().Clone(),a=e.GetWorldPosition().Clone().Sub(o).Normalized();e.SetWorldPosition(o.Add(a.Multiply(t.Length()).Multiply(f.CAMERA_POSFACTOR))),n=this.sceneManager.GetDefaultFocusLength(),e.SetNearClip(n*f.NEAR_CLIP_PLANE_FACTOR),e.SetFarClip(n*f.FAR_CLIP_PLANE_FACTOR)}var s=e.GetViewPort(),l=s.rect.Height(),h=s.rect.Width();this.sceneManager.GetRenderManager().WindowSizeChanged(h,l),e.SetZoom(this.sceneManager.GetDefaultZoom()),e.SetInitRotateCenter(t.Center());var u=e.GetViewPort().rect,p=u.Width()>u.Height()?u.Height():u.Width();this.trackBall.SetTrackWindow(p,p)}},o.prototype.InitModelViewCamera=function(){},o.prototype.OptimizeCamera=function(){},o.prototype.OnTouchUp=function(e,t){},o.prototype.OnTouchMove=function(e,t,r){},o.prototype.OnTouchDown=function(e,t){},o.prototype.TouchUp=function(e,t){this.OnTouchUp(e,t)},o.prototype.TouchMove=function(e,t,r){this.OnTouchMove(e,t,r)},o.prototype.TouchDown=function(e,t){this.OnTouchDown(e,t)},o.prototype.UpDataTouchIntent=function(e){this.UpDataTouchIntentWithSpeedControl(1,e)},o.prototype.UpDataTouchIntentWithSpeedControl=function(e,t){this.OnUpDateTouchIntent(t),this.sceneManager.ShowRotationCenter(f.Trackball.ISROTATING),this.sceneManager.GetRenderManager().UseLowQuality(f.Trackball.ISROTATING||-1!==f.Trackball.MOVESTATE)},o.prototype.StateChanged=function(){return!(Math.abs(this.trackBall.mvMatrix.rotation.LengthSquared())<.01&&this.trackBall.mvMatrix.moveVector.Length()<.02&&Math.abs(this.trackBall.mvMatrix.scaleFactor-1)<.05)},o.prototype.UpdateRenderQuality=function(e){},o.prototype.RotateOnFixedPoint=function(){if(this.sceneManager){var e=this.sceneManager,t=e.GetCamera(),r=f.Vector3.LEFT().Clone();if(this.needInitRotOnFix){var i=t.GetWorldPosition();this.birdEyeFixedPnt=e.GetSceneBox().Center(),this.oldCameraPosOnOrigin=i.Sub(this.birdEyeFixedPnt),this.rotateRadius=this.oldCameraPosOnOrigin.Length(),this.needInitRotOnFix=!1}var n=new f.Quaternion(this.rotTheta,r);n.Normalize();var o=new f.Quaternion(0,this.oldCameraPosOnOrigin.x,this.oldCameraPosOnOrigin.y,this.oldCameraPosOnOrigin.z),a=n.Multiply(o).Multiply(n.Inverse()),s=new f.Vector3(a.x,a.y,a.z);t.SetWorldPosition(s.Add(this.birdEyeFixedPnt)),t.LookAt(this.birdEyeFixedPnt,r,f.SceneNode.TS_WORLD),this.rotTheta=this.rotTheta+this.birdEyeSpeed,(-1e-7<this.rotTheta-360&&this.rotTheta-360<1e-8||360<this.rotTheta)&&(this.rotTheta=this.rotTheta-360)}},o.prototype.GetRotateOnFixedPointFunc=function(e){return e.RotateOnFixedPoint(),null},o.prototype.StartRotateOnFixedPoint=function(){this.rotateOnFixedPointTimer.IsStart()&&(this.rotateOnFixedPointTimer.StopTimer(),this.needInitRotOnFix=!0,this.rotTheta=0),this.needInitRotOnFix=!0,this.rotTheta=0,this.rotateOnFixedPointTimer.StartTimer(),this.rotateOnFixedPointTimer.SetTimer(this.GetRotateOnFixedPointFunc,this,36)},o.prototype.EndRotateOnFixedPoint=function(){this.rotateOnFixedPointTimer.IsStart()&&this.rotateOnFixedPointTimer.StopTimer(),this.needInitRotOnFix=!0,this.rotTheta=0},o.prototype.StartKeepState=function(){this.keepRotateTimer.IsStart()||this.keepRotateTimer.StartTimer()},o.prototype.CloseKeepState=function(){this.keepRotateTimer.IsStart()&&this.EndKeepState()},o.prototype.EndKeepState=function(){this.keepRotateTimer.IsStart()&&this.keepRotateTimer.StopTimer()},o.prototype.KeepState=function(){this.StateChanged()&&this.UpDataTouchIntentWithSpeedControl(.3,1)},o.prototype.TimerTask=function(e){return e.KeepState(),null},o.prototype.SetUpDirection=function(e,t){f.LOGI(" TouchHandler::SetUpDirection"),f.Parameters.Instance().m_upDirectionValue=e;var r=this.sceneManager,i=r.GetSceneRoot().Search(f.MAINMODELROOT);if(i){var n=new f.Quaternion(f.Vector3.UP().Clone(),f.Parameters.Instance().m_upDirectionValue),o=r.GetSceneBox(),a=o.Center(),s=f.Matrix3x4.IDENTITY().Clone(),l=f.Matrix3x4.IDENTITY().Clone(),h=f.Matrix3x4.IDENTITY().Clone();s.MultiTranslate(a.Multiply(-1)),h.MultiRotatiton(n),l.MultiTranslate(a);var u=l.Multiply(h).Multiply(s);i.SetPlcMatrix(u),this.setUpPlcMat=u,o.Clear()}},o.prototype.StartModelRotateOnFixedPoint=function(){this.modelRotateOnFixedPointTimer.IsStart()&&this.modelRotateOnFixedPointTimer.StopTimer(),this.modelRotateOnFixedPointTimer.StartTimer(),this.modelRotateOnFixedPointTimer.SetTimer(this.GetModelRotateOnFixedPointFunc,this,36)},o.prototype.EndModelRotateOnFixedPoint=function(){this.modelRotateOnFixedPointTimer.IsStart()&&this.modelRotateOnFixedPointTimer.StopTimer()},o.prototype.ModelRotateOnFixedPoint=function(){var e=this.sceneManager,t=e.GetSceneRoot().Search(f.MAINMODELROOT);if(t){var r=this.sceneManager.GetCamera().GetView().ToMatrix3().Data();this.modelRotateAxis=new f.Vector3(r[3],r[4],r[5]),this.modelRotateAxis.Normalize();var i=new f.Quaternion(this.modelRotateAngle,this.modelRotateAxis),n=e.GetSceneBox().Center(),o=new f.Matrix3x4,a=new f.Matrix3x4,s=new f.Matrix3x4;o.MultiTranslate(n.Multiply(-1)),s.MultiRotatiton(i),a.MultiTranslate(n);var l=a.Multiply(s).Multiply(o);t.SetPlcMatrix(l),this.modelRotateAngle=this.modelRotateAngle+this.birdEyeSpeed,(-1e-7<this.modelRotateAngle-360&&this.modelRotateAngle-360<1e-8||360<this.modelRotateAngle)&&(this.modelRotateAngle=this.modelRotateAngle-360,this.rotCirlceCount++,this.rotCirlceCount===this.circleCount?(this.isMatchCircleCount=!0,this.rotCirlceCount=0):this.isMatchCircleCount=!1)}},o.prototype.OnlyRotate=function(e){var t=e;t.sceneManager.GetCamera().RotateAroundCenter(new f.Quaternion(1,0,Math.sin(-.02*t.birdEyeSpeed/2),0),f.SceneNode.TS_WORLD)},o.prototype.GetModelRotateOnFixedPointFunc=function(e){var t=e;return t.sceneManager.GetCamera().RotateAroundCenter(new f.Quaternion(1,0,Math.sin(-.02*t.birdEyeSpeed/2),0),f.SceneNode.TS_WORLD),t.modelRotateAngle+=.02*t.birdEyeSpeed,t.modelRotateAngle>=2*Math.PI&&(t.modelRotateAngle=0,t.rotCirlceCount++,99999===t.rotCirlceCount&&(t.rotCirlceCount=0)),null},o.prototype.SetModelRotateAxis=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(e[0]instanceof f.Vector3)this.modelRotateAxis=e[0].Clone();else if("number"==typeof e[0])switch(e[0]){case 0:this.modelRotateAxis=f.Vector3.LEFT().Clone();break;case 1:this.modelRotateAxis=f.Vector3.UP().Clone();break;case 2:this.modelRotateAxis=f.Vector3.BACK().Clone()}},o.prototype.SetModelRotateSpeed=function(e){this.birdEyeSpeed=e},o.prototype.SetNeedCircle=function(e){this.circleCount=e},o.prototype.ResetRotCircleCount=function(){this.rotCirlceCount=0,this.isMatchCircleCount=!1},o.prototype.IsMatchCircleCount=function(){return this.isMatchCircleCount},o.prototype.GetCircleNumber=function(){return this.rotCirlceCount},o.prototype.TwoFingersRotate=function(e,t){if(!(e.length<4)){var r=new f.Vector2(e[0],e[1]),i=new f.Vector2(e[2],e[3]),n=this.PriPointTwo1.Sub(this.PriPointTwo2),o=r.Sub(i),a=n.Length(),s=o.Length();if(!(a+s<5)){var l=this.PriPointTwo1.Add(this.PriPointTwo2).Multiply(.5),h=n.DotProduct(o)/(a*s);1<h&&(h=1);var u=Math.acos(h);n.Normalized(),o.Normalized();var p=new f.Vector2(o.y,-o.x);n.DotProduct(p)<=0&&(u=-u);var c=this.sceneManager.GetCamera(),d=c.GetRotateCenter().Clone(),S=c.GetViewPort().ScreenToWorldPoint(l.x,l.y,.5);c.SetRotateCenter(S),c.RotateAroundCenter(new f.Quaternion(1,0,0,Math.sin(.5*u)),f.SceneNode.TS_WORLD),c.SetRotateCenter(d)}}},o.prototype.SetFirstPersionParameter=function(e){this.firstPersionSpeed=e},o.prototype.ResetViewCamera=function(){},o.prototype.SetRestoreCamera=function(e){this.m_restoreCamera=e},o.prototype.GetRestoreCamera=function(){return this.m_restoreCamera},o.TOUCHUP=0,o.TOUCHDOWN=1,o.TOUCHMOVE=2,o}();f.TouchHandler=r}(M3D||(M3D={})),function(v){var C,e,_,t;(e=C=v.OPEMODE||(v.OPEMODE={}))[e.TRANSLATE=0]="TRANSLATE",e[e.ROTATE=1]="ROTATE",e[e.SCALE=2]="SCALE",(t=_=v.TRANSAXIS||(v.TRANSAXIS={}))[t.AXIS_X=0]="AXIS_X",t[t.AXIS_Y=1]="AXIS_Y",t[t.AXIS_Z=2]="AXIS_Z",t[t.AXIS_FACE=3]="AXIS_FACE";var r=function(t){function e(){var e=t.call(this)||this;return e.mode=C.TRANSLATE,e.axis=_.AXIS_FACE,e.priPointTwo1=new v.Vector2,e.touchHandlerType=v.TouchHandlerType.HANDLER_DRAGGER,e}return __extends(e,t),e.prototype.SetMode=function(e){this.mode=e},e.prototype.SetAxis=function(e){this.axis=e},e.prototype.InitCamera=function(){t.prototype.InitCamera.call(this),this.GetRestoreCamera()&&this.pView&&v.PerspectiveOperator.GetInstance().Show(this.pView,this.GetDefaultView(),!0,!1,!1)},e.prototype.InitModelViewCamera=function(){if(this.sceneManager){var e=this.sceneManager.GetCamera();e.ReSet(),e.SetOrthographic(!1);var t=this.sceneManager.GetSceneBox(),r=e.GetViewPort(),i=r.rect.Height(),n=r.rect.Width();this.sceneManager.GetRenderManager().WindowSizeChanged(n,i);var o=t.Length(),a=t.Center();a.z+=8.5*t.Length(),e.SetWorldPosition(a),e.SetNearClip(.1*o),e.SetFarClip(15.5*o);var s=1.8;s=s*i/n,n<i&&(s=.5*s*(1*n/i)),e.SetZoom(s),e.SetInitRotateCenter(t.Center()),e.LookAt(t.Center(),new v.Vector3(0,1,0),v.SceneNode.TS_WORLD),this.pView&&v.PerspectiveOperator.GetInstance().Show(this.pView,this.GetDefaultView(),!0,!1,!1)}},e.prototype.OptimizeCamera=function(){},e.prototype.OnTouchUp=function(e,t){if(v.Parameters.Instance().IsConRotate)if(1===t)if(3<this.trackBall.angle){var r=this.trackBall.angle;r=0<r?Math.min(r,15):Math.max(r,-15),14<Math.abs(this.trackBall.angle)&&this.trackBall.mvMatrix.rotation.FromAngleAxis(r,this.trackBall.axis),this.StartKeepState()}else this.EndKeepState();else 2===t&&this.trackBall.TwoPointsUp(e,t);else 1===t?(this.EndKeepState(),this.trackBall.OnePointUp(e,t)):2===t&&this.trackBall.TwoPointsUp(e,t),this.trackBall.Reset();this.UpdateRenderQuality(!1),this.UpDataTouchIntent(t)},e.prototype.OnTouchMove=function(e,t,r){var i;if(1==r){if(1==e)if(0<(i=this.GetSelectModel()).length)switch(this.mode){case C.ROTATE:this.trackBall.OnePointRotate(t,r);break;case C.TRANSLATE:this.trackBall.OnePointsMove(t,r);break;case C.SCALE:this.trackBall.OnePointsScale(t,r)}else this.trackBall.OnePointRotate(t,r)}else 2==r&&(this.trackBall.TwoPointsMove(t,r),this.GetSelectModel().length<1&&(this.TwoFingersRotate(t,r),this.PriPointTwo1.x=t[0],this.PriPointTwo1.y=t[1],this.PriPointTwo2.x=t[2],this.PriPointTwo2.y=t[3]));if(this.StateChanged())if((i=this.GetSelectModel()).length<1)this.UpDataTouchIntent(r);else switch(this.mode){case C.ROTATE:var n=this.trackBall.mvMatrix.rotation.Clone(),o=this.sceneManager.GetCamera().GetView().ToMatrix3(),a=new v.Quaternion(o);if(a.Normalize(),n=a.Inverse().Multiply(n).Multiply(a),this.axis===_.AXIS_FACE)for(var s=0;s<i.length;s++)v.ModelTransformHelper.RotateModel(i[s],n);else if(this.axis===_.AXIS_Z){var l=new v.Quaternion(n.w,0,0,n.z);l.Normalize();for(s=0;s<i.length;s++)v.ModelTransformHelper.RotateModel(i[s],l)}else if(this.axis===_.AXIS_Y){var h=new v.Quaternion(n.w,0,n.y,0);h.Normalize();for(s=0;s<i.length;s++)v.ModelTransformHelper.RotateModel(i[s],h)}else if(this.axis===_.AXIS_X){var u=new v.Quaternion(n.w,n.x,0,0);u.Normalize();for(s=0;s<i.length;s++)v.ModelTransformHelper.RotateModel(i[s],u)}break;case C.TRANSLATE:var p=this.trackBall.mvMatrix.moveVector.Clone();if(p=(o=this.sceneManager.GetCamera().GetView().ToMatrix3().Inverse()).Multiply(p),this.axis===_.AXIS_X){var c=new v.Vector3(p.x,0,0);for(s=0;s<i.length;s++)v.ModelTransformHelper.TranslateModel(i[s],c)}else if(this.axis===_.AXIS_Y){var d=new v.Vector3(0,p.y,0);for(s=0;s<i.length;s++)v.ModelTransformHelper.TranslateModel(i[s],d)}else if(this.axis===_.AXIS_Z){var S=new v.Vector3(0,0,p.z);for(s=0;s<i.length;s++)v.ModelTransformHelper.TranslateModel(i[s],S)}else if(this.axis===_.AXIS_FACE){var f=new v.Vector3,m=new v.Vector3,y=this.sceneManager.GetCamera().GetViewPort();f=y.ScreenToWorldPoint(this.priPointTwo1.x,this.priPointTwo1.y,.5),m=y.ScreenToWorldPoint(t[0],t[1],.5);var T=new v.Vector3(m.Sub(f));for(s=0;s<i.length;s++)v.ModelTransformHelper.TranslateModel(i[s],T)}break;case C.SCALE:var M=1/this.trackBall.mvMatrix.scaleFactor;if(this.axis===_.AXIS_X)for(c=new v.Vector3(M,1,1),s=0;s<i.length;s++)v.ModelTransformHelper.ScaleModel(i[s],c);else if(this.axis===_.AXIS_Y)for(d=new v.Vector3(1,M,1),s=0;s<i.length;s++)v.ModelTransformHelper.ScaleModel(i[s],d);else if(this.axis===_.AXIS_Z)for(S=new v.Vector3(1,1,M),s=0;s<i.length;s++)v.ModelTransformHelper.ScaleModel(i[s],S);else if(this.axis===_.AXIS_FACE){var g=new v.Vector3(M,M,M);for(s=0;s<i.length;s++)v.ModelTransformHelper.ScaleModel(i[s],g)}}this.priPointTwo1.x=t[0],this.priPointTwo1.y=t[1],this.UpdateRenderQuality(!0)},e.prototype.OnTouchDown=function(e,t){this.trackBall.Reset(),this.priPointTwo1.x=e[0],this.priPointTwo1.y=e[1],1==t?this.trackBall.OnePointStart(e,t):2==t&&(this.GetSelectModel().length<1&&(this.PriPointTwo1.x=e[0],this.PriPointTwo1.y=e[1],this.PriPointTwo2.x=e[2],this.PriPointTwo2.y=e[3]),this.trackBall.TwoPointsStart(e,t))},e.prototype.OnUpDataTouchIntent=function(){var e=this.trackBall.mvMatrix.rotation.Inverse(),t=this.sceneManager.GetCamera();t.RotateAroundCenter(e,v.SceneNode.TS_WORLD),t.Translate(this.trackBall.mvMatrix.moveVector.Multiply(-1),v.SceneNode.TS_LOCAL),t.ZoomView(1/this.trackBall.mvMatrix.scaleFactor)},e.prototype.GetSelectModel=function(){var e=[],t=this.pView.GetSelector().GetAll();if(t&&0<t.length)for(var r=0;r<t.length;r++)t[r]&&t[r].GetType()===v.ShapeType.SHAPE_MODEL&&e.push(t[r]);return e},e}(v.TouchHandler);v.DraggerHandler=r}(M3D||(M3D={})),function(p){var e=function(){function u(){}return u.drawLine=function(e,t){var r=t.getStart().x,i=t.getStart().y,n=t.getEnd().x,o=t.getEnd().y;e.lineWidth=t.getBlod();var a=Math.floor(255*t.getColor().r),s=Math.floor(255*t.getColor().g),l=Math.floor(255*t.getColor().b),h=Math.floor(255*t.getColor().a);0!==h&&(e.strokeStyle="RGB("+a.toString()+","+s.toString()+","+l.toString()+","+h.toString()+")",e.beginPath(),e.moveTo(r,i),e.lineTo(n,o),e.stroke(),e.closePath())},u.drawRect=function(e,t){var r=Math.floor(255*t.getColor().r),i=Math.floor(255*t.getColor().g),n=Math.floor(255*t.getColor().b),o=(Math.floor(255*t.getColor().a),t.getStart().x),a=t.getStart().y,s=t.getEnd().x,l=t.getEnd().y;t.getRadius().x,t.getRadius().y;e.fillStyle="RGB("+r.toString()+","+i.toString()+","+n.toString()+")",e.fillRect(o,a,s-o,l-a)},u.drawTexts=function(e,t){var r=Math.floor(255*t.getColor().r),i=Math.floor(255*t.getColor().g),n=Math.floor(255*t.getColor().b),o=(Math.floor(255*t.getColor().a),t.getStart().x),a=t.getStart().y;e.fillStyle="RGB("+r.toString()+","+i.toString()+","+n.toString()+")",e.font="Bold 40pt "+t.getFontName(),e.fillText(t.getTexts(),o,a)},u.drawFillCircle=function(e,t){var r=Math.floor(255*t.getColor().r),i=Math.floor(255*t.getColor().g),n=Math.floor(255*t.getColor().b),o=t.getStart().x,a=t.getStart().y,s=t.getEnd().x,l=t.getEnd().y;e.fillStyle="RGB("+r.toString()+","+i.toString()+","+n.toString()+")",e.beginPath(),e.arc((o+s)/2,(a+l)/2,(s-o)/2,0,2*Math.PI),e.fill(),e.closePath()},u.drawStrokeCircle=function(e,t){var r=Math.floor(255*t.getColor().r),i=Math.floor(255*t.getColor().g),n=Math.floor(255*t.getColor().b),o=t.getStart().x,a=t.getStart().y,s=t.getEnd().x,l=t.getEnd().y;e.lineWidth=t.getWidth(),e.strokeStyle="RGB("+r.toString()+","+i.toString()+","+n.toString()+")",e.beginPath(),e.arc((o+s)/2,(a+l)/2,(s-o)/2,0,2*Math.PI),e.stroke(),e.closePath()},u.externsRect=function(e,t){null!==t&&(e.getStart().x>t.x&&(e.getStart().x=t.x),e.getStart().y>t.y&&(e.getStart().y=t.y),e.getEnd().x<t.x&&(e.getEnd().x=t.x),e.getEnd().y<t.y&&(e.getEnd().y=t.y))},u.getRectF=function(e){for(var t=new p.Rect2D,r=e.getShapes(),i=0;i<r.length;i++){if((l=r[i])instanceof p.Line2D){var n=l;u.externsRect(t,n.getStart()),u.externsRect(t,n.getEnd())}}for(var o=0;o<r.length;o++){if((l=r[o])instanceof p.Rect2D){var a=l;u.externsRect(t,a.getStart()),u.externsRect(t,a.getEnd())}}for(var s=0;s<r.length;s++){var l;if((l=r[s])instanceof p.Ellipse2D){var h=l;u.externsRect(t,h.getStart()),u.externsRect(t,h.getEnd())}}return t.getStart().x=t.getStart().x,t.getStart().y=t.getStart().y,t.getEnd().x=t.getEnd().x,t.getEnd().y=t.getEnd().y,t},u.drawShapes=function(e,t){for(var r=t.getShapes(),i=0;i<r.length;i++){if((o=r[i])instanceof p.Ellipse2D)(n=o).GetIsFill()&&u.drawFillCircle(e,n)}for(i=0;i<r.length;i++){var n;if((o=r[i])instanceof p.Ellipse2D)(n=o).GetIsFill()||u.drawStrokeCircle(e,n)}for(i=0;i<r.length;i++){(o=r[i])instanceof p.Rect2D&&u.drawRect(e,o)}for(i=0;i<r.length;i++){(o=r[i])instanceof p.Line2D&&u.drawLine(e,o)}for(i=0;i<r.length;i++){var o;(o=r[i])instanceof p.Texts2D&&u.drawTexts(e,o)}},u.createImageBase64=function(e){},u.createImage=function(e,t){var r=u.getRectF(e),i=document.createElement("canvas");i.width=r.getWidth()+1,i.height=r.getHeigh()+1,document.body.appendChild(i);var n=i.getContext("2d");if(u.drawShapes(n,e),"function"==typeof i.toBlob)i.toBlob(function(e){t(e)});else{var o=i.toDataURL();t(o)}document.body.removeChild(i)},u}();p.DrawingUtility=e}(M3D||(M3D={})),function(t){var e=function(){function e(){this.color=t.Color.RED().Clone()}return e.prototype.setColor=function(e){this.color=e.Clone()},e.prototype.getColor=function(){return this.color},e}();t.Shape2D=e}(M3D||(M3D={})),function(r){var e=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.start=new r.Vector2,e.end=new r.Vector2,e.isFill=!0,e.strokeWidth=2,e}return __extends(e,t),e.prototype.getStart=function(){return this.start},e.prototype.setStart=function(e){this.start=e},e.prototype.getEnd=function(){return this.end},e.prototype.setEnd=function(e){this.end=e},e.prototype.toString=function(){return null},e.prototype.getWidth=function(){return Math.abs(this.getEnd().x-this.getStart().x)},e.prototype.getHeigh=function(){return Math.abs(this.getEnd().y-this.getStart().y)},e.prototype.GetIsFill=function(){return this.isFill},e.prototype.setIsFill=function(e){this.isFill=e},e.prototype.getStrokeWidth=function(){return this.strokeWidth},e.prototype.setStrokeWidth=function(e){this.strokeWidth=e},e}(r.Shape2D);r.Ellipse2D=e}(M3D||(M3D={})),function(r){var e=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.start=new r.Vector2,e.end=new r.Vector2,e.lineType=1,e.blod=1,e}return __extends(e,t),e.prototype.getStart=function(){return this.start},e.prototype.setStart=function(e){this.start=e},e.prototype.getEnd=function(){return this.end},e.prototype.setEnd=function(e){this.end=e},e.prototype.getLineType=function(){return this.lineType},e.prototype.setLineType=function(e){this.lineType=e},e.prototype.getBlod=function(){return this.blod},e.prototype.setBlod=function(e){this.blod=e},e.prototype.toString=function(){return null},e}(r.Shape2D);r.Line2D=e}(M3D||(M3D={})),function(r){var e=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.start=new r.Vector2,e.end=new r.Vector2,e.style=-1,e.radius=new r.Vector2,e.stroke=!1,e.round=!1,e.strokeWidth=2,e}return __extends(e,t),e.prototype.getStart=function(){return this.start},e.prototype.setStart=function(e){this.start=e},e.prototype.getEnd=function(){return this.end},e.prototype.setEnd=function(e){this.end=e},e.prototype.getStyle=function(){return this.style},e.prototype.setStyle=function(e){this.style=e},e.prototype.getWidth=function(){return Math.abs(this.getEnd().x-this.getStart().x)},e.prototype.getHeigh=function(){return Math.abs(this.getEnd().y-this.getStart().y)},e.prototype.getRadius=function(){return this.radius},e.prototype.setRadius=function(e){this.radius=e},e.prototype.isStroke=function(){return this.stroke},e.prototype.setStroke=function(e){this.stroke=e},e.prototype.isRound=function(){return this.round},e.prototype.setRound=function(e){this.round=e},e.prototype.getStrokeWidth=function(){return this.strokeWidth},e.prototype.setStrokeWidth=function(e){this.strokeWidth=e},e}(r.Shape2D);r.Rect2D=e}(M3D||(M3D={})),function(e){var t=function(){function e(){this.shape2ds=[]}return e.prototype.addShape=function(e){var t=!1;return null!==e&&-1===this.shape2ds.indexOf(e)&&(this.shape2ds.push(e),t=!0),t},e.prototype.getShapes=function(){return this.shape2ds},e.prototype.setShapes=function(e){this.shape2ds=e},e}();e.Shape2DSet=t}(M3D||(M3D={})),function(r){var e=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.start=new r.Vector2,e.texts="",e.fontName="微软雅黑",e.size=15,e.alignCenter=!1,e}return __extends(e,t),e.prototype.getStart=function(){return this.start},e.prototype.setStart=function(e){this.start=e},e.prototype.getTexts=function(){return this.texts},e.prototype.setTexts=function(e){this.texts=e},e.prototype.getFontName=function(){return this.fontName},e.prototype.setFontName=function(e){this.fontName=e},e.prototype.getSize=function(){return this.size},e.prototype.setSize=function(e){this.size=e},e.prototype.toString=function(){return null},e.prototype.isAlignCenter=function(){return this.alignCenter},e.prototype.setAlignCenter=function(e){this.alignCenter=e},e}(r.Shape2D);r.Texts2D=e}(M3D||(M3D={})),function(d){var n,e;(e=n=d.TextShapeTypeEnum||(d.TextShapeTypeEnum={}))[e.Geometry=0]="Geometry",e[e.lines=1]="lines",e[e.triangle2D=2]="triangle2D";var t=function(i){function e(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=i.call(this)||this;return r.CTextList=[],r.posFloats=[],r.m_VertexSet=new d.VertexSet,r.m_Meshdata=new d.Mesh(r.m_VertexSet),r.isDirty=!0,r.textType=n.triangle2D,r.textMeshFillStateArray=[],r.Visible=!1,r}return __extends(e,i),e.prototype.AddCText=function(e){this.CTextList.push(e),this.textMeshFillStateArray.push(!1)},e.prototype.GetCText=function(e){return this.CTextList[e]},e.prototype.GetCTextList=function(){return this.CTextList},e.prototype.GetTextType=function(){return this.textType},e.prototype.SetTextType=function(e){this.textType=e},e.prototype.GetMesh=function(){return this.m_Meshdata},e.prototype.ComputeBox=function(){this.GetMesh()&&this.SetBox(this.GetMesh().GetBoundingBox())},e.prototype.clearMesh=function(){this.m_VertexSet=new d.VertexSet,this.m_Meshdata=new d.Mesh(this.m_VertexSet),this.posFloats=[];for(var e=0;e<this.textMeshFillStateArray.length;e++)this.textMeshFillStateArray[e]=!1},e.prototype.beginUpdateMesh=function(){this.Visible=!1},e.prototype.endUpdateMesh=function(){for(var e=!0,t=0;t<this.textMeshFillStateArray.length;t++)if(!this.textMeshFillStateArray[t]){e=!1;break}e&&(this.m_VertexSet.SetPositionArray(new Float32Array(this.posFloats)),this.m_VertexSet.SetUseIndex(!1),this.m_Meshdata.SetDataLength(this.posFloats.length),this.m_Meshdata.SetDataOffset(0),this.Visible=!0)},e.prototype.setTextMeshById=function(e,t){if(this.beginUpdateMesh(),null!=t.vertexs){var r,i=this.CTextList[e];i.GetCharWidthHeight()[0]/1,r=i.GetCharWidthHeight()[1]/1;var n,o=i.GetInnerLoc();n=i.GetInnerXYAxis()[0],i.GetInnerXYAxis()[1];new d.Vector3(0,0,1);var a=new d.Quaternion(new d.Vector3(1,0,0),n),s=new d.Matrix3x4(o,a,new d.Vector3(r,r,1));if(null!=t.indexes)for(var l=t.indexes,h=t.vertexs,u=0;u<l.length;u++){var p=new d.Vector3(h[3*l[u]],h[3*l[u]+1],h[3*l[u]+2]),c=s.Multiply(p);this.posFloats.push(c.x),this.posFloats.push(c.y),this.posFloats.push(c.z)}else for(c=void 0,h=t.vertexs,u=0;u<h.length/3;++u){p=new d.Vector3(h[3*u],h[3*u+1],h[3*u+2]);c=s.Multiply(p),this.posFloats.push(c.x),this.posFloats.push(c.y),this.posFloats.push(c.z)}}this.textMeshFillStateArray[e]=!0,this.endUpdateMesh()},e.option={useLocalFont:!1,pmiServer:"http://localhost:8070/"},e}(d.Shape);d.ComText=t}(M3D||(M3D={})),function(t){var e=function(){function e(){this.Text="",this.m_LanguageType="",this.pntInnerLoc=new t.Vector3,this.fCharSize=[5,5],this.dirAxis=[new t.Vector3,new t.Vector3]}return e.prototype.GetInnerLoc=function(){return this.pntInnerLoc},e.prototype.SetInnerLoc=function(e){this.pntInnerLoc=e},e.prototype.GetText=function(){return this.Text},e.prototype.SetText=function(e){this.Text=e},e.prototype.GetInnerXYAxis=function(){return this.dirAxis},e.prototype.SetInnerXYAxis=function(e,t){this.dirAxis[0]=e.Clone(),this.dirAxis[1]=t.Clone()},e.prototype.GetCharWidthHeight=function(){return this.fCharSize},e.prototype.SetCharWidthHeight=function(e,t){this.fCharSize[0]=e,this.fCharSize[1]=t},e.prototype.SetLanguageType=function(e){this.m_LanguageType=e},e.prototype.GetLanguageType=function(){return this.m_LanguageType},e}();t.CText=e}(M3D||(M3D={})),function(a){var e=function(t){function e(){var e=t.call(this)||this;return e.m_geoAttribute=null,e.m_fWidth=0,e.m_svlId=0,e.m_lineType=0,e.m_bShowPoint=!0,e.SetType(a.ShapeType.CURVE_UNKNOWN),e}return __extends(e,t),e.prototype.GetGeoAttribute=function(){return this.m_geoAttribute},e.prototype.SetGeoAttribute=function(e){this.m_geoAttribute=e},e.prototype.SetWidth=function(e){this.m_fWidth=e},e.prototype.GetWidth=function(){return this.m_fWidth},e.prototype.GetSVLId=function(){return this.m_svlId},e.prototype.UpdateSelectPoint=function(e){},e.prototype.SetShowPoint=function(e){this.m_bShowPoint=e},e.prototype.IsShowPoint=function(){return this.m_bShowPoint},e.prototype.SetLineStyle=function(e){this.m_lineType=e},e.prototype.GetLineStyle=function(){return this.m_lineType},e}(a.Shape),t=function(e){function t(){return e.call(this)||this}return __extends(t,e),t}(a.Curve=e),r=function(t){function e(){var e=t.call(this)||this;return e.m_fUMin=0,e.m_fUMax=0,e.m_pntPoints=[],e}return __extends(e,t),e.prototype.GetType=function(){return a.ShapeType.CURVE_POLYLINE},e.prototype.AddPoint=function(e){this.m_pntPoints.push(e)},e.prototype.AddPoints=function(e){this.m_pntPoints.push(e),this.BoundingBox.Clear()},e.prototype.SetPoints=function(e){this.m_pntPoints=e},e.prototype.ClearPolyLinePoint=function(){this.m_pntPoints.length=0,this.BoundingBox.Clear()},e.prototype.SetDomain=function(e,t){this.m_fUMin=e,this.m_fUMax=t},e.prototype.GetDomain=function(){},e.prototype.GetPoints=function(){return this.m_pntPoints},e.prototype.RayPick=function(e){if(e.CanPickShape(this.GetType())&&this.IsVisible()&&this.GetSelectAble()){for(var t=new a.Vector3,r=this.GetPoints(),i=0;i<r.length-1;i++){if(e.Intersect(r[i])){e.AddIntersectPnt(r[i]),this.m_intersectPnt=r[i];break}if(e.Intersect(r[i+1])){e.AddIntersectPnt(r[i+1]),this.m_intersectPnt=r[i];break}e.Intersect(r[i],r[i+1],t)&&(e.AddIntersectPnt(t),this.m_intersectPnt=t)}e.AddShape(this)}},e.prototype.GetSelectIndex=function(){return this.m_nSelectIndex},e}(a.IPolyLine=t);a.SPolyLine=r;var i=function(t){function e(){var e=t.call(this)||this;return e.m_fUMin=0,e.m_fUMax=0,e.m_curvePntList=[],e.m_vcPoints=[],e.SetType(a.ShapeType.CURVE_NURBSCURVE),e}return __extends(e,t),e.prototype.RayPick=function(e){if(e.CanPickShape(this.GetType())&&this.IsVisible()&&this.GetSelectAble()){for(var t=0;t<this.m_vcPoints.length;t++)if(e.Intersect(this.m_vcPoints[t]))return e.AddIntersectPnt(this.m_vcPoints[t]),this.m_intersectPnt=this.m_vcPoints[t],void e.AddShape(this);var r=new a.Vector3,i=this.m_curvePntList.length;for(t=0;t<i-1;t++)if(e.Intersect(this.m_curvePntList[t],this.m_curvePntList[t+1],r)){e.AddIntersectPnt(r);break}e.AddShape(this)}},e.prototype.GetDomain=function(){},e.prototype.SetDomain=function(e,t){this.m_fUMin=e,this.m_fUMax=t},e.prototype.AddPoint=function(e){this.m_vcPoints.push(e),this.BoundingBox.Clear()},e.prototype.ClearCurveControlPoint=function(){this.m_vcPoints.length=0},e.prototype.GetPoints=function(){return this.m_vcPoints},e.prototype.GetCurvePointList=function(){return this.m_curvePntList},e.prototype.AddCurvePoint=function(e){this.m_curvePntList.push(e)},e.prototype.GetSelectIndex=function(){return this.m_nSelectIndex},e.prototype.ClearCurveLinePoint=function(){this.m_curvePntList.length=0},e}(t);a.NurbsCurve=i;var n=function(r){function e(e){var t=r.call(this)||this;return t.m_refLine=e,t.m_dataOffset=0,t.m_dataLength=0,t}return __extends(e,r),e.prototype.GetType=function(){return a.ShapeType.CURVE_REF_POLYLINE},e.prototype.GetEndPnt=function(){if(this.m_refLine){var e=this.GetRefLine().GetPoints();e.length>this.m_dataOffset+this.m_dataLength&&e[this.m_dataOffset+this.m_dataLength]}},e.prototype.GetStartPnt=function(){var e;if(this.m_refLine){var t=this.GetRefLine().GetPoints();t.length>this.m_dataOffset&&(e=t[this.m_dataOffset])}return e},e.prototype.GetDataOffset=function(){return this.m_dataOffset},e.prototype.SetDataOffset=function(e){this.m_dataOffset=e},e.prototype.GetDataLength=function(){return this.m_dataLength},e.prototype.SetDataLength=function(e){this.m_dataLength=e},e.prototype.ComputeBox=function(){this.BoundingBox.Clear();for(var e=this.GetRefLine().GetPoints(),t=this.m_dataLength/2+1,r=0;r<t-1;r++)this.BoundingBox.Merge(e[2*r]),this.BoundingBox.Merge(e[2*r+1])},e.prototype.RayPick=function(e){for(var t=this.GetRefLine().GetPoints(),r=new a.Vector3,i=this.m_dataLength/2+1,n=0;n<i-1;n++)if(e.Intersect(t[2*n+this.m_dataOffset],t[2*n+1+this.m_dataOffset],r)){var o=new a.Vector3;o.copyFrom(r),e.AddIntersectPnt(o)}},e.prototype.GetRefLine=function(){return this.m_refLine},e}(t);a.RefPolyLine=n}(M3D||(M3D={})),function(n){var e=function(i){function e(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=i.call(this)||this;return r.length=0,r.vertexPos=0,r.hardWareIndexBuffer=null,r.hardwareVertexBuffer=null,r.isNeedUpdateEdge=!0,0===e.length?(r.SetInitColor(n.Color.EdgeDefaultColor().Clone()),r.SetType(n.ShapeType.SHAPE_EDGE)):r.AssignOperator(e[0]),r.m_svlId=-1,r}return __extends(e,i),e.prototype.SetRenderWorldMatrix=function(e){this.renderWorldMatrix=e.Clone()},e.prototype.GetRenderWorldMatrix=function(){return this.renderWorldMatrix},e.prototype.GetRenderMaterial=function(){return new n.Material},e.prototype.SetRenderMesh=function(e){},e.prototype.GetDataLength=function(){return this.length},e.prototype.IsUseIndex=function(){return!1},e.prototype.SetIndexOffset=function(e){},e.prototype.GetIndexOffset=function(){return-1},e.prototype.SetNormalOffset=function(e){},e.prototype.GetNormalOffset=function(){return-1},e.prototype.SetVertexOffset=function(e){},e.prototype.GetVertexOffset=function(){return-1},e.prototype.SetTextureCoordsOffset=function(e){},e.prototype.GetTextureCoordsOffset=function(){return-1},e.prototype.SetCentersCoordsOffset=function(e){},e.prototype.GetCentersCoordsOffset=function(){return-1},e.prototype.GetHardWareVertexBuffer=function(){return this.hardwareVertexBuffer},e.prototype.GetHardWareIndexBuffer=function(){return this.hardWareIndexBuffer},e.prototype.UpdateHardWareBuffer=function(e){},e.prototype.AddData=function(e,t){switch(t){case 0:this.m_lineSet=e}},e.prototype.ComputeBox=function(){this.BoundingBox.Clear(),this.m_lineSet&&this.SetBox(this.m_lineSet.GetBoundingBox())},e.prototype.GetLineData=function(){return this.m_lineSet},e.prototype.RayPick=function(e){if(this.IsVisible()&&e.CanPickShape(this.GetType())&&this.m_lineSet){var t=this.m_lineSet.GetGeoAttribute();if(null!=t){if(!e.CanPickGeo(t.GetGeoAttrType()))return}else if(!e.CanPickGeo(n.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_UNKNOWN))return;this.m_lineSet.RayPick(e),e.AddShape(this)}},e.prototype.GetGeoInfo=function(){this.m_lineSet.GetGeoAttribute()},e.prototype.GetSVLId=function(){return this.m_svlId},e.prototype.SetSVLId=function(e){this.m_svlId=e},e.prototype.GetGeoAttribute=function(){if(this.m_lineSet){var e=void 0;return this.GetSVLId()&&(this.GetBody()&&this.GetBody().GetModel()&&(e=this.GetBody().GetModel().GetExtendInfoManager().GetEdgeGeoAttribute(this.GetBody().GetModel().GetProtoTypeId(),this.GetSVLId())),this.m_lineSet.SetGeoAttribute(e)),e}return null},e.prototype.GetRenderColor=function(){return this.GetDrawColor()},e.prototype.InitProperties=function(){this.AddProperty("ID",String(this.Id));var e=String(this.Color.r)+","+String(this.Color.g)+","+String(this.Color.b)+","+String(this.Color.a);this.AddProperty("Color",e)},e.prototype.SetFace=function(e){this.face=e},e.prototype.GetFace=function(){return this.face},e.prototype.SetBody=function(e){this.body=e},e.prototype.GetBody=function(){return this.body},e.prototype.AssignOperator=function(e){this!==e&&(i.prototype.AssignOperator.call(this,e),this.SetColor(n.Color.EdgeDefaultColor().Clone()),this.m_lineSet=e.GetLineData(),this.m_svlId=e.m_svlId)},e.prototype.SetRenderPolyLine=function(e){var t=e.GetLineData(),r=(t.GetRefLine(),t.GetDataOffset());this.vertexPos=3*r*4,this.length=t.GetDataLength()},e.prototype.MergeRenderPolyLine=function(e){var t=e.GetLineData();this.length+=t.GetDataLength()},e}(n.Shape);n.Edge=e}(M3D||(M3D={})),function(i){var e=function(){function e(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this.pmiMap=new i.Map,this.modelPmiRefs=new i.Map,this.userViewMap={},this.sectionPlaneMap={},this.allMeshEdgeAttr={},this.allMeshFaceAttr={},this.allModelFileAttr={},this.allInstanceAttr={}}return e.prototype.AddModelPMIRef=function(e,t){this.modelPmiRefs[e]=t},e.prototype.GetModelPMIRef=function(e){return this.modelPmiRefs[e]},e.prototype.SetPMIs=function(e){this.pmiMap=e},e.prototype.SetModelPMIRefs=function(e){this.modelPmiRefs=e},e.prototype.AddModelView=function(e,t){this.userViewMap[e]=t},e.prototype.GetModelView=function(e){return this.userViewMap[e]},e.prototype.AddModelSectionPlane=function(e,t){this.sectionPlaneMap[e]=t},e.prototype.GetModelSectionPlane=function(e){return this.sectionPlaneMap[e]},e.prototype.GetScene=function(){return this.m_scene},e.prototype.SetScene=function(e){this.m_scene=e},e.prototype.RayPick=function(e){for(var t=0,r=this.pmiMap.Keys();t<r.length;t++){var i=r[t],n=this.pmiMap.Get(i);n&&n.IsVisible()&&n.RayPick(e)}},e.prototype.FindVisiableObject=function(e){if(null!=e){e.GetRenderEffect().GetRenderableTypeFilter();e.PrepareRenderPMIS(this.pmiMap)}},e.prototype.Clear=function(e){delete this.pmiMap[e],delete this.userViewMap[e],delete this.sectionPlaneMap[e]},e.prototype.GetFaceGeoAttribute=function(e,t){if(0<t){var r=this.GetMeshFaceAllAttribute(e,t);return 0<Object.getOwnPropertyNames(r).length?i.SvlxReader.GetGeometryAttributeFromStk(r):null}return null},e.prototype.GetModelFileAttribute=function(e){return 0<e?this.allModelFileAttr[e]:null},e.prototype.GetEdgeGeoAttribute=function(e,t){if(0<t){var r=this.GetMeshEdgeAllAttribute(e,t);return 0<Object.getOwnPropertyNames(r).length?i.SvlxReader.GetGeometryAttributeFromStk(r):null}return null},e.prototype.GetMeshFaceAllAttribute=function(e,t){var r={};if(0<Object.getOwnPropertyNames(this.allMeshFaceAttr).length){var i=this.allMeshFaceAttr[e];if(i){var n=i[t];return n||r}return r}return r},e.prototype.GetMeshEdgeAllAttribute=function(e,t){var r={};if(0<Object.getOwnPropertyNames(this.allMeshEdgeAttr).length){var i=this.allMeshEdgeAttr[e];if(i){var n=i[t];return n||r}return r}return r},e.prototype.SetAllMeshFaceAttr=function(e){this.allMeshFaceAttr=e},e.prototype.SetAllMeshEdgeAttr=function(e){this.allMeshEdgeAttr=e},e.prototype.SetAllModelFileAttr=function(e){this.allModelFileAttr=e},e.prototype.GetInstanceAttr=function(e,t){void 0===t&&(t="");var r=this.allInstanceAttr[e];return r?""==t?r:r[t]:{}},e.prototype.SetAllInstanceAttr=function(e){this.allInstanceAttr=e},e}();i.ExtendInfoManager=e}(M3D||(M3D={})),function(r){var e=function(){function e(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];3==e.length?(this._center=e[0].Clone(),this._radius=e[1],this._height=e[2]):(this._center=new r.Vector3(0,0,0),this._radius=1,this._height=1),this._rotation=new r.Quaternion}return e.prototype.ZeroRotation=function(){return this._rotation.IsZero()},e.prototype.ComputeRotationMatrix=function(){return this._rotation.RotationMatrix()},e.prototype.GetRotation=function(){return this._rotation},e.prototype.SetRotation=function(e){this._rotation=e.Clone()},e.prototype.GetHeight=function(){return this._height},e.prototype.SetHeight=function(e){this._height=e},e.prototype.GetRadius=function(){return this._radius},e.prototype.SetRadius=function(e){this._radius=e},e.prototype.GetCenter=function(){return this._center},e.prototype.SetCenter=function(e){this._center=e.Clone()},e.prototype.Set=function(e,t,r){this._center=e.Clone(),this._radius=t,this._height=r},e.prototype.Valid=function(){return 0<=this._radius},e}();r.Cylinder=e}(M3D||(M3D={})),function(n){var e=function(i){function e(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=i.call(this)||this;return r.StartPoint=new n.Vector3,r.EndPoint=new n.Vector3,r.CanDelete=!1,r.lineWidth=4,r.StartArrowBufferArray=[],r.EndArrowBufferArray=[],0===e.length?r.InitLine3D():2===e.length&&e[0]instanceof n.Vector3&&e[1]instanceof n.Vector3&&(r.InitLine3D(),r.SetValue(e[0],e[1])),r}return __extends(e,i),e.prototype.InitLine3D=function(){this.StartArrowType=-1,this.EndArrowType=-1;var e=n.Color.GRAY().Clone();this.SetColor(e),this.lineWidth=4},e.prototype.SetValue=function(e,t){this.StartPoint=e.Clone(),this.EndPoint=t.Clone()},e.prototype.ComputeBox=function(){this.BoundingBox.Merge(this.StartPoint),this.BoundingBox.Merge(this.EndPoint)},e.prototype.GetStartArrow=function(){return this.StartArrowType},e.prototype.GetEndArrow=function(){return this.EndArrowType},e.prototype.SetStartArrow=function(e){this.StartArrowType=e,this.CreateArrowBuffer(this.StartArrowType,this.StartPoint,this.StartPoint.Sub(this.EndPoint),2,2,this.StartArrowBufferArray)},e.prototype.SetEndArrow=function(e){this.EndArrowType=e,this.CreateArrowBuffer(this.EndArrowType,this.EndPoint,this.EndPoint.Sub(this.StartPoint),2,2,this.EndArrowBufferArray)},e.prototype.CreateArrowBuffer=function(e,t,r,i,n,o){},e.prototype.GetStartArrowBuffer=function(){return this.StartArrowBufferArray},e.prototype.GetEndArrowBuffer=function(){return this.EndArrowBufferArray},e.prototype.SetLineWidth=function(e){this.lineWidth=e},e.prototype.GetLineWidth=function(){return this.lineWidth},e.prototype.GetPosition=function(){return this.StartPoint},e.prototype.GetEndPoint=function(){return this.EndPoint},e.prototype.SetCanDelete=function(e){this.CanDelete=e},e.prototype.GetCanDelete=function(){return this.CanDelete},e.prototype.GetClosestPoint=function(e){return this.StartPoint.Add(this.GetDirection().Multiply(e.Sub(this.StartPoint).DotProduct(this.GetDirection())))},e.prototype.GetDirection=function(){var e=this.EndPoint.Sub(this.StartPoint);return e.Normalize(),e},e.prototype.SetStartPoint=function(e){this.StartPoint=e,this.BoundingBox.Clear()},e.prototype.GetStartPoint=function(){return this.StartPoint},e.prototype.SetEndPoint=function(e){this.EndPoint=e,this.BoundingBox.Clear()},e.prototype.SetLineStyle=function(e){this.style=e},e.prototype.GetLineStyle=function(){return this.style},e.prototype.GetSVLId=function(){return this.m_svlId},e.prototype.SetShowPoint=function(e){this.m_bShowPoint=e},e.prototype.IsShowPoint=function(){return this.m_bShowPoint},e.prototype.RayPick=function(e){if(e.CanPickShape(this.GetType())&&this.IsVisible()&&this.GetSelectAble()){this.m_selectPntSign=-1,e.Intersect(this.StartPoint)&&(this.m_selectPntSign=0,e.AddIntersectPnt(this.StartPoint)),e.Intersect(this.EndPoint)&&(this.m_selectPntSign=1,e.AddIntersectPnt(this.EndPoint));var t=new n.Vector3;e.Intersect(this.StartPoint,this.EndPoint,t)&&e.AddIntersectPnt(t),e.AddShape(this)}},e}(n.Shape);n.Line3D=e}(M3D||(M3D={})),function(i){var e=function(){function e(){this.m_worldBox=new i.BoundingBox,this.m_BoundingBox=new i.BoundingBox,this.m_drawDataPrepared=!0,this.m_SelectAble=!0,this.m_bodys=new Array,this.SetModel(null),this.SetOctant(null),this.SetOctree(null),this.SetOCTreeUpdated(!1),this.SetDrawDataPrepared(!0),this.MarkDirty()}return e.prototype.SetModel=function(e){this.m_parentModel=e},e.prototype.SetOctant=function(e){this.m_octant=e},e.prototype.GetOctant=function(){return this.m_octant},e.prototype.SetOctree=function(e){this.m_octree=e},e.prototype.GetOctree=function(){return this.m_octree},e.prototype.isOCtreeUpdated=function(){return this.m_updateQueued},e.prototype.SetOCTreeUpdated=function(e){this.m_updateQueued=e},e.prototype.IsDrawDataPrepared=function(){return this.m_drawDataPrepared},e.prototype.SetDrawDataPrepared=function(e){e&&this.MarkDirty(),this.m_drawDataPrepared=e},e.prototype.MarkDirty=function(){this.m_dirty=!0,this.m_worldBox.Clear()},e.prototype.SetBodys=function(e){this.m_bodys=e},e.prototype.GetBodys=function(){return this.m_bodys},e.prototype.GetColor=function(){return this.m_drawDataPrepared&&0<this.m_bodys.length?this.m_bodys[0].GetColor():null},e.prototype.SetColor=function(e){if(this.m_drawDataPrepared)for(var t=0;t<this.m_bodys.length;t++)this.m_bodys[t].SetColor(e)},e.prototype.ResetAlpha=function(){if(this.m_drawDataPrepared)for(var e=0;e<this.m_bodys.length;e++)this.m_bodys[e].ResetAlpha()},e.prototype.Restore=function(){if(this.m_drawDataPrepared){this.MarkDirty();for(var e=0;e<this.m_bodys.length;e++)this.m_bodys[e].Restore()}},e.prototype.GetVolumeAndArea=function(){var e=0,t=0;if(this.m_drawDataPrepared)for(var r=0;r<this.m_bodys.length;r++){var i=this.m_bodys[r].GetVolumeAndArea();return[e+=i[0],t+=i[1]]}return[0,0]},e.prototype.ResetColor=function(){if(this.m_drawDataPrepared)for(var e=0;e<this.m_bodys.length;e++)this.m_bodys[e].ResetColor()},e.prototype.SetInitColor=function(e){if(this.m_drawDataPrepared)for(var t=0;t<this.m_bodys.length;t++)this.m_bodys[t].SetInitColor(e)},e.prototype.IsHightlight=function(){return!1},e.prototype.SetInitHightlight=function(e){if(this.m_drawDataPrepared)for(var t=0;t<this.m_bodys.length;t++)this.m_bodys[t].SetInitHightlight(e)},e.prototype.SetInitAlpha=function(e){if(this.m_drawDataPrepared)for(var t=0;t<this.m_bodys.length;t++)this.m_bodys[t].SetInitAlpha(e)},e.prototype.ComputeBox=function(){if(this.IsDrawDataPrepared()){this.m_BoundingBox.Clear();for(var e=0;e<this.m_bodys.length;e++)for(var t=this.m_bodys[e].GetFaces(),r=0;r<t.length;r++)this.m_BoundingBox.Merge(t[r].GetBoundingBox())}},e.prototype.GetVertexCount=function(e){if(this.m_drawDataPrepared){for(var t=0,r=0;r<this.m_bodys.length;r++)t+=this.m_bodys[r].GetVertexCount(e);return t}return 0},e.prototype.SetVisible=function(e){if(this.m_drawDataPrepared)for(var t=0;t<this.m_bodys.length;t++)this.m_bodys[t].SetVisible(e)},e.prototype.IsVisible=function(){return!this.m_parentModel||this.m_parentModel.IsVisible()},e.prototype.SetSelected=function(e){if(this.m_drawDataPrepared)for(var t=0;t<this.m_bodys.length;t++){var r=this.m_bodys[t];null!=r&&r.SetSelected(e)}},e.prototype.SetSelectAble=function(e){this.m_SelectAble=e;for(var t=0;t<this.m_bodys.length;t++)this.m_bodys[t]&&this.m_bodys[t].SetSelectAble(e)},e.prototype.SetAlpha=function(e){if(this.m_drawDataPrepared)for(var t=0;t<this.m_bodys.length;t++)this.m_bodys[t].SetAlpha(e)},e.prototype.AddBody=function(e){null!==e&&null!==this.m_parentModel&&(e.SetModel(this.m_parentModel),this.m_bodys.push(e))},e.prototype.GetType=function(){return i.ShapeType.MODEL_SHAPE},e.prototype.GetModel=function(){return this.m_parentModel},e.prototype.AssignOperator=function(e){if(this!==e){this.m_bodys=new Array,this.SetModel(null),this.SetOctant(null),this.SetOctree(null),this.SetOCTreeUpdated(!1),this.MarkDirty();for(var t=0;t<e.m_bodys.length;t++){var r=new i.Body(e.m_bodys[t]);this.AddBody(r)}}return this},e.prototype.CopyFrom=function(e){this.m_bodys=new Array,this.SetOCTreeUpdated(!1);for(var t=0;t<e.m_bodys.length;t++){var r=new i.Body(e.m_bodys[t]);this.AddBody(r)}return!0},e.prototype.FramePick=function(e){this.m_drawDataPrepared&&this.m_SelectAble&&e.FrustumIntersetWithWorldBox(this.GetWorldBoundingBox())&&e.AddToFramePickCollection(this.GetModel())},e.prototype.RayPick=function(e){if(this.m_drawDataPrepared&&this.m_SelectAble&&0<this.m_bodys.length&&e.GetData().GetCameraRay().HitDistance(this.GetWorldBoundingBox())!=i.INFINITY){e.UpdataModelRay(this.GetWorldTransform());for(var t=0;t<this.m_bodys.length;t++)this.m_bodys[t].RayPick(e)}},e.prototype.GetWorldBoundingBox=function(){return this.m_worldBox.Defined()||(this.m_worldBox=this.GetBoundingBox(),this.m_worldBox.Defined()&&this.m_worldBox.Transform(this.GetWorldTransform())),this.m_worldBox},e.prototype.SetBoundingBox=function(e){this.m_BoundingBox=e},e.prototype.GetBoundingBox=function(){return this.ComputeBox(),this.m_BoundingBox},e.prototype.FindVisiableObject=function(e){if(this.m_drawDataPrepared){e.GetCullerHelper().InViewPort(this.GetWorldBoundingBox(),e.GetCamera());e.SetWorldMatrix(this.GetWorldTransform()),e.SetGLWorldMatrix(this.GetGLWorldTransform());for(var t=0;t<this.m_bodys.length;t++)this.m_bodys[t].FindVisiableObject(e)}},e.prototype.FindVisiableObjectFast=function(e,t){if(this.m_drawDataPrepared&&e.GetCullerHelper().InViewPort(this.GetWorldBoundingBox(),e.GetCamera())!==i.OUTSIDE)if(e.SetWorldMatrix(this.GetWorldTransform()),e.SetGLWorldMatrix(this.GetGLWorldTransform()),0===t){if(this.m_bodys)for(var r=0;r<this.m_bodys.length;r++)this.m_bodys[r].FindVisiableObject(e)}else if(1===t){if(e.SetDelayDraw(!0),this.m_bodys)for(r=0;r<this.m_bodys.length;r++)this.m_bodys[r].FindVisiableObject(e);e.SetDelayDraw(!1)}},e.prototype.IsDirty=function(){return this.m_dirty},e.prototype.Clear=function(){if(this.m_drawDataPrepared){for(var e=0;e<this.m_bodys.length;e++);this.m_bodys=new Array}},e.prototype.GetWorldTransform=function(){return this.IsDirty()&&this.UpdateWorldTransform(),this.m_worldMatrix},e.prototype.GetGLWorldTransform=function(){return this.GetWorldTransform(),this.m_glRenderMatrix},e.prototype.UpdateWorldTransform=function(){this.m_dirty=!1;var e=new i.Matrix3x4;null==this.m_parentModel?this.m_worldMatrix=e:this.m_worldMatrix=this.m_parentModel.GetWorldTransform().Multiply(e).ToMatrix3x4(),this.m_glRenderMatrix=this.m_worldMatrix.ToMatrix4().Transpose(),this.UpdateOCTree()},e.prototype.SetWorldMatrix=function(e){this.m_worldMatrix=this.m_parentModel.GetWorldTransform().ToMatrix3x4().Multiply(e),this.m_glRenderMatrix=this.m_worldMatrix.ToMatrix4().Transpose(),this.m_worldBox.Clear(),this.UpdateOCTree()},e.prototype.UpdateOCTree=function(){this.SetOCTreeUpdated(!1),null!==this.m_octree&&this.m_octree.QueueUpdate(this)},e}(),t=function(t){function e(){var e=t.call(this)||this;return e.m_image=null,e.m_imageBoard=null,e}return __extends(e,t),e.prototype.FindVisiableObject=function(e){if(this.IsVisible()&&(e.SetWorldMatrix(this.GetWorldTransform()),e.SetGLWorldMatrix(this.GetGLWorldTransform()),this.m_image&&this.m_imageBoard)){if(!this.m_imageBoard.GetTexture()&&this.m_image){var t=e.GetScene().GetResourceManager().GetOrCreateTexture(this.m_image.GetImagePath(),i.Texture.TEXTURE_2D);t.AddImage(this.m_image),this.m_imageBoard.SetTexture(t)}this.m_imageBoard.UpdateRenderData(e),e.PrepareRenderImage(this.m_imageBoard)}},e.prototype.RayPick=function(e){if(this.m_drawDataPrepared){new i.Vector3;if(this.m_imageBoard){e.UpdataModelRay(i.Matrix3x4.IDENTITY().Clone());var t=this.m_imageBoard.GetIntersects(e);if(0<t.length)for(var r=0;r<t.length;r++)e.AddIntersectPnt(t[r])}e.AddShape(this.GetModel())}},e.prototype.FramePick=function(e){this.m_drawDataPrepared&&e.FrustumIntersetWithWorldBox(this.GetWorldBoundingBox())&&e.AddToFramePickCollection(this.GetModel())},e.prototype.SetImagePath=function(e){this.CreateImage(),this.m_image.SetImageFromURL(e)},e.prototype.SetImage=function(e){this.CreateImage(),this.m_image=e},e.prototype.SetImageData=function(e,t){this.CreateImage(),this.m_image.SetImageFromURL(e)},e.prototype.SetImageGPUID=function(e){if(this.CreateImage(),!this.m_imageBoard.GetTexture()){var t=new i.Texture2DPackaging;this.m_imageBoard.SetTexture(t)}this.m_imageBoard.GetTexture()&&this.m_imageBoard.GetTexture().SetTexture2DID(e)},e.prototype.SetFlipImage=function(e){this.CreateImage(),this.m_imageBoard.SetFlipV(e)},e.prototype.AllowCuller=function(){return!1},e.prototype.GetImageBoard=function(){return this.m_imageBoard},e.prototype.SetImageSize=function(e,t){this.m_imageBoard&&this.m_imageBoard.SetOrigSize(e,t)},e.prototype.SetImagePosition=function(e){this.m_imageBoard&&this.m_imageBoard.SetPosition(e)},e.prototype.SetAllowScall=function(e){this.m_imageBoard&&this.m_imageBoard.AllowScale(e)},e.prototype.SetAllowRotate=function(e){this.m_imageBoard&&this.m_imageBoard.AllowRotate(e)},e.prototype.SetAllowTran=function(e){this.m_imageBoard&&this.m_imageBoard.AllowTran(e)},e.prototype.SetFixShowInScreen=function(e){this.m_imageBoard&&(this.m_imageBoard.m_fixShowInScreen=e)},e.prototype.SetInTopShow=function(e){this.m_imageBoard&&this.m_imageBoard.SetInTop(e)},e.prototype.ComputeBox=function(){if(t.prototype.ComputeBox.call(this),this.m_imageBoard){this.m_imageBoard.GetVertexs();this.m_BoundingBox.Merge(this.m_imageBoard.GetBoundingBox())}},e.prototype.SetSelected=function(e){this.m_imageBoard&&this.m_imageBoard.SetSelected(e)},e.prototype.SetInitHightlight=function(e){this.m_imageBoard&&this.m_imageBoard.SetInitHightlight(e)},e.prototype.CreateImage=function(){null==this.m_image&&(this.m_image=new i.ImageM3D,this.m_imageBoard=new i.ImageBoard)},e}(i.ModelShape=e);i.ImageModelShape=t}(M3D||(M3D={})),function(S){var e=function(i){function o(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=i.call(this)||this;return r.IsParallelScreen=!1,r.m_outramLocation=new S.Vector3,r.OutFrameMatrix=S.Matrix4.IDENTITY(),r.m_DefPlaneDirty=!0,r.m_GLDefPlaneMatrix=S.Matrix4.IDENTITY(),r.m_WorldMatrix=S.Matrix3x4.IDENTITY(),r.DefPlane=S.Matrix3x4.IDENTITY(),r.PolyLines=[],r.ComTexts=[],r.renderWorldMatrix=S.Matrix4.IDENTITY(),e.length=1,r}return __extends(o,i),o.prototype.SetRenderWorldMatrix=function(e){this.renderWorldMatrix=e},o.prototype.GetRenderWorldMatrix=function(){return this.renderWorldMatrix},o.prototype.GetRenderColor=function(){return this.GetDrawColor()},o.prototype.GetDrawColor=function(){return i.prototype.GetDrawColor.call(this).Clone()},o.prototype.GetRenderMaterial=function(){return null},o.prototype.SetRenderMesh=function(e){},o.prototype.GetRenderMesh=function(){return null},o.prototype.GetDataLength=function(){return-1},o.prototype.IsUseIndex=function(){return!1},o.prototype.SetIndexOffset=function(e){},o.prototype.GetIndexOffset=function(){return-1},o.prototype.SetNormalOffset=function(e){},o.prototype.GetNormalOffset=function(){return-1},o.prototype.SetVertexOffset=function(e){},o.prototype.GetVertexOffset=function(){return-1},o.prototype.SetTextureCoordsOffset=function(e){},o.prototype.GetTextureCoordsOffset=function(){return-1},o.prototype.SetCentersCoordsOffset=function(e){},o.prototype.GetCentersCoordsOffset=function(){return-1},o.prototype.GetHardWareVertexBuffer=function(){return null},o.prototype.GetHardWareIndexBuffer=function(){return null},o.prototype.GetComTextsBox=function(){var e=new S.BoundingBox;if(0!=this.ComTexts.length)for(var t=0;t<this.ComTexts.length;t++){var r=this.ComTexts[t];r&&e.Merge(r.GetBoundingBox())}else e.max=new S.Vector3(1,1,1);return e},o.prototype.fromJson=function(e){this.Id=e.id,this.Name=e.name,this.Visible=e.visible;e.color.split(" ");if(this.Color=S.Color.BLUE(),this.IsParallelScreen=0!=(256&e.style),this.Type=e.type,this.DefPlane=new S.Matrix3x4,this.DefPlane.fromString(e.defPlane),this.Source=e.source,null!=e.exLines){var t=[];S.PMICreator.CreateExtensionLines(e.exLines,t),this.SetPolyLineArray(t)}if(e.outframes){var r=[],i=[];S.PMICreator.CreateOutFrame(e.outframes,r,i),this.SetPolyLineByIndex(r,i)}if(e.Anchors){r=[],i=[];S.PMICreator.CreateAnchorPoints(e.Anchors,r,i),this.SetPolyLineByIndex(r,i)}if(e){t=[];var n=S.StkTermTypeEnum.TERM_PATSMNONE;S.PMICreator.CreateEndSymbol(e,t,n),this.SetPolyLineArray(t)}if(e.comTexts)for(var o=0;o<e.comTexts.length;o++){var a=e.comTexts[o],s=this.ConvertStkComTextToComText(a);this.ComTexts.push(s)}var l=new S.STK_BOX32,h=this.GetComTextsBox();if(l.BoundBox[0][0]=h.min.x,l.BoundBox[0][1]=h.min.y,l.BoundBox[0][2]=h.min.z,l.BoundBox[1][0]=h.max.x,l.BoundBox[1][1]=h.max.y,l.BoundBox[1][2]=h.max.z,e.leaders){t=[];S.PMICreator.CreateLeader(e.leaders,l,t,this),this.SetPolyLineArray(t)}if(e.specialLines){r=[],i=[];S.PMICreator.CreateSpeciallLines(e.specialLines,r,i),this.SetPolyLineByIndex(r,i)}},o.prototype.SetPolyLineArray=function(e){for(var t=0,r=e;t<r.length;t++){var i=r[t];if(0<i.length){for(var n=new S.SPolyLine,o=0,a=i;o<a.length;o++){var s=a[o];n.AddPoint(s.Clone())}this.PolyLines.push(n)}}},o.prototype.SetPolyLineByIndex=function(e,t){for(var r=new S.SPolyLine,i=0;i<t.length;i++)-1!=t[i]||0==i?r.AddPoint(e[t[i]]):0<r.GetPoints().length&&(this.PolyLines.push(r),r=new S.SPolyLine);0<r.GetPoints().length&&this.PolyLines.push(r)},o.prototype.ConvertStkComTextToComText=function(e){var t=new S.ComText,r=new S.BoundingBox;r.fromString(e.outBox),t.SetBox(r);for(var i=e.texts,n=0;n<i.length;n++){var o=new S.CText,a=i[n],s=(a.charSpace,a.size.split(" "));o.SetCharWidthHeight(s[0],s[1]);var l=new S.Vector3;l.fromString(a.innerLoc),o.SetInnerLoc(l);var h=new S.BoundingBox;h.fromString(a.axis),o.SetInnerXYAxis(h.min,h.max);var u=a.content;o.SetText(u),t.AddCText(o)}return t},o.prototype.RayPick=function(e){if(this.GetParentModel()){e.BeginPickAsGroup(this),e.UpdataModelRay(this.m_WorldMatrix);for(var t=0;t<this.ComTexts.length;t++){var r=this.ComTexts[t].GetMesh();r&&r.RayPick(e)}e.UpdataIntersecPnts(this.m_WorldMatrix);var i=new S.Vector3;for(t=0;t<this.PolyLines.length;t++)for(var n=this.PolyLines[t].GetPoints(),o=1;o<n.length;o++)e.Intersect(n[o-1],n[o],i)&&(i=this.m_WorldMatrix.Multiply(i),e.AddIntersectPnt(i));e.UpdateGroupPickPnts(),e.EndPickAsGroup(this,0)}},o.prototype.FindVisiableObject=function(e){if(this.IsVisible()&&this.GetParentModel()&&this.GetParentModel().GetSceneNode()){var t=this.GetParentModel().GetSceneNode().GetWorldTransform();this.m_DefPlaneDirty&&(this.m_DefPlaneDirty=!1,this.m_WorldMatrix=t.Multiply(this.DefPlane),this.m_GLDefPlaneMatrix=this.m_WorldMatrix.ToMatrix4().Transpose(),this.SetRenderWorldMatrix(this.m_GLDefPlaneMatrix));var r=e.GetCamera(),i=S.Matrix3x4.IDENTITY();if(this.IsParallelScreen&&this.Type==o.PMI_FixScreen)(i=r.GetView().Multiply(t).Inverse()).MultiTranslate(new S.Vector3(-60,-40,-10)),i.MultiScale(.2);else if(this.IsParallelScreen&&this.Type!=o.PMI_FixScreen){i=r.GetView().Multiply(this.m_WorldMatrix).Inverse();var n=this.m_WorldMatrix.Multiply(this.m_outramLocation);i=this.GetWorldMatrix(i,e,n,!0,!1,!1),this.OutFrameMatrix=i.ToMatrix4().Transpose()}e.PushRenderable(this,S.RenderableType.RGT_PMI)}},o.prototype.MarkDefinePlaneDirty=function(){this.m_DefPlaneDirty=!0},o.prototype.SetParentModel=function(e){this.m_parentModel=e},o.prototype.GetParentModel=function(){return this.m_parentModel},o.prototype.GetWorldMatrix=function(e,t,r,i,n,o){var a=S.Matrix3x4.IDENTITY();if(a.MultiTranslate(r),!o){var s=this.GetComTextsBox().GetYLength(),l=new S.Vector2(.5/s,.5/s),h=(l=S.ShapeHelper.GetCommonSize(t.GetScene(),l)).y,u=t.GetCamera();if(!u.IsOrthographic()){var p=u.GetWorldPosition(),c=u.GetOrthoSize().y;h=2*p.Sub(r).Length()/c}a.MultiScale(h/u.GetZoom())}if(!n){var d=e.Rotation();a.MultiRotatiton(d)}return i||a.MultiTranslate(e.Translation().Nagative()),a.MultiTranslate(r.Nagative()),a},o.PMI_FixScreen=8e3,o}(S.Shape);S.PMI=e}(M3D||(M3D={})),function(a){var e=function(n){function o(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=n.call(this)||this;if(r.pointImage=null,r.meshboard=null,r.coordinate=new a.Vector3,r.body=null,r.drawType=0,r.size=-1,0===e.length){var i=new a.Vector3;r.InitPoint(i)}else 1===e.length&&(e[0]instanceof a.Vector3?r.InitPoint(e[0]):e[0]instanceof o&&r.AssignOperator(e[0]));return r}return __extends(o,n),o.prototype.SetRenderWorldMatrix=function(e){this.renderWorldMatrix=e.Clone()},o.prototype.GetRenderWorldMatrix=function(){return this.renderWorldMatrix},o.prototype.GetRenderColor=function(){return this.GetDrawColor()},o.prototype.GetRenderMaterial=function(){return new a.Material},o.prototype.SetRenderMesh=function(e){},o.prototype.GetDataLength=function(){return-1},o.prototype.IsUseIndex=function(){return!1},o.prototype.SetIndexOffset=function(e){},o.prototype.GetIndexOffset=function(){return-1},o.prototype.SetNormalOffset=function(e){},o.prototype.GetNormalOffset=function(){return-1},o.prototype.SetVertexOffset=function(e){},o.prototype.GetVertexOffset=function(){return-1},o.prototype.SetTextureCoordsOffset=function(e){},o.prototype.GetTextureCoordsOffset=function(){return-1},o.prototype.SetCentersCoordsOffset=function(e){},o.prototype.GetCentersCoordsOffset=function(){return-1},o.prototype.GetHardWareVertexBuffer=function(){return null},o.prototype.GetHardWareIndexBuffer=function(){return null},o.prototype.InitPoint=function(e){this.SetType(a.ShapeType.SHAPE_POINT),this.SetCoordinate(e),this.BoundingBox.Clear(),this.pointImage=null,this.meshboard=null,this.drawType=0,this.SetSize(.8)},o.prototype.AssignOperator=function(e){this!==e&&n.prototype.AssignOperator.call(this,e)},o.prototype.SetCoordinate=function(e){this.coordinate=e.Clone()},o.prototype.GetCoordinate=function(){return this.coordinate},o.prototype.ComputeBox=function(){if(this.BoundingBox.Clear(),!this.BoundingBox.Defined()){var e=new a.Vector3(this.coordinate.x+o.BOX_LENGTH,this.coordinate.y+o.BOX_LENGTH,this.coordinate.z+o.BOX_LENGTH),t=new a.Vector3(this.coordinate.x-o.BOX_LENGTH,this.coordinate.y-o.BOX_LENGTH,this.coordinate.z-o.BOX_LENGTH);this.BoundingBox=new a.BoundingBox(t,e)}},o.prototype.RayPick=function(e){this.IsVisible()&&e.CanPickShape(this.GetType())&&e.Intersect(this.GetCoordinate())&&(e.AddIntersectPnt(this.GetCoordinate()),e.AddShape(this))},o.prototype.FindVisiableObject=function(e){this.IsVisible()&&(this.UpdateRenderData(e),e.PreapareRenderPoint(this))},o.prototype.UpdateRenderData=function(e){this.SetRenderWorldMatrix(e.GetGLWorldMatrix());var t=this.drawType;if(1===t||2===t||3===t){if(!this.pointImage){var r=new a.Vector2(this.size,this.size);r=a.ShapeHelper.GetCommonSize(e.GetScene(),r),this.pointImage=new a.ImageBoard(this.GetCoordinate(),r),this.pointImage.m_fixShowInScreen=!0,this.pointImage.SetTexture(e.GetScene().GetResourceManager().getDefaultPointTexture(this.drawType)),this.pointImage.SetCurrentGLContext(e.GetScene().GetResourceManager().GetRenderContext())}this.pointImage.UpdateRenderData(e)}else if(0==t){if(!this.meshboard){r=new a.Vector2(this.size,this.size);this.meshboard=new a.MeshBoard(this.GetCoordinate(),r)}this.meshboard.UpdateRenderData(e)}this.SetFrontShow(this.IsSelected())},o.prototype.SetBody=function(e){this.body=e},o.prototype.GetBody=function(){return this.body},o.prototype.GetImageboard=function(){return this.pointImage},o.prototype.GetMeshBoard=function(){return this.meshboard},o.prototype.SetDrawType=function(e){this.drawType=e},o.prototype.GetDrawType=function(){return this.drawType},o.prototype.SetSize=function(e){this.size=e/4},o.prototype.GetSize=function(){return this.size},o.prototype.SetFrontShow=function(e){this.frontShow=e,this.pointImage&&this.pointImage.SetFrontShow(e)},o.prototype.SetPointStyle=function(e){this.point_style=e},o.prototype.GetPointStyle=function(){return this.point_style},o.BOX_LENGTH=.1,o}(a.Shape);a.Point=e}(M3D||(M3D={})),function(e){var t=function(t){function e(){var e=t.call(this)||this;return e.m_PointList=[],e.m_curvePntList=[],e}return __extends(e,t),e.prototype.GetPointList=function(){return this.m_PointList},e.prototype.AddPoint=function(e){this.m_PointList.push(e)},e.prototype.SetBuffer=function(e,t,r,i){},e.prototype.ComputeBox=function(){this.BoundingBox.Clear();for(var e=0;e<this.m_PointList.length;e++)this.BoundingBox.Merge(this.m_PointList[e])},e.prototype.ClearCurveLinePoint=function(){this.m_curvePntList.length=0},e.prototype.AddCurvePoint=function(e){this.m_curvePntList.push(e)},e}(e.Shape);e.PolyLine=t}(M3D||(M3D={})),function(e){var t=function(){function e(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(1===e.length){var r=e[0];this.m_view=r,this.m_geoManager=r.GetSceneManager().GetGeometryGroup()}}return e.prototype.AddCurve=function(e){this.m_geoManager.AddCurve(e.GetCurve())},e.prototype.RemoveCurve=function(e){this.m_geoManager&&this.m_geoManager.RemoveCurve(e.GetCurve())},e.prototype.RemoveAllPoint=function(){this.m_geoManager&&this.m_geoManager.RemoveAllPoints()},e.prototype.RemoveAllLine=function(){this.m_geoManager&&this.m_geoManager.RemoveAllLines()},e.prototype.RemoveAllCurve=function(){this.m_geoManager&&this.m_geoManager.RemoveAllCurve()},e.prototype.RemoveAllData=function(){this.m_geoManager&&this.m_geoManager.RemoveAllGeoData()},e.prototype.CreateScanBody=function(){},e.prototype.AddLine=function(e){this.m_geoManager&&this.m_geoManager.AddLine(e.GetLine())},e.prototype.RemoveLine=function(e){this.m_geoManager&&this.m_geoManager.RemoveLine(e.GetLine())},e.prototype.AddPoint=function(e){this.m_geoManager&&this.m_geoManager.AddPoint(e.GetNativePoint())},e.prototype.RemovePoint=function(e){this.m_geoManager&&this.m_geoManager.RemovePoint(e.GetNativePoint())},e.prototype.MakePipe=function(e){},e}();e.CLIGeometryManager=t}(M3D||(M3D={})),function(f){var e=function(e,t){this.uniformType=e,this.value=t};f.Uniform=e;var t=function(){function e(e){this.textureBindingTargetMap={},this.action=null,this.m_hardWareFrameBufferMap={},this.effectManager=null,this.action=e}return e.prototype.Render=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];e.length},e.prototype.SetEffectManager=function(e){this.effectManager=e},e.prototype.ClearResource=function(){},e.prototype.SetSize=function(e,t){},e.prototype.SetUniform=function(h,e,u){var p=this,c=this.action.GetRenderContext().GetGLRenderContext(),t=this.action.GetScene().GetResourceManager(),d=t.GetDeffaultTextureObj(),S=t.GetDefaultCubeMap();this.textureBindingTargetMap={},e.forEach(function(e,t){t.name;if(!1!==u.hasOwnProperty(e)){var r=u[e],i=r.uniformType;if(t)if("Texture2D"==i){l=f.GLShapeDrawer.AllocTextureUnit();if(c.uniform1i(h.GetShaderUniformParameter(e).location,l),n=r.value)(o=n.GetOGLObj(c))?(p.textureBindingTargetMap[l]=f.GL.TEXTURE_2D,c.activeTexture(f.GL.TEXTURE0+l),c.bindTexture(f.GL.TEXTURE_2D,o)):(p.textureBindingTargetMap[l]=f.GL.TEXTURE_2D,c.activeTexture(f.GL.TEXTURE0+l),c.bindTexture(f.GL.TEXTURE_2D,d))}else if("TextureCube"==i){var n,o;l=f.GLShapeDrawer.AllocTextureUnit();if(c.uniform1i(h.GetShaderUniformParameter(e).location,l),n=r.value)(o=n.GetOGLObj(c))?(p.textureBindingTargetMap[l]=f.GL.TEXTURE_CUBE_MAP,c.activeTexture(f.GL.TEXTURE0+l),c.bindTexture(f.GL.TEXTURE_CUBE_MAP,o)):(p.textureBindingTargetMap[l]=f.GL.TEXTURE_CUBE_MAP,c.activeTexture(f.GL.TEXTURE0+l),c.bindTexture(f.GL.TEXTURE_CUBE_MAP,S))}else if("Float"==i){var a=r.value,s=new Float32Array(a);h.SetUniformValue(e,s.length,s)}else if("Vector3"==i){a=r.value;h.SetUniformValue(e,a)}else if("Vector4"==i){a=r.value;h.SetUniformValue(e,a)}else if("Bool"==i){a=r.value;c.uniform1i(h.GetShaderUniformParameter(e).location,a)}else if("Matrix3"==i){a=r.value;h.SetUniformValue(e,a)}else if("Matrix4"==i){a=r.value;h.SetUniformValue(e,a)}}else if(t.type===f.GL.SAMPLER_2D){var l=f.GLShapeDrawer.AllocTextureUnit();c.uniform1i(h.GetShaderUniformParameter(e).location,l),p.textureBindingTargetMap[l]=f.GL.TEXTURE_2D,c.activeTexture(f.GL.TEXTURE0+l),c.bindTexture(f.GL.TEXTURE_2D,d)}else if(t.type===f.GL.SAMPLER_CUBE){var l=f.GLShapeDrawer.AllocTextureUnit();c.uniform1i(h.GetShaderUniformParameter(e).location,l),p.textureBindingTargetMap[l]=f.GL.TEXTURE_CUBE_MAP,c.activeTexture(f.GL.TEXTURE0+l),c.bindTexture(f.GL.TEXTURE_CUBE_MAP,S)}})},e.prototype.MergeUnifom=function(e,t){for(var r in e){var i=e[r];t[r]=i}},e.prototype.GetHardWareFrameBuffer=function(e){var t=this.action.GetCamera(),r=this.action.GetScene().GetResourceManager(),i=this.m_hardWareFrameBufferMap[e];if(null!==i)return i.second;var n=new f.HardWareFrameBuffer(this.action.GetRenderContext().GetGLRenderContext());return this.m_hardWareFrameBufferMap[e]=n,this.m_hardWareFrameBufferMap[e].SetSize(t.GetViewPort().GetRect().Width(),t.GetViewPort().GetRect().Height()),this.m_hardWareFrameBufferMap[e].SetResourceManager(r),this.m_hardWareFrameBufferMap[e]},e}();f.Effect=t}(M3D||(M3D={})),function(i){var e=function(){function e(e){this.effects={},this.renderAction=null,this.quadVertexVBO=null,this.quadTexcoordVBO=null,this.needInit=!0,this.renderAction=e}return e.prototype.GetQuadVBO=function(){return this.needInit&&(this.Init(),this.needInit=!1),{vertex:this.quadVertexVBO,texcoords:this.quadTexcoordVBO}},e.prototype.Init=function(){if(!this.quadVertexVBO||!this.quadTexcoordVBO){var e=this.renderAction.GetRenderContext().GetGLRenderContext();this.quadVertexVBO=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.quadVertexVBO),e.bufferData(e.ARRAY_BUFFER,new Float32Array([-1,1,-1,-1,-1,-1,1,1,-1,1,-1,-1]),e.STATIC_DRAW),this.quadTexcoordVBO=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.quadTexcoordVBO),e.bufferData(e.ARRAY_BUFFER,new Float32Array([0,1,0,0,1,1,1,0]),e.STATIC_DRAW),e.bindBuffer(e.ARRAY_BUFFER,null)}},e.prototype.getEffect=function(e){if(!1!==this.effects.hasOwnProperty(e))return this.effects[e];if("JEWELEFFECT"===e){var t=new i.JewelEffect(this.renderAction);return(this.effects[e]=t).SetEffectManager(this),t}if("OUTLINEEFFECT"!==e)return null;var r=new i.OutlineEffect(this.renderAction);return(this.effects[e]=r).SetEffectManager(this),r},e.prototype.setSize=function(e,t){for(var r in this.effects){this.effects[r].SetSize(e,t)}},e}();i.EffectManager=e}(M3D||(M3D={})),function(N){var e=function(r){function e(e){var t=r.call(this,e)||this;return t.hardWareFrameBufferMap={},t}return __extends(e,r),e.prototype.Render=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(0<e.length);else{for(var r=this.action,i=r.GetRenderEffect(),n=(i.GetRenderableTypeFilter(),i.GetRenderQueuePriority().GetData()),o=r.GetRenderQueueGroup(),a=[],s=0,l=n;s<l.length;s++){var h=l[s],u=o.get(h.GetRenderGroupType().GetType());if(void 0!==u){u.SetRenderTech(h);var p=u.GetType().GetType();p!=N.RenderableType.RGT_SOLID&&p!=N.RenderableType.RGT_TRANSPARENT&&p!=N.RenderableType.RGT_POINT&&p!=N.RenderableType.RGT_NOTE&&p!==N.RenderableType.RGT_INTOP||a.push(u)}}this.DrawJewelPassGroup(a)}},e.prototype.ClearResource=function(){},e.prototype.SetSize=function(e,t){for(var r in this.hardWareFrameBufferMap){this.hardWareFrameBufferMap[r].setSize(e,t)}},e.prototype.RenderJewelFront=function(e){if(0!=e.GetRenderableArray().length){var t=this.action,r=t.GetRenderContext(),i=r.GetGLRenderContext(),n=t.GetCamera(),o=t.GetShaderMananger().GetEffect(N.ShaderManager.JewelFront);o.UseProgram();var a=o.GetShaderAttributeParameter(N.VSP_POSITION),s=o.GetShaderAttributeParameter(N.VSP_NORMAL);o.GetShaderAttributeParameter(N.VSP_TEXCOORDS);o.EnableAttributeArray(a.location),o.EnableAttributeArray(s.location);for(var l=0,h=e.GetRenderableArray();l<h.length;l++){var u=h[l],p=new N.Matrix4,c={};c[N.VSP_VIEWMAT]=new N.Uniform("Matrix4",r.GetViewMatrix()),c[N.VSP_PROJECTIONMAT]=new N.Uniform("Matrix4",r.GetProjectMatrix()),N.GLShapeDrawer._usedTextureUnits=0;var d=u,S=d.GetRenderWorldMatrix(),f=r.GetViewMatrix();S.MultiplyMat4(f,p);var m=p.InverseED().TransposeED(),y=S.Inverse().Transpose();c[N.VSP_MODELMAT]=new N.Uniform("Matrix4",S),c[N.VSP_NORMALMAT]=new N.Uniform("Matrix4",m),c.u_worldNormalMat=new N.Uniform("Matrix4",y);var T=d.GetRenderColor(),M=new N.Color(1,1,1,1);T.Equals(N.Color.SelectColor())&&(M=T.Clone()),c[N.FSP_SELECTCOLOR]=new N.Uniform("Vector4",M);var g=n.GetWorldPosition().Clone();c[N.VSP_LIGHTPOSITION]=new N.Uniform("Vector3",g),c[N.VSP_EYEPOSITION]=new N.Uniform("Vector3",g),c.depthTexture=new N.Uniform("Texture2D",this.GetHardWareFrameBuffer("Depth").getColorTarget(0));var v=d.GetRenderMaterial();if(v){var C=v.GetUnifomParameters(),_=v.GetUniformParameter("type").value[0];this.MergeUnifom(C,c);var A=o.GetShaderUniformMap();if(104!=_){if(this.SetUniform(o,A,c),104!=_){var E=d.GetDataLength(),G=d.IsUseIndex(),P=d.GetHardWareVertexBuffer(),w=d.GetHardWareIndexBuffer();P.Bind();var D=u.GetVertexOffset(),x=u.GetNormalOffset();u.GetTextureCoordsOffset();if(o.SetVertexAttribPointer(a.location,3,N.GL.FLOAT,0,D),o.SetVertexAttribPointer(s.location,3,N.GL.FLOAT,0,x),G){var R=u.GetIndexOffset();N.GLShapeDrawer.DrawTriWithIndex(i,P,w,E,R)}else N.GLShapeDrawer.DrawTriNoIndex(i,P,E);P.UnBind()}for(var I in this.textureBindingTargetMap){var L=this.textureBindingTargetMap[I];i.activeTexture(N.GL.TEXTURE0+parseInt(I)),i.bindTexture(L,null)}}}}o.DisableAttributeArray(a.location),o.DisableAttributeArray(s.location),o.ReleaseShaderProgram()}},e.prototype.RenderJewelBack=function(e){if(0!=e.GetRenderableArray().length){var t=this.action,r=t.GetRenderContext(),i=r.GetGLRenderContext(),n=t.GetCamera(),o=t.GetShaderMananger().GetEffect(N.ShaderManager.JewelBack);o.UseProgram();var a=o.GetShaderAttributeParameter(N.VSP_POSITION),s=o.GetShaderAttributeParameter(N.VSP_NORMAL);o.EnableAttributeArray(a.location),o.EnableAttributeArray(s.location);for(var l=0,h=e.GetRenderableArray();l<h.length;l++){var u=h[l],p=new N.Matrix4,c={};c[N.VSP_VIEWMAT]=new N.Uniform("Matrix4",r.GetViewMatrix()),c[N.VSP_PROJECTIONMAT]=new N.Uniform("Matrix4",r.GetProjectMatrix()),N.GLShapeDrawer._usedTextureUnits=0;var d=u,S=d.GetRenderWorldMatrix(),f=r.GetViewMatrix();S.MultiplyMat4(f,p);var m=p.InverseED().TransposeED(),y=S.Inverse().Transpose();c[N.VSP_MODELMAT]=new N.Uniform("Matrix4",S),c[N.VSP_NORMALMAT]=new N.Uniform("Matrix4",m),c.u_worldNormalMat=new N.Uniform("Matrix4",y);var T=d.GetRenderColor(),M=new N.Color(1,1,1,1);T.Equals(N.Color.SelectColor())&&(M=T.Clone()),c[N.FSP_SELECTCOLOR]=new N.Uniform("Vector4",M);var g=n.GetWorldPosition().Clone();c[N.VSP_LIGHTPOSITION]=new N.Uniform("Vector3",g),c[N.VSP_EYEPOSITION]=new N.Uniform("Vector3",g),c.depthTexture=new N.Uniform("Texture2D",this.GetHardWareFrameBuffer("Depth").getColorTarget(0));var v=d.GetRenderMaterial();if(v){var C=v.GetUnifomParameters(),_=v.GetUniformParameter("type").value[0];this.MergeUnifom(C,c);var A=o.GetShaderUniformMap();if(104!=_){if(this.SetUniform(o,A,c),104!=_){var E=d.GetDataLength(),G=d.IsUseIndex(),P=d.GetHardWareVertexBuffer(),w=d.GetHardWareIndexBuffer();P.Bind();var D=u.GetVertexOffset(),x=u.GetNormalOffset();u.GetTextureCoordsOffset();if(o.SetVertexAttribPointer(a.location,3,N.GL.FLOAT,0,D),o.SetVertexAttribPointer(s.location,3,N.GL.FLOAT,0,x),G){var R=u.GetIndexOffset();N.GLShapeDrawer.DrawTriWithIndex(i,P,w,E,R)}else N.GLShapeDrawer.DrawTriNoIndex(i,P,E);P.UnBind()}for(var I in this.textureBindingTargetMap){var L=this.textureBindingTargetMap[I];i.activeTexture(N.GL.TEXTURE0+parseInt(I)),i.bindTexture(L,null)}}}}o.DisableAttributeArray(a.location),o.DisableAttributeArray(s.location),o.ReleaseShaderProgram()}},e.prototype.RenderRing=function(e){if(0!=e.GetRenderableArray().length){var t=this.action,r=t.GetRenderContext(),i=r.GetGLRenderContext(),n=t.GetCamera(),o=t.GetShaderMananger().GetEffect(N.ShaderManager.Ring);o.UseProgram();var a=o.GetShaderAttributeParameter(N.VSP_POSITION),s=o.GetShaderAttributeParameter(N.VSP_NORMAL);o.EnableAttributeArray(a.location),o.EnableAttributeArray(s.location);for(var l=0,h=e.GetRenderableArray();l<h.length;l++){var u=h[l],p=new N.Matrix4,c={};c[N.VSP_VIEWMAT]=new N.Uniform("Matrix4",r.GetViewMatrix()),c[N.VSP_PROJECTIONMAT]=new N.Uniform("Matrix4",r.GetProjectMatrix()),N.GLShapeDrawer._usedTextureUnits=0;var d=u,S=d.GetRenderWorldMatrix(),f=r.GetViewMatrix();S.MultiplyMat4(f,p);var m=p.InverseED().TransposeED(),y=S.Inverse().Transpose();c[N.VSP_MODELMAT]=new N.Uniform("Matrix4",S),c[N.VSP_NORMALMAT]=new N.Uniform("Matrix4",m),c.u_worldNormalMat=new N.Uniform("Matrix4",y);var T=d.GetRenderColor(),M=new N.Color(1,1,1,1);T.Equals(N.Color.SelectColor())&&(M=T.Clone()),c[N.FSP_SELECTCOLOR]=new N.Uniform("Vector4",M);var g=n.GetWorldPosition().Clone();c[N.VSP_LIGHTPOSITION]=new N.Uniform("Vector3",g),c[N.VSP_EYEPOSITION]=new N.Uniform("Vector3",g);var v=d.GetRenderMaterial();if(v){var C=v.GetUnifomParameters(),_=v.GetUniformParameter("type").value[0];this.MergeUnifom(C,c);var A=o.GetShaderUniformMap();if(104==_){if(this.SetUniform(o,A,c),104==_){var E=d.GetDataLength(),G=d.IsUseIndex(),P=d.GetHardWareVertexBuffer(),w=d.GetHardWareIndexBuffer();P.Bind();var D=u.GetVertexOffset(),x=u.GetNormalOffset();u.GetTextureCoordsOffset();if(o.SetVertexAttribPointer(a.location,3,N.GL.FLOAT,0,D),o.SetVertexAttribPointer(s.location,3,N.GL.FLOAT,0,x),G){var R=u.GetIndexOffset();N.GLShapeDrawer.DrawTriWithIndex(i,P,w,E,R)}else N.GLShapeDrawer.DrawTriNoIndex(i,P,E);P.UnBind()}for(var I in this.textureBindingTargetMap){var L=this.textureBindingTargetMap[I];i.activeTexture(N.GL.TEXTURE0+parseInt(I)),i.bindTexture(L,null)}}}}o.DisableAttributeArray(a.location),o.DisableAttributeArray(s.location),o.ReleaseShaderProgram()}},e.prototype.DrawJewelType=function(e){if(0!=e.GetRenderableArray().length){var t=this.action,r=t.GetRenderContext(),i=r.GetGLRenderContext(),n=(t.GetCamera(),t.GetShaderMananger().GetEffect(N.ShaderManager.JewelType));n.UseProgram();var o=n.GetShaderAttributeParameter(N.VSP_POSITION);n.EnableAttributeArray(o.location);for(var a=0,s=e.GetRenderableArray();a<s.length;a++){var l=s[a],h=(new N.Matrix4,{});h[N.VSP_VIEWMAT]=new N.Uniform("Matrix4",r.GetViewMatrix()),h[N.VSP_PROJECTIONMAT]=new N.Uniform("Matrix4",r.GetProjectMatrix()),N.GLShapeDrawer._usedTextureUnits=0;var u=l,p=u.GetRenderWorldMatrix();h[N.VSP_MODELMAT]=new N.Uniform("Matrix4",p);var c=u.GetRenderMaterial();if(c){var d=c.GetUniformParameter("type").value[0],S=c.GetUnifomParameters();if(104!=d){this.MergeUnifom(S,h);var f=n.GetShaderUniformMap();if(this.SetUniform(n,f,h),104!=d){var m=u.GetDataLength(),y=u.IsUseIndex(),T=u.GetHardWareVertexBuffer(),M=u.GetHardWareIndexBuffer();T.Bind();var g=l.GetVertexOffset();l.GetNormalOffset(),l.GetTextureCoordsOffset();if(n.SetVertexAttribPointer(o.location,3,N.GL.FLOAT,0,g),y){var v=l.GetIndexOffset();N.GLShapeDrawer.DrawTriWithIndex(i,T,M,m,v)}else N.GLShapeDrawer.DrawTriNoIndex(i,T,m);T.UnBind()}for(var C in this.textureBindingTargetMap){var _=this.textureBindingTargetMap[C];i.activeTexture(N.GL.TEXTURE0+parseInt(C)),i.bindTexture(_,null)}}}}n.DisableAttributeArray(o.location),n.ReleaseShaderProgram()}},e.prototype.DrawJewelHighLight=function(e){if(0!=e.GetRenderableArray().length){var t=this.action,r=t.GetRenderContext(),i=r.GetGLRenderContext(),n=(t.GetCamera(),t.GetShaderMananger().GetEffect(N.ShaderManager.JewelHighLight));n.UseProgram();var o=n.GetShaderAttributeParameter(N.VSP_POSITION),a=n.GetShaderAttributeParameter(N.VSP_NORMAL);n.EnableAttributeArray(o.location),n.EnableAttributeArray(a.location);for(var s=0,l=e.GetRenderableArray();s<l.length;s++){var h=l[s],u=new N.Matrix4,p={};p[N.VSP_VIEWMAT]=new N.Uniform("Matrix4",r.GetViewMatrix()),p[N.VSP_PROJECTIONMAT]=new N.Uniform("Matrix4",r.GetProjectMatrix()),N.GLShapeDrawer._usedTextureUnits=0;var c=h,d=c.GetRenderWorldMatrix(),S=r.GetViewMatrix();d.MultiplyMat4(S,u);var f=u.InverseED().TransposeED();d.Inverse().Transpose();p[N.VSP_MODELMAT]=new N.Uniform("Matrix4",d),p[N.VSP_NORMALMAT]=new N.Uniform("Matrix4",f);var m=c.GetRenderColor();new N.Color(1,1,1,1);m.Equals(N.Color.SelectColor())&&m.Clone();var y=c.GetRenderMaterial();if(y){y.GetUnifomParameters();var T=new N.Vector3(1,1,1),M=new N.Vector3(0,0,0),g=y.GetUniformParameter("type").value[0];p[N.FSP_SPECULAR]=103==g?new N.Uniform("Vector3",T):new N.Uniform("Vector3",M);var v=n.GetShaderUniformMap();if(this.SetUniform(n,v,p),104!=g){var C=c.GetDataLength(),_=c.IsUseIndex(),A=c.GetHardWareVertexBuffer(),E=c.GetHardWareIndexBuffer();A.Bind();var G=h.GetVertexOffset(),P=h.GetNormalOffset();h.GetTextureCoordsOffset();if(n.SetVertexAttribPointer(o.location,3,N.GL.FLOAT,0,G),n.SetVertexAttribPointer(a.location,3,N.GL.FLOAT,0,P),_){var w=h.GetIndexOffset();N.GLShapeDrawer.DrawTriWithIndex(i,A,E,C,w)}else N.GLShapeDrawer.DrawTriNoIndex(i,A,C);A.UnBind()}for(var D in this.textureBindingTargetMap){var x=this.textureBindingTargetMap[D];i.activeTexture(N.GL.TEXTURE0+parseInt(D)),i.bindTexture(x,null)}}}n.DisableAttributeArray(o.location),n.DisableAttributeArray(a.location),n.ReleaseShaderProgram()}},e.prototype.DrawDepth=function(e,t){if(0!=e.GetRenderableArray().length){var r=this.action,i=r.GetRenderContext(),n=i.GetGLRenderContext(),o=(r.GetCamera(),r.GetShaderMananger().GetEffect(N.ShaderManager.Depth));o.UseProgram();var a=o.GetShaderAttributeParameter(N.VSP_POSITION);o.EnableAttributeArray(a.location);for(var s=0,l=e.GetRenderableArray();s<l.length;s++){var h=l[s],u=(new N.Matrix4,{});u[N.VSP_VIEWMAT]=new N.Uniform("Matrix4",i.GetViewMatrix()),u[N.VSP_PROJECTIONMAT]=new N.Uniform("Matrix4",i.GetProjectMatrix()),N.GLShapeDrawer._usedTextureUnits=0;var p=h,c=p.GetRenderWorldMatrix();i.GetViewMatrix();u[N.VSP_MODELMAT]=new N.Uniform("Matrix4",c);var d=p.GetRenderColor();new N.Color(1,1,1,1);d.Equals(N.Color.SelectColor())&&d.Clone();var S=p.GetRenderMaterial();if(S){var f=S.GetUnifomParameters();new N.Vector3(1,1,1),new N.Vector3(0,0,0);if(S.GetUniformParameter("type").value[0]===t){this.MergeUnifom(f,u);var m=o.GetShaderUniformMap();this.SetUniform(o,m,u);var y=p.GetDataLength(),T=p.IsUseIndex(),M=p.GetHardWareVertexBuffer(),g=p.GetHardWareIndexBuffer();M.Bind();var v=h.GetVertexOffset();h.GetNormalOffset(),h.GetTextureCoordsOffset();if(o.SetVertexAttribPointer(a.location,3,N.GL.FLOAT,0,v),T){var C=h.GetIndexOffset();N.GLShapeDrawer.DrawTriWithIndex(n,M,g,y,C)}else N.GLShapeDrawer.DrawTriNoIndex(n,M,y);for(var _ in M.UnBind(),this.textureBindingTargetMap){var A=this.textureBindingTargetMap[_];n.activeTexture(N.GL.TEXTURE0+parseInt(_)),n.bindTexture(A,null)}}}}o.DisableAttributeArray(a.location),o.ReleaseShaderProgram()}},e.prototype.DrawJadeBlendQuad=function(){var e=this.action,t=e.GetRenderContext().GetGLRenderContext(),r=e.GetCamera().GetViewPort().GetRect();t.viewport(r.left,r.top,r.right,r.bottom);r.right,r.bottom;var i=e.GetShaderMananger().GetEffect(N.ShaderManager.JewelBlendQuad);i.UseProgram();var n={};N.GLShapeDrawer._usedTextureUnits=0;var o=i.GetShaderAttributeParameter(N.VSP_POSITION),a=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,a),t.bufferData(t.ARRAY_BUFFER,new Float32Array([-1,1,-1,-1,-1,-1,1,1,-1,1,-1,-1]),t.STATIC_DRAW),i.EnableAttributeArray(o.location),i.SetVertexAttribPointer(o.location,3,N.GL.FLOAT,0,0);var s=i.GetShaderAttributeParameter(N.VSP_TEXCOORDS),l=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,l),t.bufferData(t.ARRAY_BUFFER,new Float32Array([0,1,0,0,1,1,1,0]),t.STATIC_DRAW),i.EnableAttributeArray(s.location),i.SetVertexAttribPointer(s.location,2,N.GL.FLOAT,0,0);var h=new N.Matrix4,u=new N.Matrix4,p=new N.Matrix4;n[N.VSP_MODELMAT]=new N.Uniform("Matrix4",p),n[N.VSP_VIEWMAT]=new N.Uniform("Matrix4",h),n[N.VSP_PROJECTIONMAT]=new N.Uniform("Matrix4",u),n[N.FSP_SAMPLER0]=new N.Uniform("Texture2D",this.GetHardWareFrameBuffer("diamondFrontFBO").getColorTarget(0)),n[N.FSP_SAMPLER1]=new N.Uniform("Texture2D",this.GetHardWareFrameBuffer("diamondBackFBO").getColorTarget(0)),n[N.FSP_SAMPLER2]=new N.Uniform("Texture2D",this.GetHardWareFrameBuffer("jewelTypeFBO").getColorTarget(0)),n.u_sampler3=new N.Uniform("Texture2D",this.GetHardWareFrameBuffer("jewelHighLightFBO").getColorTarget(0));var c=i.GetShaderUniformMap();for(var d in this.SetUniform(i,c,n),t.drawArrays(N.GL.TRIANGLE_STRIP,0,4),this.textureBindingTargetMap){var S=this.textureBindingTargetMap[d];t.activeTexture(N.GL.TEXTURE0+parseInt(d)),t.bindTexture(S,null)}i.DisableAttributeArray(o.location),i.DisableAttributeArray(s.location),i.ReleaseShaderProgram(),t.deleteBuffer(a),t.deleteBuffer(l)},e.prototype.DrawJewelQuad=function(){var e=this.action,t=e.GetRenderContext().GetGLRenderContext(),r=e.GetCamera().GetViewPort().GetRect();t.viewport(r.left,r.top,r.right,r.bottom);r.right,r.bottom;var i=e.GetShaderMananger().GetEffect(N.ShaderManager.JewelFinalQuad);i.UseProgram();var n={};N.GLShapeDrawer._usedTextureUnits=0;var o=i.GetShaderAttributeParameter(N.VSP_POSITION),a=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,a),t.bufferData(t.ARRAY_BUFFER,new Float32Array([-1,1,-1,-1,-1,-1,1,1,-1,1,-1,-1]),t.STATIC_DRAW),i.EnableAttributeArray(o.location),i.SetVertexAttribPointer(o.location,3,N.GL.FLOAT,0,0);var s=i.GetShaderAttributeParameter(N.VSP_TEXCOORDS),l=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,l),t.bufferData(t.ARRAY_BUFFER,new Float32Array([0,1,0,0,1,1,1,0]),t.STATIC_DRAW),i.EnableAttributeArray(s.location),i.SetVertexAttribPointer(s.location,2,N.GL.FLOAT,0,0);var h=new N.Matrix4,u=new N.Matrix4,p=new N.Matrix4;n[N.VSP_MODELMAT]=new N.Uniform("Matrix4",p),n[N.VSP_VIEWMAT]=new N.Uniform("Matrix4",h),n[N.VSP_PROJECTIONMAT]=new N.Uniform("Matrix4",u),n[N.FSP_SAMPLER0]=new N.Uniform("Texture2D",this.GetHardWareFrameBuffer("jewelBlendQuadFBO").getColorTarget(0)),n[N.FSP_SAMPLER1]=new N.Uniform("Texture2D",this.GetHardWareFrameBuffer("jewelDepth").getColorTarget(0)),n[N.FSP_SAMPLER2]=new N.Uniform("Texture2D",this.GetHardWareFrameBuffer("ringFBO").getColorTarget(0)),n.u_sampler3=new N.Uniform("Texture2D",this.GetHardWareFrameBuffer("ringDepth").getColorTarget(0));var c=i.GetShaderUniformMap();for(var d in this.SetUniform(i,c,n),t.drawArrays(N.GL.TRIANGLE_STRIP,0,4),this.textureBindingTargetMap){var S=this.textureBindingTargetMap[d];t.activeTexture(N.GL.TEXTURE0+parseInt(d)),t.bindTexture(S,null)}i.DisableAttributeArray(o.location),i.DisableAttributeArray(s.location),i.ReleaseShaderProgram(),t.deleteBuffer(a),t.deleteBuffer(l)},e.prototype.DrawJewelPassGroup=function(e){if(0!==e[0].GetRenderableArray().length){var t=this.action,r=t.GetRenderContext().GetGLRenderContext(),i=t.GetCamera().GetViewPort().GetRect();r.disable(N.GL.BLEND);var n=this.GetHardWareFrameBuffer("jewelDepth");n.reShape(),n.checkStatus(),n.bind(),r.enable(N.GL.DEPTH_TEST),r.depthFunc(N.GL.LEQUAL),r.clearColor(1,1,1,1),r.clear(N.GL.DEPTH_BUFFER_BIT|N.GL.COLOR_BUFFER_BIT|N.GL.STENCIL_BUFFER_BIT),r.viewport(i.left,i.top,i.right,i.bottom),r.enable(N.GL.CULL_FACE),r.cullFace(N.GL.BACK),r.frontFace(N.GL.CCW);for(var o=0;o<e.length;o++){(d=e[0].GetType().GetType())!=N.RenderableType.RGT_SOLID&&d!=N.RenderableType.RGT_TRANSPARENT||this.DrawDepth(e[o],103)}n.unbind();var a=this.GetHardWareFrameBuffer("ringDepth");a.reShape(),a.checkStatus(),a.bind(),r.enable(N.GL.DEPTH_TEST),r.depthFunc(N.GL.LEQUAL),r.clearColor(1,1,1,1),r.clear(N.GL.DEPTH_BUFFER_BIT|N.GL.COLOR_BUFFER_BIT|N.GL.STENCIL_BUFFER_BIT),r.viewport(i.left,i.top,i.right,i.bottom),r.enable(N.GL.CULL_FACE),r.cullFace(N.GL.BACK),r.frontFace(N.GL.CCW);for(o=0;o<e.length;o++){(d=e[0].GetType().GetType())!=N.RenderableType.RGT_SOLID&&d!=N.RenderableType.RGT_TRANSPARENT||this.DrawDepth(e[o],104)}a.unbind();var s=this.GetHardWareFrameBuffer("diamondFrontFBO");s.reShape(),s.checkStatus(),s.bind(),r.enable(N.GL.DEPTH_TEST),r.depthFunc(N.GL.LEQUAL),r.clearColor(0,0,0,0),r.clear(N.GL.DEPTH_BUFFER_BIT|N.GL.COLOR_BUFFER_BIT|N.GL.STENCIL_BUFFER_BIT),N.Parameters.Instance().m_BackTransparent||N.GLShapeDrawer.DrawBackGround(t.GetBackGroundNode(),t),r.viewport(i.left,i.top,i.right,i.bottom),r.enable(N.GL.CULL_FACE),r.cullFace(N.GL.BACK),r.frontFace(N.GL.CCW);for(o=0;o<e.length;o++){(d=e[0].GetType().GetType())!=N.RenderableType.RGT_SOLID&&d!=N.RenderableType.RGT_TRANSPARENT||this.RenderJewelFront(e[o])}s.unbind();var l=this.GetHardWareFrameBuffer("diamondBackFBO");l.reShape(),l.checkStatus(),l.bind(),r.enable(N.GL.DEPTH_TEST),r.depthFunc(N.GL.LEQUAL),r.clearColor(0,0,0,0),r.clear(N.GL.DEPTH_BUFFER_BIT|N.GL.COLOR_BUFFER_BIT|N.GL.STENCIL_BUFFER_BIT),N.Parameters.Instance().m_BackTransparent||N.GLShapeDrawer.DrawBackGround(t.GetBackGroundNode(),t),r.viewport(i.left,i.top,i.right,i.bottom),r.enable(N.GL.CULL_FACE),r.cullFace(N.GL.BACK),r.frontFace(N.GL.CW);for(o=0;o<e.length;o++){(d=e[0].GetType().GetType())!=N.RenderableType.RGT_SOLID&&d!=N.RenderableType.RGT_TRANSPARENT||this.RenderJewelBack(e[o])}l.unbind(),r.frontFace(N.GL.CCW),r.disable(N.GL.CULL_FACE);var h=this.GetHardWareFrameBuffer("ringFBO");h.reShape(),h.checkStatus(),h.bind(),r.enable(N.GL.DEPTH_TEST),r.depthFunc(N.GL.LEQUAL),r.clearColor(0,0,0,0),r.clear(N.GL.DEPTH_BUFFER_BIT|N.GL.COLOR_BUFFER_BIT|N.GL.STENCIL_BUFFER_BIT),N.Parameters.Instance().m_BackTransparent||N.GLShapeDrawer.DrawBackGround(t.GetBackGroundNode(),t),r.viewport(i.left,i.top,i.right,i.bottom);for(o=0;o<e.length;o++){(d=e[0].GetType().GetType())!=N.RenderableType.RGT_SOLID&&d!=N.RenderableType.RGT_TRANSPARENT||this.RenderRing(e[o])}h.unbind();var u=this.GetHardWareFrameBuffer("jewelTypeFBO");u.reShape(),u.checkStatus(),u.bind(),r.enable(N.GL.DEPTH_TEST),r.depthFunc(N.GL.LEQUAL),r.clearColor(0,0,0,0),r.clear(N.GL.DEPTH_BUFFER_BIT|N.GL.COLOR_BUFFER_BIT|N.GL.STENCIL_BUFFER_BIT),r.viewport(i.left,i.top,i.right,i.bottom);for(o=0;o<e.length;o++){(d=e[o].GetType().GetType())!=N.RenderableType.RGT_SOLID&&d!=N.RenderableType.RGT_TRANSPARENT||this.DrawJewelType(e[o])}u.unbind();var p=this.GetHardWareFrameBuffer("jewelHighLightFBO");p.reShape(),p.checkStatus(),p.bind(),r.enable(N.GL.DEPTH_TEST),r.depthFunc(N.GL.LEQUAL),r.clearColor(0,0,0,0),r.clear(N.GL.DEPTH_BUFFER_BIT|N.GL.COLOR_BUFFER_BIT|N.GL.STENCIL_BUFFER_BIT),r.viewport(i.left,i.top,i.right,i.bottom);for(o=0;o<e.length;o++){(d=e[o].GetType().GetType())!=N.RenderableType.RGT_SOLID&&d!=N.RenderableType.RGT_TRANSPARENT||this.DrawJewelHighLight(e[o])}p.unbind();var c=this.GetHardWareFrameBuffer("jewelBlendQuadFBO");c.reShape(),c.checkStatus(),c.bind(),r.enable(N.GL.DEPTH_TEST),r.depthFunc(N.GL.LEQUAL),r.clearColor(0,0,0,0),r.clear(N.GL.DEPTH_BUFFER_BIT|N.GL.COLOR_BUFFER_BIT|N.GL.STENCIL_BUFFER_BIT),r.viewport(i.left,i.top,i.right,i.bottom),this.DrawJadeBlendQuad(),c.unbind(),this.DrawJewelQuad();for(o=0;o<e.length;o++){var d;(d=e[o].GetType().GetType())==N.RenderableType.RGT_INTOP&&N.GLShapeDrawer.DrawOutlinePassGroup(t,e[o])}r.viewport(i.left,i.top,i.right,i.bottom)}},e.prototype.GetHardWareFrameBuffer=function(e){var t=this.action.GetCamera(),r=this.action.GetScene().GetResourceManager(),i=this.action.GetRenderContext().GetGLRenderContext();if(!1!==this.hardWareFrameBufferMap.hasOwnProperty(e))return this.hardWareFrameBufferMap[e];var n=new N.HardWareFrameBuffer(i);return n.setCreationParameters(1,!0,!1),n.setResourceManager(r),n.setSize(t.GetViewPort().GetRect().Width(),t.GetViewPort().GetRect().Height()),this.hardWareFrameBufferMap[e]=n},e.prototype.DrawFrameBufferDebug=function(){var e=this.action,t=e.GetRenderContext().GetGLRenderContext(),r=e.GetCamera().GetViewPort().GetRect();t.viewport(r.left,r.top,r.right,r.bottom);r.right,r.bottom;var i=e.GetShaderMananger().GetEffect(N.ShaderManager.FBODebug);i.UseProgram();var n={};N.GLShapeDrawer._usedTextureUnits=0;var o=i.GetShaderAttributeParameter(N.VSP_POSITION),a=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,a),t.bufferData(t.ARRAY_BUFFER,new Float32Array([-1,1,-1,-1,-1,-1,1,1,-1,1,-1,-1]),t.STATIC_DRAW),i.EnableAttributeArray(o.location),i.SetVertexAttribPointer(o.location,3,N.GL.FLOAT,0,0);var s=i.GetShaderAttributeParameter(N.VSP_TEXCOORDS),l=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,l),t.bufferData(t.ARRAY_BUFFER,new Float32Array([0,1,0,0,1,1,1,0]),t.STATIC_DRAW),i.EnableAttributeArray(s.location),i.SetVertexAttribPointer(s.location,2,N.GL.FLOAT,0,0);var h=new N.Matrix4,u=new N.Matrix4,p=new N.Matrix4;n[N.VSP_MODELMAT]=new N.Uniform("Matrix4",p),n[N.VSP_VIEWMAT]=new N.Uniform("Matrix4",h),n[N.VSP_PROJECTIONMAT]=new N.Uniform("Matrix4",u),n[N.FSP_SAMPLER0]=new N.Uniform("Texture2D",this.GetHardWareFrameBuffer("jewelDepth").getColorTarget(0));var c=i.GetShaderUniformMap();for(var d in this.SetUniform(i,c,n),t.drawArrays(N.GL.TRIANGLE_STRIP,0,4),this.textureBindingTargetMap){var S=this.textureBindingTargetMap[d];t.activeTexture(N.GL.TEXTURE0+parseInt(d)),t.bindTexture(S,null)}i.DisableAttributeArray(o.location),i.DisableAttributeArray(s.location),i.ReleaseShaderProgram(),t.deleteBuffer(a),t.deleteBuffer(l)},e}(N.Effect);N.JewelEffect=e}(M3D||(M3D={})),function(C){var e=function(r){function e(e){var t=r.call(this,e)||this;return t.hardWareFrameBufferMap={},t.outlineTexture=null,t.firstTimes=!0,t}return __extends(e,r),e.prototype.GetOutlineTexture=function(){return this.outlineTexture},e.prototype.Render=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(0<e.length){var r=e[0];(s=[]).push(r),this.InnerRender(s)}else{for(var i=this.action,n=i.GetRenderEffect(),o=(n.GetRenderableTypeFilter(),n.GetRenderQueuePriority().GetData()),a=i.GetRenderQueueGroup(),s=[],l=0,h=o;l<h.length;l++){var u=h[l],p=a.get(u.GetRenderGroupType().GetType());if(void 0!==p){p.SetRenderTech(u);var c=p.GetType().GetType();c!=C.RenderableType.RGT_SOLID&&c!=C.RenderableType.RGT_TRANSPARENT||s.push(p)}}this.InnerRender(s)}},e.prototype.InnerRender=function(e){this.firstTimes=!0;var t=this.action,r=t.GetRenderContext().GetGLRenderContext(),i=t.GetCamera().GetViewPort().GetRect(),n=this.GetHardWareFrameBuffer("model");n.reShape(),n.checkStatus(),n.bind(),r.enable(C.GL.DEPTH_TEST),r.depthFunc(C.GL.LEQUAL),r.clearColor(0,0,0,0),r.clear(C.GL.DEPTH_BUFFER_BIT|C.GL.COLOR_BUFFER_BIT|C.GL.STENCIL_BUFFER_BIT),r.viewport(i.left,i.top,i.right,i.bottom);for(var o=0;o<e.length;o++)this.RenderModel(e[o]);n.unbind();var a=this.GetHardWareFrameBuffer("width");a.reShape(),a.checkStatus(),a.bind(),r.disable(C.GL.DEPTH_TEST),r.depthFunc(C.GL.LEQUAL),r.clearColor(0,0,0,0),r.clear(C.GL.DEPTH_BUFFER_BIT|C.GL.COLOR_BUFFER_BIT|C.GL.STENCIL_BUFFER_BIT),r.viewport(i.left,i.top,i.right,i.bottom),this.RenderGaussianBlurWidth(),a.unbind();var s=this.GetHardWareFrameBuffer("height");s.reShape(),s.checkStatus(),s.bind(),r.disable(C.GL.DEPTH_TEST),r.depthFunc(C.GL.LEQUAL),r.clearColor(0,0,0,0),r.clear(C.GL.DEPTH_BUFFER_BIT|C.GL.COLOR_BUFFER_BIT|C.GL.STENCIL_BUFFER_BIT),r.viewport(i.left,i.top,i.right,i.bottom),this.RenderGaussianBlurHeight(),s.unbind(),a.bind(),this.RenderGaussianBlurWidth(),a.unbind(),s.bind(),this.RenderGaussianBlurHeight(),s.unbind(),a.bind(),this.RenderGaussianBlurWidth(),a.unbind(),s.bind(),this.RenderGaussianBlurHeight(),s.unbind(),a.bind(),this.RenderGaussianBlurWidth(),a.unbind(),s.bind(),this.RenderGaussianBlurHeight(),s.unbind(),a.bind(),this.RenderGaussianBlurWidth(),a.unbind(),s.bind(),this.RenderGaussianBlurHeight(),s.unbind(),a.bind(),this.RenderGaussianBlurWidth(),a.unbind(),s.bind(),this.RenderGaussianBlurHeight(),s.unbind(),a.bind(),this.RenderGaussianBlurWidth(),a.unbind(),s.bind(),this.RenderGaussianBlurHeight(),s.unbind();var l=this.GetHardWareFrameBuffer("outline");l.reShape(),l.checkStatus(),l.bind(),r.disable(C.GL.DEPTH_TEST),r.depthFunc(C.GL.LEQUAL),r.clearColor(0,0,0,0),r.clear(C.GL.DEPTH_BUFFER_BIT|C.GL.COLOR_BUFFER_BIT|C.GL.STENCIL_BUFFER_BIT),r.viewport(i.left,i.top,i.right,i.bottom),this.RenderOutline(),l.unbind(),this.outlineTexture=this.GetHardWareFrameBuffer("outline").getColorTarget(0)},e.prototype.RenderModel=function(e){if(0!==e.GetRenderableArray().length){var t=this.action,r=t.GetRenderContext(),i=r.GetGLRenderContext(),n=(t.GetCamera().GetViewPort().GetRect(),t.GetShaderMananger().GetEffect(C.ShaderManager.Outline));n.UseProgram();var o=n.GetShaderAttributeParameter(C.VSP_POSITION);n.GetShaderAttributeParameter(C.VSP_NORMAL);n.EnableAttributeArray(o.location),n.SetUniformValue(C.VSP_VIEWMAT,r.GetViewMatrix()),n.SetUniformValue(C.VSP_PROJECTIONMAT,r.GetProjectMatrix());var a=t.clipPlane[0].Clone();a=r.GetViewMatrix().Inverse().Multiply(a),n.SetUniformValue(C.FSP_CLIPPLANE,a);var s=new Int32Array([t.enableClip[0]]);n.SetUniformValue(C.FSP_ENABLECLIP,s);for(var l=new C.Matrix4,h=e.GetRenderableArray(),u=r.GetViewMatrix(),p=new C.Matrix4,c=new C.Matrix4,d=0,S=h;d<S.length;d++){var f=S[d],m=f.GetDataLength(),y=f.IsUseIndex(),T=f.GetHardWareVertexBuffer(),M=f.GetHardWareIndexBuffer();(l=f.GetRenderWorldMatrix()).MultiplyMat4(u,p),c=p.InverseED().TransposeED(),T.Bind();var g=f.GetVertexOffset();f.GetNormalOffset(),f.GetTextureCoordsOffset(),f.GetCentersCoordsOffset(),f.GetRenderColor();if(n.SetVertexAttribPointer(o.location,3,C.GL.FLOAT,0,g),n.SetUniformValue(C.VSP_MODELMAT,l),n.SetUniformValue(C.VSP_NORMALMAT,c),0<m)if(n.SetUniformValue(C.FSP_DIFFUSE,C.Parameters.Instance().ModelSelectedColor),y){var v=f.GetIndexOffset();C.GLShapeDrawer.DrawTriWithIndex(i,T,M,m,v)}else C.GLShapeDrawer.DrawTriNoIndex(i,T,m)}n.DisableAttributeArray(o.location),n.ReleaseShaderProgram(),i.enable(C.GL.DEPTH_TEST)}},e.prototype.RenderGaussianBlurWidth=function(){var e=this.action,t=e.GetRenderContext().GetGLRenderContext(),r=e.GetCamera().GetViewPort().GetRect();t.viewport(r.left,r.top,r.right,r.bottom);var i=1/r.right,n=(r.bottom,e.GetShaderMananger().GetEffect(C.ShaderManager.GaussianBlur));n.UseProgram();var o={};C.GLShapeDrawer._usedTextureUnits=0;var a=n.GetShaderAttributeParameter(C.VSP_POSITION),s=this.effectManager.GetQuadVBO().vertex;t.bindBuffer(t.ARRAY_BUFFER,s),n.EnableAttributeArray(a.location),n.SetVertexAttribPointer(a.location,3,C.GL.FLOAT,0,0);var l=n.GetShaderAttributeParameter(C.VSP_TEXCOORDS),h=this.effectManager.GetQuadVBO().texcoords;t.bindBuffer(t.ARRAY_BUFFER,h),n.EnableAttributeArray(l.location),n.SetVertexAttribPointer(l.location,2,C.GL.FLOAT,0,0);new C.Matrix4,new C.Matrix4,new C.Matrix4;var u=[];u.push(i),o.tex_offset=new C.Uniform("Float",u),o.horizontal=new C.Uniform("Bool",!0),this.firstTimes?(o.image=new C.Uniform("Texture2D",this.GetHardWareFrameBuffer("model").getColorTarget(0)),this.firstTimes=!1):o.image=new C.Uniform("Texture2D",this.GetHardWareFrameBuffer("height").getColorTarget(0));var p=n.GetShaderUniformMap();for(var c in this.SetUniform(n,p,o),t.drawArrays(C.GL.TRIANGLE_STRIP,0,4),this.textureBindingTargetMap){var d=this.textureBindingTargetMap[c];t.activeTexture(C.GL.TEXTURE0+parseInt(c)),t.bindTexture(d,null)}n.DisableAttributeArray(a.location),n.DisableAttributeArray(l.location),n.ReleaseShaderProgram(),t.bindBuffer(C.GL.ARRAY_BUFFER,null)},e.prototype.RenderGaussianBlurHeight=function(){var e=this.action,t=e.GetRenderContext().GetGLRenderContext(),r=e.GetCamera().GetViewPort().GetRect();t.viewport(r.left,r.top,r.right,r.bottom);r.right;var i=1/r.bottom,n=e.GetShaderMananger().GetEffect(C.ShaderManager.GaussianBlur);n.UseProgram();var o={};C.GLShapeDrawer._usedTextureUnits=0;var a=n.GetShaderAttributeParameter(C.VSP_POSITION),s=this.effectManager.GetQuadVBO().vertex;t.bindBuffer(t.ARRAY_BUFFER,s),n.EnableAttributeArray(a.location),n.SetVertexAttribPointer(a.location,3,C.GL.FLOAT,0,0);var l=n.GetShaderAttributeParameter(C.VSP_TEXCOORDS),h=this.effectManager.GetQuadVBO().texcoords;t.bindBuffer(t.ARRAY_BUFFER,h),n.EnableAttributeArray(l.location),n.SetVertexAttribPointer(l.location,2,C.GL.FLOAT,0,0);new C.Matrix4,new C.Matrix4,new C.Matrix4;var u=[];u.push(i),o.tex_offset=new C.Uniform("Float",u),o.horizontal=new C.Uniform("Bool",!1),o.image=new C.Uniform("Texture2D",this.GetHardWareFrameBuffer("width").getColorTarget(0));var p=n.GetShaderUniformMap();for(var c in this.SetUniform(n,p,o),t.drawArrays(C.GL.TRIANGLE_STRIP,0,4),this.textureBindingTargetMap){var d=this.textureBindingTargetMap[c];t.activeTexture(C.GL.TEXTURE0+parseInt(c)),t.bindTexture(d,null)}n.DisableAttributeArray(a.location),n.DisableAttributeArray(l.location),n.ReleaseShaderProgram(),t.bindBuffer(C.GL.ARRAY_BUFFER,null)},e.prototype.RenderOutline=function(){var e=this.action,t=e.GetRenderContext().GetGLRenderContext(),r=e.GetCamera().GetViewPort().GetRect();t.viewport(r.left,r.top,r.right,r.bottom);r.right,r.bottom;var i=e.GetShaderMananger().GetEffect(C.ShaderManager.GaussianBlurOutline);i.UseProgram();var n={};C.GLShapeDrawer._usedTextureUnits=0;var o=i.GetShaderAttributeParameter(C.VSP_POSITION),a=this.effectManager.GetQuadVBO().vertex;t.bindBuffer(t.ARRAY_BUFFER,a),i.EnableAttributeArray(o.location),i.SetVertexAttribPointer(o.location,3,C.GL.FLOAT,0,0);var s=i.GetShaderAttributeParameter(C.VSP_TEXCOORDS),l=this.effectManager.GetQuadVBO().texcoords;t.bindBuffer(t.ARRAY_BUFFER,l),i.EnableAttributeArray(s.location),i.SetVertexAttribPointer(s.location,2,C.GL.FLOAT,0,0);new C.Matrix4,new C.Matrix4,new C.Matrix4;n.height=new C.Uniform("Texture2D",this.GetHardWareFrameBuffer("height").getColorTarget(0)),n.model=new C.Uniform("Texture2D",this.GetHardWareFrameBuffer("model").getColorTarget(0));var h=i.GetShaderUniformMap();for(var u in this.SetUniform(i,h,n),t.drawArrays(C.GL.TRIANGLE_STRIP,0,4),this.textureBindingTargetMap){var p=this.textureBindingTargetMap[u];t.activeTexture(C.GL.TEXTURE0+parseInt(u)),t.bindTexture(p,null)}i.DisableAttributeArray(o.location),i.DisableAttributeArray(s.location),i.ReleaseShaderProgram(),t.bindBuffer(C.GL.ARRAY_BUFFER,null)},e.prototype.DrawFrameBufferDebug=function(){var e=this.action,t=e.GetRenderContext().GetGLRenderContext(),r=e.GetCamera().GetViewPort().GetRect();t.viewport(r.left,r.top,r.right,r.bottom);r.right,r.bottom;var i=e.GetShaderMananger().GetEffect(C.ShaderManager.FBODebug);i.UseProgram();var n={};C.GLShapeDrawer._usedTextureUnits=0;var o=i.GetShaderAttributeParameter(C.VSP_POSITION),a=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,a),t.bufferData(t.ARRAY_BUFFER,new Float32Array([-1,1,-1,-1,-1,-1,1,1,-1,1,-1,-1]),t.STATIC_DRAW),i.EnableAttributeArray(o.location),i.SetVertexAttribPointer(o.location,3,C.GL.FLOAT,0,0);var s=i.GetShaderAttributeParameter(C.VSP_TEXCOORDS),l=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,l),t.bufferData(t.ARRAY_BUFFER,new Float32Array([0,1,0,0,1,1,1,0]),t.STATIC_DRAW),i.EnableAttributeArray(s.location),i.SetVertexAttribPointer(s.location,2,C.GL.FLOAT,0,0);var h=new C.Matrix4,u=new C.Matrix4,p=new C.Matrix4;n[C.VSP_MODELMAT]=new C.Uniform("Matrix4",p),n[C.VSP_VIEWMAT]=new C.Uniform("Matrix4",h),n[C.VSP_PROJECTIONMAT]=new C.Uniform("Matrix4",u),n[C.FSP_SAMPLER0]=new C.Uniform("Texture2D",this.GetHardWareFrameBuffer("outline").getColorTarget(0));var c=i.GetShaderUniformMap();for(var d in this.SetUniform(i,c,n),t.drawArrays(C.GL.TRIANGLE_STRIP,0,4),this.textureBindingTargetMap){var S=this.textureBindingTargetMap[d];t.activeTexture(C.GL.TEXTURE0+parseInt(d)),t.bindTexture(S,null)}i.DisableAttributeArray(o.location),i.DisableAttributeArray(s.location),i.ReleaseShaderProgram(),t.deleteBuffer(a),t.deleteBuffer(l)},e.prototype.SetSize=function(e,t){for(var r in this.hardWareFrameBufferMap){this.hardWareFrameBufferMap[r].setSize(e,t)}},e.prototype.GetHardWareFrameBuffer=function(e){var t=this.action.GetCamera(),r=this.action.GetScene().GetResourceManager(),i=this.action.GetRenderContext().GetGLRenderContext();if(!1!==this.hardWareFrameBufferMap.hasOwnProperty(e))return this.hardWareFrameBufferMap[e];var n=new C.HardWareFrameBuffer(i);return n.setCreationParameters(1,!0,!1),n.setResourceManager(r),n.setSize(t.GetViewPort().GetRect().Width(),t.GetViewPort().GetRect().Height()),this.hardWareFrameBufferMap[e]=n},e}(C.Effect);C.OutlineEffect=e}(M3D||(M3D={})),function(h){var e=function(){function e(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(this.sviewControl=null,this.cliGeoManager=null,1===e.length){var r=e[0];this.sviewControl=r,this.cliGeoManager=new h.CLIGeometryManager(this.sviewControl),this.geoRoot=new h.SGeoGroup,this.geoRoot.SetName("基本几何")}}return e.prototype.GetRoot=function(){return this.geoRoot},e.prototype.AddGeoDataTreeRoot=function(e){if(e instanceof h.ScanBody){var t=e;this.geoRoot.addChildren(t),t.SetParentID(this.geoRoot.GetID()),this.cliGeoManager.MakePipe(t)}else e instanceof h.SBaseGeoData&&this.AddGeoData(e)},e.prototype.AddGeoData=function(e){null!=this.cliGeoManager&&null!=e&&(e.GetType()==h.ShapeType.SHAPE_POINT?this.cliGeoManager.AddPoint(e):e.GetType()==h.ShapeType.CURVE_LINE?this.cliGeoManager.AddLine(e):e.GetType()!=h.ShapeType.CURVE_POLYLINE&&e.GetType()!=h.ShapeType.CURVE_NURBSCURVE||this.cliGeoManager.AddCurve(e))},e.prototype.GetGeoDataByID=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(1===e.length){var r=e[0];this.GetGeoDataByID(this.geoRoot,r)}if(2===e.length){var i=e[0],n=null;if((r=e[1])==i.GetID())n=i;else for(var o=0,a=i.GetChildrenList();o<a.length;o++){var s=a[o];if(s instanceof h.ScanBody){if(r==s.GetID()){n=s;break}}else if(s instanceof h.SBaseGeoData){if(r==s.GetID()){n=s;break}s.GetType()==h.ShapeType.VIRTUAL_GROUP&&(n=this.GetGeoDataByID(s,r))}}return n}},e.prototype.AddGeoDataByID=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(2===e.length){var r=e[0],i=e[1];return this.AddGeoDataByID(this.geoRoot,r,i)}if(3===e.length){var n=e[0];r=e[1],i=e[2];if(null==n)return!1;if(r==n.GetID()){if(i instanceof h.ScanBody)i.SetParentID(r),this.cliGeoManager.MakePipe(i);else if(i instanceof h.SBaseGeoData){var o=i;o.SetParentID(r),h.ShapeType.VIRTUAL_GROUP==o.GetType()?n.insertChildren(n.getGroupCount(),o):n.addChildren(i),this.AddGeoData(o)}return!0}for(var a=0,s=n.GetChildrenList();a<s.length;a++){var l=s[a];l.GetType()==h.ShapeType.VIRTUAL_GROUP&&this.AddGeoDataByID(l,r,i)}return!1}},e}();h.GeometryManager=e}(M3D||(M3D={})),function(e){var t,r;(r=t=e.RenderTargetType||(e.RenderTargetType={}))[r.DEFALUT_TARGET=-1]="DEFALUT_TARGET",r[r.TEXTURE_TARGET=0]="TEXTURE_TARGET",r[r.RBO_TARGET=1]="RBO_TARGET";var i=function(){function e(){this.m_targetType=t.DEFALUT_TARGET}return e.prototype.GetTargetType=function(){return this.m_targetType},e.prototype.SetTargetType=function(e){this.m_targetType=e},e}();e.GLRenderTarget=i}(M3D||(M3D={})),function(_){var e=function(){},i=function(t){function e(){var e=t.call(this)||this;return e.shadow=0,e.shadowBias=0,e.shadowRadius=1,e}return __extends(e,t),e}(_.LightUniforms=e);_.DirectionalLightUniforms=i;var n=function(t){function e(){var e=t.call(this)||this;return e.distance=0,e.decay=0,e.shadow=0,e.shadowBias=0,e.shadowRadius=1,e.shadowCameraFar=1,e.shadowCameraNear=1e3,e}return __extends(e,t),e}(e);_.PointLightUniforms=n;var o=function(t){function e(){var e=t.call(this)||this;return e.distance=0,e.coneCos=0,e.penumbraCos=0,e.decay=0,e.shadow=0,e.shadowBias=0,e.shadowRadius=1,e}return __extends(e,t),e}(e);_.SpotLightUniforms=o;var a=function(t){function e(){var e=t.call(this)||this;return e.direction=new _.Vector3(0,1,0),e.skyColor=new _.Color(1,1,1),e.groundColor=new _.Color(1,1,1),e}return __extends(e,t),e}(e);_.HemisphereLightUniforms=a;var t=function(){function e(){this.directional=[],this.spot=[],this.point=[],this.hemisphere=[]}return e.prototype.Resize=function(){this.directional=[],this.spot=[],this.point=[],this.hemisphere=[],this.ambient=new _.Vector3},e}();_.SceneLightState=t;var r=function(){function e(){this.m_sceneLights=[],this.m_directionalLightNumber=0,this.m_pointLightNumber=0,this.m_spotLightNumber=0,this.direnctionCastShadowLightNumber=0,this.pointLightCastShadowNumber=0,this.spotLightCastShadowNumber=0,this.m_hemisphereLightNumber=0,this.m_lightUniformCatch={},this.m_state=new t}return e.prototype.AddLight=function(e){if(e){for(var t=0;t<this.m_sceneLights.length;t++)if(this.m_sceneLights[t]==e)return;this.m_sceneManager.AsynUpdateModelCacheInfo(e,!0),this.m_sceneLights.push(e)}},e.prototype.RemoveLight=function(e){for(var t=0,r=this.m_sceneLights.length;t<r;t++)if(this.m_sceneLights[t]==e){var i=this.GetLightUniform(e);i&&(i=null),this.RemoveLightUniform(e),this.m_sceneManager.AsynUpdateModelCacheInfo(e,!1);var n=this.m_sceneLights.indexOf(e);return void this.m_sceneLights.splice(n,1)}},e.prototype.RemoveAllLight=function(){this.m_sceneLights=[]},e.prototype.SetSceneManager=function(e){this.m_sceneManager=e},e.prototype.GetSceneManager=function(){return this.m_sceneManager},e.prototype.SetUp=function(e){this.m_directionalLightNumber=0,this.m_pointLightNumber=0,this.m_spotLightNumber=0,this.m_hemisphereLightNumber=0,this.m_state.Resize();var t=e.GetView().Clone(),r=0,i=0,n=0;this.m_sceneLights.length;for(var o=0;o<this.m_sceneLights.length;o++){var a=this.m_sceneLights[o];if(a.IsTurnOn()){var s=a.GetLightSourceType(),l=this.GetLightUniform(a),h=a.GetIntensity(),u=a.GetLightColor().Multiply(h).Clone();if(s==_.LightType.LightType_Ambient)r+=u.r,i+=u.g,n+=u.b;else if(s==_.LightType.LightType_Directional){var p=l;p.color=u.Clone();var c=a.GetNodeWorldPosition(),d=void 0;if((d=a.IsInWorld()?t.Multiply(new _.Vector4(a.GetWorldDirection(),0)):a.GetWorldDirection()).Normalize(),p.direction=d,a.CastShadow()){var S=a.GetLightShadow();p.shadow=1,p.shadowBias=S.Bias(),p.shadowMapSize=S.GetMapSize(),p.shadowRadius=S.Radius()}this.m_state.directional.push(p),this.m_directionalLightNumber++}else if(s==_.LightType.LightType_Point){var f=l,m=a;f.color=u;c=new _.Vector3;c=a.IsInWorld()?t.Multiply(new _.Vector4(a.GetNodeWorldPosition(),1)):a.GetNodeWorldPosition(),f.position=c,f.distance=m.Distance(),f.decay=m.Decay(),m.CastShadow(),this.m_state.point.push(f),this.m_pointLightNumber++}else if(s==_.LightType.LightType_Spot){var y=l,T=a;y.color=u,y.distance=T.Distance(),y.decay=T.Decay();var M=T.Angle()*_.DEGTORAD,g=T.Penumbra()*_.DEGTORAD;y.coneCos=Math.cos(M),y.penumbraCos=Math.cos(M*(1-g));c=new _.Vector3,d=new _.Vector3;d=a.IsInWorld()?(c=t.Multiply(new _.Vector4(a.GetNodeWorldPosition(),1)),t.Multiply(new _.Vector4(a.GetWorldDirection(),1))):(c=a.GetNodeWorldPosition(),a.GetWorldDirection()),y.position=c.Clone(),d.Normalize(),y.direction=d.Clone(),T.CastShadow(),this.m_spotLightNumber++,this.m_state.spot.push(y)}else if(s==_.LightType.LightType_Hemisphere){var v=l,C=a;c=new _.Vector3;c=a.IsInWorld()?t.Multiply(new _.Vector4(a.GetNodeWorldPosition(),1)):a.GetNodeWorldPosition(),v.direction=c,v.direction.Normalize(),v.skyColor=u.Clone(),v.groundColor=C.GroundColor().Multiply(h).Clone(),this.m_hemisphereLightNumber++,this.m_state.hemisphere.push(v)}}}this.m_state.ambient.x=r,this.m_state.ambient.y=i,this.m_state.ambient.z=n,this.m_state.hash=this.m_directionalLightNumber.toString()+","+this.m_pointLightNumber.toString()+","+this.m_spotLightNumber.toString()+","+this.m_hemisphereLightNumber.toString()},e.prototype.CreateDefaultLights=function(){if(this.m_sceneManager&&this.m_sceneManager.GetModel()){var e=this.m_sceneManager.GetModel().GetTotalWorldBoundingBox(),t=e.Center().Clone(),r=(this.CreateLight(_.LightType.LightType_Ambient),this.CreateLight(_.LightType.LightType_Directional));if(null!=r){r.SetLightColor(_.Color.WHITE().Clone()),r.SetIntensity(.7);var i=new _.Vector3(-1,.4,.7);i.Normalized();var n=new _.Quaternion(new _.Vector3(0,0,1),i),o=t.Add(i.Multiply(.5*e.Length()));r.SetWorldRotation(n),r.SetWorldPosition(o),r.SetShowAllSign(!1),r.SetShowSimpleSign(!1),r.SetName("directionalLight"),this.AddLight(r)}var a=this.CreateLight(_.LightType.LightType_Directional);if(null!=a){a.SetLightColor(_.Color.WHITE().Clone()),a.SetIntensity(.6);n=new _.Quaternion(new _.Vector3(0,0,1),new _.Vector3(1,.4,.7));a.SetWorldRotation(n),a.SetWorldPosition(t),a.SetShowAllSign(!1),a.SetShowSimpleSign(!1),a.SetName("directionalLigh1")}var s=this.CreateLight(_.LightType.LightType_Directional);if(null!=s){s.SetLightColor(_.Color.WHITE().Clone()),s.SetIntensity(.6);n=new _.Quaternion(new _.Vector3(0,0,1),new _.Vector3(0,1,-1));s.SetWorldRotation(n),s.SetWorldPosition(t),s.SetShowAllSign(!1),s.SetShowSimpleSign(!1),s.SetName("directionalLigh1")}var l=this.CreateLight(_.LightType.LightType_Hemisphere);null!=l&&(l.SetIntensity(.5),l.SetWorldPosition(new _.Vector3(0,1,0)),l.SetLightColor(_.Color.WHITE().Clone()),l.SetGroundColor(_.Color.WHITE().Clone()),l.SetName("heimisphreLight"),l.SetShowAllSign(!1),this.AddLight(l));var h=this.CreateLight(_.LightType.LightType_Point);null!=h&&(h.SetIntensity(1),h.SetWorldPosition(t),h.SetLightColor(_.Color.WHITE().Clone()),h.SetDistance(2e3),h.SetDecay(1),h.SetName("poitLight"),h.SetShowAllSign(!1));var u=this.CreateLight(_.LightType.LightType_Spot);if(null!==u&&void 0!==h){u.SetIntensity(1);var p=new _.Vector3(1,1,1);p.Normalize(),u.SetWorldPosition(t.Add(p.Multiply(.2*e.Length())));n=new _.Quaternion(45,new _.Vector3(-1,0,0));u.SetLightColor(_.Color.WHITE().Clone()),u.SetDistance(2e3),u.SetDecay(1),u.SetAngle(30),u.SetPenumbra(15),u.SetWorldRotation(n),u.SetName("spotLight"),u.SetShowAllSign(!1)}}},e.prototype.CreateLight=function(e){var t=null;switch(e){case _.LightType.LightType_Base:t=new _.BaseLight;break;case _.LightType.LightType_Ambient:t=new _.AmbientLight;break;case _.LightType.LightType_Directional:t=new _.DirectionalLight;break;case _.LightType.LightType_Point:t=new _.PointLight;break;case _.LightType.LightType_Spot:t=new _.SpotLight;break;case _.LightType.LightType_Hemisphere:t=new _.HemisphereLight}return t},e.prototype.DirectionalLightNumber=function(){return this.m_directionalLightNumber},e.prototype.SetDirectionalLightNumber=function(e){this.m_directionalLightNumber=e},e.prototype.PointLightNumber=function(){return this.m_pointLightNumber},e.prototype.SetPointLightNumber=function(e){this.m_pointLightNumber=e},e.prototype.SpotLightNumber=function(){return this.m_spotLightNumber},e.prototype.SetSpotLightNumber=function(e){this.m_spotLightNumber=e},e.prototype.GetState=function(){return this.m_state},e.prototype.GetAllLight=function(){return this.m_sceneLights},e.prototype.HemisphereLightNumber=function(){return this.m_hemisphereLightNumber},e.prototype.SetHemisphereLightNumber=function(e){this.m_hemisphereLightNumber=e},e.prototype.GetLightUniform=function(e){if(!e)return null;var t=null,r=this.m_lightUniformCatch[e.GetID()];if(null!=r)return r;switch(e.GetLightSourceType()){case _.LightType.LightType_Directional:t=new i;break;case _.LightType.LightType_Point:t=new n;break;case _.LightType.LightType_Spot:t=new o;break;case _.LightType.LightType_Hemisphere:t=new a}return this.m_lightUniformCatch[e.GetID()]=t},e.prototype.RemoveLightUniform=function(e){e&&delete this.m_lightUniformCatch[e.GetID()]},e}();_.LightManager=r}(M3D||(M3D={})),function(e){e.ShaderChunkStrings={},e.ShaderChunkStrings.begin_vertex=["vec3 transformed = vec3( a_position );"].join("\n"),e.ShaderChunkStrings.beginnormal_vertex=["vec3 objectNormal = vec3( a_normal );"].join("\n"),e.ShaderChunkStrings.bsdfs=["float punctualLightIntensityToIrradianceFactor( const in float lightDistance, const in float cutoffDistance, const in float decayExponent ) {","\tif( decayExponent > 0.0 ) {","#if defined ( PHYSICALLY_CORRECT_LIGHTS )","\t\t// based upon Frostbite 3 Moving to Physically-based Rendering","\t\t// page 32, equation 26: E[window1]","\t\t// https://seblagarde.files.wordpress.com/2015/07/course_notes_moving_frostbite_to_pbr_v32.pdf","\t\t// this is intended to be used on spot and point lights who are represented as luminous intensity","\t\t// but who must be converted to luminous irradiance for surface lighting calculation","\t\tfloat distanceFalloff = 1.0 / max( pow( lightDistance, decayExponent ), 0.01 );","\t\tfloat maxDistanceCutoffFactor = pow2( saturate( 1.0 - pow4( lightDistance / cutoffDistance ) ) );","\t\treturn distanceFalloff * maxDistanceCutoffFactor;","#else","\t\treturn pow( saturate( -lightDistance / cutoffDistance + 1.0 ), decayExponent );","#endif","\t}","\treturn 1.0;","}","vec3 BRDF_Diffuse_Lambert( const in vec3 diffuseColor ) {","\treturn RECIPROCAL_PI * diffuseColor;","} // validated","vec3 F_Schlick( const in vec3 specularColor, const in float VdotH ) {","\t// Original approximation by Christophe Schlick '94","\t// float fresnel = pow( 1.0 - dotLH, 5.0 );","\t// Optimized variant (presented by Epic at SIGGRAPH '13)","\t// https://cdn2.unrealengine.com/Resources/files/2013SiggraphPresentationsNotes-26915738.pdf","  return specularColor + (1.0 - specularColor) * pow(clamp(1.0 - VdotH, 0., 1.), 5.0);","} // validated","vec3 fresnelSchlickRoughness(float dotNV, vec3 F0, float roughness)","{","    return F0 + (max(vec3(1.0 - roughness), F0) - F0) * pow(1.0 - dotNV, 5.0);","}","// Microfacet Models for Refraction through Rough Surfaces - equation (34)","// http://graphicrants.blogspot.com/2013/08/specular-brdf-reference.html","// alpha is 'roughness squared' in Disney’s reparameterization","float G_GGX_Smith( const in float alpha, const in float dotNL, const in float dotNV ) {","\t// geometry term (normalized) = G(l)⋅G(v) / 4(n⋅l)(n⋅v)","\t// also see #12151","\tfloat a2 = pow2( alpha );","\tfloat gl = dotNL + sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNL ) );","\tfloat gv = dotNV + sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNV ) );","\treturn 1.0 / ( gl * gv );","} // validated","// Moving Frostbite to Physically Based Rendering 3.0 - page 12, listing 2","// https://seblagarde.files.wordpress.com/2015/07/course_notes_moving_frostbite_to_pbr_v32.pdf","float G_GGX_SmithCorrelated( const in float alpha, const in float dotNL, const in float dotNV ) {","\tfloat a2 = pow2( alpha );","\t// dotNL and dotNV are explicitly swapped. This is not a mistake.","\tfloat gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNV ) );","\tfloat gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNL ) );","\treturn 0.5 / max( gv + gl, EPSILON );","}","// Microfacet Models for Refraction through Rough Surfaces - equation (33)","// http://graphicrants.blogspot.com/2013/08/specular-brdf-reference.html","// alpha is 'roughness squared' in Disney’s reparameterization","float D_GGX( const in float alpha, const in float dotNH ) {","\tfloat a2 = pow2( alpha );","\tfloat denom = pow2( dotNH ) * ( a2 - 1.0 ) + 1.0; // avoid alpha = 0 with dotNH = 1","\treturn RECIPROCAL_PI * a2 / pow2( denom );","}","// GGX Distribution, Schlick Fresnel, GGX-Smith Visibility","vec3 BRDF_Specular_GGX( const in IncidentLight incidentLight, const in GeometricContext geometry, const in vec3 specularColor, const in float roughness ,out vec3 ks) {","\tfloat alpha = pow2( roughness ); // UE4's roughness","\tvec3 halfDir = normalize( incidentLight.direction + geometry.viewDir );","\tfloat dotNL = saturate( dot( geometry.normal, incidentLight.direction ) );","\tfloat dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );","\tfloat dotNH = saturate( dot( geometry.normal, halfDir ) );","\tfloat dotVH = saturate( dot( geometry.viewDir, halfDir ) );","\tvec3 F = F_Schlick( specularColor, dotVH );","ks = F;","\tfloat G = G_GGX_SmithCorrelated( alpha, dotNL, dotNV );","\tfloat D = D_GGX( alpha, dotNH );","\treturn F * ( G * D );","} // validated","// ref: https://www.unrealengine.com/blog/physically-based-shading-on-mobile - environmentBRDF for GGX on mobile","vec3 BRDF_Specular_GGX_Environment( const in GeometricContext geometry, const in vec3 specularColor, const in float roughness ) {","\tfloat dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );","\tconst vec4 c0 = vec4( - 1, - 0.0275, - 0.572, 0.022 );","\tconst vec4 c1 = vec4( 1, 0.0425, 1.04, - 0.04 );","\tvec4 r = roughness * c0 + c1;","\tfloat a004 = min( r.x * r.x, exp2( - 9.28 * dotNV ) ) * r.x + r.y;","\tvec2 AB = vec2( -1.04, 1.04 ) * a004 + r.zw;","\treturn specularColor * AB.x + AB.y;","} // validated","float G_BlinnPhong_Implicit( /* const in float dotNL, const in float dotNV */ ) {","\t// geometry term is (n dot l)(n dot v) / 4(n dot l)(n dot v)","\treturn 0.25;","}","float D_BlinnPhong( const in float shininess, const in float dotNH ) {","\treturn RECIPROCAL_PI * ( shininess * 0.5 + 1.0 ) * pow( dotNH, shininess );","}","vec3 BRDF_Specular_BlinnPhong( const in IncidentLight incidentLight, const in GeometricContext geometry, const in vec3 specularColor, const in float shininess ) {","\tvec3 halfDir = normalize( incidentLight.direction + geometry.viewDir );","\t//float dotNL = saturate( dot( geometry.normal, incidentLight.direction ) );","\t//float dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );","\tfloat dotNH = saturate( dot( geometry.normal, halfDir ) );","\tfloat dotLH = saturate( dot( incidentLight.direction, halfDir ) );","\tvec3 F = F_Schlick( specularColor, dotLH );","\tfloat G = G_BlinnPhong_Implicit( /* dotNL, dotNV */ );","\tfloat D = D_BlinnPhong( shininess, dotNH );","\treturn F * ( G * D );","} // validated","// source: http://simonstechblog.blogspot.ca/2011/12/microfacet-brdf.html","float GGXRoughnessToBlinnExponent( const in float ggxRoughness ) {","\treturn ( 2.0 / pow2( ggxRoughness + 0.0001 ) - 2.0 );","}","float BlinnExponentToGGXRoughness( const in float blinnExponent ) {","\treturn sqrt( 2.0 / ( blinnExponent + 2.0 ) );","}","#if defined(PHYSICAL) ","vec3 BRDF_Specular_GGX_Environment_texture( const in GeometricContext geometry,const in vec3 specularColor, const in float roughness ) {","\tfloat dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );"," vec3 brdf = (texture2D(lut, vec2(dotNV, 1.0-roughness))).rgb;","\treturn specularColor * brdf.x + brdf.y;","} // validated","vec3 getSpecularDominantDir(const in vec3 N, const in vec3 R, const in float realRoughness)","{","\tvec3 dominant;","   bool uSpecularPeak = true;","\tif (uSpecularPeak == true) {","\t\tfloat smoothness = 1.0 - realRoughness;","\t\tfloat lerpFactor = smoothness * (sqrt(smoothness) + realRoughness);","\t\tdominant = mix(N, R, lerpFactor);","\t}","\telse {","\t\tdominant = R;","\t}","\treturn dominant;","}","float occlusionHorizon(const in vec3 R, const in vec3 normal)","{","bool occlusion = true;","if (occlusion == false)","\treturn 1.0;","float factor = clamp(1.0 + dot(R, normal), 0.0, 1.0);","return factor * factor;","}","#endif"].join("\n"),e.ShaderChunkStrings.clip_fragment=["#if defined(USE_CLIP)","    if(u_enableClip)","    {","        float dPara = u_clipPlane.w;","        float testvalue = (dot(-vec3(vViewPosition.xyz),vec3(u_clipPlane.xyz))+dPara);","        if( testvalue<0.0)","        {","            discard;","        }","    }","#endif"].join("\n"),e.ShaderChunkStrings.clip_pars_fragment=["#if defined(USE_CLIP)","uniform vec4 u_clipPlane;","uniform bool u_enableClip;","//varying vec3 vViewPosition;","#endif "].join("\n"),e.ShaderChunkStrings.clip_pars_vertex=["#if defined(USE_CLIP) ","//varying vec3 vViewPosition;","#endif "].join("\n"),e.ShaderChunkStrings.common=["#define PI 3.14159265359","#define PI2 6.28318530718","#define PI_HALF 1.5707963267949","#define RECIPROCAL_PI 0.31830988618","#define RECIPROCAL_PI2 0.15915494","#define LOG2 1.442695","#define EPSILON 1e-6","#define saturate(a) clamp( a, 0.001, 1.0 )","#define whiteCompliment(a) ( 1.0 - saturate( a ) )","float pow2( const in float x ) { return x*x; }","float pow3( const in float x ) { return x*x*x; }","float pow4( const in float x ) { float x2 = x*x; return x2*x2; }","float average( const in vec3 color ) { return dot( color, vec3( 0.3333 ) ); }","// expects values in the range of [0,1]x[0,1], returns values in the [0,1] range.","// do not collapse into a single function per: http://byteblacksmith.com/improvements-to-the-canonical-one-liner-glsl-rand-for-opengl-es-2-0/","struct IncidentLight {","       vec3 color;","       vec3 direction;","       bool visible;","};","struct ReflectedLight {","       vec3 directDiffuse;","       vec3 directSpecular;","       vec3 indirectDiffuse;","       vec3 indirectSpecular;","};","struct GeometricContext {","       vec3 position;","       vec3 normal;","       vec3 viewDir;","};","vec3 transformDirection( in vec3 dir, in mat4 matrix ) {","       return normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );","}","// http://en.wikibooks.org/wiki/GLSL_Programming/Applying_Matrix_Transformations","vec3 inverseTransformDirection( in vec3 dir, in mat4 matrix ) {","       return normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );","}","// https://en.wikipedia.org/wiki/Relative_luminance","float linearToRelativeLuminance( const in vec3 color ) {","       vec3 weights = vec3( 0.2126, 0.7152, 0.0722 );","       return dot( weights, color.rgb );","}"].join("\n"),e.ShaderChunkStrings.defaultnormal_vertex=["vec3 transformedNormal = mat3(normalMatrix) * objectNormal;","#ifdef FLIP_SIDED","       transformedNormal = - transformedNormal;","#endif"].join("\n"),e.ShaderChunkStrings.lights_pars=[" uniform vec3 ambientLightColor;","vec3 getAmbientLightIrradiance( const in vec3 ambientLightColor ) {","       vec3 irradiance = ambientLightColor;","       #ifndef PHYSICALLY_CORRECT_LIGHTS","               irradiance *= PI;","       #endif","       return irradiance;","}","#if NUM_DIR_LIGHTS > 0","       struct DirectionalLight {","               vec3 direction;","               vec3 color;","               int shadow;","               float shadowBias;","               float shadowRadius;","               vec2 shadowMapSize;","       };","       uniform DirectionalLight directionalLights[ NUM_DIR_LIGHTS ];","#if defined(USE_LIGHT_MARK)","       uniform bool directionMark[ NUM_DIR_LIGHTS ];","#endif","       void getDirectionalDirectLightIrradiance( const in DirectionalLight directionalLight, const in GeometricContext geometry, out IncidentLight directLight ) {","               directLight.color = directionalLight.color;","               directLight.direction =normalize( vec3(/*viewMatrix**/vec4(directionalLight.direction,0.0)));","               directLight.visible = true;","       }","#endif","#if NUM_POINT_LIGHTS > 0","       struct PointLight {","               vec3 position;","               vec3 color;","               float distance;","               float decay;","               int shadow;","               float shadowBias;","               float shadowRadius;","               vec2 shadowMapSize;","               float shadowCameraNear;","               float shadowCameraFar;","       };","       uniform PointLight pointLights[ NUM_POINT_LIGHTS ];","#if defined(USE_LIGHT_MARK)","       uniform bool pointMark[ NUM_POINT_LIGHTS ];","#endif","       // directLight is an out parameter as having it as a return value caused compiler errors on some devices","       void getPointDirectLightIrradiance( const in PointLight pointLight, const in GeometricContext geometry, out IncidentLight directLight ) {","               vec3 lVector = vec3(/*viewMatrix**/vec4(pointLight.position,1.0)) - geometry.position;","               directLight.direction = normalize( lVector );","               float lightDistance = length( lVector );","               directLight.color = pointLight.color;","               directLight.color *= punctualLightIntensityToIrradianceFactor( lightDistance, pointLight.distance, pointLight.decay );","               directLight.visible = ( directLight.color != vec3( 0.0 ) );","       }","#endif","#if NUM_SPOT_LIGHTS > 0","       struct SpotLight {","               vec3 position;","               vec3 direction;","               vec3 color;","               float distance;","               float decay;","               float coneCos;","               float penumbraCos;","               int shadow;","               float shadowBias;","               float shadowRadius;","               vec2 shadowMapSize;","       };","       uniform SpotLight spotLights[ NUM_SPOT_LIGHTS ];","#if defined(USE_LIGHT_MARK)","       uniform bool spotMark[ NUM_SPOT_LIGHTS ];","#endif","       // directLight is an out parameter as having it as a return value caused compiler errors on some devices","       void getSpotDirectLightIrradiance( const in SpotLight spotLight, const in GeometricContext geometry, out IncidentLight directLight  ) {","               vec3 lVector = vec3(/*viewMatrix**/vec4(spotLight.position,1.0)) - geometry.position;","               directLight.direction = normalize( lVector );","               float lightDistance = length( lVector );","               float angleCos = dot( directLight.direction,normalize( vec3(/*viewMatrix**/vec4( spotLight.direction,0.0))) );","               if ( angleCos > spotLight.coneCos ) {","                       float spotEffect = smoothstep( spotLight.coneCos, spotLight.penumbraCos, angleCos );","                       directLight.color = spotLight.color;","                       directLight.color *= spotEffect * punctualLightIntensityToIrradianceFactor( lightDistance, spotLight.distance, spotLight.decay );","                       directLight.visible = true;","               } else {","                       directLight.color = vec3( 0.0 );","                       directLight.visible = false;","               }","       }","#endif","#if NUM_HEMI_LIGHTS > 0","\t\tstruct HemisphereLight {","\t\t\t\tvec3 direction;","\t\t\t\tvec3 skyColor;","\t\t\t\tvec3 groundColor;","\t\t\t};","\t\t\tuniform HemisphereLight hemisphereLights[NUM_HEMI_LIGHTS];","\t\t\tvec3 getHemisphereLightIrradiance(const in HemisphereLight hemiLight, const in GeometricContext geometry) {","\t\t\t\tfloat dotNL = dot(geometry.normal, normalize(vec3(/*viewMatrix**/vec4(hemiLight.direction,0.0))));","\t\t\t\tfloat hemiDiffuseWeight = 0.5 * dotNL + 0.5;","\t\t\t\tvec3 irradiance = mix(hemiLight.groundColor, hemiLight.skyColor, hemiDiffuseWeight);","#ifndef PHYSICALLY_CORRECT_LIGHTS","\t\t\t\tirradiance *= PI;","#endif","\t\t\t\treturn irradiance;","\t\t\t}","#endif","#if defined( USE_ENV_TEXTURE ) && defined( PHYSICAL )","       vec3 getLightProbeIndirectIrradiance( /*const in SpecularLightProbe specularLightProbe,*/ const in GeometricContext geometry, const in int maxMIPLevel ) {","               vec3 worldNormal = inverseTransformDirection( geometry.normal, viewMatrix );","               #ifdef ENVTEXTURE_TYPE_CUBE","                       vec3 queryVec = vec3(  worldNormal.x, worldNormal.yz );","                       // TODO: replace with properly filtered cubemaps and access the irradiance LOD level, be it the last LOD level","                       // of a specular cubemap, or just the default level of a specially created irradiance cubemap.","                               // force the bias high to get the last LOD level as it is the most blurred.","                               vec4 envMapColor = textureCube( envDiffuseTexture, queryVec );","                       envMapColor.rgb = envMapTexelToLinear( envMapColor ).rgb;","               #else","                       vec4 envMapColor = vec4( 0.0 );","               #endif","               return PI * envMapColor.rgb * envMapIntensity;","       }","       // taken from here: http://casual-effects.blogspot.ca/2011/08/plausible-environment-lighting-in-two.html","       float getSpecularMIPLevel( const in float blinnShininessExponent, const in int maxMIPLevel ) {","               //float envMapWidth = pow( 2.0, maxMIPLevelScalar );","               //float desiredMIPLevel = log2( envMapWidth * sqrt( 3.0 ) ) - 0.5 * log2( pow2( blinnShininessExponent ) + 1.0 );","               float maxMIPLevelScalar = float( maxMIPLevel );","               float desiredMIPLevel = maxMIPLevelScalar + 0.79248 - 0.5 * log2( pow2( blinnShininessExponent ) + 1.0 );","               // clamp to allowable LOD ranges.","               return clamp( desiredMIPLevel, 0.0, maxMIPLevelScalar );","       }","\t\tfloat linRoughnessToMipmap(float roughnessLinear,const in int maxMIPLevel)","\t\t{","           float maxMIPLevelScalar = float( maxMIPLevel );","\t\t\treturn sqrt(roughnessLinear)*(maxMIPLevelScalar - 1.0);","\t\t}","       vec3 getLightProbeIndirectRadiance( /*const in SpecularLightProbe specularLightProbe,*/ const in GeometricContext geometry, const in float blinnShininessExponent, const in int maxMIPLevel ) {","               #ifdef ENVTEXTURE_MODE_REFLECTION","                       vec3 reflectVec = reflect( -geometry.viewDir, geometry.normal );","               #else","                       vec3 reflectVec = refract( -geometry.viewDir, geometry.normal, refractionRatio );","               #endif","               reflectVec = inverseTransformDirection( reflectVec, viewMatrix );","               float specularMIPLevel = linRoughnessToMipmap( blinnShininessExponent, maxMIPLevel );","#ifdef USE_LOCAL_CUBEMAP","reflectVec = GetParallaxCorrectedReflect( normalize(reflectVec), boxMax, boxMin, cubeMapWorldPosition, vWorldPosition);","#endif","               #ifdef ENVTEXTURE_TYPE_CUBE","                       vec3 queryReflectVec = vec3(  reflectVec.x, reflectVec.yz );","                       #ifdef TEXTURE_LOD_EXT","                               vec4 envMapColor = textureCubeLodEXT( envTexture, queryReflectVec, specularMIPLevel );","                       #else","                               vec4 envMapColor = textureCube( envTexture, queryReflectVec, specularMIPLevel );","                       #endif","                       envMapColor.rgb = envMapTexelToLinear( envMapColor ).rgb;","               #elif defined( ENVMAP_TYPE_EQUIREC )","                       vec2 sampleUV;","                       sampleUV.y = asin( clamp( reflectVec.y, - 1.0, 1.0 ) ) * RECIPROCAL_PI + 0.5;","                       sampleUV.x = atan( reflectVec.z, reflectVec.x ) * RECIPROCAL_PI2 + 0.5;","                       #ifdef TEXTURE_LOD_EXT","                               vec4 envMapColor = texture2DLodEXT( envTexture, sampleUV, specularMIPLevel );","                       #else","                               vec4 envMapColor = texture2D( envTexture, sampleUV, specularMIPLevel );","                       #endif","                       envMapColor.rgb = envMapTexelToLinear( envMapColor ).rgb;","               #elif defined( ENVMAP_TYPE_SPHERE )","                       vec3 reflectView = normalize( ( viewMatrix * vec4( reflectVec, 0.0 ) ).xyz + vec3( 0.0,0.0,1.0 ) );","                       #ifdef TEXTURE_LOD_EXT","                               vec4 envMapColor = texture2DLodEXT( envTexture, reflectView.xy * 0.5 + 0.5, specularMIPLevel );","                       #else","                               vec4 envMapColor = texture2D( envTexture, reflectView.xy * 0.5 + 0.5, specularMIPLevel );","                       #endif","                       envMapColor.rgb = envMapTexelToLinear( envMapColor ).rgb;","               #endif","               return envMapColor.rgb * envMapIntensity;","       }","#endif"].join("\n"),e.ShaderChunkStrings.lights_phong_fragment=["BlinnPhongMaterial material;","material.diffuseColor = diffuseColor.rgb;","material.specularColor = specular.rgb;","material.specularShininess = shininess;","material.specularStrength = specularStrength;"].join("\n"),e.ShaderChunkStrings.lights_phong_pars_fragment=["varying vec3 vViewPosition;","#ifndef FLAT_SHADED","       varying vec3 vNormal;","#endif","struct BlinnPhongMaterial {","       vec3    diffuseColor;","       vec3    specularColor;","       float   specularShininess;","       float   specularStrength;","};","void RE_Direct_BlinnPhong( const in IncidentLight directLight, const in GeometricContext geometry, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {","               float dotNL = saturate( dot( geometry.normal, directLight.direction ) );","               vec3 irradiance = dotNL * directLight.color;","        #ifndef PHYSICALLY_CORRECT_LIGHTS","             irradiance *= PI; // punctual light","        #endif","       reflectedLight.directDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );","       reflectedLight.directSpecular += irradiance * BRDF_Specular_BlinnPhong( directLight, geometry, material.specularColor, material.specularShininess ) * material.specularStrength;","}","void RE_IndirectDiffuse_BlinnPhong( const in vec3 irradiance, const in GeometricContext geometry, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {","       reflectedLight.indirectDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );","}"," #define RE_Direct                           RE_Direct_BlinnPhong"," #define RE_IndirectDiffuse          RE_IndirectDiffuse_BlinnPhong","#define Material_LightProbeLOD( material )     (0)"].join("\n"),e.ShaderChunkStrings.lights_template=["/**"," * This is a template that can be used to light a material, it uses pluggable"," * RenderEquations (RE)for specific lighting scenarios."," *"," * Instructions for use:"," * - Ensure that both RE_Direct, RE_IndirectDiffuse and RE_IndirectSpecular are defined"," * - If you have defined an RE_IndirectSpecular, you need to also provide a Material_LightProbeLOD. <---- ???"," * - Create a material parameter that is to be passed as the third parameter to your lighting functions."," *"," * TODO:"," * - Add area light support."," * - Add sphere light support."," * - Add diffuse light probe (irradiance cubemap) support."," */","GeometricContext geometry;","geometry.position = - vViewPosition;","geometry.normal = normal;","geometry.viewDir = normalize( vViewPosition );","IncidentLight directLight;","vec4 coord = vec4(1.0,0.0,0.0,1.0);","#if ( NUM_POINT_LIGHTS > 0 ) && defined( RE_Direct )","       PointLight pointLight;","       for ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {","#if defined(USE_LIGHT_MARK)","               if(pointMark[ i ] == true){","#endif","\t\t\tpointLights[ i ].position;","\t\t\tpointLights[ i ].color;","\t\t\tpointLights[ i ].distance;","\t\t\tpointLights[ i ].decay;","\t\t\tpointLights[ i ].shadow;","\t\t\tpointLights[ i ].shadowBias;","\t\t\tpointLights[ i ].shadowRadius;","\t\t\tpointLights[ i ].shadowMapSize;","\t\t\tpointLights[ i ].shadowCameraNear;","\t\t\tpointLights[ i ].shadowCameraFar;","               pointLight = pointLights[ i ];","               getPointDirectLightIrradiance( pointLight, geometry, directLight );","//coord = vPointShadowCoord[i];","       #ifdef USE_SHADOWMAP","               vec3 lVector = pointLight.position - geometry.position;","               float bias = max(pointLight.shadowBias*10.0*(1.0-dot(normalize(lVector), geometry.normal)), pointLight.shadowBias);","               directLight.color *= bool(pointLight.shadow)?(getPointShadow(pointShadowMap[i],pointLight.shadowMapSize, bias, pointLight.shadowRadius, vPointShadowCoord[i],pointLight.shadowCameraNear, pointLight.shadowCameraFar)):1.0 ;","       #endif","               RE_Direct( directLight, geometry, material, reflectedLight );","#if defined(USE_LIGHT_MARK)","   }","#endif"," }","#endif","#if ( NUM_SPOT_LIGHTS > 0 ) && defined( RE_Direct )","       SpotLight spotLight;","       for ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {","\t\t\tspotLights[ i ].position;","\t\t\tspotLights[ i ].direction;","\t\t\tspotLights[ i ].color;","\t\t\tspotLights[ i ].distance;","\t\t\tspotLights[ i ].decay;","\t\t\tspotLights[ i ].coneCos;","\t\t\tspotLights[ i ].penumbraCos;","\t\t\tspotLights[ i ].shadow;","\t\t\tspotLights[ i ].shadowBias;","\t\t\tspotLights[ i ].shadowRadius;","\t\t\tspotLights[ i ].shadowMapSize;","               spotLight = spotLights[ i ];","#if defined(USE_LIGHT_MARK)","               if(spotMark[ i ] == true){","#endif","               getSpotDirectLightIrradiance( spotLight, geometry, directLight );","       #ifdef USE_SHADOWMAP","               vec3 lVector = spotLight.position - geometry.position;","               float bias = max(spotLight.shadowBias*3.0*(1.0-dot(normalize(lVector), geometry.normal)), spotLight.shadowBias);","               directLight.color *= bool(spotLight.shadow)?(getShadow(spotShadowMap[i],spotLight.shadowMapSize, bias, spotLight.shadowRadius, vSpotShadowCoord[i])):1.0 ;","       #endif","               RE_Direct( directLight, geometry, material, reflectedLight );","#if defined(USE_LIGHT_MARK)","   }","#endif","}","#endif","float ss = 1.0;","#if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct )","       DirectionalLight directionalLight;","       for ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {","             directionalLights[ i ] . direction;","             directionalLights[ i ] . color;","             directionalLights[ i ] . shadow;","             directionalLights[ i ] . shadowBias;","             directionalLights[ i ] . shadowRadius;","             directionalLights[ i ] . shadowMapSize;","               directionalLight = directionalLights[ i ];","#if defined(USE_LIGHT_MARK)","               if(directionMark[ i ] == true){","#endif","               getDirectionalDirectLightIrradiance( directionalLight, geometry, directLight );","        #ifdef USE_SHADOWMAP","               vec3 lVector = directionalLight.direction;","               float bias = max(directionalLight.shadowBias*10.0*(1.0-dot(normalize(lVector), geometry.normal)), directionalLight.shadowBias);","               directLight.color *=bool( directionalLight.shadow)?(getShadow(directionalShadowMap[i],directionalLight.shadowMapSize,bias, directionalLight.shadowRadius,    vDirectionalShadowCoord[i])):1.0 ;","        #endif","               RE_Direct( directLight, geometry, material, reflectedLight );","#if defined(USE_LIGHT_MARK)","   }","#endif","}","#endif","#if defined( RE_IndirectDiffuse )","       vec3 irradiance = getAmbientLightIrradiance( ambientLightColor );","#if ( NUM_HEMI_LIGHTS > 0 )","\tfor (int i = 0; i < NUM_HEMI_LIGHTS; i++) {","\t\themisphereLights[i].direction;","\t\themisphereLights[i].skyColor;","\t\themisphereLights[i].groundColor;","\t\tirradiance += getHemisphereLightIrradiance(hemisphereLights[i], geometry);","\t}","#endif","       #if defined( USE_ENV_TEXTURE ) && defined( PHYSICAL )","               // TODO, replace 8 with the real maxMIPLevel","              // irradiance = vec3(0.0);","               irradiance += getLightProbeIndirectIrradiance( /*lightProbe,*/ geometry, 9 );","       #endif","       RE_IndirectDiffuse( irradiance, geometry, material, reflectedLight );","#if defined(USE_MATCAPMAP) && !defined(PHYSICAL)","irradiance = GetMatcapIndirectLight(geometry);","reflectedLight.indirectDiffuse = (irradiance) /** (material.diffuseColor)*/;","#endif","#endif","#if defined( USE_ENV_TEXTURE ) && defined( RE_IndirectSpecular )","       // TODO, replace 8 with the real maxMIPLevel","       vec3 radiance = getLightProbeIndirectRadiance( /*specularLightProbe,*/ geometry, ( material.specularRoughness ), 9 );","   #ifndef STANDARD","   vec3 clearCoatRadiance = getLightProbeIndirectRadiance( /*specularLightProbe,*/ geometry, ( material.clearCoatRoughness ), 9 );","   #else","   vec3 clearCoatRadiance = vec3( 0.0 );","   #endif","   RE_IndirectSpecular( radiance, clearCoatRadiance, geometry, material, reflectedLight );","#endif"].join("\n"),e.ShaderChunkStrings.normalmap_pars_fragment=["#ifdef USE_NORMALMAP","uniform sampler2D normalMap;","uniform vec2 normalScale;","vec3 perturbNormal2Arb(vec3 eye_pos, vec3 surf_norm) {","\tvec3 q0 = vec3(dFdx(eye_pos.x), dFdx(eye_pos.y), dFdx(eye_pos.z));","\tvec3 q1 = vec3(dFdy(eye_pos.x), dFdy(eye_pos.y), dFdy(eye_pos.z));","\tvec2 st0 = dFdx(vUv.st);","\tvec2 st1 = dFdy(vUv.st);","\tvec3 S = normalize(q0 * st1.t - q1 * st0.t);","\tvec3 T = normalize(-q0 * st1.s + q1 * st0.s);","\tvec3 N = normalize(surf_norm);","\tvec3 mapN = texture2D(normalMap, vUv).xyz * 2.0 - 1.0;","\tmapN.xy = normalScale * mapN.xy;","\tmat3 tsn = mat3(S, T, N);","\treturn normalize(tsn * mapN);","}","#endif"].join("\n"),e.ShaderChunkStrings.normal_fragment=["#ifdef FLAT_SHADED","       // Workaround for Adreno/Nexus5 not able able to do dFdx( vViewPosition ) ...","       vec3 fdx = vec3( dFdx( vViewPosition.x ), dFdx( vViewPosition.y ), dFdx( vViewPosition.z ) );","       vec3 fdy = vec3( dFdy( vViewPosition.x ), dFdy( vViewPosition.y ), dFdy( vViewPosition.z ) );","       vec3 normal = normalize( cross( fdx, fdy ) );","#else","       vec3 normal = normalize( vNormal );","       #ifdef DOUBLE_SIDED","               normal = normal * ( float( gl_FrontFacing ) * 2.0 - 1.0 );","       #endif","#endif","#ifdef USE_NORMALMAP","       normal = perturbNormal2Arb( -vViewPosition, normal );","#elif defined( USE_BUMPMAP )","       normal = perturbNormalArb( -vViewPosition, normal, dHdxy_fwd() );","#endif"].join("\n"),e.ShaderChunkStrings.project_vertex=["vec4 mvPosition = viewMatrix*modelMatrix * vec4( transformed, 1.0 );","gl_Position = projectionMatrix * mvPosition;"].join("\n"),e.ShaderChunkStrings.specularmap_fragment=["float specularStrength;","#ifdef USE_SPECULARMAP","       vec4 texelSpecular = texture2D( specularMap, vUv );","       specularStrength = texelSpecular.r;","#else","       specularStrength = 1.0;","#endif"].join("\n"),e.ShaderChunkStrings.specularmap_pars_fragment=["#ifdef USE_SPECULARMAP","       uniform sampler2D specularMap;","#endif"].join("\n"),e.ShaderChunkStrings.uv_pars_fragment=["#if defined( USE_DIFFUSEMAP) || defined(USE_AOMAP) || defined(USE_EMISSIVEMAP)||defined(USE_NORMALMAP)||defined(USE_SPECULARMAP)||defined(USE_METALLIC_ROUGHNESS_TEXTURE)","    varying vec2 vUv;   ","#endif"].join("\n"),e.ShaderChunkStrings.uv_pars_vertex=["#if defined( USE_DIFFUSEMAP) || defined(USE_AOMAP) || defined(USE_EMISSIVEMAP)||defined(USE_NORMALMAP)||defined(USE_SPECULARMAP)||defined(USE_METALLIC_ROUGHNESS_TEXTURE)","    varying vec2 vUv;","    uniform mat3 uvTransform;","#endif"].join("\n"),e.ShaderChunkStrings.worldpos_vertex=["#if defined( USE_ENV_TEXTURE ) ||defined ( DISTANCE ) ||defined ( USE_SHADOWMAP )","       vec4 worldPosition = modelMatrix * vec4( transformed, 1.0 );","#endif"].join("\n"),e.ShaderChunkStrings.uv_vertex=["#if defined( USE_DIFFUSEMAP ) || defined( USE_BUMP_TEXTURE ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP ) || defined( USE_ALPHA_TEXTURE ) || defined( USE_EMISSIVEMAP ) || defined( USE_METALLIC_ROUGHNESS_TEXTURE )","       vUv = ( uvTransform* vec3( a_texCoords.xy,1.0) ).xy;","#endif"].join("\n"),e.ShaderChunkStrings.map_pars_fragment=["#ifdef USE_DIFFUSEMAP","       uniform sampler2D diffuseTexture;","#endif"].join("\n"),e.ShaderChunkStrings.map_fragment=["#ifdef USE_DIFFUSEMAP","       vec4 texelColor = texture2D( diffuseTexture, vUv );","       texelColor = mapTexelToLinear( texelColor );","       diffuseColor *= texelColor;","#endif"].join("\n"),e.ShaderChunkStrings.metallicRoughness_pars_fragment=["#ifdef USE_METALLIC_ROUGHNESS_TEXTURE","   uniform sampler2D metallicRoughnessTexture;","#endif"].join("\n"),e.ShaderChunkStrings.metallicRoughness_fragment=["float roughnessFactor = roughness;","float metalnessFactor = metalness;","#ifdef USE_METALLIC_ROUGHNESS_TEXTURE","vec4 mrSample = texture2D( metallicRoughnessTexture, vUv );","roughnessFactor *= mrSample.g;","metalnessFactor *= mrSample.b;","#endif"].join("\n"),e.ShaderChunkStrings.lights_physical_pars_fragment=["struct PhysicalMaterial {","       vec3    diffuseColor;","       float   specularRoughness;","       float   metalness;","       vec3    specularColor;","\t    #ifndef STANDARD","       float clearCoat;","       float clearCoatRoughness;","       #endif","};","#define MAXIMUM_SPECULAR_COEFFICIENT 0.16","#define DEFAULT_SPECULAR_COEFFICIENT 0.04","// Clear coat directional hemishperical reflectance (this approximation should be improved)","float clearCoatDHRApprox( const in float roughness, const in float dotNL ) {","       float F0 = DEFAULT_SPECULAR_COEFFICIENT;\tfloat Fc = pow(1.0 - dotNL, 5.0);\tfloat F = Fc + (1.0 - Fc) * F0;   return F;","}","void RE_Direct_Physical( const in IncidentLight directLight, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {","       float dotNL = saturate( dot( geometry.normal, directLight.direction ) );","       vec3 irradiance = dotNL * directLight.color;","       #ifndef PHYSICALLY_CORRECT_LIGHTS","               irradiance *= PI; // punctual light","       #endif","       #ifndef STANDARD","  vec3 halfDir = normalize(directLight.direction + geometry.viewDir);"," float dotVH = saturate(dot(geometry.viewDir, halfDir));","       float clearCoatDHR = material.clearCoat * clearCoatDHRApprox( material.clearCoatRoughness, dotVH );","       #else","       float clearCoatDHR = 0.0;","       #endif","\t\tvec3 ks = vec3(0.0);","       reflectedLight.directSpecular +=  ( 1.0 - clearCoatDHR ) * irradiance * BRDF_Specular_GGX( directLight, geometry, material.specularColor, material.specularRoughness,ks);","       reflectedLight.directDiffuse +=  ( 1.0 - clearCoatDHR )*(1.0-ks) * irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );","       #ifndef STANDARD","       reflectedLight.directSpecular += irradiance * material.clearCoat * BRDF_Specular_GGX(directLight, geometry, vec3(DEFAULT_SPECULAR_COEFFICIENT), material.clearCoatRoughness,ks);","       #endif","}","void RE_IndirectDiffuse_Physical( const in vec3 irradiance, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {","       float dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );","       vec3 ks = fresnelSchlickRoughness(dotNV,material.specularColor,material.specularRoughness);","       reflectedLight.indirectDiffuse += irradiance *(1.0-ks)* BRDF_Diffuse_Lambert( material.diffuseColor );","}","void RE_IndirectSpecular_Physical( const in vec3 radiance, const in vec3 clearCoatRadiance, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {","       #ifndef STANDARD","       float dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );","       float dotNL = dotNV;","       float clearCoatDHR = material.clearCoat * clearCoatDHRApprox( material.clearCoatRoughness, dotNL );","       #else","               float clearCoatDHR = 0.0;","       #endif","       reflectedLight.indirectSpecular += ( 1.0 - clearCoatDHR )* radiance * BRDF_Specular_GGX_Environment_texture( geometry, material.specularColor, material.specularRoughness );","\t    #ifndef STANDARD","       reflectedLight.indirectSpecular += clearCoatRadiance * material.clearCoat * BRDF_Specular_GGX_Environment_texture(geometry, vec3(DEFAULT_SPECULAR_COEFFICIENT), material.clearCoatRoughness);","       #endif","}","#define RE_Direct                              RE_Direct_Physical","#define RE_Direct_RectArea             RE_Direct_RectArea_Physical","#define RE_IndirectDiffuse             RE_IndirectDiffuse_Physical","#define RE_IndirectSpecular            RE_IndirectSpecular_Physical","#define Material_BlinnShininessExponent( material )   GGXRoughnessToBlinnExponent( material.specularRoughness )","#define Material_ClearCoat_BlinnShininessExponent( material )   GGXRoughnessToBlinnExponent( material.clearCoatRoughness )","// ref: https://seblagarde.files.wordpress.com/2015/07/course_notes_moving_frostbite_to_pbr_v32.pdf","float computeSpecularOcclusion( const in float dotNV, const in float ambientOcclusion, const in float roughness ) {","       return saturate( pow( dotNV + ambientOcclusion, exp2( - 16.0 * roughness - 1.0 ) ) - 1.0 + ambientOcclusion );","}"].join("\n"),e.ShaderChunkStrings.lights_physical_fragment=["PhysicalMaterial material;","material.diffuseColor = diffuseColor.rgb * ( 1.0 - metalnessFactor );","material.specularRoughness = clamp( roughnessFactor, 0.04, 1.0 );","#ifdef STANDARD","material.specularColor = mix( vec3( DEFAULT_SPECULAR_COEFFICIENT ), diffuseColor.rgb, metalnessFactor );","#else","material.specularColor = mix( vec3( MAXIMUM_SPECULAR_COEFFICIENT * pow2( reflectivity ) ), diffuseColor.rgb, metalnessFactor );","material.clearCoat = saturate( clearCoat );","material.clearCoatRoughness = clamp( clearCoatRoughness, 0.04, 1.0 );","#endif","material.metalness = metalness;"].join("\n"),e.ShaderChunkStrings.envmap_pars_vertex=["#ifdef USE_ENV_TEXTURE","       #if defined( USE_BUMP_TEXTURE ) || defined( USE_NORMALMAP ) || defined( PHONG )","               varying vec3 vWorldPosition;","       #else","               varying vec3 vReflect;","               uniform float refractionRatio;","       #endif","#endif"].join("\n"),e.ShaderChunkStrings.envmap_vertex=["#ifdef USE_ENV_TEXTURE","       #if defined( USE_BUMP_TEXTURE ) || defined( USE_NORMALMAP ) || defined( PHONG )","               vWorldPosition = worldPosition.xyz;","       #else","               vec3 cameraToVertex = normalize( worldPosition.xyz - cameraPosition );","               vec3 worldNormal = inverseTransformDirection( transformedNormal, viewMatrix );","               #ifdef ENVTEXTURE_MODE_REFLECTION","                       vReflect = reflect( cameraToVertex, worldNormal );","               #else","                       vReflect = refract( cameraToVertex, worldNormal, refractionRatio );","               #endif","       #endif","#endif"].join("\n"),e.ShaderChunkStrings.envmap_pars_fragment=["#if defined( USE_ENV_TEXTURE ) || defined( PHYSICAL )","       float reflectivity = 0.5;","       uniform float envMapIntensity;","#endif","#ifdef USE_ENV_TEXTURE","       #if ! defined( PHYSICAL ) && ( defined( USE_BUMP_TEXTURE ) || defined( USE_NORMALMAP ) || defined( PHONG ) )","               varying vec3 vWorldPosition;","       #endif","       #ifdef ENVTEXTURE_TYPE_CUBE","               uniform samplerCube envTexture;","               #if defined( PHYSICAL ) ","               uniform samplerCube envDiffuseTexture;","               #endif","       #else","               uniform sampler2D envTexture;","       #endif","       uniform float flipEnvMap;","       #if defined( USE_BUMP_TEXTURE ) || defined( USE_NORMALMAP ) || defined( PHONG ) || defined( PHYSICAL )","               uniform float refractionRatio;","       #else","               varying vec3 vReflect;","       #endif","#endif"].join("\n"),e.ShaderChunkStrings.envmap_fragment=["#ifdef USE_ENV_TEXTURE","       #if defined( USE_BUMP_TEXTURE ) || defined( USE_NORMALMAP ) || defined( PHONG )","               vec3 cameraToVertex = normalize( vWorldPosition - cameraPosition );","               // Transforming Normal Vectors with the Inverse Transformation","               vec3 worldNormal = inverseTransformDirection( normal, viewMatrix );","               #ifdef ENVTEXTURE_MODE_REFLECTION","                       vec3 reflectVec = reflect( cameraToVertex, worldNormal );","               #else","                       vec3 reflectVec = refract( cameraToVertex, worldNormal, refractionRatio );","               #endif","       #else","               vec3 reflectVec = vReflect;","       #endif","       #ifdef ENVTEXTURE_TYPE_CUBE","               vec4 envColor = textureCube( envTexture, vec3(  reflectVec.x, reflectVec.yz ) );","       #elif defined( ENVMAP_TYPE_EQUIREC )","               vec2 sampleUV;","               reflectVec = normalize( reflectVec );","               sampleUV.y = asin( clamp( reflectVec.y, - 1.0, 1.0 ) ) * RECIPROCAL_PI + 0.5;","               sampleUV.x = atan( reflectVec.z, reflectVec.x ) * RECIPROCAL_PI2 + 0.5;","               vec4 envColor = texture2D( envTexture, sampleUV );","       #elif defined( ENVMAP_TYPE_SPHERE )","               reflectVec = normalize( reflectVec );","               vec3 reflectView = normalize( ( viewMatrix * vec4( reflectVec, 0.0 ) ).xyz + vec3( 0.0, 0.0, 1.0 ) );","               vec4 envColor = texture2D( envTexture, reflectView.xy * 0.5 + 0.5 );","       #else","               vec4 envColor = vec4( 0.0 );","       #endif","       envColor = envMapTexelToLinear( envColor );","       #ifdef ENVMAP_BLENDING_MULTIPLY","               outgoingLight = mix( outgoingLight, outgoingLight * envColor.xyz, specularStrength * reflectivity );","       #elif defined( ENVMAP_BLENDING_MIX )","               outgoingLight = mix( outgoingLight, envColor.xyz, specularStrength * reflectivity );","       #elif defined( ENVMAP_BLENDING_ADD )","               outgoingLight += envColor.xyz * specularStrength * reflectivity;","       #endif","#endif"].join("\n"),e.ShaderChunkStrings.packing=["vec3 packNormalToRGB( const in vec3 normal ) {","       return normalize( normal ) * 0.5 + 0.5;","}","vec3 unpackRGBToNormal( const in vec3 rgb ) {","       return 2.0 * rgb.xyz - 1.0;","}","const float PackUpscale = 256. / 255.; // fraction -> 0..1 (including 1)","const float UnpackDownscale = 255. / 256.; // 0..1 -> fraction (excluding 1)","const vec3 PackFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );","const vec4 UnpackFactors = UnpackDownscale / vec4( PackFactors, 1. );","const float ShiftRight8 = 1. / 256.;","vec4 packDepthToRGBA( const in float v ) {","       vec4 r = vec4( fract( v * PackFactors ), v );","       r.yzw -= r.xyz * ShiftRight8; // tidy overflow","       return r * PackUpscale;","}","float unpackRGBAToDepth( const in vec4 v ) {","       return dot( v, UnpackFactors );","}","// NOTE: viewZ/eyeZ is < 0 when in front of the camera per OpenGL conventions","float viewZToOrthographicDepth( const in float viewZ, const in float near, const in float far ) {","       return ( viewZ + near ) / ( near - far );","}","float orthographicDepthToViewZ( const in float linearClipZ, const in float near, const in float far ) {","       return linearClipZ * ( near - far ) - near;","}","float viewZToPerspectiveDepth( const in float viewZ, const in float near, const in float far ) {","       return (( near + viewZ ) * far ) / (( far - near ) * viewZ );","}","float perspectiveDepthToViewZ( const in float invClipZ, const in float near, const in float far ) {","       return ( near * far ) / ( ( far - near ) * invClipZ - far );","}"].join("\n"),e.ShaderChunkStrings.shadowmap_vertex=["#ifdef USE_SHADOWMAP","       #if NUM_DIR_LIGHTS > 0","       for ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {","               vDirectionalShadowCoord[ i ] = directionalShadowMatrix[ i ] * worldPosition;","       }","       #endif","       #if NUM_SPOT_LIGHTS > 0","       for ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {","               vSpotShadowCoord[ i ] = spotShadowMatrix[ i ] * worldPosition;","       }","       #endif","       #if NUM_POINT_LIGHTS > 0","       for ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {","               vPointShadowCoord[ i ] = pointShadowMatrix[ i ] * worldPosition;","       }","       #endif","#endif"].join("\n"),e.ShaderChunkStrings.shadowmap_pars_vertex=["#ifdef USE_SHADOWMAP","       #if NUM_DIR_LIGHTS > 0","               uniform mat4 directionalShadowMatrix[ NUM_DIR_LIGHTS ];","               varying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHTS ];","       #endif","       #if NUM_SPOT_LIGHTS > 0","               uniform mat4 spotShadowMatrix[ NUM_SPOT_LIGHTS ];","               varying vec4 vSpotShadowCoord[ NUM_SPOT_LIGHTS ];","       #endif","       #if NUM_POINT_LIGHTS > 0","               uniform mat4 pointShadowMatrix[ NUM_POINT_LIGHTS ];","               varying vec4 vPointShadowCoord[ NUM_POINT_LIGHTS ];","       #endif","#endif"].join("\n"),e.ShaderChunkStrings.shadowmap_pars_fragment=["#ifdef USE_SHADOWMAP","       #if NUM_DIR_LIGHTS > 0","               uniform sampler2D directionalShadowMap[ NUM_DIR_LIGHTS ];","               varying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHTS ];","       #endif","       #if NUM_SPOT_LIGHTS > 0","               uniform sampler2D spotShadowMap[ NUM_SPOT_LIGHTS ];","               varying vec4 vSpotShadowCoord[ NUM_SPOT_LIGHTS ];","       #endif","       #if NUM_POINT_LIGHTS > 0","               uniform sampler2D pointShadowMap[ NUM_POINT_LIGHTS ];","               varying vec4 vPointShadowCoord[ NUM_POINT_LIGHTS ];","       #endif","       float texture2DCompare( sampler2D depths, vec2 uv, float compare ) {","               return step( compare, unpackRGBAToDepth( texture2D( depths, uv ) ) );","       }","       float texture2DShadowLerp( sampler2D depths, vec2 size, vec2 uv, float compare ) {","               const vec2 offset = vec2( 0.0, 1.0 );","               vec2 texelSize = vec2( 1.0 ) / size;","               vec2 centroidUV = floor( uv * size + 0.5 ) / size;","               float lb = texture2DCompare( depths, centroidUV + texelSize * offset.xx, compare );","               float lt = texture2DCompare( depths, centroidUV + texelSize * offset.xy, compare );","               float rb = texture2DCompare( depths, centroidUV + texelSize * offset.yx, compare );","               float rt = texture2DCompare( depths, centroidUV + texelSize * offset.yy, compare );","               vec2 f = fract( uv * size + 0.5 );","               float a = mix( lb, lt, f.y );","               float b = mix( rb, rt, f.y );","               float c = mix( a, b, f.x );","               return c;","       }","       float getShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord ) {","               float shadow = 1.0;","               shadowCoord.xyz /= shadowCoord.w;","               shadowCoord.z -= shadowBias;","               // if ( something && something ) breaks ATI OpenGL shader compiler","               // if ( all( something, something ) ) using this instead","               bvec4 inFrustumVec = bvec4 ( shadowCoord.x >= 0.0, shadowCoord.x <= 1.0, shadowCoord.y >= 0.0, shadowCoord.y <= 1.0 );","               bool inFrustum = all( inFrustumVec );","               bvec2 frustumTestVec = bvec2( inFrustum, shadowCoord.z <= 1.0 );","               bool frustumTest = all( frustumTestVec );","               if ( frustumTest ) {","               #if defined( SHADOWMAP_TYPE_PCF )","                       vec2 texelSize = vec2( 1.0 ) / shadowMapSize;","                       float dx0 = - texelSize.x * shadowRadius;","                       float dy0 = - texelSize.y * shadowRadius;","                       float dx1 = + texelSize.x * shadowRadius;","                       float dy1 = + texelSize.y * shadowRadius;","                       shadow = (","                               texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy0 ), shadowCoord.z ) +","                               texture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy0 ), shadowCoord.z ) +","                               texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy0 ), shadowCoord.z ) +","                               texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, 0.0 ), shadowCoord.z ) +","                               texture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z ) +","                               texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, 0.0 ), shadowCoord.z ) +","                               texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy1 ), shadowCoord.z ) +","                               texture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy1 ), shadowCoord.z ) +","                               texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy1 ), shadowCoord.z )","                       ) * ( 1.0 / 9.0 );","               #elif defined( SHADOWMAP_TYPE_PCF_SOFT )","                       vec2 texelSize = vec2( 1.0 ) / shadowMapSize;","                       float dx0 = - texelSize.x * shadowRadius;","                       float dy0 = - texelSize.y * shadowRadius;","                       float dx1 = + texelSize.x * shadowRadius;","                       float dy1 = + texelSize.y * shadowRadius;","                       shadow = (","                               texture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx0, dy0 ), shadowCoord.z ) +","                               texture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( 0.0, dy0 ), shadowCoord.z ) +","                               texture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx1, dy0 ), shadowCoord.z ) +","                               texture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx0, 0.0 ), shadowCoord.z ) +","                               texture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy, shadowCoord.z ) +","                               texture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx1, 0.0 ), shadowCoord.z ) +","                               texture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx0, dy1 ), shadowCoord.z ) +","                               texture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( 0.0, dy1 ), shadowCoord.z ) +","                               texture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx1, dy1 ), shadowCoord.z )","                       ) * ( 1.0 / 9.0 );","               #else // no percentage-closer filtering:","                       shadow = texture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z );","               #endif","               }","               if(shadowCoord.z>1.0)","               {","                   shadow = 1.0;","               ","               }","               return shadow;","       }","       // cubeToUV() maps a 3D direction vector suitable for cube texture mapping to a 2D","       // vector suitable for 2D texture mapping. This code uses the following layout for the","       // 2D texture:","       //","       // xzXZ","       //  y Y","       //","       // Y - Positive y direction","       // y - Negative y direction","       // X - Positive x direction","       // x - Negative x direction","       // Z - Positive z direction","       // z - Negative z direction","       //","       // Source and test bed:","       // https://gist.github.com/tschw/da10c43c467ce8afd0c4","       vec2 cubeToUV( vec3 v, float texelSizeY ) {","               // Number of texels to avoid at the edge of each square","               vec3 absV = abs( v );","               // Intersect unit cube","               float scaleToCube = 1.0 / max( absV.x, max( absV.y, absV.z ) );","               absV *= scaleToCube;","               // Apply scale to avoid seams","               // two texels less per square (one texel will do for NEAREST)","               v *= scaleToCube * ( 1.0 - 2.0 * texelSizeY );","               // Unwrap","               // space: -1 ... 1 range for each square","               //","               // #X##         dim    := ( 4 , 2 )","               //  # #         center := ( 1 , 1 )","               vec2 planar = v.xy;","               float almostATexel = 1.5 * texelSizeY;","               float almostOne = 1.0 - almostATexel;","               if ( absV.z >= almostOne ) {","                       if ( v.z > 0.0 )","                               planar.x = 4.0 - v.x;","               } else if ( absV.x >= almostOne ) {","                       float signX = sign( v.x );","                       planar.x = v.z * signX + 2.0 * signX;","               } else if ( absV.y >= almostOne ) {","                       float signY = sign( v.y );","                       planar.x = v.x + 2.0 * signY + 2.0;","                       planar.y = v.z * signY - 2.0;","               }","               // Transform to UV space","               // scale := 0.5 / dim","               // translate := ( center + 0.5 ) / dim","               return vec2( 0.125, 0.25 ) * planar + vec2( 0.375, 0.75 );","       }","       float getPointShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord, float shadowCameraNear, float shadowCameraFar ) {","               vec2 texelSize = vec2( 1.0 ) / ( shadowMapSize * vec2( 4.0, 2.0 ) );","               // for point lights, the uniform @vShadowCoord is re-purposed to hold","               // the vector from the light to the world-space position of the fragment.","               vec3 lightToPosition = shadowCoord.xyz;","               // dp = normalized distance from light to fragment position","               float  dp = ( length( lightToPosition ) - shadowCameraNear ) / ( shadowCameraFar - shadowCameraNear );","\t\t        dp -= shadowBias;","               // bd3D = base direction 3D","               vec3 bd3D = normalize( lightToPosition );","               #if defined( SHADOWMAP_TYPE_PCF ) || defined( SHADOWMAP_TYPE_PCF_SOFT )","                       vec2 offset = vec2( - 1, 1 ) * shadowRadius * texelSize.y;","                       return (","                               texture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyy, texelSize.y ), dp ) +","                               texture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyy, texelSize.y ), dp ) +","                               texture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyx, texelSize.y ), dp ) +","                               texture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyx, texelSize.y ), dp ) +","                               texture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp ) +","                               texture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxy, texelSize.y ), dp ) +","                               texture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxy, texelSize.y ), dp ) +","                               texture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxx, texelSize.y ), dp ) +","                               texture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxx, texelSize.y ), dp )","                       ) * ( 1.0 / 9.0 );","               #else // no percentage-closer filtering","                       return texture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp );","               #endif","       }","#endif"].join("\n"),e.ShaderChunkStrings.z_depth_pars_vert=["#ifdef USE_DEPTH_TEXTURE_CULL","uniform mat4 zMatrix;","varying vec4 zCoords;","#endif"].join("\n"),e.ShaderChunkStrings.z_depth_pars_frag=["#ifdef USE_DEPTH_TEXTURE_CULL","varying vec4 zCoords;","uniform sampler2D zDepth;","#endif"].join("\n"),e.ShaderChunkStrings.z_depth_vert=["#ifdef USE_DEPTH_TEXTURE_CULL","zCoords = zMatrix * worldPosition;","#endif"].join("\n"),e.ShaderChunkStrings.z_depth_frag=["#ifdef USE_DEPTH_TEXTURE_CULL","vec4 temZcoords = zCoords;","temZcoords.xyz /= temZcoords.w;","float zdepth =unpackRGBAToDepth(texture2D(zDepth, temZcoords.xy));","if(gl_FragCoord.z>zdepth+0.000005)","   discard;","#endif"].join("\n"),e.ShaderChunkStrings.tonemapping_pars_fragment=["uniform float toneMappingExposure;","#define Uncharted2Helper(x) max(((x * (0.15 * x + 0.10 * 0.50) + 0.20 * 0.02) / (x * (0.15 * x + 0.50) + 0.20 * 0.30)) - 0.02 / 0.30, vec3(0.0))","vec3 Uncharted2ToneMapping(vec3 color ) {"," color *= toneMappingExposure;"," return saturate(Uncharted2Helper(color) / Uncharted2Helper(vec3(1.0/*toneMappingWhitePoint*/)));","}","vec3 OptimizedCineonToneMapping(vec3 color ) {","   color *= toneMappingExposure;","  color = max(vec3(0.0), color - 0.004);","   return pow((color * (6.2 * color + 0.5)) / (color * (6.2 * color + 1.7) + 0.06), vec3(2.2));","}"].join("\n"),e.ShaderChunkStrings.tonemapping_fragment=["#if defined(TONE_MAPPING)","   gl_FragColor.rgb = OptimizedCineonToneMapping(gl_FragColor.rgb);","#endif"].join("\n"),e.ShaderChunkStrings.clip_pars_fragment=["#if defined(USE_CLIP)","uniform vec4 u_clipPlanes[3];","uniform bool u_enableClips[3];","uniform bool u_reverseClip;","#endif"].join("\n"),e.ShaderChunkStrings.clip_fragment=["#if defined(USE_CLIP)","if (u_reverseClip)","{","\tint iEnableNum = 0;","\tint iClipNum = 0;","\tfor (int i = 0; i < 3; i++)","\t{","\t\tif (u_enableClips[i])","\t\t{","\t\t\tiEnableNum++;","\t\t\tfloat dPara = u_clipPlanes[i].w;","\t\t\tif ((dot(-vec3(vViewPosition.xyz), vec3(u_clipPlanes[i].xyz)) + dPara) > 0.0)","\t\t\t{","\t\t\t\tiClipNum++;","\t\t\t}","\t\t}","\t}","\tif (iEnableNum == iClipNum && iEnableNum != 0)","\t{","\t\tdiscard;","\t}","}","else","{","\tfor (int i = 0; i < 3; i++)","\t{","\t\tif (u_enableClips[i])","\t\t{","\t\t\tfloat dPara = u_clipPlanes[i].w;","\t\t\tif ((dot(-vec3(vViewPosition.xyz), vec3(u_clipPlanes[i].xyz)) + dPara) < 0.0)","\t\t\t{","\t\t\t\tdiscard;","\t\t\t}","\t\t}","\t}","}","#endif"].join("\n"),e.ShaderChunkStrings.displacementmap_pars_vertex=["#ifdef USE_DISPLACEMENTMAP","uniform sampler2D displacementMap;","uniform float displacementScale;","uniform float displacementBias;","#endif"].join("\n"),e.ShaderChunkStrings.displacementmap_vertex=["#ifdef USE_DISPLACEMENTMAP","transformed += normalize( objectNormal ) * ( texture2D( displacementMap, a_texCoords.xy ).x * displacementScale + displacementBias );","#endif"].join("\n"),e.ShaderChunkStrings.aomap_pars_fragment=["#ifdef USE_AOMAP","\tuniform sampler2D aoMap;","\tuniform float aoMapIntensity;","#endif"].join("\n"),e.ShaderChunkStrings.aomap_fragment=["#ifdef USE_AOMAP","\t\tfloat ambientOcclusion = (texture2D(aoMap, vUv).r - 1.0) * aoMapIntensity + 1.0;","\t\treflectedLight.indirectDiffuse *= ambientOcclusion;","#if defined( USE_ENV_TEXTURE ) && defined( PHYSICAL )","\t\tfloat dotNV = saturate(dot(geometry.normal, geometry.viewDir));","\t\treflectedLight.indirectSpecular *= computeSpecularOcclusion(dotNV, ambientOcclusion, material.specularRoughness);","#endif","#endif"].join("\n"),e.ShaderChunkStrings.emissivemap_fragment=["#ifdef USE_EMISSIVEMAP","\t\tvec4 emissiveColor = texture2D(emissiveMap, vUv);","\t\temissiveColor.rgb = mapTexelToLinear(emissiveColor).rgb;","\t\ttotalEmissiveRadiance *= emissiveColor.rgb;","#endif"].join("\n"),e.ShaderChunkStrings.emissivemap_pars_fragment=["#ifdef USE_EMISSIVEMAP","\t\tuniform sampler2D emissiveMap;","#endif"].join("\n"),e.ShaderChunkStrings.parallax_corrected_cubemap_pars_vertex=["#ifdef USE_LOCAL_CUBEMAP","               varying vec3 vWorldPosition;","#endif"].join("\n"),e.ShaderChunkStrings.parallax_corrected_cubemap_vertex=["#ifdef USE_LOCAL_CUBEMAP","               vWorldPosition = worldPosition.xyz;","#endif"].join("\n"),e.ShaderChunkStrings.parallax_corrected_cubemap_pars_fragment=["#ifdef USE_LOCAL_CUBEMAP"," uniform vec3 boxMax;"," uniform vec3 boxMin;"," uniform vec3 cubeMapWorldPosition;"," varying vec3 vWorldPosition;"," vec3 GetParallaxCorrectedReflect(vec3 originReflect,vec3 boxMax,vec3 boxMin,vec3 cubeMapWorldPosition,vec3 worldPosition)"," {"," vec3 rbmax = (boxMax - worldPosition) / originReflect;","vec3 rbmin = (boxMin - worldPosition) / originReflect;","vec3 rbminmax;","rbminmax.x = originReflect.x > 0.0 ? rbmax.x : rbmin.x;","rbminmax.y = originReflect.y > 0.0 ? rbmax.y : rbmin.y;","rbminmax.z = originReflect.z > 0.0 ? rbmax.z : rbmin.z;"," float fa = min(min(rbminmax.x, rbminmax.y), rbminmax.z);","vec3 posonbox = worldPosition + originReflect * fa;"," vec3 envBoxPos = (boxMin + boxMax) * 0.5;"," return posonbox - envBoxPos;"," }","vec3 fixSeams(vec3 vec, float mipmapIndex) {","float scale = 1.0 - exp2(mipmapIndex) / 256.0;","float M = max(max(abs(vec.x), abs(vec.y)), abs(vec.z));","if (abs(vec.x) != M) vec.x *= scale;","if (abs(vec.y) != M) vec.y *= scale;","if (abs(vec.z) != M) vec.z *= scale;","return vec;","}","#endif"].join("\n"),e.ShaderChunkStrings.encodings_pars_fragment=["","vec4 LinearToLinear(in vec4 value) {","return value;","}","vec4 GammaToLinear(in vec4 value, in float gammaFactor) {","\treturn vec4(pow(value.xyz, vec3(gammaFactor)), value.w);","}","vec4 LinearToGamma(in vec4 value, in float gammaFactor) {","\treturn vec4(pow(value.xyz, vec3(1.0 / gammaFactor)), value.w);","}","vec4 sRGBToLinear(in vec4 value) {","\treturn vec4(mix(pow(value.rgb * 0.9478672986 + vec3(0.0521327014), vec3(2.4)), value.rgb * 0.0773993808, vec3(lessThanEqual(value.rgb, vec3(0.04045)))), value.w);","}","vec4 LinearTosRGB(in vec4 value) {","\treturn vec4(mix(pow(value.rgb, vec3(0.41666)) * 1.055 - vec3(0.055), value.rgb * 12.92, vec3(lessThanEqual(value.rgb, vec3(0.0031308)))), value.w);","}","vec4 RGBEToLinear(in vec4 value) {","\treturn vec4(value.rgb * exp2(value.a * 255.0 - 128.0), 1.0);","}","vec4 LinearToRGBE(in vec4 value) {","\tfloat maxComponent = max(max(value.r, value.g), value.b);","\tfloat fExp = clamp(ceil(log2(maxComponent)), -128.0, 127.0);","\treturn vec4(value.rgb / exp2(fExp), (fExp + 128.0) / 255.0);","}","vec4 RGBMToLinear(in vec4 value, in float maxRange) {","\treturn vec4(value.xyz * value.w * maxRange, 1.0);","}","vec4 LinearToRGBM(in vec4 value, in float maxRange) {","\tfloat maxRGB = max(value.x, max(value.g, value.b));","\tfloat M = clamp(maxRGB / maxRange, 0.0, 1.0);","\tM = ceil(M * 255.0) / 255.0;","\treturn vec4(value.rgb / (M * maxRange), M);","}","vec4 RGBDToLinear(in vec4 value, in float maxRange) {","\treturn vec4(value.rgb * ((maxRange / 255.0) / value.a), 1.0);","}","vec4 LinearToRGBD(in vec4 value, in float maxRange) {","\tfloat maxRGB = max(value.x, max(value.g, value.b));","\tfloat D = max(maxRange / maxRGB, 1.0);","\tD = min(floor(D) / 255.0, 1.0);","\treturn vec4(value.rgb * (D * (255.0 / maxRange)), D);","}","const mat3 cLogLuvM = mat3(0.2209, 0.3390, 0.4184, 0.1138, 0.6780, 0.7319, 0.0102, 0.1130, 0.2969);","vec4 LinearToLogLuv(in vec4 value) {","\tvec3 Xp_Y_XYZp = value.rgb * cLogLuvM;","\tXp_Y_XYZp = max(Xp_Y_XYZp, vec3(1e-6, 1e-6, 1e-6));","\tvec4 vResult;","\tvResult.xy = Xp_Y_XYZp.xy / Xp_Y_XYZp.z;","\tfloat Le = 2.0 * log2(Xp_Y_XYZp.y) + 127.0;","\tvResult.w = fract(Le);","\tvResult.z = (Le - (floor(vResult.w*255.0)) / 255.0) / 255.0;","\treturn vResult;","}","const mat3 cLogLuvInverseM = mat3(6.0014, -2.7008, -1.7996, -1.3320, 3.1029, -5.7721, 0.3008, -1.0882, 5.6268);","vec4 LogLuvToLinear(in vec4 value) {","\tfloat Le = value.z * 255.0 + value.w;","\tvec3 Xp_Y_XYZp;","\tXp_Y_XYZp.y = exp2((Le - 127.0) / 2.0);","\tXp_Y_XYZp.z = Xp_Y_XYZp.y / value.y;","\tXp_Y_XYZp.x = value.x * Xp_Y_XYZp.z;","\tvec3 vRGB = Xp_Y_XYZp.rgb * cLogLuvInverseM;","\treturn vec4(max(vRGB, 0.0), 1.0);","}"].join("\n"),e.ShaderChunkStrings.encodings_fragment=" gl_FragColor = linearToOutputTexel( gl_FragColor );",e.ShaderChunkStrings.ssao_par_fragment=["#ifdef SSAO"," uniform vec2 screenSize;"," uniform sampler2D ssaoMap;","vec2 CalcScreenTexCoord()","{","\treturn gl_FragCoord.xy / screenSize;","}","#endif"].join("\n"),e.ShaderChunkStrings.ssao_fragment=["#ifdef SSAO"," ssaoFactor = texture2D(ssaoMap,CalcScreenTexCoord()).r;","#endif"].join("\n"),e.ShaderChunkStrings.matcap_pars_fragment=["#if defined( USE_MATCAPMAP ) &&  !defined( PHYSICAL )","uniform sampler2D matcapMap;","vec3 GetMatcapIndirectLight( const in GeometricContext geometry)","{","  vec2 matcapCoords = -normalize(geometry.normal).xy*0.5+0.5;","  vec3 ret = texture2D(matcapMap,matcapCoords).xyz;"," return ret;","}","#endif"].join("\n")}(M3D||(M3D={})),function(e){var t=function(){function e(){this.gl=null,this.vertexShaderCode="",this.fragShaderCode="",this.vertexShader=null,this.fragShader=null,this.baseShaderProgram=null}return e.prototype.CompileShaer=function(){this.vertexShader=this.gl.createShader(WebGLRenderingContext.VERTEX_SHADER),this.fragShader=this.gl.createShader(WebGLRenderingContext.FRAGMENT_SHADER),this.gl.shaderSource(this.vertexShader,this.vertexShaderCode),this.gl.shaderSource(this.fragShader,this.fragShaderCode),this.gl.compileShader(this.vertexShader),this.gl.compileShader(this.fragShader),!1===this.gl.getShaderParameter(this.vertexShader,this.gl.COMPILE_STATUS)&&""!==this.gl.getShaderInfoLog(this.vertexShader)&&console.log("Shader Info: "+this.gl.getShaderInfoLog(this.vertexShader),this.vertexShaderCode),!1===this.gl.getShaderParameter(this.fragShader,this.gl.COMPILE_STATUS)&&""!==this.gl.getShaderInfoLog(this.fragShader)&&console.log("Shader Info: "+this.gl.getShaderInfoLog(this.fragShader),this.fragShaderCode),this.baseShaderProgram=this.gl.createProgram(),this.gl.attachShader(this.baseShaderProgram,this.vertexShader),this.gl.attachShader(this.baseShaderProgram,this.fragShader),this.gl.linkProgram(this.baseShaderProgram),!1===this.gl.getProgramParameter(this.baseShaderProgram,this.gl.LINK_STATUS)&&""!==this.gl.getProgramInfoLog(this.baseShaderProgram)&&console.log("Shader Info: "+this.gl.getProgramInfoLog(this.baseShaderProgram))},e.prototype.SetUniformInt=function(e,t){this.gl.uniform1i(this.gl.getUniformLocation(this.baseShaderProgram,e),t)},e}();e.ShaderTest=t}(M3D||(M3D={})),function(_){var e=function(){function C(){}return C.GetUniformListMaps=function(e){var t=null,r=this.m_uniformMaps[e];return null==r?(t={},this.m_uniformMaps[e]=t):t=r,t},C.UpdateUniform=function(e,t,r,i,n){var o=e.GetRenderContext().GetGLRenderContext(),a=e.GetScene().GetResourceManager(),s=a.GetDeffaultTextureObj(),l=a.GetDefaultCubeMap();r.GetShaderUniformKeyValueArray();for(var h in n){var u=n[h],p=u.uniformType;if(u)if("Texture2D"==p){var c=_.GLShapeDrawer.AllocTextureUnit();if(o.uniform1i(r.GetShaderUniformParameter(h).location,c),T=u.value){var d=T.GetOGLObj(o);T.SetTextureUnit(c),d?(t[c]=_.GL.TEXTURE_2D,o.activeTexture(_.GL.TEXTURE0+c),o.bindTexture(_.GL.TEXTURE_2D,d)):(t[c]=_.GL.TEXTURE_2D,o.activeTexture(_.GL.TEXTURE0+c),o.bindTexture(_.GL.TEXTURE_2D,s))}}else if("GeometryBuffer"==p){c=_.GLShapeDrawer.AllocTextureUnit();if(o.uniform1i(r.GetShaderUniformParameter(h).location,c),T=u.value)(d=T.GetOGLObj())&&(t[c]=_.GL.TEXTURE_2D,o.activeTexture(_.GL.TEXTURE0+c),o.bindTexture(_.GL.TEXTURE_2D,d))}else if("GeometryBufferArray"==p){for(var S=[],f=0,m=(y=u.value).length;f<m;f++){c=_.GLShapeDrawer.AllocTextureUnit();if(S.push(c),T=y[f]){d=T.GetOGLObj(o);T.SetTextureUnit(c),d?(t[c]=_.GL.TEXTURE_2D,o.activeTexture(_.GL.TEXTURE0+c),o.bindTexture(_.GL.TEXTURE_2D,d)):(t[c]=_.GL.TEXTURE_2D,o.activeTexture(_.GL.TEXTURE0+c),o.bindTexture(_.GL.TEXTURE_2D,s))}}o.uniform1iv(r.GetShaderUniformParameter(h).location,S)}else if("Texture2DArray"==p){var y=u.value;for(S=[],f=0;f<y.length;f++){c=_.GLShapeDrawer.AllocTextureUnit();if(S.push(c),T=y[f]){d=T.GetOGLObj(o);T.SetTextureUnit(c),d?(t[c]=_.GL.TEXTURE_2D,o.activeTexture(_.GL.TEXTURE0+c),o.bindTexture(_.GL.TEXTURE_2D,d)):(t[c]=_.GL.TEXTURE_2D,o.activeTexture(_.GL.TEXTURE0+c),o.bindTexture(_.GL.TEXTURE_2D,s))}}o.uniform1iv(r.GetShaderUniformParameter(h).location,S)}else if("TextureCube"==p){var T;c=_.GLShapeDrawer.AllocTextureUnit();if(T=u.value)T.SetTextureUnit(c),(d=T.GetOGLObj(o))?(t[c]=_.GL.TEXTURE_CUBE_MAP,o.activeTexture(_.GL.TEXTURE0+c),o.bindTexture(_.GL.TEXTURE_CUBE_MAP,d)):(t[c]=_.GL.TEXTURE_CUBE_MAP,o.activeTexture(_.GL.TEXTURE0+c),o.bindTexture(_.GL.TEXTURE_CUBE_MAP,l));o.uniform1i(r.GetShaderUniformParameter(h).location,c),u.lastValue=c}else if("Float"==p){var M=r.GetShaderUniformParameter(h);if(1<M.size){if(Array.isArray(u.value)){var g=u.value;o.uniform1fv(M.location,g)}}else{g=u.value;o.uniform1f(M.location,g)}}else if("Vector2"==p){var v=(g=u.value).Data();o.uniform2f(r.GetShaderUniformParameter(h).location,v[0],v[1])}else if("Vector3"==p){v=(g=u.value).ToArray();o.uniform3f(r.GetShaderUniformParameter(h).location,v[0],v[1],v[2])}else if("Vector4"==p){v=(g=u.value).Data();o.uniform4f(r.GetShaderUniformParameter(h).location,v[0],v[1],v[2],v[3])}else if("Bool"==p)o.uniform1i(r.GetShaderUniformParameter(h).location,u.value);else if("BoolArray"==p){g=u.value;o.uniform1iv(r.GetShaderUniformParameter(h).location,g)}else if("Matrix3"==p){g=u.value;o.uniformMatrix3fv(r.GetShaderUniformParameter(h).location,!1,g.data)}else if("Matrix4"==p){g=u.value;o.uniformMatrix4fv(r.GetShaderUniformParameter(h).location,!1,g.data)}else if("Matrix4Array"==p){g=u.value;o.uniformMatrix4fv(r.GetShaderUniformParameter(h).location,!1,C.flatten(g,r.GetShaderUniformParameter(h).size,16))}}},C.flatten=function(e,t,r){var i;if(1===t)return e[0].data;i=new Float32Array(t*r);for(var n=0;n<t;n++)i.set(e[0].data,n*r);return i},C.SetUniformValueToMap=function(e,t,r,i){var n=e[t];if(null!=n)n.value=i;else{var o=new _.Uniform(r,i);e[t]=o}},C.m_uniformHelper={},C.m_uniformMaps={},C}();_.UniformHelper=e}(M3D||(M3D={})),function(e){var t=function(t){function e(){var e=t.call(this)||this;return e.AnnotationIdList=[],e.strNodeName="AnnotationGroup",e.m_scene=null,e}return __extends(e,t),e.prototype.Initialize=function(){},e.prototype.Clear=function(){this.DeleteAllChildren()},e.prototype.SetScene=function(e){this.m_scene=e},e.prototype.GetScene=function(){return this.m_scene},e.prototype.GetAnnotationIdList=function(){return this.AnnotationIdList},e.prototype.AddAnnotationId=function(e){this.AnnotationIdList.indexOf(e)<0&&this.AnnotationIdList.push(e)},e}(e.GroupNode);e.AnnotationGroup=t}(M3D||(M3D={})),function(t){var e=function(){function e(){this.m_sceneCameras=[]}return e.prototype.AddCamera=function(e){if(e){for(var t=0;t<this.m_sceneCameras.length;t++)if(this.m_sceneCameras[t]==e)return;this.m_sceneCameras.push(e)}},e.prototype.RemoveCamera=function(e){for(var t=0,r=this.m_sceneCameras.length;t<r;t++)if(this.m_sceneCameras[t]==e)return void this.m_sceneCameras[t]},e.prototype.SetSceneManager=function(e){this.m_sceneManager=e},e.prototype.GetSceneManger=function(){return this.m_sceneManager},e.prototype.GetAllCameras=function(){return this.m_sceneCameras},e}();t.CameraManager=e;var r=function(i){function e(){var e=i.call(this)||this;return e.SetScene(null),e}return __extends(e,i),e.prototype.GetType=function(){return t.CAMERA_GROUP_NODE},e.prototype.Initialize=function(){},e.prototype.SetScene=function(e){this.m_scene=e},e.prototype.GetScene=function(){return this.m_scene},e.prototype.RayPick=function(e){i.prototype.RayPick.call(this,e);for(var t=this.m_scene.GetCameraManager().GetAllCameras(),r=0;r<t.length;r++)t[r].RayPick(e)},e}(t.GroupNode);t.CameraGroup=r}(M3D||(M3D={})),function(t){var e=function(r){function e(e){var t=r.call(this)||this;return t.m_scene=null,t.m_points=[],t.m_lines=[],t.m_curves=[],t.m_scene=e,t}return __extends(e,r),e.prototype.GetType=function(){return t.GEOMETRY_GROUP_NODE},e.prototype.RayPick=function(e){for(var t=this.m_points.length,r=0;r<t;r++){var i=this.m_points[r];null!=i&&i.IsVisible()&&i.RayPick(e)}t=this.m_lines.length;for(r=0;r<t;r++){var n=this.m_lines[r];null!=n&&n.IsVisible()&&n.RayPick(e)}t=this.m_curves.length;for(r=0;r<t;r++){var o=this.m_curves[r];null!=o&&o.IsVisible()&&o.RayPick(e)}},e.prototype.Traverse=function(e){r.prototype.Traverse.call(this,e)},e.prototype.FindVisiableObject=function(e){e.ClearPreapareRenderPoint();for(var t=0;t<this.m_points.length;t++){var r=this.m_points[t];null!=r&&r.IsVisible()&&e.PreapareRenderPoint(r)}e.ClearPreapareRenderLine();for(t=0;t<this.m_lines.length;t++){var i=this.m_lines[t];null!=i&&i.IsVisible()&&e.PrepareRenderLine(i)}e.ClearPreapareCurve();for(t=0;t<this.m_curves.length;t++){var n=this.m_curves[t];null!=n&&n.IsVisible()&&e.PrepareRenderCurve(n)}},e.prototype.AddPoint=function(e){if(null==e)return!1;for(var t=!1,r=0;r<this.m_points.length;r++){this.m_points[r].IsVisible(),this.m_points[r].GetName();if(this.m_points[r]==e){t=!0;break}}return!t&&(this.m_points.push(e),!0)},e.prototype.RemovePoint=function(e){if(e)for(var t=0,r=this.m_points;t<r.length;t++){var i=r[t];if(i==e){this.m_points.splice(this.m_points.indexOf(i),1);break}}},e.prototype.RemoveAllPoints=function(){this.m_points.length=0},e.prototype.AddLine=function(e){if(null==e)return!1;for(var t=!1,r=0;r<this.m_lines.length;r++)if(this.m_lines[r]==e){t=!0;break}return!t&&(this.m_lines.push(e),!0)},e.prototype.RemoveLine=function(e){for(var t=0,r=this.m_lines;t<r.length;t++){var i=r[t];if(i==e){this.m_lines.splice(this.m_lines.indexOf(i),1);break}}},e.prototype.RemoveAllLines=function(){this.m_lines.length=0},e.prototype.AddCurve=function(e){if(null==e)return!1;for(var t=!1,r=0;r<this.m_curves.length;r++)if(this.m_curves[r]==e){t=!0;break}return!t&&(this.m_curves.push(e),!0)},e.prototype.RemoveCurve=function(e){for(var t=0,r=this.m_curves;t<r.length;t++){var i=r[t];if(i==e){this.m_curves.splice(this.m_curves.indexOf(i),1);break}}},e.prototype.RemoveAllCurve=function(){this.m_curves.length=0},e.prototype.RemoveAllGeoData=function(){this.RemoveAllPoints(),this.RemoveAllLines(),this.RemoveAllCurve()},e}(t.GroupNode);t.GeometryGroup=e}(M3D||(M3D={})),function(t){var e=function(i){function e(){var e=i.call(this)||this;return e.SetScene(null),e}return __extends(e,i),e.prototype.RayPick=function(e){i.prototype.RayPick.call(this,e);for(var t=this.m_scene.GetLightManager().GetAllLight(),r=0;r<t.length;r++)t[r].RayPick(e)},e.prototype.FindVisableObject=function(e){i.prototype.FindVisiableObject.call(this,e);for(var t=this.m_scene.GetLightManager().GetAllLight(),r=0;r<t.length;r++)t[r].FindVisiableObject(e)},e.prototype.OnMarkedDirty=function(){if(i.prototype.OnMarkedDirty.call(this),this.m_scene)for(var e=this.m_scene.GetLightManager().GetAllLight(),t=0;t<e.length;t++);},e.prototype.GetScene=function(){return this.m_scene},e.prototype.Initialize=function(){},e.prototype.SetScene=function(e){this.m_scene=e},e.prototype.GetType=function(){return t.MEASURE_GROUP_NODE},e}(t.GroupNode);t.LightGroup=e}(M3D||(M3D={})),function(l){l.DEFAULT_OCTREE_SIZE=1e3,l.DEFAULT_OCTREE_LEVELS=6,l.RAYCASTS_PER_WORK_ITEM=4,l.NUM_OCTANTS=8,l.ROOT_INDEX=99999999999;var e=function(){function n(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(this.m_drawables=[],this.m_center=l.Vector3.ZERO(),this.m_halfSize=l.Vector3.ZERO(),this.m_parent=null,this.m_root=null,5==e.length){var r=e[0],i=e[1],n=e[2],o=e[3],a=e[4];this.m_level=i,this.m_numDrawables=0,this.m_parent=n,this.m_root=o,this.m_index=a,this.m_dirty=!0,this.Initialize(r),this.m_children=new Array(l.NUM_OCTANTS);for(var s=0;s<l.NUM_OCTANTS;++s)this.m_children[s]=null}}return n.prototype.Initialize=function(e){this.m_worldBoundingBox=e.Clone(),this.m_center=e.Center(),this.m_halfSize=e.Size().Multiply(.5),this.m_cullingBox=new l.BoundingBox(this.m_worldBoundingBox.min.Sub(this.m_halfSize),this.m_worldBoundingBox.max.Add(this.m_halfSize))},n.prototype.GetOrCreateChild=function(e){if(null!==this.m_children[e])return this.m_children[e];var t=this.m_worldBoundingBox.min.Clone(),r=this.m_worldBoundingBox.max.Clone(),i=this.m_worldBoundingBox.Center().Clone();return 1&e?t.x=i.x:r.x=i.x,2&e?t.y=i.y:r.y=i.y,4&e?t.z=i.z:r.z=i.z,this.m_children[e]=new n(new l.BoundingBox(t,r),this.m_level+1,this,this.m_root,e),this.m_children[e]},n.prototype.DeleteChild=function(e){e<l.NUM_OCTANTS&&null!==this.m_children[e]&&(this.m_children[e]=null)},n.prototype.GetWorldBoundingBox=function(){return this.m_worldBoundingBox},n.prototype.GetCullingBox=function(){return this.m_cullingBox},n.prototype.GetLevel=function(){return this.m_level},n.prototype.GetParent=function(){return this.m_parent},n.prototype.GetRoot=function(){return this.m_root},n.prototype.GetNumDrawables=function(){return this.m_numDrawables},n.prototype.IsEmpty=function(){return 0==this.m_numDrawables},n.prototype.InsertDrawable=function(e){var t=e.GetWorldBoundingBox();if(this===this.m_root&&this.m_cullingBox.IsInside(t)!=l.INSIDE||this.CheckDrawableFit(t)){var r=e.GetOctant();r!==this&&(this.AddDrawable(e),null!==r&&r.RemoveDrawable(e,!1))}else{var i=t.Center(),n=i.x<this.m_center.x?0:1,o=i.y<this.m_center.y?0:2,a=i.z<this.m_center.z?0:4;this.GetOrCreateChild(n+o+a).InsertDrawable(e)}this.m_dirty=!0},n.prototype.AddDrawable=function(e){e.SetOctant(this),this.m_drawables.push(e),this.IncDrawableCount()},n.prototype.IncDrawableCount=function(){++this.m_numDrawables,null!==this.m_parent&&this.m_parent.IncDrawableCount()},n.prototype.RemoveDrawable=function(e,t){void 0===t&&(t=!0);for(var r,i=!1,n=0;n<this.m_drawables.length;n++){if(this.m_drawables[n]===e){r=n,i=!0;break}}this.m_drawables.splice(r,1),i&&(t&&e.SetOctant(null),this.DecDrawableCount()),this.m_dirty=!0},n.prototype.DecDrawableCount=function(){var e=this.m_parent;--this.m_numDrawables,0===this.m_numDrawables&&null!==e&&e.DeleteChild(this.m_index),null!==e&&e.DecDrawableCount()},n.prototype.Clear=function(){for(var e=0;e<this.m_drawables.length;++e)null!==this.m_drawables[e]&&this.m_drawables[e].SetOctant(null);for(var t=this.m_drawables.length=0;t<l.NUM_OCTANTS;++t)null!==this.m_children[t]&&this.m_children[t].Clear()},n.prototype.CheckDrawableFit=function(e){var t=e.Size();return this.m_level>=this.m_root.GetNumLevels()||t.x>=this.m_halfSize.x||t.y>=this.m_halfSize.y||t.z>=this.m_halfSize.z||(e.min.x<=this.m_worldBoundingBox.min.x-.5*this.m_halfSize.x||e.max.x>=this.m_worldBoundingBox.max.x+.5*this.m_halfSize.x||e.min.y<=this.m_worldBoundingBox.min.y-.5*this.m_halfSize.y||e.max.y>=this.m_worldBoundingBox.max.y+.5*this.m_halfSize.y||e.min.z<=this.m_worldBoundingBox.min.z-.5*this.m_halfSize.z||e.max.z>=this.m_worldBoundingBox.max.z+.5*this.m_halfSize.z)},n.prototype.CompareByPlcWorldBoxLength=function(e,t){return e.GetWorldBoundingBox().Length()<t.GetWorldBoundingBox().Length()},n.prototype.GetDrawablesInternal=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(2==e.length){var r=e[0],i=e[1];if(this!=this.m_root){var n=r.TestOctant(this.m_cullingBox,i);if(n===l.Intersection.INSIDE)i=!0;else if(n===l.Intersection.OUTSIDE)return}0<this.m_drawables.length&&(this.m_dirty&&(this.m_dirty=!1,this.m_drawables=this.quickSort(this.m_drawables)),r.TestDrawables(this.m_drawables,i));for(var o=0;o<l.NUM_OCTANTS;++o)null!==this.m_children[o]&&this.m_children[o].GetDrawablesInternal(r,i)}else{if((r=e[0]).m_ray.HitDistance(this.m_cullingBox)>=r.m_maxDistance)return;for(o=0;o<l.NUM_OCTANTS;++o)this.m_children[o]&&this.m_children[o].GetDrawablesInternal(r)}},n.prototype.GetDrawablesOnlyInternal=function(e,t){if(!(e.m_ray.HitDistance(this.m_cullingBox)>=l.INFINITY)){if(0<this.m_drawables.length)for(var r=0;r<this.m_drawables.length;r++){var i=this.m_drawables[r];i.IsVisible()&&t.push(i)}for(r=0;r<l.NUM_OCTANTS;++r)null!==this.m_children[r]&&this.m_children[r].GetDrawablesOnlyInternal(e,t)}},n.prototype.quickSort=function(e){if(e.length<=1)return e;for(var t=(new Array).concat(e),r=Math.floor(t.length/2),i=t.splice(r,1)[0],n=[],o=[],a=0;a<t.length;a++)this.CompareByPlcWorldBoxLength(i,t[a])?n.push(t[a]):o.push(t[a]);return this.quickSort(n).concat([i],this.quickSort(o))},n}(),t=function(t){function e(){var e=t.call(this,new l.BoundingBox(-l.DEFAULT_OCTREE_SIZE,l.DEFAULT_OCTREE_SIZE),0,null,null,l.ROOT_INDEX)||this;return e.m_drawableUpdates=[],(e.m_root=e).m_numLevels=l.DEFAULT_OCTREE_LEVELS,e}return __extends(e,t),e.prototype.QueueUpdate=function(e){e.isOCtreeUpdated()||(this.m_drawableUpdates.push(e),e.SetOCTreeUpdated(!0))},e.prototype.GetNumLevels=function(){return this.m_numLevels},e.prototype.Clear=function(){this.m_drawableUpdates=new Array,this.m_drawableReinsertions=new Array,t.prototype.Clear.call(this);for(var e=0;e<l.NUM_OCTANTS;++e)null!==this.m_children[e]&&(this.m_children[e].Clear(),this.m_children[e]=null)},e.prototype.SetSize=function(e,t){for(var r=0;r<l.NUM_OCTANTS;++r)this.DeleteChild(r);this.Initialize(e),this.m_numDrawables=this.m_drawables.length,this.m_numLevels=1<t?t:1},e.prototype.Update=function(){if(0!=this.m_drawableUpdates.length){for(var e=0;e<this.m_drawableUpdates.length;++e){var t=this.m_drawableUpdates[e],r=t.GetOctant(),i=t.GetWorldBoundingBox();null!==r&&r.GetRoot()===this&&(r.GetCullingBox().IsInside(i)===l.INSIDE&&r.CheckDrawableFit(i)||this.InsertDrawable(t))}this.m_drawableUpdates=new Array}},e.prototype.AddManualDrawable=function(e){null!==e&&null===e.GetOctant()&&this.AddDrawable(e)},e.prototype.RemoveManualDrawable=function(e){if(null!==e){var t=e.GetOctant();null!==t&&t.GetRoot()===this&&t.RemoveDrawable(e)}},e.prototype.GetDrawables=function(e){e.m_result.length=0,this.GetDrawablesInternal(e,!1)},e.prototype.Raycast=function(e){},e.prototype.RaycastSingle=function(e){e.m_result.length=0,this.m_rayQuery=e,this.m_rayQueryDrawables=new Array,this.GetDrawablesOnlyInternal(e,this.m_rayQueryDrawables);for(var t=0,r=this.m_rayQueryDrawables;t<r.length;t++){var i=r[t];e.m_fastResult.push(i)}},e.prototype.RaycastSingleFast=function(e){e.m_result.length=0,this.m_rayQuery=e,this.m_rayQueryDrawables=new Array,this.GetDrawablesOnlyInternal(e,this.m_rayQueryDrawables);for(var t=0,r=this.m_rayQueryDrawables;t<r.length;t++){var i=r[t];e.m_fastResult.push(i)}},e}(l.Octant=e);l.Octree=t}(M3D||(M3D={})),function(r){var e;(e=r.RayQueryLevel||(r.RayQueryLevel={}))[e.RAY_AABB=0]="RAY_AABB",e[e.RAY_OBB=1]="RAY_OBB",e[e.RAY_TRIANGLE=2]="RAY_TRIANGLE",e[e.RAY_TRIANGLE_UV=3]="RAY_TRIANGLE_UV";var t=function(){};r.OctreeQueryResult=t;var i=function(){};r.RayQueryResult=i;var n=function(e,t,r,i){this.m_result=[],this.m_fastResult=e,this.m_ray=t.Clone(),this.m_level=r,this.m_maxDistance=i};r.RayOctreeQuery=n;var o=function(){function e(e,t,r){this.m_result=e,this.m_drawableFlags=t,this.m_viewMask=r}return e.prototype.TestOctant=function(e,t){return 0},e.prototype.TestDrawables=function(e,t){},e.prototype.GetCamera=function(){return this.m_camera},e.prototype.SetCamera=function(e){this.m_camera=e},e.prototype.GetRenderAction=function(){return this.m_renderAction},e.prototype.SetRenderAction=function(e){this.m_renderAction=e},e}(),a=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.TestOctant=function(e,t){return r.Intersection.INSIDE},t.prototype.TestDrawables=function(e,t){},t}(r.OctreeQuery=o);r.AllContentOctreeQuery=a;var s=function(o){function e(e,t,r,i){var n=o.call(this,e,r,i)||this;return n.m_frustum=t,n}return __extends(e,o),e.prototype.TestOctant=function(e,t){return t?r.Intersection.INSIDE:this.m_frustum.IsInside(e)},e.prototype.TestDrawables=function(e,t){for(var r=0;r<e.length;r++){var i=e[r];if(this.m_renderAction&&this.m_camera)if(2==this.m_renderAction.GetCullerHelper().IsLittleModel(i.GetWorldBoundingBox(),this.m_camera))return;this.m_result.push(i)}},e}(o);r.FrustumOctreeQuery=s;var l=function(o){function e(e,t,r,i){var n=o.call(this,e,r,i)||this;return n.m_box=t.Clone(),n}return __extends(e,o),e.prototype.TestOctant=function(e,t){return t?r.Intersection.INSIDE:this.m_box.IsInside(e)},e.prototype.TestDrawables=function(e,t){},e}(o);r.BoxOctreeQuery=l;var h=function(o){function e(e,t,r,i){var n=o.call(this,e,r,i)||this;return n.m_sphere=t,n}return __extends(e,o),e.prototype.TestOctant=function(e,t){return t?r.Intersection.INSIDE:this.m_sphere.IsInside(e)},e.prototype.TestDrawables=function(e,t){},e}(o);r.SphereOctreeQuery=h;var u=function(o){function e(e,t,r,i){var n=o.call(this,e,r,i)||this;return n.m_point=t,n}return __extends(e,o),e.prototype.TestOctant=function(e,t){return t?r.Intersection.INSIDE:e.IsInside(this.m_point)},e.prototype.TestDrawables=function(e,t){},e}(o);r.PointOctreeQuery=u}(M3D||(M3D={})),function(s){var e=function(a){function e(e){var t=a.call(this)||this;return t.m_scene=null,t.m_svlTools=[],t.m_scene=e,t}return __extends(e,a),e.prototype.GetType=function(){return s.SCREENLAYER_GROUP_NODE},e.prototype.RayPick=function(e){a.prototype.RayPick.call(this,e);var t=new s.RayPickAction(e.GetScene());t.SetCamera(e.GetScene().GetHudCamera()),t.SetPickShapeType(e.GetPickShapeType()),t.SetPickGeoType(e.GetPickGeoType()),t.SetRay(e.GetScreentPoint());for(var r=0;r<this.m_svlTools.length;r++){var i=this.m_svlTools[r];if(i.GetType()==s.ShapeType.SHAPE_IMAGE_MODEL)i.RayPick(t)}var n=t.GetNearPickShape(),o=t.GetNearestPickPoint();n&&(e.AddIntersectPnt(o),e.AddShape(n)),t=null},e.prototype.Traverse=function(e){a.prototype.Traverse.call(this,e)},e.prototype.FindVisiableObject=function(e){var t=e.currentRenderImageQueueIndex;e.currentRenderImageQueueIndex=2;for(var r=0;r<this.m_svlTools.length;r++){var i=this.m_svlTools[r];if(i.GetType()==s.ShapeType.SHAPE_IMAGE_MODEL)i.FindVisiableObject(e)}e.currentRenderImageQueueIndex=t},e.prototype.AddHudModel=function(e){if(null==e)return!1;for(var t=!1,r=!1,i=0;i<this.m_svlTools.length;i++)this.m_svlTools[i]==e&&(r=!0);return r||(this.m_svlTools.push(e),t=!0),t},e.prototype.RemoveHudModel=function(e){if(null==e)return!1;for(var t=0;t<this.m_svlTools.length;t++)if(this.m_svlTools[t]==e){this.m_svlTools.splice(this.m_svlTools.indexOf(e),1);break}},e.prototype.RemoveHudModelByName=function(e){for(var t=0;t<this.m_svlTools.length;t++){var r=this.m_svlTools[t];if(null!=r&&r.GetName()==e){this.m_svlTools.splice(t,1);break}}},e.prototype.RemoveAllHudModel=function(){this.m_svlTools=null},e.prototype.GetHudModelByName=function(e){for(var t=null,r=0;r<this.m_svlTools.length;r++){var i=this.m_svlTools[r];if(null!=i&&i.GetName()==e){t=i;break}}return t},e.prototype.BindBoxDragger=function(e,t){},e.prototype.UnBindBoxDragger=function(){},e}(s.GroupNode);s.ScreenUILayerGroup=e}(M3D||(M3D={})),function(r){var e=function(t){function e(){var e=t.call(this)||this;return e.m_section=null,e.SetScene(null),e}return __extends(e,t),e.prototype.SetScene=function(e){this.m_scene=e},e.prototype.GetScene=function(){return this.m_scene},e.prototype.GetSection=function(){null==this.m_section&&(this.m_section=new r.Section),this.m_section.SetBox(this.GetScene().GetSceneBox());var e=this.GetScene().GetSceneBox();return e.ScaleBox(1.3),this.m_section.SetDrawRection(e),this.m_section},e.prototype.RayPick=function(e){},e.prototype.ComputeBox=function(){},e.prototype.GetPickType=function(){return r.PICKTYPE_MODEL},e.prototype.GetType=function(){return r.SECTION_NODE},e.prototype.OnMarkedDirty=function(){this.m_section&&this.m_section.SetTransform(this.GetWorldTransform())},e.prototype.FindVisiableObject=function(e){this.m_section&&this.m_section.FindVisiableObject(e)},e}(r.SceneNode);r.SectionNode=e}(M3D||(M3D={})),function(s){var e=function(){function e(){this.UpdatePercent=function(){},this.UpdateWorkTask=function(){},this.UpdateStopPlaying=function(){}}return e.prototype.OnExecute=function(e,t){},e.prototype.OnStopTask=function(e,t){this.UpdateStopPlaying()},e.prototype.OnTick=function(e,t){e instanceof r&&(this.UpdatePercent(),this.UpdateWorkTask())},e.prototype.OnActive=function(e,t){},e}();s.AnimationTaskLinstener=e;var t=function(){function e(){this._currentWorkTask=null,this._stoped=!1,this.canBegin=!1,this._manager=null}return e.prototype.SetManager=function(e){this._manager=e},e.prototype.Execute=function(){if(0<this._manager.workTaskList.length&&this.canBegin){if(null===this._currentWorkTask)this._currentWorkTask=this._manager.workTaskList[0],this._currentWorkTask.IsRun()||(this._currentWorkTask.Active(),0<=this._manager.pausePos&&(this._currentWorkTask.SetPercent(this._manager.pausePos),this._manager.pausePos=0),this._manager.hasCompleted=!1,this._currentWorkTask.Play(),this._manager.SetActiveTask(this._currentWorkTask));else if(!this._currentWorkTask.IsRun()){var e=this._manager.workTaskList.indexOf(this._currentWorkTask);-1<e&&this._manager.workTaskList.splice(e,1),0<this._manager.workTaskList.length&&(this._currentWorkTask=null)}for(var t=0;t<this._manager._animatinTaskListeners.length;t++)this._manager._animatinTaskListeners[t].OnTick(this._manager,this._manager.GetActiveTask);this._stoped=!1}else if(this._currentWorkTask&&(this._manager.viewer.GetSimulationMgr().GetAnimationStepManager().GetCurrentProcessManager().CurProcessID=-1,this._currentWorkTask=null),!1===this._stoped){this._stoped=!0;for(var r=0;r<this._manager._animatinTaskListeners.length;r++)this._manager._animatinTaskListeners[r].OnStopTask(this._manager,this._manager.GetActiveTask);this._manager.viewer.GetSimulationMgr().GetAnimationStepManager().GetProcessManagerList().forEach(function(e){e.CurProcessID=-1}),(99.99<this._manager.GetPercent()||0===this._manager.workTaskList.length)&&(this._manager.pausePos=0,this._manager.SetActiveTask(null),this._manager.IsLoop()&&(this._manager.Reset(),this._manager.PlayAll()))}},e}();s.HandlerTask=t;var r=function(){function e(e){this._animationTasksWithProcess=[],this._animationTasks=[],this._activeTask=null,this._speed=1,this.pausePos=0,this.temPausePos=0,this.viewer=null,this.workTaskList=[],this._animatinTaskListeners=[],this._handlerTask=new t,this.hasCompleted=!0,this.isPlaying=!1,this.animationTimer=null,this.nativeAnimationTimer=null,this._isLoop=!1,this._autoWalkCamera=!1,this.animationEnd=function(){},this._handlerTask.SetManager(this),this.viewer=e}return e.prototype.AddTaskListener=function(e){var t=!1;return null!==e&&-1===this._animatinTaskListeners.indexOf(e)&&(this._animatinTaskListeners.push(e),t=!0),t},e.prototype.ClearTaskListeners=function(){return this._animatinTaskListeners=[],!0},e.prototype.RemoveTaskListeners=function(e){var t=!1;return null!=e&&-1!==this._animatinTaskListeners.indexOf(e)&&(this._animatinTaskListeners.splice(this._animatinTaskListeners.indexOf(e),1),t=!0),t},e.prototype.OpenFile=function(){this.viewer.AnimationIit(),this.ClearData(),this.SetupTasks()},e.prototype.Open=function(){this.viewer.AnimationIit(),this.ClearData(),this.SetupTasks()},e.prototype.ClearData=function(){this.CloseTaskList(),this._animationTasks=[],this._animationTasksWithProcess=[],this.SetActiveTask(null),this.pausePos=-1,this.temPausePos=0},e.prototype.CloseTaskList=function(){this._handlerTask.canBegin=!1,this._handlerTask.Execute(),this.workTaskList=[],null!==this.GetActiveTask()&&this.GetActiveTask().Pause()},e.prototype.SetIsPlaying=function(e){this.isPlaying=e},e.prototype.GetIsPlaying=function(){return this.isPlaying},e.prototype.IsPlaying=function(){return this.isPlaying},e.prototype.Close=function(){s.SimulationAnimationManager.Instance().ExitAll(),this.viewer.GetModel().ResetAlpha(),this.Reset(),s.SimulationAnimationManager.Instance().pAnimationStepManager.GetCurrentProcessManager().CurProcessID=-1},e.prototype.SetActiveTask=function(e){this._activeTask=e;for(var t=0;t<this._animatinTaskListeners.length;t++)this._animatinTaskListeners[t].OnActive(this,this._activeTask)},e.prototype.SetCurStep=function(e){this.SetActiveTask(e)},e.prototype.SetupTasks=function(){this.ClearData();var e=this.viewer.AnimationGetInfo();this.getSteps(e)},e.prototype.getSteps=function(e){for(var t=0;t<e.length;t++){this._animationTasksWithProcess.push(e[t]),e[t].GetChildProcessList()&&this.getSteps(e[t].GetChildProcessList());for(var r=e[t].GetStepList(),i=0;i<r.length;i++)this._animationTasks.push(r[i]),this._animationTasksWithProcess.push(r[i])}},e.prototype.GetTaskList=function(){return this.viewer.AnimationGetInfo()},e.prototype.GetTasks=function(){return this.viewer.AnimationGetInfo()},e.prototype.GetAllAnimations=function(){return this.viewer.AnimationGetInfo()},e.prototype.AnimationTask1=function(e){e._handlerTask.Execute()},e.prototype.NativeAnimationTickTask=function(e){e.viewer.OnAnimationTick()},e.prototype.ExecuteTaskList=function(){this._handlerTask.canBegin=!0,null===this.animationTimer&&(this.nativeAnimationTimer=new s.Timer,this.nativeAnimationTimer.SetTimer(this.NativeAnimationTickTask,this,10),this.nativeAnimationTimer.StartTimer(),this.animationTimer=new s.Timer,this.animationTimer.SetTimer(this.AnimationTask1,this,100),this.animationTimer.StartTimer())},e.prototype.Reset=function(){this.StopPlayer()},e.prototype.AddTask=function(e){null!==e&&1===e.GetType()&&this.workTaskList.push(e)},e.prototype.GetActiveTask=function(){return this._activeTask},e.prototype.GetPercent=function(){var e=0;if(1===this._animationTasks.length)null!==(t=this.GetActiveTask())&&(e=t.Percent(),this.temPausePos=e);else if(1<this._animationTasks.length){var t;if(null!==(t=this.GetActiveTask())){var r=this._animationTasks.indexOf(t),i=100/this._animationTasks.length;e=r*i+t.Percent()*i/100,this.temPausePos=t.Percent()}}return e},e.prototype.GetTick=function(){var e=0;if(1===this._animationTasks.length)null!==(t=this.GetActiveTask())&&(e=t.Percent(),this.temPausePos=e);else if(1<this._animationTasks.length){var t;if(null!==(t=this.GetActiveTask())){var r=this._animationTasks.indexOf(t),i=100/this._animationTasks.length;e=r*i+t.Percent()*i/100,this.temPausePos=t.Percent()}}return e},e.prototype.GetActiveTaskWithProcessIndex=function(){return this._animationTasksWithProcess.indexOf(this._activeTask)},e.prototype.SetPercent=function(e){if(1===this._animationTasks.length)null!==(i=this.GetActiveTask())&&(this.GetActiveTask().SetPercent(e),this.pausePos=e);else if(1<this._animationTasks.length){var t=100/this._animationTasks.length,r=Math.floor(e/t);if(r<this._animationTasks.length&&0<=r){var i=this._animationTasks[r];this.SetActiveTask(i);var n=100*(e-r*t)/t;this.pausePos=n}}},e.prototype.SetTick=function(e){if(1===this._animationTasks.length)null!==(i=this.GetActiveTask())&&(this.GetActiveTask().SetPercent(e),this.pausePos=e);else if(1<this._animationTasks.length){var t=100/this._animationTasks.length,r=Math.floor(e/t);if(r<this._animationTasks.length&&0<=r){var i=this._animationTasks[r];this.SetActiveTask(i);var n=100*(e-r*t)/t;this.pausePos=n}}},e.prototype.IsLoop=function(){return this._isLoop},e.prototype.SetLoop=function(e){this._isLoop=e,null!==this.viewer&&this.viewer.AnimationContinuousPlay(!1)},e.prototype.PlayNextAll=function(){if(this.CloseTaskList(),null!==this.GetActiveTask()){var e=this._animationTasks.indexOf(this.GetActiveTask());if(e<this._animationTasks.length)if(this.pausePos<100)this.Play(e,this._animationTasks.length);else{var t=e+1;this.Play(t===this._animationTasks.length?0:t,this._animationTasks.length)}else this.ExecuteTaskList()}else this.PlayAll()},e.prototype.Play=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(0===e.length)this.CloseTaskList(),null!=this.GetActiveTask()&&this.AddTask(this.GetActiveTask()),this.ExecuteTaskList();else if(1===e.length)e[0]<this._animationTasks.length&&(s.SimulationAnimationManager.Instance().ExitAll(),this.Play(e[0],this._animationTasks.length));else if(2===e.length){if(this.CloseTaskList(),e[0]<e[1]&&0<=e[0]&&e[1]<=this._animationTasks.length)for(var r=e[0];r<e[1];r++)this.AddTask(this._animationTasks[r]);this.ExecuteTaskList()}},e.prototype.playAnimation=function(e,t){if(0===this._animationTasks.length&&this.OpenFile(),this.StopPlayer(),null==t){for(var r=0,i=-1,n=[e],o=0;o<this._animationTasksWithProcess.length;o++)this._animationTasksWithProcess[o]instanceof s.SAnimationStep&&0<=n.indexOf(this._animationTasksWithProcess[o].GetProcessId())&&(r++,-1===i&&(i=this._animationTasksWithProcess[o].GetId())),this._animationTasksWithProcess[o]instanceof s.SAnimationProcess&&(0<=n.indexOf(this._animationTasksWithProcess[o].GetId())||0<=n.indexOf(this._animationTasksWithProcess[o].GetProcessId()))&&n.push(this._animationTasksWithProcess[o].GetId());for(o=0;o<this._animationTasks.length;o++)if(i===this._animationTasks[o].GetId()&&0<=n.indexOf(this._animationTasks[o].GetProcessId())){this.Play(o,o+r);break}}else{for(r=0,o=0;o<this._animationTasks.length;o++){var a=this._animationTasks[o];if(a.GetProcessId()===e&&a.GetId()===t){r++,this.Play(o,o+r);break}}t||this.ExecuteTaskList()}},e.prototype.GetSpeed=function(){return this._speed},e.prototype.SetSpeed=function(e){this._speed=e,this.viewer.AnimationPlaySpeed(e)},e.prototype.GetPreTask=function(e){var t=this._animationTasks.length-1;return null!=e&&(t=this._animationTasks.indexOf(e)),0<=--t?this._animationTasks[t]:this._animationTasks[0]},e.prototype.GetNextTask=function(e){var t=-1;return null!==e&&(t=this._animationTasks.indexOf(e)),++t<this._animationTasks.length?this._animationTasks[t]:this._animationTasks[0]},e.prototype.GetTaskPercent=function(){var e=0;return null!==this.GetActiveTask()&&(e=this.GetActiveTask().Percent()),e},e.prototype.SetAutoWalkCamera=function(e){this._autoWalkCamera=e,this.viewer.AnimationPlayCamera(e)},e.prototype.GetAutoWalkCamera=function(){return this._autoWalkCamera},e.prototype.PlayAll=function(){this.CloseTaskList();for(var e=0;e<this._animationTasks.length;e++)this.AddTask(this._animationTasks[e]);this.ExecuteTaskList()},e.prototype.Pause=function(){this.GetPercent(),this.pausePos=this.temPausePos,this.CloseTaskList()},e.prototype.Resume=function(){this.PlayNextAll()},e.prototype.Continue=function(){this.PlayNextAll()},e.prototype.IsSingleAnimation=function(){var e=!0;return 1<this._animationTasks.length&&(e=!1),e},e.prototype.PlayPrevious=function(){if(this.IsSingleAnimation()){var e=this.GetPercent()-5;e<0&&(e=0),this.SetPercent(e)}else this.PlayPreSeg()},e.prototype.PlayPreSeg=function(){this.CloseTaskList(),this.SetActiveTask(this.GetPreTask(this.GetActiveTask())),this.PlayNextAll()},e.prototype.PlayNext=function(){if(this.IsSingleAnimation()){var e=this.GetPercent()+5;100<e&&(e=0),this.SetPercent(e)}else this.PlayNextSeg()},e.prototype.PlayNextSeg=function(){this.CloseTaskList(),this.SetActiveTask(this.GetNextTask(this.GetActiveTask())),this.PlayNextAll()},e.prototype.StopPlayer=function(){this.CloseTaskList(),this.SetActiveTask(null),this.pausePos=-1,this.temPausePos=0,this.animationEnd(),null!==this.animationTimer&&(this.animationTimer.StopTimer(),this.animationTimer=null,this.nativeAnimationTimer.StopTimer(),this.nativeAnimationTimer=null)},e.prototype.GetParameter=function(e){return this[e]},e.prototype.SetParameter=function(e,t){this[e]&&(this[e]=t)},e.prototype.ExistAnimation=function(){return this.viewer.HasAnimations()},e}();s.AnimationPlayer=r}(M3D||(M3D={})),function(e){var t=function(){function e(){this._isAsyncExecute=!1,this.listeners=[]}return e.prototype.AddListener=function(e){this.listeners.push(e)},e.prototype.Close=function(){null!=this.GetManager()&&this.GetManager().Complete(this),this.FireListener(e.CmdCompletedMsg)},e.prototype.Cancle=function(){},e.prototype.Execute=function(){this.GetManager().Run(this)},e.prototype.GetManager=function(){return this._cmdMng},e.prototype.GetName=function(){return null==this._name?this.toString():this._name},e.prototype.isAsyncExecute=function(){return this._isAsyncExecute},e.prototype.OnTouchHandle=function(e,t){return!1},e.prototype.SetAsyncExecute=function(e){this._isAsyncExecute=e},e.prototype.SetManager=function(e){this._cmdMng=e},e.prototype.SetName=function(e){this._name=e},e.prototype.FireListener=function(e){for(var t=0,r=this.listeners;t<r.length;t++){r[t].OnHandle(this,e)}},e.CmdCompletedMsg=1,e.CmdPromptMsg=2,e}();e.Command=t}(SView||(SView={})),function(e){var t=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.isAsyncExecute=function(){return!0},t.prototype.OnExecute=function(){},t}(e.Command);e.AsyncCommand=t}(SView||(SView={})),function(S){var i,e;(e=i=S.AnnotationCommandType||(S.AnnotationCommandType={}))[e.ANNOTATION_TEXT=0]="ANNOTATION_TEXT",e[e.ANNOTATION_NUMBER=1]="ANNOTATION_NUMBER",e[e.ANNOTATION_COMPONENT=2]="ANNOTATION_COMPONENT",e[e.ANNOTATION_HOTSPOT=3]="ANNOTATION_HOTSPOT",e[e.ANNOTATION_EDIT=11]="ANNOTATION_EDIT";var t=function(r){function e(e){var t=r.call(this)||this;return t.sview=null,t._annotationCommandManager=null,t._clickflag=!1,t._priDragX=0,t._priDragY=0,t._annotation=null,t.annotationStep=0,t._touchDownSelectedShape=null,t._onDrag=!1,t.sview=e,t.SetCommandType(i.ANNOTATION_TEXT),t}return __extends(e,r),e.prototype.Close=function(){this.sview.view.SetSelectType(M3D.ShapeType.SHAPE_MODEL),r.prototype.Close.call(this)},e.prototype.GetAnnotationCommandManager=function(){return this._annotationCommandManager},e.prototype.SetAnnotationCommandManager=function(e){this._annotationCommandManager=e},e.prototype.ExecuteNew=function(){null!=this.sview&&this._annotationCommandManager.ExcuateCmmand(this.GetCommandType(),this._annotation.GetAnnotationType())},e.prototype.SetCommandType=function(e){this.annotationCommandType=e},e.prototype.GetCommandType=function(){return this.annotationCommandType},e.prototype.OnAsyncExecute=function(e){},e.prototype.SelectedPnt=function(e,t,r){var i=0;return r&&(i=this.sview.view.SelectTempShape(e,t,M3D.ShapeType.SHAPE_FEATURE_COORDINATE,M3D.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_UNKNOWN)),0<i||(i=this.sview.view.SelectTempShape(e,t,M3D.ShapeType.SHAPE_COORDINATE,M3D.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_UNKNOWN)),i},e.prototype.IsUseFeaturePnt=function(){return this._useFeaturePnt},e.prototype.SetUseFeaturePnt=function(e){this._useFeaturePnt=e},e.prototype.IsSingleClick=function(e){var t=!1;switch(e.getEventType()){case S.TOUCH_MASK.TOUCH_DOWN:1==e.getTouchCount()&&(this._clickflag=!0),this._previousX=e.getX(),this._previousY=e.getY();break;case S.TOUCH_MASK.TOUCH_MOVE:break;case S.TOUCH_MASK.TOUCH_UP:this._clickflag&&(t=!0),this._clickflag=!1}return t},e.prototype.RemoveModelParent=function(e){var t=e.GetParent();t&&(this.sview.GetSelector().Exist(t)?(!0,this.sview.GetSelector().Remove(t)):this.RemoveModelParent(e.GetParent()))},e.prototype.ProcessEditAndDrag=function(e,t){var r=0;switch(t.getEventType()){case S.TOUCH_MASK.TOUCH_DOWN:if(1==t.getTouchCount()){this._priDragX=t.getX(),this._priDragY=t.getY();var i=this.sview.view.SelectTempShape(this._priDragX,this._priDragY,M3D.ShapeType.SHAPE_ANNOTATION_NOTE,0);if(0<i)if(this._touchDownSelectedShape=this.sview.GetNativeShapeManager().GetShape(i),this._touchDownSelectedShape instanceof M3D.Annotation){var n=M3D.AnnotationFactory.calculateGap(this._touchDownSelectedShape,this._priDragX,this.sview.view.GetSceneManager());this._touchDownSelectedShape.SetGap(n)}else this._touchDownSelectedShape=null;else this._touchDownSelectedShape=null}break;case S.TOUCH_MASK.TOUCH_MOVE:if(1!=t.getTouchCount()||null==this._touchDownSelectedShape)break;var o=new M3D.Vector2(this._priDragX,this._priDragY),a=new M3D.Vector2(t.getX(),t.getY());return 1e-7<o.Sub(a).Length()&&(this._onDrag=!0),this._priDragX=t.getX(),this._priDragY=t.getY(),this.sview.view.UpdateAnnotationImagePos(this._touchDownSelectedShape,this._priDragX,this._priDragY),1;case S.TOUCH_MASK.TOUCH_UP:this._touchDownSelectedShape=null}if(1==this._onDrag)return this._onDrag=!1,1;if(!this.IsSingleClick(t))return 2;t.getX(),t.getY();var s=this.sview.view.SelectTempShape(t.getX(),t.getY(),M3D.ShapeType.SHAPE_ANNOTATION_NOTE,M3D.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_UNKNOWN),l=this.sview.view.SelectTempShape(t.getX(),t.getY(),M3D.ShapeType.IMAGEMODEL_SHAPE,M3D.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_UNKNOWN);if(0<s){null!=(h=this.sview.GetNativeShapeManager().GetShape(s))&&(this.sview.GetSelector().Exist(h)?this.sview.GetSelector().Remove(h):this.sview.GetSelector().Add(h),r=1)}else{var h;if(0<l)if(null!=(h=this.sview.GetNativeShapeManager().GetShape(s))){if(h instanceof M3D.ImageModel)for(var u=0,p=S.SHotSpotManager.Instance().GetAllHotSpotList();u<p.length;u++){h===p[u].GetHotSpotImage()&&(this.sview.GetSelector().Exist(h)?this.sview.GetSelector().Remove(h):this.sview.GetSelector().Add(h))}r=1}if(M3D.Parameters.Instance().canPickModel){var c=this.sview.view.SelectTempShape(this._priDragX,this._priDragY,M3D.ShapeType.SHAPE_MODEL,0);if(0<c){var d=this.sview.GetShpae(c);if("floor"===d.GetName())return void this.sview.GetSelector().Clear();this.sview.GetSelector().Exist(d)?this.sview.GetSelector().Remove(d):d.IsSelected()?this.RemoveModelParent(d):this.sview.GetSelector().Add(d)}else this.sview.GetSelector().Clear()}else this.sview.GetSelector().Clear()}return r},e.prototype.getAnnotationStep=function(){return this.annotationStep},e.prototype.setAnnotationStep=function(e){this.annotationStep=e},e.prototype.GetAnnotation=function(){return this._annotation},e.prototype.SetAnnotation=function(e){this._annotation=e},e.prototype.SaveAnnotation=function(e){this.sview.GetView().GetSAnnotationManager().Add(e)},e}(S.AsyncCommand);S.AnnotationCommand=t}(SView||(SView={})),function(o){var e=function(r){function e(e){var t=r.call(this,e)||this;return t.number=0,t.SetCommandType(o.AnnotationCommandType.ANNOTATION_COMPONENT),t}return __extends(e,r),e.prototype.OnTouchHandle=function(e,t){var r=!1,i=this.ProcessEditAndDrag(e,t);if(1==i)return!0;if(2==i)return!1;var n=this.GetAnnotation();return null!=n&&(n.GetAnnotationType()==o.SAnnotation.ANNOTATION_TYPE_COMPONENTNAME&&(this.ComponentNameNoteStep0(t),r=!0),r)},e.prototype.ComponentNameNoteStep0=function(e){var t=this.GetAnnotation();if(M3D.ShapeType.SHAPE_POINT==M3D.ShapeType.SHAPE_POINT){var r,i=e.getX(),n=e.getY();r=this.SelectedPnt(i,n,this.IsUseFeaturePnt());var o=this.sview.view.GetPickShape(i,n,M3D.ShapeType.SHAPE_MODEL,0);0!=r&&(t.SetFirstShape(r),t.SetFirstAnchorX(i),t.SetFirstAnchorY(n),t.SetTextString(String(o.GetName())),this.componentNameNoteStep1(i,n))}},e.prototype.componentNameNoteStep1=function(e,t){var r=this.GetAnnotation();r.SetAnchorX(e);var i=t;i<this.sview.view.sceneManager.GetCamera().GetViewPort().GetRect().Height()/2?r.SetAnchorY(i-50*window.devicePixelRatio):r.SetAnchorY(i+100*window.devicePixelRatio),r.Create()?(this.sview.GetNativeShapeManager().AddShape(r.GetID(),r.GetNoteObj()),this.setAnnotationStep(0),this.SaveAnnotation(r),this.Close(),this.ExecuteNew()):this.ProcessError()},e.prototype.ProcessError=function(){this.Close(),this.ExecuteNew()},e.prototype.Close=function(){r.prototype.Close.call(this),this.ClearTmpSource()},e.prototype.ClearTmpSource=function(){var e=this.GetAnnotation();if((this.setAnnotationStep(0),null!=e)&&(e.GetAnnotationType()==o.SAnnotation.ANNOTATION_TYPE_COMPONENTNAME&&e instanceof o.SAnnotationComponent)){var t=e.GetFirstShape();0<t&&this.sview.view.RemoveShape(t)}},e}(o.AnnotationCommand);o.AnnotationComponentCommand=e}(SView||(SView={})),function(h){var e=function(){function e(){}return e.onAnnotationText=function(e){var t=e.GetAnnotationCommandManager(),r=t.GetCurrentCommand(),i=e.GetHotSpotCommandManager();(null!=i.GetCurrentCommand()&&i.CloseCurrentCommand(),null!=r)?r.GetAnnotation().GetAnnotationType()!=h.SAnnotation.ANNOTATION_TYPE_TEXT?(t.CloseCurrentCommand(),t.ExcuateCmmand(h.AnnotationCommandType.ANNOTATION_TEXT,h.SAnnotation.ANNOTATION_TYPE_TEXT)):t.ExecuteEditCommand():t.ExcuateCmmand(h.AnnotationCommandType.ANNOTATION_TEXT,h.SAnnotation.ANNOTATION_TYPE_TEXT)},e.onVoiceNote=function(e){var t=e.GetMeasureCommandManager(),r=t.GetCurrentCommand(),i=e.GetHotSpotCommandManager();(null!=i.GetCurrentCommand()&&i.CloseCurrentCommand(),null!=r)?r.GetMeasure().GetMeasureType()!=h.SMeasure.MEASURE_VOICE_NOTE?(t.CloseCurrentCommand(),t.ExcuateCmmand(h.MeasureCommandType.MEASURE_VOICE_NOTE,h.SMeasure.MEASURE_VOICE_NOTE)):t.ExecuteEditCommand():t.ExcuateCmmand(h.MeasureCommandType.MEASURE_VOICE_NOTE,h.SMeasure.MEASURE_VOICE_NOTE)},e.onSequenceNote=function(e){var t=e.GetAnnotationCommandManager(),r=t.GetCurrentCommand(),i=e.GetHotSpotCommandManager();(null!=i.GetCurrentCommand()&&i.CloseCurrentCommand(),null!=r)?r.GetAnnotation().GetAnnotationType()!=h.SAnnotation.ANNOTATION_TYPE_ORDER?(t.CloseCurrentCommand(),t.ExcuateCmmand(h.AnnotationCommandType.ANNOTATION_NUMBER,h.SAnnotation.ANNOTATION_TYPE_ORDER)):t.ExecuteEditCommand():t.ExcuateCmmand(h.AnnotationCommandType.ANNOTATION_NUMBER,h.SAnnotation.ANNOTATION_TYPE_ORDER)},e.onComponentNameNote=function(e){var t=e.GetAnnotationCommandManager(),r=t.GetCurrentCommand(),i=e.GetHotSpotCommandManager();(null!=i.GetCurrentCommand()&&i.CloseCurrentCommand(),null!=r)?r.GetAnnotation().GetAnnotationType()!=h.SAnnotation.ANNOTATION_TYPE_COMPONENTNAME?(t.CloseCurrentCommand(),t.ExcuateCmmand(h.AnnotationCommandType.ANNOTATION_COMPONENT,h.SAnnotation.ANNOTATION_TYPE_COMPONENTNAME)):t.ExecuteEditCommand():t.ExcuateCmmand(h.AnnotationCommandType.ANNOTATION_COMPONENT,h.SAnnotation.ANNOTATION_TYPE_COMPONENTNAME)},e.onNoteDelete=function(e){var t=e.GetSelector();if(null!=t){for(var r=new Array,i=t.GetAll(),n=0;n<i.length;n++)r.push(i[n]);0<r.length&&t.Clear();for(n=0;n<r.length;n++){var o=r[n];if(e.GetNativeShapeManager().RemoveShape(o.GetID()),o instanceof M3D.ImageModel)for(var a=0,s=h.SHotSpotManager.Instance().GetAllHotSpotList();a<s.length;a++){var l=s[a];o===l.GetHotSpotImage()&&(e.view.GetSceneManager().GetHandlerGroup().RemoveSVLTool(o.GetName()),h.SHotSpotManager.Instance().DeleteHotspot(l))}else e.view.RemoveShape(o.GetID())}}},e.onAnnotationExit=function(e){e.GetAnnotationCommandManager().CloseAllCommand();var t=e.GetHotSpotCommandManager();null!=t.GetCurrentCommand()&&t.CloseCurrentCommand(),e.GetView().GetSAnnotationManager().Clear()},e.onAnnotationClose=function(e){e.GetAnnotationCommandManager().CloseAllCommand(),e.GetHotSpotCommandManager().CloseAllCommand()},e.onTextNoteDelete=function(e){e.GetAnnotationCommandManager()},e.onBase=function(e){var t=e.GetAnnotationCommandManager();null!=t.GetCurrentCommand()?t.ExecuteEditCommand():t.ExcuateCmmand(h.AnnotationCommandType.ANNOTATION_EDIT,h.SAnnotation.ANNOTATION_TYPE_BASE)},e}();h.AnnotationOperate=e}(SView||(SView={})),function(r){var e=function(){function e(e){this._commandsMap=new M3D.Map,this._currentCommand=null,this._annotationCommandType=r.AnnotationCommandType.ANNOTATION_TEXT,this._sview=null,this.SetSviewControl(e)}return e.prototype.GetCurrentCommand=function(){return this._currentCommand},e.prototype.SetCurrentCommand=function(e){this._currentCommand=e},e.prototype.CloseCurrentCommand=function(){null!=this._currentCommand&&(this._currentCommand.Close(),this._currentCommand=null)},e.prototype.SetSviewControl=function(e){this._sview=e},e.prototype.GetSviewControl=function(){return this._sview},e.prototype.ExecuteEditCommand=function(){this.CloseCurrentCommand(),this._sview.view.SetSelectType(M3D.ShapeType.SHAPE_NOTE_BASE),this.ExcuateCmmand(r.AnnotationCommandType.ANNOTATION_TEXT,M3D.NoteType.TextNote)},e.prototype.CloseAllCommand=function(){this._currentCommand=null,this._annotationCommandType=r.AnnotationCommandType.ANNOTATION_TEXT;for(var e=0,t=this._commandsMap.Values();e<t.length;e++){t[e].Close()}this._commandsMap.Clear()},e.prototype.ExcuateCmmand=function(e,t){if(this._currentCommand=this.GetCommand(e),null!=this._currentCommand){this._annotationCommandType=e,this.GetSviewControl().GetCommandManager().AddCommand(this._currentCommand);var r=this.CreateAnnotation(e);r.SetAnnotationType(t),this._currentCommand.SetAnnotation(r),this._currentCommand.SetAnnotationCommandManager(this),this._currentCommand.Execute(),this._currentCommand.Execute()}},e.prototype.CreateAnnotation=function(e){var t=null;switch(e){case r.AnnotationCommandType.ANNOTATION_TEXT:t=new r.SAnnotationText;break;case r.AnnotationCommandType.ANNOTATION_NUMBER:t=new r.SAnnotationNumber;break;case r.AnnotationCommandType.ANNOTATION_COMPONENT:t=new r.SAnnotationComponent;break;case r.AnnotationCommandType.ANNOTATION_EDIT:t=new r.SAnnotation}return null!=t&&t.SetView(this.GetSviewControl().view),t},e.prototype.ExcuteCommand=function(e,t){this._currentCommand=this.GetCommand(e),null!=this._currentCommand&&(this._annotationCommandType=e,this._sview.GetCommandManager().AddCommand(this._currentCommand),this._currentCommand.SetAnnotation(t),this._currentCommand.Execute())},e.prototype.GetAnnotationCommandType=function(){return this._annotationCommandType},e.prototype.Undo=function(){this._currentCommand},e.prototype.GetCommand=function(e){switch(this._commandsMap.ContainKey(e)||this._commandsMap.Put(e,null),e){case r.AnnotationCommandType.ANNOTATION_TEXT:0!=this._commandsMap.Size()&&null!=this._commandsMap.Get(e)||this._commandsMap.Put(r.AnnotationCommandType.ANNOTATION_TEXT,new r.AnnotationTextCommand(this._sview));break;case r.AnnotationCommandType.ANNOTATION_NUMBER:0!=this._commandsMap.Size()&&null!=this._commandsMap.Get(e)||this._commandsMap.Put(r.AnnotationCommandType.ANNOTATION_NUMBER,new r.AnnotationNumberCommand(this._sview));break;case r.AnnotationCommandType.ANNOTATION_COMPONENT:0!=this._commandsMap.Size()&&null!=this._commandsMap.Get(e)||this._commandsMap.Put(r.AnnotationCommandType.ANNOTATION_COMPONENT,new r.AnnotationComponentCommand(this._sview));break;case r.AnnotationCommandType.ANNOTATION_EDIT:0!=this._commandsMap.Size()&&null!=this._commandsMap.Get(e)||this._commandsMap.Put(r.AnnotationCommandType.ANNOTATION_EDIT,new r.AnnotationEditCommand(this._sview))}return this._commandsMap.Get(e)},e}();r.AnnotationCommandManager=e}(SView||(SView={})),function(r){var e=function(){function e(e){this._commandsMap=new M3D.Map,this._currentCommand=null,this._hotspotCommandType=r.HotSpotCommandType.NOTE_NONE,this._sview=null,this.SetSviewControl(e)}return e.prototype.GetCurrentCommand=function(){return this._currentCommand},e.prototype.SetCurrentCommand=function(e){this._currentCommand=e},e.prototype.CloseCurrentCommand=function(){null!=this._currentCommand&&(this._currentCommand.Close(),this._currentCommand=null)},e.prototype.SetSviewControl=function(e){this._sview=e},e.prototype.GetSviewControl=function(){return this._sview},e.prototype.ExecuteEditCommand=function(){this.CloseCurrentCommand(),this._sview.view.SetSelectType(M3D.ShapeType.SHAPE_NOTE_BASE),this._sview.GetAnnotationCommandManager().ExecuteEditCommand()},e.prototype.CloseAllCommand=function(){this._currentCommand=null,this._hotspotCommandType=r.HotSpotCommandType.NOTE_NONE;for(var e=0,t=this._commandsMap.Values();e<t.length;e++){t[e].Close()}this._commandsMap.Clear()},e.prototype.ExcuateCmmand=function(e,t){if(this._currentCommand=this.GetCommand(e),null!=this._currentCommand){this._hotspotCommandType=e,this.GetSviewControl().GetCommandManager().AddCommand(this._currentCommand);var r=this.CreateHotSpot(e);this._currentCommand.SetHotSpot(r),this._currentCommand.SetHotSpotCommandManager(this),this._currentCommand.Execute()}},e.prototype.CreateHotSpot=function(e){var t=null;switch(e){case r.HotSpotCommandType.NOTE_ADD:t=new r.SHotSpot}return t},e.prototype.ExcuteCommand=function(e,t){this._currentCommand=this.GetCommand(e),null!=this._currentCommand&&(this._hotspotCommandType=e,this._sview.GetCommandManager().AddCommand(this._currentCommand),this._currentCommand.SetHotSpot(t),this._currentCommand.Execute())},e.prototype.GetHotSpotCommandType=function(){return this._hotspotCommandType},e.prototype.Undo=function(){this._currentCommand},e.prototype.GetCommand=function(e){switch(this._commandsMap.ContainKey(e)||this._commandsMap.Put(e,null),e){case r.HotSpotCommandType.NOTE_ADD:0!=this._commandsMap.Size()&&null!=this._commandsMap.Get(e)||this._commandsMap.Put(r.HotSpotCommandType.NOTE_ADD,new r.HotSpotCreateCommand(this._sview))}return this._commandsMap.Get(e)},e}();r.HotSpotCommandManager=e}(SView||(SView={})),function(a){var i,e;(e=i=a.HotSpotCommandType||(a.HotSpotCommandType={}))[e.NOTE_NONE=0]="NOTE_NONE",e[e.NOTE_ADD=100]="NOTE_ADD",e[e.NOTE_EDIT=4]="NOTE_EDIT";var t=function(r){function e(e){var t=r.call(this)||this;return t.noteStep=0,t._touchDownSelectedShape=null,t._onDrag=!1,t.sview=null,t.HotSpotCommandManager=null,t._clickflag=!1,t._priDragX=0,t._priDragY=0,t._hotspot=null,t.hotspotStep=0,t.sview=e,t.SetCommandType(i.NOTE_NONE),t.nativaShapeIds=new Array,t}return __extends(e,r),e.prototype.Close=function(){this.sview.view.SetSelectType(M3D.ShapeType.SHAPE_MODEL),r.prototype.Close.call(this),this.ClearTmpSource()},e.prototype.GetHotSpotCommandManager=function(){return this.HotSpotCommandManager},e.prototype.SetHotSpotCommandManager=function(e){this.HotSpotCommandManager=e},e.prototype.SetCommandType=function(e){this.noteCommandType=e},e.prototype.GetCommandType=function(){return this.noteCommandType},e.prototype.OnAsyncExecute=function(e){},e.prototype.ExecuteNew=function(){null!=this.sview&&this.HotSpotCommandManager.ExcuateCmmand(this.GetCommandType(),0)},e.prototype.SelectedPnt=function(e,t,r){var i=0;return r&&(i=this.sview.view.SelectTempShape(e,t,M3D.ShapeType.SHAPE_FEATURE_COORDINATE,M3D.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_UNKNOWN)),0<i||(i=this.sview.view.SelectTempShape(e,t,M3D.ShapeType.SHAPE_COORDINATE,M3D.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_UNKNOWN)),i},e.prototype.IsUseFeaturePnt=function(){return this._useFeaturePnt},e.prototype.SetUseFeaturePnt=function(e){this._useFeaturePnt=e},e.prototype.IsSingleClick=function(e){var t=!1;switch(e.getEventType()){case a.TOUCH_MASK.TOUCH_DOWN:1==e.getTouchCount()&&(this._clickflag=!0),this._previousX=e.getX(),this._previousY=e.getY();break;case a.TOUCH_MASK.TOUCH_MOVE:break;case a.TOUCH_MASK.TOUCH_UP:this._clickflag&&(t=!0),this._clickflag=!1}return t},e.prototype.RemoveModelParent=function(e){var t=e.GetParent();t&&(this.sview.GetSelector().Exist(t)?(!0,this.sview.GetSelector().Remove(t)):this.RemoveModelParent(e.GetParent()))},e.prototype.ProcessEditAndDrag=function(e,t){var r=0;switch(t.getEventType()){case a.TOUCH_MASK.TOUCH_DOWN:if(1==t.getTouchCount()){this._priDragX=t.getX(),this._priDragY=t.getY();var i=this.sview.view.SelectTempShape(this._priDragX,this._priDragY,M3D.ShapeType.SHAPE_IMAGE_MODEL,0);if(0<i)(n=this.sview.GetNativeShapeManager().GetShape(i))instanceof M3D.ImageModel?this._touchDownSelectedShape=n:this._touchDownSelectedShape=null;else this._touchDownSelectedShape=null}break;case a.TOUCH_MASK.TOUCH_MOVE:if(1==t.getTouchCount())return this._touchDownSelectedShape,1;break;case a.TOUCH_MASK.TOUCH_UP:this._touchDownSelectedShape=null}if(1==this._onDrag)return this._onDrag=!1,1;if(!this.IsSingleClick(t))return 2;t.getX(),t.getY();var n,o=this.sview.view.SelectTempShape(t.getX(),t.getY(),M3D.ShapeType.SHAPE_IMAGE_MODEL,M3D.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_UNKNOWN);0<o?null!=(n=this.sview.GetNativeShapeManager().GetShape(o))&&(this.sview.GetSelector().Exist(n)?this.sview.GetSelector().Remove(n):this.sview.GetSelector().Add(n),r=1):this.sview.GetSelector().Clear();return r},e.prototype.getHotSpotStep=function(){return this.hotspotStep},e.prototype.setHotSpotStep=function(e){this.hotspotStep=e},e.prototype.GetHotSpot=function(){return this._hotspot},e.prototype.SetHotSpot=function(e){this._hotspot=e},e.prototype.SaveSHotSpot=function(e){this.sview.GetView().GetSceneManager().GetHandlerGroup().AddSVLTool(e.GetHotSpotImage(),e.GetName()),a.SHotSpotManager.Instance().AddHotSpot(e)},e.prototype.ClearTmpSource=function(){var e=this.GetHotSpot();if(this.setHotSpotStep(0),null!=e){var t=e.GetPointShape();if(this.sview.isShowTextNoteAlert=!1,1<this.nativaShapeIds.length){for(var r=0,i=this.nativaShapeIds;r<i.length;r++){var n=i[r];this.sview.view.RemoveShape(n)}this.nativaShapeIds.splice(0,this.nativaShapeIds.length)}else 0<t&&this.sview.view.RemoveShape(t)}},e.prototype.AddNoteToScene=function(e,t){var r=!1;if(null==e||null==t)return r;var i=e.GetHandlerGroup(),n=new M3D.ShapeNode;n.SetShape(t),n.SetName(t.GetName()+"|"+n.GetID()),i.AddChild(n);var o=t;return i.AddSVLTool(o,o.GetName()),e.AddShapeIDToMap(t),e.GetRenderManager().RequestRedraw(),r=!0},e}(a.AsyncCommand);a.SHotSpotCommand=t}(SView||(SView={})),function(T){var e=function(r){function e(e){var t=r.call(this,e)||this;return t.inputHotSpotPara=function(e,t){},t.SetCommandType(T.HotSpotCommandType.NOTE_ADD),t}return __extends(e,r),e.prototype.OnTouchHandle=function(e,t){var r=this.ProcessEditAndDrag(e,t);return 1==r||2!=r&&(null!=this.GetHotSpot()&&(this.hotSpotStep0(t),!0))},e.prototype.hotSpotStep0=function(e){var f=this.GetHotSpot();if(M3D.ShapeType.SHAPE_POINT==M3D.ShapeType.SHAPE_POINT){var m,t=e.getX(),r=e.getY();m=this.SelectedPnt(t,r,this.IsUseFeaturePnt());var y=new M3D.Vector3;if(0!=m){f.SetPointShape(m);var i=this.sview.GetView().GetSceneManager().GetShape(m);if(i&&i.GetType()==M3D.ShapeType.SHAPE_POINT_HANDLE)y=i.GetPosition(),f.SetPosX(y.x),f.SetPosY(y.y),f.SetPosZ(y.z);else this.sview.GetView().GetSceneManager().GetPickPoint(new M3D.Vector2(t,r),y,!1)&&(f.SetPosX(y.x),f.SetPosY(y.y),f.SetPosZ(y.z));this.inputHotSpotPara(this,function(e,t,r,i,n,o,a,s,l){if(s){var h=l.sview.GetView().GetSceneManager().GetResourceManager(),u=new M3D.ImageModel,p="./Platform/Ctrls/SView/sview/css/images/hotspot.png",c=h.GetImage(p);null===c&&(c=h.GetOrCreateImage(p,p)),u.SetImage(c);var d=M3D.Parameters.Instance().hotSpotImageSize;u.SetImageSize(y,new M3D.Vector2(d,d)),u.SetAllowScall(!1),u.SetAllowRotate(!1),u.SetInTopShow(!0),u.SetName(e),l.sview.GetView().GetSceneManager().GetHandlerGroup().AddSVLTool(u,e);var S=new T.SHotSpot(u.GetID(),e,t,null,null,null,n,o,a,y.x,y.y,y.z,null,null,null,null,null,null,null,null,null,null,null,u);S.SetPointShape(m),T.SHotSpotManager.Instance().AddHotSpot(S),l.SetHotSpot(f),l.Close(),l.ExecuteNew(),this.sview.GetNativeShapeManager().AddShape(u.GetID(),u)}else l.SetHotSpot(f),l.Close(),l.ExecuteNew()})}}},e}(T.SHotSpotCommand);T.HotSpotCreateCommand=e}(SView||(SView={})),function(o){var e=function(r){function e(e){var t=r.call(this,e)||this;return t.inputTextNoteString=function(e,t){},t.SetCommandType(o.AnnotationCommandType.ANNOTATION_TEXT),t.nativaShapeIds=new Array,t}return __extends(e,r),e.prototype.OnTouchHandle=function(e,t){var r=!1,i=this.ProcessEditAndDrag(e,t);if(1==i)return!0;if(2==i)return!1;var n=this.GetAnnotation();return null!=n&&(n.GetAnnotationType()==o.SAnnotation.ANNOTATION_TYPE_TEXT&&(this.textNoteStep0(t),r=!0),r)},e.prototype.textNoteStep0=function(e){var i=this.GetAnnotation();if(M3D.ShapeType.SHAPE_POINT==M3D.ShapeType.SHAPE_POINT){var t=0,n=e.getX(),o=e.getY();if(i.SetFirstAnchorX(n),i.SetFirstAnchorY(o),0!=(t=this.SelectedPnt(n,o,this.IsUseFeaturePnt()))){i.SetFirstShape(t);var r=function(e,t,r){t?(i.SetTextString(e),r.SetAnnotation(i),r.textNoteStep1(n,o)):(r.SetAnnotation(i),r.Close(),r.ExecuteNew())};this.inputTextNoteString(this,r)}else{t=i.CreateFirstPoint(),i.SetFirstShape(t);r=function(e,t,r){t?(i.SetTextString(e),r.SetAnnotation(i),r.textNoteStep1(n,o)):(r.SetAnnotation(i),r.Close(),r.ExecuteNew())};this.inputTextNoteString(this,r)}}},e.prototype.textNoteStep1=function(e,t){var r=this.GetAnnotation();r.SetAnchorX(e);var i=t;i<this.sview.view.sceneManager.GetCamera().GetViewPort().GetRect().Height()/2?r.SetAnchorY(i-50*window.devicePixelRatio):r.SetAnchorY(i+100*window.devicePixelRatio),r.Create()?(this.sview.GetNativeShapeManager().AddShape(r.GetID(),r.GetNoteObj()),this.setAnnotationStep(0),this.SaveAnnotation(r),this.Close(),this.ExecuteNew()):this.ProcessError()},e.prototype.ProcessError=function(){this.Close(),this.ExecuteNew()},e.prototype.Close=function(){r.prototype.Close.call(this),this.ClearTmpSource()},e.prototype.ClearTmpSource=function(){var e=this.GetAnnotation();if((this.setAnnotationStep(0),null!=e)&&(e.GetAnnotationType()==o.SAnnotation.ANNOTATION_TYPE_TEXT&&e instanceof o.SAnnotationText)){var t=e.GetFirstShape();if(this.sview.isShowTextNoteAlert=!1,1<this.nativaShapeIds.length){for(var r=0,i=this.nativaShapeIds;r<i.length;r++){var n=i[r];this.sview.view.RemoveShape(n)}this.nativaShapeIds.splice(0,this.nativaShapeIds.length)}else 0<t&&this.sview.view.RemoveShape(t)}},e}(o.AnnotationCommand);o.AnnotationTextCommand=e}(SView||(SView={})),function(o){var e=function(r){function e(e){var t=r.call(this,e)||this;return t.number=0,t.SetCommandType(o.AnnotationCommandType.ANNOTATION_NUMBER),t}return __extends(e,r),e.prototype.OnTouchHandle=function(e,t){var r=!1,i=this.ProcessEditAndDrag(e,t);if(1==i)return!0;if(2==i)return!1;var n=this.GetAnnotation();return null!=n&&(n.GetAnnotationType()==o.SAnnotation.ANNOTATION_TYPE_ORDER&&(this.sequenceNumberNoteStep0(t),r=!0),r)},e.prototype.sequenceNumberNoteStep0=function(e){var t=this.GetAnnotation();if(M3D.ShapeType.SHAPE_POINT==M3D.ShapeType.SHAPE_POINT){var r,i=e.getX(),n=e.getY();if(t.SetFirstAnchorX(i),t.SetFirstAnchorY(n),0!=(r=this.SelectedPnt(i,n,this.IsUseFeaturePnt()))){t.SetFirstShape(r),this.number++;for(var o=this.sview.GetView().GetSAnnotationManager().GetAnnotations(),a=0,s=0;s<o.length;s++)2===o[s].GetAnnotationType()&&Number(o[s].GetText())>a&&(a=Number(o[s].GetText()));a++,t.SetText(String(a)),this.sequenceNumberNoteStep1(i,n)}}},e.prototype.sequenceNumberNoteStep1=function(e,t){var r=this.GetAnnotation();r.SetAnchorX(e);var i=t;i<this.sview.view.sceneManager.GetCamera().GetViewPort().GetRect().Height()/2?r.SetAnchorY(i-50*window.devicePixelRatio):r.SetAnchorY(i+100*window.devicePixelRatio),r.Create()?(this.sview.GetNativeShapeManager().AddShape(r.GetID(),r.GetNoteObj()),this.setAnnotationStep(0),this.SaveAnnotation(r),this.Close(),this.ExecuteNew()):this.ProcessError()},e.prototype.ProcessError=function(){this.Close(),this.ExecuteNew()},e.prototype.Close=function(){r.prototype.Close.call(this),this.ClearTmpSource()},e.prototype.ClearTmpSource=function(){var e=this.GetAnnotation();if((this.setAnnotationStep(0),null!=e)&&(e.GetAnnotationType()==o.SAnnotation.ANNOTATION_TYPE_ORDER&&e instanceof o.SAnnotationNumber)){var t=e.GetFirstShape();0<t&&this.sview.view.RemoveShape(t)}},e}(o.AnnotationCommand);o.AnnotationNumberCommand=e}(SView||(SView={})),function(i){var e=function(r){function e(e){var t=r.call(this,e)||this;return t.SetCommandType(i.AnnotationCommandType.ANNOTATION_EDIT),e.view.SetSelectType(M3D.ShapeType.SHAPE_NOTE_BASE),t}return __extends(e,r),e.prototype.OnTouchHandle=function(e,t){var r=this.ProcessEditAndDrag(e,t);return 1==r||2!=r&&0==r},e}(i.AnnotationCommand);i.AnnotationEditCommand=e}(SView||(SView={})),function(S){var f,e,m=function(){function e(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];switch(this.modelShape=null,this.matrixCache=new S.Matrix3x4,this.boxCache=new S.BoundingBox,e.length){case 3:this.modelShape=e[0],this.matrixCache=e[1],this.boxCache=e[2]}}return e.prototype.CopyFrom=function(e){this.modelShape=e.modelShape,this.matrixCache=e.matrixCache,this.boxCache=e.boxCache},e}();S.NodeState=m,(e=f=S.ExplosiveStyle||(S.ExplosiveStyle={}))[e.NOEXPLOSIVE=-1]="NOEXPLOSIVE",e[e.AWAYFROMCENTER=0]="AWAYFROMCENTER",e[e.AWAYFROMCENTER_X=1]="AWAYFROMCENTER_X",e[e.AWAYFROMCENTER_Y=2]="AWAYFROMCENTER_Y",e[e.AWAYFROMCENTER_Z=3]="AWAYFROMCENTER_Z",e[e.AWAYFROMCENTER_X_LEFT=4]="AWAYFROMCENTER_X_LEFT",e[e.AWAYFROMCENTER_Y_FRONT=5]="AWAYFROMCENTER_Y_FRONT",e[e.AWAYFROMCENTER_Z_BOTTOM=6]="AWAYFROMCENTER_Z_BOTTOM",e[e.TOBALLSURFACE=9]="TOBALLSURFACE";var o=function(){function e(e){this.explosiveViewOperator=null,this.explosiveViewOperator=e}return e.onExecute=function(e,t){if(t&&(e.GetExplosiveLevel()>=y.MAX_ASSEMBLY_LEVLE&&null!==t&&t instanceof S.ShapeNode))t.GetWorldTransform()},e.onExecuteModel=function(e,t){if(t&&(e.GetExplosiveLevel()>=y.MAX_ASSEMBLY_LEVLE&&null!==t)){var r=t.GetModelShape();if(r&&r.GetBodys()&&0<r.GetBodys().length){var i=r.GetWorldTransform(),n=new m(r,i.Clone(),r.GetWorldBoundingBox().Clone());e.AddMatrix(t,n)}}},e}(),r=function(){function e(e){this.explosiveViewOperator=null,this.explosiveViewOperator=e}return e.onExecute=function(e,t){},e.onExecuteModel=function(e,t){if(t){e.GetExplosiveLevel(),t.GetModelShape();var r=new S.Vector3,i=(new S.Matrix3x4,new S.Matrix3x4),n=new m;if(e.GetMatrix(t,n)){i=n.matrixCache.Clone();var o=n.boxCache.Clone(),a=o.Center().Clone(),s=new S.Vector3,l=a.Clone();if(e.explosiveStyle===f.AWAYFROMCENTER?r=e.topNodeCenter.Clone():e.explosiveStyle===f.AWAYFROMCENTER_X?((r=e.topNodeFront.Clone()).y=l.y,r.z=l.z):e.explosiveStyle===f.AWAYFROMCENTER_Y?((r=e.topNodeLeft.Clone()).x=l.x,r.z=l.z):e.explosiveStyle===f.AWAYFROMCENTER_Z?((r=e.topNodeBottom.Clone()).x=l.x,r.y=l.y):e.explosiveStyle===f.AWAYFROMCENTER_X_LEFT?(r=e.topNodeFront.Clone(),a=y.GetNewPos(o,i,f.AWAYFROMCENTER_X_LEFT),r.y=a.y,r.z=a.z):e.explosiveStyle===f.AWAYFROMCENTER_Y_FRONT?(r=e.topNodeLeft.Clone(),a=y.GetNewPos(o,i,f.AWAYFROMCENTER_Y_FRONT),r.x=a.x,r.z=a.z):e.explosiveStyle===f.AWAYFROMCENTER_Z_BOTTOM&&(r=e.topNodeBottom.Clone(),a=y.GetNewPos(o,i,f.AWAYFROMCENTER_Z_BOTTOM),r.x=a.x,r.y=a.y),(s=0<=e.explosivePercent?a.Sub(r).Multiply(e.explosivePercent):r.Sub(a).Multiply(e.explosivePercent)).x==s.x&&s.y==s.y&&s.z==s.z){var h=t.GetParent(),u=new S.Matrix3x4;u=i;var p=new S.Matrix3x4;p=h?h.GetWorldTransform().ToMatrix3x4():p;var c=new S.Matrix3x4;c.MultiTranslate(s);var d=p.Inverse().Multiply(c.Multiply(u));t.SetPlaceMatrix(d.ToMatrix4())}else S.LOGE("explosive move error : %s",s.Tostring())}}},e}(),y=function(){function e(){this.view=null,this.explosiveStyle=-1,this.explosivePercent=-1,this.isUseAnimation=!1,this.isFirstOpen=!0,this.allNodeMatrixsCache=new S.Map,this.viewMatrix=new S.Matrix4,this.topNodeCenter=new S.Vector3,this.topNodeBottom=new S.Vector3,this.topNodeLeft=new S.Vector3,this.topNodeFront=new S.Vector3,this.screenDepth=-1,this.explosiveLevel=-1,this.SetExplosiveLevel(e.MAX_ASSEMBLY_LEVLE),this.Reset()}return e.prototype.SetView=function(e){this.view=e},e.prototype.GetView=function(){return this.view},e.prototype.SetPercentNoRestore=function(e,t,r,i){void 0===r&&(r=100),void 0===i&&(i=!0),this.isFirstOpen&&(this.Reset(),this.isFirstOpen=!1,this.CacheMatrixState());if(t!==this.explosiveStyle||r!==this.explosivePercent)switch(this.explosiveStyle=t,this.explosivePercent=4*r/.5,this.view=e,this.isUseAnimation=i,this.explosiveStyle){case f.AWAYFROMCENTER:case f.AWAYFROMCENTER_X:case f.AWAYFROMCENTER_Y:case f.AWAYFROMCENTER_Z:case f.AWAYFROMCENTER_X_LEFT:case f.AWAYFROMCENTER_Y_FRONT:case f.AWAYFROMCENTER_Z_BOTTOM:this.ProcressAwayFromCenter();break;case f.TOBALLSURFACE:this.ProcressAwayToBallSurface()}return!1},e.prototype.SetPercent=function(e,t,r,i){void 0===r&&(r=100),void 0===i&&(i=!0),this.isFirstOpen&&(this.Reset(),null!=e&&this.view.RestoreView(),this.isFirstOpen=!1,this.CacheMatrixState());if(t!==this.explosiveStyle||r!==this.explosivePercent)switch(this.explosiveStyle=t,this.explosivePercent=4*r/.5,this.view=e,this.isUseAnimation=i,this.explosiveStyle){case f.AWAYFROMCENTER:case f.AWAYFROMCENTER_X:case f.AWAYFROMCENTER_Y:case f.AWAYFROMCENTER_Z:case f.AWAYFROMCENTER_X_LEFT:case f.AWAYFROMCENTER_Y_FRONT:case f.AWAYFROMCENTER_Z_BOTTOM:this.ProcressAwayFromCenter();break;case f.TOBALLSURFACE:this.ProcressAwayToBallSurface()}var n=e.GetSceneManager().GetSceneBox(),o=e.GetSceneManager().GetCamera().GetPosition().Clone();return n.IsInside(o)===S.INSIDE&&e.GetSceneManager().GetCamera().OnMarkedDirty(),!1},e.prototype.Close=function(e){return this.SetPercent(e,this.explosiveStyle,0,!1),this.Reset(),!1},e.prototype.GetExplosiveLevel=function(){return this.explosiveLevel},e.prototype.SetExplosiveLevel=function(e){this.explosiveLevel=e},e.prototype.Reset=function(){this.explosiveStyle=f.NOEXPLOSIVE,this.explosivePercent=0,this.isUseAnimation=!1,this.isFirstOpen=!0,this.allNodeMatrixsCache.Clear()},e.prototype.ProcressAwayFromCenter=function(){if(null!==this.view){var e=this.view,t=new S.CallBackAction;t.SetActionData(this),t.SetActionFun(r.onExecute),t.SetActionFunModel(r.onExecuteModel),e.GetSceneManager().ExecuteAction(t),e.GetSceneManager().RequestUpdateWhenSceneBoxChanged()}return!1},e.prototype.ProcressAwayToBallSurface=function(){},e.prototype.AwayFromCenter=function(e,t){},e.prototype.CacheMatrixState=function(){if(null!==this.view){var e=this.view,t=e.GetSceneManager().GetSceneBox(),r=t.max.Clone(),i=t.min.Clone();this.topNodeCenter=r.Add(i).Multiply(.5),this.topNodeBottom=i.Add(new S.Vector3(r.x,r.y,i.z)).Multiply(.5),this.topNodeFront=i.Add(new S.Vector3(i.x,r.y,r.z)).Multiply(.5),this.topNodeLeft=i.Add(new S.Vector3(r.x,i.y,r.z)).Multiply(.5);var n=new S.CallBackAction;n.SetActionData(this),n.SetActionFun(o.onExecute),n.SetActionFunModel(o.onExecuteModel),e.GetSceneManager().ExecuteAction(n)}},e.GetNewPos=function(e,t,r){var i=new S.Vector3,n=e.Clone(),o=n.max.Clone(),a=n.min.Clone();return r===f.AWAYFROMCENTER_Z_BOTTOM?i=a.Add(new S.Vector3(o.x,o.y,a.z)).Multiply(.5):r===f.AWAYFROMCENTER_Y_FRONT?i=a.Add(new S.Vector3(a.x,o.y,o.z)).Multiply(.5):r===f.AWAYFROMCENTER_X_LEFT&&(i=a.Add(new S.Vector3(o.x,a.y,o.z)).Multiply(.5)),i},e.prototype.GetMatrix=function(e,t){var r=!1,i=this.allNodeMatrixsCache.Get(e);return null!==i&&(t.CopyFrom(i),r=!0),r},e.prototype.AddMatrix=function(e,t){this.allNodeMatrixsCache.Put(e,t)},e.MAX_ASSEMBLY_LEVLE=96,e}();S.ExplosiveViewOperator=y}(M3D||(M3D={})),function(h){var e=function(){function e(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];switch(e.length){case 0:break;case 1:this.view=e[0],this.enableXY=!0,this.enableXZ=!0,this.enableYZ=!0,this.ShowPlaneRect=!0,this.ShowClipPlane=!0,this.ShowCappingPlane=!0,this.xyPlaneID=1001,this.xzPlaneID=1002,this.yzPlaneID=1003,this.bindAxisDragger=new h.Dragger,this.bindRotationDragger=new h.Dragger,this.firstOpen=!0}}return e.prototype.OpenThreePlaneSection=function(){var e=new h.SectionPlane;e.SetID(this.xyPlaneID);var t=this.view.GetSceneManager().GetSectionNode().GetSection();t.AddPlane(e),(e=new h.SectionPlane).SetID(this.yzPlaneID),t.AddPlane(e),(e=new h.SectionPlane).SetID(this.xzPlaneID),t.AddPlane(e),this.ResetThreePlaneSection()},e.prototype.CreateOneSectionPlane=function(e,t){var r=new h.SectionPlane,i=this.view.GetSceneManager().GetSectionNode().GetSection(),n=i.GetPlaneList();if(0<n.length)for(var o=0;o<n.length;o++){var a=n[o];a.GetEnable()&&(a.SetEnable(!1),this.SetDraggerVisiable(a.GetID(),!1))}var s=-e.DotProduct(t);return r.SetPlaneParam(e.x,e.y,e.z,s),r.SetEnable(!0),r.SetShowCutPlane(!0),r.SetShowCappingPlane(!0),i.AddPlane(r),this.BindOneSectionDragger(e,r),r},e.prototype.BindOneSectionDragger=function(e,t){},e.prototype.SetDraggerVisiable=function(e,t){},e.prototype.UnBindOneDragger=function(e){return!1},e.prototype.ResetThreePlaneSection=function(){var e=this.view.GetSceneManager().GetSectionNode().GetSection(),t=e.GetPlaneById(this.xyPlaneID),r=e.GetPlaneById(this.yzPlaneID),i=e.GetPlaneById(this.xzPlaneID);t&&(this.GetSectionInfo(this.view,3,.5,t),t.SetEnable(!0)),r&&(this.GetSectionInfo(this.view,1,.5,r),t.SetEnable(!0)),i&&(this.GetSectionInfo(this.view,2,.5,i),t.SetEnable(!0))},e.prototype.CloseAllSectionPlanes=function(){this.view.GetSceneManager().GetSectionNode().GetSection().ClearPlanes(),this.firstOpen=!0},e.prototype.GetSectionInfo=function(e,t,r,i){var n=e.GetSceneManager().GetSceneBox(),o=0,a=n.min,s=0,l=0;switch(t){case-h.Direction.X:o=n.GetXLength()*r,s=-1,l=a.x+o;break;case h.Direction.X:o=n.GetXLength()*r,s=1,l=-(a.x+o);break;case-h.Direction.Y:o=n.GetYLength()*r,s=-1,l=a.y+o;break;case h.Direction.Y:o=n.GetYLength()*r,s=1,l=-(a.y+o);break;case-h.Direction.Z:o=n.GetZLength()*r,s=-1,l=a.z+o;break;case h.Direction.Z:o=n.GetZLength()*r,s=1,l=-(a.z+o)}i.SetPlaneParam(s,0,0,l)},e.prototype.GetEnableXY=function(){return this.enableXY},e.prototype.SetEnableXY=function(e){this.enableXY=e;var t=this.view.GetSceneManager().GetSectionNode().GetSection().GetPlaneById(this.xyPlaneID);t&&t.SetEnable(e)},e.prototype.GetEnableXZ=function(){return this.enableXZ},e.prototype.SetEnableXZ=function(e){this.enableXZ=e;var t=this.view.GetSceneManager().GetSectionNode().GetSection().GetPlaneById(this.xzPlaneID);t&&t.SetEnable(e)},e.prototype.GetPlaneById=function(e){return this.view.GetSceneManager().GetSectionNode().GetSection().GetPlaneById(e)},e.prototype.GetPlaneList=function(){return this.view.GetSceneManager().GetSectionNode().GetSection().GetPlaneList()},e.prototype.AddPlane=function(e){return this.view.GetSceneManager().GetSectionNode().GetSection().AddPlane(e)},e.prototype.RemovePlane=function(e){return this.view.GetSceneManager().GetSectionNode().GetSection().RemovePlane(e)},e.prototype.GetEnableYZ=function(){return this.enableYZ},e.prototype.SetEnableYZ=function(e){this.enableYZ=e;var t=this.view.GetSceneManager().GetSectionNode().GetSection().GetPlaneById(this.yzPlaneID);t&&t.SetEnable(e)},e.prototype.GetShowPlaneRect=function(){return this.ShowPlaneRect},e.prototype.SetShowPlaneRect=function(e){this.ShowPlaneRect=e,this.view.GetSceneManager().GetSectionNode().GetSection().SetShowPlaneRect(e)},e.prototype.GetShowClipPlane=function(){return this.ShowClipPlane},e.prototype.SetShowClipPlane=function(e){this.ShowClipPlane=e,this.view.GetSceneManager().GetSectionNode().GetSection().SetShowClipPlane(e)},e.prototype.GetShowCappingPlane=function(){return this.ShowCappingPlane},e.prototype.SetShowCappingPlane=function(e){this.ShowCappingPlane=e,this.view.GetSceneManager().GetSectionNode().GetSection().SetIsShowCappingPlane(e)},e.prototype.GetReversePlane=function(){return this.ReverseClipPlane},e.prototype.SetReversePlane=function(e){this.ReverseClipPlane=e,this.view.GetSceneManager().GetSectionNode().GetSection().SetIsReverseClipping(e)},e}();h.SectionManager=e}(M3D||(M3D={})),function(l){l.ZDEPS=1e-6;var e=function(){function e(){}return e.LengthAndUnit=function(e,t,r,i){var n=0,o=0,a=0,s=0;if(3==e)n=(a=t[0]*t[0]+t[1]*t[1]+t[2]*t[2])<l.ZDEPS?(i[0]=t[0],i[1]=t[1],i[2]=t[2],-2):(s=Math.sqrt(a),i[0]=t[0]/s,i[1]=t[1]/s,i[2]=t[2]/s,s,0);else if(2==e)n=(a=t[0]*t[0]+t[1]*t[1])<l.ZDEPS?(i[0]=t[0],i[1]=t[1],-2):(s=Math.sqrt(a),i[0]=t[0]/s,i[1]=t[1]/s,s,0);else if(0<e){for(o=a=0;o<e;o++)a+=t[o]*t[o];if(a<l.ZDEPS){for(o=0;o<e;o++)i[o]=t[o];n=-2}else{for(s=Math.sqrt(a),o=0;o<e;o++)i[o]=t[o]/s;s,n=0}}else n=-1;return n},e.Cross=function(e,t,r){var i=[];return i[0]=e[1]*t[2]-e[2]*t[1],i[1]=e[2]*t[0]-e[0]*t[2],i[2]=e[0]*t[1]-e[1]*t[0],r[0]=i[0],r[1]=i[1],r[2]=i[2],0},e}();l.CMathVector=e}(SView||(SView={})),function(e){var t=function e(t){if(this.name="NO_NAME",this.iconSkin="icon01",null!==t){this.id=t.GetID(),null!==t.GetName()&&(this.name=t.GetName()),this.checked=t.IsVisible(),this.orcChecked=t.IsOrigVisible();var r=t.GetSubModels();0<r.length&&(this.children=[],this.iconSkin="pIcon01");for(var i=0,n=r;i<n.length;i++){var o=n[i];null!==o&&this.children.push(new e(o))}}};(SView||(SView={})).JSONAssembly=t}(),function(e){var t=function(){this.percent=0,this.fileName=""};(M3D||(M3D={})).LoadingEvent=t}(),function(e){var t=function(){function e(){}return e.prototype.OnHandle=function(e,t){},e}();e.CommandListener=t}(SView||(SView={})),function(i){var e=function(){function e(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(this._commandList=[],this._historyList=[],this._isBusy=!1,this._cmdListener=new i.CommandListener,0===e.length);else{var r=e[0];this.setSView(r)}}return e.prototype.AddCommand=function(e){return e.SetManager(this),e},e.prototype.Complete=function(e){this._commandList.splice(this._commandList.indexOf(e),1),this._historyList.push(e.GetName())},e.prototype.GetCurCommand=function(){return 0!==this._commandList.length?this._commandList[0]:null},e.prototype.GetHistories=function(){return this._historyList},e.prototype.getSView=function(){return this._sview},e.prototype.Redo=function(){},e.prototype.setSView=function(e){this._sview=e},e.prototype.Undo=function(){},e.prototype.InnerRun=function(e){e.isAsyncExecute()||e.OnExecute()},e.prototype.Run=function(e){-1===this._commandList.indexOf(e)&&(this._commandList.push(e),e.AddListener(this._cmdListener)),this.InnerRun(e)},e.prototype.IsBusy=function(){return this._isBusy},e.prototype.SetBusy=function(e){this._isBusy=e},e}();i.CommandManager=e;var t=function(e){this.cmd=e};i.AsyncExecuteCommandTask=t}(SView||(SView={})),function(u){var i,e;(e=i=u.MeasureCommandType||(u.MeasureCommandType={}))[e.MEASURE_DIAMETER=3]="MEASURE_DIAMETER",e[e.MEASURE_LENGTH=1]="MEASURE_LENGTH",e[e.MEASURE_NONE=0]="MEASURE_NONE",e[e.MEASURE_RADIUS=2]="MEASURE_RADIUS",e[e.MEASURE_DISTANCE=5]="MEASURE_DISTANCE",e[e.MEASURE_ANGLE=6]="MEASURE_ANGLE",e[e.MEASURE_PROPERTY=7]="MEASURE_PROPERTY",e[e.MEASURE_NOTE=8]="MEASURE_NOTE",e[e.MEASURE_TEXT_NOTE=9]="MEASURE_TEXT_NOTE",e[e.MEASURE_VOICE_NOTE=10]="MEASURE_VOICE_NOTE",e[e.MEASURE_EDIT=11]="MEASURE_EDIT",e[e.MEASURE_CT_TEXT_NOTE=30]="MEASURE_CT_TEXT_NOTE",e[e.MEASURE_PROPERTYNew=12]="MEASURE_PROPERTYNew",e[e.MEASURE_SEQUENCE_NUM=13]="MEASURE_SEQUENCE_NUM";var t=function(r){function e(e){var t=r.call(this)||this;return t.sview=null,t._measureCommandManager=null,t._clickflag=!1,t._priDragX=0,t._priDragY=0,t._measure=null,t.measureStep=0,t._touchDownSelectedShape=null,t._onDrag=!1,t.sview=e,t.SetCommandType(i.MEASURE_NONE),t}return __extends(e,r),e.prototype.Close=function(){this.sview.view.SetSelectType(M3D.ShapeType.SHAPE_MODEL),r.prototype.Close.call(this)},e.prototype.GetMeasureCommandManager=function(){return this._measureCommandManager},e.prototype.SetMeasureCommandManager=function(e){this._measureCommandManager=e},e.prototype.GetMeasure=function(){return this._measure},e.prototype.SetMeasure=function(e){this._measure=e},e.prototype.SaveMeasure=function(e){this.sview.GetMeasureManager().Add(e)},e.prototype.ExecuteNew=function(){null!=this.sview&&this._measureCommandManager.ExcuateCmmand(this.GetCommandType(),this._measure.GetMeasureType())},e.prototype.SetCommandType=function(e){this.measureCommandType=e},e.prototype.GetCommandType=function(){return this.measureCommandType},e.prototype.OnAsyncExecute=function(e){},e.prototype.SelectedPnt=function(e,t,r){var i=0;return r&&(i=this.sview.view.SelectTempShape(e,t,M3D.ShapeType.SHAPE_FEATURE_COORDINATE,M3D.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_UNKNOWN)),0<i||(i=this.sview.view.SelectTempShape(e,t,M3D.ShapeType.SHAPE_COORDINATE,M3D.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_UNKNOWN)),i},e.prototype.IsUseFeaturePnt=function(){return this._useFeaturePnt},e.prototype.SetUseFeaturePnt=function(e){this._useFeaturePnt=e},e.prototype.IsSingleClick=function(e){var t=!1;switch(e.getEventType()){case u.TOUCH_MASK.TOUCH_DOWN:1==e.getTouchCount()&&(this._clickflag=!0),this._previousX=e.getX(),this._previousY=e.getY();break;case u.TOUCH_MASK.TOUCH_MOVE:break;case u.TOUCH_MASK.TOUCH_UP:this._clickflag&&(t=!0),this._clickflag=!1}return t},e.prototype.RemoveModelParent=function(e){var t=e.GetParent();t&&(this.sview.GetSelector().Exist(t)?(!0,this.sview.GetSelector().Remove(t)):this.RemoveModelParent(e.GetParent()))},e.prototype.ProcessEditAndDrag=function(e,t){var r=0;switch(t.getEventType()){case u.TOUCH_MASK.TOUCH_DOWN:if(1==t.getTouchCount()){this._priDragX=t.getX(),this._priDragY=t.getY();var i=this.sview.view.SelectTempShape(this._priDragX,this._priDragY,M3D.ShapeType.SHAPE_MEASURE_BASE,0);this._touchDownSelectedShape=0<i?this.sview.GetNativeShapeManager().GetShape(i):null}break;case u.TOUCH_MASK.TOUCH_MOVE:if(1!=t.getTouchCount()||null==this._touchDownSelectedShape)break;var n=new M3D.Vector2(this._priDragX,this._priDragY),o=new M3D.Vector2(t.getX(),t.getY());return 1e-7<n.Sub(o).Length()&&(this._onDrag=!0),this._priDragX=t.getX(),this._priDragY=t.getY(),this.sview.view.UpdateMeasureImagePos(this._touchDownSelectedShape,this._priDragX,this._priDragY),1;case u.TOUCH_MASK.TOUCH_UP:this._touchDownSelectedShape=null}if(1==this._onDrag)return this._onDrag=!1,1;if(!this.IsSingleClick(t))return 2;t.getX(),t.getY();var a=this.sview.view.SelectTempShape(t.getX(),t.getY(),M3D.ShapeType.SHAPE_MEASURE_BASE,M3D.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_UNKNOWN);if(0<a){var s=this.sview.GetNativeShapeManager().GetShape(a);null!=s&&(this.sview.GetSelector().Exist(s)?this.sview.GetSelector().Remove(s):this.sview.GetSelector().Add(s),r=1)}else if(M3D.Parameters.Instance().canPickModel){var l=this.sview.view.SelectTempShape(this._priDragX,this._priDragY,M3D.ShapeType.SHAPE_MODEL,0);if(0<l){var h=this.sview.GetShpae(l);if("floor"===h.GetName())return void this.sview.GetSelector().Clear();this.sview.GetSelector().Exist(h)?this.sview.GetSelector().Remove(h):h.IsSelected()?this.RemoveModelParent(h):this.sview.GetSelector().Add(h)}else this.sview.GetSelector().Clear()}else this.sview.GetSelector().Clear();return r},e.prototype.getMeasureStep=function(){return this.measureStep},e.prototype.setMeasureStep=function(e){this.measureStep=e},e}(u.AsyncCommand);u.MeasureCommand=t}(SView||(SView={})),function(s){var e=function(r){function e(e){var t=r.call(this,e)||this;return t.SetCommandType(s.MeasureCommandType.MEASURE_ANGLE),t}return __extends(e,r),e.prototype.OnTouchHandle=function(e,t){var r=!1,i=this.ProcessEditAndDrag(e,t);if(1==i)return!0;if(2==i)return!1;var n=this.GetMeasure();if(null==n)return!1;var o=n.GetMeasureType();return o==s.SMeasure.MEASURE_TYPE_LINE_LINE_ANGLE?(this.LineToLineAngle(t),r=!0):o==s.SMeasure.MEASURE_TYPE_LINE_FACE_ANGLE?(this.LineToFaceAngle(t),r=!0):o==s.SMeasure.MEASURE_TYPE_FACE_FACE_ANGLE?(this.FaceToFaceAngle(t),r=!0):o==s.SMeasure.MEASURE_TYPE_CURVE_CURVE_ANGLE&&(this.CurveToCurveAngle(t),r=!0),r},e.prototype.CurveToCurveAngle=function(e){0==this.getMeasureStep()?this.CurveToCurveAngleStep0(e):1==this.getMeasureStep()?this.CurveToCurveAngleStep1(e):2==this.getMeasureStep()&&this.CurveToCurveAngleStep2(e)},e.prototype.CurveToCurveAngleStep0=function(e){var t=this.GetMeasure();if(M3D.ShapeType.SHAPE_EDGE==M3D.ShapeType.SHAPE_EDGE){var r,i=e.getX(),n=e.getY();r=this.sview.view.SelectTempShape(i,n,M3D.ShapeType.SHAPE_EDGE,M3D.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_UNKNOWN);var o=this.sview.view.SelectTempShape(i,n,M3D.ShapeType.SHAPE_COORDINATE,M3D.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_UNKNOWN);if(0!=r&&0!=o){var a=t.GetView().GetSceneManager().GetShape(r),s=t.GetView().GetSceneManager().GetShape(o).GetPosition().Clone();if(null==a)return void this.sview.view.RemoveShape(o);for(var l=a,h=l.GetLineData(),u=h.GetRefLine().GetPoints(),p=0,c=0,d=new M3D.Vector3,S=new M3D.Line3D,f=u.slice(h.GetDataOffset(),h.GetDataOffset()+h.GetDataLength()),m=0;m<f.length-1;m+=2){var y=new M3D.Line3D(f[m],f[m+1]),T=new M3D.LineAttribute;T.SetID(y.GetID()),T.SetDirection(new M3D.Vector3(y.GetPosition().x-y.GetEndPoint().x,y.GetPosition().y-y.GetEndPoint().y,y.GetPosition().z-y.GetEndPoint().z)),T.SetStartPoint(y.GetEndPoint()),T.SetEndPoint(y.GetPosition()),T.SetCenterPoint(new M3D.Vector3(NaN,NaN,NaN));var M=M3D.ShapeHelper.GetShapeWorldMatrix(l);M3D.GeometryHelper.Transform(T,M),p=M3D.MeasureCalculateHelper.PntLineDistance(s,T,p,void 0,d),0===m?(c=p,S=new M3D.Line3D(f[m],f[m+1])):p<c&&(c=p,S=new M3D.Line3D(f[m],f[m+1]))}S.SetType(M3D.ShapeType.SHAPE_EDGE),this.sview.view.PreSelect(r,!0),t.SetFirstCurveLine(S),t.SetFirstShape(r),this.setMeasureStep(this.getMeasureStep()+1)}this.sview.view.RemoveShape(o)}},e.prototype.CurveToCurveAngleStep1=function(e){var t=this.GetMeasure();if(M3D.ShapeType.SHAPE_EDGE==M3D.ShapeType.SHAPE_EDGE){var r,i=e.getX(),n=e.getY();r=this.sview.view.SelectTempShape(i,n,M3D.ShapeType.SHAPE_EDGE,M3D.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_UNKNOWN);var o=this.sview.view.SelectTempShape(i,n,M3D.ShapeType.SHAPE_COORDINATE,M3D.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_UNKNOWN);if(0!=r&&0!=o){var a=t.GetView().GetSceneManager().GetShape(r),s=t.GetView().GetSceneManager().GetShape(o).GetPosition().Clone();if(null==a)return void this.sview.view.RemoveShape(o);for(var l=a,h=l.GetLineData(),u=h.GetRefLine().GetPoints(),p=0,c=0,d=new M3D.Vector3,S=new M3D.Line3D,f=u.slice(h.GetDataOffset(),h.GetDataOffset()+h.GetDataLength()),m=0;m<f.length-1;m+=2){var y=new M3D.Line3D(f[m],f[m+1]),T=new M3D.LineAttribute;T.SetID(y.GetID()),T.SetDirection(new M3D.Vector3(y.GetPosition().x-y.GetEndPoint().x,y.GetPosition().y-y.GetEndPoint().y,y.GetPosition().z-y.GetEndPoint().z)),T.SetStartPoint(y.GetEndPoint()),T.SetEndPoint(y.GetPosition()),T.SetCenterPoint(new M3D.Vector3(NaN,NaN,NaN));var M=M3D.ShapeHelper.GetShapeWorldMatrix(l);M3D.GeometryHelper.Transform(T,M),p=M3D.MeasureCalculateHelper.PntLineDistance(s,T,p,void 0,d),0===m?(c=p,S=new M3D.Line3D(f[m],f[m+1])):p<c&&(c=p,S=new M3D.Line3D(f[m],f[m+1]))}S.SetType(M3D.ShapeType.SHAPE_EDGE),this.sview.view.PreSelect(r,!0),t.SetSecondCurveLine(S),t.SetSecondShape(r),this.setMeasureStep(this.getMeasureStep()+1)}this.sview.view.RemoveShape(o)}},e.prototype.CurveToCurveAngleStep2=function(e){var t=this.GetMeasure();t.SetAnchorX(e.getX()),t.SetAnchorY(e.getY()),t.Create()?(this.sview.GetNativeShapeManager().AddShape(t.GetID(),t.GetMeasureObj()),this.setMeasureStep(0),this.SaveMeasure(t),this.Close(),this.ExecuteNew()):this.ProcessError()},e.prototype.FaceToFaceAngle=function(e){0==this.getMeasureStep()?this.FaceToFaceAngleStep0(e):1==this.getMeasureStep()?this.FaceToFaceAngleStep1(e):2==this.getMeasureStep()&&this.FaceToFaceAngleStep2(e)},e.prototype.FaceToFaceAngleStep1=function(e){var t=this.GetMeasure();if(M3D.ShapeType.SHAPE_FACE==M3D.ShapeType.SHAPE_FACE){var r,i=e.getX(),n=e.getY();if(0!=(r=this.sview.view.SelectTempShape(i,n,M3D.ShapeType.SHAPE_FACE,M3D.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_UNKNOWN))){this.sview.view.PreSelect(r,!0),t.SetSecondShape(r);var o=this.SelectedPnt(i,n,this.IsUseFeaturePnt());t.SetSecondAnChorShape(o),this.setMeasureStep(this.getMeasureStep()+1)}}},e.prototype.FaceToFaceAngleStep0=function(e){var t=this.GetMeasure();if(M3D.ShapeType.SHAPE_FACE==M3D.ShapeType.SHAPE_FACE){var r,i=e.getX(),n=e.getY();if(0!=(r=this.sview.view.SelectTempShape(i,n,M3D.ShapeType.SHAPE_FACE,M3D.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_UNKNOWN))){this.sview.view.PreSelect(r,!0),t.SetFirstShape(r);var o=this.SelectedPnt(i,n,this.IsUseFeaturePnt());t.SetFristAnChorShape(o),this.setMeasureStep(this.getMeasureStep()+1)}}},e.prototype.FaceToFaceAngleStep2=function(e){var t=this.GetMeasure();t.SetAnchorX(e.getX()),t.SetAnchorY(e.getY()),t.Create()?(this.sview.GetNativeShapeManager().AddShape(t.GetID(),t.GetMeasureObj()),this.setMeasureStep(0),this.SaveMeasure(t),this.Close(),this.ExecuteNew()):this.ProcessError()},e.prototype.LineToFaceAngle=function(e){0==this.getMeasureStep()?this.LineToFaceAngleStep0(e):1==this.getMeasureStep()?this.LineToFaceAngleStep1(e):2==this.getMeasureStep()&&this.LineToFaceAngleStep2(e)},e.prototype.LineToFaceAngleStep1=function(e){var t=this.GetMeasure();if(M3D.ShapeType.SHAPE_EDGE==M3D.ShapeType.SHAPE_EDGE){var r,i=e.getX(),n=e.getY();0!=(r=this.sview.view.SelectTempShape(i,n,M3D.ShapeType.SHAPE_EDGE,M3D.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_UNKNOWN))&&(this.sview.view.PreSelect(r,!0),t.SetSecondShape(r),this.setMeasureStep(this.getMeasureStep()+1))}},e.prototype.LineToFaceAngleStep0=function(e){var t=this.GetMeasure();if(M3D.ShapeType.SHAPE_FACE==M3D.ShapeType.SHAPE_FACE){var r,i=e.getX(),n=e.getY();if(0!=(r=this.sview.view.SelectTempShape(i,n,M3D.ShapeType.SHAPE_FACE,M3D.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_UNKNOWN))){this.sview.view.PreSelect(r,!0),t.SetFirstShape(r);var o=this.SelectedPnt(i,n,this.IsUseFeaturePnt());t.SetFristAnChorShape(o),this.setMeasureStep(this.getMeasureStep()+1)}}},e.prototype.LineToFaceAngleStep2=function(e){var t=this.GetMeasure();t.SetAnchorX(e.getX()),t.SetAnchorY(e.getY()),t.Create()?(this.sview.GetNativeShapeManager().AddShape(t.GetID(),t.GetMeasureObj()),this.setMeasureStep(0),this.SaveMeasure(t),this.Close(),this.ExecuteNew()):this.ProcessError()},e.prototype.LineToLineAngle=function(e){0==this.getMeasureStep()?this.LineToLineAngleStep0(e):1==this.getMeasureStep()?this.LineToLineAngleStep1(e):2==this.getMeasureStep()&&this.LineToLineAngleStep2(e)},e.prototype.LineToLineAngleStep0=function(e){var t=this.GetMeasure();if(M3D.ShapeType.SHAPE_EDGE==M3D.ShapeType.SHAPE_EDGE){var r,i=e.getX(),n=e.getY();0!=(r=this.sview.view.SelectTempShape(i,n,M3D.ShapeType.SHAPE_EDGE,M3D.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_UNKNOWN))&&(this.sview.view.PreSelect(r,!0),t.SetFirstShape(r),this.setMeasureStep(this.getMeasureStep()+1))}},e.prototype.LineToLineAngleStep1=function(e){var t=this.GetMeasure();if(M3D.ShapeType.SHAPE_EDGE==M3D.ShapeType.SHAPE_EDGE){var r,i=e.getX(),n=e.getY();0!=(r=this.sview.view.SelectTempShape(i,n,M3D.ShapeType.SHAPE_EDGE,M3D.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_UNKNOWN))&&(this.sview.view.PreSelect(r,!0),t.SetSecondShape(r),this.setMeasureStep(this.getMeasureStep()+1))}},e.prototype.LineToLineAngleStep2=function(e){var t=this.GetMeasure();t.SetAnchorX(e.getX()),t.SetAnchorY(e.getY()),t.Create()?(this.sview.GetNativeShapeManager().AddShape(t.GetID(),t.GetMeasureObj()),this.setMeasureStep(0),this.SaveMeasure(t),this.Close(),this.ExecuteNew()):this.ProcessError()},e.prototype.ProcessError=function(){this.Close(),this.ExecuteNew(),this.sview.MeasureError()},e.prototype.Close=function(){r.prototype.Close.call(this),this.ClearTmpSource()},e.prototype.ClearTmpSource=function(){var e=this.GetMeasure();if(this.setMeasureStep(0),null!=e){var t=e.GetMeasureType();if(t==s.SMeasure.MEASURE_TYPE_LINE_LINE_ANGLE){var r=(a=e).GetFirstShape(),i=a.GetSecondShape();0<r&&this.sview.view.PreSelect(r,!1),0<i&&this.sview.view.PreSelect(i,!1)}else if(t==s.SMeasure.MEASURE_TYPE_LINE_FACE_ANGLE){r=(a=e).GetFirstShape();0<(i=a.GetSecondShape())&&this.sview.view.PreSelect(i,!1),0<(n=a.GetFristAnChorShape())&&this.sview.view.RemoveShape(n),0<r&&this.sview.view.PreSelect(r,!1)}else if(t==s.SMeasure.MEASURE_TYPE_FACE_FACE_ANGLE){var n;r=(a=e).GetFirstShape(),i=a.GetSecondShape();0<r&&this.sview.view.PreSelect(r,!1),0<i&&this.sview.view.PreSelect(i,!1),0<(n=a.GetFristAnChorShape())&&this.sview.view.RemoveShape(n);var o=a.GetSecondAnChorShape();0<o&&this.sview.view.RemoveShape(o)}else if(t==s.SMeasure.MEASURE_TYPE_CURVE_CURVE_ANGLE){var a;r=(a=e).GetFirstShape(),i=a.GetSecondShape();0<r&&this.sview.view.PreSelect(r,!1),0<i&&this.sview.view.PreSelect(i,!1)}}},e}(s.MeasureCommand);s.MeasureAngleCommand=e}(SView||(SView={})),function(r){var e=function(){function e(e){this._commandsMap=new M3D.Map,this._currentCommand=null,this._measureCommandType=r.MeasureCommandType.MEASURE_NONE,this._sview=null,this.SetSviewControl(e)}return e.prototype.GetCurrentCommand=function(){return this._currentCommand},e.prototype.SetCurrentCommand=function(e){this._currentCommand=e},e.prototype.CloseCurrentCommand=function(){null!=this._currentCommand&&(this._currentCommand.Close(),this._currentCommand=null)},e.prototype.SetSviewControl=function(e){this._sview=e},e.prototype.GetSviewControl=function(){return this._sview},e.prototype.ExecuteEditCommand=function(){this.CloseCurrentCommand(),this._sview.view.SetSelectType(M3D.ShapeType.SHAPE_NOTE_BASE),this.ExcuateCmmand(r.MeasureCommandType.MEASURE_EDIT,r.SMeasure.MEASURE_TYPE_BASE)},e.prototype.CloseAllCommand=function(){this._currentCommand=null,this._measureCommandType=r.MeasureCommandType.MEASURE_NONE;for(var e=0,t=this._commandsMap.Values();e<t.length;e++){t[e].Close()}this._commandsMap.Clear()},e.prototype.ExcuateCmmand=function(e,t){if(this._currentCommand=this.GetCommand(e),null!=this._currentCommand){this._measureCommandType=e,this.GetSviewControl().GetCommandManager().AddCommand(this._currentCommand);var r=this.CreateMeasure(e);r.SetMeasureType(t),this._currentCommand.SetMeasure(r),this._currentCommand.SetMeasureCommandManager(this),this._currentCommand.Execute()}},e.prototype.CreateMeasure=function(e){var t=null;switch(e){case r.MeasureCommandType.MEASURE_DISTANCE:t=new r.SMeasureDistance;break;case r.MeasureCommandType.MEASURE_ANGLE:t=new r.SMeasureAngle;break;case r.MeasureCommandType.MEASURE_DIAMETER:t=new r.SMeasureDiametre;break;case r.MeasureCommandType.MEASURE_PROPERTY:t=new r.SMeasureProperty;break;case r.MeasureCommandType.MEASURE_PROPERTYNew:break;case r.MeasureCommandType.MEASURE_TEXT_NOTE:t=new r.STextNote;break;case r.MeasureCommandType.MEASURE_CT_TEXT_NOTE:break;case r.MeasureCommandType.MEASURE_VOICE_NOTE:t=new r.SVoiceNote;break;case r.MeasureCommandType.MEASURE_SEQUENCE_NUM:t=new r.SSequenceNumberNote;break;case r.MeasureCommandType.MEASURE_EDIT:t=new r.SMeasure}return null!=t&&t.SetView(this.GetSviewControl().view),t},e.prototype.ExcuteCommand=function(e,t){this._currentCommand=this.GetCommand(e),null!=this._currentCommand&&(this._measureCommandType=e,this._sview.GetCommandManager().AddCommand(this._currentCommand),this._currentCommand.SetMeasure(t),this._currentCommand.Execute())},e.prototype.GetMeasureCommandType=function(){return this._measureCommandType},e.prototype.Undo=function(){this._currentCommand},e.prototype.GetCommand=function(e){switch(this._commandsMap.ContainKey(e)||this._commandsMap.Put(e,null),e){case r.MeasureCommandType.MEASURE_LENGTH:0==this._commandsMap.Size()||this._commandsMap.Get(e);break;case r.MeasureCommandType.MEASURE_DIAMETER:0!=this._commandsMap.Size()&&null!=this._commandsMap.Get(e)||this._commandsMap.Put(r.MeasureCommandType.MEASURE_DIAMETER,new r.MeasureDiametreCommand(this._sview));break;case r.MeasureCommandType.MEASURE_RADIUS:0==this._commandsMap.Size()||this._commandsMap.Get(e);break;default:case r.MeasureCommandType.MEASURE_DISTANCE:0!=this._commandsMap.Size()&&null!=this._commandsMap.Get(e)||this._commandsMap.Put(r.MeasureCommandType.MEASURE_DISTANCE,new r.MeasureDistanceCommand(this._sview));break;case r.MeasureCommandType.MEASURE_ANGLE:0!=this._commandsMap.Size()&&null!=this._commandsMap.Get(e)||this._commandsMap.Put(r.MeasureCommandType.MEASURE_ANGLE,new r.MeasureAngleCommand(this._sview));break;case r.MeasureCommandType.MEASURE_PROPERTY:0!=this._commandsMap.Size()&&null!=this._commandsMap.Get(e)||this._commandsMap.Put(r.MeasureCommandType.MEASURE_PROPERTY,new r.MeasurePorpertyCommand(this._sview));break;case r.MeasureCommandType.MEASURE_TEXT_NOTE:if(0==this._commandsMap.Size()||null==this._commandsMap.Get(e)){var t=new r.TextNoteCommand(this._sview);this._commandsMap.Put(r.MeasureCommandType.MEASURE_TEXT_NOTE,t)}break;case r.MeasureCommandType.MEASURE_VOICE_NOTE:0!=this._commandsMap.Size()&&null!=this._commandsMap.Get(e)||(this._commandsMap[r.MeasureCommandType.MEASURE_VOICE_NOTE]=new r.VoiceNoteCommand(this._sview));break;case r.MeasureCommandType.MEASURE_SEQUENCE_NUM:if(0==this._commandsMap.Size()||null==this._commandsMap.Get(e)){t=new r.SequenceNumberNoteCommand(this._sview);this._commandsMap.Put(r.MeasureCommandType.MEASURE_SEQUENCE_NUM,t)}break;case r.MeasureCommandType.MEASURE_EDIT:if(0==this._commandsMap.Size()||null==this._commandsMap.Get(e)){t=new r.MeasureEditCommand(this._sview);this._commandsMap.Put(r.MeasureCommandType.MEASURE_EDIT,t)}break;case r.MeasureCommandType.MEASURE_PROPERTYNew:0==this._commandsMap.Size()||this._commandsMap.Get(e)}return this._commandsMap.Get(e)},e}();r.MeasureCommandManager=e}(SView||(SView={})),function(a){var e=function(r){function e(e){var t=r.call(this,e)||this;return t.SetCommandType(a.MeasureCommandType.MEASURE_DIAMETER),t}return __extends(e,r),e.prototype.OnTouchHandle=function(e,t){var r=!1,i=this.ProcessEditAndDrag(e,t);if(1==i)return!0;if(2==i)return!1;var n=this.GetMeasure();if(null==n)return!1;var o=n.GetMeasureType();return o==a.SMeasure.MEASURE_TYPE_DIAMETRE?(this.CircleDiametre(t),r=!0):o==a.SMeasure.MEASURE_TYPE_RADIUS&&(this.CircleRadius(t),r=!0),r},e.prototype.CircleDiametre=function(e){0==this.getMeasureStep()?this.CircleDiametreStep0(e):1==this.getMeasureStep()&&this.CircleDiametreStep1(e)},e.prototype.CircleRadius=function(e){0==this.getMeasureStep()?this.CircleRadiusStep0(e):1==this.getMeasureStep()&&this.CircleRadiusStep1(e)},e.prototype.CircleDiametreStep0=function(e){var t=this.GetMeasure();if(M3D.ShapeType.SHAPE_EDGE==M3D.ShapeType.SHAPE_EDGE){var r,i=e.getX(),n=e.getY();0!=(r=this.sview.view.SelectTempShape(i,n,M3D.ShapeType.SHAPE_EDGE,M3D.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_UNKNOWN))&&(this.sview.view.PreSelect(r,!0),t.SetFirstShape(r),this.setMeasureStep(this.getMeasureStep()+1))}},e.prototype.CircleDiametreStep1=function(e){var t=this.GetMeasure();t.SetAnchorX(e.getX()),t.SetAnchorY(e.getY()),t.Create()?(this.sview.GetNativeShapeManager().AddShape(t.GetID(),t.GetMeasureObj()),this.setMeasureStep(0),this.SaveMeasure(t),this.Close(),this.ExecuteNew()):this.ProcessError()},e.prototype.CircleRadiusStep0=function(e){var t=this.GetMeasure();if(M3D.ShapeType.SHAPE_EDGE==M3D.ShapeType.SHAPE_EDGE){var r,i=e.getX(),n=e.getY();0!=(r=this.sview.view.SelectTempShape(i,n,M3D.ShapeType.SHAPE_EDGE,M3D.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_UNKNOWN))&&(this.sview.view.PreSelect(r,!0),t.SetFirstShape(r),this.setMeasureStep(this.getMeasureStep()+1))}},e.prototype.CircleRadiusStep1=function(e){var t=this.GetMeasure();t.SetAnchorX(e.getX()),t.SetAnchorY(e.getY()),t.Create()?(this.sview.GetNativeShapeManager().AddShape(t.GetID(),t.GetMeasureObj()),this.setMeasureStep(0),this.SaveMeasure(t),this.Close(),this.ExecuteNew()):this.ProcessError()},e.prototype.ProcessError=function(){this.Close(),this.ExecuteNew(),this.sview.MeasureError()},e.prototype.Close=function(){r.prototype.Close.call(this),this.ClearTmpSource()},e.prototype.ClearTmpSource=function(){var e=this.GetMeasure();if(this.setMeasureStep(0),null!=e){var t=e.GetMeasureType();if(t==a.SMeasure.MEASURE_TYPE_DIAMETRE&&e instanceof a.SMeasureDiametre)0<(r=e.GetFirstShape())&&this.sview.view.PreSelect(r,!1);else if(t==a.SMeasure.MEASURE_TYPE_RADIUS&&e instanceof a.SMeasureDiametre){var r;0<(r=e.GetFirstShape())&&this.sview.view.PreSelect(r,!1)}}},e}(a.MeasureCommand);a.MeasureDiametreCommand=e}(SView||(SView={})),function(l){var e=function(r){function e(e){var t=r.call(this,e)||this;return t.SetCommandType(l.MeasureCommandType.MEASURE_DISTANCE),t}return __extends(e,r),e.prototype.OnTouchHandle=function(e,t){var r=!1,i=this.ProcessEditAndDrag(e,t);if(1==i)return!0;if(2==i)return!1;var n=this.GetMeasure();if(null==n)return!1;var o=n.GetMeasureType();return o==l.SMeasure.MEASURE_TYPE_PNT_PNT_DISTANCE?(this.PntToPntDistance(t),r=!0):o==l.SMeasure.MEASURE_TYPE_PNT_LINE_DISTANCE?(this.PntToLineDistance(t),r=!0):o==l.SMeasure.MEASURE_TYPE_PNT_FACE_DISTANCE?(this.PntToFaceDistance(t),r=!0):o==l.SMeasure.MEASURE_TYPE_LINE_LINE_DISTANCE?(this.LineToLineDistance(t),r=!0):o==l.SMeasure.MEASURE_TYPE_LINE_FACE_DISTANCE?(this.LineToFaceDistance(t),r=!0):o==l.SMeasure.MEASURE_TYPE_FACE_FACE_DISTANCE?(this.FaceToFaceDistance(t),r=!0):o==l.SMeasure.MEASURE_TYPE_SHAFT_SHAFT_DISTANCE?(this.ShaftToShaftDistance(t),r=!0):o==l.SMeasure.MEASURE_TYPE_CENTER_CENTER_DISTANCE?(this.CenterToCenterDistance(t),r=!0):o==l.SMeasure.MEASURE_TYPE_LENGTH?(this.LineDistance(t),r=!0):o==l.SMeasure.MEASURE_TYPE_ARC&&(this.ArcDistance(t),r=!0),r},e.prototype.PntToPntDistance=function(e){0==this.getMeasureStep()?this.PntToPntStep0(e):1==this.getMeasureStep()?this.PntToPntStep1(e):2==this.getMeasureStep()&&this.PntToPntStep2(e)},e.prototype.PntToLineDistance=function(e){0==this.getMeasureStep()?this.PntToLineStep0(e):1==this.getMeasureStep()?this.PntToLineStep1(e):2==this.getMeasureStep()&&this.PntToLineStep2(e)},e.prototype.PntToFaceDistance=function(e){0==this.getMeasureStep()?this.PntToFaceStep0(e):1==this.getMeasureStep()?this.PntToFaceStep1(e):2==this.getMeasureStep()&&this.PntToFaceStep2(e)},e.prototype.LineToLineDistance=function(e){0==this.getMeasureStep()?this.LineToLineStep0(e):1==this.getMeasureStep()?this.LineToLineStep1(e):2==this.getMeasureStep()&&this.LineToLineStep2(e)},e.prototype.LineToFaceDistance=function(e){0==this.getMeasureStep()?this.LineToFaceStep0(e):1==this.getMeasureStep()?this.LineToFaceStep1(e):2==this.getMeasureStep()&&this.LineToFaceStep2(e)},e.prototype.FaceToFaceDistance=function(e){0==this.getMeasureStep()?this.FaceToFaceStep0(e):1==this.getMeasureStep()?this.FaceToFaceStep1(e):2==this.getMeasureStep()&&this.FaceToFaceStep2(e)},e.prototype.ShaftToShaftDistance=function(e){0==this.getMeasureStep()?this.ShaftToShaftStep0(e):1==this.getMeasureStep()?this.ShaftToShaftStep1(e):2==this.getMeasureStep()&&this.ShaftToShaftStep2(e)},e.prototype.CenterToCenterDistance=function(e){0==this.getMeasureStep()?this.CenterToCenterStep0(e):1==this.getMeasureStep()?this.CenterToCenterStep1(e):2==this.getMeasureStep()&&this.CenterToCenterStep2(e)},e.prototype.LineDistance=function(e){0==this.getMeasureStep()?this.LineDistanceStep0(e):1==this.getMeasureStep()&&this.LineDistanceStep1(e)},e.prototype.ArcDistance=function(e){0==this.getMeasureStep()?this.ArcDistanceStep0(e):1==this.getMeasureStep()&&this.ArcDistanceStep1(e)},e.prototype.PntToPntStep2=function(e){var t=this.GetMeasure();t.SetAnchorX(e.getX()),t.SetAnchorY(e.getY()),t.Create()?(this.sview.GetNativeShapeManager().AddShape(t.GetID(),t.GetMeasureObj()),this.setMeasureStep(0),this.SaveMeasure(t),this.Close(),this.ExecuteNew()):this.ProcessError()},e.prototype.PntToPntStep1=function(e){var t=this.GetMeasure(),r=M3D.ShapeType.SHAPE_COORDINATE;if(r==M3D.ShapeType.SHAPE_COORDINATE&&r==M3D.ShapeType.SHAPE_COORDINATE){var i,n=e.getX(),o=e.getY();0!=(i=this.SelectedPnt(n,o,this.IsUseFeaturePnt()))&&(t.SetSecondShape(i),this.setMeasureStep(this.getMeasureStep()+1))}},e.prototype.PntToPntStep0=function(e){var t=this.GetMeasure();if(M3D.ShapeType.SHAPE_COORDINATE==M3D.ShapeType.SHAPE_COORDINATE){var r,i=e.getX(),n=e.getY();0!=(r=this.SelectedPnt(i,n,this.IsUseFeaturePnt()))&&(t.SetFirstShape(r),this.setMeasureStep(this.getMeasureStep()+1))}},e.prototype.PntToLineStep1=function(e){var t=this.GetMeasure();if(M3D.ShapeType.SHAPE_COORDINATE==M3D.ShapeType.SHAPE_COORDINATE){var r,i=e.getX(),n=e.getY();0!=(r=this.SelectedPnt(i,n,this.IsUseFeaturePnt()))&&(t.SetSecondShape(r),this.setMeasureStep(this.getMeasureStep()+1))}},e.prototype.PntToLineStep0=function(e){var t=this.GetMeasure();if(M3D.ShapeType.SHAPE_EDGE==M3D.ShapeType.SHAPE_EDGE){var r,i=e.getX(),n=e.getY();0!=(r=this.sview.view.SelectTempShape(i,n,M3D.ShapeType.SHAPE_EDGE,M3D.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_UNKNOWN))&&(this.sview.view.PreSelect(r,!0),t.SetFirstShape(r),this.setMeasureStep(this.getMeasureStep()+1))}},e.prototype.PntToLineStep2=function(e){var t=this.GetMeasure();t.SetAnchorX(e.getX()),t.SetAnchorY(e.getY()),t.Create()?(this.sview.GetNativeShapeManager().AddShape(t.GetID(),t.GetMeasureObj()),this.setMeasureStep(0),this.SaveMeasure(t),this.Close(),this.ExecuteNew()):this.ProcessError()},e.prototype.PntToFaceStep1=function(e){var t=this.GetMeasure();if(M3D.ShapeType.SHAPE_COORDINATE==M3D.ShapeType.SHAPE_COORDINATE){var r,i=e.getX(),n=e.getY();0!=(r=this.SelectedPnt(i,n,this.IsUseFeaturePnt()))&&(t.SetSecondShape(r),this.setMeasureStep(this.getMeasureStep()+1))}},e.prototype.PntToFaceStep0=function(e){var t=this.GetMeasure();if(M3D.ShapeType.SHAPE_FACE==M3D.ShapeType.SHAPE_FACE){var r,i=e.getX(),n=e.getY();if(0!=(r=this.sview.view.SelectTempShape(i,n,M3D.ShapeType.SHAPE_FACE,M3D.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_UNKNOWN))){this.sview.view.PreSelect(r,!0),t.SetFirstShape(r);var o=this.SelectedPnt(i,n,this.IsUseFeaturePnt());t.SetFristAnChorShape(o),this.setMeasureStep(this.getMeasureStep()+1)}}},e.prototype.PntToFaceStep2=function(e){var t=this.GetMeasure();t.SetAnchorX(e.getX()),t.SetAnchorY(e.getY()),t.Create()?(this.sview.GetNativeShapeManager().AddShape(t.GetID(),t.GetMeasureObj()),this.setMeasureStep(0),this.SaveMeasure(t),this.Close(),this.ExecuteNew()):this.ProcessError()},e.prototype.LineToLineStep0=function(e){var t=this.GetMeasure();if(M3D.ShapeType.SHAPE_EDGE==M3D.ShapeType.SHAPE_EDGE){var r=0,i=e.getX(),n=e.getY(),o=this.sview.view.GetPickShape(i,n,M3D.ShapeType.SHAPE_EDGE,M3D.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_UNKNOWN);o&&(r=o.GetID()),0!=r&&(this.sview.view.PreSelect(r,!0),t.SetFirstShape(r),this.setMeasureStep(this.getMeasureStep()+1))}},e.prototype.LineToLineStep1=function(e){var t=this.GetMeasure();if(M3D.ShapeType.SHAPE_EDGE==M3D.ShapeType.SHAPE_EDGE){var r=0,i=e.getX(),n=e.getY(),o=this.sview.view.GetPickShape(i,n,M3D.ShapeType.SHAPE_EDGE,M3D.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_UNKNOWN);o&&(r=o.GetID()),0!=r&&(this.sview.view.PreSelect(r,!0),t.SetSecondShape(r),this.setMeasureStep(this.getMeasureStep()+1))}},e.prototype.LineToLineStep2=function(e){var t=this.GetMeasure();t.SetAnchorX(e.getX()),t.SetAnchorY(e.getY()),t.Create()?(this.sview.GetNativeShapeManager().AddShape(t.GetID(),t.GetMeasureObj()),this.setMeasureStep(0),this.SaveMeasure(t),this.Close(),this.ExecuteNew()):this.ProcessError()},e.prototype.LineToFaceStep1=function(e){var t=this.GetMeasure();if(M3D.ShapeType.SHAPE_EDGE==M3D.ShapeType.SHAPE_EDGE){var r,i=e.getX(),n=e.getY();0!=(r=this.sview.view.SelectTempShape(i,n,M3D.ShapeType.SHAPE_EDGE,M3D.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_UNKNOWN))&&(this.sview.view.PreSelect(r,!0),t.SetSecondShape(r),this.setMeasureStep(this.getMeasureStep()+1))}},e.prototype.LineToFaceStep0=function(e){var t=this.GetMeasure();if(M3D.ShapeType.SHAPE_FACE==M3D.ShapeType.SHAPE_FACE){var r,i=e.getX(),n=e.getY();if(0!=(r=this.sview.view.SelectTempShape(i,n,M3D.ShapeType.SHAPE_FACE,M3D.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_UNKNOWN))){this.sview.view.PreSelect(r,!0),t.SetFirstShape(r);var o=this.SelectedPnt(i,n,this.IsUseFeaturePnt());t.SetFristAnChorShape(o),this.setMeasureStep(this.getMeasureStep()+1)}}},e.prototype.LineToFaceStep2=function(e){var t=this.GetMeasure();t.SetAnchorX(e.getX()),t.SetAnchorY(e.getY()),t.Create()?(this.sview.GetNativeShapeManager().AddShape(t.GetID(),t.GetMeasureObj()),this.setMeasureStep(0),this.SaveMeasure(t),this.Close(),this.ExecuteNew()):this.ProcessError()},e.prototype.FaceToFaceStep0=function(e){var t=this.GetMeasure();if(M3D.ShapeType.SHAPE_FACE==M3D.ShapeType.SHAPE_FACE){var r,i=e.getX(),n=e.getY();if(0!=(r=this.sview.view.SelectTempShape(i,n,M3D.ShapeType.SHAPE_FACE,M3D.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_UNKNOWN))){var o=this.SelectedPnt(i,n,!1);0!=o&&(t.SetFristAnChorShape(o),this.sview.view.PreSelect(r,!0),t.SetFirstShape(r),this.setMeasureStep(this.getMeasureStep()+1))}}},e.prototype.FaceToFaceStep1=function(e){var t=this.GetMeasure();if(M3D.ShapeType.SHAPE_FACE==M3D.ShapeType.SHAPE_FACE){var r,i=e.getX(),n=e.getY();if(0!=(r=this.sview.view.SelectTempShape(i,n,M3D.ShapeType.SHAPE_FACE,M3D.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_UNKNOWN))){var o=this.SelectedPnt(i,n,!1);0!=o&&(t.SetSecondAnChorShape(o),this.sview.view.PreSelect(r,!0),t.SetSecondShape(r),this.setMeasureStep(this.getMeasureStep()+1))}}},e.prototype.FaceToFaceStep2=function(e){var t=this.GetMeasure();t.SetAnchorX(e.getX()),t.SetAnchorY(e.getY()),t.Create()?(this.sview.GetNativeShapeManager().AddShape(t.GetID(),t.GetMeasureObj()),this.setMeasureStep(0),this.SaveMeasure(t),this.Close(),this.ExecuteNew()):this.ProcessError()},e.prototype.ShaftToShaftStep0=function(e){var t=this.GetMeasure();if(M3D.ShapeType.SHAPE_EDGE==M3D.ShapeType.SHAPE_EDGE){var r,i=e.getX(),n=e.getY();0!=(r=this.sview.view.SelectTempShape(i,n,M3D.ShapeType.SHAPE_EDGE,M3D.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_UNKNOWN))&&(this.sview.view.PreSelect(r,!0),t.SetFirstShape(r),this.setMeasureStep(this.getMeasureStep()+1))}},e.prototype.ShaftToShaftStep1=function(e){var t=this.GetMeasure();if(M3D.ShapeType.SHAPE_EDGE==M3D.ShapeType.SHAPE_EDGE){var r,i=e.getX(),n=e.getY();0!=(r=this.sview.view.SelectTempShape(i,n,M3D.ShapeType.SHAPE_EDGE,M3D.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_UNKNOWN))&&(this.sview.view.PreSelect(r,!0),t.SetSecondShape(r),this.setMeasureStep(this.getMeasureStep()+1))}},e.prototype.ShaftToShaftStep2=function(e){var t=this.GetMeasure();t.SetAnchorX(e.getX()),t.SetAnchorY(e.getY()),t.Create()?(this.sview.GetNativeShapeManager().AddShape(t.GetID(),t.GetMeasureObj()),this.setMeasureStep(0),this.SaveMeasure(t),this.Close(),this.ExecuteNew()):this.ProcessError()},e.prototype.CenterToCenterStep0=function(e){var t=this.GetMeasure();if(M3D.ShapeType.SHAPE_EDGE==M3D.ShapeType.SHAPE_EDGE){var r,i=e.getX(),n=e.getY();0!=(r=this.sview.view.SelectTempShape(i,n,M3D.ShapeType.SHAPE_EDGE,M3D.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_UNKNOWN))&&(this.sview.view.PreSelect(r,!0),t.SetFirstShape(r),this.setMeasureStep(this.getMeasureStep()+1))}},e.prototype.CenterToCenterStep1=function(e){var t=this.GetMeasure();if(M3D.ShapeType.SHAPE_EDGE==M3D.ShapeType.SHAPE_EDGE){var r,i=e.getX(),n=e.getY();0!=(r=this.sview.view.SelectTempShape(i,n,M3D.ShapeType.SHAPE_EDGE,M3D.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_UNKNOWN))&&(this.sview.view.PreSelect(r,!0),t.SetSecondShape(r),this.setMeasureStep(this.getMeasureStep()+1))}},e.prototype.CenterToCenterStep2=function(e){var t=this.GetMeasure();t.SetAnchorX(e.getX()),t.SetAnchorY(e.getY()),t.Create()?(this.sview.GetNativeShapeManager().AddShape(t.GetID(),t.GetMeasureObj()),this.setMeasureStep(0),this.SaveMeasure(t),this.Close(),this.ExecuteNew()):this.ProcessError()},e.prototype.LineDistanceStep0=function(e){var t=this.GetMeasure();if(M3D.ShapeType.SHAPE_EDGE==M3D.ShapeType.SHAPE_EDGE){var r,i=e.getX(),n=e.getY();0!=(r=this.sview.view.SelectTempShape(i,n,M3D.ShapeType.SHAPE_EDGE,M3D.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_UNKNOWN))&&(this.sview.view.PreSelect(r,!0),t.SetFirstShape(r),this.setMeasureStep(this.getMeasureStep()+1))}},e.prototype.LineDistanceStep1=function(e){var t=this.GetMeasure();t.SetAnchorX(e.getX()),t.SetAnchorY(e.getY()),t.Create()?(this.sview.GetNativeShapeManager().AddShape(t.GetID(),t.GetMeasureObj()),this.setMeasureStep(0),this.SaveMeasure(t),this.Close(),this.ExecuteNew()):this.ProcessError()},e.prototype.ArcDistanceStep0=function(e){var t=this.GetMeasure();if(M3D.ShapeType.SHAPE_EDGE==M3D.ShapeType.SHAPE_EDGE){var r,i=e.getX(),n=e.getY();0!=(r=this.sview.view.SelectTempShape(i,n,M3D.ShapeType.SHAPE_EDGE,M3D.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_UNKNOWN))&&(this.sview.view.PreSelect(r,!0),t.SetFirstShape(r),this.setMeasureStep(this.getMeasureStep()+1))}},e.prototype.ArcDistanceStep1=function(e){var t=this.GetMeasure();t.SetAnchorX(e.getX()),t.SetAnchorY(e.getY()),t.Create()?(this.sview.GetNativeShapeManager().AddShape(t.GetID(),t.GetMeasureObj()),this.setMeasureStep(0),this.SaveMeasure(t),this.Close(),this.ExecuteNew()):this.ProcessError()},e.prototype.ProcessError=function(){this.Close(),this.ExecuteNew(),this.sview.MeasureError()},e.prototype.Close=function(){r.prototype.Close.call(this),this.ClearTmpSource()},e.prototype.ClearTmpSource=function(){var e=this.GetMeasure();if(this.setMeasureStep(0),null!=e){var t=e.GetMeasureType();if(t==l.SMeasure.MEASURE_TYPE_PNT_PNT_DISTANCE&&e instanceof l.SMeasureDistance){var r=(s=e).GetFirstShape(),i=s.GetSecondShape();0<r&&this.sview.view.RemoveShape(r),0<i&&this.sview.view.RemoveShape(i)}else if(t==l.SMeasure.MEASURE_TYPE_PNT_LINE_DISTANCE&&e instanceof l.SMeasureDistance){r=(s=e).GetFirstShape();0<(i=s.GetSecondShape())&&this.sview.view.RemoveShape(i),0<r&&this.sview.view.PreSelect(r,!1)}else if(t==l.SMeasure.MEASURE_TYPE_PNT_FACE_DISTANCE&&e instanceof l.SMeasureDistance){r=(s=e).GetFirstShape();0<(i=s.GetSecondShape())&&this.sview.view.RemoveShape(i),0<(n=s.GetFristAnChorShape())&&this.sview.view.RemoveShape(n),0<r&&this.sview.view.PreSelect(r,!1)}else if(t==l.SMeasure.MEASURE_TYPE_LINE_LINE_DISTANCE&&e instanceof l.SMeasureDistance){r=(s=e).GetFirstShape(),i=s.GetSecondShape();0<r&&this.sview.view.PreSelect(r,!1),0<i&&this.sview.view.PreSelect(i,!1)}else if(t==l.SMeasure.MEASURE_TYPE_LINE_FACE_DISTANCE&&e instanceof l.SMeasureDistance){var n;r=(s=e).GetFirstShape();0<(i=s.GetSecondShape())&&this.sview.view.PreSelect(i,!1),0<(n=s.GetFristAnChorShape())&&this.sview.view.RemoveShape(n),0<r&&this.sview.view.PreSelect(r,!1)}else if(t==l.SMeasure.MEASURE_TYPE_FACE_FACE_DISTANCE&&e instanceof l.SMeasureDistance){r=(s=e).GetFirstShape(),i=s.GetSecondShape();var o=s.GetFristAnChorShape(),a=s.GetSecondAnChorShape();0<r&&this.sview.view.PreSelect(r,!1),0<i&&this.sview.view.PreSelect(i,!1),0<o&&this.sview.view.RemoveShape(o),0<a&&this.sview.view.RemoveShape(a)}else if(t==l.SMeasure.MEASURE_TYPE_SHAFT_SHAFT_DISTANCE&&e instanceof l.SMeasureDistance){r=(s=e).GetFirstShape(),i=s.GetSecondShape();0<r&&this.sview.view.PreSelect(r,!1),0<i&&this.sview.view.PreSelect(i,!1)}else if(t==l.SMeasure.MEASURE_TYPE_CENTER_CENTER_DISTANCE&&e instanceof l.SMeasureDistance){r=(s=e).GetFirstShape(),i=s.GetSecondShape();0<r&&this.sview.view.PreSelect(r,!1),0<i&&this.sview.view.PreSelect(i,!1)}else if(t==l.SMeasure.MEASURE_TYPE_LENGTH&&e instanceof l.SMeasureDistance){0<(r=(s=e).GetFirstShape())&&this.sview.view.PreSelect(r,!1)}else if(t==l.SMeasure.MEASURE_TYPE_ARC&&e instanceof l.SMeasureDistance){var s;0<(r=(s=e).GetFirstShape())&&this.sview.view.PreSelect(r,!1)}}},e}(l.MeasureCommand);l.MeasureDistanceCommand=e}(SView||(SView={})),function(i){var e=function(r){function e(e){var t=r.call(this,e)||this;return t.SetCommandType(i.MeasureCommandType.MEASURE_EDIT),e.view.SetSelectType(M3D.ShapeType.SHAPE_MEASURE_BASE),t}return __extends(e,r),e.prototype.OnTouchHandle=function(e,t){var r=this.ProcessEditAndDrag(e,t);return 1==r||2!=r&&0==r},e}(i.MeasureCommand);i.MeasureEditCommand=e}(SView||(SView={})),function(i){var e=function(){function e(){}return e.onTextNote=function(e){var t=e.GetMeasureCommandManager(),r=t.GetCurrentCommand();null!=r?r.GetMeasure().GetMeasureType()!=i.SMeasure.MEASURE_TEXT_NOTE?(t.CloseCurrentCommand(),t.ExcuateCmmand(i.MeasureCommandType.MEASURE_TEXT_NOTE,i.SMeasure.MEASURE_TEXT_NOTE)):t.ExecuteEditCommand():t.ExcuateCmmand(i.MeasureCommandType.MEASURE_TEXT_NOTE,i.SMeasure.MEASURE_TEXT_NOTE)},e.onVoiceNote=function(e){var t=e.GetMeasureCommandManager(),r=t.GetCurrentCommand();null!=r?r.GetMeasure().GetMeasureType()!=i.SMeasure.MEASURE_VOICE_NOTE?(t.CloseCurrentCommand(),t.ExcuateCmmand(i.MeasureCommandType.MEASURE_VOICE_NOTE,i.SMeasure.MEASURE_VOICE_NOTE)):t.ExecuteEditCommand():t.ExcuateCmmand(i.MeasureCommandType.MEASURE_VOICE_NOTE,i.SMeasure.MEASURE_VOICE_NOTE)},e.onSequenceNote=function(e){var t=e.GetMeasureCommandManager(),r=t.GetCurrentCommand();null!=r?r.GetMeasure().GetMeasureType()!=i.SMeasure.MEASURE_SEQUENCE_NUMBER_NOTE?(t.CloseCurrentCommand(),t.ExcuateCmmand(i.MeasureCommandType.MEASURE_SEQUENCE_NUM,i.SMeasure.MEASURE_SEQUENCE_NUMBER_NOTE)):t.ExecuteEditCommand():t.ExcuateCmmand(i.MeasureCommandType.MEASURE_SEQUENCE_NUM,i.SMeasure.MEASURE_SEQUENCE_NUMBER_NOTE)},e.onMeasureDistancePntToPnt=function(e){var t=e.GetMeasureCommandManager(),r=t.GetCurrentCommand();null!=r?r.GetMeasure().GetMeasureType()!=i.SMeasure.MEASURE_TYPE_PNT_PNT_DISTANCE?(t.CloseCurrentCommand(),t.ExcuateCmmand(i.MeasureCommandType.MEASURE_DISTANCE,i.SMeasure.MEASURE_TYPE_PNT_PNT_DISTANCE)):t.ExecuteEditCommand():t.ExcuateCmmand(i.MeasureCommandType.MEASURE_DISTANCE,i.SMeasure.MEASURE_TYPE_PNT_PNT_DISTANCE)},e.onMeasureDistancePntToLine=function(e){var t=e.GetMeasureCommandManager(),r=t.GetCurrentCommand();null!=r?r.GetMeasure().GetMeasureType()!=i.SMeasure.MEASURE_TYPE_PNT_LINE_DISTANCE?(t.CloseCurrentCommand(),t.ExcuateCmmand(i.MeasureCommandType.MEASURE_DISTANCE,i.SMeasure.MEASURE_TYPE_PNT_LINE_DISTANCE)):t.ExecuteEditCommand():t.ExcuateCmmand(i.MeasureCommandType.MEASURE_DISTANCE,i.SMeasure.MEASURE_TYPE_PNT_LINE_DISTANCE)},e.onMeasureDistancePntToFace=function(e){var t=e.GetMeasureCommandManager(),r=t.GetCurrentCommand();null!=r?r.GetMeasure().GetMeasureType()!=i.SMeasure.MEASURE_TYPE_PNT_FACE_DISTANCE?(t.CloseCurrentCommand(),t.ExcuateCmmand(i.MeasureCommandType.MEASURE_DISTANCE,i.SMeasure.MEASURE_TYPE_PNT_FACE_DISTANCE)):t.ExecuteEditCommand():t.ExcuateCmmand(i.MeasureCommandType.MEASURE_DISTANCE,i.SMeasure.MEASURE_TYPE_PNT_FACE_DISTANCE)},e.onMeasureDistanceLineToLine=function(e){var t=e.GetMeasureCommandManager(),r=t.GetCurrentCommand();null!=r?r.GetMeasure().GetMeasureType()!=i.SMeasure.MEASURE_TYPE_LINE_LINE_DISTANCE?(t.CloseCurrentCommand(),t.ExcuateCmmand(i.MeasureCommandType.MEASURE_DISTANCE,i.SMeasure.MEASURE_TYPE_LINE_LINE_DISTANCE)):t.ExecuteEditCommand():t.ExcuateCmmand(i.MeasureCommandType.MEASURE_DISTANCE,i.SMeasure.MEASURE_TYPE_LINE_LINE_DISTANCE)},e.onMeasureDistanceLineToFace=function(e){var t=e.GetMeasureCommandManager(),r=t.GetCurrentCommand();null!=r?r.GetMeasure().GetMeasureType()!=i.SMeasure.MEASURE_TYPE_LINE_FACE_DISTANCE?(t.CloseCurrentCommand(),t.ExcuateCmmand(i.MeasureCommandType.MEASURE_DISTANCE,i.SMeasure.MEASURE_TYPE_LINE_FACE_DISTANCE)):t.ExecuteEditCommand():t.ExcuateCmmand(i.MeasureCommandType.MEASURE_DISTANCE,i.SMeasure.MEASURE_TYPE_LINE_FACE_DISTANCE)},e.onMeasureDistanceFaceToFace=function(e){var t=e.GetMeasureCommandManager(),r=t.GetCurrentCommand();null!=r?r.GetMeasure().GetMeasureType()!=i.SMeasure.MEASURE_TYPE_FACE_FACE_DISTANCE?(t.CloseCurrentCommand(),t.ExcuateCmmand(i.MeasureCommandType.MEASURE_DISTANCE,i.SMeasure.MEASURE_TYPE_FACE_FACE_DISTANCE)):t.ExecuteEditCommand():t.ExcuateCmmand(i.MeasureCommandType.MEASURE_DISTANCE,i.SMeasure.MEASURE_TYPE_FACE_FACE_DISTANCE)},e.onMeasureDistanceShaftToShaft=function(e){var t=e.GetMeasureCommandManager(),r=t.GetCurrentCommand();null!=r?r.GetMeasure().GetMeasureType()!=i.SMeasure.MEASURE_TYPE_SHAFT_SHAFT_DISTANCE?(t.CloseCurrentCommand(),t.ExcuateCmmand(i.MeasureCommandType.MEASURE_DISTANCE,i.SMeasure.MEASURE_TYPE_SHAFT_SHAFT_DISTANCE)):t.ExecuteEditCommand():t.ExcuateCmmand(i.MeasureCommandType.MEASURE_DISTANCE,i.SMeasure.MEASURE_TYPE_SHAFT_SHAFT_DISTANCE)},e.onMeasureDistanceCenterToCenter=function(e){var t=e.GetMeasureCommandManager(),r=t.GetCurrentCommand();null!=r?r.GetMeasure().GetMeasureType()!=i.SMeasure.MEASURE_TYPE_CENTER_CENTER_DISTANCE?(t.CloseCurrentCommand(),t.ExcuateCmmand(i.MeasureCommandType.MEASURE_DISTANCE,i.SMeasure.MEASURE_TYPE_CENTER_CENTER_DISTANCE)):t.ExecuteEditCommand():t.ExcuateCmmand(i.MeasureCommandType.MEASURE_DISTANCE,i.SMeasure.MEASURE_TYPE_CENTER_CENTER_DISTANCE)},e.onMeasureDistanceLine=function(e){var t=e.GetMeasureCommandManager(),r=t.GetCurrentCommand();null!=r?r.GetMeasure().GetMeasureType()!=i.SMeasure.MEASURE_TYPE_LENGTH?(t.CloseCurrentCommand(),t.ExcuateCmmand(i.MeasureCommandType.MEASURE_DISTANCE,i.SMeasure.MEASURE_TYPE_LENGTH)):t.ExecuteEditCommand():t.ExcuateCmmand(i.MeasureCommandType.MEASURE_DISTANCE,i.SMeasure.MEASURE_TYPE_LENGTH)},e.onMeasureDistanceArc=function(e){var t=e.GetMeasureCommandManager(),r=t.GetCurrentCommand();null!=r?r.GetMeasure().GetMeasureType()!=i.SMeasure.MEASURE_TYPE_ARC?(t.CloseCurrentCommand(),t.ExcuateCmmand(i.MeasureCommandType.MEASURE_DISTANCE,i.SMeasure.MEASURE_TYPE_ARC)):t.ExecuteEditCommand():t.ExcuateCmmand(i.MeasureCommandType.MEASURE_DISTANCE,i.SMeasure.MEASURE_TYPE_ARC)},e.onMeasureDistanceRadius=function(e){var t=e.GetMeasureCommandManager(),r=t.GetCurrentCommand();null!=r?r.GetMeasure().GetMeasureType()!=i.SMeasure.MEASURE_TYPE_RADIUS?(t.CloseCurrentCommand(),t.ExcuateCmmand(i.MeasureCommandType.MEASURE_DIAMETER,i.SMeasure.MEASURE_TYPE_RADIUS)):t.ExecuteEditCommand():t.ExcuateCmmand(i.MeasureCommandType.MEASURE_DIAMETER,i.SMeasure.MEASURE_TYPE_RADIUS)},e.onMeasureDistanceDiametre=function(e){var t=e.GetMeasureCommandManager(),r=t.GetCurrentCommand();null!=r?r.GetMeasure().GetMeasureType()!=i.SMeasure.MEASURE_TYPE_DIAMETRE?(t.CloseCurrentCommand(),t.ExcuateCmmand(i.MeasureCommandType.MEASURE_DIAMETER,i.SMeasure.MEASURE_TYPE_DIAMETRE)):t.ExecuteEditCommand():t.ExcuateCmmand(i.MeasureCommandType.MEASURE_DIAMETER,i.SMeasure.MEASURE_TYPE_DIAMETRE)},e.onMeasureAngleLineToLine=function(e){var t=e.GetMeasureCommandManager(),r=t.GetCurrentCommand();null!=r?r.GetMeasure().GetMeasureType()!=i.SMeasure.MEASURE_TYPE_LINE_LINE_ANGLE?(t.CloseCurrentCommand(),t.ExcuateCmmand(i.MeasureCommandType.MEASURE_ANGLE,i.SMeasure.MEASURE_TYPE_LINE_LINE_ANGLE)):t.ExecuteEditCommand():t.ExcuateCmmand(i.MeasureCommandType.MEASURE_ANGLE,i.SMeasure.MEASURE_TYPE_LINE_LINE_ANGLE)},e.onMeasureAngleLineToFace=function(e){var t=e.GetMeasureCommandManager(),r=t.GetCurrentCommand();null!=r?r.GetMeasure().GetMeasureType()!=i.SMeasure.MEASURE_TYPE_LINE_FACE_ANGLE?(t.CloseCurrentCommand(),t.ExcuateCmmand(i.MeasureCommandType.MEASURE_ANGLE,i.SMeasure.MEASURE_TYPE_LINE_FACE_ANGLE)):t.ExecuteEditCommand():t.ExcuateCmmand(i.MeasureCommandType.MEASURE_ANGLE,i.SMeasure.MEASURE_TYPE_LINE_FACE_ANGLE)},e.onMeasureAngleFaceToFace=function(e){var t=e.GetMeasureCommandManager(),r=t.GetCurrentCommand();null!=r?r.GetMeasure().GetMeasureType()!=i.SMeasure.MEASURE_TYPE_FACE_FACE_ANGLE?(t.CloseCurrentCommand(),t.ExcuateCmmand(i.MeasureCommandType.MEASURE_ANGLE,i.SMeasure.MEASURE_TYPE_FACE_FACE_ANGLE)):t.ExecuteEditCommand():t.ExcuateCmmand(i.MeasureCommandType.MEASURE_ANGLE,i.SMeasure.MEASURE_TYPE_FACE_FACE_ANGLE)},e.onMeasureAngleCurveToCurve=function(e){var t=e.GetMeasureCommandManager(),r=t.GetCurrentCommand();null!=r?r.GetMeasure().GetMeasureType()!=i.SMeasure.MEASURE_TYPE_CURVE_CURVE_ANGLE?(t.CloseCurrentCommand(),t.ExcuateCmmand(i.MeasureCommandType.MEASURE_ANGLE,i.SMeasure.MEASURE_TYPE_CURVE_CURVE_ANGLE)):t.ExecuteEditCommand():t.ExcuateCmmand(i.MeasureCommandType.MEASURE_ANGLE,i.SMeasure.MEASURE_TYPE_CURVE_CURVE_ANGLE)},e.onMeasurePropertyPnt=function(e){var t=e.GetMeasureCommandManager(),r=t.GetCurrentCommand();null!=r?r.GetMeasure().GetMeasureType()!=i.SMeasure.MEASURE_TYPE_PNT_COORD?(t.CloseCurrentCommand(),t.ExcuateCmmand(i.MeasureCommandType.MEASURE_PROPERTY,i.SMeasure.MEASURE_TYPE_PNT_COORD)):t.ExecuteEditCommand():t.ExcuateCmmand(i.MeasureCommandType.MEASURE_PROPERTY,i.SMeasure.MEASURE_TYPE_PNT_COORD)},e.onMeasurePropertyModel=function(e){var t=e.GetMeasureCommandManager(),r=t.GetCurrentCommand();null!=r?r.GetMeasure().GetMeasureType()!=i.SMeasure.MEASURE_TYPE_MODEL?(t.CloseCurrentCommand(),t.ExcuateCmmand(i.MeasureCommandType.MEASURE_PROPERTY,i.SMeasure.MEASURE_TYPE_MODEL)):t.ExecuteEditCommand():t.ExcuateCmmand(i.MeasureCommandType.MEASURE_PROPERTY,i.SMeasure.MEASURE_TYPE_MODEL)},e.onMeasurePropertyLine=function(e){var t=e.GetMeasureCommandManager(),r=t.GetCurrentCommand();null!=r?r.GetMeasure().GetMeasureType()!=i.SMeasure.MEASURE_TYPE_LENGTH?(t.CloseCurrentCommand(),t.ExcuateCmmand(i.MeasureCommandType.MEASURE_PROPERTY,i.SMeasure.MEASURE_TYPE_LENGTH)):t.ExecuteEditCommand():t.ExcuateCmmand(i.MeasureCommandType.MEASURE_PROPERTY,i.SMeasure.MEASURE_TYPE_LENGTH)},e.onMeasurePropertyFace=function(e){var t=e.GetMeasureCommandManager(),r=t.GetCurrentCommand();null!=r?r.GetMeasure().GetMeasureType()!=i.SMeasure.MEASURE_TYPE_CIRCLE?(t.CloseCurrentCommand(),t.ExcuateCmmand(i.MeasureCommandType.MEASURE_PROPERTY,i.SMeasure.MEASURE_TYPE_CIRCLE)):t.ExecuteEditCommand():t.ExcuateCmmand(i.MeasureCommandType.MEASURE_PROPERTY,i.SMeasure.MEASURE_TYPE_CIRCLE)},e.onNoteDelete=function(e){var t=e.GetSelector();if(null!=t){for(var r=new Array,i=t.GetAll(),n=0;n<i.length;n++)r.push(i[n]);0<r.length&&t.Clear();for(n=0;n<r.length;n++){var o=r[n];e.GetNativeShapeManager().RemoveShape(o.GetID()),e.view.RemoveShape(o.GetID())}}},e.onMeasureExit=function(e){this.onMeasureClose(e)},e.onMeasureClose=function(e){e.GetMeasureCommandManager().CloseAllCommand()},e.onTextNoteDelete=function(e){e.GetMeasureCommandManager()},e.onBase=function(e){var t=e.GetMeasureCommandManager();null!=t.GetCurrentCommand()?t.ExecuteEditCommand():t.ExcuateCmmand(i.MeasureCommandType.MEASURE_EDIT,i.SMeasure.MEASURE_TYPE_BASE)},e}();i.MeasureOperate=e}(SView||(SView={})),function(a){var e=function(r){function e(e){var t=r.call(this,e)||this;return t.SetCommandType(a.MeasureCommandType.MEASURE_PROPERTY),t}return __extends(e,r),e.prototype.OnTouchHandle=function(e,t){var r=!1,i=this.ProcessEditAndDrag(e,t);if(1==i)return!0;if(2==i)return!1;var n=this.GetMeasure();if(null==n)return!1;var o=n.GetMeasureType();return o==a.SMeasure.MEASURE_TYPE_PNT_COORD?(this.CoordPorperty(t),r=!0):o==a.SMeasure.MEASURE_TYPE_LENGTH?(this.LengthPorperty(t),r=!0):o==a.SMeasure.MEASURE_TYPE_CIRCLE?(this.CirclePorperty(t),r=!0):o==a.SMeasure.MEASURE_TYPE_MODEL&&(this.ModelPorperty(t),r=!0),r},e.prototype.ModelPorperty=function(e){0==this.getMeasureStep()&&this.ModelPorpertyStep0(e)},e.prototype.ModelPorpertyStep0=function(e){var t=this.GetMeasure();if(M3D.ShapeType.SHAPE_MODEL==M3D.ShapeType.SHAPE_MODEL){this.UiShowBegin(t);var r,i=e.getX(),n=e.getY();r=this.sview.view.SelectTempShape(i,n,M3D.ShapeType.SHAPE_MODEL,M3D.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_UNKNOWN),t.SetPropertyShape(r),0!=r&&this.sview.view.PreSelect(r,!0),this.UiShowEnd(t)}},e.prototype.ModelPorpertyStep1=function(e){var t=this.GetMeasure();t.SetAnchorX(e.getX()),t.SetAnchorY(e.getY()),t.Create()&&(this.setMeasureStep(0),this.SaveMeasure(t),this.Close(),this.ExecuteNew())},e.prototype.CoordPorperty=function(e){0==this.getMeasureStep()?this.CoordPorpertyStep0(e):1==this.getMeasureStep()&&this.CoordPorpertyStep1(e)},e.prototype.LengthPorperty=function(e){0==this.getMeasureStep()?this.LengthPorpertyStep0(e):1==this.getMeasureStep()&&this.LengthPorpertyStep1(e)},e.prototype.CirclePorperty=function(e){0==this.getMeasureStep()?this.CirclePorpertyStep0(e):1==this.getMeasureStep()&&this.CirclePorpertyStep1(e)},e.prototype.CirclePorpertyStep0=function(e){var t=this.GetMeasure();if(M3D.ShapeType.SHAPE_FACE==M3D.ShapeType.SHAPE_FACE){this.UiShowBegin(t);var r,i=e.getX(),n=e.getY();r=this.sview.view.SelectTempShape(i,n,M3D.ShapeType.SHAPE_FACE,M3D.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_UNKNOWN),t.SetPropertyShape(r),0!=r&&(this.sview.view.PreSelect(r,!0),this.setMeasureStep(this.getMeasureStep()+1)),this.UiShowEnd(t)}},e.prototype.CirclePorpertyStep1=function(e){var t=this.GetMeasure();t.SetAnchorX(e.getX()),t.SetAnchorY(e.getY()),t.Create()&&(this.setMeasureStep(0),this.SaveMeasure(t),this.Close(),this.ExecuteNew())},e.prototype.LengthPorpertyStep0=function(e){var t=this.GetMeasure();if(M3D.ShapeType.SHAPE_EDGE==M3D.ShapeType.SHAPE_EDGE){this.UiShowBegin(t);var r,i=e.getX(),n=e.getY();r=this.sview.view.SelectTempShape(i,n,M3D.ShapeType.SHAPE_EDGE,M3D.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_UNKNOWN),t.SetPropertyShape(r),0!=r&&(this.sview.view.PreSelect(r,!0),this.setMeasureStep(this.getMeasureStep()+1)),this.UiShowEnd(t)}},e.prototype.LengthPorpertyStep1=function(e){var t=this.GetMeasure();t.SetAnchorX(e.getX()),t.SetAnchorY(e.getY()),t.Create()&&(this.setMeasureStep(0),this.SaveMeasure(t),this.Close(),this.ExecuteNew())},e.prototype.CoordPorpertyStep0=function(e){var t=this.GetMeasure();if(M3D.ShapeType.SHAPE_COORDINATE==M3D.ShapeType.SHAPE_COORDINATE){this.UiShowBegin(t);var r,i=e.getX(),n=e.getY();0!=(r=this.SelectedPnt(i,n,this.IsUseFeaturePnt()))&&(t.SetPropertyShape(r),this.setMeasureStep(this.getMeasureStep()+1)),this.UiShowEnd(t)}},e.prototype.CoordPorpertyStep1=function(e){var t=this.GetMeasure();t.SetAnchorX(e.getX()),t.SetAnchorY(e.getY()),t.Create()&&(this.setMeasureStep(0),this.SaveMeasure(t),this.Close(),this.ExecuteNew())},e.prototype.UiShowBegin=function(e){e.GetShowType()==a.SMeasureProperty.UI_SHOW&&this.ClearTmpSource()},e.prototype.UiShowEnd=function(e){if(e.GetShowType()==a.SMeasureProperty.UI_SHOW){if(e.Create())return this.setMeasureStep(0),void this.ShowPropertiesDialog(e);0!=e.GetPropertyShape()&&(this.setMeasureStep(0),this.ShowPropertiesDialog(e))}else this.ClearTmpSource()},e.prototype.ShowPropertiesDialog=function(e){var t=e.GetMeasureProperties();null!=t&&0<t.length&&this.sview.MeasurePropertyStr(t)},e.prototype.ClearTmpSource=function(){var e,t=this.GetMeasure();(this.setMeasureStep(0),null!=t)&&(t.GetMeasureType()==a.SMeasure.MEASURE_TYPE_PNT_COORD&&t instanceof a.SMeasureProperty?0<(e=t.GetPropertyShape())&&this.sview.view.RemoveShape(e):0<(e=t.GetPropertyShape())&&this.sview.view.PreSelect(e,!1))},e.prototype.Close=function(){r.prototype.Close.call(this),this.ClearTmpSource()},e}(a.MeasureCommand);a.MeasurePorpertyCommand=e}(SView||(SView={})),function(e){var t;(t=e.TOUCH_MASK||(e.TOUCH_MASK={}))[t.TOUCH_DOWN=0]="TOUCH_DOWN",t[t.TOUCH_MOVE=1]="TOUCH_MOVE",t[t.TOUCH_UP=2]="TOUCH_UP",t[t.TOUCH_CANCELLED=3]="TOUCH_CANCELLED";var r=function(){function e(e,t,r){this.touchCount=0,this.x=0,this.y=0,this.mouseEvent=e,this.x=t,this.y=r}return e.prototype.getEventType=function(){return this.eventType},e.prototype.setEventType=function(e){this.eventType=e},e.prototype.getMouseEvent=function(){return this.mouseEvent},e.prototype.setMouseEvent=function(e){this.mouseEvent=e},e.prototype.getX=function(){return this.x},e.prototype.setX=function(e){this.x=e},e.prototype.getY=function(){return this.y},e.prototype.setY=function(e){this.y=e},e.prototype.getTouchCount=function(){return this.touchCount},e.prototype.setTouchCount=function(e){this.touchCount=e},e}();e.MotionEvent=r}(SView||(SView={})),function(u){var e=function(){function e(e){this.view=null,this.view=e}return e.prototype.Traver=function(e,t){var r=e.GetSubModels();if(0<r.length)for(var i=0;i<r.length;i++)this.Traver(r[i],t);t(e)},e.prototype.OnlyDisplayCurrent=function(){var r=this.view.GetSelector().GetAll(),e=this.view.model;0!==r.length&&(this.Traver(e,function(e){e.SetVisible(!1)}),this.Traver(e,function(e){for(var t=0;t<r.length;t++)if(e===r[t]){e.SetVisible(!0);break}}))},e.prototype.HideCurrent=function(){for(var e=this.view.GetSelector(),t=e.GetAll(),r=0,i=t;r<i.length;r++){var n=i[r];if(null!==n){n.SetVisible(!1),n.SetSelected(!1);var o=t.indexOf(n);u.Parameters.Instance().IsMulSelect||t.splice(o,1)}}u.Parameters.Instance().IsMulSelect&&t.splice(0,t.length),e.Clear()},e.prototype.ExchangeHidden=function(){var r=this.view.GetSelector().GetAll(),e=this.view.model;this.Traver(e,function(e){if(e.IsVisible()&&0===e.GetSubModels().length){e.SetVisible(!1),e.SetSelected(!1);var t=r.indexOf(e);r.splice(t,1)}else 0===e.GetSubModels().length&&e.SetVisible(!0)})},e.prototype.DisplayAll=function(){this.view.model.SetVisible(!0)},e.prototype.DisplayInCenter=function(){var e,t=this.view.GetSelector().GetAll()[0],r=this.view.GetSceneManager(),i=r.GetCamera(),n=i.GetViewPort(),o=n.GetRect();e=t?u.ModelTransformHelper.GetModelWorldBoundingBox(t).Center():r.GetSceneBox().Center();var a=new u.Vector2((o.left+o.right)/2,(o.bottom+o.top)/2),s=n.GetScreenRay(a.x,a.y),l=new u.Plane(s.GetDirection(),i.GetPosition()).Project(e);i.SetWorldPosition(l)},e.prototype.Foces=function(e){void 0===e&&(e=[]);var t,r=e[0],i=this.view.GetSceneManager(),n=i.GetCamera(),o=n.GetViewPort(),a=o.GetRect();t=r?u.ModelTransformHelper.GetModelWorldBoundingBox(r).Center():i.GetSceneBox().Center();var s=new u.Vector2((a.left+a.right)/2,(a.bottom+a.top)/2),l=o.GetScreenRay(s.x,s.y),h=new u.Plane(l.GetDirection(),n.GetPosition()).Project(t);n.SetWorldPosition(h)},e.prototype.ContinuousRotation=function(){u.Parameters.Instance().IsConRotate?(u.Parameters.Instance().IsConRotate=!1,this.view.CloseSceneAnimation()):u.Parameters.Instance().IsConRotate=!0},e}();u.SelectionOperator=e}(M3D||(M3D={})),function(g){var e=function(){function t(){}return t.Instance=function(e){return null==t.instance&&((t.instance=new t).view=e),t.instance},t.prototype.ToJson=function(){var e=this.view.GetModelViewsList(),t='{"version":"0.1","views":[',r='"model_views":[{"id":'+this.view.GetModel().GetID()+',"views":[',i='"view_notes":[',n='"view_sections":[';if(!(0<e.length))return t+="],",r+="]}],",i+="],",n+="]","";for(var o=0;o<e.length;o++){var a=e[o],s="{";s=s+'"id":'+a.GetID()+',"name":"'+a.GetName()+'","usageType":'+a.GetViewType()+',"isActivated":false,"isDefault":false,"transparency":1.0,',r=r+a.GetID()+",";var l=a.GetCamera();if(l){s=s+'"camera":{"projectType":'+l.GetOrthographic()+',"angle":1.0,"matix":"';var h=new g.Matrix4(l.GetRotation().RotationMatrix().Inverse());h.data[12]=l.GetPosition().x,h.data[13]=l.GetPosition().y,h.data[14]=l.GetPosition().z;for(var u=h.data,p=0;p<u.length;p++)s+=u[p].toFixed(8),p<u.length-1?s+=" ":s+='"';s=(s=(s=(s=s+',"aspectRatio":'+l.GetAspectRatio())+',"nearDistance":'+l.GetNearClip())+',"farDistance":'+l.GetFarClip())+',"height":'+l.GetOrthoSize().y,s+="},"}var c=a.GetInstanceAttributeMap();s+='"insAttributes":{';for(p=0;p<c.Keys().length;p++){var d=c.Keys()[p],S=c.Values()[p];s=s+'"'+g.PathHelper.SVLPathHexToDec(S.path)+'":{"plcPath":'+d+',"visible":'+(S.visible?0:1)+',"matix":"'+S.placeMatrix.Tostring()+'"',S.hasColor?s=s+',"color":"'+S.insColor.Tostring()+'"}':s+=',"color":"-1.00000000 -1.00000000 -1.000000000 -1.00000000"}',p<c.Keys().length-1&&(s+=",")}t+=s+="}},";var f=a.GetNoteList();if(0<f.length){i=i+'{"id":'+a.GetID()+',"notes":[';for(p=0;p<f.length;p++)p===f.length-1?i+=f[p]:i=i+f[p]+",";i+="]},"}var m=a.GetSectionPlaneIDList();if(0<m.length){n=n+'{"id":'+a.GetID()+',"sections":[';for(p=0;p<m.length;p++)p===m.length-1?n+=m[p]:n=n+m[p]+",";n+="]},"}}return t=t.substring(0,t.length-1),t+="],",r=r.substring(0,r.length-1),r+="]}],",i=i.substring(0,i.length-1),i+="],",n=n.substring(0,n.length-1),t=t+r+'"view_pmis":[],"view_views":[],'+i+'"view_signs":[],'+(n+="]")+"}"},t.prototype.FromJson=function(e){var t=[],r=JSON.parse(JSON.parse(JSON.stringify(e)));if(r){if(r.version)r.version;var i=new Array;if(r.model_views)i=r.model_views[0].views;var n=r.views;if(n)for(var o=0;o<n.length;o++){var a=n[o];if(!(i.indexOf(a.id)<0)){var s=this.parseOneModelView(a);if(r.view_pmis)for(var l=r.view_pmis,h=0;h<l.length;h++){if(l[h].id)if(l[h].id===s.GetID())for(var u=0;u<l[h].pmis.length;u++)s.AddPMIId(l[h].pmis[u])}if(r.view_notes){var p=r.view_notes;for(h=0;h<p.length;h++){if(p[h].id)if(p[h].id===s.GetID())for(u=0;u<p[h].notes.length;u++)s.AddNoteId(p[h].notes[u])}}if(r.view_sections){var c=r.view_sections;for(h=0;h<c.length;h++){if(c[h].id)if(c[h].id===s.GetID())for(u=0;u<c[h].sections.length;u++)s.AddSectionPlaneId(c[h].sections[u])}}t.push(s),this.view.GetModel().AddModelView(s)}}return t}},t.prototype.parseOneModelView=function(e){var t=new g.ModleView;t.SetID(e.id),t.SetName(e.name),t.SetViewType(e.usageType);var r=e.camera;if(r){var i=new g.Camera;if(i.SetOrthographic("1"==r.projectType),r.angle){var n=r.angle;i.SetFov(n)}if(r.matix){var o=new g.Matrix4;o.fromString(r.matix);var a=new g.Quaternion,s=new g.Matrix3(o.data[0],o.data[4],o.data[8],o.data[1],o.data[5],o.data[9],o.data[2],o.data[6],o.data[10]);a.FromRotationMatrix(s),i.SetPosition(new g.Vector3(o.data[12],o.data[13],o.data[14])),i.SetRotation(a)}var l=1;r.aspectRatio&&(l=r.aspectRatio),i.SetAspectRatio(l),r.nearDistance&&i.SetNearClip(r.nearDistance),r.farDistance&&i.SetFarClip(r.farDistance),r.focalDistance,r.height&&i.IsOrthographic()&&i.SetOrthoSize(new g.Vector2(r.height*l,r.height)),i.SetZoom(1),t.SetCamera(i),t.SetUpDataCamera(!0)}var h=e.insAttributes;for(var u in h){var p=h[u],c=p.matix,d=new g.InstanceAttribute;d.id=p.plcPath;var S=p.visible;if(d.visible=0===S,d.path=g.PathHelper.SVLPathDecToHex(u),c){var f=void 0,m=c.split(" ");if(16==m.length?f=new g.Matrix4:12==m.length&&(f=new g.Matrix3x4),f.fromString(c),f.Equals(g.Matrix4.ZERO().Clone()))continue;d.placeMatrix=f}var y=p.color;if(y){var T=y.split(" ");d.hasColor=!0;var M=new g.Color(Number(T[0]),Number(T[1]),Number(T[2]),Number(T[3]));d.insColor=M.Clone()}t.GetInstanceAttributeMap().Put(Number(p.plcPath),d)}return t},t.prototype.Create=function(){var e=(new Date).toISOString(),t=new g.ModleView;t.SetName(e),t.SetViewType(2);var r=this.view;r.UpdateViewByCurrentScene(t),r.GetModel().AddModelView(t)},t.prototype.Remove=function(e){this.view.GetModel().RemoveModelView(e.GetID())},t.prototype.Get=function(e){return this.view.GetModel().GetModleView(e)},t}();g.ModelViews=e}(M3D||(M3D={})),function(e){var t=function(){function e(e){this.type=0,this.view=e,this.type=0}return e.prototype.GetId=function(){return this.id},e.prototype.SetId=function(e){this.id=Number(e)},e.prototype.GetName=function(){return this.name},e.prototype.SetName=function(e){this.name=e},e.prototype.GetType=function(){return this.type},e.prototype.TaskValid=function(){return!1},e.prototype.Play=function(){},e.prototype.Stop=function(){},e.prototype.Pause=function(){},e.prototype.Percent=function(){return 0},e.prototype.Active=function(){},e.prototype.SetPercent=function(e){},e.prototype.GetNativeTask=function(){return 0},e.prototype.SetNativeTask=function(e){},e.prototype.IsRun=function(){return this.view.AnimationIsPlaying()},e}();e.SAnimationTask=t}(M3D||(M3D={})),function(e){var t=function(r){function e(e){var t=r.call(this,e)||this;return t.steplist=[],t.childProcessList=[],t.view=e,t.type=2,t}return __extends(e,r),e.prototype.SetProcessId=function(e){this.processId=Number(e)},e.prototype.GetProcessId=function(){return this.processId},e.prototype.AddStep=function(e){this.steplist.push(e)},e.prototype.GetStepList=function(){return this.steplist},e.prototype.AddChildProcess=function(e){this.childProcessList.push(e)},e.prototype.GetChildProcessList=function(){return this.childProcessList},e}(e.SAnimationTask);e.SAnimationProcess=t}(M3D||(M3D={})),function(e){var t=function(r){function e(e){var t=r.call(this,e)||this;return t.process=null,t.type=1,t}return __extends(e,r),e.prototype.SetProcessId=function(e){this.processId=Number(e)},e.prototype.GetProcessId=function(){return this.processId},e.prototype.SetStepInfo=function(e){this.stepInfo=e},e.prototype.GetStepInfo=function(){return this.stepInfo},e.prototype.GetProcess=function(){return this.process},e.prototype.SetProcess=function(e){this.process=e},e.prototype.Play=function(){this.view&&this.view.AnimationPlay()},e.prototype.Stop=function(){this.view&&this.view.AnimationRewind()},e.prototype.Active=function(){this.view&&this.view.AnimationSetActiveStep(this.processId,this.id)},e.prototype.Pause=function(){this.view&&this.view.AnimationIsPlaying()&&this.view.AnimationPlay()},e.prototype.Percent=function(){var e=0;return this.view&&(e=this.view.AnimationGetTick()),e},e.prototype.SetPercent=function(e){this.view&&this.view.AnimationSetTick(e)},e}(e.SAnimationTask);e.SAnimationStep=t}(M3D||(M3D={})),function(v){var e,t,r=function(){function g(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(this.PMIList=[],this.NoteList=[],this.SectionPlaneIDList=[],this.noteDataList=new v.Map,this.PLineColors=[],this.InstanceAttributeMap=new v.Map,this.appendInfo=new v.Map,0===e.length)this.ID=++g.MaxId,this.UpDataModel=!1,this.UpDataCamera=!1,this.ViewType=-1;else if(1===e.length){var r=e[0];g.MaxId++,this.ID=r.ID,this.Name=r.Name,this.Camera=r.Camera,this.PMIList=r.PMIList,this.NoteList=r.NoteList,this.SectionPlaneIDList=r.SectionPlaneIDList,this.UpDataCamera=r.UpDataCamera,this.UpDataModel=r.UpDataModel,this.noteDataList=r.noteDataList,this.PLineColors=r.PLineColors,this.InstanceAttributeMap=r.InstanceAttributeMap,this.SvlType=r.SvlType,this.ViewType=r.ViewType,this.appendInfo=r.appendInfo}}return g.prototype.SetModleView=function(e,t,r,i,n,o,a,s){this.SetID(e),this.SetName(t),this.SetCamera(i),this.SetPMIIds(n),this.SetNoteIds(o),this.SetSectionPlaneIDList(a),this.setInstanceAttributeMap(s),this.SetViewType(r),this.SetUpDataCamera(!0),this.SetUpDataModel(!0)},g.prototype.getExplosiveType=function(){return this.m_ExplosiveType},g.prototype.setExplosiveType=function(e){this.m_ExplosiveType=e},g.prototype.setExplosivePercent=function(e){this.m_ExplosivePercent=e},g.prototype.getExplosivePercent=function(){return this.m_ExplosivePercent},g.prototype.SetSectionPlaneDirection=function(e){this.m_Direction=e},g.prototype.GetSectionPlaneDirection=function(){return this.m_Direction},g.prototype.SetSectionPlaneDirectionAndPercentage=function(e,t,r,i,n,o){this.m_DirectionX=e,this.m_DirectionY=t,this.m_DirectionZ=r,this.m_PercentageX=i,this.m_PercentageY=n,this.m_PercentageZ=o},g.prototype.SetSectionPlanePercentage=function(e){this.m_Percentage=e},g.prototype.GetSectionPlanePercentage=function(){return this.m_Percentage},g.prototype.SetShowSectionCappingPlane=function(e){this.m_ShowCappingPlane=e},g.prototype.SetReverseClipping=function(e){this.m_ReverseClipping=e},g.prototype.IsReverseClipping=function(){return this.m_ReverseClipping},g.prototype.SetShowClipSectionPlane=function(e){this.m_ShowClipPlane=e},g.prototype.GetShowClipSectionPlane=function(){return this.m_ShowClipPlane},g.prototype.SetID=function(e){this.ID=e},g.prototype.SetViewType=function(e){this.ViewType=e},g.prototype.GetViewType=function(){return this.ViewType},g.prototype.AddSectionPlaneId=function(e){for(var t=!1,r=0;r<this.SectionPlaneIDList.length;r++){if(this.SectionPlaneIDList[r]==e){t=!0;break}}t||this.SectionPlaneIDList.push(e)},g.prototype.ClearSectionPlaneId=function(){this.SectionPlaneIDList=[]},g.prototype.GetNoteList=function(){return this.NoteList},g.prototype.GetNotes=function(){return this.NoteList},g.prototype.GetMeasures=function(){return this.NoteList},g.prototype.GetUpDataModelState=function(){return this.UpDataModel},g.prototype.SetUpDataModel=function(e){this.UpDataModel=e},g.prototype.GetUpDataCameraState=function(){return this.UpDataCamera},g.prototype.SetUpDataCamera=function(e){this.UpDataCamera=e},g.prototype.GetPMIList=function(){return this.PMIList},g.prototype.GetPMIs=function(){return this.PMIList},g.prototype.GetSectionPlaneIDList=function(){return this.SectionPlaneIDList},g.prototype.GetClips=function(){return this.SectionPlaneIDList},g.prototype.SetSectionPlaneIDList=function(e){this.SectionPlaneIDList=e},g.prototype.GetCamera=function(){return this.Camera},g.prototype.GetName=function(){return this.Name},g.prototype.GetID=function(){return this.ID},g.prototype.AddNoteId=function(e){this.NoteList.push(e)},g.prototype.SetNoteIds=function(e){this.NoteList=e},g.prototype.AddPMIId=function(e){this.PMIList.push(e)},g.prototype.SetPMIIds=function(e){this.PMIList=e},g.prototype.SetCamera=function(e){this.Camera=e},g.prototype.SetName=function(e){this.Name=e},g.prototype.GetProperty=function(e){return this.appendInfo.Get(e)},g.prototype.SetProperty=function(e,t){this.appendInfo.Put(e,t)},g.prototype.ClearProperties=function(){this.appendInfo.Clear()},g.prototype.DeleteProperty=function(e){return this.appendInfo.Remove(e)},g.prototype.GetNoteDataList=function(e){if(null===this.noteDataList.Get(e)){this.noteDataList.Put(e,[])}return this.noteDataList.Get(e)},g.prototype.ClearNoteDataList=function(){this.noteDataList.Clear()},g.prototype.SetNoteDataList=function(e,t){this.noteDataList.Put(e,t)},g.prototype.SetGestureNotePolyLineColors=function(e){this.PLineColors=e},g.prototype.GetGestureNotePolyLineColors=function(){return this.PLineColors},g.prototype.GetInstanceAttributeMap=function(){return this.InstanceAttributeMap},g.prototype.setInstanceAttributeMap=function(e){this.InstanceAttributeMap=e},g.prototype.ProcessXMLData=function(e){e.getElementsByTagName("Views")},g.CreateByXml=function(e){var t=(new DOMParser).parseFromString(e,"application/xml");return SView.ViewManager.GetInstance().GetModleViewByXmlStr(t.documentElement)},g.prototype.ToXml=function(){return'<View ID="'+this.GetID()+'" Name="'+this.GetName()+'" Type="'+this.GetViewType()+'"> <Camera '+this.GetCamera().toString()+'/> <BackgroundColor/><Notes><GestureNote ID= "0" Created= "" UserID= "1" Layer= "0" > <ProjectMatrix/> <Polylines /> </GestureNote> </Notes>  <PMIs/>  <SectionPlanes/><Instances></Instances></View>'},g.prototype.ToJson=function(){var e="{";e+='"id":'+this.GetID()+',"name":"'+this.GetName()+'","usageType":'+this.GetViewType()+',"isActivated":false,"isDefault":false,"transparency":1.0,';var t=this.GetCamera();if(t){e+='"camera":{"projectType":'+t.GetOrthographic()+',"angle":1.0,"matix":"';var r=new v.Matrix4(t.GetRotation().RotationMatrix().Inverse());r.data[12]=t.GetPosition().x,r.data[13]=t.GetPosition().y,r.data[14]=t.GetPosition().z;for(var i=r.data,n=0;n<i.length;n++)e+=i[n].toFixed(8),n<i.length-1?e+=" ":e+='"';e+="},"}var o=this.GetInstanceAttributeMap();e+='"insAttributes":{';for(n=0;n<o.Keys().length;n++){var a=o.Keys()[n],s=o.Values()[n];e+='"'+v.PathHelper.SVLPathHexToDec(s.path)+'":{"plcPath":'+a+',"visible":'+(s.visible?0:1)+',"matix":"'+s.placeMatrix.Tostring()+'"',s.hasColor?e+=',"color":"'+s.insColor.Tostring()+'"}':e+=',"color":"-1.00000000 -1.00000000 -1.000000000 -1.00000000"}',n<o.Keys().length-1&&(e+=",")}return e+="}}"},g.FromJson=function(e){var t=[],r=JSON.parse(JSON.parse(JSON.stringify(e)));if(r){if(r.version)r.version;var i=new Array;if(r.model_views)i=r.model_views[0].views;var n=r.views;if(n)for(var o=0;o<n.length;o++){var a=n[o];if(!(i.indexOf(a.id)<0)){var s=this.parseOneModelView(a);if(r.view_pmis)for(var l=r.view_pmis,h=0;h<l.length;h++){if(l[h].id)if(l[h].id===s.GetID())for(var u=0;u<l[h].pmis.length;u++)s.AddPMIId(l[h].pmis[u])}if(r.view_notes){var p=r.view_notes;for(h=0;h<p.length;h++){if(p[h].id)if(p[h].id===s.GetID())for(u=0;u<p[h].notes.length;u++)s.AddNoteId(p[h].notes[u])}}if(r.view_sections){var c=r.view_sections;for(h=0;h<c.length;h++){if(c[h].id)if(c[h].id===s.GetID())for(u=0;u<c[h].sections.length;u++)s.AddSectionPlaneId(c[h].sections[u])}}t.push(s)}}return t}},g.parseOneModelView=function(e){var t=new g;t.SetID(e.id),t.SetName(e.name),t.SetViewType(e.usageType);var r=e.camera;if(r){var i=new v.Camera;if(i.SetOrthographic("1"==r.projectType),r.angle){var n=r.angle;i.SetFov(n)}if(r.matix){var o=new v.Matrix4;o.fromString(r.matix);var a=new v.Quaternion,s=new v.Matrix3(o.data[0],o.data[4],o.data[8],o.data[1],o.data[5],o.data[9],o.data[2],o.data[6],o.data[10]);a.FromRotationMatrix(s),i.SetPosition(new v.Vector3(o.data[12],o.data[13],o.data[14])),i.SetRotation(a)}var l=1;r.aspectRatio&&(l=r.aspectRatio),i.SetAspectRatio(l),r.nearDistance&&i.SetNearClip(r.nearDistance),r.farDistance&&i.SetFarClip(r.farDistance),r.focalDistance,r.height&&i.IsOrthographic()&&i.SetOrthoSize(new v.Vector2(r.height*l,r.height)),i.SetZoom(1),t.SetCamera(i),t.SetUpDataCamera(!0)}var h=e.insAttributes;for(var u in h){var p=h[u],c=p.matix,d=new v.InstanceAttribute;d.id=p.plcPath;var S=p.visible;if(d.visible=0===S,d.path=v.PathHelper.SVLPathDecToHex(u),c){var f=void 0,m=c.split(" ");if(16==m.length?f=new v.Matrix4:12==m.length&&(f=new v.Matrix3x4),f.fromString(c),f.Equals(v.Matrix4.ZERO().Clone()))continue;d.placeMatrix=f}var y=p.color;if(y){var T=y.split(" ");d.hasColor=!0;var M=new v.Color(Number(T[0]),Number(T[1]),Number(T[2]),Number(T[3]));d.insColor=M.Clone()}t.GetInstanceAttributeMap().Put(Number(p.plcPath),d)}return t},g.Create=function(){var e=(new Date).toISOString(),t=new g;return t.SetName(e),t.SetViewType(2),t},g.prototype.GetModels=function(){for(var e=this.GetInstanceAttributeMap(),t=[],r=0;r<e.Keys().length;r++){var i=e.Values()[r];t.push(i.path)}return t},g.MaxId=1e3,g}();v.ModleView=r,(e=v.StkViewUsageEnum||(v.StkViewUsageEnum={}))[e.VIEW_USAGE_UNKNOWN=0]="VIEW_USAGE_UNKNOWN",e[e.VIEW_USAGE_GENERAL_VIEW=1]="VIEW_USAGE_GENERAL_VIEW",e[e.VIEW_USAGE_SV_BASE_VIEW=2]="VIEW_USAGE_SV_BASE_VIEW",e[e.VIEW_USAGE_SV_USER_VIEW=3]="VIEW_USAGE_SV_USER_VIEW",e[e.VIEW_USAGE_SV_USER_CLIPVIEW=4]="VIEW_USAGE_SV_USER_CLIPVIEW",e[e.VIEW_USAGE_SV_OTHER_VIEW=5]="VIEW_USAGE_SV_OTHER_VIEW",e[e.VIEW_USAGE_PROE_BASE_VIEW=6]="VIEW_USAGE_PROE_BASE_VIEW",e[e.VIEW_USAGE_PROE_USER_VIEW=7]="VIEW_USAGE_PROE_USER_VIEW",e[e.VIEW_USAGE_DEFAULT_VIEW=8]="VIEW_USAGE_DEFAULT_VIEW",e[e.VIEW_USAGE_USER_CLIPPLANE=9]="VIEW_USAGE_USER_CLIPPLANE",(t=v.ViewTypeEnum||(v.ViewTypeEnum={}))[t.Undefine=-1]="Undefine",t[t.DefaultView=0]="DefaultView",t[t.OrignalView=1]="OrignalView",t[t.UserView=2]="UserView"}(M3D||(M3D={})),function(e){var t=function(){function e(){this.anchorY=-1,this.m_firstShape=0,this.m_secondShape=0,this.m_firstAnchorX=0,this.m_firsteAnchorY=0,this.m_secondAnchorX=0,this.m_secondAnchorY=0,this.m_thirdAnchorX=0,this.m_thirdAnchorY=0,this.m_annotationObj=null,this.m_fristAnChorShape=0,this.m_secondAnChorShape=0,this.m_annotationType=e.ANNOTATION_TYPE_BASE,this.m_nativeNote=null,this.m_annotationObj=null}return e.prototype.SetView=function(e){this.m_viewer=e},e.prototype.SetGUID=function(e){this.m_guid=e},e.prototype.GetGUID=function(){return this.m_guid},e.prototype.SetAuthor=function(e){this.m_author=e},e.prototype.GetAuthor=function(){return this.m_author},e.prototype.GetAnchorX=function(){return this.anchorX},e.prototype.SetAnchorX=function(e){this.anchorX=e},e.prototype.GetAnchorY=function(){return this.anchorY},e.prototype.SetAnchorY=function(e){this.anchorY=e},e.prototype.Init=function(){this.m_author="",this.SetGUID(M3D.IDCreator.GetUUID()),this.SetType(M3D.ShapeType.SHAPE_NOTE_BASE)},e.prototype.CreatePoint=function(e,t){return M3D.AnnotationFactory.CreateTmpPoint(e,t,this.m_viewer.GetSceneManager())},e.prototype.GetAnnotationPos=function(){var e=new M3D.Vector3;if(this.m_annotationObj){var t=this.m_annotationObj.GetAnnotationPos();e=new M3D.Vector3(t.x,t.y,t.z)}return e},e.prototype.SetAnnotationPos=function(e){if(this.m_annotationObj){var t=new M3D.Vector3(e.x,e.y,e.z);this.m_annotationObj.SetAnnotationPos(t)}},e.prototype.GetBroadPos=function(){var e=new M3D.Vector2;if(this.m_annotationObj){var t=this.m_annotationObj.GetBroadPos();e=new M3D.Vector2(t.x,t.y)}return e},e.prototype.SetBroadPos=function(e){if(this.m_annotationObj){var t=new M3D.Vector2(e.x,e.y);this.m_annotationObj.SetBroadPos(t)}},e.prototype.GetCenterPos=function(){var e=new M3D.Vector3;if(this.m_annotationObj){var t=this.m_annotationObj.GetCenterPos();e=new M3D.Vector3(t.x,t.y,t.z)}return e},e.prototype.SetCenterPos=function(e){if(this.m_annotationObj){var t=new M3D.Vector3(e.x,e.y,e.z);this.m_annotationObj.SetCenterPos(t)}},e.prototype.SetGap=function(e){if(this.m_annotationObj){var t=M3D.AnnotationFactory.calculateGap(this.m_annotationObj,e,this.m_viewer.GetSceneManager());this.m_annotationObj.SetGap(t)}},e.prototype.SetID=function(e){null!=this.m_annotationObj&&this.m_annotationObj.SetID(e)},e.prototype.CreateObject=function(){this.m_annotationObj||(this.m_annotationObj=new M3D.Annotation,this.GetAnnotationType()===e.ANNOTATION_TYPE_TEXT?this.m_annotationObj.SetType(M3D.ShapeType.SHAPE_TEXT_NOTE):this.GetAnnotationType()===e.ANNOTATION_TYPE_ORDER?this.m_annotationObj.SetType(M3D.ShapeType.SHAPE_SEQUENCE_NUMBER_NOTE):this.GetAnnotationType()===e.ANNOTATION_TYPE_COMPONENTNAME&&this.m_annotationObj.SetType(M3D.ShapeType.SHAPE_COMPONENTNAME_NOTE)),this.m_nativeNote=this.m_annotationObj},e.prototype.ModifyObject=function(){var e,t=this.m_noteText,r=new M3D.Color(this.m_frameColor.r,this.m_frameColor.g,this.m_frameColor.b,this.m_frameColor.a),i=new M3D.Color(this.m_fillColor.r,this.m_fillColor.g,this.m_fillColor.b,this.m_fillColor.a);return(e=M3D.AnnotationFactory.CreateAnnotation(this.m_annotationObj,t,r,i,this.m_bLenderLine,this.m_bEnvelope,this.m_bStub,this.m_bFixed,this.m_viewer.GetSceneManager()))&&(this.m_nativeNote=this.m_annotationObj),e},e.prototype.ModifyInfo=function(){var e=this.m_noteText,t=new M3D.Color(this.m_frameColor.r,this.m_frameColor.g,this.m_frameColor.b,this.m_frameColor.a),r=new M3D.Color(this.m_fillColor.r,this.m_fillColor.g,this.m_fillColor.b,this.m_fillColor.a);return M3D.AnnotationFactory.CreateAnnotation(this.m_annotationObj,e,t,r,this.m_viewer.GetSceneManager())},e.prototype.CreateFirstPoint=function(){var e=new M3D.Vector2(this.m_firstAnchorX,this.m_firsteAnchorY);return this.m_fristAnChorShape=this.CreatePoint(e,this.m_firstShape),this.m_fristAnChorShape},e.prototype.CreateSecondPoint=function(){var e=new M3D.Vector2(this.m_secondAnchorX,this.m_secondAnchorY);return this.m_secondAnChorShape=this.CreatePoint(e,0),!0},e.prototype.Create=function(){var e=!1,t=this.m_firstShape,r=(this.m_secondShape,new M3D.Vector2(this.m_firstAnchorX,this.m_firsteAnchorY)),i=new M3D.Vector2(this.m_secondAnchorX,this.m_secondAnchorY),n=(new M3D.Vector2(this.m_thirdAnchorX,this.m_thirdAnchorY),this.m_noteText),o=new M3D.Color(this.m_frameColor.r,this.m_frameColor.g,this.m_frameColor.b,this.m_frameColor.a),a=new M3D.Color(this.m_fillColor.r,this.m_fillColor.g,this.m_fillColor.b,this.m_fillColor.a);return this.m_annotationObj=M3D.AnnotationFactory.CreateAnnotation(t,r,i,n,o,a,this.m_bLenderLine,this.m_bEnvelope,this.m_bStub,this.m_bFixed,this.m_viewer.GetSceneManager(),M3D.ShapeType.SHAPE_ANNOTATION_NOTE),this.m_annotationObj&&(this.m_nativeNote=this.m_annotationObj,e=!0,this.ClearTmpPoint()),e},e.prototype.Delete=function(){var e=this.GetID();return 0<e&&(this.m_nativeNote&&(this.m_nativeNote=null),this.m_viewer.RemoveShape(e)),!0},e.prototype.Clear=function(){var e=this.GetID();return 0<e&&(this.m_nativeNote&&(this.m_nativeNote=null),this.m_viewer.RemoveShape(e)),!1},e.prototype.GetID=function(){return null!=this.m_nativeNote?this.m_nativeNote.GetID():0},e.prototype.GetName=function(){return""},e.prototype.SetName=function(e){},e.prototype.GetPropertyByKey=function(e){return null},e.prototype.Visible=function(){return!!this.m_nativeNote&&this.m_nativeNote.IsVisible()},e.prototype.SetVisible=function(e){this.m_nativeNote&&this.m_nativeNote.SetVisible(e)},e.prototype.GetColor=function(){return null},e.prototype.SetColor=function(e){},e.prototype.SetAlpha=function(e){},e.prototype.ResetAlpha=function(){},e.prototype.RestoreColor=function(){},e.prototype.RestoreAlpha=function(){},e.prototype.Restore=function(){},e.prototype.SetSelected=function(e){this.m_nativeNote&&this.m_nativeNote.SetSelected(e)},e.prototype.IsSelected=function(){return!!this.m_nativeNote&&this.m_nativeNote.IsSelected()},e.prototype.GetSVLPath=function(){return null},e.prototype.GetChildren=function(){return null},e.prototype.GetSVLId=function(){return-1},e.prototype.GetNoteObj=function(){return this.m_nativeNote},e.prototype.SetNativeNoteObj=function(e){this.m_nativeNote=e},e.prototype.ClearTmpPoint=function(){0<this.m_fristAnChorShape&&this.m_viewer.RemoveShape(this.m_fristAnChorShape),0<this.m_secondAnChorShape&&this.m_viewer.RemoveShape(this.m_secondAnChorShape),0<this.m_firstShape&&this.m_viewer.RemoveShape(this.m_firstShape)},e.prototype.GetHaveLenderLine=function(){return this.m_annotationObj&&(this.m_bLenderLine=this.m_annotationObj.GetHaveLeaderLine()),this.m_bLenderLine},e.prototype.SetHaveLenderLine=function(e){this.m_annotationObj&&this.m_annotationObj.SetHaveLeaderLine(e),this.m_bLenderLine=e},e.prototype.GetHaveEnvelope=function(){return this.m_annotationObj&&(this.m_bEnvelope=this.m_annotationObj.GetHaveEnvelope()),this.m_bEnvelope},e.prototype.SetHaveEnvelope=function(e){this.m_annotationObj&&this.m_annotationObj.SetHaveEnvelope(e),this.m_bEnvelope=e},e.prototype.GetHaveStub=function(){return this.m_annotationObj&&(this.m_bStub=this.m_annotationObj.GetHaveStub()),this.m_bStub},e.prototype.SetHaveStub=function(e){this.m_annotationObj&&this.m_annotationObj.SetHaveStub(e),this.m_bStub=e},e.prototype.GetFixed=function(){return this.m_annotationObj&&(this.m_bFixed=this.m_annotationObj.GetFixed()),this.m_bFixed},e.prototype.SetFixed=function(e){this.m_annotationObj&&this.m_annotationObj.SetFixed(e),this.m_bFixed=e},e.prototype.GetFrameColor=function(){var e=new M3D.Color;if(this.m_annotationObj){var t=this.m_annotationObj.GetFrameColor();e=new M3D.Color(t.r,t.g,t.b,t.a)}return this.m_frameColor=e,this.m_frameColor},e.prototype.SetFrameColor=function(e){if(this.m_frameColor=e,this.m_annotationObj){var t=new M3D.Color(e.r,e.g,e.b,e.a);this.m_annotationObj.SetFrameColor(t)}},e.prototype.GetFillColor=function(){var e=new M3D.Color;if(this.m_annotationObj){var t=this.m_annotationObj.GetFillColor();e=new M3D.Color(t.r,t.g,t.b,t.a)}return this.m_fillColor=e,this.m_fillColor},e.prototype.SetFillColor=function(e){if(this.m_fillColor=e,this.m_annotationObj){var t=new M3D.Color(e.r,e.g,e.b,e.a);this.m_annotationObj.SetFillColor(t)}},e.prototype.GetFirstAnchorX=function(){return this.m_firstAnchorX},e.prototype.SetFirstAnchorX=function(e){this.m_firstAnchorX=e},e.prototype.GetFirstAnchorY=function(){return this.m_firsteAnchorY},e.prototype.SetFirstAnchorY=function(e){this.m_firsteAnchorY=e},e.prototype.GetSecondAnchorX=function(){return this.m_secondAnchorX},e.prototype.SetSecondAnchorX=function(e){this.m_secondAnchorX=e},e.prototype.GetSecondAnchorY=function(){return this.m_secondAnchorY},e.prototype.SetSecondAnchorY=function(e){this.m_secondAnchorY=e},e.prototype.GetThirdAnchorX=function(){return this.m_thirdAnchorX},e.prototype.SetThirdAnchorX=function(e){this.m_thirdAnchorX=e},e.prototype.GetThirdAnchorY=function(){return this.m_thirdAnchorY},e.prototype.SetThirdAnchorY=function(e){this.m_thirdAnchorY=e},e.prototype.GetText=function(){return this.m_noteText},e.prototype.SetText=function(e){this.m_noteText=e},e.prototype.GetAnnotationType=function(){return this.m_annotationType},e.prototype.SetAnnotationType=function(e){this.m_annotationType=e},e.prototype.UpdateImagePos=function(e,t){this.m_viewer&&this.m_viewer.UpdateAnnotationImagePos(this,e,t)},e.prototype.GetCreateID=function(){return this.m_nativeNote?this.m_nativeNote.GetCreateID():0},e.prototype.SetCreateID=function(e){this.m_nativeNote&&this.m_nativeNote.SetCreateID(e)},e.prototype.SetNativeAnnotationObj=function(e){this.m_annotationObj=e},e.prototype.GetAnnotationObj=function(){return this.m_annotationObj},e.prototype.SetType=function(e){this.type=e},e.prototype.GetType=function(){return this.type},e.ANNOTATION_TYPE_BASE=0,e.ANNOTATION_TYPE_TEXT=3,e.ANNOTATION_TYPE_COMPONENTNAME=1,e.ANNOTATION_TYPE_ORDER=2,e.ANNOTATION_TYPE_SHOTSPOT=2,e.ANNOTATION_TYPE_AUDIO=1001,e.ANNOTATION_TYPE_GESTURE=1002,e}();e.SAnnotation=t}(SView||(SView={})),function(l){var e=function(t){function e(){var e=t.call(this)||this;return e.firstShape=0,e.textString="",e.Init(),e}return __extends(e,t),e.prototype.Create=function(){var e=!1,t=null,r=this.GetAnnotationType(),i=this.firstShape,n=new M3D.Vector2(this.GetFirstAnchorX(),this.GetFirstAnchorY()),o=this.GetAnchorX(),a=this.GetAnchorY(),s=new M3D.Vector2(o,a);return r==l.SAnnotation.ANNOTATION_TYPE_COMPONENTNAME&&(t=M3D.AnnotationFactory.CreateAnnotation(i,n,s,this.GetTextString(),M3D.Color.BLACK(),M3D.Color.WHITE(),!0,!0,!0,!1,this.m_viewer.GetSceneManager(),M3D.ShapeType.SHAPE_COMPONENTNAME_NOTE)),t&&(this.m_nativeNote=t,e=!0),e},e.prototype.Init=function(){this.SetAnnotationType(M3D.ShapeType.SHAPE_COMPONENTNAME_NOTE)},e.prototype.GetFirstShape=function(){return this.firstShape},e.prototype.SetFirstShape=function(e){this.firstShape=e},e.prototype.Delete=function(){return 0<this.GetID()&&(this.m_viewer.RemoveShape(this.GetID()),!0),!1},e.prototype.SetTextString=function(e){this.textString=e},e.prototype.GetTextString=function(){return this.textString},e.prototype.Clear=function(){return!1},e}(l.SAnnotation);l.SAnnotationComponent=e}(SView||(SView={})),function(l){var e=function(t){function e(){var e=t.call(this)||this;return e.firstShape=0,e.textString="",e.Init(),e}return __extends(e,t),e.prototype.Create=function(){var e=!1,t=null,r=this.GetAnnotationType(),i=this.firstShape,n=new M3D.Vector2(this.GetFirstAnchorX(),this.GetFirstAnchorY()),o=this.GetAnchorX(),a=this.GetAnchorY(),s=new M3D.Vector2(o,a);return r==l.SAnnotation.ANNOTATION_TYPE_TEXT&&(t=M3D.AnnotationFactory.CreateAnnotation(i,n,s,this.GetTextString(),M3D.Color.BLACK(),M3D.Color.WHITE(),!0,!0,!0,!1,this.m_viewer.GetSceneManager(),M3D.ShapeType.SHAPE_TEXT_NOTE)),t&&(this.m_nativeNote=t,e=!0),e},e.prototype.Init=function(){this.SetType(M3D.ShapeType.SHAPE_ANNOTATION_NOTE)},e.prototype.GetFirstShape=function(){return this.firstShape},e.prototype.SetFirstShape=function(e){this.firstShape=e},e.prototype.Delete=function(){return 0<this.GetID()&&(this.m_viewer.RemoveShape(this.GetID()),!0),!1},e.prototype.SetTextString=function(e){this.textString=e},e.prototype.GetTextString=function(){return this.textString},e.prototype.Clear=function(){return!1},e.CreateFromXML=function(e,t){var r=null;if(null!=e&&0!=e.length){r=new l.STextNote;var i=M3D.NoteFactory.CreateTextNoteFromXMLElement(t.view.GetSceneManager(),t.ParseXmlString(e));if(i){r.SetView(t.view),r.SetNativeNoteObj(i);i.GetID()}return r}},e}(l.SAnnotation);l.SAnnotationText=e}(SView||(SView={})),function(l){var e=function(t){function e(){var e=t.call(this)||this;return e.firstShape=0,e.textString="",e.Init(),e}return __extends(e,t),e.prototype.Create=function(){var e=!1,t=null,r=this.GetAnnotationType(),i=this.firstShape,n=new M3D.Vector2(this.GetFirstAnchorX(),this.GetFirstAnchorY()),o=this.GetAnchorX(),a=this.GetAnchorY(),s=new M3D.Vector2(o,a);return r==l.SAnnotation.ANNOTATION_TYPE_ORDER&&(t=M3D.AnnotationFactory.CreateAnnotation(i,n,s,this.GetText(),M3D.Color.BLACK(),M3D.Color.WHITE(),!0,!0,!0,!1,this.m_viewer.GetSceneManager(),M3D.ShapeType.SHAPE_SEQUENCE_NUMBER_NOTE)),t&&(this.m_nativeNote=t,e=!0),e},e.prototype.Init=function(){this.SetAnnotationType(M3D.ShapeType.SHAPE_SEQUENCE_NUMBER_NOTE)},e.prototype.GetFirstShape=function(){return this.firstShape},e.prototype.SetFirstShape=function(e){this.firstShape=e},e.prototype.Delete=function(){return 0<this.GetID()&&(this.m_viewer.RemoveShape(this.GetID()),!0),!1},e.prototype.SetTextString=function(e){this.textString=e},e.prototype.GetTextString=function(){return this.textString},e.prototype.Clear=function(){return!1},e}(l.SAnnotation);l.SAnnotationNumber=e}(SView||(SView={})),function(e){var t=function(){function e(){this.HudModels=new Array}return e.Instance=function(){return null==e.instance&&(e.instance=new e),e.instance},e.prototype.RemoveAllHuds=function(){this.HudModels.splice(0,this.HudModels.length)},e.prototype.RemoveHud=function(e){0<=this.HudModels.indexOf(e)&&(this.sview.GetNativeShapeManager().RemoveShape(e.GetID()),this.HudModels.splice(this.HudModels.indexOf(e),1))},e.prototype.BindBoxDragger=function(e,t){},e.prototype.UnBindBoxDragger=function(){},e.prototype.AddHud=function(e){this.HudModels.indexOf(e)<0&&(this.sview.GetNativeShapeManager().AddShape(e.GetID(),e),this.HudModels.push(e))},e.prototype.getSView=function(){return this.sview},e.prototype.setSView=function(e){this.sview=e},e.prototype.getHudModels=function(){return this.HudModels},e.prototype.setHudModels=function(e){this.HudModels=e},e.instance=null,e}();e.ScreenUILayerManager=t}(SView||(SView={})),function(e){var t=function(){function e(e){this.sviewControl=null,this.measures=[],this.sviewControl=e}return e.prototype.RemoveLastMeasure=function(e){for(var t=this.measures.length-1;0<=t;t--){var r=this.measures[t];if(e.indexOf(r.GetMeasureType())){var i=r.GetID();r.Delete(),this.sviewControl.GetNativeShapeManager().RemoveShape(i),r.GetMeasureObj()?this.sviewControl.GetSelector().Remove(r.GetMeasureObj()):this.sviewControl.GetSelector().Remove(r.GetNoteObj()),this.Remove(r);break}}return!1},e.prototype.Add=function(e){var t=!1;return null!==e&&-1===this.measures.indexOf(e)&&(this.measures.push(e),t=!0),t},e.prototype.Remove=function(e){var t=!1,r=this.measures.indexOf(e);if(null!==e&&-1!==r){var i=e.GetID();this.sviewControl.GetNativeShapeManager().RemoveShape(i),e.GetMeasureObj()?this.sviewControl.GetSelector().Remove(e.GetMeasureObj()):this.sviewControl.GetSelector().Remove(e.GetNoteObj()),this.measures.splice(r,1),e.Delete(),t=!0}return t},e.prototype.Clear=function(){this.sviewControl.GetSelector().Clear();for(var e=0,t=this.measures;e<t.length;e++){var r=t[e],i=r.GetID();this.sviewControl.GetNativeShapeManager().RemoveShape(i),r.GetMeasureObj()?this.sviewControl.GetSelector().Remove(r.GetMeasureObj()):this.sviewControl.GetSelector().Remove(r.GetNoteObj()),r.Delete()}return this.measures.length=0,!1},e.prototype.GetMeasures=function(e,t){var r=[];if(null!=e)for(var i=0,n=this.measures;i<n.length;i++){(s=n[i]).GetMeasureType()==e&&r.push(s)}else for(var o=0,a=this.measures;o<a.length;o++){var s=a[o];0<t.indexOf(s.GetMeasureType())&&r.push(s)}return r},e.prototype.RemoveMeasuresByType=function(e){for(var t=!1,r=[],i=0,n=this.measures;i<n.length;i++){var o=n[i];e.indexOf(o.GetMeasureType())&&r.push(o)}if(0<r.length){for(var a=0,s=this.measures;a<s.length;a++){o=s[a];this.Remove(o)}t=!0}return t},e.prototype.GetMeasureByGUId=function(e){return null},e.prototype.GetMeasureById=function(e){for(var t=null,r=0,i=this.measures;r<i.length;r++){var n=i[r];if(n.GetID()==e){t=n;break}}return t},e.prototype.GetsView=function(){return this.sviewControl},e.prototype.SetsView=function(e){this.sviewControl=e},e}();e.MeasureManager=t}(SView||(SView={})),function(l){var e=function(){function e(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this.sviewControl=null,this.annotations=[],1===e.length&&(this.sviewControl=e[0])}return e.prototype.Add=function(e){var t=!1;return null!=e&&-1===this.annotations.indexOf(e)&&(this.annotations.push(e),t=!0),t},e.prototype.Remove=function(e){var t=!1;return null!=e&&-1!==this.annotations.indexOf(e)&&(this.annotations.splice(this.annotations.indexOf(e),1),t=!0),this.sviewControl.GetNativeShapeManager().RemoveShape(e.GetID()),this.GetsView().GetView().RemoveShape(e.GetID()),t},e.prototype.Clear=function(){this.sviewControl.GetSelector().Clear();for(var e=0,t=this.annotations;e<t.length;e++){var r=t[e],i=r.GetID();this.sviewControl.GetNativeShapeManager().RemoveShape(i),r.GetAnnotationObj()?this.sviewControl.GetSelector().Remove(r.GetAnnotationObj()):this.sviewControl.GetSelector().Remove(r.GetNoteObj()),r.Delete()}return this.annotations.length=0,!1},e.prototype.GetAnnotations=function(){return this.annotations},e.prototype.GetsView=function(){return this.sviewControl},e.prototype.SetsView=function(e){this.sviewControl=e},e.prototype.GetAll=function(e){var t=[];if(!e){for(var r=this.GetAnnotations(),i=0;i<r.length;i++)t.push(r[i].GetAnnotationObj());return t}},e.prototype.FromJson=function(e){var t=JSON.parse(JSON.parse(JSON.stringify(e))),r=new l.SAnnotation;null==t.type?r.SetAnnotationType(l.SAnnotation.ANNOTATION_TYPE_BASE):"0"==t.type?(r=new l.SAnnotationText).SetAnnotationType(l.SAnnotation.ANNOTATION_TYPE_TEXT):"1"==t.type?(r=new l.SAnnotation).SetAnnotationType(t.type):"2"==t.type&&(r=new l.SAnnotationNumber).SetAnnotationType(t.type),r.CreateObject(),r.SetView(this.GetsView().GetView()),r.SetCreateID(t.createID),r.SetText(t.text),r.SetHaveLenderLine(t.leaderLine),r.SetHaveEnvelope(t.envelope),r.SetHaveStub(t.stub),r.SetFixed(t.fixed);var i=new M3D.Color;i.r=t.frameColor[0],i.g=t.frameColor[1],i.b=t.frameColor[2],i.a=t.frameColor[3],r.SetFrameColor(i);var n=new M3D.Color;n.r=t.fillColor[0],n.g=t.fillColor[1],n.b=t.fillColor[2],n.a=t.fillColor[3],r.SetFillColor(n);var o=new M3D.Vector3;o.x=t.annotationPos[0],o.y=t.annotationPos[1],o.z=t.annotationPos[2],r.SetAnnotationPos(o);var a=new M3D.Vector3;if(a.x=t.centerPos[0],a.y=t.centerPos[1],a.z=t.centerPos[2],r.SetCenterPos(a),r.GetFixed()){var s=new M3D.Vector2;t.broadPos?(s.x=t.broadPos[0],s.y=t.broadPos[1],r.SetBroadPos(s)):r.SetFixed(!1)}r.ModifyObject()&&this.GetsView().GetView().GetSAnnotationManager().Add(r)},e.prototype.ToJson=function(e){for(var t='{"annotations":[',r=0;r<e.length;r++){var i=e[r];t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=t+'{"createID":'+i.GetCreateID()+",")+'"type":'+i.GetType()+",")+'"text":"'+i.getText()+'",')+'"leaderLine":'+i.GetHaveLeaderLine()+",")+'"envelope":'+i.GetHaveEnvelope()+",")+'"stub":'+i.GetHaveStub()+",")+'"fixed":'+i.GetFixed()+",")+'"frameColor":['+i.GetFrameColor().r+","+i.GetFrameColor().g+","+i.GetFrameColor().b+","+i.GetFrameColor().a+"],")+'"fillColor":['+i.GetFillColor().r+","+i.GetFillColor().g+","+i.GetFillColor().b+","+i.GetFillColor().a+"],")+'"annotationPos":['+i.GetAnnotationPos().x+","+i.GetAnnotationPos().y+","+i.GetAnnotationPos().z+"],")+'"centerPos":['+i.GetCenterPos().x+","+i.GetCenterPos().y+","+i.GetCenterPos().z+"]},"}return t=t.substring(0,t.length-1),t+="]}"},e.prototype.EditAnnotation=function(e,t){M3D.AnnotationFactory.UpdateAnnotationTextValue(e,t,this.sviewControl.view.GetSceneManager())},e}();l.SAnnotations=e}(SView||(SView={})),function(e){var t=function(){function e(){this.nativeShapeCache=new M3D.Map}return e.prototype.Clear=function(){this.nativeShapeCache.Clear()},e.prototype.GetShape=function(e){return this.nativeShapeCache.ContainKey(e)?this.nativeShapeCache.Get(e):null},e.prototype.AddShape=function(e,t){null===t||this.nativeShapeCache.ContainKey(e)||this.nativeShapeCache.Put(e,t)},e.prototype.RemoveShape=function(e){this.nativeShapeCache.Remove(e)},e}();e.ShapeManager=t}(SView||(SView={})),function(r){var e=function(t){function e(){var e=t.call(this)||this;return e.Mark="",e.Mark="BaseGeoData",e}return __extends(e,t),e.prototype.GetType=function(){return r.ShapeType.VIRTUAL_GROUP},e.prototype.SetName=function(e){},e.prototype.SetID=function(e){this.m_id=e},e.prototype.GetID=function(){return this.m_id},e.prototype.SetParentID=function(e){this.m_parent_id=e},e.prototype.GetParentID=function(){return this.m_parent_id},e.prototype.IsVisible=function(){return this.m_bVisible},e.prototype.SetVisible=function(e){this.m_bVisible=e},e.prototype.IsSelected=function(){return this.m_bSelected},e.prototype.SetSelected=function(e){this.m_bSelected=e},e}(r.Shape);r.SBaseGeoData=e}(M3D||(M3D={})),function(o){var e=function(n){function e(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=n.call(this)||this;if(r.pointList=[],1===e.length){var i=e[0];r.pointList=[],r.m_type=o.ShapeType.SHAPE_SCANNINGBODY,r.m_size=2,r.m_dTolerance=1,r.m_pModel=i}return r}return __extends(e,n),e.prototype.SetName=function(e){if(null!=this.m_pModel){var t=String(e);return this.m_pModel.SetName(t)}this.m_name=e},e.prototype.GetName=function(){var e=null;return null!=this.m_pModel&&(e=String(this.m_pModel.GetName())),e},e.prototype.GetID=function(){if(null!=this.m_pModel)return this.m_pModel.GetID()},e.prototype.SetPathType=function(e){this.m_path_type=e},e.prototype.GetPathType=function(){return this.m_path_type},e.prototype.GetType=function(){return o.ShapeType.SHAPE_SCANNINGBODY},e.prototype.SetPipeRadius=function(e){this.m_size=e},e.prototype.GetPipeRadiu=function(){return this.m_size},e.prototype.SetPipeTolerance=function(e){this.m_dTolerance=e},e.prototype.GetPipeTolerance=function(){return this.m_dTolerance},e.prototype.addPoint=function(e){this.pointList.push(e)},e.prototype.removePoint=function(e){this.pointList.splice(this.pointList.indexOf(e),1)},e.prototype.RemovePoints=function(){this.pointList.length=0},e.prototype.addPoints=function(e){for(var t=0;t<e.length;t++)if(null!=e[t]){var r=e[t];null!=r&&this.pointList.push(r)}},e.prototype.GetPointList=function(){return this.pointList},e.prototype.SetParentID=function(e){this.m_parentID=e},e.prototype.GetParentID=function(){return this.m_parentID},e}(o.Model);o.ScanBody=e}(M3D||(M3D={})),function(l){var e=function(n){function e(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=n.call(this)||this;if(1===e.length){var i=e[0];r.Initialize(i)}else r.m_pCurve=null,r.Initialize(l.ShapeType.CURVE_POLYLINE);return r}return __extends(e,n),e.prototype.Initialize=function(e){if(!this.m_pCurve){switch(e){case l.ShapeType.CURVE_POLYLINE:this.m_pCurve=new l.SPolyLine;break;case l.ShapeType.CURVE_NURBSCURVE:this.m_pCurve=new l.NurbsCurve}this.SetVisible(!0)}},e.prototype.GetID=function(){if(this.m_pCurve)return this.m_pCurve.GetID()},e.prototype.SetName=function(e){if(this.m_pCurve){var t=String(e);this.m_pCurve.SetName(t)}},e.prototype.GetName=function(){var e=null;return null!=this.m_pCurve&&(e=this.m_pCurve.GetName()),e},e.prototype.SetType=function(e){this.Initialize(e)},e.prototype.GetType=function(){var e=l.ShapeType.CURVE_POLYLINE;this.m_pCurve&&(this.m_pCurve.GetType()==l.ShapeType.CURVE_NURBSCURVE&&(e=l.ShapeType.CURVE_NURBSCURVE));return e},e.prototype.AddPoint=function(e){if(null!=this.m_pCurve){var t=new l.Vector3(e.x,e.y,e.z);switch(this.m_pCurve.GetType()){case l.ShapeType.CURVE_POLYLINE:this.m_pCurve.AddPoints(t);break;case l.ShapeType.CURVE_NURBSCURVE:this.m_pCurve.AddPoint(t)}}},e.prototype.ClearPoints=function(){if(null!=this.m_pCurve)switch(this.m_pCurve.GetType()){case l.ShapeType.CURVE_POLYLINE:this.m_pCurve.ClearPolyLinePoint();break;case l.ShapeType.CURVE_NURBSCURVE:this.m_pCurve.ClearCurveControlPoint()}},e.prototype.GetPointList=function(){var e=[];if(this.m_pCurve){var t=[];switch(this.m_pCurve.GetType()){case l.ShapeType.CURVE_POLYLINE:t=this.m_pCurve.GetPoints();break;case l.ShapeType.CURVE_NURBSCURVE:t=this.m_pCurve.GetPoints()}for(var r=0;r<t.length;r++){var i=new l.Vector3(t[r].x,t[r].y,t[r].z);e.push(i)}}return e},e.prototype.SetColor=function(e){if(this.m_pCurve){var t=new l.Color(e.r,e.g,e.b,e.a);this.m_pCurve.SetColor(t)}},e.prototype.GetColor=function(){var e=new l.Color,t=this.m_pCurve.GetColor();return t&&e.SetColor(t.r,t.g,t.b,t.a),e},e.prototype.SetWidth=function(e){this.m_pCurve&&this.m_pCurve.SetWidth(e)},e.prototype.GetWidth=function(){var e=0;return this.m_pCurve&&(e=this.m_pCurve.GetWidth()),e},e.prototype.SetLineStyle=function(e){this.m_pCurve&&this.m_pCurve.SetLineStyle(e)},e.prototype.GetLineStyle=function(){var e=1;return this.m_pCurve&&(e=this.m_pCurve.GetLineStyle()),e},e.prototype.SetVisible=function(e){this.m_pCurve&&this.m_pCurve.SetVisible(e)},e.prototype.IsVisible=function(){var e=!1;return this.m_pCurve&&(e=this.m_pCurve.IsVisible()),e},e.prototype.SetSelected=function(e){this.m_pCurve&&this.m_pCurve.SetSelected(e)},e.prototype.IsSelected=function(){if(this.m_pCurve)return this.m_pCurve.IsSelected()},e.prototype.GetSVLId=function(){return this.m_pCurve?this.m_pCurve.GetSVLId():0},e.prototype.SetSetSelectable=function(e){if(this.m_pCurve)switch(this.m_pCurve.GetType()){case l.ShapeType.CURVE_POLYLINE:this.m_pCurve.SetSelectAble(e);break;case l.ShapeType.CURVE_NURBSCURVE:this.m_pCurve.SetSelectAble(e)}},e.prototype.Selectable=function(){return null!=this.m_pCurve&&this.m_pCurve.GetSelectAble()},e.prototype.SetShowPoint=function(e){this.m_pCurve&&this.m_pCurve.SetShowPoint(e)},e.prototype.MakeCurveLine=function(){if(null!=this.m_pCurve&&this.m_pCurve.GetType()==l.ShapeType.CURVE_NURBSCURVE){var e,t=this.m_pCurve,r=t.GetPoints();if(!((e=r.length)<=0||e<3)){for(var i=new l.Spline(l.InterpolationMode.CATMULL_ROM_FULL_CURVE),n=0;n<e;n++){var o=new l.Vector3(r[n].x,r[n].y,r[n].z);i.AddKnot(o)}t.ClearCurveLinePoint();for(var a=.001/e,s=0;s<=1;s+=a){o=i.GetPoint(s);t.AddCurvePoint(o)}}}},e.prototype.GetCurve=function(){return this.m_pCurve},e}(l.SBaseGeoData);l.SCurve=e}(M3D||(M3D={})),function(i){var e=function(t){function e(){var e=t.call(this)||this;return e.children=[],e.children=[],e.m_type=i.ShapeType.VIRTUAL_GROUP,e.Mark="BaseGeoGroup",t.prototype.SetVisible.call(e,!0),e}return __extends(e,t),e.prototype.GetName=function(){return this.m_name},e.prototype.getChildCount=function(){return this.children.length},e.prototype.getGroupCount=function(){for(var e=0,t=0;t<this.children.length;t++){var r=this.children[t];null!=r&&(r.GetType()==i.ShapeType.VIRTUAL_GROUP&&(e+=1))}return e},e.prototype.insertChildren=function(e,t){e<=this.children.length&&this.children.splice(e,0,t)},e.prototype.addChildren=function(e){this.children.push(e)},e.prototype.GetChildrenList=function(){return this.children},e.prototype.removeChildren=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(e[0]instanceof Number){for(var r=e[0],i=0;i<this.children.length;i++)if(null!=this.children[i]){var n=this.children[i];null!=n&&n.GetID()==r&&this.children.splice(this.children.indexOf(this.children[i]),1)}}else{var o=e[0];this.children.splice(this.children.indexOf(o),1)}},e.prototype.RemoveAll=function(){this.children.length=0},e}(i.SBaseGeoData);i.SGeoGroup=e}(M3D||(M3D={})),function(d){var e=function(c){function e(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=c.call(this)||this;if(1===e.length){var i=e[0],n=(i.GetName(),i.StartPoint),o=i.EndPoint,a=i.GetColor();r.m_startPoint=new d.Vector3(n.x,n.y,n.z),r.m_endPoint=new d.Vector3(o.x,o.y,o.z),a&&(r.m_color=new d.Color(a.r,a.g,a.b,a.a))}else if(4===e.length){var s=e[0],l=e[1],h=e[2];a=e[3];if(r.nativeLine=new d.Line3D,r.nativeLine){var u=s;r.nativeLine.SetName(u),r.nativeLine.SetType(d.ShapeType.CURVE_LINE);n=new d.Vector3(l.x,l.y,l.z),o=new d.Vector3(h.x,h.y,h.z);r.nativeLine.SetValue(n,o);var p=new d.Color(a.r,a.g,a.b,a.a);r.nativeLine.SetColor(p),r.m_startPoint=new d.Vector3(n.x,n.y,n.z),r.m_endPoint=new d.Vector3(o.x,o.y,o.z),r.m_color=new d.Color(a.r,a.g,a.b,a.a)}}else r.nativeLine=new d.Line3D,r.nativeLine.SetType(d.ShapeType.CURVE_LINE),r.SetVisible(!0);return r}return __extends(e,c),e.prototype.SetStartPoint=function(e){if(this.m_startPoint=e,this.nativeLine&&null!=e){var t=new d.Vector3(e.x,e.y,e.z);this.nativeLine.SetStartPoint(t)}},e.prototype.GetStartPoint=function(e){if(this.nativeLine){var t=this.nativeLine.GetStartPoint();this.m_startPoint=new d.Vector3(t.x,t.y,t.z)}return this.m_startPoint},e.prototype.GetStartVector=function(){var e=new d.Vector3;return null!=this.m_startPoint&&(e.x=this.m_startPoint.x,e.y=this.m_startPoint.y,e.z=this.m_startPoint.z),e},e.prototype.SetEndPoint=function(e){if(this.m_endPoint=e,this.nativeLine){var t=new d.Vector3(e.x,e.y,e.z);this.nativeLine.SetEndPoint(t)}},e.prototype.GetEndPoint=function(){if(this.nativeLine){var e=this.nativeLine.GetEndPoint();this.m_endPoint=new d.Vector3(e.x,e.y,e.z)}return this.m_endPoint},e.prototype.GetEndVector=function(){var e=new d.Vector3;return null!=this.m_endPoint&&(e.x=this.m_endPoint.x,e.y=this.m_endPoint.y,e.z=this.m_endPoint.z),e},e.prototype.GetType=function(){return d.ShapeType.CURVE_LINE},e.prototype.GetID=function(){return this.nativeLine?this.nativeLine.GetID():0},e.prototype.SetName=function(e){if(this.nativeLine){var t=String(e);this.nativeLine.SetName(t)}},e.prototype.GetName=function(){var e=null;return null!=this.nativeLine&&(e=String(this.nativeLine.GetName())),e},e.prototype.GetM3DName=function(){var e="",t=this.GetName();return null!=t&&(e=String(t)),e},e.prototype.SetColor=function(e){var t=new d.Color(e.r,e.g,e.b,e.a);this.nativeLine.SetColor(t),this.m_color=e},e.prototype.GetColor=function(){return this.m_color},e.prototype.GetM3DColor=function(){var e=new d.Color;return null!=this.m_color&&(e.a=this.m_color.a,e.b=this.m_color.b,e.g=this.m_color.g,e.r=this.m_color.r),e},e.prototype.SetWidth=function(e){this.nativeLine&&(this.m_size=e,this.nativeLine.SetLineWidth(e))},e.prototype.GetWidth=function(){return this.m_size},e.prototype.SetStyle=function(e){this.nativeLine&&this.nativeLine.SetLineStyle(e)},e.prototype.GetStyle=function(){var e=0;return this.nativeLine&&(e=this.nativeLine.GetLineStyle()),e},e.prototype.SetVisible=function(e){this.nativeLine&&this.nativeLine.SetVisible(e)},e.prototype.SetSelected=function(e){this.nativeLine&&this.nativeLine.SetSelected(e)},e.prototype.IsSelected=function(){return!!this.nativeLine&&this.nativeLine.IsSelected()},e.prototype.GetSVLId=function(){return this.nativeLine?this.nativeLine.GetSVLId():0},e.prototype.SetSetSelectable=function(e){this.nativeLine&&this.nativeLine.SetSelectAble(e)},e.prototype.Selectable=function(){return null!=this.nativeLine&&this.nativeLine.GetSelectAble()},e.prototype.SetShowPoint=function(e){this.nativeLine&&this.nativeLine.SetShowPoint(e)},e.prototype.GetLine=function(){return this.nativeLine},e}(d.SBaseGeoData);d.SLine=e}(M3D||(M3D={})),function(e){var t=function(){function e(){this.nativeMeasure=null,this.nativeNote=null,this.anchorX=-1,this.anchorY=-1,this.author="",this.view=null}return e.prototype.GetAnchorX=function(){return this.anchorX},e.prototype.SetAnchorX=function(e){this.anchorX=e},e.prototype.GetAnchorY=function(){return this.anchorY},e.prototype.SetAnchorY=function(e){this.anchorY=e},e.prototype.GetMeasureType=function(){return this.measureType},e.prototype.SetMeasureType=function(e){this.measureType=e},e.prototype.GetView=function(){return this.view},e.prototype.SetView=function(e){this.view=e},e.prototype.GetID=function(){return null!==this.nativeMeasure?this.nativeMeasure.GetID():null!==this.nativeNote?this.nativeNote.GetID():0},e.prototype.Create=function(){return!1},e.prototype.Delete=function(){return!1},e.prototype.Clear=function(){return!1},e.prototype.SetNativeMeasureObj=function(e){this.nativeMeasure=e},e.prototype.GetMeasureObj=function(){return this.nativeMeasure},e.prototype.SetNativeNoteObj=function(e){this.nativeNote=e},e.prototype.GetNoteObj=function(){return this.nativeNote},e.prototype.CreateMeasure=function(){var e,t=!1,r=this.GetMeasureType();return(e=M3D.MeasureFactory.CreateSingleMeasure(r,this.view.GetSceneManager()))&&(this.nativeMeasure=e,t=!0),t},e.prototype.GetCreateID=function(){return this.nativeMeasure?this.nativeMeasure.GetCreateID():0},e.prototype.SetCreateID=function(e){this.nativeMeasure&&this.nativeMeasure.SetCreateID(e)},e.prototype.AddImageBoard=function(e,t){var r=!1;if(this.nativeMeasure){var i=String(e);new M3D.Vector3(t.x,t.y,t.z);r=M3D.MeasureFactory.CreateMeasureImageBoard(this.nativeMeasure,i,t,this.view.GetSceneManager())}return r},e.prototype.AddLines=function(e){var t=!1;if(this.nativeMeasure){var r=e.GetM3DName(),i=e.GetStartVector(),n=e.GetEndVector(),o=e.GetM3DColor();t=M3D.MeasureFactory.CreateMeasureLine(this.nativeMeasure,r,i,n,o)}return t},e.prototype.AddPoints=function(e){var t=!1;if(this.nativeMeasure){var r=e.GetType(),i=e.GetSize(),n=e.GetVector();t=M3D.MeasureFactory.CreateMeasurePoint(this.nativeMeasure,r,i,n)}return t},e.prototype.Init=function(){this.SetType(M3D.ShapeType.SHAPE_MEASURE_BASE)},e.prototype.SetType=function(e){this.type=e},e.prototype.GetType=function(){return this.type},e.MEASURE_TYPE_BASE=0,e.MEASURE_TYPE_ERROR=200,e.MEASURE_TYPE_PNT_PNT_DISTANCE=1,e.MEASURE_TYPE_PNT_LINE_DISTANCE=2,e.MEASURE_TYPE_PNT_FACE_DISTANCE=3,e.MEASURE_TYPE_LINE_LINE_DISTANCE=4,e.MEASURE_TYPE_LINE_FACE_DISTANCE=5,e.MEASURE_TYPE_FACE_FACE_DISTANCE=6,e.MEASURE_TYPE_POINT_MULTIPOINT_DISTANCE=7,e.MEASURE_TYPE_SUDISTANCE=8,e.MEASURE_TYPE_SHAFT_SHAFT_DISTANCE=9,e.MEASURE_TYPE_CENTER_CENTER_DISTANCE=10,e.MEASURE_TYPE_ANNOTATION=40,e.MEASURE_TYPE_LINE_LINE_ANGLE=50,e.MEASURE_TYPE_FACE_FACE_ANGLE=51,e.MEASURE_TYPE_LINE_FACE_ANGLE=52,e.MEASURE_TYPE_CURVE_CURVE_ANGLE=53,e.MEASURE_TYPE_DIAMETRE=60,e.MEASURE_TYPE_RADIUS=61,e.MEASURE_TYPE_PNT_COORD=100,e.MEASURE_TYPE_LENGTH=101,e.MEASURE_TYPE_ARC=102,e.MEASURE_TYPE_CIRCLE=103,e.MEASURE_TYPE_HOLE=104,e.MEASURE_TYPE_MODEL=105,e.MEASURE_TEXT_NOTE=150,e.MEASURE_CT_TEXT_NOTE=152,e.MEASURE_VOICE_NOTE=151,e.MEASURE_SEQUENCE_NUMBER_NOTE=153,e.MEASURE_THREED_GESTURE_NOTE=154,e.MEASURE_FRIST_SHAPE_PNT=1,e.MEASURE_FRIST_SHAPE_LINE=2,e.MEASURE_FRIST_SHAPE_FACE=3,e.MEASURE_SECOND_SHAPE_PNT=4,e.MEASURE_SECOND_SHAPE_LINE=5,e.MEASURE_SECOND_SHAPE_FACE=6,e.MEASURE_SHAPE_PNT=7,e.MEASURE_SHAPE_LINE=8,e.MEASURE_SHAPE_FACE=9,e.MEASURE_SHAPE_ARC=10,e.MEASURE_SHAPE_HOLE=11,e.MEASURE_SHAPE_MODEL=12,e.WALKTHROUGH_TIPS=32,e.PUTBOX_TIPS=33,e.MEASURE_TIPS_CANCLE=500,e.MEASURE_SHOW_RESULT=501,e}();e.SMeasure=t}(SView||(SView={})),function(e){var t=function(t){function e(){var e=t.call(this)||this;return e.fristAnChorShape=0,e.secondAnChorShape=0,e.firstShape=0,e.secondShape=0,e.firstCurveLine=new M3D.Line3D,e.secondCurveLine=new M3D.Line3D,e.Init(),e}return __extends(e,t),e.prototype.Create=function(){this.GetMeasureType(),this.firstShape,this.secondShape;var e=this.GetAnchorX(),t=this.GetAnchorY();new M3D.Vector2(e,t);return this.CreateTempMeasure(),this.CompleteMeasure()},e.prototype.CreateCurve=function(){var e,t=!1,r=this.GetMeasureType(),i=this.firstCurveLine,n=this.secondCurveLine,o=this.firstShape,a=this.secondShape,s=this.GetAnchorX(),l=this.GetAnchorY(),h=new M3D.Vector2(s,l);return(e=M3D.MeasureFactory.CreateCurveAngleMeasure(o,a,i,n,r,h,this.view.GetSceneManager()))&&(this.nativeMeasure=e,t=!0),t},e.prototype.Delete=function(){return 0<this.GetID()&&(this.view.RemoveShape(this.GetID()),!0),!1},e.prototype.Clear=function(){return!1},e.prototype.GetFirstShape=function(){return this.firstShape},e.prototype.SetFirstShape=function(e){this.firstShape=e},e.prototype.GetFirstCurveLine=function(){return this.firstCurveLine},e.prototype.SetFirstCurveLine=function(e){this.firstCurveLine=e},e.prototype.GetSecondShape=function(){return this.secondShape},e.prototype.SetSecondShape=function(e){this.secondShape=e},e.prototype.GetSecondCurveLine=function(){return this.secondCurveLine},e.prototype.SetSecondCurveLine=function(e){this.secondCurveLine=e},e.prototype.GetFristAnChorShape=function(){return this.fristAnChorShape},e.prototype.SetFristAnChorShape=function(e){this.fristAnChorShape=e},e.prototype.GetSecondAnChorShape=function(){return this.secondAnChorShape},e.prototype.SetSecondAnChorShape=function(e){this.secondAnChorShape=e},e.prototype.Init=function(){this.SetType(M3D.ShapeType.SHAPE_MEASURE_ANGLE)},e.prototype.CreateTempMeasure=function(){var e,t=!1,r=this.GetMeasureType(),i=this.firstShape,n=this.secondShape,o=this.GetFristAnChorShape(),a=this.GetSecondAnChorShape();return(e=M3D.MeasureFactory.CreateTmpAngleMeasure(i,n,o,a,r,this.GetView().GetSceneManager()))&&(this.nativeMeasure=e,t=!0),t},e.prototype.CompleteMeasure=function(){var e=!1;if(this.nativeMeasure){var t=this.firstShape,r=this.secondShape,i=(this.GetMeasureType(),this.GetAnchorX()),n=this.GetAnchorY(),o=this.fristAnChorShape,a=this.secondAnChorShape,s=new M3D.Vector2(i,n);e=M3D.MeasureFactory.CompleteAngleMeasure(this.nativeMeasure,t,r,o,a,s,this.GetView().GetSceneManager())}return e},e}(e.SMeasure);e.SMeasureAngle=t}(SView||(SView={})),function(e){var t=function(t){function e(){var e=t.call(this)||this;return e.fristAnChorShape=0,e.secondAnChorShape=0,e.firstShape=0,e.secondShape=0,e.Init(),e}return __extends(e,t),e.prototype.Create=function(){var e=!1,t=(this.GetMeasureType(),this.firstShape,this.secondShape,this.GetAnchorX()),r=this.GetAnchorY();new M3D.Vector2(t,r);return this.CreateTempMeasure()&&(e=this.CompleteMeasure()),e},e.prototype.Delete=function(){return 0<this.GetID()&&(this.view.RemoveShape(this.GetID()),!0),!1},e.prototype.Clear=function(){return!1},e.prototype.GetFirstShape=function(){return this.firstShape},e.prototype.SetFirstShape=function(e){this.firstShape=e},e.prototype.GetSecondShape=function(){return this.secondShape},e.prototype.SetSecondShape=function(e){this.secondShape=e},e.prototype.GetFristAnChorShape=function(){return this.fristAnChorShape},e.prototype.SetFristAnChorShape=function(e){this.fristAnChorShape=e},e.prototype.GetSecondAnChorShape=function(){return this.secondAnChorShape},e.prototype.SetSecondAnChorShape=function(e){this.secondAnChorShape=e},e.prototype.Init=function(){this.SetType(M3D.ShapeType.SHAPE_MEASURE_DIAMETRE)},e.prototype.CreateTempMeasure=function(){var e,t=!1,r=this.GetMeasureType(),i=this.GetAnchorX(),n=this.GetAnchorY(),o=new M3D.Vector2(i,n),a=this.firstShape;this.secondShape;return(e=M3D.MeasureFactory.CreateTmpDiametreMeasure(a,r,this.GetView().GetSceneManager(),o))&&(this.nativeMeasure=e,t=!0),t},e.prototype.CompleteMeasure=function(){var e=!1;if(this.nativeMeasure){var t=this.firstShape,r=(this.secondShape,this.GetMeasureType(),this.GetAnchorX()),i=this.GetAnchorY(),n=new M3D.Vector2(r,i);e=M3D.MeasureFactory.CompleteDiametreMeasure(this.nativeMeasure,t,n,this.GetView().GetSceneManager())}return e},e.prototype.GetName=function(){var e="";if(this.nativeMeasure){var t=this.nativeMeasure.GetTextValue();e=String(t.toString())}return e},e}(e.SMeasure);e.SMeasureDiametre=t}(SView||(SView={})),function(m){var e=function(t){function n(){var e=t.call(this)||this;return e.fristAnChorShape=0,e.secondAnChorShape=0,e.firstShape=0,e.secondShape=0,e.Init(),e}return __extends(n,t),n.prototype.Create=function(){var e=!1,t=(this.GetMeasureType(),this.firstShape,this.secondShape,this.GetAnchorX()),r=this.GetAnchorY();new M3D.Vector2(t,r);return this.CreateTempMeasure()&&(e=this.CompleteMeasure()),e},n.prototype.Delete=function(){return 0<this.GetID()&&(this.view.RemoveShape(this.GetID()),!0),!1},n.prototype.Clear=function(){return!1},n.prototype.GetFirstShape=function(){return this.firstShape},n.prototype.SetFirstShape=function(e){this.firstShape=e},n.prototype.GetSecondShape=function(){return this.secondShape},n.prototype.SetSecondShape=function(e){this.secondShape=e},n.prototype.GetFristAnChorShape=function(){return this.fristAnChorShape},n.prototype.SetFristAnChorShape=function(e){this.fristAnChorShape=e},n.prototype.GetSecondAnChorShape=function(){return this.secondAnChorShape},n.prototype.SetSecondAnChorShape=function(e){this.secondAnChorShape=e},n.prototype.Init=function(){this.SetType(M3D.ShapeType.SHAPE_MEASURE_DISTANCE)},n.CreateFromXML=function(e,t){var r=null;if(null!=e&&0!=e.length){r=new n;var i=M3D.MeasureFactory.CreateMeasureFromXMLElement(t.view.GetSceneManager(),t.ParseXmlString(e));if(i){r.SetView(t.view),r.SetNativeMeasureObj(i);i.GetID()}return r}},n.prototype.CreateTempMeasure=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r,i=!1,n=this.GetMeasureType(),o=this.GetAnchorX(),a=this.GetAnchorY(),s=new M3D.Vector2(o,a);if(2==e.length){var l=e[1],h=e[0],u=new M3D.Vector3,p=new M3D.Vector3;null!=l&&(u=new M3D.Vector3(l.x,l.y,l.z)),null!=h&&(p=new M3D.Vector3(h.x,h.y,h.z)),r=M3D.MeasureFactory.CreateTmpDistanceMeasure(u,p,n,this.GetView().GetSceneManager())}else{var c=this.firstShape,d=this.secondShape;if(n==m.SMeasure.MEASURE_TYPE_PNT_FACE_DISTANCE||n==m.SMeasure.MEASURE_TYPE_LINE_FACE_DISTANCE||n==m.SMeasure.MEASURE_TYPE_FACE_FACE_DISTANCE){var S=this.fristAnChorShape,f=this.secondAnChorShape;r=M3D.MeasureFactory.CreateTmpFaceDistanceMeasure(c,d,S,f,n,this.GetView().GetSceneManager(),s)}else r=M3D.MeasureFactory.CreateTmpDistanceMeasure(c,d,n,this.GetView().GetSceneManager(),s)}return r&&(this.nativeMeasure=r,i=!0),i},n.prototype.CompleteMeasure=function(){var e=!1;if(this.nativeMeasure){var t=this.firstShape,r=this.secondShape,i=this.GetMeasureType(),n=this.GetAnchorX(),o=this.GetAnchorY(),a=new M3D.Vector2(n,o);if(i==M3D.Measure.MEASURE_TYPE_PNT_FACE_DISTANCE||i==M3D.Measure.MEASURE_TYPE_LINE_FACE_DISTANCE||i==M3D.Measure.MEASURE_TYPE_FACE_FACE_DISTANCE){var s=this.fristAnChorShape,l=this.secondAnChorShape;e=M3D.MeasureFactory.CompleteFaceDistanceMeasure(this.nativeMeasure,t,r,s,l,a,this.GetView().GetSceneManager())}else e=M3D.MeasureFactory.CompleteDistanceMeasure(this.nativeMeasure,t,r,a,this.GetView().GetSceneManager())}return e},n.prototype.GetName=function(){var e="";if(this.nativeMeasure){var t=this.nativeMeasure.GetTextValue();e=String(t.toString())}return e},n}(m.SMeasure);m.SMeasureDistance=e}(SView||(SView={})),function(e){var t=function(t){function h(){var e=t.call(this)||this;return e.fristAnChorShape=0,e.secondAnChorShape=0,e.propertyShape=0,e.showType=h.UI_SHOW,e.Init(),e}return __extends(h,t),h.prototype.Create=function(){var e=!1,t=null,r=this.GetMeasureType(),i=this.propertyShape,n=this.showType,o=this.GetAnchorX(),a=this.GetAnchorY(),s=new M3D.Vector2(o,a);if(n===h.GL_SHOW){this.fristAnChorShape,this.secondAnChorShape;t=M3D.MeasureFactory.CreatePropertyMeasure(i,r,s,this.view.GetSceneManager())}else{var l=void 0;l=M3D.MeasureFactory.GetMeasureProperty(i,r,this.view.GetSceneManager(),l),this.SetMeasureProperties(l)}return t&&(this.nativeMeasure=t,e=!0),e},h.prototype.GetMeasurePropertiesWithMeasuerId=function(e,t){var r;return r=M3D.MeasureFactory.GetMeasureProperty(e,t,this.view.GetSceneManager(),r),this.SetMeasureProperties(r),this.GetMeasureProperties()},h.prototype.Delete=function(){return 0<this.GetID()&&(this.view.RemoveShape(this.GetID()),!0),!1},h.prototype.Clear=function(){return!1},h.prototype.GetFristAnChorShape=function(){return this.fristAnChorShape},h.prototype.SetFristAnChorShape=function(e){this.fristAnChorShape=e},h.prototype.GetSecondAnChorShape=function(){return this.secondAnChorShape},h.prototype.SetSecondAnChorShape=function(e){this.secondAnChorShape=e},h.prototype.Init=function(){this.SetType(M3D.ShapeType.SHAPE_MEASURE_PROPERTY)},h.prototype.SetMeasureProperties=function(e){this.measureProperties=e},h.prototype.GetMeasureProperties=function(){return this.measureProperties},h.prototype.SetPropertyShape=function(e){this.propertyShape=e},h.prototype.GetPropertyShape=function(){return this.propertyShape},h.prototype.GetShowType=function(){return this.showType},h.prototype.SetShowType=function(e){this.showType=e},h.GL_SHOW=0,h.UI_SHOW=1,h}(e.SMeasure);e.SMeasureProperty=t}(SView||(SView={})),function(s){var e=function(a){function e(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=a.call(this)||this;if(r.m_name="",1===e.length){(i=e[0]).GetCoordinate();r.m_size=i.GetSize(),r.nativepoint=i,r.SetVisible(!0)}else if(3===e.length){var i=e[0],n=(e[1],e[2]);r.nativepoint=new s.Point;var o=new s.Vector3(i.x,i.y,i.z);r.nativepoint.SetCoordinate(o),r.nativepoint.SetSize(n),r.SetVisible(!0),r.m_point=o,r.m_size=n}else r.nativepoint=new s.Point,r.nativepoint.SetType(s.ShapeType.SHAPE_POINT),r.SetVisible(!0);return r}return __extends(e,a),e.prototype.SetSelected=function(e){this.nativepoint&&this.nativepoint.SetSelected(e)},e.prototype.IsSelected=function(){return!!this.nativepoint&&this.nativepoint.IsSelected()},e.prototype.GetType=function(){return s.ShapeType.SHAPE_POINT},e.prototype.GetID=function(){return this.nativepoint?this.nativepoint.GetID():0},e.prototype.SetPoint=function(e){if(this.m_point=e,this.nativepoint&&null!=e){var t=new s.Vector3(e.x,e.y,e.z);this.nativepoint.SetCoordinate(t)}},e.prototype.GetPoint=function(){return this.m_point},e.prototype.GetVector=function(){var e=new s.Vector3;return null!=this.m_point&&(e.x=this.m_point.x,e.y=this.m_point.y,e.z=this.m_point.z),e},e.prototype.SetSize=function(e){this.m_size=e,this.nativepoint.SetSize(e)},e.prototype.GetSize=function(){return this.m_size},e.prototype.SetColor=function(e){if(null!=e){this.m_color=e;var t=new s.Color(e.r,e.g,e.b,e.a);this.nativepoint.SetColor(t)}},e.prototype.GetColor=function(){return this.m_color},e.prototype.SetName=function(e){if(null!=e){this.m_name=e;var t=String(e);this.nativepoint.SetName(t)}},e.prototype.GetName=function(){return this.m_name},e.prototype.SetVisible=function(e){this.nativepoint&&this.nativepoint.SetVisible(e)},e.prototype.SetStyle=function(e){this.nativepoint&&this.nativepoint.SetPointStyle(e)},e.prototype.GetStyle=function(){return this.nativepoint?this.nativepoint.GetPointStyle():0},e.prototype.SetSetSelectable=function(e){this.nativepoint&&this.nativepoint.SetSelectAble(e)},e.prototype.Selectable=function(){return null!=this.nativepoint&&this.nativepoint.GetSelectAble()},e.prototype.UpdateSelectPoint=function(e){this.SetPoint(e)},e.prototype.GetNativePoint=function(){return this.nativepoint},e}(s.SBaseGeoData);s.SPoint=e}(M3D||(M3D={})),function(e){var t=function(t){function e(){var e=t.call(this)||this;return e.m_strokePoints=[],e.Init(),e}return __extends(e,t),e.prototype.Create=function(){return!1},e.prototype.Delete=function(){var e=!1;return 0<this.GetID()&&(this.view.RemoveShape(this.GetID()),e=!0),e},e.prototype.Clear=function(){return!1},e.prototype.Create3DGestureNote=function(e,t,r,i){if(0<e.length&&0<t.length&&0<r.length){var n=new M3D.Gesture3DInfo;if(i){for(var o=n.m_pointSet,a=0;a<e.length;a++){for(var s=e[a],l=new M3D.PolyLine,h=0;h<s.length;h++){var u=new M3D.Vector3(s[h].x,s[h].y,0);l.AddPoint(u)}o.push(l)}var p=n.m_colorSet;for(a=0;a<t.length;a++){var c=t[a];for(h=0;h<c.length;h++){var d=new M3D.Color(c[h].r,c[h].g,c[h].b,c[h].a);p.push(d)}}var S=n.m_lineWidthSet;for(a=0;a<r.length;a++){var f=r[a];S.push(f)}var m=M3D.NoteFactory.CreateThreeDGestureNote(n,i.GetView().GetSceneManager());m&&(this.nativeNote=m,this.SetView(i.GetView()),i.GetNativeShapeManager().AddShape(m.GetID(),m))}return!0}return!1},e.prototype.Init=function(){t.prototype.Init.call(this),this.SetType(M3D.ShapeType.SHAPE_THREED_GESTURE_NOTE)},e}(e.SMeasure);e.SThreeDGestureNote=t}(SView||(SView={})),function(SView_1){SView_1.CreateViewer=function(e){return new SView(e)},SView_1.GetLogger=function(){return null===M3D.Log&&(M3D.Log=new M3D.Logger),M3D.Log};var SView=function(){function SView(renderCanvas){this.view=null,this.curExplosiveStyle=0,this.curExplosivePercentage=0,this.curClipValue=0,this.curClipDirection=1,this.curIsShowCappingPlane=!1,this.curIsShowClipPlane=!1,this.CurIsShowCutPlane=!1,this.singleClickFlag=!1,this.PickShapeType=M3D.ShapeType.SHAPE_MODEL,this.inputConfig="",this.optionConfig='{ "pc": { "zoom": "", "traslation": "wheelkey", "rotating": "left","zoombearing":"up","pickup":"left" },"singletouch":{"rotating":"touch","traslation":"dbtouch","zoom":"longtouch","zoombearing":"left"} }',this.configJson=eval("("+this.optionConfig+")"),this.SViewBaseUrl="",this.choiceSwitch=!0,this.isSinglePoint=!1,this.oneFinger=!1,this.touchDown=!1,this.clickUp=!1,this.isPickUp=!1,this.OperaType=SView.TOUCH_ROTATE,this.tempShapeList=[],this.touchPnts=new Array(10),this.renderCanvas=null,this.lastMousePosition=new M3D.Vector2,this.isMouseWheelStop=!1,this.width=0,this.height=0,this.isShowWireframe=!1,this.isOnlyShowWireframe=!1,this.IsShowEdgeLine=!0,this.IsOnlyShowEdgeLine=!1,this.IsShowTransparent=!1,this.readListeners=[],this.selectorListeners=[],this.isWheelPressing=!1,this.deviceRatio=1,this.curFileName="",this.joyStickOption={strightSpd:0,sideSpd:0,isJoysticPressing:!1},this.decryptoOptions={decryptoFile:!1,decryptoServer:""},this.pmiOptions={usePMI:!1,pmiServer:"http://localhost:8070/"},this.onAlert=function(e){},this.animationTaskLinstener=new M3D.AnimationTaskLinstener,this.animationPlayer=null,this.isPlaying=!1,this.assemblyTempModel=null,this.initAssemblyTreeFuc=function(e){},this.updateAssemblyTree=function(e){},this.addAssemblyOver=function(){},this.onSViewMouseDown=function(){},this.onSViewMouseMove=function(){},this.onSViewMouseUp=function(){},this.onRestoreViewEnd=function(){},this.openModelsEnd=function(e){},this.OnOpenFinished=function(e){this.StartFixUpdateTimer()},this.PorpertyMeasureCallBack=function(e){},this.MeasureError=function(){},this.inputTextNote=function(e){},this.inputSHotSpot=function(e){},this.showRightMenuInIos=function(e){},this.CloseRightMenuInIos=function(e){},this.DoubleTouchListener=function(e){},this.ShowLicenceStateInfoListener=function(e,t){},this.SHotSpotDescribeListener=function(e){},this.isControlDown=!1,this.mouseDownPoints=[],this.isFrameSelect=!1,this.isFrameSelctState=!1,this.isShowTextNoteAlert=!1,this.lastMouseTime=(new Date).getTime(),this.downPnts=new Array(10),this.isMultiSelect=!1,this.keyMap={},this.fixUpdateInterval=20,this.fixUpdateTimer=new M3D.Timer,this.lastTicks=0,this.showRightMenu=!1,this.timeOutEvent=0,this.timeOutEventForMove=0,this.isDbTouch=!1,this.isLongTouch=!1,this.longTouchMenu=!1,this.lastTouchTime=(new Date).getTime(),this.touchStartPoints=[],this.readNextListener=null,this.mulitFileReadModels=[],this.readModelListener=null,this.explosiveManager=new SView_1.ExplosiveManager(this),this.joystickTimer=new M3D.Timer,this.explosiveTimer=new M3D.Timer,this.aniTimer=new M3D.Timer,this.explosivePercent=0,this.isRotateComplete=!1,this.explorsiveSpeed=1,this.isNeedRotate=!0,this.excStep1=!1,this.excStep2=!1,this.downTimer=null,this.openFileLicence=!1,this.measureLicence=!0,this.animationLicence=!1,this.explosiveLicence=!1,this.licenseTools=new M3D.LicenseTools(this),this.licenseHelper=new M3D.LicenseHelper,this._commandManage=null,this._measureCommandManager=null,this._annotationCommandManager=null,this._hotspotCommandManager=null,this._nativeShapeManager=new SView_1.ShapeManager,this._measureManager=null,this._annotationManager=null,this.modelSet=[],this.readCounts=0,this.allModels=new M3D.Model,this._firstLocation=new M3D.Vector2,this._endLocation=new M3D.Vector2,this.isCanvace2Dsingle=!1,this._isAixsCommand=!1,this._isRotationCommand=!1,SView_1.GetLogger();var message="{SView:'StartCreate'}";M3D.Log.Info(this,message),null!=window.devicePixelRatio&&null!=window.devicePixelRatio&&(this.deviceRatio=window.devicePixelRatio),this.view=new M3D.View,this.view.Initial(renderCanvas),this.renderCanvas=renderCanvas,this.resize(),this.InitRenderCavansEventListener(),this.animationPlayer=new M3D.AnimationPlayer(this.view),this.animationPlayer.AddTaskListener(this.animationTaskLinstener),SView_1.ScreenUILayerManager.Instance().setSView(this),message="{SView:'Create View Success'}",M3D.Log.Info(this,message),SView_1.LinkManager.Instance().view=this,SView_1.SHotSpotManager.Instance().view=this,M3D.Parameters.Instance().useBackGroundImage&&this.SetBackgroundImage(M3D.Parameters.Instance().backGroundImageUrl)}return SView.prototype.SetSViewBaseUrl=function(e){this.SViewBaseUrl=e},SView.prototype.setConfig=function(inputConfig){this.configJson=eval("("+this.optionConfig+")"),this.inputConfig=inputConfig;var config=null;null!==inputConfig&&0<inputConfig.length&&(config=eval("("+this.inputConfig+")")),null==config.phone&&(config.phone=this.configJson.phone),null==config.pc&&(config.pc=this.configJson.pc),null==config.singletouch&&(config.singletouch=this.configJson.singletouch),this.configJson=config},SView.prototype.getConfig=function(){return this.configJson},SView.prototype.getOffsetLeftToBody=function(e){for(var t=e.offsetLeft;e=e.offsetParent;)t+=e.offsetLeft;return t},SView.prototype.getOffsetTopToBody=function(e){for(var t=e.offsetTop;e=e.offsetParent;)t+=e.offsetTop;return t},SView.prototype.openChoice=function(e){this.choiceSwitch=e},SView.prototype.setSinglePoint=function(e){this.isSinglePoint=e},SView.prototype.setOneFinger=function(e){this.oneFinger=e},SView.prototype.SetBackgroundImage=function(e){var t=this.view.GetSceneManager().GetResourceManager(),r=t.GetOrCreateTexture(e),i=t.GetImage(e);null===i&&(i=t.GetOrCreateImage(e,e)),r.AddImage(i),this.view.SetBackgroundTexture(r),this.view.SetBackgroundUseImage(!0)},SView.prototype.GetBackgroundImage=function(){var e=this.view.GetBackgroundTexture();if(e)return e.GetImagePathes()},SView.prototype.SetBackgroundWaterMark=function(e){e?(M3D.Parameters.Instance().useWaterMark=!0,M3D.Parameters.Instance().waterMarkStr=e):M3D.Parameters.Instance().useWaterMark=!1},SView.prototype.SetWaterMarkText=function(e){e?(M3D.Parameters.Instance().useWaterMark=!0,M3D.Parameters.Instance().waterMarkStr=e):M3D.Parameters.Instance().useWaterMark=!1},SView.prototype.GetWaterMarkText=function(){return M3D.Parameters.Instance().useWaterMark?M3D.Parameters.Instance().waterMarkStr:null},SView.prototype.SetBackgroundColor=function(e,t){if(!e||!t)return!1;this.view.SetBackgroundColor(e,t),M3D.CookieHelper.AddCookie(M3D.TOP_COLOR_KEY,e.Tostring(),30),M3D.CookieHelper.AddCookie(M3D.BOTTOCOLOR_KEY,t.Tostring(),30)},SView.prototype.GetBackgroundColor=function(){var e=M3D.CookieHelper.GetCookie(M3D.BOTTOCOLOR_KEY),t=M3D.CookieHelper.GetCookie(M3D.TOP_COLOR_KEY),r=[];if(e&&t){var i=e.split(" "),n=t.split(" "),o=new M3D.Color(parseFloat(i[0]),parseFloat(i[1]),parseFloat(i[2])),a=new M3D.Color(parseFloat(n[0]),parseFloat(n[1]),parseFloat(n[2]));r.push(a),r.push(o)}else r.push(new M3D.Color(.25,.63,1)),r.push(new M3D.Color(.88,.96,1));return r},SView.prototype.createMaterial=function(e){var t=this.getOrCreateMaterial(e.material_type);if(t.SetDisplayName(e.material_name),t instanceof M3D.Material&&1==e.material_type){var r=e.difusse_color.split(","),i=new M3D.Color(Number(r[0])/255,Number(r[1])/255,Number(r[2])/255);t.SetDiffuse(i);var n=e.specular_color.split(","),o=new M3D.Color(Number(n[0])/255,Number(n[1])/255,Number(n[2])/255);t.SetSpecular(o),t.SetShininess(e.brightness),t.Opacity(Number(e.transparency));var a=e.ambient_color.split(","),s=new M3D.Color(Number(a[0])/255,Number(a[1])/255,Number(a[2])/255);t.SetAmbient(s);var l=e.emissive_color.split(","),h=new M3D.Color(Number(l[0])/255,Number(l[1])/255,Number(l[2])/255);if(t.SetEmissive(h),t.SetUvRotate(Number(e.texture_coordinate_rotation)),t.SetUvScale(new M3D.Vector2(Number(e.texture_coor_scaling_u),Number(e.texture_coor_scaling_v))),t.SetUvTranslate(new M3D.Vector2(Number(e.texture_coor_rollover_u),Number(e.texture_coor_rollover_v))),""!=e.diffuse_texture_img){var u=this.GetOrCreateTexture(e.diffuse_texture_img);t.SetDiffuseMap(u)}if(""!=e.specular_texture_img){u=this.GetOrCreateTexture(e.specular_texture_img);t.SetSpecularMap(u)}if(""!=e.radiation_texture_img){u=this.GetOrCreateTexture(e.radiation_texture_img);t.SetEmissiveMap(u)}if(""!=e.nomal_texture_img){u=this.GetOrCreateTexture(e.nomal_texture_img);t.SetNormalMap(u),t.NormalMapScale(new M3D.Vector2(Number(e.normal_texture_scaling_x),Number(e.normal_texture_scaling_y)))}}if(t instanceof M3D.PbrMaterial&&2==e.material_type){r=e.difusse_color.split(","),i=new M3D.Color(Number(r[0])/255,Number(r[1])/255,Number(r[2])/255);if(t.SetAlbedoColor(i),t.SetOpacity(Number(e.transparency)),t.SetMetalnessFactor(Number(e.metallic_luster)),t.SetRougthnessFactor(Number(e.roughness)),t.SetUseClearCoat(e.is_remove_cover),t.SetClearCoat(Number(e.remove_cover)),t.SetClearCoatRoughness(Number(e.clear_rough_overlays)),t.SetUvRotate(Number(e.texture_coordinate_rotation)),t.SetUvScale(new M3D.Vector2(Number(e.texture_coor_scaling_u),Number(e.texture_coor_scaling_v))),t.SetUvTranslate(new M3D.Vector2(Number(e.texture_coor_rollover_u),Number(e.texture_coor_rollover_v))),""!=e.rough_metal_texture_img){u=this.GetOrCreateTexture(e.rough_metal_texture_img);t.SetMetalnessRoughnessMap(u)}if(""!=e.diffuse_texture_img){u=this.GetOrCreateTexture(e.diffuse_texture_img);t.SetEmissiveMap(u)}if(""!=e.nomal_texture_img){u=this.GetOrCreateTexture(e.nomal_texture_img);t.SetNormalMap(u),t.SetNormalMapScale(new M3D.Vector2(Number(e.normal_texture_scaling_x),Number(e.normal_texture_scaling_y)))}}if(t instanceof M3D.MatCapMaterial&&4==e.material_type){r=e.difusse_color.split(","),i=new M3D.Color(Number(r[0])/255,Number(r[1])/255,Number(r[2])/255);if(t.SetDiffuse(i),t.Opacity(Number(e.transparency)),""!=e.material_capture_texture_img){u=this.GetOrCreateTexture(e.material_capture_texture_img);t.SetMatcapMap(u)}if(""!=e.nomal_texture_img){u=this.GetOrCreateTexture(e.nomal_texture_img);t.SetNormalMap(u),t.NormalMapScale(new M3D.Vector2(Number(e.normal_texture_scaling_x),Number(e.normal_texture_scaling_y)))}}console.log(this.view.GetSceneManager().GetResourceManager().MaterialToJSON())},SView.prototype.getOrCreateMaterial=function(e){var t=this.view.GetSceneManager().GetResourceManager(),r=t.getMaxMaterialKey()+1,i=null;return 1==e&&(i=t.GetOrCreateMaterial(r,M3D.MaterialType.MaterialType_Phong)),2==e&&(i=t.GetOrCreateMaterial(r,M3D.MaterialType.MaterialType_Pbr)),4==e&&(i=t.GetOrCreateMaterial(r,M3D.MaterialType.MaterialType_MatCap)),i},SView.prototype.GetOrCreateTexture=function(e){var t=this.view.GetSceneManager().GetResourceManager(),r=t.GetOrCreateTexture(e),i=t.GetImage(e);return null===i&&(i=t.GetOrCreateImageById(e,t.getMaxImageId()+1,e)),r.AddImage(i),r},SView.prototype.SetMaterialToModel=function(e,t){if(0==t.GetSubModels().length)for(var r=t.GetModelShape().GetBodys(),i=0;i<r.length;i++)for(var n=r[i].GetFaces(),o=0;o<n.length;o++)n[o].SetMaterial(e);else for(var a=0;a<t.GetSubModels().length;a++)this.SetMaterialToModel(e,t.GetSubModels()[a])},SView.prototype.GetAnimationTaskLinstener=function(){return this.animationTaskLinstener},SView.prototype.GetAnimationPlayer=function(){return this.animationPlayer},SView.prototype.SetIsPlaying=function(e){this.isPlaying=e},SView.prototype.GetIsPlaying=function(){return this.isPlaying},SView.prototype.IsPlaying=function(){return this.isPlaying},SView.prototype.AnimationPlay=function(){this.isPlaying?this.Pause():this.Play()},SView.prototype.AnimationPre=function(){this.PlayPre()},SView.prototype.AnimationNext=function(){this.PlayNext()},SView.prototype.AnimationSetSliderValue=function(e){this.animationPlayer.SetPercent(e),this.SetIsPlaying(!0),this.GetAnimationPlayer().SetIsPlaying(!0)},SView.prototype.AnimationGetSliderValue=function(){return this.animationPlayer.GetPercent()},SView.prototype.AnimationAutoWalk=function(e){e?this.animationPlayer.SetAutoWalkCamera(!0):this.animationPlayer.SetAutoWalkCamera(!1)},SView.prototype.AnimationLoop=function(e){e?this.animationPlayer.SetLoop(!0):this.animationPlayer.SetLoop(!1)},SView.prototype.AnimationSetSpeed=function(e){this.animationPlayer.SetSpeed(e)},SView.prototype.AnimationOpenFile=function(){this.view.HasAnimations()&&this.animationPlayer.OpenFile()},SView.prototype.ExistAnimation=function(){return this.view.HasAnimations()},SView.prototype.showShotSpotDescribe=function(e){this.SHotSpotDescribeListener(e)},SView.prototype.Pause=function(){this.animationPlayer.Pause(),this.SetIsPlaying(!1),this.GetAnimationPlayer().SetIsPlaying(!1)},SView.prototype.Play=function(){this.animationPlayer.Resume(),this.animationPlayer.GetSpeed(),this.SetIsPlaying(!0),this.GetAnimationPlayer().SetIsPlaying(!0)},SView.prototype.PlayPre=function(){this.animationPlayer.PlayPrevious(),this.SetIsPlaying(!0),this.GetAnimationPlayer().SetIsPlaying(!0)},SView.prototype.PlayNext=function(){this.animationPlayer.PlayNext(),this.SetIsPlaying(!0),this.GetAnimationPlayer().SetIsPlaying(!0)},SView.prototype.checkButton=function(e){if(null!=e.buttons)return e.buttons;if(null!=e.button){if(0===e.button)return 1;if(1===e.button)return 4}return-1},SView.prototype.AssemblyDelete=function(e){this.GetSelector().Remove(e),this.view.GetModelManager().Delete(e);this.view.GetSceneManager().GetModel()},SView.prototype.AssemblyAdd=function(e){return this.AssemblyOpenFile(e)},SView.prototype.AssemblyMoveTo=function(e,t){var r=this.view.GetModelManager().MoveTo(e,t);return this.UpdateSceneBox(),r},SView.prototype.AssemblyCopyTo=function(e,t,r){var i=new M3D.Model;return i=this.view.GetModelManager().CopyTo(e,t),this.updateAssemblyTree(i[1]),this.UpdateSceneBox(),i[0]},SView.prototype.Move=function(e,t){return this.view.GetModelManager().Move(e,t)},SView.prototype.AssemblyRename=function(e,t){return this.view.GetModelManager().ReName(e,t)},SView.prototype.AssemblyOpenFile=function(i){var t=this;this.view.GetSelector().SetListeners(this.selectorListeners);var e=M3D.FileHelper.GetSuffix(i[0].name);if("zip"===e||"svp"===e||"zsvl"===e){var r=new FileReader,n=this;return r.addEventListener("load",function(e){var t=e.target.result,r=new JSZip(t);n.AssemblyOpenZipFile(r,"","")},!1),r.readAsBinaryString(i[0]),"OK"}if("svlx"===e){var o=new FileReader,a=this;return o.addEventListener("load",function(e){var t=e.target.result,r=new JSZip(t);a.AssemblyOpenZipFile(r,i[0].name,"svlx")},!1),o.readAsArrayBuffer(i[0]),"OK"}var s=M3D.Reader.GetReader(i),l=s[0];if(null==l)return s[1];l.SetView(this.view);var h=new M3D.ReadListener;h.onReadEnd=function(e){e.GetModel();t.readEnd(),t.RemoveReadListener(h)},this.AddReadListener(h),l.SetListeners(this.readListeners);i[0].name;var u,p,c=new FileReader,d=new FileReader,S=!0;return l instanceof M3D.JSvlReader?(c.addEventListener("load",function(e){var t=e.target;u=t.result},!1),d.addEventListener("load",function(e){var t=e.target;p=t.result;l.ReadJSvl(u,p)},!1),c.readAsText(i[0]),d.readAsBinaryString(i[1])):l instanceof M3D.StlReader?(c.addEventListener("load",function(e){var t=e.target.result,r=l,i=r.ensureBinary(t);if(!r.isBinary(i)){S=!1;r.parseASCII(r.ensureString(t))}},!1),d.addEventListener("load",function(e){if(S){var t=e.target.result,r=l,i=r.ensureBinary(t);if(r.isBinary(i))r.parseBinary(i)}},!1),c.readAsText(i[0]),d.readAsBinaryString(i[0])):(c.addEventListener("load",function(e){var t=e.target.result;l.ReadFile(t)},!1),c.readAsText(i[0])),"OK"},SView.prototype.AppendOpenZipFile=function(e,t,r){if("svlx"===r){var o=this;this.view.GetSelector().SetListeners(this.selectorListeners);var a=new M3D.ReadListener;a.onReadEnd=function(e){var t=e.GetModel();o.view.ReadModel(t),o.readEnd(),M3D.SimulationAnimationManager.Instance().view=o.view;var r=e.getChildAnimation();M3D.SimulationAnimationManager.Instance().SetChildSAManagerStr(r);var i=e.getAnimation();if(i){var n=i.indexOf("<");i=i.substr(n),M3D.SimulationAnimationManager.Instance().ProcessXMLData(o.ParseXmlString(i))}o.RemoveReadListener(a)},this.AddReadListener(a),(c=new M3D.SvlxReader).SetView(this.view),c.readNextListener=this.readNextListener,c.readModelListener=this.readModelListener,c.SetListeners(this.readListeners),c.OpenZipModel(e)}else{"svl"==r&&(r="jsvl"),this.view.GetSceneManager().GetResourceManager().SetZipFile(e);var i=this,n=this.GetNeedReadFile(e,t,r);if(null==n[0])return;var s=n[0];r=n[4],this.view.GetSelector().SetListeners(this.selectorListeners),this.curFileName=t;var l=new M3D.ReadListener;l.onSingleFileReadEnd=function(e){var t=e.GetModel(),r=i.view.GetSceneManager().GetModel();i.view.GetModelManager().AddTo(t,r,void 0)},this.AddReadListener(l);if("stl"==r){var h=new M3D.StlReader;h.SetView(this.view),h.SetListeners(this.readListeners),h.readNextListener=this.readNextListener;var u=h.ensureBinary(s.asBinary());h.isBinary(u)?h.parseBinary(u):h.parseASCII(h.ensureString(s.asText()))}else if("jsvl"==r){M3D.SimulationAnimationManager.Instance().view=this.view,(c=new M3D.JSvlReader).SetView(this.view),c.readNextListener=this.readNextListener,c.SetListeners(this.readListeners);var p=n[1];c.ReadJSvl(s.asText(),p.asBinary())}else if("obj"==r){var c;(c=new M3D.ObjReader).SetView(this.view),c.readNextListener=this.readNextListener,c.SetListeners(this.readListeners),c.ReadFile(s.asText())}}},SView.prototype.AssemblyOpenZipFile=function(e,t,r){if("svlx"===r){var i=this;this.view.GetSelector().SetListeners(this.selectorListeners);var n=new M3D.ReadListener,o=i.view.GetSelector().Get();this.view.GetSceneManager().GetModelFillManager().openFileEnd=function(){i.RestoreView(),i.addAssemblyOver()},n.onReadEnd=function(e){var t=e.GetModel();t.SetModelExtInfo(i.view.GetSceneManager().GetExtendInfoManager(),!0);i.view.GetSceneManager().GetModel();i.view.GetModelManager().AddTo(t,o,void 0);i.view.GetSceneManager().GetModel();i.view.GetSceneManager().GetSceneBox().Clear(),i.readEnd(),i.updateAssemblyTree(t),i.RemoveReadListener(n)},this.AddReadListener(n),(S=new M3D.SvlxReader).SetView(this.view),S.readNextListener=this.readNextListener,S.readModelListener=this.readModelListener,S.SetListeners(this.readListeners),S.OpenZipModel(e),S.currentFilesName=t}else{"svl"==r&&(r="jsvl"),this.view.GetSceneManager().GetResourceManager().SetZipFile(e);var a=this,s=this.GetNeedReadFile(e,t,r);if(null==s[0])return;var l=s[0];r=s[4],this.view.GetSelector().SetListeners(this.selectorListeners),this.curFileName=t;var h=new M3D.ReadListener,u=a.view.GetSelector().Get();h.onReadEnd=function(e){var t=e.GetModel();a.view.GetSceneManager().GetModel();a.view.GetModelManager().AddTo(t,u,void 0);a.view.GetSceneManager().GetModel();a.view.GetSceneManager().GetSceneBox().Clear(),a.readEnd(),a.updateAssemblyTree(t),a.RemoveReadListener(h),a.addAssemblyOver(),t.SetModelExtInfo(a.view.GetSceneManager().GetExtendInfoManager(),!0)},this.AddReadListener(h);if("stl"==(r=r.toLowerCase())){var p=new M3D.StlReader;p.SetListeners(this.readListeners),p.SetView(this.view);var c=p.ensureBinary(l.asBinary());p.isBinary(c)?p.parseBinary(c):p.parseASCII(p.ensureString(l.asText())),p.currentFilesName=l.name}else if("jsvl"==r){M3D.SimulationAnimationManager.Instance().view=this.view,(S=new M3D.JSvlReader).SetView(this.view),S.SetListeners(this.readListeners);var d=s[1];S.ReadJSvl(l.asText(),d.asBinary()),S.currentFilesName=l.name}else if("obj"==r){var S;(S=new M3D.ObjReader).SetView(this.view),S.SetListeners(this.readListeners),S.ReadFile(l.asText()),S.currentFilesName=l.name}}},SView.prototype.setIsFrameSelect=function(e){this.isFrameSelect=e},SView.prototype.onMouseDown=function(e){var t=this;if(this.onSViewMouseDown(),this.showRightMenu=!1,0<this.view.sceneManager.rotationCenterId&&this.view.usingTouchHandlerType!==M3D.TouchHandlerType.HANDLER_WALKTHROUGH&&this.view.sceneManager.GetShape(this.view.sceneManager.rotationCenterId).SetVisible(!0),1==this.isShowTextNoteAlert)return!1;if(this.longTouchMenu=!1,this.singleClickFlag=!1,1===this.checkButton(e)){e.ctrlKey&&null==this.GetCommandManager().GetCurCommand()&&(this.isCanvace2Dsingle||this.GetSelector().Clear(),this.setIsFrameSelect(!0),this.isFrameSelctState=!0,this._firstLocation=this.GetClientPnt(e).Clone()),this.isFrameSelect&&this.DrawSelectRectangle();var r=this.GetClientPnt(e);this.closeRightMenu(e),0==this.timeOutEvent&&(this.isSinglePoint||this.oneFinger)&&(this.timeOutEvent=window.setTimeout(function(){t.press(e)},1e3)),0==this.timeOutEventForMove&&(this.isSinglePoint||this.oneFinger)&&(this.timeOutEventForMove=window.setTimeout(function(){t.longTouchMove()},500));var i=(new Date).getTime();if(Number(i.toString())-Number(this.lastMouseTime.toString())<300){var n=new M3D.Vector2(this.touchStartPoints[0],this.touchStartPoints[1]),o=new M3D.Vector2(r.x,r.y);n.Sub(o).Length()<50&&(this.isDbTouch=!0,console.log("doubleTouch!"),clearTimeout(this.timeOutEvent),this.timeOutEvent=0,clearTimeout(this.timeOutEventForMove),this.timeOutEventForMove=0)}if(this.lastMouseTime=i,(a=new SView_1.MotionEvent(e,r.x,r.y)).setEventType(SView_1.TOUCH_MASK.TOUCH_DOWN),a.setTouchCount(1),this.OnCommandTouchHandle(this,a))return;this.lastMousePosition=new M3D.Vector2(r.x,r.y),this.touchPnts[0]=r.x,this.touchPnts[1]=r.y,this.mouseDownPoints[0]=this.touchPnts[0],this.mouseDownPoints[1]=this.touchPnts[1],this.downPnts[0]=r.x,this.downPnts[1]=r.y,this.view.TouchDown(this.touchPnts,1),this.touchStartPoints[0]=r.x,this.touchStartPoints[1]=r.y,this.touchDown=!0,null==this.configJson||null==this.configJson?this.isPickUp=!0:"left"===this.configJson.pc.pickup&&(this.isPickUp=!0),this.singleClickFlag=!0,!this.view.commonTouchHandler.freeViewMode&&this.view.sceneManager.conRotationCenterId||this.view.usingTouchHandlerType===M3D.TouchHandlerType.HANDLER_WALKTHROUGH||this.view.SetRotationCenter(r.x,r.y),this.view.sceneManager.conRotationCenterId!==this.view.sceneManager.rotationCenterId&&this.view.usingTouchHandlerType!==M3D.TouchHandlerType.HANDLER_WALKTHROUGH&&this.view.SetRotationCenter(r.x,r.y)}else if(4===this.checkButton(e)){clearTimeout(this.timeOutEvent),this.timeOutEvent=0,clearTimeout(this.timeOutEventForMove),this.timeOutEventForMove=0,this.isWheelPressing=!0;r=this.GetClientPnt(e);if((a=new SView_1.MotionEvent(e,r.x,r.y)).setEventType(SView_1.TOUCH_MASK.TOUCH_DOWN),a.setTouchCount(1),this.OnCommandTouchHandle(this,a))return;this.lastMousePosition=new M3D.Vector2(r.x,r.y),this.touchPnts[0]=r.x,this.touchPnts[1]=r.y,this.mouseDownPoints[0]=this.touchPnts[0],this.mouseDownPoints[1]=this.touchPnts[1],this.downPnts[0]=r.x,this.downPnts[1]=r.y,this.touchDown=!0,null==this.configJson&&null==this.configJson||"wheelkey"===this.configJson.pc.pickup&&(this.isPickUp=!0),this.singleClickFlag=!0,this.view.TouchDown(this.touchPnts,1)}else if(2===this.checkButton(e)){clearTimeout(this.timeOutEvent),this.timeOutEvent=0,clearTimeout(this.timeOutEventForMove),this.timeOutEventForMove=0,e.ctrlKey&&null==this.GetCommandManager().GetCurCommand()&&(this.isCanvace2Dsingle||this.GetSelector().Clear(),this.setIsFrameSelect(!0),this.isFrameSelctState=!0,this._firstLocation=this.GetClientPnt(e).Clone()),this.isFrameSelect&&this.DrawSelectRectangle();var a;r=this.GetClientPnt(e);if((a=new SView_1.MotionEvent(e,r.x,r.y)).setEventType(SView_1.TOUCH_MASK.TOUCH_DOWN),a.setTouchCount(1),this.OnCommandTouchHandle(this,a))return;this.lastMousePosition=new M3D.Vector2(r.x,r.y),this.touchPnts[0]=r.x,this.touchPnts[1]=r.y,this.mouseDownPoints[0]=this.touchPnts[0],this.mouseDownPoints[1]=this.touchPnts[1],this.downPnts[0]=r.x,this.downPnts[1]=r.y,this.view.TouchDown(this.touchPnts,1),this.touchDown=!0,null==this.configJson&&null==this.configJson||"right"===this.configJson.pc.pickup&&(this.isPickUp=!0),this.singleClickFlag=!0}this.isControlDown=!0,this.Refresh()},SView.prototype.onMouseMove=function(e){if(this.onSViewMouseMove(),this.isControlDown){if(1===this.checkButton(e)){if(this.isFrameSelect&&this.DrawSelectRectangle(),this.touchDown){var t=this.GetClientPnt(e);if(this.lastMousePosition.x===t.x&&this.lastMousePosition.x===t.y)return;if((a=new SView_1.MotionEvent(e,t.x,t.y)).setEventType(SView_1.TOUCH_MASK.TOUCH_MOVE),a.setTouchCount(1),this.OnCommandTouchHandle(this,a))return;this.touchPnts[0]=t.x,this.touchPnts[1]=t.y;var r=new M3D.Vector2(this.mouseDownPoints[0],this.mouseDownPoints[1]),i=new M3D.Vector2(this.touchPnts[0],this.touchPnts[1]);1e-5<r.Sub(i).Length()&&(this.singleClickFlag=!1,clearTimeout(this.timeOutEvent),this.timeOutEvent=0,clearTimeout(this.timeOutEventForMove),this.timeOutEventForMove=0),this.oneFinger?"rotating"===this.configJson.onefinger.operation?this.view.TouchMove(this.OperaType,this.touchPnts,1):"traslation"===this.configJson.onefinger.operation?this.view.TouchMove(2,this.touchPnts,1):"zoom"===this.configJson.onefinger.operation&&this.moveOperating(e,t):this.isSinglePoint?this.mouseSingleOperat(e,t):null==this.configJson||null==this.configJson?this.view.TouchMove(this.OperaType,this.touchPnts,1):"left"===this.configJson.pc.rotating?this.view.TouchMove(this.OperaType,this.touchPnts,1):"left"===this.configJson.pc.traslation?this.view.TouchMove(2,this.touchPnts,1):"left"===this.configJson.pc.zoom&&this.moveOperating(e,t),this.lastMousePosition=t.Clone()}this.SendMoving()}else if(4===this.checkButton(e)){if(this.touchDown){this.isWheelPressing=!0;t=this.GetClientPnt(e);if(this.lastMousePosition.x===t.x&&this.lastMousePosition.x===t.y)return;if((a=new SView_1.MotionEvent(e,t.x,t.y)).setEventType(SView_1.TOUCH_MASK.TOUCH_MOVE),a.setTouchCount(1),this.OnCommandTouchHandle(this,a))return;this.touchPnts[0]=t.x,this.touchPnts[1]=t.y;r=new M3D.Vector2(this.mouseDownPoints[0],this.mouseDownPoints[1]),i=new M3D.Vector2(this.touchPnts[0],this.touchPnts[1]);if(1e-5<r.Sub(i).Length()&&(this.singleClickFlag=!1,clearTimeout(this.timeOutEvent),this.timeOutEvent=0,clearTimeout(this.timeOutEventForMove),this.timeOutEventForMove=0),null==this.configJson||null==this.configJson){var n=this.width,o=(this.height,.001*n);this.touchPnts[0]=t.x+o,this.touchPnts[1]=t.y+o,this.view.TouchMove(2,this.touchPnts,1)}else"wheelkey"===this.configJson.pc.rotating?this.view.TouchMove(this.OperaType,this.touchPnts,1):"wheelkey"===this.configJson.pc.traslation?this.view.TouchMove(2,this.touchPnts,1):"wheelkey"===this.configJson.pc.zoom&&this.moveOperating(e,t)}this.SendMoving()}else if(2===this.checkButton(e)){if(this.touchDown){var a;t=this.GetClientPnt(e);if(this.lastMousePosition.x===t.x&&this.lastMousePosition.x===t.y)return;if((a=new SView_1.MotionEvent(e,t.x,t.y)).setEventType(SView_1.TOUCH_MASK.TOUCH_MOVE),a.setTouchCount(1),this.OnCommandTouchHandle(this,a))return;this.touchPnts[0]=t.x,this.touchPnts[1]=t.y;r=new M3D.Vector2(this.mouseDownPoints[0],this.mouseDownPoints[1]),i=new M3D.Vector2(this.touchPnts[0],this.touchPnts[1]);1e-5<r.Sub(i).Length()&&(this.singleClickFlag=!1,clearTimeout(this.timeOutEvent),this.timeOutEvent=0,clearTimeout(this.timeOutEventForMove),this.timeOutEventForMove=0),null==this.configJson||null==this.configJson||("right"===this.configJson.pc.rotating?this.view.TouchMove(this.OperaType,this.touchPnts,1):"right"===this.configJson.pc.traslation?this.view.TouchMove(2,this.touchPnts,1):"right"===this.configJson.pc.zoom&&this.moveOperating(e,t))}this.SendMoving()}this.Refresh(),this.view.commonTouchHandler.twoOperateType=M3D.TwoOperateType.all}},SView.prototype.moveOperating=function(e,t){var r=this.width;this.height;e.preventDefault(),e.stopPropagation();var i=.1*r,n=0;n="up"===this.configJson.pc.zoombearing?1+.01*(this.downPnts[1]-this.touchPnts[1]):"down"===this.configJson.pc.zoombearing?1-.01*(this.downPnts[1]-this.touchPnts[1]):"left"===this.configJson.pc.zoombearing?1+.01*(this.downPnts[0]-this.touchPnts[0]):1-.01*(this.downPnts[0]-this.touchPnts[0]),this.isSinglePoint&&(n="up"===this.configJson.singletouch.zoombearing?1+.01*(this.downPnts[1]-this.touchPnts[1]):"down"===this.configJson.singletouch.zoombearing?1-.01*(this.downPnts[1]-this.touchPnts[1]):"left"===this.configJson.singletouch.zoombearing?1+.01*(this.downPnts[0]-this.touchPnts[0]):1-.01*(this.downPnts[0]-this.touchPnts[0])),this.oneFinger&&(n="up"===this.configJson.onefinger.zoombearing?1+.01*(this.downPnts[1]-this.touchPnts[1]):"down"===this.configJson.onefinger.zoombearing?1-.01*(this.downPnts[1]-this.touchPnts[1]):"left"===this.configJson.onefinger.zoombearing?1+.01*(this.downPnts[0]-this.touchPnts[0]):1-.01*(this.downPnts[0]-this.touchPnts[0])),this.touchPnts[0]=this.mouseDownPoints[0]+i,this.touchPnts[1]=this.mouseDownPoints[1]+i,this.touchPnts[2]=this.mouseDownPoints[0]-i,this.touchPnts[3]=this.mouseDownPoints[1]-i,this.touchPnts[4]=t.x,this.touchPnts[5]=t.y,this.view.workTouchHandler.HandleDragger([t.x,t.y],0,M3D.TouchHandler.TOUCHMOVE,0)||(this.view.TouchDown(this.touchPnts,2),this.touchPnts[0]=this.mouseDownPoints[0]+i*n,this.touchPnts[1]=this.mouseDownPoints[1]+i*n,this.touchPnts[2]=this.mouseDownPoints[0]-i*n,this.touchPnts[3]=this.mouseDownPoints[1]-i*n,this.touchPnts[4]=t.x,this.touchPnts[5]=t.y,this.view.TouchMove(3,this.touchPnts,2),this.view.TouchMove(3,this.touchPnts,2),this.downPnts[0]=t.x,this.downPnts[1]=t.y)},SView.prototype.mouseSingleOperat=function(e,t){this.isLongTouch?null==this.configJson||null==this.configJson?this.moveOperating(e,t):"longtouch"===this.configJson.singletouch.rotating?this.view.TouchMove(this.OperaType,this.touchPnts,1):"longtouch"===this.configJson.singletouch.traslation?this.view.TouchMove(2,this.touchPnts,1):"longtouch"===this.configJson.singletouch.zoom&&this.moveOperating(e,t):this.isDbTouch?null==this.configJson||null==this.configJson?this.view.TouchMove(2,this.touchPnts,1):"dbtouch"===this.configJson.singletouch.rotating?this.view.TouchMove(this.OperaType,this.touchPnts,1):"dbtouch"===this.configJson.singletouch.traslation?this.view.TouchMove(2,this.touchPnts,1):"dbtouch"===this.configJson.singletouch.zoom&&this.moveOperating(e,t):null==this.configJson||null==this.configJson?this.view.TouchMove(this.OperaType,this.touchPnts,1):"touch"===this.configJson.singletouch.rotating?this.view.TouchMove(this.OperaType,this.touchPnts,1):"touch"===this.configJson.singletouch.traslation?this.view.TouchMove(2,this.touchPnts,1):"touch"===this.configJson.singletouch.zoom&&this.moveOperating(e,t)},SView.prototype.SetIsMultiSelect=function(e){this.isMultiSelect=e},SView.prototype.OnExecute=function(e,t){var r=this.view.GetPickShape(e,t,M3D.ShapeType.SHAPE_MODEL,0);if(r&&(r.GetType()===M3D.ShapeType.SHAPE_MODEL||r.GetType()===M3D.ShapeType.SHAPE_IMAGE_MODEL||r.GetType()===M3D.ShapeType.SHAPE_ANNOTATION_NOTE)){var i,n,o=[];if(r.GetType()===M3D.ShapeType.SHAPE_MODEL){var a=r;o=SView_1.LinkManager.Instance().GetLink(a.GetSVLPath(),a.GetWorldTransform().Translation())}else if(r.GetType()===M3D.ShapeType.SHAPE_IMAGE_MODEL){var s="Image:"+(a=r).GetID();o=SView_1.LinkManager.Instance().GetLink(s,a.GetWorldTransform().Translation())}else if(r.GetType()===M3D.ShapeType.SHAPE_ANNOTATION_NOTE){s="Note:"+(a=r).GetCreateID();o=SView_1.LinkManager.Instance().GetLink(s)}if(!o||o.length<=0)return;for(var l=0,h=o;l<h.length;l++){(d=h[l]).action instanceof SView_1.LinkStoryAction&&(i=d),d.action instanceof SView_1.LinkOpenAniAction&&(n=d)}if(i&&n){var u=this;i.action.ShowLastLinkStoryListener=function(){u.OnAniLinkExecute(n,i)},i.onExecute()}else for(var p=0,c=o;p<c.length;p++){var d;(d=c[p]).onExecute()}}},SView.prototype.OnAniLinkExecute=function(e,t){e.onExecute(),t.action.ShowLastLinkStoryListener=null},SView.prototype.UnExecute=function(){SView_1.LinkManager.Instance().ClearStoryLinkViews(),this.view.ShowLinkStoryListener=null,this.view.StopModelViewAnimation(),this.exitAnimation()},SView.prototype.SelectShape=function(e,t){var r=this.view.GetSelector(),i=(r.Get(),this.view.GetPickShape(e,t,this.PickShapeType,0));if(null!==i){if(i.IsSelected())this.isFrameSelctState?(r.Clear(),this.SHotSpotDescribeListener(""),this.isFrameSelctState=!1):(r.Remove(i),this.SHotSpotDescribeListener(""));else if(M3D.Parameters.Instance().IsMulSelect||(r.Clear(),this.SHotSpotDescribeListener("")),i.IsVisible()&&i.GetSelectAble()&&(r.Add(i),this._isAixsCommand&&this.buttonBindAixs(),this._isRotationCommand&&this.buttonBindRotation(),i instanceof M3D.ImageModel))for(var n=0,o=SView_1.SHotSpotManager.Instance().GetAllHotSpotList();n<o.length;n++){var a=o[n];i===a.GetHotSpotImage()&&a.onExecute()}}else r.Clear(),this.SHotSpotDescribeListener("")},SView.prototype.SelectModels=function(e){for(var t=this.view.GetSelector(),r=0;r<e.length;r++)t.Add(e[r])},SView.prototype.SelectShapes=function(e,t){for(var r=this.view.GetSelector(),i=0;i<e.length;i++)e[i].GetType()===t&&r.Add(e[i])},SView.prototype.GetSelectedModels=function(){return this.view.GetSelector().GetAll()},SView.prototype.GetSelectedShapes=function(e){for(var t=this.view.GetSelector().GetAll(),r=[],i=0;i<t.length;i++)t[i].GetType()==e&&r.push(t[i]);return r},SView.prototype.DeselectModels=function(e){var t=this.view.GetSelector();if(e)for(var r=0;r<e.length;r++)t.Remove(e[r]);else t.Clear()},SView.prototype.DeselectShapes=function(e,t){for(var r=this.view.GetSelector(),i=0;i<e.length;i++)e[i].GetType()==t&&r.Remove(e[i])},SView.prototype.PickShape=function(e,t){var r=this.view.GetSelector(),i=(r.Get(),this.view.GetPickShape(e,t,this.PickShapeType,0));if(null!==i){if(i.IsSelected())this.isFrameSelctState?(r.Clear(),this.SHotSpotDescribeListener(""),this.isFrameSelctState=!1):(r.Remove(i),this.SHotSpotDescribeListener(""));else if(M3D.Parameters.Instance().IsMulSelect||this.SHotSpotDescribeListener(""),i.IsVisible()&&i.GetSelectAble()&&(this._isAixsCommand&&this.buttonBindAixs(),this._isRotationCommand&&this.buttonBindRotation(),i instanceof M3D.ImageModel))for(var n=0,o=SView_1.SHotSpotManager.Instance().GetAllHotSpotList();n<o.length;n++){var a=o[n];i===a.GetHotSpotImage()&&a.onExecute()}}else r.Clear(),this.SHotSpotDescribeListener("")},SView.prototype.onMouseUp=function(e){if(!this.joyStickOption.isJoysticPressing){if(this.onSViewMouseUp(),this.isControlDown=!1,this.isWheelPressing=!1,this.isFrameSelect=!1,clearTimeout(this.timeOutEvent),this.timeOutEvent=0,clearTimeout(this.timeOutEventForMove),(this.timeOutEventForMove=0)<this.view.sceneManager.rotationCenterId&&this.view.sceneManager.GetShape(this.view.sceneManager.rotationCenterId).SetVisible(!1),this.isLongTouch=!1,0===this.checkButton(e)||1===this.checkButton(e)){var t=this.GetClientPnt(e);if((o=new SView_1.MotionEvent(e,t.x,t.y)).setEventType(SView_1.TOUCH_MASK.TOUCH_UP),o.setTouchCount(1),this.touchDown=!1,this.singleClickFlag&&this.OnCommandTouchHandle(this,o))return;if(this.touchPnts[0]=t.x,this.touchPnts[1]=t.y,this.isDbTouch){var r=this.view.GetPickShape(t.x,t.y,M3D.ShapeType.SHAPE_MODEL,0);r&&r.GetType()===M3D.ShapeType.SHAPE_MODEL?this.DoubleTouchListener(r.GetSVLPath()):this.DoubleTouchListener(null)}this.view.TouchUp(this.touchPnts,1),!this.choiceSwitch&&this.singleClickFlag&&this.OnExecute(t.x,t.y),this.singleClickFlag&&this.isPickUp&&0==this.showRightMenu&&null==this.GetCommandManager().GetCurCommand()&&this.choiceSwitch&&(this.SelectShape(t.x,t.y),this.clickUp=!0)}else if(4===this.checkButton(e)){t=this.GetClientPnt(e);this.lastMousePosition=new M3D.Vector2(t.x,t.y);var i=this.width,n=(this.height,.001*i);this.touchPnts[0]=t.x+n,this.touchPnts[1]=t.y+n,this.touchPnts[2]=t.x-n,this.touchPnts[3]=t.y-n,this.view.TouchUp(this.touchPnts,2),this.touchDown=!1,this.singleClickFlag&&this.isPickUp&&0==this.showRightMenu&&null==this.GetCommandManager().GetCurCommand()&&this.choiceSwitch&&this.SelectShape(t.x,t.y),this.Refresh(),this.singleClickFlag=!1}else if(2===this.checkButton(e)){var o;t=this.GetClientPnt(e);if((o=new SView_1.MotionEvent(e,t.x,t.y)).setEventType(SView_1.TOUCH_MASK.TOUCH_UP),o.setTouchCount(1),this.singleClickFlag&&this.OnCommandTouchHandle(this,o))return;this.touchPnts[0]=t.x,this.touchPnts[1]=t.y,this.view.TouchUp(this.touchPnts,1),this.touchDown=!1,this.singleClickFlag&&this.isPickUp&&0==this.showRightMenu&&null==this.GetCommandManager().GetCurCommand()&&this.choiceSwitch&&this.SelectShape(t.x,t.y)}this.isDbTouch=!1,this.touchPnts=new Array(10),this.isShowRightMenu(!1),this.isPickUp=!1}},SView.prototype.GetClientPnt=function(e){var t=new M3D.Vector2;return t.x=e.offsetX*this.deviceRatio,t.y=e.offsetY*this.deviceRatio,t},SView.prototype.onMouseWheel=function(e){if(this.touchDown)return e.preventDefault(),!1;M3D.Parameters.Instance().IsConRotate&&this.view.CloseSceneAnimation();var t=this.width;this.height;if(e.preventDefault(),e.stopPropagation(),this.isWheelPressing)return!1;var r=this.GetClientPnt(e);this.view.commonTouchHandler.freeViewMode||this.view.usingTouchHandlerType===M3D.TouchHandlerType.HANDLER_WALKTHROUGH||this.view.SetRotationCenter(r.x,r.y);var i=1;e.wheelDelta?i=1-5e-4*e.wheelDelta:e.detail&&(i=1+.01*e.detail);var n=.1*t;this.touchPnts[0]=r.x+n,this.touchPnts[1]=r.y+n,this.touchPnts[2]=r.x-n,this.touchPnts[3]=r.y-n,this.view.TouchDown(this.touchPnts,2),this.touchPnts[0]=r.x+n*i,this.touchPnts[1]=r.y+n*i,this.touchPnts[2]=r.x-n*i,this.touchPnts[3]=r.y-n*i,this.view.TouchMove(SView.TOUCH_NORMAL,this.touchPnts,2),this.view.TouchMove(SView.TOUCH_NORMAL,this.touchPnts,2),this.SendMoving(),this.Refresh(),this.onSViewMouseMove()},SView.prototype.Refresh=function(){this.view.GetSceneManager().GetRenderManager().RequestRedraw()},SView.prototype.SendMoving=function(){},SView.prototype.OnKeyDown=function(e){this.keyMap[e.keyCode]="keydown"==e.type},SView.prototype.OnKeyUp=function(e){this.keyMap[e.keyCode]="keydown"==e.type},SView.prototype.OnKeyPress=function(e){},SView.prototype.StartFixUpdateTimer=function(){this.fixUpdateTimer.IsStart()&&this.fixUpdateTimer.StopTimer(),this.fixUpdateTimer.StartTimer(),this.fixUpdateTimer.SetTimer(this.FixUpdate,this,this.fixUpdateInterval)},SView.prototype.StopFixUpdateTimer=function(){this.fixUpdateTimer.IsStart()&&this.fixUpdateTimer.StopTimer()},SView.prototype.FixUpdate=function(e){(0==e.lastTicks||1e4<(new Date).getTime()-e.lastTicks)&&(e.lastTicks=(new Date).getTime());var t=(new Date).getTime()-e.lastTicks;(e.lastTicks=(new Date).getTime(),null!=e.view)&&(e.view.GetTouchHandler()instanceof M3D.WalkthroughHandler&&e.HandleWalkThrough(t))},SView.prototype.HandleWalkThrough=function(e){var t=this.view.GetTouchHandler();if(!(t instanceof M3D.WalkthroughHandler))return!0;var r=t;this.keyMap[87]&&r.MoveStraight(1),this.keyMap[83]&&r.MoveStraight(-1),this.keyMap[65]&&r.MoveSideways(1),this.keyMap[68]&&r.MoveSideways(-1),this.keyMap[81]&&r.MoveUpAndDown(1),this.keyMap[69]&&r.MoveUpAndDown(-1)},SView.prototype.GetTouchClientPnt=function(e){var t=new M3D.Vector2;return t.x=e[0].pageX-this.renderCanvas.offsetLeft,t.y=e[0].pageY-this.renderCanvas.offsetTop,t},SView.prototype.scaleToDeviceRatio=function(e){e.x=e.x*this.deviceRatio,e.y=e.y*this.deviceRatio},SView.prototype.force=function(e){1!=e.changedTouches[0].force||this.showRightMenu||this.press(e)},SView.prototype.press=function(e){this.timeOutEvent=0,this.showRightMenuInIos(e),this.isShowRightMenu(!0),this.isLongTouch=!1,clearTimeout(this.timeOutEventForMove),this.timeOutEventForMove=0},SView.prototype.closeRightMenu=function(e){this.CloseRightMenuInIos(e)},SView.prototype.longTouchMove=function(){this.isLongTouch=!0,this.longTouchMenu=!0},SView.prototype.isShowRightMenu=function(e){this.showRightMenu=e},SView.prototype.touchstart=function(e){var t=this;this.singleClickFlag=!1,e.preventDefault(),e.stopPropagation();window.hasOwnProperty("PointerEvent");switch(e.touches.length){case 1:this.showRightMenu=!1,this.longTouchMenu=!1,this.CloseRightMenuInIos(e),0==this.timeOutEvent&&(this.timeOutEvent=window.setTimeout(function(){t.press(e)},1e3)),0==this.timeOutEventForMove&&(this.timeOutEventForMove=window.setTimeout(function(){t.longTouchMove()},500));var r=new M3D.Vector2;r.x=e.touches[0].pageX-this.getOffsetLeftToBody(this.renderCanvas),r.y=e.touches[0].pageY-this.getOffsetTopToBody(this.renderCanvas),this.scaleToDeviceRatio(r);var i=(new Date).getTime();if(Number(i.toString())-Number(this.lastTouchTime.toString())<300){var n=new M3D.Vector2(this.touchStartPoints[0],this.touchStartPoints[1]),o=new M3D.Vector2(r.x,r.y);n.Sub(o).Length()<50&&(this.isDbTouch=!0,console.log("doubleTouch!"),clearTimeout(this.timeOutEvent),this.timeOutEvent=0,clearTimeout(this.timeOutEventForMove),this.timeOutEventForMove=0)}this.lastTouchTime=i;var a=new SView_1.MotionEvent(e,r.x,r.y);if(a.setEventType(SView_1.TOUCH_MASK.TOUCH_DOWN),a.setTouchCount(1),this.OnCommandTouchHandle(this,a))return;this.lastMousePosition=new M3D.Vector2(r.x,r.y),this.touchPnts[0]=r.x,this.touchPnts[1]=r.y,this.mouseDownPoints[0]=this.touchPnts[0],this.mouseDownPoints[1]=this.touchPnts[1],this.downPnts[0]=r.x,this.downPnts[1]=r.y,this.touchStartPoints[0]=r.x,this.touchStartPoints[1]=r.y,this.view.TouchDown(this.touchPnts,1),this.touchDown=!0,this.singleClickFlag=!0;break;case 2:clearTimeout(this.timeOutEvent),this.timeOutEvent=0,clearTimeout(this.timeOutEventForMove),this.timeOutEventForMove=0;var s=new M3D.Vector2,l=new M3D.Vector2;s.x=e.touches[0].pageX-this.getOffsetLeftToBody(this.renderCanvas),s.y=e.touches[0].pageY-this.getOffsetTopToBody(this.renderCanvas),l.x=e.touches[1].pageX-this.getOffsetLeftToBody(this.renderCanvas),l.y=e.touches[1].pageY-this.getOffsetLeftToBody(this.renderCanvas),this.scaleToDeviceRatio(s),this.scaleToDeviceRatio(l),this.touchPnts[0]=s.x,this.touchPnts[1]=s.y,this.touchPnts[2]=l.x,this.touchPnts[3]=l.y,this.touchDown=!0,this.view.TouchDown(this.touchPnts,2)}},SView.prototype.touchmove=function(e){e.preventDefault(),e.stopPropagation(),this.touchDown&&console.log("Listener:TouchMoveLisener--------------"+e.touches.length);window.hasOwnProperty("PointerEvent");switch(e.touches.length){case 1:if(this.touchDown){clearTimeout(this.timeOutEvent),this.timeOutEvent=0,clearTimeout(this.timeOutEventForMove),this.timeOutEventForMove=0;var t=new M3D.Vector2;if(t.x=e.touches[0].pageX-this.getOffsetLeftToBody(this.renderCanvas),t.y=e.touches[0].pageY-this.getOffsetTopToBody(this.renderCanvas),this.scaleToDeviceRatio(t),this.lastMousePosition.x===t.x&&this.lastMousePosition.x===t.y)return;var r=new SView_1.MotionEvent(e,t.x,t.y);if(r.setEventType(SView_1.TOUCH_MASK.TOUCH_MOVE),r.setTouchCount(1),this.OnCommandTouchHandle(this,r))return;var i=new M3D.Vector2(this.touchPnts[0],this.touchPnts[1]),n=new M3D.Vector2(t.x,t.y),o=i.Sub(n).Length();this.touchPnts[0]=t.x,this.touchPnts[1]=t.y,this.oneFinger?"rotating"===this.configJson.onefinger.operation?this.view.TouchMove(this.OperaType,this.touchPnts,1):"traslation"===this.configJson.onefinger.operation?this.view.TouchMove(2,this.touchPnts,1):"zoom"===this.configJson.onefinger.operation&&this.zoomOptionForTouch(e,t):this.isSinglePoint?this.touchSingleOpreation(e,t):this.configJson.phone?"1"===this.configJson.phone.rotating?this.view.TouchMove(this.OperaType,this.touchPnts,1):"1"===this.configJson.phone.traslation?this.view.TouchMove(2,this.touchPnts,1):"1"===this.configJson.phone.zoom&&this.zoomOptionForTouch(e,t):this.view.TouchMove(this.OperaType,this.touchPnts,1),this.lastMousePosition=t.Clone(),1e-5<o&&(this.singleClickFlag=!1,clearTimeout(this.timeOutEvent),this.timeOutEvent=0)}this.SendMoving();break;case 2:clearTimeout(this.timeOutEvent),this.timeOutEvent=0,clearTimeout(this.timeOutEventForMove),this.timeOutEventForMove=0;var a=new M3D.Vector2,s=new M3D.Vector2;a.x=e.touches[0].pageX-this.getOffsetLeftToBody(this.renderCanvas),a.y=e.touches[0].pageY-this.getOffsetTopToBody(this.renderCanvas),s.x=e.touches[1].pageX-this.getOffsetLeftToBody(this.renderCanvas),s.y=e.touches[1].pageY-this.getOffsetTopToBody(this.renderCanvas),this.scaleToDeviceRatio(a),this.scaleToDeviceRatio(s),this.touchPnts[0]=a.x,this.touchPnts[1]=a.y,this.touchPnts[2]=s.x,this.touchPnts[3]=s.y,this.configJson.phone?"2"===this.configJson.phone.rotating&&"2"===this.configJson.phone.traslation&&"2"===this.configJson.phone.zoom?this.view.TouchMove(0,this.touchPnts,2):"2"===this.configJson.phone.rotating&&"2"===this.configJson.phone.traslation?this.view.TouchMove(6,this.touchPnts,2):"2"===this.configJson.phone.rotating&&"2"===this.configJson.phone.zoom?this.view.TouchMove(7,this.touchPnts,2):"2"===this.configJson.phone.traslation&&"2"===this.configJson.phone.zoom?this.view.TouchMove(4,this.touchPnts,2):"2"===this.configJson.phone.rotating?this.view.TouchMove(this.OperaType,this.touchPnts,1):"2"===this.configJson.phone.traslation?this.view.TouchMove(2,this.touchPnts,2):"2"===this.configJson.phone.zoom&&this.view.TouchMove(3,this.touchPnts,2):this.view.TouchMove(0,this.touchPnts,2)}},SView.prototype.zoomOptionForTouch=function(e,t){var r=this.width;this.height;e.preventDefault(),e.stopPropagation();var i=.1*r,n=0;n="up"===this.configJson.phone.zoombearing?1+.01*(this.downPnts[1]-this.touchPnts[1]):"down"===this.configJson.phone.zoombearing?1-.01*(this.downPnts[1]-this.touchPnts[1]):"left"===this.configJson.phone.zoombearing?1+.01*(this.downPnts[0]-this.touchPnts[0]):1-.01*(this.downPnts[0]-this.touchPnts[0]),this.isSinglePoint&&(n="up"===this.configJson.singletouch.zoombearing?1+.01*(this.downPnts[1]-this.touchPnts[1]):"down"===this.configJson.singletouch.zoombearing?1-.01*(this.downPnts[1]-this.touchPnts[1]):"left"===this.configJson.singletouch.zoombearing?1+.01*(this.downPnts[0]-this.touchPnts[0]):1-.01*(this.downPnts[0]-this.touchPnts[0])),this.oneFinger&&(n="up"===this.configJson.onefinger.zoombearing?1+.01*(this.downPnts[1]-this.touchPnts[1]):"down"===this.configJson.onefinger.zoombearing?1-.01*(this.downPnts[1]-this.touchPnts[1]):"left"===this.configJson.onefinger.zoombearing?1+.01*(this.downPnts[0]-this.touchPnts[0]):1-.01*(this.downPnts[0]-this.touchPnts[0])),this.touchPnts[0]=this.mouseDownPoints[0]+i,this.touchPnts[1]=this.mouseDownPoints[1]+i,this.touchPnts[2]=this.mouseDownPoints[0]-i,this.touchPnts[3]=this.mouseDownPoints[1]-i,this.touchPnts[4]=t.x,this.touchPnts[5]=t.y,this.view.workTouchHandler.HandleDragger([t.x,t.y],0,M3D.TouchHandler.TOUCHMOVE,0)||(this.view.TouchDown(this.touchPnts,2),this.touchPnts[0]=this.mouseDownPoints[0]+i*n,this.touchPnts[1]=this.mouseDownPoints[1]+i*n,this.touchPnts[2]=this.mouseDownPoints[0]-i*n,this.touchPnts[3]=this.mouseDownPoints[1]-i*n,this.touchPnts[4]=t.x,this.touchPnts[5]=t.y,this.view.TouchMove(3,this.touchPnts,2),this.view.TouchMove(3,this.touchPnts,2),this.downPnts[0]=t.x,this.downPnts[1]=t.y)},SView.prototype.touchSingleOpreation=function(e,t){this.isLongTouch?null==this.configJson||null==this.configJson?this.zoomOptionForTouch(e,t):"longtouch"===this.configJson.singletouch.rotating?this.view.TouchMove(this.OperaType,this.touchPnts,1):"longtouch"===this.configJson.singletouch.traslation?this.view.TouchMove(2,this.touchPnts,1):"longtouch"===this.configJson.singletouch.zoom&&this.zoomOptionForTouch(e,t):this.isDbTouch?null==this.configJson||null==this.configJson?this.view.TouchMove(2,this.touchPnts,1):"dbtouch"===this.configJson.singletouch.rotating?this.view.TouchMove(this.OperaType,this.touchPnts,1):"dbtouch"===this.configJson.singletouch.traslation?this.view.TouchMove(2,this.touchPnts,1):"dbtouch"===this.configJson.singletouch.zoom&&this.zoomOptionForTouch(e,t):null==this.configJson||null==this.configJson?this.view.TouchMove(this.OperaType,this.touchPnts,1):"touch"===this.configJson.singletouch.rotating?this.view.TouchMove(this.OperaType,this.touchPnts,1):"touch"===this.configJson.singletouch.traslation?this.view.TouchMove(2,this.touchPnts,1):"touch"===this.configJson.singletouch.zoom&&this.zoomOptionForTouch(e,t)},SView.prototype.touchend=function(e){e.preventDefault(),e.stopPropagation();window.hasOwnProperty("PointerEvent");switch(e.changedTouches.length){case 1:clearTimeout(this.timeOutEvent),this.timeOutEvent=0,clearTimeout(this.timeOutEventForMove),this.timeOutEventForMove=0;var t=new M3D.Vector2;t.x=e.changedTouches[0].pageX-this.getOffsetLeftToBody(this.renderCanvas),t.y=e.changedTouches[0].pageY-this.getOffsetTopToBody(this.renderCanvas),this.scaleToDeviceRatio(t);var r=new SView_1.MotionEvent(e,t.x,t.y);if(r.setEventType(SView_1.TOUCH_MASK.TOUCH_UP),r.setTouchCount(1),this.singleClickFlag&&this.OnCommandTouchHandle(this,r))return;if(this.isDbTouch){var i=this.view.GetPickShape(t.x,t.y,M3D.ShapeType.SHAPE_MODEL,0);i&&i.GetType()===M3D.ShapeType.SHAPE_MODEL?this.DoubleTouchListener(i.GetSVLPath()):this.DoubleTouchListener(null)}this.touchPnts[0]=t.x,this.touchPnts[1]=t.y,this.view.TouchUp(this.touchPnts,1),this.touchDown=!1,!this.choiceSwitch&&this.singleClickFlag&&this.OnExecute(t.x,t.y),this.singleClickFlag&&0==this.showRightMenu&&null==this.GetCommandManager().GetCurCommand()&&this.choiceSwitch&&!this.clickUp&&this.SelectShape(t.x,t.y);break;case 2:clearTimeout(this.timeOutEvent),this.timeOutEvent=0,clearTimeout(this.timeOutEventForMove),this.timeOutEventForMove=0;var n=new M3D.Vector2,o=new M3D.Vector2;n.x=e.changedTouches[0].pageX-this.getOffsetLeftToBody(this.renderCanvas),n.y=e.changedTouches[0].pageY-this.getOffsetTopToBody(this.renderCanvas),o.x=e.changedTouches[1].pageX-this.getOffsetLeftToBody(this.renderCanvas),o.y=e.changedTouches[1].pageY-this.getOffsetTopToBody(this.renderCanvas),this.scaleToDeviceRatio(n),this.scaleToDeviceRatio(o),this.touchPnts[0]=n.x,this.touchPnts[1]=n.y,this.touchPnts[2]=o.x,this.touchPnts[3]=o.y,this.view.TouchUp(this.touchPnts,2)}this.isDbTouch=!1,this.isLongTouch=!1,this.touchPnts=new Array(10)},SView.prototype.Draw=function(){this.view.OnDraw()},SView.prototype.resize=function(){null!==this.renderCanvas&&(null!=this.renderCanvas.parentElement&&null!=this.renderCanvas.parentElement?(this.renderCanvas.width=this.renderCanvas.parentElement.offsetWidth*this.deviceRatio,this.renderCanvas.height=this.renderCanvas.parentElement.offsetHeight*this.deviceRatio):SView_1.GetLogger().Error(this,"renderCanvas:resize error"),this.width=this.renderCanvas.width,this.height=this.renderCanvas.height,this.view.WindowSizeChange(this.width,this.height))},SView.prototype.IsPC=function(){for(var e=navigator.userAgent,t=["Android","iPhone","SymbianOS","Windows Phone","iPad","iPod"],r=!0,i=0;i<t.length;i++)if(0<e.indexOf(t[i])){r=!1;break}return r},SView.prototype.InitRenderCavansEventListener=function(){var t=this;if(null!==this.renderCanvas){this.renderCanvas.addEventListener("contextmenu",function(e){e.preventDefault()},!1),this.IsPC()&&this.renderCanvas.addEventListener("mousemove",function(e){return t.onMouseMove(e)},!1);var e=window.hasOwnProperty("PointerEvent");this.IsPC()&&(e?(this.renderCanvas.addEventListener("pointerup",function(e){return t.onMouseUp(e)},!1),this.renderCanvas.addEventListener("pointerdown",function(e){return t.onMouseDown(e)},!1)):(this.renderCanvas.addEventListener("mouseup",function(e){return t.onMouseUp(e)},!1),this.renderCanvas.addEventListener("mousedown",function(e){return t.onMouseDown(e)},!1))),M3D.Parameters.Instance().onMouseWheel&&(this.renderCanvas.addEventListener("mousewheel",function(e){return t.onMouseWheel(e)},!1),this.renderCanvas.addEventListener("DOMMouseScroll",function(e){return t.onMouseWheel(e)},!1)),this.renderCanvas.addEventListener("touchstart",function(e){return t.touchstart(e)},!1),this.renderCanvas.addEventListener("touchend",function(e){return t.touchend(e)},!1),this.renderCanvas.addEventListener("touchmove",function(e){return t.touchmove(e)},!1),this.renderCanvas.addEventListener("touchforcechange",function(e){return t.force(e)},!1),window.addEventListener("keydown",function(e){return t.OnKeyDown(e)},!1),window.addEventListener("keypress",function(e){return t.OnKeyPress(e)},!1),window.addEventListener("keyup",function(e){return t.OnKeyUp(e)},!1),window.addEventListener("resize",this.resize.bind(this),!1),this.resize()}},SView.prototype.closeCavansEventListener=function(e){e?null!==this.renderCanvas&&(this.renderCanvas.style.pointerEvents=""):null!==this.renderCanvas&&(this.renderCanvas.style.pointerEvents="none")},SView.prototype.RestoreView=function(){this.view.startLinkAni&&this.UnExecute(),this.isPlaying&&this.exitAnimation(),this.view.ShowAllAnnotation(),this.view.ShowAllSign(),this.view.RestoreView(),this.CloseClipPlane(),this.ClearExplosive(),this.ClearRotateAndExplosive(),this.onRestoreViewEnd()},SView.prototype.SetPerspective=function(e){this.view.SetPerspective(e)},SView.prototype.AsyOpenRemotes=function(l,h,u){var p=0;if(0<l.length){var c=new M3D.ReadNextListener;this.readNextListener=c;var d=this;this.readNextListener.onReadEnd=function(e){d.readNextListener=null;var t=++p;if(t<l.length&&((d.readNextListener=c).allFilesCount=l.length,c.currentFileIndex=t,c.currentFilesName=M3D.FileHelper.GetFileNameFromUrl(l[t]),d.OpenSingleRemote(l[t],!0,!0,"",u)),t==l.length){var r=new M3D.Model;r.SetName(h);for(var i=0;i<d.mulitFileReadModels.length;i++){var n=d.mulitFileReadModels[i];n.SetPlcId(i),r.AddSubModel(n)}var o=e;o.SetModel(r),d.view.ReadModel(r);for(var a=0,s=d.readListeners;a<s.length;a++){s[a].onReadEnd(o)}}},c.allFilesCount=l.length,c.currentFileIndex=0,c.currentFilesName=M3D.FileHelper.GetFileNameFromUrl(l[0])}return this.OpenSingleRemote(l[0],!0,!0,"",u),null},SView.prototype.OpenSingleRemote=function(e,t,i,n,o){if(t){var a=this,r=new XMLHttpRequest;r.open("GET",e,!0),r.responseType="arraybuffer",r.addEventListener("loadend",function(e){var t=e.target.response,r=new JSZip(t);i?a.OpenZipFileOnlyGetModel(r,n,o):a.OpenZipFile(r,n,o)},!1),r.addEventListener("loadstart",function(e){for(var t=new M3D.LoadingEvent,r=0,i=a.readListeners;r<i.length;r++){i[r].onReadBegin(t)}},!1),r.addEventListener("progress",function(e){var t=new M3D.LoadingEvent;null!=a.readNextListener&&(t.fileName=a.readNextListener.currentFilesName),t.percent=e.loaded/e.total;for(var r=0,i=a.readListeners;r<i.length;r++){i[r].onReading(t)}},!1),r.send(null)}else{var s=new XMLHttpRequest;s.overrideMimeType("text/plain"),s.open("GET",e,!0);var l=this;s.onreadystatechange=function(){4==s.readyState&&(200==s.status?console.log("成功"):console.log("不允许跨域请求"))},s.addEventListener("load",function(e){var t=e.target.response;t=t.replace(/(^\s*)|(\s*$)/g,"");(t=JSON.parse(t)).zipFolder;0!=t.reback&&"false"!=t.reback?l.Open(t.zipfilepath,!0,t.zipfilename,t.format):l.onAlert(t.errMsg),200===this.status?console.log("成功读取"):this.status},!1),s.addEventListener("error",function(e){},!1),s.send(null)}return null},SView.prototype.GetCurFileName=function(){return this.curFileName},SView.prototype.GetNeedReadFile=function(e,t,r){var i=null,n=null,o=null,a=null;if(null==t||null==t||0===t.length||"stl"===r.toLowerCase()||"obj"===r.toLowerCase()||"jsvl"===r.toLowerCase()){var s=void 0;s=null==r||null==r||0===r.length?new RegExp(".*.((jsvl)|(obj)|(stl))$","i"):new RegExp(".*."+r+"$","i");var l=e.file(s);if(0<l.length){var h=(i=l[0]).name,u=h.lastIndexOf(".");0<=u&&u<h.length-1&&(r=h.substr(u+1))}if("jsvl"==r){var p=new RegExp(".*.jsvl_Mesh.bin$","i"),c=e.file(p);0<c.length&&(n=c[0]);var d=new RegExp(".*.sa$","i"),S=e.file(d);0<S.length&&(o=S[0]);var f=new RegExp(".*views$","i"),m=e.file(f);0<m.length&&(a=m[0]),console.log(f)}}else{s=t+"."+r;if(i=e.file(s),"jsvl"==r){var y=t+".jsvl_Mesh.bin";n=e.file(y);d=t+".sa";var T=t+".views";a=e.file(T),o=e.file(d)}}return[i,n,o,a,r=r.toLocaleLowerCase()]},SView.prototype.OpenZipFileOnlyGetModel=function(e,t,r){var i=this;this.readModelListener=new M3D.ReadModelListener,this.readModelListener.onReadEnd=function(e){var t=e.GetModel();i.mulitFileReadModels.push(t)},this.OpenSingleZipFile(e,t,r)},SView.prototype.AsyOpenSingleZipFile=function(e,t,r,i){"svl"==r&&(r="jsvl"),this.view.GetSceneManager().GetResourceManager().ClearResource(),this.view.GetSceneManager().GetResourceManager().SetZipFile(e);var n=this.GetNeedReadFile(e,t,r);if(null!=n[0]){var o=n[0];if(r=n[4],this.view.GetSelector().SetListeners(this.selectorListeners),this.curFileName=t,"stl"==r){var a=new M3D.StlReader;a.SetView(this.view),a.SetListeners(this.readListeners),a.readNextListener=this.readNextListener,a.readModelListener=this.readModelListener;var s=a.ensureBinary(o.asBinary());a.isBinary(s)?a.parseBinary(s):a.parseASCII(a.ensureString(o.asText()))}else if("jsvl"==r){M3D.SimulationAnimationManager.Instance().view=this.view,(d=new M3D.JSvlReader).readNextListener=this.readNextListener,d.readModelListener=this.readModelListener,d.SetListeners(this.readListeners);var l=n[1];d.ReadJSvl(o.asText(),l.asBinary());var h=n[2],u=n[3];if(u){console.log(u);var p=(c=u.asText()).indexOf("<");c=c.substr(p),console.log(this.ParseXmlString(c)),this.view.LoadModelViewList(this.ParseXmlString(c))}if(h){console.log(h);var c;p=(c=h.asText()).indexOf("<");c=c.substr(p),M3D.SimulationAnimationManager.Instance().ProcessXMLData(this.ParseXmlString(c))}}else if("obj"==r){var d;(d=new M3D.ObjReader).readNextListener=this.readNextListener,d.readModelListener=this.readModelListener,d.SetListeners(this.readListeners);var S=o.asText();d.ReadFile(S)}}},SView.prototype.OpenSingleZipFile=function(e,t,r){"svl"==r&&(r="jsvl"),this.view.GetSceneManager().GetResourceManager().ClearResource(),this.view.GetSceneManager().GetResourceManager().SetZipFile(e);var i=this.GetNeedReadFile(e,t,r);if(null!=i[0]){var n=i[0];if(r=i[4],this.view.GetSelector().SetListeners(this.selectorListeners),this.curFileName=t,"stl"==r){var o=new M3D.StlReader;o.SetListeners(this.readListeners),o.readNextListener=this.readNextListener,o.readModelListener=this.readModelListener;var a=o.ensureBinary(n.asBinary());o.SetView(this.view),o.isBinary(a)?o.parseBinary(a):o.parseASCII(o.ensureString(n.asText()))}else if("jsvl"==r){M3D.SimulationAnimationManager.Instance().view=this.view,(c=new M3D.JSvlReader).SetView(this.view),c.readNextListener=this.readNextListener,c.readModelListener=this.readModelListener,c.SetListeners(this.readListeners);var s=i[1];c.ReadJSvl(n.asText(),s.asBinary());var l=i[2],h=i[3];if(h){console.log(h);var u=(p=h.asText()).indexOf("<");p=p.substr(u),console.log(this.ParseXmlString(p)),this.view.LoadModelViewList(this.ParseXmlString(p))}if(l){console.log(l);var p;u=(p=l.asText()).indexOf("<");p=p.substr(u),M3D.SimulationAnimationManager.Instance().ProcessXMLData(this.ParseXmlString(p))}}else if("obj"==r){var c;(c=new M3D.ObjReader).SetView(this.view),c.readNextListener=this.readNextListener,c.readModelListener=this.readModelListener,c.SetView(this.view),c.SetListeners(this.readListeners),c.SetView(this.view),c.ReadFile(n.asText())}}},SView.prototype.ParseXmlString=function(e){var t=null;if(window.hasOwnProperty("DOMParser"))try{t=(new DOMParser).parseFromString(e,"text/xml")}catch(e){}else if(window.hasOwnProperty("ActiveXObject"))for(var r=["MSXML2.DOMDocument","Microsoft.XMLDOM"],i=0;i<r.length;i++)try{(t=new ActiveXObject(r[i])).async=!1,t.loadXML(e);break}catch(e){continue}return t},SView.prototype.CreatModleViewByXMlStr=function(e){return M3D.ModleView.CreateByXml(e)},SView.prototype.CreatModleView=function(){var e=M3D.ModleView.Create();return this.view.UpdateViewByCurrentScene(e),this.view.GetModel().AddModelView(e),e},SView.prototype.GetXMLStrByMV=function(e){return e.ToXml()},SView.prototype.SaveMeasure=function(e){SView.canvas.GetMeasureManager()},SView.prototype.GetXMLStrByMeasure=function(){for(var e=this._measureManager.GetMeasures(1),t=new Array,r=0,i=e;r<i.length;r++){var n=i[r],o=M3D.MeasureFactory.MeasureToXMLElement(n.GetMeasureObj(),this.view.GetSceneManager());t.push(o)}return t},SView.prototype.GetXMLStrByTextNote=function(){for(var e=this._measureManager.GetMeasures(150),t=new Array,r=0,i=e;r<i.length;r++){var n=i[r],o=M3D.NoteFactory.TextNoteToXMLElement(this.view.GetSceneManager(),n.GetNoteObj());t.push(o)}return t},SView.prototype.CreateTextNoteByXML=function(e){var t=SView_1.STextNote.CreateFromXML(e,this);this.GetNativeShapeManager().AddShape(t.GetID(),t.GetNoteObj()),this.GetMeasureManager().Add(t)},SView.prototype.CreateMeasureByXML=function(e){var t=SView_1.SMeasureDistance.CreateFromXML(e,this);this.GetNativeShapeManager().AddShape(t.GetID(),t.GetMeasureObj()),this.GetMeasureManager().Add(t)},SView.prototype.OpenZipFile=function(e,t,r){var i=this,n=new M3D.ReadListener;n.onReadEnd=function(e){var t=e.GetModel();i.view.ReadModel(t),i.readEnd(),i.RemoveReadListener(n)},this.AddReadListener(n),this.OpenSingleZipFile(e,t,r)},SView.prototype.readEnd=function(){M3D.Log.Info(this,"{readSuccess:'true'}")},SView.prototype.OpenFile=function(e){var n=this,o=this;this.view.GetSceneManager().GetResourceManager().ClearResource(),this.view.GetSelector().SetListeners(this.selectorListeners);var s=M3D.FileHelper.GetSuffix(e[0].name);if("zip"===s||"svp"===s||"zsvl"===s||"svlx"===s){var t=new FileReader,l=this;return t.addEventListener("load",function(e){var t=e.target.result,r=new JSZip(t);if("svlx"!==s)l.OpenZipFile(r,"","");else{var o=n;n.view.GetSelector().SetListeners(n.selectorListeners);var a=new M3D.ReadListener;a.onReadEnd=function(e){var t=e.GetModel();o.view.ReadModel(t),o.readEnd(),M3D.SimulationAnimationManager.Instance().view=o.view;var r=e.getChildAnimation();M3D.SimulationAnimationManager.Instance().SetChildSAManagerStr(r);var i=e.getAnimation();if(i){var n=i.indexOf("<");i=i.substr(n),M3D.SimulationAnimationManager.Instance().ProcessXMLData(o.ParseXmlString(i))}o.RemoveReadListener(a)},n.AddReadListener(a);var i=new M3D.SvlxReader;i.SetView(n.view),i.readNextListener=n.readNextListener,i.readModelListener=n.readModelListener,i.SetListeners(n.readListeners),i.OpenZipModel(r)}},!1),t.readAsBinaryString(e[0]),"OK"}var r=M3D.Reader.GetReader(e),a=r[0];if(null==a)return r[1];var i=new M3D.ReadListener;i.onReadEnd=function(e){var t=e.GetModel();console.log("onReadEnd"+(new Date).toISOString()),o.view.ReadModel(t),o.readEnd(),o.RemoveReadListener(i)},this.AddReadListener(i),a.SetListeners(this.readListeners);e[0].name;var h,u,p=new FileReader,c=new FileReader,d=!0;return a instanceof M3D.JSvlReader?(p.addEventListener("load",function(e){var t=e.target;h=t.result},!1),c.addEventListener("load",function(e){var t=e.target;u=t.result;a.ReadJSvl(h,u)},!1),p.readAsText(e[0]),c.readAsBinaryString(e[1])):a instanceof M3D.StlReader?(p.addEventListener("load",function(e){var t=e.target.result,r=a,i=r.ensureBinary(t);if(!r.isBinary(i)){d=!1;var n=r.parseASCII(r.ensureString(t));null!=n&&o.view.ReadModel(n)}},!1),c.addEventListener("load",function(e){if(d){var t=e.target.result,r=a,i=r.ensureBinary(t);if(r.isBinary(i)){var n=r.parseBinary(i);null!=n&&o.view.ReadModel(n)}}},!1),p.readAsText(e[0]),c.readAsBinaryString(e[0])):(p.addEventListener("load",function(e){var t=e.target.result,r=a.ReadFile(t);null!=r&&o.view.ReadModel(r)},!1),p.readAsText(e[0])),"OK"},SView.prototype.CloseFile=function(){this.StopFixUpdateTimer(),this.view.CloseFile()},SView.prototype.setSelectType=function(e){M3D.Parameters.Instance().selectedStyle=e},SView.prototype.IsShowWireframe=function(){this.isShowWireframe?this.isShowWireframe=!1:(this.isShowWireframe=!0,this.isOnlyShowWireframe=!1),M3D.Parameters.Instance().IsShowTrilateralEdge=this.isShowWireframe,M3D.Parameters.Instance().IsOnlyShowTrilateralEdge=this.isOnlyShowWireframe,this.view.setDrawMode(4)},SView.prototype.setRenderMode=function(e){switch(e){case 0:this.IsShowEdgeLine=!0,this.IsOnlyShowEdgeLine=!1;break;case 1:this.IsShowEdgeLine=!1,this.IsOnlyShowEdgeLine=!1;break;case 2:this.IsOnlyShowEdgeLine=!0,this.IsShowEdgeLine=!0}M3D.Parameters.Instance().IsOnlyShowEdgeLine=this.IsOnlyShowEdgeLine,M3D.Parameters.Instance().IsShowEdgeLine=this.IsShowEdgeLine,this.view.setDrawMode(e)},SView.prototype.IsOnlyShowWireframe=function(){this.isOnlyShowWireframe?this.isOnlyShowWireframe=!1:(this.isOnlyShowWireframe=!0,this.isShowWireframe=!1),M3D.Parameters.Instance().IsShowTrilateralEdge=this.isShowWireframe,M3D.Parameters.Instance().IsOnlyShowTrilateralEdge=this.isOnlyShowWireframe},SView.prototype.ShowTransparent=function(){this.IsShowTransparent?this.IsShowTransparent=!1:this.IsShowTransparent=!0,M3D.Parameters.Instance().IsShowTransparent=this.IsShowTransparent;var e=this.view.getDrawMode();this.view.setDrawMode(e)},SView.prototype.GetFPS=function(){return this.view.GetSceneManager().GetRenderManager().GetFPS()},SView.prototype.SetClipPlane=function(e,t,r,i){this.view.ClearClipPlane(),this.view.SetClipPlane(e,t,r,i)},SView.prototype.SetClipPlaneColor=function(e,t){this.view.SetClipPlaneColor(e,t)},SView.prototype.SetClipValue=function(e){this.curClipValue=e,this.SetClipPlane(this.curClipDirection,this.curClipValue,!0,!0),this.view.GetSceneManager().GetSection().SetIsShowCappingPlane(this.curIsShowCappingPlane)},SView.prototype.SetClipDirection=function(e){this.curClipDirection=e,this.SetClipPlane(this.curClipDirection,this.curClipValue,!0,!0)},SView.prototype.SetOppositeDir=function(){this.curClipDirection=-1*this.curClipDirection,this.SetClipPlane(this.curClipDirection,this.curClipValue,!0,!0)},SView.prototype.CloseClipPlane=function(){this.view.ClearClipPlane(),this.curClipValue=0},SView.prototype.IsShowCappingPlane=function(){this.curIsShowCappingPlane?this.curIsShowCappingPlane=!1:this.curIsShowCappingPlane=!0,this.view.GetSceneManager().GetSection().SetIsShowCappingPlane(this.curIsShowCappingPlane)},SView.prototype.IsShowClipHelppingPlane=function(){M3D.Parameters.Instance().showSection?M3D.Parameters.Instance().showSection=!1:M3D.Parameters.Instance().showSection=!0},SView.prototype.AddSelectListener=function(e){return null!=e&&-1===this.selectorListeners.indexOf(e)&&this.selectorListeners.push(e),!0},SView.prototype.RemoveSelectListener=function(e){return null!=e&&-1!==this.selectorListeners.indexOf(e)&&this.selectorListeners.splice(this.selectorListeners.indexOf(e),1),!0},SView.prototype.AddReadListener=function(e){return null!=e&&-1===this.readListeners.indexOf(e)&&this.readListeners.push(e),!0},SView.prototype.RemoveReadListener=function(e){return null!=e&&-1!==this.readListeners.indexOf(e)&&this.readListeners.splice(this.readListeners.indexOf(e),1),!0},SView.prototype.GetShpae=function(e){var t=this.view.GetSceneManager().GetModel();return null!==t?t.GetModelById(e):null},SView.prototype.SetExplosiveStyle=function(e){this.curExplosiveStyle=e,this.view.SetExplosiveView(this.curExplosiveStyle,this.curExplosivePercentage,!1),this.view.SetPerspective(6)},SView.prototype.SetExplosiveStyleNoRestore=function(e){this.curExplosiveStyle=e,this.view.SetExplosiveViewNoRestore(this.curExplosiveStyle,this.curExplosivePercentage,!1)},SView.prototype.SetExplosiveParam=function(e,t){this.explosiveManager.SetExplosiveParam(e,t)},SView.prototype.OpenExplossive=function(e,t){this.explosiveManager.OpenExplosive(e,t)},SView.prototype.CloseExplosive=function(){this.explosiveManager.CloseExplosive()},SView.prototype.SetExplosivePersentageNoRestore=function(e){this.curExplosivePercentage=e,this.view.SetExplosiveViewNoRestore(this.curExplosiveStyle,this.curExplosivePercentage,!1)},SView.prototype.SetExplosivePersentage=function(e){this.curExplosivePercentage=e,this.view.SetExplosiveView(this.curExplosiveStyle,this.curExplosivePercentage,!1)},SView.prototype.SetExplosive=function(e,t){this.view.SetExplosiveView(e,t,!1),this.view.SetPerspective(6)},SView.prototype.ClearExplosive=function(){this.view.CloseExplosiveView(),this.curExplosivePercentage=0},SView.prototype.IsUseModelContextMenu=function(){return 0<this.view.GetSelector().GetAll().length},SView.prototype.SetSelectModelColor=function(e,t,r){for(var i=0,n=this.view.GetSelector().GetAll();i<n.length;i++){var o=n[i];if(null!==o){var a=new M3D.Color(e,t,r);o.SetInitColor(a)}}},SView.prototype.SetDraggerMode=function(e){switch(e){case 0:this.view.draggerHandler.SetMode(M3D.OPEMODE.TRANSLATE);break;case 1:this.view.draggerHandler.SetMode(M3D.OPEMODE.ROTATE);break;case 2:this.view.draggerHandler.SetMode(M3D.OPEMODE.SCALE)}},SView.prototype.SetDraggerAxis=function(e){switch(e){case 0:this.view.draggerHandler.SetAxis(M3D.TRANSAXIS.AXIS_X);break;case 1:this.view.draggerHandler.SetAxis(M3D.TRANSAXIS.AXIS_Y);break;case 2:this.view.draggerHandler.SetAxis(M3D.TRANSAXIS.AXIS_Z);break;case 3:this.view.draggerHandler.SetAxis(M3D.TRANSAXIS.AXIS_FACE)}},SView.prototype.SetUsingTouchHandlerType=function(e){switch(e){case 0:this.view.SetUsingTouchHandlerType(M3D.TouchHandlerType.HANDLER_WALKTHROUGH);break;case 1:this.view.SetUsingTouchHandlerType(M3D.TouchHandlerType.HANDLER_COMMON);break;case 2:this.view.SetUsingTouchHandlerType(M3D.TouchHandlerType.HANDLER_ORBIT);break;case 3:this.view.SetUsingTouchHandlerType(M3D.TouchHandlerType.HANDLER_DRAGGER)}},SView.prototype.StartRotateBySelf=function(){this.view.GetTouchHandler().StartModelRotateOnFixedPoint()},SView.prototype.EndRotateBySelf=function(){this.view.GetTouchHandler().EndModelRotateOnFixedPoint()},SView.prototype.SetRotateAxis=function(e){this.view.GetTouchHandler().SetModelRotateAxis(e)},SView.prototype.SetRotateSpeed=function(e){this.explorsiveSpeed=e,this.view.GetTouchHandler().SetModelRotateSpeed(e)},SView.prototype.SetNeedCircleNumber=function(e){this.view.GetTouchHandler().SetNeedCircle(e)},SView.prototype.IsMatchCircleCount=function(){return this.view.GetTouchHandler().IsMatchCircleCount()},SView.prototype.ResetRotCircleCount=function(){this.view.GetTouchHandler().ResetRotCircleCount()},SView.prototype.StartRotateAndExplosive=function(){this.StartExplosiveTimer()},SView.prototype.EndRotateAndExplosive=function(){this.EndExplosiveTimer()},SView.prototype.ClearRotateAndExplosive=function(){this.explosivePercent=0,this.isRotateComplete=!1,this.isNeedRotate=!0,this.view.GetTouchHandler().ResetRotCircleCount(),this.EndRotateBySelf()},SView.prototype.JoystickControl=function(e,t){var r=this.view.GetTouchHandler();r instanceof M3D.WalkthroughHandler&&r.VirtualKeyMove(e,t)},SView.prototype.StartJoystick=function(){this.joystickTimer.IsStart()&&this.joystickTimer.StopTimer(),this.joystickTimer.StartTimer(),this.joystickTimer.SetTimer(this.JoystickTask,this,41)},SView.prototype.EndJoystick=function(){this.joystickTimer.IsStart()&&this.joystickTimer.StopTimer()},SView.prototype.SetWalkingSpeed=function(e){e*=8,this.view.GetTouchHandler().SetFirstPersionParameter(e)},SView.prototype.SetUpdirection=function(e){var t=new M3D.Vector3;switch(e){case 0:t=M3D.Vector3.RIGHT().Clone();break;case 1:t=M3D.Vector3.LEFT().Clone();break;case 2:t=M3D.Vector3.UP().Clone();break;case 3:t=M3D.Vector3.DOWN().Clone();break;case 4:t=M3D.Vector3.FORWARD().Clone();break;case 5:t=M3D.Vector3.BACK().Clone()}this.view.GetTouchHandler().SetUpDirection(t,this.view)},SView.prototype.SetCameraFov=function(e){var t=this.view.GetTouchHandler();return t instanceof M3D.WalkthroughHandler&&(t.SetCameraFov(e),!0)},SView.prototype.JoystickTask=function(e){var t=e;t.joyStickOption.isJoysticPressing&&t.JoystickControl(t.joyStickOption.strightSpd,t.joyStickOption.sideSpd)},SView.prototype.StartAniTimer=function(){this.aniTimer.IsStart()&&this.aniTimer.StopTimer(),this.aniTimer.StartTimer(),this.aniTimer.SetTimer(this.AnimationTick,this,40)},SView.prototype.StopAniTimer=function(){this.aniTimer.IsStart()&&this.aniTimer.StopTimer()},SView.prototype.AnimationTick=function(e){var t=new Date;M3D.HTManager.GetHTManager().Tick(t.getTime()/1e3)},SView.prototype.StartExplosiveTimer=function(){this.explosiveTimer.IsStart()&&this.explosiveTimer.StopTimer(),this.explosiveTimer.StartTimer(),this.explosiveTimer.SetTimer(this.ExplosiveTimerTask,this,41)},SView.prototype.EndExplosiveTimer=function(){this.explosiveTimer.IsStart()&&this.explosiveTimer.StopTimer()},SView.prototype.ExplosiveTimerTask=function(e){var t=e,r=t.view.GetTouchHandler();if(t.isNeedRotate&&r.GetModelRotateOnFixedPointFunc(r),2===r.GetCircleNumber()){t.isNeedRotate=!1,t.isRotateComplete=!0,t.excStep1=!0;var i=.3*Math.abs(Math.sin(t.explosivePercent));t.SetExplosivePersentageNoRestore(i),t.explosivePercent+=Math.PI/180*.3*t.explorsiveSpeed,t.explosivePercent>=Math.PI/2&&(t.isNeedRotate=!0,r.ResetRotCircleCount())}if(1===r.GetCircleNumber()&&t.isRotateComplete){t.isNeedRotate=!1,r.OnlyRotate(r);i=.3*Math.abs(Math.sin(t.explosivePercent));t.SetExplosivePersentageNoRestore(i),t.explosivePercent-=Math.PI/180*.3*t.explorsiveSpeed,t.explosivePercent<=0&&(t.isNeedRotate=!0,t.explosivePercent=0,t.SetExplosivePersentageNoRestore(0),t.isRotateComplete=!1,r.ResetRotCircleCount())}},SView.prototype.DelayRotateAndExplosive=function(){null!==this.downTimer&&(clearInterval(this.downTimer),this.EndRotateAndExplosive()),this.downTimer=setTimeout(this.StartRotateAndExplosive.bind(this),3e3)},SView.prototype.GetModelBySVLPath=function(e){return null!=this.view?this.view.GetModelBySVLPath(e):null},SView.prototype.GetModelByPlacePath=function(e){return null!=this.view?this.view.GetModelBySVLPath(e):null},SView.prototype.GetSelector=function(){return null!=this.view?this.view.GetSelector():null},SView.prototype.FoucusViewToSCreenCenter=function(e,t){if(null==this.view)return!1;var r=this.view.GetSceneManager().GetCamera().GetViewPort().GetRect().Center();return this.view.FoucusView(e,r,t)},SView.prototype.FoucusViewByModel=function(e,t){if(null!=this.view&&null!=e){var r=null,i=[];i=i.concat(e);for(var n=0;n<e.length;n++){(o=e[n]).GetAllSubModels(i)}i.length;for(n=0;n<i.length;n++){var o,a=(o=i[n]).GetWorldBoundingBox();a||(a=o.GetTotalWorldBoundingBox()),0!==n?r.Merge(a.Clone()):r=a.Clone()}if(null!=r){var s=this.view.GetSceneManager().GetCamera().GetViewPort().GetRect().Center();return this.view.FoucusView(r,s,t)}}return!1},SView.prototype.FoucusView=function(e,t,r){return null!=this.view&&this.view.FoucusView(e,t,r)},SView.prototype.SetCurrentModelView=function(e){},SView.prototype.GetCurrentModelView=function(){},SView.prototype.GetDefaultModelView=function(){},SView.prototype.NoteGetAll=function(){this.view.GetSceneManager().GetNoteGroup().GetChildren()},SView.prototype.UpdateViewByCurrentScene=function(e){},SView.prototype.ShowModelView=function(e,t){},SView.prototype.onTextNote=function(){null!=this.view&&SView_1.AnnotationOperate.onAnnotationText(this)},SView.prototype.onNoteDelete=function(){null!=this.view&&SView_1.AnnotationOperate.onNoteDelete(this)},SView.prototype.onVoiceNote=function(){null!=this.view&&SView_1.MeasureOperate.onVoiceNote(this)},SView.prototype.onSequenceNote=function(){null!=this.view&&SView_1.AnnotationOperate.onSequenceNote(this)},SView.prototype.onSHotSpot=function(){if(null!=this.view){var e=this.GetHotSpotCommandManager(),t=e.GetCurrentCommand(),r=this.GetAnnotationCommandManager();null!=r.GetCurrentCommand()&&r.CloseCurrentCommand(),null!=t?(e.CloseCurrentCommand(),e.ExecuteEditCommand()):e.ExcuateCmmand(SView_1.HotSpotCommandType.NOTE_ADD,SView_1.SAnnotation.ANNOTATION_TYPE_ORDER)}},SView.prototype.onComponentNameNote=function(){null!=this.view&&SView_1.AnnotationOperate.onComponentNameNote(this)},SView.prototype.onMeasureDistancePntToPnt=function(){null!=this.view&&SView_1.MeasureOperate.onMeasureDistancePntToPnt(this)},SView.prototype.onMeasureDistancePntToLine=function(){null!=this.view&&SView_1.MeasureOperate.onMeasureDistancePntToLine(this)},SView.prototype.onMeasureDistancePntToFace=function(){null!=this.view&&SView_1.MeasureOperate.onMeasureDistancePntToFace(this)},SView.prototype.onMeasureDistanceLineToLine=function(){null!=this.view&&SView_1.MeasureOperate.onMeasureDistanceLineToLine(this)},SView.prototype.onMeasureDistanceLineToFace=function(){null!=this.view&&SView_1.MeasureOperate.onMeasureDistanceLineToFace(this)},SView.prototype.onMeasureDistanceFaceToFace=function(){null!=this.view&&SView_1.MeasureOperate.onMeasureDistanceFaceToFace(this)},SView.prototype.onMeasureDistanceShaftToShaft=function(){null!=this.view&&SView_1.MeasureOperate.onMeasureDistanceShaftToShaft(this)},SView.prototype.onMeasureDistanceCenterToCenter=function(){null!=this.view&&SView_1.MeasureOperate.onMeasureDistanceCenterToCenter(this)},SView.prototype.onMeasureDistanceLine=function(){null!=this.view&&SView_1.MeasureOperate.onMeasureDistanceLine(this)},SView.prototype.onMeasureDistanceArc=function(){null!=this.view&&SView_1.MeasureOperate.onMeasureDistanceArc(this)},SView.prototype.onMeasureDistanceRadius=function(){null!=this.view&&SView_1.MeasureOperate.onMeasureDistanceRadius(this)},SView.prototype.onMeasureDistanceDiametre=function(){null!=this.view&&SView_1.MeasureOperate.onMeasureDistanceDiametre(this)},SView.prototype.onMeasureAngleLineToLine=function(){null!=this.view&&SView_1.MeasureOperate.onMeasureAngleLineToLine(this)},SView.prototype.onMeasureAngleCurveToCurve=function(){null!=this.view&&SView_1.MeasureOperate.onMeasureAngleCurveToCurve(this)},SView.prototype.onMeasureAngleLineToFace=function(){null!=this.view&&SView_1.MeasureOperate.onMeasureAngleLineToFace(this)},SView.prototype.onMeasureAngleFaceToFace=function(){null!=this.view&&SView_1.MeasureOperate.onMeasureAngleFaceToFace(this)},SView.prototype.onMeasurePropertyPoint=function(){null!=this.view&&SView_1.MeasureOperate.onMeasurePropertyPnt(this)},SView.prototype.onMeasurePropertyLine=function(){null!=this.view&&SView_1.MeasureOperate.onMeasurePropertyLine(this)},SView.prototype.onMeasurePropertyFace=function(){null!=this.view&&SView_1.MeasureOperate.onMeasurePropertyFace(this)},SView.prototype.onMeasurePropertyModel=function(){null!=this.view&&SView_1.MeasureOperate.onMeasurePropertyModel(this)},SView.prototype.onMeasureExit=function(){null!=this.view&&SView_1.MeasureOperate.onMeasureExit(this)},SView.prototype.onAnnotationExit=function(){null!=this.view&&SView_1.AnnotationOperate.onAnnotationClose(this)},SView.prototype.onMeasureClose=function(){null!=this.view&&SView_1.MeasureOperate.onMeasureClose(this)},SView.prototype.loadMeasure=function(){this.view.GetSceneManager().ReIndexIDMapAfterAddModel(this.view.GetSceneManager().GetModel())},SView.prototype.removeMeasure=function(){this.view.GetSceneManager().ReIndexIDMapAfterDeleteModel(this.view.GetSceneManager().GetModel())},SView.prototype.onMeasureBase=function(){null!=this.view&&SView_1.MeasureOperate.onBase(this)},SView.prototype.onAnnotationBase=function(){null!=this.view&&SView_1.AnnotationOperate.onBase(this)},SView.prototype.UpdateNote=function(e,t){if(null!=this.view){this.GetSelector().Clear();var r=this.GetNativeShapeManager().GetShape(e);r.GetType()==M3D.ShapeType.SHAPE_TEXT_NOTE&&M3D.AnnotationFactory.UpdateAnnotationTextValue(r,t,this.view.GetSceneManager())}},SView.prototype.CanEditNote=function(){if(null!=this.view){var e=this.GetSelector().GetAll()[0].GetID();if(this.GetNativeShapeManager().GetShape(e).GetType()==M3D.ShapeType.SHAPE_TEXT_NOTE)return!0}return!1},SView.prototype.editSequenceNote=function(){if(null!=this.view){var e=this.GetSelector().GetAll()[0].GetID();if(this.GetNativeShapeManager().GetShape(e).GetType()==M3D.ShapeType.SHAPE_SEQUENCE_NUMBER_NOTE)return!0}return!1},SView.prototype.setIsMulSelect=function(e){M3D.Parameters.Instance().IsMulSelect=e},SView.prototype.setShowBox=function(e){M3D.Parameters.Instance().IsShowBox=e;var t=this.view.getDrawMode();this.view.setDrawMode(t)},SView.prototype.getOpenFileLicence=function(){return this.openFileLicence},SView.prototype.setOpenFileLicence=function(e){this.openFileLicence=e},SView.prototype.getMeasureLicence=function(){return this.measureLicence},SView.prototype.setMeasureLicence=function(e){this.measureLicence=e},SView.prototype.getAnimationLicence=function(){return this.animationLicence},SView.prototype.setAnimationLicence=function(e){this.animationLicence=e},SView.prototype.getExplosiveLicence=function(){return this.explosiveLicence},SView.prototype.setExplosiveLicence=function(e){this.explosiveLicence=e},SView.prototype.GetLicenseHelper=function(){return this.licenseHelper},SView.prototype.SetLicenceOptionUserId=function(e){this.licenseTools.SetLicenceOptionUserId(e)},SView.prototype.SetUser=function(e){this.licenseTools.SetLicenceOptionUserId(e)},SView.prototype.GetUser=function(){return this.licenseTools.GetLicenceOptionUserId()},SView.prototype.CheckLicence=function(r){var i=this,e=new XMLHttpRequest,t=this.SViewBaseUrl+"lic/sview.lic";e.open("GET",t,!0),e.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),e.addEventListener("load",function(e){var t=e.target.response;i.licenseHelper.SetLicenseOption(t),i.licenseHelper.GetInitState()?i.licenseTools.check(!0,r):i.ShowLicenseStateInfo()},!1),e.addEventListener("error",function(e){i.licenseHelper.SetInitState(!1),i.licenseHelper.SetInitStateCode(M3D.READLICENSESTATE_OPENFAILURE)},!1);try{e.send(null)}catch(e){i.licenseHelper.SetInitState(!1),i.licenseHelper.SetInitStateCode(M3D.READLICENSESTATE_OPENFAILURE),console.log(e.code+"\n"+e.message)}return!0},SView.prototype.utoa=function(e){return window.btoa(encodeURI(encodeURIComponent(e)))},SView.prototype.ResetAllModel=function(){this.view.GetSceneManager().Reset(),this.GetSelector().Clear()},SView.prototype.GetCommandManager=function(){return null!==this._commandManage?this._commandManage:this._commandManage=new SView_1.CommandManager(this)},SView.prototype.GetMeasureCommandManager=function(){return null!==this._measureCommandManager?this._measureCommandManager:this._measureCommandManager=new SView_1.MeasureCommandManager(this)},SView.prototype.GetAnnotationCommandManager=function(){return null!==this._annotationCommandManager?this._annotationCommandManager:this._annotationCommandManager=new SView_1.AnnotationCommandManager(this)},SView.prototype.GetHotSpotCommandManager=function(){return null!==this._hotspotCommandManager?this._hotspotCommandManager:this._hotspotCommandManager=new SView_1.HotSpotCommandManager(this)},SView.prototype.OnCommandTouchHandle=function(e,t){var r=this.GetCommandManager(),i=null;return null!=r&&((i=r.GetCurCommand())instanceof SView_1.AnnotationTextCommand&&(i.inputTextNoteString=function(r,i){e instanceof SView&&e.inputTextNote(function(e,t){i(e,t,r)})}),i instanceof SView_1.HotSpotCreateCommand&&(i.inputHotSpotPara=function(l,h){e instanceof SView&&e.inputSHotSpot(function(e,t,r,i,n,o,a,s){h(e,t,r,i,n,o,a,s,l)})})),null!==i&&i.OnTouchHandle(e,t)},SView.prototype.MeasurePropertyStr=function(e){this.PorpertyMeasureCallBack(e)},SView.prototype.GetNativeShapeManager=function(){return this._nativeShapeManager},SView.prototype.GetMeasureManager=function(){return null!==this._measureManager?this._measureManager:this._measureManager=new SView_1.MeasureManager(this)},SView.prototype.GetAnnotationManager=function(){var e=this.view.GetSAnnotationManager();return e?(this.view.GetSAnnotationManager().SetsView(this),e):(null!==this._annotationManager||(this._annotationManager=new SView_1.SAnnotations(this)),this.view.sannotationManager=this._annotationManager,this._annotationManager)},SView.prototype.atou=function(e){return decodeURIComponent(decodeURI(window.atob(e)))},SView.prototype.Open=function(){for(var y=[],e=0;e<arguments.length;e++)y[e]=arguments[e];var T=SView.canvas=this;this.CheckLicence(function(){var s=T;if(M3D.ComText.option.useLocalFont=!1,M3D.ComText.option.pmiServer=T.pmiOptions.pmiServer,T.view.GetSceneManager().GetModelFillManager().openFileEnd=function(){s.view.GetSceneManager().RequestUpdateWhenSceneBoxChanged(),0===s.view.GetSceneManager().GetLightManager().GetAllLight().length&&s.view.GetSceneManager().GetLightManager().CreateDefaultLights();for(var e=s.view.GetSAnnotationManager().GetAnnotations(),t=0;t<e.length;t++)s.GetNativeShapeManager().AddShape(e[t].GetNoteObj().GetID(),e[t].GetNoteObj());s.openModelsEnd(s.view.GetModel()),s.OnOpenFinished(s.view.GetModel()),s.view.GetSceneManager().m_pSceneBoxNote=null},2==y.length){var e=y[1],t=y[0];if(e){T.view.GetSelector().SetListeners(T.selectorListeners);var l=new M3D.ReadListener;l.onReadEnd=function(e){var t=e.GetModel();s.view.ReadModel(t),s.readEnd(),M3D.SimulationAnimationManager.Instance().view=s.view;var r=e.getChildAnimation();for(var i in r){var n=r[i],o=n.indexOf("<");n=n.substr(o).replace(/&#xD;&#xA;/g,""),r[i]=s.ParseXmlString(n)}M3D.SimulationAnimationManager.Instance().SetChildSAManagerStr(r);var a=e.getAnimation();if(a){o=a.indexOf("<");a=a.substr(o).replace(/&#xD;&#xA;/g,""),M3D.SimulationAnimationManager.Instance().ProcessXMLData(s.ParseXmlString(a))}s.GetAnnotationManager(),s.RemoveReadListener(l)},T.AddReadListener(l);var r=new M3D.SvlxReader;r.SaveMeasure=T.SaveMeasure,r.SetView(T.view),r.readNextListener=T.readNextListener,r.readModelListener=T.readModelListener,r.SetListeners(T.readListeners),r.option.readPMI=T.pmiOptions.usePMI,T.decryptoOptions.decryptoFile&&null!==T.decryptoOptions.decryptoServer?r.OpenUrl(t,T.svlxCallBack,T.decryptoOptions.decryptoServer):r.FillModelOnceTime(t,T.svlxCallBack)}else{var i=new XMLHttpRequest;i.overrideMimeType("text/plain"),i.open("GET",t,!0);var n=T;i.addEventListener("load",function(e){var t=e.target.response;t=t.replace(/(^\s*)|(\s*$)/g,"");(t=JSON.parse(t)).zipFolder;0!=t.reback&&"false"!=t.reback?n.Open(t.zipfilepath,!0):n.onAlert(t.errMsg),200===this.status?console.log("成功读取"):this.status},!1),i.addEventListener("error",function(e){},!1),i.send(null)}}else{if(4==y.length){var o=y[0],a=(e=y[1],y[2]),h=y[3];return T.readNextListener=null,T.readModelListener=null,T.view.GetSceneManager().GetResourceManager().ClearResource(),T.OpenSingleRemote(o,e,!1,a,h)}if(1==y.length){var u=y[0];T.OpenSvlxFunc(u,0,T.OpenSvlxFunc.bind(T))}else if(3==y.length){var p=y[1],c=y[0],d=y[2],S=0;if(0<c.length){var f=new M3D.ReadNextListener;T.readNextListener=f;var m=T;T.readNextListener.onReadEnd=function(e){m.readNextListener=null;var t=++S;if(t<c.length&&((m.readNextListener=f).allFilesCount=c.length,f.currentFileIndex=t,f.currentFilesName=M3D.FileHelper.GetFileNameFromUrl(c[t]),m.OpenSingleRemote(c[t],!0,!0,"",d)),t==c.length){var r=new M3D.Model;r.SetName(p);for(var i=0;i<m.mulitFileReadModels.length;i++){var n=m.mulitFileReadModels[i];n.SetPlcId(i),r.AddSubModel(n)}var o=e;o.SetModel(r),m.view.ReadModel(r);for(var a=0,s=m.readListeners;a<s.length;a++){s[a].onReadEnd(o)}}},f.allFilesCount=c.length,f.currentFileIndex=0,f.currentFilesName=M3D.FileHelper.GetFileNameFromUrl(c[0])}T.OpenSingleRemote(c[0],!0,!0,"",d)}}})},SView.prototype.svlxCallBack=function(e){var t=new M3D.LoadingEvent;null!=SView.canvas.readNextListener&&(t.fileName=SView.canvas.readNextListener.currentFilesName),t.percent=e.loaded/e.total;for(var r=0,i=SView.canvas.readListeners;r<i.length;r++){i[r].onReading(t)}},SView.prototype.OpenSvlxFunc=function(i,n,o){var a=this,s=new M3D.ReadListener;s.onReadEnd=function(e){var t=e.GetModel();if(a.modelSet.push(t),a.modelSet.length===i.length){for(var r=0;r<i.length;r++)a.allModels.AddSubModel(a.modelSet[r]);a.view.ReadModel(a.allModels),console.log("zsvl end time"+Date.now())}a.readEnd(),a.RemoveReadListener(s),n<i.length-1?o(i,n+1,o):(a.openModelsEnd(a.view.GetModel()),a.OnOpenFinished(a.view.GetModel()))},a&&a.AddReadListener(s);var e=new M3D.SvlxReader;e.SetView(a.view),e.readNextListener=a.readNextListener,e.readModelListener=a.readModelListener,e.SetListeners(a.readListeners),e.FillModelOnceTime(i[n],function(e){var t=new M3D.LoadingEvent;null!=a.readNextListener&&(t.fileName=a.readNextListener.currentFilesName),t.percent=e.loaded/e.total;for(var r=0,i=a.readListeners;r<i.length;r++){i[r].onReading(t)}})},SView.prototype.RestoreSelectedModel=function(){for(var e=null,t=this.GetSelector().GetAll(),r=0;r<t.length;r++){var i=t[r];i&&i.GetType()==M3D.ShapeType.SHAPE_MODEL&&(e=i),e&&e.ResetMovement()}},SView.prototype.Restore=function(e,t){if(void 0===e&&(e=null),void 0===t&&(t=0),e)for(var r=0;r<e.length;r++){var i=e[r];switch(t){case 0:i.Restore(!0);break;case 1:i.ResetMovement();break;case 2:i.ResetColor();break;case 3:i.SetVisible(i.IsOrigVisible())}}else{i=this.view.GetModel();switch(t){case 0:i.Restore(!0);break;case 1:i.ResetMovement();break;case 2:i.ResetColor();break;case 3:i.SetVisible(i.IsOrigVisible())}}},SView.prototype.DrawSelectRectangle=function(){var r=this;function e(e){}function t(e){if(r._endLocation=r.GetClientPnt(e).Clone(),r.isFrameSelect){var t=r._endLocation.Sub(r._firstLocation);t.x*t.x+t.y*t.y<450?(r.singleClickFlag=!0,r.singleClickFlag&&null==r.GetCommandManager().GetCurCommand()&&(r.SelectShape(r._endLocation.x,r._endLocation.y),r.isCanvace2Dsingle=!0)):(r.isCanvace2Dsingle=!1,r.FrameSelection(r._firstLocation,r._endLocation,1))}r.setIsFrameSelect(!1),i.style.visibility="hidden"}var i=document.getElementById("canvas2d");i||((i=document.createElement("canvas")).setAttribute("id","canvas2d"),i.style.zIndex="-1",i.style.position="absolute",i.style.width="100%",i.style.height="100%",this.renderCanvas.parentElement.appendChild(i),i.addEventListener("mousemove",function(e){n.clearRect(0,0,i.width,i.height),r._endLocation=r.GetClientPnt(e).Clone();var t=r._endLocation.Sub(r._firstLocation);n.strokeStyle="red",n.setLineDash([12,5]),n.strokeRect(r._firstLocation.x,r._firstLocation.y,t.x,t.y)}.bind(this),!1),window.hasOwnProperty("PointerEvent")?(i.addEventListener("pointerup",t.bind(this),!1),i.addEventListener("pointerdown",e.bind(this),!1)):(i.addEventListener("mouseup",t.bind(this),!1),i.addEventListener("mousedown",e.bind(this),!1)));i.width=this.renderCanvas.width,i.height=this.renderCanvas.height,i.style.visibility="visible";var n=i.getContext("2d")},SView.prototype.FrameSelection=function(e,t,r){var i=this.view.FrameSelectShape(e,t,0,0,r);this.view.GetSelector().Add(i)},SView.prototype.UpdateSceneBox=function(){this.view.GetSceneManager().GetSceneBox().Clear();this.view.GetSceneManager().GetSceneBox();var e=this.view.GetTouchHandler();e.SetRestoreCamera(!1),e.UpdateCamera(),e.SetRestoreCamera(!0)},SView.prototype.TranslateNote=function(e,t){var r,i=e.GetSceneNode();r=i?i.GetWorldTransform().Clone():M3D.Matrix3x4.IDENTITY().Clone();var n=new M3D.Matrix3x4;n.MultiTranslate(t);var o=n.Multiply(r);i.SetPlcMatrix(o)},SView.prototype.Translate=function(e,t){var r=e.model,i=e.noteArray;M3D.ModelTransformHelper.TranslateModel(r,t);for(var n=0,o=i.length;n<o;n++){var a=i[n];this.TranslateNote(a,t)}},SView.prototype.getRenderCanvas=function(){return this.renderCanvas},SView.prototype.CreatePropertyNote=function(e,t,r,i){var n;return r==CreateType.HTML?n=M3D.NoteFactory.createPropertyTextNote(e,t,this.view.GetSceneManager(),!1,i):r==CreateType.Note&&(n=M3D.NoteFactory.createPropertyTextNote(e,t,this.view.GetSceneManager(),!0,i)),n&&this.GetNativeShapeManager().AddShape(n.GetID(),n),n},SView.prototype.GetModelsWithUserProperty=function(){return this.view.shapeProperties},SView.prototype.SetAxisNodeState=function(e){this.view.axisNode&&this.view.axisNode.SetVisible(e)},SView.prototype.unButtonBindAixs=function(){this.tranAxisDragger&&(this.view.draggerManager.UnBindDragger(this.tranAxisDragger),this.tranAxisDragger=null)},SView.prototype.buttonBindAixs=function(){this.tranAxisDragger&&(this.view.draggerManager.UnBindDragger(this.tranAxisDragger),this.tranAxisDragger=null);this.view.GetModel();var e=this.GetSelector().Get();e&&(this.tranAxisDragger=this.view.draggerManager.BindDragger(e,1))},SView.prototype.unButtonBindRotation=function(){this.tranRotateDragger&&(this.view.draggerManager.UnBindDragger(this.tranRotateDragger),this.tranRotateDragger=null)},SView.prototype.buttonBindRotation=function(){this.tranRotateDragger&&(this.view.draggerManager.UnBindDragger(this.tranRotateDragger),this.tranRotateDragger=null);this.view.GetModel();var e=this.GetSelector().Get();e&&(this.tranRotateDragger=this.view.draggerManager.BindDragger(e,2))},SView.prototype.buttonBindScale=function(){0<this.tranScaleDragger&&(this.view.draggerManager.UnBindDragger(this.tranScaleDragger),this.tranScaleDragger=0);this.view.GetModel();var e=this.GetSelector().Get();e&&(this.tranScaleDragger=this.view.draggerManager.BindDragger(e,3))},SView.prototype.exitAnimation=function(){M3D.SimulationAnimationManager.Instance().ExitAll(),this.view.GetModel().ResetAlpha(),this.animationPlayer.Reset(),M3D.SimulationAnimationManager.Instance().pAnimationStepManager.GetCurrentProcessManager().CurProcessID=-1},SView.prototype.SetAixsCommandState=function(e){this._isAixsCommand=e,this.GetRotateCommandState()&&(this._isRotationCommand=!1,this.unButtonBindRotation()),e?this.buttonBindAixs():this.unButtonBindAixs()},SView.prototype.GetAixsCommandState=function(){return this._isAixsCommand},SView.prototype.SetRotationCommandState=function(e){this._isRotationCommand=e,this.GetAixsCommandState()&&(this._isAixsCommand=!1,this.unButtonBindAixs()),e?this.buttonBindRotation():this.unButtonBindRotation()},SView.prototype.GetRotateCommandState=function(){return this._isRotationCommand},SView.prototype.fillModelMaterial=function(e,t){e&&t&&M3D.MaterialReader.Instance().fillMaterial(this.view,e,t)},SView.prototype.getSceneManagerType=function(){return this.view.GetSceneManager().GetSceneType()},SView.prototype.setShadowState=function(e){M3D.Parameters.Instance().m_shadowMapEnabled=e},SView.prototype.getShadowState=function(){return M3D.Parameters.Instance().m_shadowMapEnabled},SView.prototype.setIBLFactor=function(e){0<=e&&e<=5&&(M3D.Parameters.Instance().IBLFactor[0]=e)},SView.prototype.SetSceneGamma=function(e){M3D.Parameters.Instance().m_gammaFactor=Number(e)},SView.prototype.SetAlpha=function(e){var t=this.GetSelector().Get();if(t)for(var r=t.GetBodys(),i=0;i<r.length;i++)for(var n=r[i].GetFaces(),o=0;o<n.length;o++){n[o].SetAlpha(e)}},SView.prototype.SetUserMaterial=function(e,t){var r=this.GetSelector().Get();if(r)for(var i=r.GetBodys(),n=0;n<i.length;n++)for(var o=i[n].GetFaces(),a=0;a<o.length;a++){var s=o[a].GetMaterial();if(s&&s.GetMaterialType()===M3D.MaterialType.MaterialType_Pbr){var l=s;l.SetRougthnessFactor(e),l.SetMetalnessFactor(t)}}},SView.prototype.InitLicense=function(){},SView.prototype.GetLicenseInfo=function(e){this.licenseTools.info(e)},SView.prototype.ShowLicenseStateInfo=function(){if(this.licenseHelper.GetInitState())switch(this.licenseTools.GetCheckStateCode()){case M3D.READLICENSESTATE_FILECONTENTERROR:this.ShowLicenceStateInfoListener("LicenseInfoError",M3D.READLICENSESTATE_FILECONTENTERROR);break;case M3D.CHECKSTATE_INCORRECTPRODUCTNAME:this.ShowLicenceStateInfoListener("ProductNameError",M3D.CHECKSTATE_INCORRECTPRODUCTNAME);break;case M3D.CHECKSTATE_INCORRECTVERSION:this.ShowLicenceStateInfoListener("ProductVersionError",M3D.CHECKSTATE_INCORRECTVERSION);break;case M3D.CHECKSTATE_ACCESSFAILURE:this.ShowLicenceStateInfoListener("GetLicenseFailed",M3D.CHECKSTATE_ACCESSFAILURE);break;case M3D.CHECKSTATE_CONNECTSERVERFAILURE:this.ShowLicenceStateInfoListener("ServerRequestFailed",M3D.CHECKSTATE_CONNECTSERVERFAILURE);break;case M3D.CHECKSTATE_REQUESTRESULTFILEERROR:this.ShowLicenceStateInfoListener("LicenseInfoError",M3D.CHECKSTATE_REQUESTRESULTFILEERROR);break;case M3D.CHECKSTATE_TOKENERROR:this.ShowLicenceStateInfoListener("GetLicenseFailed",M3D.CHECKSTATE_TOKENERROR);break;case M3D.CHECKSTATE_LICENSEAUTHENTICATIONFAILURE:this.ShowLicenceStateInfoListener("LicenseCheckFailed",M3D.CHECKSTATE_LICENSEAUTHENTICATIONFAILURE);break;case M3D.CHECKSTATE_NOAVAILABLEPOINTS:this.ShowLicenceStateInfoListener("UnavailablePoints",M3D.CHECKSTATE_NOAVAILABLEPOINTS);break;case M3D.CHECKSTATE_UNEXISTEDAUTHENTICATIONINFO:this.ShowLicenceStateInfoListener("GetLicenseFailed",M3D.CHECKSTATE_UNEXISTEDAUTHENTICATIONINFO);break;case M3D.CHECKSTATE_TOKENEXPIRES:this.ShowLicenceStateInfoListener("LicenseCheckFailed",M3D.CHECKSTATE_TOKENEXPIRES);break;case M3D.CHECKSTATE_LICENSENOTSTARTED:this.ShowLicenceStateInfoListener("LicenseNotStarted",M3D.CHECKSTATE_LICENSENOTSTARTED);break;case M3D.CHECKSTATE_LICENSEEXPIRED:this.ShowLicenceStateInfoListener("LicenseExpired",M3D.CHECKSTATE_LICENSEEXPIRED);break;case M3D.CHECKSTATE_NOPERMISSION:this.ShowLicenceStateInfoListener("NoUseAccess",M3D.CHECKSTATE_NOPERMISSION);break;case M3D.CHECKSTATE_AUTHENTICATIONMODEMISMATCHED:this.ShowLicenceStateInfoListener("LicenseCheckFailed",M3D.CHECKSTATE_AUTHENTICATIONMODEMISMATCHED);break;case M3D.CHECKSTATE_MACADDRASSMISMATCHED:this.ShowLicenceStateInfoListener("BrowserMismatch",M3D.CHECKSTATE_MACADDRASSMISMATCHED);break;case M3D.CHECKSTATE_INCORRECTUSER:this.ShowLicenceStateInfoListener("UserMismatch",M3D.CHECKSTATE_INCORRECTUSER);break;case M3D.CHECKSTATE_LICENSERESCINDEDERROR:this.ShowLicenceStateInfoListener("LisenseDisabled",M3D.CHECKSTATE_LICENSERESCINDEDERROR);break;case M3D.CHECKSTATE_PROHIBITIONAGAINST:this.ShowLicenceStateInfoListener("DeniedAccess",M3D.CHECKSTATE_PROHIBITIONAGAINST);break;case M3D.CHECKSTATE_LICENSESIGNDISMATCHED:this.ShowLicenceStateInfoListener("GetLicenseFailed",M3D.CHECKSTATE_LICENSESIGNDISMATCHED)}else switch(this.licenseHelper.GetInitStateCode()){case M3D.READLICENSESTATE_OPENFAILURE:this.ShowLicenceStateInfoListener("GetLicenseFailed",M3D.READLICENSESTATE_OPENFAILURE);break;case M3D.READLICENSESTATE_FILECONTENTERROR:this.ShowLicenceStateInfoListener("LicenseInfoError",M3D.READLICENSESTATE_FILECONTENTERROR)}},SView.prototype.SnoptImage=function(e){var t=M3D.Parameters.Instance().IsShowAxis,r=M3D.Parameters.Instance().m_BackTransparent;t&&(M3D.Parameters.Instance().IsShowAxis=!1),!r&&e&&(M3D.Parameters.Instance().m_BackTransparent=!0),this.Draw();var i=this.renderCanvas.toDataURL("image/png");return t&&(M3D.Parameters.Instance().IsShowAxis=t),r||(M3D.Parameters.Instance().m_BackTransparent=r),i},SView.prototype.Snapshot=function(e){var t=M3D.Parameters.Instance().IsShowAxis,r=M3D.Parameters.Instance().m_BackTransparent;t&&(M3D.Parameters.Instance().IsShowAxis=!1),!r&&e&&(M3D.Parameters.Instance().m_BackTransparent=!0),this.Draw();var i=this.renderCanvas.toDataURL("image/png");return t&&(M3D.Parameters.Instance().IsShowAxis=t),r||(M3D.Parameters.Instance().m_BackTransparent=r),i},SView.prototype.createTextTexture=function(e){var t=document.createElement("canvas");t.width=100,t.height=100;var r=t.getContext("2d");return r.fillStyle="#808080",r.fillRect(0,0,100,100),r.textAlign="center",r.textBaseline="middle",r.fillText(e,50,50),t},SView.prototype.Set2DLableShowType=function(e){switch(e){case M3D.ShapeType.SHAPE_IMAGE_MODEL:this.view.ShowAllSign(),this.view.HiddenAllAnnotation();break;case SView_1.SAnnotation.ANNOTATION_TYPE_BASE:case SView_1.SAnnotation.ANNOTATION_TYPE_TEXT:case SView_1.SAnnotation.ANNOTATION_TYPE_COMPONENTNAME:case SView_1.SAnnotation.ANNOTATION_TYPE_ORDER:case SView_1.SAnnotation.ANNOTATION_TYPE_AUDIO:case SView_1.SAnnotation.ANNOTATION_TYPE_GESTURE:this.view.HiddenAllAnnotation(),this.view.HiddenAllSign(),this.view.ShowAnnotationByType(e)}},SView.prototype.SetParameter=function(e,t){this.view.SetParameter(e,t)},SView.prototype.GetParameter=function(e){return this.view.GetParameter(e)},SView.prototype.SetParameters=function(e){this.view.SetParameters(e)},SView.prototype.GetParameters=function(){return this.view.GetParameters()},SView.prototype.GetView=function(e){return e?null:this.view},SView.prototype.GetVersion=function(e){var t="";switch(e){case 0:t=M3D.PRODUCTVERSION}return t},SView.prototype.RestoreRotationCenter=function(){this.view.GetSceneManager().RestoreRotationCenter()},SView.prototype.Focus=function(e){void 0===e&&(e=[]),new M3D.SelectionOperator(this.view).Foces(e)},SView.prototype.ExchangeModelVisible=function(){new M3D.SelectionOperator(this.view).ExchangeHidden()},SView.prototype.StartAutoRotate=function(e){this.SetRotateSpeed(e),this.SetExplosiveStyleNoRestore(M3D.ExplosiveStyle.NOEXPLOSIVE),this.StartRotateAndExplosive()},SView.prototype.StopAutoRotate=function(){this.EndExplosiveTimer()},SView.prototype.SetPickShapeType=function(e){this.PickShapeType=e},SView.prototype.GetPickShapeType=function(){return this.PickShapeType},SView.prototype.IsHighlight=function(e){return e.IsHightlight()},SView.prototype.Highlight=function(e,t){e.SetInitHightlight(t)},SView.prototype.Clip=function(para){var clipPara=eval("("+para+")"),direction=clipPara.direction,position=clipPara.position/100,showClipPlane=clipPara.showClipPlane,showCutPlane=clipPara.showCutPlane;direction&&position&&null!=showClipPlane&&null!=showCutPlane&&this.view.SetClipPlane(direction,position,showClipPlane,showCutPlane)},SView.prototype.multiClip=function(e){for(var t=0;t<e.length;t++)this.Clip(e[t])},SView.prototype.CancelClip=function(){this.view.ClearClipPlane(),this.curClipValue=0},SView.prototype.CancelExplosive=function(){this.explosiveManager.CloseExplosive()},SView.prototype.Explosive=function(para){var explosivePara=eval("("+para+")"),curExplosiveStyle=explosivePara.type,curExplosivePercentage=explosivePara.position/100;this.view.SetExplosiveView(curExplosiveStyle,curExplosivePercentage,!1)},SView.prototype.GetanimationManager=function(){return this.view.GetSimulationMgr()},SView.prototype.GetLightManager=function(){return this.view.GetSceneManager().GetLightManager()},SView.prototype.GetBomManager=function(){return this.view.GetBomManager()},SView.prototype.GetCamera=function(e){return this.view.GetSceneManager().GetCamera()},SView.prototype.Create3DGestureNote=function(e,t){var r=[],i=[],n=[];if(1===t)for(var o=0;o<e.length;o++){for(var a=[],s=[],l=e[o],h=0;h<l.x.length;h++){var u=new M3D.Vector2(l.x[h],l.y[h]);a.push(u)}var p=void 0,c=l.color,d=parseInt(c.substr(1,2),16),S=parseInt(c.substr(3,2),16),f=parseInt(c.substr(5,2),16);p=new M3D.Color(d/255,S/255,f/255,1),s.push(p),i.push(s),r.push(a);var m=l.font;n.push(m)}else if(2===t){a=[],s=[];if(e.length<1)return;l=e[e.length-1];for(var y=new M3D.Vector2(l.x[0],l.y[0]),T=new M3D.Vector2(l.x[l.x.length-1],l.y[l.y.length-1]),M=Math.sqrt(Math.abs((y.x-T.x)*(y.x-T.x))+(y.y-T.y)*(y.y-T.y)),g=0;g<=360;g+=10){var v=y.x+M*Math.cos(g*Math.PI/180),C=y.y+M*Math.sin(g*Math.PI/180);a.push(new M3D.Vector2(v,C))}p=void 0,c=l.color,d=parseInt(c.substr(1,2),16),S=parseInt(c.substr(3,2),16),f=parseInt(c.substr(5,2),16);p=new M3D.Color(d/255,S/255,f/255,1),s.push(p),i.push(s),r.push(a);m=l.font;n.push(m)}else if(3===t){a=[],s=[];if(e.length<1)return;l=e[e.length-1];var _=new M3D.Vector2(l.x[0],l.y[0]),A=new M3D.Vector2(l.x[l.x.length-1],l.y[l.y.length-1]),E=new M3D.Vector2(l.x[0],l.y[l.y.length-1]);T=new M3D.Vector2(l.x[l.x.length-1],l.y[0]);a.push(_),a.push(E),a.push(A),a.push(T),a.push(_);p=void 0,c=l.color,d=parseInt(c.substr(1,2),16),S=parseInt(c.substr(3,2),16),f=parseInt(c.substr(5,2),16);p=new M3D.Color(d/255,S/255,f/255,1),s.push(p),i.push(s),r.push(a);m=l.font;n.push(m)}else if(4===t){a=[],s=[];if(e.length<1)return;l=e[e.length-1],_=new M3D.Vector2(l.x[0],l.y[l.y.length-1]),A=new M3D.Vector2(l.x[l.x.length-1],l.y[l.y.length-1]);var G=(l.x[l.x.length-1]+l.x[0])/2,P=l.y[0];a.push(_),a.push(A),a.push(new M3D.Vector2(G,P)),a.push(_);p=void 0,c=l.color,d=parseInt(c.substr(1,2),16),S=parseInt(c.substr(3,2),16),f=parseInt(c.substr(5,2),16);p=new M3D.Color(d/255,S/255,f/255,1),s.push(p),i.push(s),r.push(a);m=l.font;n.push(m)}(new SView_1.SThreeDGestureNote).Create3DGestureNote(r,i,n,this)},SView.prototype.HotSpotCreate=function(e,t,r){var i=new M3D.Vector2(e,t),n=new M3D.Vector3;this.view.GetSceneManager().GetPickPoint(i,n,!1);var o,a=(new Date).getTime(),s=n.x,l=n.y,h=n.z,u=this.GetCamera(null),p=u.GetPosition().x,c=u.GetPosition().y,d=u.GetPosition().z,S=u.GetRotation().w,f=u.GetRotation().x,m=u.GetRotation().y,y=u.GetRotation().z,T=u.GetZoom(),M=u.GetZoom(),g=u.GetZoom(),v=new M3D.ImageModel;o="./Platform/Ctrls/SView/sview/css/images/hotspot.png";var C=this.view.GetSceneManager().GetResourceManager(),_=C.GetImage(o);null===_&&(_=C.GetOrCreateImage(o,o)),v.SetImage(_);var A=M3D.Parameters.Instance().hotSpotImageSize;return v.SetImageSize(n,new M3D.Vector2(A,A)),v.SetAllowScall(!1),v.SetAllowRotate(!1),v.SetInTopShow(!0),new SView_1.SHotSpot(a,r,"","","","",-1,-1,-1,s,l,h,p,c,d,S,f,m,y,T,M,g,0,v)},SView.prototype.CreateSHotSpot=function(e,t,r,i,n,o,a){var s=new M3D.Vector2(e,t),l=new M3D.Vector3;this.view.GetSceneManager().GetPickPoint(s,l,!1);var h=(new Date).getTime(),u=h+"",p=l.x,c=l.y,d=l.z,S=this.GetCamera(null),f=S.GetPosition().x,m=S.GetPosition().y,y=S.GetPosition().z,T=S.GetRotation().w,M=S.GetRotation().x,g=S.GetRotation().y,v=S.GetRotation().z,C=S.GetZoom(),_=S.GetZoom(),A=S.GetZoom(),E=new M3D.ImageModel,G="";G=a||"./Platform/Ctrls/SView/sview/css/images/hotspot.png";var P=this.view.GetSceneManager().GetResourceManager(),w=P.GetImage(G);null===w&&(w=P.GetOrCreateImage(G,G)),E.SetImage(w);var D=M3D.Parameters.Instance().hotSpotImageSize;E.SetImageSize(l,new M3D.Vector2(D,D)),E.SetAllowScall(!1),E.SetAllowRotate(!1),E.SetInTopShow(!0),this.GetView().GetSceneManager().GetHandlerGroup().AddSVLTool(E,u);var x=new SView_1.SHotSpot(h,u,r,null,null,"",i,n,o,p,c,d,f,m,y,T,M,g,v,C,_,A,0,E);SView_1.SHotSpotManager.Instance().AddHotSpot(x)},SView.prototype.SetObserveMode=function(e,t){if(null!=e){switch(e){case 0:this.view.commonTouchHandler.freeViewMode=!0,this.view.commonTouchHandler.controlLockXY=!1,this.view.commonTouchHandler.oribitMode=!1;break;case 1:this.view.commonTouchHandler.freeViewMode=!1,this.view.commonTouchHandler.controlLockXY=!1,this.view.commonTouchHandler.oribitMode=!0;break;case 2:this.view.commonTouchHandler.freeViewMode=!1,this.view.commonTouchHandler.controlLockXY=!0,this.view.commonTouchHandler.oribitMode=!1;break;default:this.view.commonTouchHandler.freeViewMode=!0,this.view.commonTouchHandler.controlLockXY=!1,this.view.commonTouchHandler.oribitMode=!1}t&&(this.view.commonTouchHandler.oberveMode=e)}},SView.TOUCH_NORMAL=0,SView.TOUCH_ROTATE=1,SView.TOUCH_SELECT=5,SView.TOUCH_ZOOM=3,SView}(),CreateType,MMd;SView_1.SView=SView,MMd=CreateType=SView_1.CreateType||(SView_1.CreateType={}),MMd[MMd.HTML=1]="HTML",MMd[MMd.Note=2]="Note"}(SView||(SView={})),function(t){var e=function(r){function e(e){var t=r.call(this,e)||this;return t.offset=0,t.dynamic=!1,t.bufferSize=0,t.bufferOffset=0,t.bufferType=0,t.webGLBuffer=null,t.cacheData=null,t}return __extends(e,r),e.prototype.SetSize=function(e,t){this.dynamic=t,this.bufferSize=e},e.prototype.SetData=function(e){},e.prototype.SetDataRange=function(e,t){return null!==this.cacheData&&e instanceof Int8Array&&this.cacheData.set(e,t),!0},e.prototype.SetOffset=function(e){this.bufferOffset=e},e.prototype.GetOffset=function(){return this.bufferOffset},e.prototype.Create=function(e,t){return this.bufferType=e,this.bufferSize=t,this.cacheData=new Float32Array(this.bufferSize),!0},e.prototype.Bind=function(){this.gl.bindBuffer(t.GL.ELEMENT_ARRAY_BUFFER,this.webGLBuffer)},e.prototype.UnBind=function(){this.gl.bindBuffer(t.GL.ELEMENT_ARRAY_BUFFER,null)},e.prototype.BufferType=function(){return this.bufferType},e.prototype.HasValue=function(){return null!==this.webGLBuffer},e.prototype.WriteBuffer=function(){this.webGLBuffer=this.gl.createBuffer(),this.Bind(),this.dynamic?this.gl.bufferData(t.GL.ELEMENT_ARRAY_BUFFER,this.cacheData,t.GL.DYNAMIC_DRAW):this.gl.bufferData(t.GL.ELEMENT_ARRAY_BUFFER,this.cacheData,t.GL.STATIC_DRAW),this.UnBind()},e.prototype.Init=function(){},e}(t.GPUObject);t.HardWareIndexBuffer=e}(M3D||(M3D={})),function(M3D){var Camera=function(_super){function Camera(){var e=_super.call(this)||this;return e.viewPort=new M3D.Viewport,e.isAnimation=!1,e.origRotateCenter=new M3D.Vector3,e.rotateCenter=new M3D.Vector3,e.view=new M3D.Matrix3x4,e.projection=new M3D.Matrix4,e.projectionOffset=new M3D.Vector2,e.frustum=new M3D.Frustum,e.viewDirty=!0,e.projectionDirty=!0,e.frustumDirty=!0,e.orthographic=!0,e.nearClip=.001,e.farClip=1e4,e.fov=35,e.orthoSize=10,e.aspectRatio=1,e.zoom=1,e.lodBias=1,e.autoAspectRatio=!1,e.flipVertical=!1,e.focalLength=100,e.cameraMode=0,e.leftEyeMat=new M3D.Matrix3x4,e.rightEyeMat=new M3D.Matrix3x4,e.tempMatrix=new M3D.Matrix3x4,e.scene=null,e.viewPort.SetCamera(e),e}return __extends(Camera,_super),Camera.prototype.SetCamera=function(e,t,r,i,n,o,a){this.SetPosition(e),this.SetRotation(t),this.SetZoom(r),this.SetOrthographic(i),this.SetNearClip(n),this.SetFarClip(o),this.SetFov(a)},Camera.prototype.SetState=function(state){var stateJson=eval("("+state+")");for(var key in stateJson)if("position"===key){var positation=stateJson[key],xyz=positation.split(" ");this.SetPosition(new M3D.Vector3(Number(xyz[0]),Number(xyz[1]),Number(xyz[2])))}else if("rotate"===key){var rotate=stateJson[key],xyz=rotate.split(" ");this.SetRotation(new M3D.Quaternion(Number(xyz[0]),Number(xyz[1]),Number(xyz[2])))}else"zoom"===key&&this.SetZoom(Number(stateJson[key]))},Camera.prototype.Clone=function(e){var t=new Camera;return t.SetCamera(e.GetPosition(),e.GetRotation(),e.GetZoom(),e.GetOrthographic(),e.GetNearClip(),e.GetFarClip(),e.GetFov()),t},Camera.prototype.SetScale=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];"number"==typeof e[0]?.001<e[0]&&(this.zoom*=e[0]):e[0]instanceof M3D.Vector3&&(this.scale=e[0].Abs(),this.MarkDirty())},Camera.prototype.ReSet=function(){_super.prototype.Reset.call(this),this.zoom=1,this.rotateCenter=this.origRotateCenter.Clone(),this.worldMatrix=M3D.Matrix3x4.IDENTITY().Clone()},Camera.prototype.Traverse=function(e){},Camera.prototype.ZoomView=function(e){.001<e&&(this.zoom*=e),this.projectionDirty=!0,this.frustumDirty=!0,this.viewDirty=!0,this.dirty=!0},Camera.prototype.GetOrthoSize=function(){return new M3D.Vector2(this.orthoSize*this.aspectRatio,this.orthoSize)},Camera.prototype.RotateAroundCenter=function(e,t){var r=e.Clone();switch(t){case M3D.SceneNode.TS_LOCAL:case M3D.SceneNode.TS_PARENT:break;case M3D.SceneNode.TS_WORLD:r=this.rotation.Multiply(e).MultiplyED(this.rotation.Inverse())}this.RotateAround(this.rotateCenter,r,t)},Camera.prototype.GetViewPort=function(){return this.viewPort},Camera.prototype.SetViewPort=function(e,t,r,i){var n=new M3D.IntRect(e,t,e+r,t+i);this.viewPort.SetRect(n),this.MarkDirty()},Camera.prototype.SetNearClip=function(e){this.nearClip=M3D.Max(e,M3D.MIN_NEARCLIP),this.frustumDirty=!0,this.projectionDirty=!0},Camera.prototype.SetFarClip=function(e){this.farClip=M3D.Max(e,M3D.MIN_NEARCLIP),this.frustumDirty=!0,this.projectionDirty=!0},Camera.prototype.SetFov=function(e){this.fov=M3D.Clamp(e,0,M3D.MAX_FOV),this.frustumDirty=!0,this.projectionDirty=!0},Camera.prototype.SetOrthoSize=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(1===e.length)if(e[0]instanceof M3D.Vector2){var r=e[0];this.autoAspectRatio=!1,this.orthoSize=r.y,this.aspectRatio=r.x/r.y,this.frustumDirty=!0,this.projectionDirty=!0}else this.orthoSize=e[0],this.aspectRatio=1,this.frustumDirty=!0,this.projectionDirty=!0},Camera.prototype.SetAspectRatio=function(e){this.autoAspectRatio=!1,this.SetAspectRatioInternal(e)},Camera.prototype.SetAspectRatioInternal=function(e){this.aspectRatio=e,this.frustumDirty=!0,this.projectionDirty=!0},Camera.prototype.SetZoom=function(e){this.zoom=M3D.Max(e,M3D.EPSILON),this.viewDirty=!0,this.frustumDirty=!0,this.projectionDirty=!0},Camera.prototype.SetLodBias=function(e){},Camera.prototype.GetOrthographic=function(){return this.orthographic},Camera.prototype.SetOrthographic=function(e){this.orthographic=e,this.frustumDirty=!0,this.projectionDirty=!0},Camera.prototype.SetAutoAspectRatio=function(e){},Camera.prototype.SetProjectionOffset=function(e){},Camera.prototype.SetUseReflection=function(e){},Camera.prototype.GetFarClip=function(){return this.farClip},Camera.prototype.SetRotateCenter=function(e){this.rotateCenter=e},Camera.prototype.SetInitRotateCenter=function(e){this.origRotateCenter=e,this.rotateCenter=e},Camera.prototype.GetRotateCenter=function(){return this.rotateCenter},Camera.prototype.GetOrigRotateCenter=function(){return this.origRotateCenter},Camera.prototype.GetNearClip=function(){return this.orthographic?0:this.nearClip},Camera.prototype.GetHalfClip=function(){return(this.GetNearClip()+this.GetFarClip())/2},Camera.prototype.GetFov=function(){return this.fov},Camera.prototype.GetAspectRatio=function(){return this.aspectRatio},Camera.prototype.GetZoom=function(){return this.zoom},Camera.prototype.GetClipDis=function(){return this.GetFarClip()-this.GetNearClip()},Camera.prototype.IsOrthographic=function(){return this.orthographic},Camera.prototype.GetAutoAspectRatio=function(){return this.autoAspectRatio},Camera.prototype.GetFrustum=function(){if(this.frustumDirty){var e=this.GetEffectiveWorldTransform();this.orthographic?this.frustum.DefineOrtho(this.orthoSize,this.aspectRatio,this.zoom,this.GetNearClip(),this.farClip,e):this.frustum.Define(this.fov,this.aspectRatio,this.zoom,this.GetNearClip(),this.farClip,e),this.frustumDirty=!1}return this.frustum},Camera.prototype.GetProjection=function(){return this.projectionDirty&&(this.projection=this.GetProjection2(!0),this.projectionDirty=!1),this.projection},Camera.prototype.GetProjection2=function(e){var t=M3D.Matrix4.ZERO().Clone(),r=e;if(this.orthographic){o=(i=1/(.5*this.orthoSize)*this.zoom)/this.aspectRatio,a=void 0,s=void 0;s=r?(a=-2/this.farClip,-1):(a=-1/this.farClip,0),t.data[0]=o,t.data[3]=2*this.projectionOffset.x,t.data[5]=i,t.data[7]=2*this.projectionOffset.y,t.data[10]=a,t.data[11]=s,t.data[15]=1}else{var i,n=this.GetNearClip(),o=(i=1/Math.tan(this.fov*M3D.DEGTORAD*.5)*this.zoom)/this.aspectRatio,a=void 0,s=void 0;s=r?(a=-(this.farClip+n)/(this.farClip-n),-2*this.farClip*n/(this.farClip-n)):(a=-this.farClip/(this.farClip-n))*n,t.data[0]=o,t.data[2]=2*this.projectionOffset.x,t.data[5]=i,t.data[6]=2*this.projectionOffset.y,t.data[10]=a,t.data[11]=s,t.data[14]=-1}return t},Camera.prototype.GetView=function(){if(this.viewDirty&&(this.view=this.GetEffectiveWorldTransform().Inverse(),this.viewDirty=!1,this.IsOrthographic()&&this.scene)){var e=this.scene.GetSceneBox(),t=this.GetFrustum().planes[0];if(t.Distance(e.min)*t.Distance(e.max)<0){var r=this.GetPosition(),i=(t.Project(e.Center()),r.Sub(e.Center()).Length(),this.GetView().ToMatrix3()),n=new M3D.Vector3(i.data[6],i.data[7],i.data[8]),o=new M3D.Plane(n,e.Center()).Distance(r);n.Normalize();var a=this.scene.GetDefaultFocusLength();this.SetNearClip(a*M3D.NEAR_CLIP_PLANE_FACTOR),this.SetFarClip(a*M3D.FAR_CLIP_PLANE_FACTOR);var s=r.Add(n.Multiply(a-o));this.isAnimation||this.SetWorldPosition(s)}}return 1==this.cameraMode?this.tempMatrix=this.leftEyeMat.Multiply(this.view):2==this.cameraMode?this.tempMatrix=this.rightEyeMat.Multiply(this.view):this.tempMatrix=this.view.Clone(),this.tempMatrix},Camera.prototype.GetFrustumSize=function(e,t){if(e.z=this.GetNearClip(),t.z=this.farClip,this.orthographic){r=.5*this.orthoSize/this.zoom;e.y=t.y=r,e.x=t.x=e.y*this.aspectRatio}else{var r=Math.tan(this.fov*M3D.DEGTORAD*.5)/this.zoom;e.y=e.z*r,e.x=e.y*this.aspectRatio,t.y=t.z*r,t.x=t.y*this.aspectRatio}this.flipVertical&&(e.y=-e.y,t.y=-t.y)},Camera.prototype.GetHalfViewSize=function(){return this.orthographic?.5*this.orthoSize/this.zoom:Math.tan(this.fov*M3D.DEGTORAD*.5)/this.zoom},Camera.prototype.GetEffectiveWorldTransform=function(){return new M3D.Matrix3x4(this.GetWorldPosition(),this.GetWorldRotation(),1)},Camera.prototype.GetScreenRay=function(e,t){var r=new M3D.Ray;if(!this.IsProjectionValid())return r.origin=this.GetWorldPosition(),r.direction=this.GetWorldDirection(),r;var i=this.GetProjection2(!1).Multiply(this.GetView()).Inverse();e=2*e-1,t=1-2*t;var n=new M3D.Vector3(e,t,0),o=new M3D.Vector3(e,t,1);return r.origin=i.Multiply(n),r.direction=i.Multiply(o).SubED(r.origin).NormalizedED(),r},Camera.prototype.WorldToScreenPoint=function(e){var t=this.GetView().Multiply(e),r=new M3D.Vector2;if(t.z<0){var i=this.GetProjection2(!1).Multiply(t);r.x=i.x,r.y=i.y}else r.x=0<-t.x?-1:1,r.y=0<-t.y?-1:1;return r.x=r.x/2+.5,r.y=1-(r.y/2+.5),r},Camera.prototype.ScreenToWorldPoint=function(e){var t=this.GetScreenRay(e.x,e.y);return t.origin.Add(t.direction.Multiply(e.z))},Camera.prototype.GetSceneManager=function(){return this.scene},Camera.prototype.GetDistance=function(e){return 0},Camera.prototype.GetDistanceSquared=function(e){return 0},Camera.prototype.IsProjectionValid=function(){return this.farClip>this.GetNearClip()},Camera.prototype.OnMarkedDirty=function(){this.frustumDirty=!0,this.viewDirty=!0,this.frustumDirty=!0},Camera.prototype.SetCameraMode=function(e){this.cameraMode=e},Camera.prototype.SetPupilDistance=function(e){this.leftEyeMat.SetTranslation(new M3D.Vector3(e,0,0)),this.rightEyeMat.SetTranslation(new M3D.Vector3(-e,0,0))},Camera.prototype.GetFitClip=function(){return this.GetWorldPosition().Sub(this.GetRotateCenter()).Length()-this.GetNearClip()},Camera.prototype.toString=function(){return'Position="'+this.GetPosition().toPlainString()+'"  Rotation="'+this.GetRotation().Tostring()+'" ZoomFactor="'+this.GetZoom()+'"  Orthographic="'+this.GetOrthographic()+'"  NearClip="'+this.GetNearClip()+'"  FarClip="'+this.GetFarClip()+'" FOV="'+this.GetFov()+'"'},Camera.prototype.SetSceneManager=function(e){this.scene=e},Camera.prototype.GetStates=function(){var e=this.GetPosition(),t=this.GetRotation(),r=this.GetZoom(),i='{"position":"'+e.x+" "+e.y+" "+e.z+'","rotate":"'+t.x+" "+t.y+" "+t.z+" "+t.w+'","zoom":"'+r+'"}';return JSON.parse(i)},Camera.FRUSTUINTER=0,Camera.FRUSTUOUT=1,Camera.FRUSTUINER=2,Camera}(M3D.SceneNode);M3D.Camera=Camera}(M3D||(M3D={})),function(t){var e=function(r){function e(e){var t=r.call(this,e)||this;return t.offset=0,t.dynamic=!1,t.bufferSize=0,t.bufferOffset=0,t.bufferType=0,t.normalOffset=0,t.vertexOffset=0,t.textureCoordsOffset=0,t.centersOffset=0,t.webGLBuffer=null,t.cacheData=null,t}return __extends(e,r),e.prototype.SetSize=function(e,t){this.bufferSize=e,this.dynamic=t},e.prototype.SetData=function(e){},e.prototype.SetNormalOffset=function(e){this.normalOffset=e},e.prototype.GetNormalOffset=function(){return this.normalOffset},e.prototype.SetVertexOffset=function(e){this.vertexOffset=e},e.prototype.GetVertexOffset=function(){return this.vertexOffset},e.prototype.SetTextureCoordsOffset=function(e){this.textureCoordsOffset=e},e.prototype.GetTextureCoordsOffset=function(){return this.textureCoordsOffset},e.prototype.SetCentersCoordsOffset=function(e){this.centersOffset=e},e.prototype.GetCentersCoordsOffset=function(){return this.centersOffset},e.prototype.SetDataRange=function(e,t){return null!==this.cacheData&&e instanceof Float32Array&&this.cacheData.set(e,t),!0},e.prototype.SetOffset=function(e){this.bufferOffset=e},e.prototype.GetOffset=function(){return this.bufferOffset},e.prototype.Create=function(e,t){return void 0===e&&(e=0),void 0===t&&(t=0),this.bufferType=e,this.bufferSize=t,this.cacheData=new Float32Array(this.bufferSize),!0},e.prototype.Bind=function(){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.webGLBuffer)},e.prototype.UnBind=function(){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,null)},e.prototype.BufferType=function(){return this.bufferType},e.prototype.HasValue=function(){return null!==this.webGLBuffer},e.prototype.WriteBuffer=function(){this.webGLBuffer=this.gl.createBuffer(),this.Bind(),this.dynamic?this.gl.bufferData(t.GL.ARRAY_BUFFER,this.cacheData,t.GL.DYNAMIC_DRAW):this.gl.bufferData(t.GL.ARRAY_BUFFER,this.cacheData,t.GL.STATIC_DRAW),this.UnBind(),this.cacheData=null},e.prototype.Init=function(){},e}(t.GPUObject);t.HardWareVertexBuffer=e}(M3D||(M3D={})),function(r){var e=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.color=new r.Color,e.position=new r.Vector4,e.spotDirection=new r.Vector3,e.ambient=new r.Color,e.diffuse=new r.Color,e.specular=new r.Color,e.lightModelAmbient=new r.Color,e}return __extends(e,t),e.prototype.InitProperties=function(){},e.prototype.TurnOn=function(){this.turnOn=!0},e.prototype.TurnOff=function(){this.turnOn=!1},e.prototype.ShowShape=function(){},e.prototype.HideShape=function(){},e.prototype.SetPerVertex=function(e){this.perVertex=e},e.prototype.SetColor=function(e){this.color=e},e.prototype.SetSpecularIntensity=function(e){this.intensity=e},e.prototype.SetBrightness=function(e){this.brightness=e},e.prototype.SetRange=function(e){this.range=e},e.prototype.SetFov=function(e){this.fov=e},e.prototype.SetAspectRatio=function(e){this.aspectRatio=e},e.prototype.GetLinearAttenuation=function(){return this.linearAttenuation},e.prototype.SetLinearAttenuation=function(e){this.linearAttenuation=e},e.prototype.GetAmbient=function(){return this.ambient},e.prototype.SetAmbient=function(e){this.ambient=e},e.prototype.GetConstantAttenuation=function(){return this.constantAttenuation},e.prototype.SetConstantAttenuation=function(e){this.constantAttenuation=e},e.prototype.GetDiffuse=function(){return this.diffuse},e.prototype.SetDiffuse=function(e){this.diffuse=e},e.prototype.GetLightModelAmbient=function(){return this.lightModelAmbient},e.prototype.SetLightModelAmbient=function(e){this.lightModelAmbient=e},e.prototype.GetQuadraticAttenuation=function(){return this.quadraticAttenuation},e.prototype.SetQuadraticAttenuation=function(e){this.quadraticAttenuation=e},e.prototype.GetSpecular=function(){return this.specular},e.prototype.SetSpecular=function(e){this.specular=e},e.prototype.GetSpotCosCutoff=function(){return this.spotCosCutoff},e.prototype.SetSpotCosCutoff=function(e){this.spotCosCutoff=e},e.prototype.GetSpotCutoff=function(){return this.spotCutoff},e.prototype.SetSpotCutoff=function(e){this.spotCutoff=e},e.prototype.GetSpotDirection=function(){return this.spotDirection},e.prototype.SetSpotDirection=function(e){this.spotDirection=e},e.prototype.GetSpotExponent=function(){return this.spotExponent},e.prototype.SetSpotExponent=function(e){this.spotExponent=e},e.prototype.GetPosition=function(){return this.position},e.prototype.SetPosition=function(e){this.position=e},e.prototype.GetPerVertex=function(){return this.perVertex},e.prototype.GetColor=function(){return this.color},e.prototype.GetSpecularIntensity=function(){return this.specularIntensity},e.prototype.GetBrightness=function(){return this.brightness},e.prototype.GetRange=function(){return this.range},e.prototype.GetFov=function(){return this.fov},e.prototype.GetAspectRatio=function(){return this.aspectRatio},e.prototype.LightState=function(){return this.turnOn},e}(r.Shape);r.Light=e}(M3D||(M3D={})),function(S){var e=function(t){function e(){var e=t.call(this)||this;return e.planeList=[],e.drawBoxSize=new S.BoundingBox,e.isShowCappingPlane=!1,e.isShowClipPlane=!1,e.isReverseClipping=!1,e.showPlaneRect=!1,e}return __extends(e,t),e.prototype.GetType=function(){return S.ShapeType.SHAPE_SEQUENCE_NUMBER_NOTE},e.prototype.GetPlaneList=function(){return this.planeList},e.prototype.GetPlaneById=function(e){for(var t=this.GetPlaneList(),r=0;r<t.length;r++){var i=t[r];if(i.GetID()===e)return i}return null},e.prototype.SetTransform=function(e){for(var t=0;t<this.planeList.length;t++){this.planeList[t].SetTransform(e)}},e.prototype.FindVisiableObject=function(e){e&&(0<this.planeList.length?e.PrepareRenderSection(this):e.PrepareRenderSection(null))},e.prototype.AddPlane=function(e){if(!e)return!1;for(var t=new S.Color(.5,.5,0,.3),r=new S.Color(.7,.7,.7,1),i=0;i<this.planeList.length;++i){var n=this.planeList[i];if(n.GetID()===e.GetID()){n.Copy(e);var o=e.GetEquation(),a=new S.Vector3(o[0],o[1],o[2]),s=new S.Plane(a,o[3]),l=this.drawBoxSize.Projected(s);return n.SetDrawPlane(l),n.SetSceneBox(this.drawBoxSize),n.SetFaceColor(t),n.SetEdgeColor(r),n.UpdateDrawData1(),!1}}3<=this.planeList.length&&this.planeList.splice(0,1);var h=new S.SectionPlane;h.Copy(e),h.SetSceneBox(this.drawBoxSize),h.UpdateDrawData1();var u=e.GetEquation(),p=new S.Vector3(u[0],u[1],u[2]),c=new S.Plane(p,u[3]),d=this.drawBoxSize.Projected(c);return h.SetDrawPlane(d),h.SetFaceColor(t),h.SetEdgeColor(r),h.UpdateDrawData1(),this.planeList.push(h),!0},e.prototype.RemovePlane=function(e){for(var t=0;t<this.planeList.length;++t){if(this.planeList[t].GetID()==e.GetID())return this.planeList.splice(t,1),!0}return!1},e.prototype.ClearPlanes=function(){for(var e=0;e<this.planeList.length;++e){this.planeList[e].SetEnable(!1)}this.planeList.length=0},e.prototype.SetDrawRection=function(e){this.drawBoxSize=e.Clone()},e.prototype.GetDrawRection=function(){return this.drawBoxSize.Clone()},e.prototype.SetIsShowCappingPlane=function(e){this.isShowCappingPlane=e;for(var t=this.GetPlaneList(),r=0;r<t.length;r++)t[r].SetShowCappingPlane(this.isShowCappingPlane)},e.prototype.IsShowCappingPlane=function(){return this.isShowCappingPlane},e.prototype.IsReverseClipping=function(){return this.isReverseClipping},e.prototype.GetShowClipPlane=function(){return this.isShowClipPlane},e.prototype.GetShowPlaneRect=function(){return this.showPlaneRect},e.prototype.SetShowClipPlane=function(e){this.isShowClipPlane=e;for(var t=this.GetPlaneList(),r=0;r<t.length;r++);},e.prototype.SetShowPlaneRect=function(e){this.showPlaneRect=e;for(var t=this.GetPlaneList(),r=0;r<t.length;r++)t[r].SetShowPlaneRect(this.showPlaneRect)},e.prototype.SetIsReverseClipping=function(e){this.isReverseClipping=e},e}(S.Shape);S.Section=e}(M3D||(M3D={})),function(G){var e=function(){function r(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];switch(this.equation=[0,0,0,0],this.id=-1,this.glClipPlaneID=-1,this.origin=new G.Vector3,this.normal=new G.Vector3,this.uDir=new G.Vector3,this.vDir=new G.Vector3,this.name="",this.enable=!1,this.showPlaneRect=!1,this.showCutPlane=!1,this.showCappingPlane=!1,this.width=-1,this.height=-1,this.points=[],this.normals=[],this.uvs=[],this.edgePoints=[],this.dirty=!0,this.center=new G.Vector3,this.size=new G.Vector2,this.box=new G.BoundingBox,this.edgeColor=new G.Color,this.faceColor=new G.Color,this.facePositionVBO=null,this.edgePositionVBO=null,this.gl=null,this.isNeedUpdateFace=!0,this.isNeedUpdateEdge=!0,this.sceneBox=new G.BoundingBox,e.length){case 0:this.id=r.maxId++,this.glClipPlaneID=-1,this.enable=!1,this.edgeColor=G.Color.BLACK().Clone(),this.faceColor=G.Color.BLACK().Clone(),this.faceColor.a=.5,this.Init();break;case 4:this.id=r.maxId++,this.glClipPlaneID=-1,this.enable=!1,this.origin=e[0].Clone(),this.normal=e[1].Clone(),this.uDir=e[2].Clone(),this.vDir=e[3].Clone(),this.GetParam(),this.Init()}this.transformEquation=new Array}return r.prototype.GetID=function(){return this.id},r.prototype.SetID=function(e){this.id=e},r.prototype.GetEnable=function(){return this.enable},r.prototype.SetEnable=function(e){this.enable=e},r.prototype.SetShowPlaneRect=function(e){this.showPlaneRect=e},r.prototype.GetShowPlaneRect=function(){return this.SetShowPlaneRect},r.prototype.SetShowCutPlane=function(e){this.showCutPlane=e},r.prototype.GetShowCutPlane=function(){return this.showCutPlane},r.prototype.SetShowCappingPlane=function(e){this.showCappingPlane=e},r.prototype.GetShowCappingPlane=function(){return this.showCappingPlane},r.prototype.SetName=function(e){this.name=e},r.prototype.SetPlaneParam=function(e,t,r,i){this.equation[0]=e,this.equation[1]=t,this.equation[2]=r,this.equation[3]=i;var n=G.Matrix3x4.IDENTITY();this.SetTransform(n)},r.prototype.SetDrawPlane=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];switch(e.length){case 1:this.box=e[0].Clone(),this.dirty=!0,this.isNeedUpdateEdge=!0,this.isNeedUpdateFace=!0,this.UpdateDrawData1();break;case 2:this.center=e[0].Clone(),this.size=e[1].Clone(),this.dirty=!0}},r.prototype.Copy=function(e){e&&(this.equation[0]=e.equation[0],this.equation[1]=e.equation[1],this.equation[2]=e.equation[2],this.equation[3]=e.equation[3]+this.box.Length()/1e4,this.id=e.id,this.enable=e.GetEnable(),this.transformEquation=e.GetTransformPlaneParam(),this.showCutPlane=e.GetShowCutPlane(),this.showCappingPlane=e.GetShowCappingPlane())},r.prototype.GetEquation=function(){return this.equation},r.prototype.GetPointArray=function(){return this.points},r.prototype.GetNormalArray=function(){return this.normals},r.prototype.GetLinePointArray=function(){return this.edgePoints},r.prototype.GetFaceColor=function(){return this.faceColor},r.prototype.GetEdgeColor=function(){return this.edgeColor},r.prototype.GetSceneBox=function(){return this.sceneBox},r.prototype.SetSceneBox=function(e){this.sceneBox=e},r.prototype.SetFaceColor=function(e){this.faceColor.copyFrom(e)},r.prototype.SetEdgeColor=function(e){this.edgeColor.copyFrom(e)},r.prototype.SetCurrentGLContext=function(e){this.gl=e},r.prototype.GetFacePositionVBO=function(){if(null===this.gl)return null;if(null===this.facePositionVBO&&(this.facePositionVBO=new G.HardWareVertexBuffer(this.gl)),this.isNeedUpdateFace){var e=G.ArrayHelper.ConvertToFloat32Array(this.points);this.facePositionVBO.Create(0,e.length),this.facePositionVBO.SetDataRange(e,0),this.facePositionVBO.WriteBuffer(),this.isNeedUpdateFace=!1}return this.facePositionVBO},r.prototype.GetEdgePositionVBO=function(){if(null===this.gl)return null;if(null===this.edgePositionVBO&&(this.edgePositionVBO=new G.HardWareVertexBuffer(this.gl)),this.isNeedUpdateEdge){var e=G.ArrayHelper.ConvertToFloat32Array(this.edgePoints);this.edgePositionVBO.Create(0,e.length),this.edgePositionVBO.SetDataRange(e,0),this.edgePositionVBO.WriteBuffer(),this.isNeedUpdateEdge=!1}return this.edgePositionVBO},r.prototype.Init=function(){},r.prototype.SetTransform=function(e){var t=new G.Plane(new G.Vector3(this.equation[0],this.equation[1],this.equation[2]),this.equation[3]);t.Transform(e);var r=t.normal.x,i=t.normal.y,n=t.normal.z,o=t.d;this.SetTransformPlaneParam(r,i,n,o),this.dirty=!0,this.UpdateDrawData1()},r.prototype.GetParam=function(){var e=this.normal.x,t=this.normal.y,r=this.normal.z,i=-(e*this.origin.x+t*this.origin.y+r*this.origin.z);this.equation[0]=e,this.equation[1]=t,this.equation[2]=r,this.equation[3]=i},r.prototype.SetTransformPlaneParam=function(e,t,r,i){this.transformEquation[0]=e,this.transformEquation[1]=t,this.transformEquation[2]=r,this.transformEquation[3]=i},r.prototype.UpdateDrawData1=function(){if(this.dirty){var e=this.GetTransformPlaneParam(),t=new G.Vector3(e[0],e[1],e[2]),r=new G.Plane(t,e[3]),i=r.Project(this.sceneBox.Center().Clone());this.points.length=0,this.normals.length=0,this.uvs.length=0,this.edgePoints.length=0;for(var n=[this.sceneBox.min.Clone(),this.sceneBox.max.Clone()],o=[],a=[],s=0;s<8;s++){var l=new G.Vector3;l.x=n[(4&s)>>2].x,l.y=n[(2&s)>>1].y,l.z=n[1&s].z,o[s]=l.Clone(),a[s]=r.Project(o[s])}var h=new G.Vector3,u=[];for(s=0;s<8;s++){for(var p=!1,c=0;c<u.length;++c)if(a[s].Equals(u[c])){p=!0;break}p||u.push(a[s])}2<=u.length?h=u[1].Sub(u[0]):1==u.length&&(h=u[0].Sub(i)),h.Normalize();var d=[h.x,h.y,h.z],S=[i.x,i.y,i.z],f=[t.x,t.y,t.z],m=new G.Matrix3x4;if(0!=this.CalMatrixByPntXZAxis(S,f,d,m))return;for(s=0;s<8;++s)a[s]=m.Multiply(a[s]);var y=new G.BoundingBox;for(s=0;s<8;s++)0==s?(y.min=a[s].Clone(),y.max=a[s].Clone()):(y.min.x=a[s].x<y.min.x?a[s].x:y.min.x,y.min.y=a[s].y<y.min.y?a[s].y:y.min.y,y.min.z=a[s].z<y.min.z?a[s].z:y.min.z,y.max.x=a[s].x>y.max.x?a[s].x:y.max.x,y.max.y=a[s].y>y.max.y?a[s].y:y.max.y,y.max.z=a[s].z>y.max.z?a[s].z:y.max.z);y.min=new G.Vector3(y.min.y,y.min.z,y.min.x),y.max=new G.Vector3(y.max.y,y.max.z,y.max.x);y.min,y.max;var T=[];T[0]=y.min,T[1]=new G.Vector3(y.max.x,y.min.y,y.max.z),T[2]=new G.Vector3(y.min.x,y.max.y,y.min.z),T[3]=y.max,T[2].Equals(T[0])&&T[3].Equals(T[1])&&(T[2]=new G.Vector3(T[2].x,T[2].y,T[3].z),T[1]=new G.Vector3(T[1].x,T[1].y,T[0].z));var M=new G.Matrix3x4;M.MultiTranslate(i);var g=T[0].Sub(T[1]).CrossProduct(T[0].Sub(T[2])),v=new G.Quaternion(g,t),C=new G.Quaternion(90,t),_=new G.Matrix3x4(v.RotationMatrix()),A=new G.Matrix3x4(C.RotationMatrix());(M=(M=M.Multiply(A)).Multiply(_)).MultiTranslate(y.Center().Nagative());for(s=0;s<4;s++)T[s]=M.Multiply(T[s]);this.center=T[0].Add(T[3]).Multiply(.5);var E=[];this.points.push(T[0]),this.points.push(T[1]),this.points.push(T[2]),this.points.push(T[1]),this.points.push(T[2]),this.points.push(T[3]),E[0]=T[2].Sub(T[0]).CrossProduct(T[1].Sub(T[0])).Normalized(),this.normals.push(E[0]),this.normals.push(E[0]),this.normals.push(E[0]),this.normals.push(E[0]),this.normals.push(E[0]),this.normals.push(E[0]),this.edgePoints.push(T[0]),this.edgePoints.push(T[1]),this.edgePoints.push(T[1]),this.edgePoints.push(T[3]),this.edgePoints.push(T[3]),this.edgePoints.push(T[2]),this.edgePoints.push(T[2]),this.edgePoints.push(T[0]),this.dirty=!1}},r.prototype.CalMatrixByPntXZAxis=function(e,t,r,i){var n=0,o=[],a=[],s=[];return 0!=SView.CMathVector.LengthAndUnit(3,t,0,s)?n=-1:0!=SView.CMathVector.LengthAndUnit(3,r,0,o)?n=-1:(SView.CMathVector.Cross(s,o,a),i[0]=o[0],i[1]=a[0],i[2]=s[0],i[3]=o[1],i[4]=a[1],i[5]=s[1],i[6]=o[2],i[7]=a[2],i[8]=s[2],i[9]=-(o[0]*e[0]+o[1]*e[1]+o[2]*e[2]),i[10]=-(a[0]*e[0]+a[1]*e[1]+a[2]*e[2]),i[11]=-(s[0]*e[0]+s[1]*e[1]+s[2]*e[2]),n)},r.prototype.UpdateDrawData=function(){if(this.dirty){G.LOGI("SectionPlane::UpdateDrawData()"),this.points.length=0,this.normals.length=0,this.uvs.length=0,this.edgePoints.length=0;this.box.GetTriangleArray();var e=this.box.min.Clone(),t=this.box.max.Clone(),r=[];r[0]=e,r[1]=new G.Vector3(t.x,e.y,e.z),r[2]=new G.Vector3(e.x,t.y,e.z),r[3]=new G.Vector3(t.x,t.y,e.z),r[4]=new G.Vector3(e.x,e.y,t.z),r[5]=new G.Vector3(t.x,e.y,t.z),r[6]=new G.Vector3(e.x,t.y,t.z),r[7]=t,this.points.push(r[1]),this.points.push(r[0]),this.points.push(r[2]),this.points.push(r[0]),this.points.push(r[3]),this.points.push(r[2]),this.points.push(r[0]),this.points.push(r[4]),this.points.push(r[3]),this.points.push(r[0]),this.points.push(r[5]),this.points.push(r[4]),this.points.push(r[7]),this.points.push(r[4]),this.points.push(r[5]),this.points.push(r[5]),this.points.push(r[6]),this.points.push(r[7]),this.points.push(r[6]),this.points.push(r[1]),this.points.push(r[7]),this.points.push(r[1]),this.points.push(r[2]),this.points.push(r[7]),this.points.push(r[6]),this.points.push(r[0]),this.points.push(r[1]),this.points.push(r[6]),this.points.push(r[5]),this.points.push(r[0]),this.points.push(r[3]),this.points.push(r[7]),this.points.push(r[2]),this.points.push(r[3]),this.points.push(r[4]),this.points.push(r[7]),this.edgePoints.push(r[0]),this.edgePoints.push(r[1]),this.edgePoints.push(r[1]),this.edgePoints.push(r[3]),this.edgePoints.push(r[2]),this.edgePoints.push(r[3]),this.edgePoints.push(r[0]),this.edgePoints.push(r[2]),this.edgePoints.push(r[4]),this.edgePoints.push(r[5]),this.edgePoints.push(r[5]),this.edgePoints.push(r[7]),this.edgePoints.push(r[6]),this.edgePoints.push(r[7]),this.edgePoints.push(r[4]),this.edgePoints.push(r[6]),this.edgePoints.push(r[0]),this.edgePoints.push(r[4]),this.edgePoints.push(r[2]),this.edgePoints.push(r[6]),this.edgePoints.push(r[3]),this.edgePoints.push(r[7]),this.edgePoints.push(r[1]),this.edgePoints.push(r[5]),this.dirty=!1}},r.prototype.expandClpPlane=function(e,t){e.x<0?e.x=1.25*e.x:e.x=.75*e.x,e.z<0?e.z=1.25*e.z:e.z=.75*e.z,t.x<0?t.x=1.25*t.x:t.x=.75*t.x,t.z<0?t.z=1.25*t.z:t.z=.75*t.z},r.prototype.GetTransformPlaneParam=function(){return this.transformEquation},r.maxId=0,r}();G.SectionPlane=e}(M3D||(M3D={})),function(V){var e=function(t){function e(){var e=t.call(this)||this;return e.delay=50,e.instanceCount=0,e.currentReadInstanceCount=0,e}return __extends(e,t),e.prototype.ReadJSvl=function(e,t){var r;function i(e){e.asm=JSON.parse(e.text),setTimeout(n,e.delay,e),e.SetReadPercent(.12)}function n(e){e.map=e.parseBinary(e.mapObj),e.SetReadPercent(.22),setTimeout(o,e.delay,e)}function o(e){e.proto=void 0!==e.asm.ProtoTypes.TopProto?e.asm.ProtoTypes.TopProto:e.asm.ProtoTypes,void 0!==e.proto&&void 0!==e.proto.ChildIns&&e.GetInstanceCount(e.asm,e.proto),e.SetReadPercent(.25),setTimeout(a,e.delay,e)}function a(e){if(e.topModel=new V.Model,e.topModel.SetName(e.proto.Name),e.topModel.SetPlcId(0),void 0!==e.proto.ChildIns)e.SearchInstance(e.asm,e.map,e.proto,e.topModel,e);else{var t=void 0,r=new V.Matrix4,i=e.proto.Name;if(e.map.contains(i)){var n=e.map.get(i);if(""!=n){e.AddMesh(e.topModel,n[0],n[1],n[2],n[3],!1)}else t=new V.Body,e.topModel.AddBody(t)}else t=new V.Body,e.topModel.AddBody(t);e.topModel.SetPlaceMatrix(r)}setTimeout(s,e.delay,e)}function s(e){e.SetReadPercent(.9),e.EndRead()}return this.text=e,this.mapObj=t,(r=this).BeginRead(),r.SetReadPercent(.02),setTimeout(i,r.delay,r),null},e.prototype.ReadFile=function(e){return new V.Model},e.prototype.GetInstanceCount=function(e,t){var r=t.ChildIns;this.instanceCount++;for(var i=0;i<r.length;i++){var n="ChildIns"+(i+1),o=r[i][n].PointProtoName,a=e.ProtoTypes[o];void 0!==a&&void 0!==a.ChildIns&&this.GetInstanceCount(e,a)}},e.prototype.SearchInstance=function(e,t,r,i,n){n.SetReadPercent(.25+.65*n.currentReadInstanceCount++/n.instanceCount);for(var o=r.ChildIns,a=0;a<o.length;a++){var s="ChildIns"+(a+1),l=o[a][s],h=n.CreateInstance(t,l);i.AddSubModel(h);var u=l.PointProtoName,p=e.ProtoTypes[u];void 0!==p&&void 0!==p.ChildIns&&n.SearchInstance(e,t,p,h,n),h=null}},e.prototype.CreateInstance=function(e,t){var r,i,n=new V.Model,o=!1,a=new V.Matrix4,s=t.InsName;n.SetName(s),n.SetPlcId(t.PlcID),1==t.HasColor&&(o=t.Color),void 0===(r=t.PlcMatrix)?console.log("Warning: the ProtoType "+s+" have not PlacementMatrix!"):a=new V.Matrix4(r[0],r[1],r[2],r[3],r[4],r[5],r[6],r[7],r[8],r[9],r[10],r[11],r[12],r[13],r[14],r[15]);var l=t.PointProtoName;if(e.contains(l)){var h=e.get(l);""!=h?this.AddMesh(n,h[0],h[1],h[2],h[3],o):(i=new V.Body,n.AddBody(i))}else i=new V.Body,n.AddBody(i);return n.SetPlaceMatrix(a),n},e.prototype.AddMesh=function(e,t,r,i,n,o){var a,s;if(!t||t&&t.length<3)console.log("vertex array length is too short!");else{var l=new V.Color(.5,.5,.5,1),h=0;if(i&&2<i.length){for(var u=void 0,p=0,c=i.length;p<c;p+=1)if(!1!==o&&-1e-5<o[0]&&o[0]<1.00001?u=new V.Color(o[0],o[1],o[2],1-o[3]):n.length>p/3*4&&-1e-5<n[p/3*4]&&n[p/3*4]<1.00001&&(u=new V.Color(n[p/3*4],n[p/3*4+1],n[p/3*4+2],1-n[p/3*4+3])),u||(u=new V.Color(.5,.5,.5,1)),0==p)l=u,h=p;else if(!u.Equals(l)||p==i.length-1){var d=p-h;p==i.length-1&&++d,a=new Float32Array(3*d),r&&(s=new Float32Array(3*d));for(var S=0;S<d;++S)a[3*S]=t[3*i[S+h]],a[3*S+1]=t[3*i[S+h]+1],a[3*S+2]=t[3*i[S+h]+2],s&&(s[3*S]=r[3*i[S+h]],s[3*S+1]=r[3*i[S+h]+1],s[3*S+2]=r[3*i[S+h]+2]);(v=new V.VertexSet).SetUseIndex(!1),v.SetPositionArray(a);var f=new V.Body;s&&a.length==s.length?v.SetNormalArray(s):v.computeVertexNormals(),f.SetVertexSet(v);var m=new V.Face;if(l)(C=this.coverColorToMaterial(l))&&m.SetMaterial(C);m.SetInitColor(l),f.AddFace(m);var y=new V.Mesh(v),T=v.GetPositionArray().length/3;y.SetDataOffset(0),y.SetDataLength(T),m.SetMesh(y),e.AddBody(f),l=u,h=p}}else{var M=new V.Color(.5,.5,.5,1),g=0;for(u=void 0,p=0;p<t.length;++p)if(!1!==o&&-1e-5<o[0]&&o[0]<1.00001?u=new V.Color(o[0],o[1],o[2],1-o[3]):n.length>p/9*4&&-1e-5<n[p/9*4]&&n[p/9*4]<1.00001&&(u=new V.Color(n[p/9*4],n[p/9*4+1],n[p/9*4+2],1-n[p/9*4+3])),u||(u=new V.Color(.5,.5,.5,1)),0==p)M=u,g=p;else if(!u.Equals(M)||p==i.length-1){d=p-g;p==i.length-1&&++d,a=new Float32Array(d),r&&(s=new Float32Array(d));for(S=0;S<d;++S)a[S]=t[S+g],s&&(s[S]=r[S+g]);var v;(v=new V.VertexSet).SetUseIndex(!1),v.SetPositionArray(a);f=new V.Body;s&&a.length==s.length?v.SetNormalArray(s):v.computeVertexNormals(),f.SetVertexSet(v);var C;m=new V.Face;if(M)(C=this.coverColorToMaterial(M))&&m.SetMaterial(C);m.SetRenderColor(M),f.AddFace(m);y=new V.Mesh(v),T=v.GetPositionArray().length/3;y.SetDataOffset(0),y.SetDataLength(T),m.SetMesh(y),e.AddBody(f),M=u,g=p}}}},e.prototype.parseBinary=function(e){var t=e.length;new V.Dictionary;if(552<t){for(var r=new V.Dictionary,i=void 0,n=void 0,o=0,a=0;o<t;){a=o+24;var s=e.charCodeAt(a),l=e.charCodeAt(a+1)<<8,h=e.charCodeAt(a+2)<<16,u=e.charCodeAt(a+3)<<24;if(t<(o+=(s|l|h|u)+28))return console.log("RangeError: offset is outside the bounds of the DataView!"),console.log("Failed to read the prototype name!"),r;a+=16;var p=e.slice(a,a+512);if(i=this.getProtoName(p),a=o,a+=24,t<(o+=((s=e.charCodeAt(a))|(l=e.charCodeAt(a+1)<<8)|(h=e.charCodeAt(a+2)<<16)|(u=e.charCodeAt(a+3)<<24))+28))return console.log("RangeError: offset is outside the bounds of the DataView!"),console.log("Failed to read the prototype MeshDate!"),r;a+=16;var c=(s=e.charCodeAt(a))|(l=e.charCodeAt(a+1)<<8)|(h=e.charCodeAt(a+2)<<16)|(u=e.charCodeAt(a+3)<<24);if(0!==c){var d=0;n=new Array(4);var S=new Array(3*c);a+=4;for(var f=0;f<c;f++){var m=a+12*f,y=new ArrayBuffer(4),T=new Int8Array(y);T[0]=e.charCodeAt(m+0),T[1]=e.charCodeAt(m+1),T[2]=e.charCodeAt(m+2),T[3]=e.charCodeAt(m+3);var M=new DataView(y);S[d]=M.getFloat32(0,!0),T[0]=e.charCodeAt(m+4),T[1]=e.charCodeAt(m+5),T[2]=e.charCodeAt(m+6),T[3]=e.charCodeAt(m+7),M=new DataView(y),S[d+1]=M.getFloat32(0,!0),T[0]=e.charCodeAt(m+8),T[1]=e.charCodeAt(m+9),T[2]=e.charCodeAt(m+10),T[3]=e.charCodeAt(m+11),M=new DataView(y),S[d+2]=M.getFloat32(0,!0),d+=3}n[0]=S,d=0,a+=12*c,a+=12,a+=4;for(var g=new Array(3*c),v=0;v<c;v++){var C=a+12*v,_=void 0,A=new ArrayBuffer(4),E=new Int8Array(A);E[0]=e.charCodeAt(C+0),E[1]=e.charCodeAt(C+1),E[2]=e.charCodeAt(C+2),E[3]=e.charCodeAt(C+3),_=new DataView(A),g[d]=_.getFloat32(0,!0),E[0]=e.charCodeAt(C+4),E[1]=e.charCodeAt(C+5),E[2]=e.charCodeAt(C+6),E[3]=e.charCodeAt(C+7),_=new DataView(A),g[d+1]=_.getFloat32(0,!0),E[0]=e.charCodeAt(C+8),E[1]=e.charCodeAt(C+9),E[2]=e.charCodeAt(C+10),E[3]=e.charCodeAt(C+11),_=new DataView(A),g[d+2]=_.getFloat32(0,!0),d+=3}n[1]=g,a+=12*c,a+=12;var G=void 0,P=new ArrayBuffer(4),w=new Int8Array(P);w[0]=e.charCodeAt(a+0),w[1]=e.charCodeAt(a+1),w[2]=e.charCodeAt(a+2),w[3]=e.charCodeAt(a+3);var D=(G=new DataView(P)).getUint32(0,!0);a+=4;for(var x=new Array(D),R=0;R<D;R++){var I=a+4*R;w[0]=e.charCodeAt(I+0),w[1]=e.charCodeAt(I+1),w[2]=e.charCodeAt(I+2),w[3]=e.charCodeAt(I+3),G=new DataView(P),x[R]=G.getUint32(0,!0)}n[2]=x,a+=4*D,a+=12,w[d=0]=e.charCodeAt(a+0),w[1]=e.charCodeAt(a+1),w[2]=e.charCodeAt(a+2),w[3]=e.charCodeAt(a+3);var L=(G=new DataView(P)).getUint32(0,!0);a+=4;for(var N=new Array(D/3*4),O=0;O<L;O++){var b=a+16*O;w[0]=e.charCodeAt(b+0),w[1]=e.charCodeAt(b+1),w[2]=e.charCodeAt(b+2),w[3]=e.charCodeAt(b+3),G=new DataView(P),N[d]=G.getFloat32(0,!0),w[0]=e.charCodeAt(b+4),w[1]=e.charCodeAt(b+5),w[2]=e.charCodeAt(b+6),w[3]=e.charCodeAt(b+7),G=new DataView(P),N[d+1]=G.getFloat32(0,!0),w[0]=e.charCodeAt(b+8),w[1]=e.charCodeAt(b+9),w[2]=e.charCodeAt(b+10),w[3]=e.charCodeAt(b+11),G=new DataView(P),N[d+2]=G.getFloat32(0,!0),w[0]=e.charCodeAt(b+12),w[1]=e.charCodeAt(b+13),w[2]=e.charCodeAt(b+14),w[3]=e.charCodeAt(b+15),G=new DataView(P),N[d+3]=G.getFloat32(0,!0),d+=4}n[3]=N}else n="";r.getOrAdd(i,n)}return n=null,r}return console.log("Warning: Not Find MeshData!!!"),""},e.prototype.getProtoName=function(e){for(var t="",r=String.fromCharCode(0),i=0;i<e.length;i+=2){var n=String.fromCharCode(e.charCodeAt(i)|e.charCodeAt(i+1)<<8);if(n===r)break;t+=n}return t},e}(V.Reader);V.JSvlReader=e}(M3D||(M3D={})),function(g){var e=function(t){function e(){var e=t.call(this)||this;return e.lastName="",e.regexp={vertex_pattern:/^v\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)/,normal_pattern:/^vn\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)/,uv_pattern:/^vt\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)/,face_vertex:/^f\s+(-?\d+)\s+(-?\d+)\s+(-?\d+)(?:\s+(-?\d+))?/,face_vertex_uv:/^f\s+(-?\d+)\/(-?\d+)\s+(-?\d+)\/(-?\d+)\s+(-?\d+)\/(-?\d+)(?:\s+(-?\d+)\/(-?\d+))?/,face_vertex_uv_normal:/^f\s+(-?\d+)\/(-?\d+)\/(-?\d+)\s+(-?\d+)\/(-?\d+)\/(-?\d+)\s+(-?\d+)\/(-?\d+)\/(-?\d+)(?:\s+(-?\d+)\/(-?\d+)\/(-?\d+))?/,face_vertex_normal:/^f\s+(-?\d+)\/\/(-?\d+)\s+(-?\d+)\/\/(-?\d+)\s+(-?\d+)\/\/(-?\d+)(?:\s+(-?\d+)\/\/(-?\d+))?/,object_pattern:/^[og]\s*(.+)?/,smoothing_pattern:/^s\s+(\d+|on|off)/,material_library_pattern:/^mtllib /,material_use_pattern:/^usemtl /},e.delay=50,e}return __extends(e,t),e.prototype._createParserState=function(){var e={objects:[],object:{smooth:!0,startMaterial:function(e,t){},currentMaterial:function(){}},vertices:[],normals:[],uvs:[],materialLibraries:[],startObject:function(e,t){if(this.object&&!1===this.object.fromDeclaration)return this.object.name=e,void(this.object.fromDeclaration=!1!==t);this.object&&"function"==typeof this.object._finalize&&this.object._finalize();var r=this.object&&"function"==typeof this.object.currentMaterial?this.object.currentMaterial():void 0;if(this.object={name:e||"",fromDeclaration:!1!==t,geometry:{vertices:[],normals:[],uvs:[]},materials:[],smooth:!0,startMaterial:function(e,t){var r=this._finalize(!1);r&&(r.inherited||r.groupCount<=0)&&this.materials.splice(r.index,1);var i={index:this.materials.length,name:e||"",mtllib:Array.isArray(t)&&0<t.length?t[t.length-1]:"",smooth:void 0!==r?r.smooth:this.smooth,groupStart:void 0!==r?r.groupEnd:0,groupEnd:-1,groupCount:-1,inherited:!1,clone:function(e){return{index:"number"==typeof e?e:this.index,name:this.name,mtllib:this.mtllib,smooth:this.smooth,groupStart:this.groupEnd,groupEnd:-1,groupCount:-1,inherited:!1}}};return this.materials.push(i),i},currentMaterial:function(){if(0<this.materials.length)return this.materials[this.materials.length-1]},_finalize:function(e){var t=this.currentMaterial();return t&&-1===t.groupEnd&&(t.groupEnd=this.geometry.vertices.length/3,t.groupCount=t.groupEnd-t.groupStart,t.inherited=!1),!1!==e&&0===this.materials.length&&this.materials.push({name:"",smooth:this.smooth}),t}},r&&r.name&&"function"==typeof r.clone){var i=r.clone(0);i.inherited=!0,this.object.materials.push(i)}this.objects.push(this.object)},finalize:function(){this.object&&"function"==typeof this.object._finalize&&this.object._finalize()},parseVertexIndex:function(e,t){var r=parseInt(e,10);return 3*(0<=r?r-1:r+t/3)},parseNormalIndex:function(e,t){var r=parseInt(e,10);return 3*(0<=r?r-1:r+t/3)},parseUVIndex:function(e,t){var r=parseInt(e,10);return 2*(0<=r?r-1:r+t/2)},addVertex:function(e,t,r){var i=this.vertices,n=this.object.geometry.vertices;n.push(i[e+0]),n.push(i[e+1]),n.push(i[e+2]),n.push(i[t+0]),n.push(i[t+1]),n.push(i[t+2]),n.push(i[r+0]),n.push(i[r+1]),n.push(i[r+2])},addVertexLine:function(e){var t=this.vertices,r=this.object.geometry.vertices;r.push(t[e+0]),r.push(t[e+1]),r.push(t[e+2])},addNormal:function(e,t,r){var i=this.normals,n=this.object.geometry.normals;n.push(i[e+0]),n.push(i[e+1]),n.push(i[e+2]),n.push(i[t+0]),n.push(i[t+1]),n.push(i[t+2]),n.push(i[r+0]),n.push(i[r+1]),n.push(i[r+2])},addUV:function(e,t,r){var i=this.uvs,n=this.object.geometry.uvs;n.push(i[e+0]),n.push(i[e+1]),n.push(i[t+0]),n.push(i[t+1]),n.push(i[r+0]),n.push(i[r+1])},addUVLine:function(e){var t=this.uvs,r=this.object.geometry.uvs;r.push(t[e+0]),r.push(t[e+1])},addFace:function(e,t,r,i,n,o,a,s,l,h,u,p){var c,d=this.vertices.length,S=this.parseVertexIndex(e,d),f=this.parseVertexIndex(t,d),m=this.parseVertexIndex(r,d);if(void 0===i?this.addVertex(S,f,m):(c=this.parseVertexIndex(i,d),this.addVertex(S,f,c),this.addVertex(f,m,c)),void 0!==n){var y=this.uvs.length;S=this.parseUVIndex(n,y),f=this.parseUVIndex(o,y),m=this.parseUVIndex(a,y),void 0===i?this.addUV(S,f,m):(c=this.parseUVIndex(s,y),this.addUV(S,f,c),this.addUV(f,m,c))}if(void 0!==l){var T=this.normals.length;S=this.parseNormalIndex(l,T),f=l===h?S:this.parseNormalIndex(h,T),m=l===u?S:this.parseNormalIndex(u,T),void 0===i?this.addNormal(S,f,m):(c=this.parseNormalIndex(p,T),this.addNormal(S,f,c),this.addNormal(f,m,c))}},addLineGeometry:function(e,t){this.object.geometry.type="Line";for(var r=this.vertices.length,i=this.uvs.length,n=0,o=e.length;n<o;n++)this.addVertexLine(this.parseVertexIndex(e[n],r));var a=0;for(o=t.length;a<o;a++)this.addUVLine(this.parseUVIndex(t[a],i))}};return e.startObject("",!1),e},e.prototype.parse=function(e){console.time("OBJLoader");var M=this._createParserState();-1!==e.indexOf("\\\r\n")&&(e=e.replace(/\\\r\n/g,"")),-1!==e.indexOf("\r\n")&&(e=e.replace("\r\n","\n"));var c=e.split("\n"),d="",S="",f="",m=[];return function(){this.BeginRead(),this.SetReadPercent(.02),setTimeout(function(){for(var e="",t=0,r=c.length;t<r;t++)if(d=(d=c[t]).trim(),0!==d.length&&"#"!==(S=d.charAt(0)))if("v"===S)if(" "===(f=d.charAt(1))&&null!==(m=this.regexp.vertex_pattern.exec(d)))M.vertices.push(parseFloat(m[1]),parseFloat(m[2]),parseFloat(m[3]));else if("n"===f&&null!==(m=this.regexp.normal_pattern.exec(d)))M.normals.push(parseFloat(m[1]),parseFloat(m[2]),parseFloat(m[3]));else{if("t"!==f||null===(m=this.regexp.uv_pattern.exec(d)))throw new Error("Unexpected vertex/normal/uv line: '"+d+"'");M.uvs.push(parseFloat(m[1]),parseFloat(m[2]))}else if("f"===S)if(null!==(m=this.regexp.face_vertex_uv_normal.exec(d)))M.addFace(m[1],m[4],m[7],m[10],m[2],m[5],m[8],m[11],m[3],m[6],m[9],m[12]);else if(null!==(m=this.regexp.face_vertex_uv.exec(d)))M.addFace(m[1],m[3],m[5],m[7],m[2],m[4],m[6],m[8],void 0,void 0,void 0,void 0);else if(null!==(m=this.regexp.face_vertex_normal.exec(d)))M.addFace(m[1],m[3],m[5],m[7],void 0,void 0,void 0,void 0,m[2],m[4],m[6],m[8]);else{if(null===(m=this.regexp.face_vertex.exec(d)))throw new Error("Unexpected face line: '"+d+"'");M.addFace(m[1],m[2],m[3],m[4],void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0)}else if("l"===S){var i=d.substring(1).trim().split(" "),n=[],o=[];if(-1===d.indexOf("/"))n=i;else for(var a=0,s=i.length;a<s;a++){var l=i[a].split("/");""!==l[0]&&n.push(l[0]),""!==l[1]&&o.push(l[1])}M.addLineGeometry(n,o)}else if(null!==(m=this.regexp.object_pattern.exec(d))){var h=m[0].substr(1).trim();e=h}else if(this.regexp.material_use_pattern.test(d)){if(null!==(m=this.regexp.material_use_pattern.exec(d))){m[0].substr(1).trim();M.startObject(e,void 0)}M.object.startMaterial(d.substring(7).trim(),M.materialLibraries)}else if(this.regexp.material_library_pattern.test(d))M.materialLibraries.push(d.substring(7).trim());else{if(null===(m=this.regexp.smoothing_pattern.exec(d))){if("\0"===d)continue;throw new Error("Unexpected line: '"+d+"'")}var u=m[1].trim().toLowerCase();M.object.smooth="1"===u||"on"===u;var p=M.object.currentMaterial();p&&(p.smooth=M.object.smooth)}setTimeout(function(){M.finalize(),this.topModel.SetID(1),this.topModel.SetPlcId(0);for(var e=0,t=M.objects.length;e<t;e++){var r=new g.Model,i=new g.VertexSet,n=M.objects[e],o=n.geometry,a=n.materials,s=(o.type,new Float32Array(o.vertices.length)),l=void 0,h=void 0;if(0!==o.vertices.length){for(var u=0;u<o.vertices.length;u++)s[u]=o.vertices[u];if(0<o.normals.length){l=new Float32Array(o.normals.length);for(var u=0;u<o.normals.length;u++)l[u]=o.normals[u]}else i.computeVertexNormals();if(0<o.uvs.length){h=new Float32Array(o.uvs.length);for(var u=0;u<o.uvs.length;u++)h[u]=u%2==0?o.uvs[u]:1-o.uvs[u]}else{h=new Float32Array(o.vertices.length/3*2);for(var u=0;u<h.length;u++)h[u]=-1}var p=void 0;if(0<a.length){var c=a[0].mtllib;c&&("."!==c.charAt(0)||"\\"!==c.charAt(1)&&"/"!==c.charAt(1)?"\\"!==c.charAt(0)&&"/"!==c.charAt(0)||(c=c.substr(1)):c=c.substr(2),p=this.GetResourceManager().GetOrCreateMaterial(a[0].name,g.MaterialType.MaterialType_Phong,c))}i.SetPositionArray(s),null!=l&&l.length==s.length?i.SetNormalArray(l):i.computeVertexNormals(),i.SetUVArray(h);var d=new g.Body;d.SetVertexSet(i);var S=new g.ModelShape;S.AddBody(d),r.SetModelShape(S),r.AddBody(d);var f=new g.Face;if(p)f.SetMaterial(p),f.SetInitColor(p.GetDiffuse());else{var m=this.coverColorToMaterial(g.Color.GRAY().Clone());m&&(f.SetMaterial(m),f.SetInitColor(g.Color.GRAY().Clone()))}d.AddFace(f);var y=new g.Mesh(i),T=i.GetPositionArray().length/3;y.SetDataOffset(0),y.SetDataLength(T),f.SetMesh(y),r.SetName(n.name),f.SetName(n.name),r.SetPlcId(0),this.topModel.AddSubModel(r)}}this.SetReadPercent(.62),setTimeout(function(){this.SetReadPercent(.9),this.EndRead()}.bind(this),this.delay,this)}.bind(this),this.delay,this),this.SetReadPercent(.22)}.bind(this),this.delay,this)}.bind(this)(),this.topModel=new g.Model,null},e.prototype.ReadFile=function(e){return this.parse(e)},e.prototype.GetModel=function(){return this.topModel},e}(g.Reader);g.ObjReader=e}(M3D||(M3D={})),function(_){_.HEADER_SIZE=84;var e=function(t){function e(){var e=t.call(this)||this;return e.delay=50,e}return __extends(e,t),e.prototype.ReadFile=function(e){var t=this.ensureBinary(e);return this.isBinary(t)?this.parseBinary(t):this.parseASCII(this.ensureString(e))},e.prototype.GetModel=function(){return this.topModel},e.prototype.parseBinary=function(e){var p,c,d,S=new DataView(e),f=S.getUint32(80,!0),m=!1;(function(){this.BeginRead(),this.SetReadPercent(.02),setTimeout(function(){for(var e=0;e<70;e++)1129270351==S.getUint32(e,!1)&&82==S.getUint8(e+4)&&61==S.getUint8(e+5)&&(m=!0,new Float32Array(3*f*3),p=S.getUint8(e+6)/255,c=S.getUint8(e+7)/255,d=S.getUint8(e+8)/255,S.getUint8(e+9)/255);setTimeout(function(){for(var e=0;e<f;e++){var t=y+e*T,r=S.getFloat32(t,!0),i=S.getFloat32(t+4,!0),n=S.getFloat32(t+8,!0);if(m){var o=S.getUint16(t+48,!0);0==(32768&o)?((31&o)/31,(o>>5&31)/31,(o>>10&31)/31):(p,c,d)}for(var a=1;a<=3;a++){var s=t+12*a,l=S.getFloat32(s,!0),h=S.getFloat32(s+4,!0),u=S.getFloat32(s+8,!0);g[C+0]=l,g[C+1]=h,g[C+2]=u,v[C+0]=r,v[C+1]=i,v[C+2]=n,C+=3}}setTimeout(function(){this.topModel=new _.Model;var e=new _.Body;M.SetPositionArray(g),M.SetNormalArray(v),e.SetVertexSet(M);var t=new _.Face,r=this.coverColorToMaterial(t.GetRenderColor());r&&t.SetMaterial(r);e.AddFace(t);var i=new _.Mesh(M),n=M.GetPositionArray().length/3;i.SetDataOffset(0),i.SetDataLength(n),t.SetMesh(i);var o=new _.ModelShape;o.AddBody(e),this.topModel.SetModelShape(o),this.topModel.AddBody(e),this.topModel.SetID(1),this.topModel.SetPlcId(0),setTimeout(function(){this.SetReadPercent(.9),this.EndRead()}.bind(this),this.delay,this),this.SetReadPercent(.82)}.bind(this),this.delay,this),this.SetReadPercent(.62)}.bind(this),this.delay,this),this.SetReadPercent(.42)}.bind(this),this.delay,this)}).bind(this)();var y=84,T=50,M=new _.VertexSet,g=new Float32Array(3*f*3),v=new Float32Array(3*f*3),C=0;return null},e.prototype.parseASCII=function(e){var t,r,i,n,o;t=/facet([\s\S]*?)endfacet/g;var l=new _.VertexSet;l.SetUseIndex(!1);var h,u=[],p=[];return function(){this.BeginRead(),this.SetReadPercent(.02),setTimeout(function(){for(;null!==(n=t.exec(e));){for(o=n[0],r=/normal[\s]+([\-+]?[0-9]+\.?[0-9]*([eE][\-+]?[0-9]+)?)+[\s]+([\-+]?[0-9]*\.?[0-9]+([eE][\-+]?[0-9]+)?)+[\s]+([\-+]?[0-9]*\.?[0-9]+([eE][\-+]?[0-9]+)?)+/g;null!==(n=r.exec(o));)p.push(parseFloat(n[1]),parseFloat(n[3]),parseFloat(n[5]));for(i=/vertex[\s]+([\-+]?[0-9]+\.?[0-9]*([eE][\-+]?[0-9]+)?)+[\s]+([\-+]?[0-9]*\.?[0-9]+([eE][\-+]?[0-9]+)?)+[\s]+([\-+]?[0-9]*\.?[0-9]+([eE][\-+]?[0-9]+)?)+/g;null!==(n=i.exec(o));)u.push(parseFloat(n[1]),parseFloat(n[3]),parseFloat(n[5]))}h=new Float32Array(u.length),setTimeout(function(){for(var e=0;e<u.length;++e)h[e]=u[e];setTimeout(function(){this.topModel=new _.Model;var e=new _.Body;if(l.SetPositionArray(h),u.length!=p.length)l.computeVertexNormals();else{for(var t=new Float32Array(p.length),r=0;r<p.length;++r)t[r]=p[r];l.SetNormalArray(t)}e.SetVertexSet(l);var i=new _.Face,n=this.coverColorToMaterial(i.GetRenderColor());n&&i.SetMaterial(n);e.AddFace(i);var o=new _.Mesh(l),a=l.GetPositionArray().length/3;o.SetDataOffset(0),o.SetDataLength(a),i.SetMesh(o);var s=new _.ModelShape;s.AddBody(e),this.topModel.SetModelShape(s),this.topModel.AddBody(e),this.topModel.SetID(1),this.topModel.SetPlcId(0),setTimeout(function(){this.SetReadPercent(.9),this.EndRead()}.bind(this),this.delay,this),this.SetReadPercent(.82)}.bind(this),this.delay,this),this.SetReadPercent(.72)}.bind(this),this.delay,this),this.SetReadPercent(.65)}.bind(this),this.delay,this)}.bind(this)(),null},e.prototype.isBinary=function(e){var t;if(84+50*(t=new DataView(e)).getUint32(80,!0)===t.byteLength)return!0;for(var r=t.byteLength,i=0;i<r;i++)if(127<t.getUint8(i,!1))return!0;return!1},e.prototype.ensureBinary=function(e){if("string"!=typeof e)return e;for(var t=new Uint8Array(e.length),r=0;r<e.length;r++)t[r]=255&e.charCodeAt(r);return t.buffer||t},e.prototype.ensureString=function(e){if("string"==typeof e)return e;for(var t=new Uint8Array(e),r="",i=0;i<e.byteLength;i++)r+=String.fromCharCode(t[i]);return r},e}(_.Reader);_.StlReader=e}(M3D||(M3D={})),function(r){var e=function(e){function t(){return e.call(this)||this}return __extends(t,e),t.prototype.ReadFile=function(e){return new r.Model},t.prototype.GetModel=function(){return new r.Model},t}(r.Reader);r.SvlReader=e}(M3D||(M3D={})),function(e){e.ROOT="M3D",e.MAINGROUP="M3D|MAIN",e.MAINMODELROOT="M3D|MAIN|PATH",e.MAINCAMERA="M3D|MAIN|CAMERA",e.MAINDIRTLIGHT="M3D|MAIN|DIRLIGHT",e.MAINPOTLIGHT="M3D|MAIN|POTLIGHT",e.MAINPOINTIGHT="M3D|MAIN|POINTLIGHT",e.AXIS="M3D|AIXS",e.FPS_FLAG="M3D|FPS",e.BACKGROUNDCOLOR="M3D|BACKGROUNDCOLOR",e.SCENEGROUND="M3D|SCENEGROUND",e.HANDLER_GROUPNODE="M3D|MAIN|HANDLER_GROUP",e.SCREENUILAYER_GROUPNODE="M3D|MAIN|SCREEN_UI_LAYER_GROUP",e.GEOMETRY_GROUPNODE="M3D|MAIN|GEOMETER_GROUP",e.SECTION_GROUP_PATH="M3D|MAIN|SECTIONGROUPNODE",e.NOTE_GROUP_PATH="M3D|MAIN|NOTEGROUPNODE",e.MEASURE_GROUP_PATH="M3D|MAIN|MEASUREGROUPNODE",e.ANNOTATION_GROUP_PATH="M3D|MAIN|ANNOTATIONGROUPNODE",e.LIGHT_GROUP_PATH="M3D|MAIN|LIGHTGROUPNODE",e.CAMERA_GROUP_PATH="M3D|MAIN|CAMERAGOUPNODE",e.TRANSFORHANDLER_NODE="M3D|MAIN|TRANSFORHANDLER_NODE",e.ROTATECENTERNODE="M3D|MAIN|ROTATECENTERNODE",e.AXISHANDLENODE="M3D|MAIN|AXISHANDLENODE",e.PLANHANDLENODE="M3D|MAIN|PLANHANDLENODE",e.X_TRAN_HANDLER="X_TRAN_HANDLER",e.Y_TRAN_HANDLER="Y_TRAN_HANDLER",e.Z_TRAN_HANDLER="Z_TRAN_HANDLER",e.X_ROTATE_HANDLER="X_ROTATE_HANDLER",e.Y_ROTATE_HANDLER="Y_ROTATE_HANDLER",e.Z_ROTATE_HANDLER="Z_ROTATE_HANDLER",e.X_SCALE_HANDLER="X_SCALE_HANDLER",e.Y_SCALE_HANDLER="Y_SCALE_HANDLER",e.Z_SCALE_HANDLER="Z_SCALE_HANDLER",e.SCENE_NODE=0,e.LSCENE_NODE=2,e.LSHAPE_NODE=3,e.CAMERA_NODE_BEGIN=10,e.CAMERA_NODE=11,e.CAMERA_NODE_END=19,e.SHAPE_NODE_BEGIN=30,e.SHAPE_NODE=31,e.SHAPE_NODE_END=39,e.GROUP_NODE_BEGIN=40,e.GROUP_NODE=41,e.MODEL_NODE=42,e.GROUP_NODE_END=49,e.AND_NODE=51,e.SUB_NODE=61,e.HANDLER_NODE_BEGIN=70,e.HANDLER_NODE=71,e.HANDLER_NODE_VOICEANNOTATION=72,e.HANDLER_NODE_TEXTaNNOTATION=73,e.HANDLER_NODE_POINT=74,e.HANDLER_GROUP_NODE=75,e.HANDLER_NODE_ROTATECENTER=76,e.HANDLER_NODE_PLAN=77,e.NOTE_GROUP_NODE=78,e.MEASURE_GROUP_NODE=79,e.LIGHT_GROUP_NODE=80,e.CAMERA_GROUP_NODE=81,e.SCREENLAYER_GROUP_NODE=82,e.GEOMETRY_GROUP_NODE=83,e.HANDLER_NODE_END=99,e.GRAPHICAL_MODEL=100,e.GRAPHICAL_PMI=101,e.HANDLER_SHAPE_BEGIN=150,e.HANDLER_SHAPE=e.HANDLER_SHAPE_BEGIN+1,e.HANDLER_ANNOTATION_VOICE=e.HANDLER_SHAPE_BEGIN+2,e.HANDLER_ANNOTATION_TEXT=e.HANDLER_SHAPE_BEGIN+3,e.HANDLER_ROTATECENTER=e.HANDLER_SHAPE_BEGIN+4,e.HANDLER_POINT=e.HANDLER_SHAPE_BEGIN+5,e.HANDLER_SHAPE_END=199,e.EXTERN_NODE_BEGIN=200,e.AXIS_NODE=201,e.BACKGROUNDCOLOR_NODE=202,e.SECTION_NODE=203,e.FPS_NODE=204,e.TEXT_NODE=205,e.INTERACTIVEINFO_NODE=206,e.SCENEGROUND_NODE=207,e.EXTERN_NODE_END=300,e.PICKTYPE_BASE=1e3,e.PICKTYPE_MODEL=1001,e.PICKTYPE_PMI=1002,e.PICKTYPE_NOTE=1003,e.PICKTYPE_FACE=1004,e.PICKTYPE_LINE=1005,e.PICKTYPE_POINT=1006,e.PICKTYPE_OTHER=1007,e.NOTE_NODE=2e3,e.PERSPECTIVE=1,e.ORTHO=2,e.NEAR_CLIP_PLANE_FACTOR=.001,e.FAR_CLIP_PLANE_FACTOR=10.5,e.NEAR_CLIP_PLANE_VALUE=.01,e.CAMERA_POSFACTOR=.8,e.DEFAULT_MATERIAL="m3d_default_material",e.M3D_GLOBLE_MATERIAL="m3d_globle_material",e.DEFAULT_TEXTURE_PATH="Platform/Ctrls/SView/sview/css/images/default.png",e.BOTTOCOLOR_KEY="bottomColorKey",e.TOP_COLOR_KEY="topColorKey",e.ROTATE="rotate",e.MERGEFACE="mergeface",e.WATERMARK="watermark",e.CATIA="catia",e.HIGHPERFORMANCE="highPerformance",e.USELOD="lod",e.USEPMI="pim",e.ROAMAUTOMATIC="roamAutomatic",e.LOOPPLAYBACK="loopPlayback",e.REMOVESMALLTHING="removeSmallThing",e.REMOVESMALLSIZE="removeSmallSize",e.MEASUREUNIT="measureUnit",e.UPDIRECTION="upDirection",e.OBSERVEMODE="observeMode",e.LANGUAHEMACRO="languageType",e.SELECTTYPE="selectType",e.EDGECOLOR="selectedColor",e.PRODUCTNAME="SView for HTML5",e.PRODUCTVERSION="6.1.1.2",e.LICENCETOKEN="licenceToken",e.LICENCEID="licenceID",e.LICENCECONTEXT="licenceContext",e.LICENCETOKENHASH="ycNU3zFku9zG2EAUprUu3eIRytx5Ukjg",e.FIRSTOPENDATE="firstOpenDate",e.LICENCESIGNCODE="licenceSignCode",e.READLICENSESTATE_UNKNOWERROR=50,e.READLICENSESTATE_SUCCESS=51,e.READLICENSESTATE_UNEXISTEDFILE=52,e.READLICENSESTATE_OPENFAILURE=53,e.READLICENSESTATE_FILEDECRYPTFAILURE=54,e.READLICENSESTATE_FILECONTENTERROR=55,e.OTHERERROR=100,e.CHECKSTATE_UNKNOWNERROR=0,e.CHECKSTATE_SUCCESS=1,e.CHECKSTATE_FILEDECRYPTFAILURE=4,e.CHECKSTATE_INCORRECTPRODUCTNAME=5,e.CHECKSTATE_INCORRECTVERSION=6,e.CHECKSTATE_INCORRECTDEVICEID=7,e.CHECKSTATE_NOPERMISSION=8,e.CHECKSTATE_INCORRECTUSER=9,e.CHECKSTATE_LICENSEEXPIRED=10,e.CHECKSTATE_INITFAILURE=11,e.CHECKSTATE_ACCESSFAILURE=12,e.CHECKSTATE_TOKENERROR=13,e.CHECKSTATE_CHECKFAILURE=14,e.CHECKSTATE_CONNECTSERVERFAILURE=15,e.CHECKSTATE_SENDFAILURE=16,e.CHECKSTATE_RECEIVEFAILURE=17,e.CHECKSTATE_TOKENEXPIRES=18,e.CHECKSTATE_LICENSENOTSTARTED=19,e.CHECKSTATE_AUTHENTICATIONMODEMISMATCHED=21,e.CHECKSTATE_MACADDRASSMISMATCHED=22,e.CHECKSTATE_LICENSEAUTHENTICATIONFAILURE=23,e.CHECKSTATE_LICENSESIGNDISMATCHED=24,e.CHECKSTATE_NOAVAILABLEPOINTS=25,e.CHECKSTATE_UNEXISTEDAUTHENTICATIONINFO=26,e.CHECKSTATE_WRITEREQUESTRESULTFILEERROR=27,e.CHECKSTATE_LICENSEFILEERROR=28,e.CHECKSTATE_REQUESTRESULTFILEERROR=29,e.CHECKSTATE_LICENSERESCINDEDERROR=30,e.CHECKSTATE_PROHIBITIONAGAINST=31,e.NETWORK_RESULT_0="0",e.NETWORK_RESULT_1="1",e.NETWORK_RESULT_2="2",e.NETWORK_RESULT_3="3",e.NETWORK_RESULT_2004="2004",e.NETWORK_RESULT_2006="2006",e.NETWORK_RESULT_2007="2007",e.NETWORK_RESULT_2008="2008",e.NETWORK_RESULT_2009="2009",e.NETWORK_RESULT_2010="2010",e.NETWORK_RESULT_2011="2011",e.NETWORK_RESULT_2012="2012",e.NETWORK_RESULT_2013="2013",e.NETWORK_RESULT_2014="2014",e.NETWORK_RESULT_2015="2015",e.NETWORK_RESULT_2016="2016",e.NETWORK_RESULT_2017="2017",e.NETWORK_RESULT_2018="2018",e.NETWORK_RESULT_2019="2019",e.NETWORK_RESULT_2020="2020",e.NETWORK_RESULT_2021="2021",e.NETWORK_RESULT_2022="2022",e.NETWORK_RESULT_2023="2023"}(M3D||(M3D={})),function(e){var t;(t=e.M3D_STATUS||(e.M3D_STATUS={}))[t.ERROR=-1]="ERROR",t[t.SUCCESS=0]="SUCCESS",t[t.SUCCESS_EXIST=1001]="SUCCESS_EXIST",t[t.LIC_ERROR=100]="LIC_ERROR",t[t.Read_OK=200]="Read_OK",t[t.Read_CANCEL=201]="Read_CANCEL",t[t.Read_NO_DEFINE_Error=202]="Read_NO_DEFINE_Error",t[t.Read_IO_ERROR=203]="Read_IO_ERROR",t[t.Read_OOM=204]="Read_OOM",t[t.Read_ANALYSIS_ERROR=205]="Read_ANALYSIS_ERROR"}(M3D||(M3D={})),function(a){var e=function(o){function n(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=o.call(this)||this;if(r.vertexSet=null,r.faces=[],r.edges=[],r.model=null,r.polyLine=null,r.m_isDrawDataDirty=!0,r.origVisible=!1,r.dirty=!0,r.hardWareVertexBuffer=null,0===e.length)r.SetType(a.ShapeType.SHAPE_BODY);else if(1===e.length&&e[0]instanceof n){var i=e[0];r.AssignOperator(i)}return r.MarkDrawDataDirty(),r}return __extends(n,o),n.prototype.AssignOperator=function(e){if(this!==e){o.prototype.AssignOperator.call(this,e),this.SetModel(null),this.SetType(a.ShapeType.SHAPE_BODY),this.faces=[],this.polyLine=e.polyLine;for(var t=0;t<e.faces.length;t++){var r=new a.Face;r.AssignOperator(e.faces[t]),this.AddFace(r)}for(var i=0;i<e.edges.length;i++){var n=new a.Edge;n.AssignOperator(e.edges[i]),this.AddEdge(n)}this.MarkDrawDataDirty()}},n.prototype.MarkDrawDataDirty=function(){this.m_isDrawDataDirty=!0},n.prototype.FindVisiableObject=function(e){if(this.IsVisible()){e.StartMergeFace(),e.StartMergeEdge();var t=e.GetRenderEffect().GetRenderableTypeFilter();if(t.Contain(a.RenderableType.RGT_SOLID)){if(this.m_isDrawDataDirty)for(var r=0;r<this.faces.length;r++)this.faces[r].FindVisiableObject(e);for(r=0;r<this.faces.length;r++){var i=this.faces[r];i.GetRenderMeshData()&&(e.AddFaceToDrawQueue(i),t.Contain(a.RenderableType.RGT_TRILINE)&&e.FacePrepareLineMesh(i))}}if(t.Contain(a.RenderableType.RGT_EDGELINE)){var n=this.edges;for(r=0;r<n.length;r++){var o=n[r];e.PrepareRenderEdges(o)}}this.m_isDrawDataDirty=!1,this.UpdateHardWareBuffer(e),e.FinishMergeFace()}},n.prototype.SetVertexSet=function(e){this.vertexSet=e,this.MarkDrawDataDirty()},n.prototype.GetVertexSet=function(){return this.vertexSet},n.prototype.SetBodyExtInfo=function(){for(var e=0;e<this.faces.length;e++)this.faces[e].SetFaceExtInfo()},n.prototype.GetVertexCount=function(e){for(var t=0,r=0;r<this.faces.length;r++)t+=this.faces[r].GetVertexCount(e);return t},n.prototype.RayPick=function(e){if(this.IsVisible()&&e.CanPickShape(this.GetType())&&this.selectAble){if(e.Intersect(this.GetBoundingBox()))for(var t=0;t<this.faces.length;t++)this.faces[t].RayPick(e);if(this.edges)for(t=0;t<this.edges.length;t++)this.edges[t].RayPick(e)}},n.prototype.SetModel=function(e){this.model=e},n.prototype.GetModel=function(){return this.model},n.prototype.SetSelected=function(e){o.prototype.SetSelected.call(this,e);for(var t=0;t<this.faces.length;t++)this.faces[t].SetSelected(e);for(t=0;t<this.edges.length;t++)this.edges[t].SetSelected(e);this.MarkDrawDataDirty()},n.prototype.SetVisible=function(e){o.prototype.SetVisible.call(this,e);for(var t=0;t<this.faces.length;t++)this.faces[t].SetVisible(e);this.MarkDrawDataDirty()},n.prototype.SetSelectAble=function(e){o.prototype.SetSelectAble.call(this,e);for(var t=0;t<this.faces.length;t++)this.faces[t].SetSelectAble(e);for(t=0;t<this.edges.length;t++)this.edges[t].SetSelectAble(e)},n.prototype.AddFace=function(e){null!==e&&(e.SetBody(this),this.faces.push(e)),this.MarkDrawDataDirty()},n.prototype.AddEdge=function(e){null!==e&&(e.SetBody(this),this.edges.push(e)),this.MarkDrawDataDirty()},n.prototype.GetEdges=function(){return this.edges},n.prototype.ComputeBox=function(){this.BoundingBox.Clear();for(var e=0;e<this.faces.length;e++){var t=this.faces[e];t.GetBoundingBox().Defined()&&this.BoundingBox.Merge(t.GetBoundingBox())}},n.prototype.SetInitColor=function(e){for(var t=0;t<this.faces.length;t++)this.faces[t].SetInitColor(e);this.MarkDrawDataDirty()},n.prototype.SetColor=function(e){for(var t=0;t<this.faces.length;t++)this.faces[t].SetColor(e);this.MarkDrawDataDirty()},n.prototype.ResetColor=function(){for(var e=0;e<this.faces.length;e++)this.faces[e].ResetColor();this.MarkDrawDataDirty()},n.prototype.SetAlpha=function(e){this.Color.a=e;for(var t=0;t<this.faces.length;t++)this.faces[t].SetAlpha(e);this.MarkDrawDataDirty()},n.prototype.ResetAlpha=function(){for(var e=0;e<this.faces.length;e++)this.faces[e].ResetAlpha();this.MarkDrawDataDirty()},n.prototype.SetOrigVisible=function(e){this.origVisible=e,this.SetVisible(e)},n.prototype.IsOrigVisible=function(){return this.origVisible},n.prototype.Restore=function(){for(var e=0;e<this.faces.length;e++)this.faces[e].Restore();this.ResetColor(),this.SetVisible(this.IsOrigVisible()),this.SetSelected(!1)},n.prototype.GetFaces=function(){return this.faces},n.prototype.FramePick=function(e){o.prototype.FramePick.call(this,e)},n.prototype.GetPolyLine=function(){return this.polyLine},n.prototype.SetPolyLine=function(e){this.polyLine=e},n.prototype.GetHardWareVertexBuffer=function(){return this.hardWareVertexBuffer},n.prototype.UpdateHardWareBuffer=function(e){if(this.polyLine){var t=this.polyLine.GetPoints();this.dirty&&(this.dirty=!1,null===this.hardWareVertexBuffer&&0<t.length&&this.createVertexBuffer(e))}},n.prototype.GetVolumeAndArea=function(){var e=this.GetData(0);return e?e.GetVolumeAndArea():[0,0]},n.prototype.GetData=function(e){for(var t=null,r=0;r<this.GetFaces().length;r++)if(this.GetFaces()[r]&&this.GetFaces()[r].GetMesh()&&this.GetFaces()[r].GetMesh().GetRefMesh()){t=this.GetFaces()[r].GetMesh().GetRefMesh();break}return t},n.prototype.SetInitHightlight=function(e){for(var t=0;t<this.faces.length;t++)this.faces[t].SetInitHightlight(e);this.MarkDrawDataDirty()},n.prototype.SetInitAlpha=function(e){for(var t=0;t<this.faces.length;t++)this.faces[t].SetInitAlpha(e);this.MarkDrawDataDirty()},n.prototype.GetPoints=function(){return[]},n.prototype.createVertexBuffer=function(e){var t=e.GetRenderContext().GetGLRenderContext(),r=this.polyLine.GetPoints(),i=a.ArrayHelper.ConvertToFloat32Array(r);this.hardWareVertexBuffer=new a.HardWareVertexBuffer(t);var n;n=i.length;this.hardWareVertexBuffer.Create(0,n)?(this.hardWareVertexBuffer.SetDataRange(i,0),this.hardWareVertexBuffer.SetVertexOffset(0),this.hardWareVertexBuffer.WriteBuffer()):this.hardWareVertexBuffer=null},n}(a.Shape);a.Body=e}(M3D||(M3D={})),function(g){var r=function(){this.m_IsFirstGetProperties=!0};g.FaceExtInfo=r;var e=function(t){function e(){var e=t.call(this)||this;return e.origVisible=!1,e.renderIndexOffset=0,e.renderNormalOffset=0,e.renderVertexOffset=0,e.renderTextureCoordsOffset=0,e.renderCentersOffset=0,e.renderLength=0,e.renderColor=new g.Color(.5,.5,.5,1),e.useIndex=!1,e.index=0,e.body=null,e.color=g.Color.GRAY().Clone(),e.isHighlight=!1,e.m_linesIndex=0,e.SetType(g.ShapeType.SHAPE_FACE),e.m_svlId=-1,e.m_recesiveShadow=!0,e}return __extends(e,t),e.prototype.SetMaterial=function(e){this.material=e},e.prototype.GetMaterial=function(){return this.material},e.prototype.FindVisiableObject=function(e){null!=this.mesh&&e.PrepareRenderFace(this)},e.prototype.SetBody=function(e){this.body=e},e.prototype.GetBody=function(){return this.body},e.prototype.SetInitAlpha=function(e){this.color.a=e,this.body&&this.body.MarkDrawDataDirty()},e.prototype.RayPick=function(e){this.IsVisible()&&e.CanPickShape(this.GetType())&&e.Intersect(this.GetBoundingBox())&&e.CanPickShape(g.ShapeType.SHAPE_TRIMESH)&&(this.mesh.RayPick(e),e.AddShape(this))},e.prototype.SetSelected=function(e){t.prototype.SetSelected.call(this,e),this.body&&this.body.MarkDrawDataDirty()},e.prototype.SetVisible=function(e){t.prototype.SetVisible.call(this,e),this.body&&this.body.MarkDrawDataDirty()},e.prototype.SetFaceExtInfo=function(){this.m_FaceExtInfo||(this.m_FaceExtInfo=new r),this.m_FaceExtInfo.m_InitColor=this.Color,this.m_FaceExtInfo.m_origHighlight=this.isHighlight},e.prototype.ComputeBox=function(){if(this.BoundingBox.Clear(),!this.BoundingBox.Defined()){var e=this.GetMesh();null!=e&&e.GetBoundingBox().Defined()&&this.BoundingBox.copyFrom(e.GetBoundingBox())}},e.prototype.ResetAlpha=function(){this.SetAlpha(this.initColor.a)},e.prototype.SetAlpha=function(e){if(this.GetAlpha()!==e){if(this.Color.a=e,this.renderColor.a=e,this.material){var t=null,r=this.GetBody().GetModel();if(!r)return;var i=r.GetExtendInfoManager();if(i){var n=i.GetScene();n&&(t=n.GetResourceManager())}if(!t)return;var o=r.GetExtendInfoManager().GetScene().GetModel();switch(this.material.GetMaterialType()){case g.MaterialType.MaterialType_Phong:var a=this.material,s=a.GetDiffuse(),l=null;if(l=t.IsMaterialExisted(s,e))this.SetMaterial(l.Clone());else if(t.IsMaterialUsed(o,a,r)){var h="material_phong_uuid_"+g.IDCreator.GetUUID(),u=a.Clone();u.GetMaterialType(),s.a=e,u.SetDiffuse(s),u.Opacity(e),u.SetName(h),u.SetAmbient(a.GetAmbient()),u.SetSpecular(a.GetSpecular()),u.SetEmissive(a.GetEmissive());t.AddMaterial(h,u);u.SetResourceManager(t),this.SetMaterial(u)}else a.Opacity(e),this.SetMaterial(a);break;case g.MaterialType.MaterialType_Pbr:var p=this.material,c=(s=p.AlbedoColor(),new g.BaseMaterial);if(c=t.IsMaterialExisted(s,e))this.SetMaterial(c.Clone());else if(t.IsMaterialUsed(o,p,r)){h="material_pbr_uuid_"+g.IDCreator.GetUUID();var d=p.Clone();s.a=e,d.SetAlbedoColor(s),d.SetOpacity(e),d.SetName(h);t.AddMaterial(h,d);d.setResourceManager(t),this.SetMaterial(d)}else p.SetOpacity(e),this.SetMaterial(p);break;case g.MaterialType.MaterialType_MatCap:var S=this.material,f=(s=S.GetAmbient(),null);if(f=t.IsMaterialExisted(s,e))this.SetMaterial(f.Clone());else if(t.IsMaterialUsed(o,S,r)){h="material_matCap_uuid_"+g.IDCreator.GetUUID();var m=S.Clone();s.a=e,m.SetAmbient(s),m.Opacity(e),m.SetName(h);t.AddMaterial(h,m);m.SetResourceManager(t),this.SetMaterial(m)}else S.Opacity(e),this.SetMaterial(S)}}this.body&&this.body.MarkDrawDataDirty()}},e.prototype.SetMyColor=function(e){var t=null,r=this.GetBody().GetModel();if(r){var i=r.GetExtendInfoManager();if(i){var n=i.GetScene();n&&(t=n.GetResourceManager())}if(t){var o=e.a,a=this.material;if(a){var s=r.GetExtendInfoManager().GetScene().GetModel();switch(a.GetMaterialType()){case g.MaterialType.MaterialType_Phong:var l=a,h=(T="material_phong_uuid_"+g.IDCreator.GetUUID(),l.Clone());h.SetDiffuse(e);var u=t.IsMaterialExistedByKey(h,T);if(u)h=null,r.SetFaceMaterial(u);else if(t.IsMaterialUsed(s,l,r)){h.SetName(T);t.AddMaterial(T,h);h.SetResourceManager(t),r.SetFaceMaterial(h)}else l.SetDiffuse(e),r.SetFaceMaterial(l),h=null;break;case g.MaterialType.MaterialType_Pbr:var p=a,c=(T="material_pbr_uuid_"+g.IDCreator.GetUUID(),p.Clone());c.SetAlbedoColor(e);var d=t.IsMaterialExistedByKey(c,T);if(d)c=null,r.SetFaceMaterial(d);else if(t.IsMaterialUsed(s,p,r)){c.SetName(T);t.AddMaterial(T,c);c.setResourceManager(t),r.SetFaceMaterial(c)}else p.SetAlbedoColor(e),r.SetFaceMaterial(p),c=null;break;case g.MaterialType.MaterialType_MatCap:var S=a,f=(T="material_matCap_uuid_"+g.IDCreator.GetUUID(),S.Clone());f.SetDiffuse(e);var m=t.IsMaterialExistedByKey(f,T);if(m)r.SetFaceMaterial(m),f=null;else if(t.IsMaterialUsed(s,S,r)){f.SetName(T);t.AddMaterial(T,f);f.SetResourceManager(t),r.SetFaceMaterial(f)}else S.SetDiffuse(e),r.SetFaceMaterial(S),f=null}}else{var y=t.IsMaterialExisted(e,o);if(y)r.SetFaceMaterial(y);else{var T="material_phong_uuid_"+g.IDCreator.GetUUID(),M=t.GetOrCreateMaterial(T,g.MaterialType.MaterialType_Phong);M.SetDiffuse(e),r.SetFaceMaterial(M)}}}}},e.prototype.SetInitColor=function(e){if(this.initColor.copyFrom(e),this.Color=e.Clone(),this.GetBody())this.SetMyColor(e);else if(this.material)if(this.material.GetMaterialType()==g.MaterialType.MaterialType_Base||this.material.GetMaterialType()==g.MaterialType.MaterialType_Phong||this.material.GetMaterialType()==g.MaterialType.MaterialType_MatCap)this.material.SetDiffuse(e);else if(this.material.GetMaterialType()==g.MaterialType.MaterialType_Pbr){this.material.SetAlbedoColor(e)}this.body&&this.body.MarkDrawDataDirty(),this.renderColor.a=e.a},e.prototype.ResetColor=function(){if(this.Color=this.initColor.Clone(),this.renderColor.a=this.initColor.Clone().a,this.material)if(this.material.GetMaterialType()==g.MaterialType.MaterialType_Base||this.material.GetMaterialType()==g.MaterialType.MaterialType_Phong||this.material.GetMaterialType()==g.MaterialType.MaterialType_MatCap)this.material.SetDiffuse(this.Color);else if(this.material.GetMaterialType()==g.MaterialType.MaterialType_Pbr){this.material.SetAlbedoColor(this.Color)}this.body&&this.body.MarkDrawDataDirty()},e.prototype.SetColor=function(e){if(!this.GetColor().Equals(e)){if(this.Color=e.Clone(),this.renderColor.a=e.Clone().a,this.material){var t=null,r=this.GetBody().GetModel();if(!r)return;var i=r.GetExtendInfoManager();if(i){var n=i.GetScene();n&&(t=n.GetResourceManager())}if(!t)return;var o=r.GetExtendInfoManager().GetScene().GetModel();switch(this.material.GetMaterialType()){case g.MaterialType.MaterialType_Phong:var a,s=this.material;if(a=t.IsMaterialExisted(e,e.a))this.SetMaterial(a);else if(t.IsMaterialUsed(o,s,r)){var l="material_phong_uuid_"+g.IDCreator.GetUUID(),h=s.Clone();h.SetDiffuse(e),h.Opacity(e.a),h.SetName(l),h.SetAmbient(s.GetAmbient()),h.SetSpecular(s.GetSpecular()),h.SetEmissive(s.GetEmissive()),h.SetName(l);t.AddMaterial(l,h);h.SetResourceManager(t),this.SetMaterial(h)}else s.SetDiffuse(e),this.SetMaterial(s);break;case g.MaterialType.MaterialType_Pbr:var u=this.material,p=new g.BaseMaterial;if(p=t.IsMaterialExisted(e,e.a))this.SetMaterial(p);else if(t.IsMaterialUsed(o,u,r)){l="material_pbr_uuid_"+g.IDCreator.GetUUID();var c=u.Clone();c.SetAlbedoColor(e),c.SetOpacity(e.a),c.SetName(l);t.AddMaterial(l,c);c.setResourceManager(t),this.SetMaterial(c)}else u.SetAlbedoColor(e);break;case g.MaterialType.MaterialType_MatCap:var d,S=this.material;if(d=t.IsMaterialExisted(e,e.a))this.SetMaterial(d);else if(t.IsMaterialUsed(o,S,r)){l="material_matCap_uuid_"+g.IDCreator.GetUUID();var f=S.Clone();f.SetDiffuse(e),f.Opacity(e.a),f.SetName(l);t.AddMaterial(l,f);f.SetResourceManager(t),this.SetMaterial(f)}else S.SetDiffuse(e)}}this.body&&this.body.MarkDrawDataDirty()}},e.prototype.GetColor=function(){return t.prototype.GetColor.call(this).Clone()},e.prototype.SetRenderColor=function(e){this.Color.copyFrom(e),this.SetInitColor(e),this.renderColor.copyFrom(e)},e.prototype.GetColorAlpha=function(){return this.renderColor.a},e.prototype.SetMesh=function(e){this.mesh=e},e.prototype.GetMesh=function(){return this.mesh},e.prototype.GetRenderMeshData=function(){return this.m_drawCache},e.prototype.SetRenderMeshData=function(e){this.m_drawCache=e},e.prototype.SetRenderWorldMatrix=function(e){this.renderWorldMatrix=e},e.prototype.GetRenderWorldMatrix=function(){return this.renderWorldMatrix},e.prototype.GetRenderColor=function(){return this.GetDrawColor()},e.prototype.GetDrawColor=function(e){return void 0===e&&(e=1!==g.Parameters.Instance().selectedStyle),e?t.prototype.GetDrawColor.call(this).Clone():this.Color},e.prototype.GetRenderMaterial=function(){return this.GetMaterial()},e.prototype.GetLinesModeVertexPos=function(){return this.m_linesVertexPos},e.prototype.SetRenderMesh=function(e){var t=e.GetDataOffset(),r=e.GetRefMesh();if(this.useIndex=r.UseIndex(),this.hardWareVertexBuffer=r.GetHardWareVertexBuffer(),this.hardWareIndexBuffer=r.GetHardWareIndexBuffer(),null!=this.hardWareVertexBuffer&&this.hardWareVertexBuffer.HasValue())if(this.useIndex){if(this.hardWareIndexBuffer&&this.hardWareIndexBuffer.HasValue()&&(this.renderIndexOffset=this.hardWareIndexBuffer.GetOffset()+1*t,this.renderNormalOffset=this.hardWareVertexBuffer.GetNormalOffset(),this.renderVertexOffset=this.hardWareVertexBuffer.GetVertexOffset(),this.renderTextureCoordsOffset=this.hardWareVertexBuffer.GetTextureCoordsOffset(),g.Parameters.Instance().IsShowTrilateralEdge)){var i=r.GetLinesModeIndexArray();this.m_linesIndex=i.length+2*t,this.m_linesVertexPos=r.GetPositionArray()}}else t*=g.Vector3.BYTE_SIZE,this.renderNormalOffset=this.hardWareVertexBuffer.GetNormalOffset()+t,this.renderVertexOffset=this.hardWareVertexBuffer.GetVertexOffset()+t,this.renderTextureCoordsOffset=this.hardWareVertexBuffer.GetTextureCoordsOffset()+t,this.renderCentersOffset=this.hardWareVertexBuffer.GetCentersCoordsOffset()+t,g.Parameters.Instance().IsShowTrilateralEdge&&(this.m_linesVertexPos=2*t);this.renderLength=e.GetDataLength()},e.prototype.GetLineModeIndex=function(){return this.m_linesIndex},e.prototype.MergeRenderMesh=function(e){this.renderLength+=e.GetDataLength()},e.prototype.GetRenderMesh=function(){return this.mesh},e.prototype.GetDataLength=function(){return this.renderLength},e.prototype.IsUseIndex=function(){return this.useIndex},e.prototype.SetIndexOffset=function(e){this.renderIndexOffset=e},e.prototype.GetIndexOffset=function(){return this.renderIndexOffset},e.prototype.SetNormalOffset=function(e){this.renderNormalOffset=e},e.prototype.GetNormalOffset=function(){return this.renderNormalOffset},e.prototype.SetVertexOffset=function(e){this.renderVertexOffset=e},e.prototype.GetVertexOffset=function(){return this.renderVertexOffset},e.prototype.SetTextureCoordsOffset=function(e){this.renderTextureCoordsOffset=e},e.prototype.GetTextureCoordsOffset=function(){return this.renderTextureCoordsOffset},e.prototype.SetCentersCoordsOffset=function(e){this.renderCentersOffset=e},e.prototype.GetCentersCoordsOffset=function(){return this.renderCentersOffset},e.prototype.GetHardWareVertexBuffer=function(){return this.hardWareVertexBuffer},e.prototype.GetHardWareIndexBuffer=function(){return this.hardWareIndexBuffer},e.prototype.SetOrigVisible=function(e){this.origVisible=e,this.SetVisible(e)},e.prototype.IsOrigVisible=function(){return this.origVisible},e.prototype.Restore=function(){this.ResetColor(),this.SetVisible(this.IsOrigVisible()),this.SetSelected(!1)},e.prototype.AssignOperator=function(e){t.prototype.AssignOperator.call(this,e),this.mesh=e.mesh,this.m_svlId=e.m_svlId,this.material=e.material},e.prototype.FramePick=function(e){t.prototype.FramePick.call(this,e)},e.prototype.IsHightlight=function(){return this.isHighlight||this.IsSelect},e.prototype.SetInitHightlight=function(e){this.isHighlight=e,this.m_FaceExtInfo||(this.m_FaceExtInfo=new r),this.m_FaceExtInfo.m_origHighlight=e,this.body&&this.body.MarkDrawDataDirty()},e.prototype.GetVertexCount=function(e){var t=0,r=this.GetMesh();return null!=r&&(t+=r.GetVertexCount()),t},e.prototype.GetSVLId=function(){return this.m_svlId},e.prototype.SetSVLId=function(e){this.m_svlId=e},e.prototype.GetGeoAttribute=function(){var e=this.GetMesh();if(e){var t=void 0;return this.GetSVLId()&&(this.GetBody()&&this.GetBody().GetModel()&&(t=this.GetBody().GetModel().GetExtendInfoManager().GetFaceGeoAttribute(this.GetBody().GetModel().GetProtoTypeId(),this.GetSVLId())),e.SetGeoAttribute(t)),t}return null},e.prototype.InitProperties=function(){this.AddProperty("ID",String(this.Id));var e=String(this.Color.r.toFixed(3))+","+String(this.Color.g.toFixed(3))+","+String(this.Color.b.toFixed(3))+","+String(this.Color.a.toFixed(3));this.AddProperty("Color",e),this.AddProperty("LOD0PatchCount",String(this.GetVertexCount(0)/3));var t=this.GetVolumeAndArea()[1],r=new Array;r.push(t);var i="";i=g.MeasureDisplayHelper.SetMeasureAreaUnit(g.Parameters.Instance().measureUnitStyle,r,i);var n=String(r[0].toFixed(3))+i;this.AddProperty("Area",String(n))},e.prototype.GetVolumeAndArea=function(){var e=this.GetMesh();return e?e.GetVolumeAndArea():[0,0]},e.prototype.GetEdges=function(){return[]},e.prototype.RecesiveShadow=function(){return this.m_recesiveShadow},e.prototype.SetRecesiveShadow=function(e){this.m_recesiveShadow=e},e}(g.Shape);g.Face=e}(M3D||(M3D={})),function(e){e.LOD_LODMAX=0,e.LOD_LODMIN=10;var t=function(){function r(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];e[0]instanceof r&&(this.m_data=e[0].m_data)}return r.prototype.GetData=function(e){var t=null;return e<this.GetCount()&&0<=e&&(t=this.m_data[e]),t},r.prototype.GetCount=function(){return this.m_data.length},r.prototype.AddData=function(e,t){if(t<this.GetCount()&&0<=t)this.m_data[t]=e;else{var r=this.m_data;this.m_data[t+1]=null;for(var i=0;i<r.length;i++)this.m_data[i]=r[i];this.m_data[t]=e}},r}();e.LOD=t}(M3D||(M3D={})),function(M){var e=function(){function e(e){this.refMesh=null,this.geoAttribute=null,this.boudingBox=new M.BoundingBox,this.dataOffset=0,this.dataLength=0,this.SetRefMesh(e)}return e.prototype.GetBoundingBox=function(){if(!this.boudingBox.Defined()&&this.refMesh){var e=0;if(this.refMesh.UseIndex()){var t=this.dataLength;e=t;for(var r=this.refMesh.GetPositionArray(),i=this.refMesh.GetIndexArray(),n=0;n<t;n++)this.boudingBox.Merge(r[3*i[this.dataOffset+n]],r[3*i[this.dataOffset+n]+1],r[3*i[this.dataOffset+n]+2])}else{e=this.dataLength;var o=this.refMesh.GetPositionArray();for(n=0;n<e;n++)this.boudingBox.Merge(o[3*(this.dataOffset+n)],o[3*(this.dataOffset+n)+1],o[3*(this.dataOffset+n)+2])}}return this.boudingBox},e.prototype.RayPick=function(e){if(e.Intersect(this.GetBoundingBox())){var t=new M.Vector3,r=this.refMesh.UseIndex(),i=0,n=new M.Vector3,o=new M.Vector3,a=new M.Vector3;if(r){var s=this.dataLength;i=s;for(var l=this.refMesh.GetPositionArray(),h=this.refMesh.GetIndexArray(),u=0,p=0,c=0,d=0;d<s/3;d++){if(u=h[s+3*d],p=h[s+3*d+1],c=h[s+3*d+2],n.x=l[3*u],n.y=l[3*u+1],n.z=l[3*u+2],o.x=l[3*p],o.y=l[3*p+1],o.z=l[3*p+2],a.x=l[3*c],a.y=l[3*c+1],a.z=l[3*c+2],e.IsintersectRayAndTriangle(n,o,a,t))(f=new M.Vector3).copyFrom(t),e.AddIntersectPnt(f)}}else{i=this.dataLength;var S=this.refMesh.GetPositionArray();for(d=0;d<i/3;d++){var f,m=3*(this.dataOffset+3*d),y=m+3,T=m+6;if(n.x=S[m],n.y=S[m+1],n.z=S[m+2],o.x=S[y],o.y=S[y+1],o.z=S[y+2],a.x=S[T],a.y=S[T+1],a.z=S[T+2],e.IsintersectRayAndTriangle(n,o,a,t))(f=new M.Vector3).copyFrom(t),e.AddIntersectPnt(f)}}}},e.prototype.Clear=function(){},e.prototype.GetVertexCount=function(){return this.dataLength},e.prototype.GetGeoAttribute=function(){return this.geoAttribute},e.prototype.SetGeoAttribute=function(e){this.geoAttribute=e},e.prototype.SetRefMesh=function(e){this.refMesh=e},e.prototype.GetRefMesh=function(){return this.refMesh},e.prototype.SetDataLength=function(e){this.dataLength=e},e.prototype.GetDataLength=function(){return this.dataLength},e.prototype.SetDataOffset=function(e){this.dataOffset=e},e.prototype.GetDataOffset=function(){return this.dataOffset},e.prototype.GetVolumeAndArea=function(){var e,t,r=0,i=0,n=new M.Vector3,o=new M.Vector3,a=new M.Vector3;new M.Vector3;if(0<this.refMesh.GetPositionArray().length){var s=this.dataLength;s;for(var l=this.refMesh.GetHardWareVertexBuffer(),h=this.refMesh.GetPositionArray(),u=this.refMesh.GetHardWareIndexBuffer(),p=(this.GetRefMesh().GetIndexArray(),this.dataOffset);p<this.dataOffset+s;p+=3){var c=new M.Vector3(h[3*p],h[3*p+1],h[3*p+2]),d=new M.Vector3(h[3*(p+1)],h[3*(p+1)+1],h[3*(p+1)+2]),S=new M.Vector3(h[3*(p+2)],h[3*(p+2)+1],h[3*(p+2)+2]);n.x=c.x,n.y=c.y,n.z=c.z,o.x=d.x,o.y=d.y,o.z=d.z,a.x=S.x,a.y=S.y,a.z=S.z,e=(m=M.MeshHelper.CalculateAirVol(n,o,a,e,t))[0],t=m[1],Math.abs(e)<1e-10&&console.log(" **** Element NULL  i = %d   S = %f\n",p,e),r+=e,i+=t}u&&u.UnBind(),l&&l.UnBind()}else{this.dataLength;l=this.refMesh.GetHardWareVertexBuffer();var f=this.refMesh.GetPositionArray();for(p=this.dataOffset;p<this.dataOffset+this.dataLength;p+=9){var m;c=new M.Vector3(f[p],f[p+1],f[p+2]),d=new M.Vector3(f[p+3],f[p+4],f[p+5]),S=new M.Vector3(f[p+6],f[p+7],f[p+8]);n.x=c.x,n.y=c.y,n.z=c.z,o.x=d.x,o.y=d.y,o.z=d.z,a.x=S.x,a.y=S.y,a.z=S.z,e=(m=M.MeshHelper.CalculateAirVol(n,o,a,e,t))[0],t=m[1],Math.abs(e)<1e-10&&console.log(" **** Element NULL  i = %d   S = %f\n",p,e),r+=e,i+=t}l&&l.UnBind()}return 1e-16<r&&i/r,[i,r]},e}();M.Mesh=e}(M3D||(M3D={})),function(r){var i,e;(e=i=r.GeoAttrTypeEnum||(r.GeoAttrTypeEnum={}))[e.M3D_GEOATTR_TYPE_UNKNOWN=0]="M3D_GEOATTR_TYPE_UNKNOWN",e[e.M3D_GEOATTR_TYPE_PLANEFACE=1]="M3D_GEOATTR_TYPE_PLANEFACE",e[e.M3D_GEOATTR_TYPE_REVOLUTIONFACE=2]="M3D_GEOATTR_TYPE_REVOLUTIONFACE",e[e.M3D_GEOATTR_TYPE_CYLINDERFACE=3]="M3D_GEOATTR_TYPE_CYLINDERFACE",e[e.M3D_GEOATTR_TYPE_CONICALFACE=4]="M3D_GEOATTR_TYPE_CONICALFACE",e[e.M3D_GEOATTR_TYPE_SPHEREFACE=5]="M3D_GEOATTR_TYPE_SPHEREFACE",e[e.M3D_GEOATTR_TYPE_TOROIDALFACE=6]="M3D_GEOATTR_TYPE_TOROIDALFACE",e[e.M3D_GEOATTR_TYPE_LINE=7]="M3D_GEOATTR_TYPE_LINE",e[e.M3D_GEOATTR_TYPE_ELLIPSE=8]="M3D_GEOATTR_TYPE_ELLIPSE",e[e.M3D_GEOATTR_TYPE_REVOLUTIONFACE_CYLINDERFACE_CONICALFACE=9]="M3D_GEOATTR_TYPE_REVOLUTIONFACE_CYLINDERFACE_CONICALFACE";var t=function(){function e(){this.m_ID=0,this.m_eGeoAttrType=i.M3D_GEOATTR_TYPE_UNKNOWN}return e.prototype.GetID=function(){return this.m_ID},e.prototype.SetID=function(e){this.m_ID=e},e.prototype.GetGeoAttrType=function(){return this.m_eGeoAttrType},e.prototype.SetGeoAttrType=function(e){this.m_eGeoAttrType=e},e}(),n=function(t){function e(){var e=t.call(this)||this;return e.m_eGeoAttrType=i.M3D_GEOATTR_TYPE_LINE,e.m_ID=0,e.m_fLength=0,e.m_pntStartPoint=r.Vector3.ZERO().Clone(),e.m_pntEndPoint=r.Vector3.ZERO().Clone(),e.m_pntCenterPoint=r.Vector3.ZERO().Clone(),e.m_dirDirection=r.Vector3.ZERO().Clone(),e}return __extends(e,t),e.prototype.GetLength=function(){return this.m_fLength},e.prototype.SetLength=function(e){this.m_fLength=e},e.prototype.GetStartPoint=function(){return this.m_pntStartPoint},e.prototype.SetStartPoint=function(e){this.m_pntStartPoint=e},e.prototype.GetEndPoint=function(){return this.m_pntEndPoint},e.prototype.SetEndPoint=function(e){this.m_pntEndPoint=e},e.prototype.GetCenterPoint=function(){return this.m_pntCenterPoint},e.prototype.SetCenterPoint=function(e){this.m_pntCenterPoint=e},e.prototype.GetDirection=function(){return this.m_dirDirection},e.prototype.SetDirection=function(e){this.m_dirDirection=e},e}(r.GeometryAttribute=t);r.LineAttribute=n;var o=function(t){function e(){var e=t.call(this)||this;return e.m_eGeoAttrType=i.M3D_GEOATTR_TYPE_ELLIPSE,e.m_ID=0,e.m_pntStartPoint=r.Vector3.ZERO().Clone(),e.m_pntEndPoint=r.Vector3.ZERO().Clone(),e.m_pntCenterPoint=r.Vector3.ZERO().Clone(),e.m_fMajorRadius=0,e.m_fMinorRadius=0,e.m_dirX=r.Vector3.ZERO().Clone(),e}return __extends(e,t),e.prototype.GetXYZDir=function(e,t,r){e.copyFrom(this.m_dirX.Clone()),t.copyFrom(this.m_dirY.Clone()),r.copyFrom(this.m_dirZ.Clone())},e.prototype.SetXYZDir=function(e,t,r){this.m_dirX=e.Clone(),this.m_dirY=t.Clone(),this.m_dirZ=r.Clone()},e.prototype.GetCenterPoint=function(){return this.m_pntCenterPoint},e.prototype.SetCenterPoint=function(e){this.m_pntCenterPoint=e.Clone()},e.prototype.GetMajorRadius=function(){return this.m_fMajorRadius},e.prototype.GetMinorRadius=function(){return this.m_fMinorRadius},e.prototype.SetMinorRadius=function(e){this.m_fMinorRadius=e},e.prototype.SetMajorRadius=function(e){this.m_fMajorRadius=e},e.prototype.GetStartPoint=function(){return this.m_pntStartPoint},e.prototype.SetStartPoint=function(e){this.m_pntStartPoint=e.Clone()},e.prototype.GetEndPoint=function(){return this.m_pntEndPoint},e.prototype.SetEndPoint=function(e){this.m_pntEndPoint=e.Clone()},e.prototype.ConvertToLine=function(){var e=new r.Line3D;return e.StartPoint=this.m_pntStartPoint.Clone(),e.EndPoint=this.m_pntEndPoint.Clone(),e},e}(t);r.EllipseAttribute=o;var a=function(t){function e(){var e=t.call(this)||this;return e.m_eGeoAttrType=i.M3D_GEOATTR_TYPE_PLANEFACE,e.m_ID=0,e.m_dirNormal=r.Vector3.ZERO().Clone(),e.m_pntOrigin=r.Vector3.ZERO().Clone(),e}return __extends(e,t),e.prototype.SetNormal=function(e){this.m_dirNormal=e.Clone()},e.prototype.GetNormal=function(){return this.m_dirNormal},e.prototype.SetOrigin=function(e){this.m_pntOrigin=e},e.prototype.GetOrigin=function(){return this.m_pntOrigin},e}(t);r.PlaneFaceAttribute=a;var s=function(t){function e(){var e=t.call(this)||this;return e.m_eGeoAttrType=i.M3D_GEOATTR_TYPE_REVOLUTIONFACE,e.m_ID=0,e.m_dRadius=0,e.m_dirRevoAxis=r.Vector3.ZERO().Clone(),e.m_pntAxisOrigin=r.Vector3.ZERO().Clone(),e}return __extends(e,t),e.prototype.SetRadius=function(e){this.m_dRadius=e},e.prototype.GetRadius=function(){return this.m_dRadius},e.prototype.SetRevoAxis=function(e){this.m_dirRevoAxis=e},e.prototype.GetRevoAxis=function(){return this.m_dirRevoAxis},e.prototype.SetAxisOrigin=function(e){this.m_pntAxisOrigin=e},e.prototype.GetAxisOrigin=function(){return this.m_pntAxisOrigin},e}(t),l=function(t){function e(){var e=t.call(this)||this;return e.m_eGeoAttrType=i.M3D_GEOATTR_TYPE_CYLINDERFACE,e.m_ID=0,e.m_dRadius=0,e.m_dirRevoAxis=r.Vector3.ZERO().Clone(),e.m_pntAxisOrigin=r.Vector3.ZERO().Clone(),e}return __extends(e,t),e}(r.RevolutionFaceAttribute=s);r.CylinderFaceAttribute=l;var h=function(t){function e(){var e=t.call(this)||this;return e.m_eGeoAttrType=i.M3D_GEOATTR_TYPE_CONICALFACE,e.m_ID=0,e.m_dirRevoAxis=r.Vector3.ZERO(),e.m_pntAxisOrigin=r.Vector3.ZERO(),e}return __extends(e,t),e}(s);r.ConicalFaceAttribute=h;var u=function(t){function e(){var e=t.call(this)||this;return e.m_eGeoAttrType=i.M3D_GEOATTR_TYPE_SPHEREFACE,e.m_ID=0,e.m_dRadius=0,e.m_dirRevoAxis=r.Vector3.ZERO(),e.m_pntAxisOrigin=r.Vector3.ZERO(),e}return __extends(e,t),e}(s);r.SphereFaceAttribute=u;var p=function(t){function e(){var e=t.call(this)||this;return e.m_eGeoAttrType=i.M3D_GEOATTR_TYPE_TOROIDALFACE,e.m_ID=0,e.m_dRadius=0,e.m_dirRevoAxis=r.Vector3.ZERO(),e.m_pntAxisOrigin=r.Vector3.ZERO(),e.m_fMajorRadius=0,e.m_fMinorRadius=0,e}return __extends(e,t),e.prototype.GetMajorRadius=function(){return this.m_fMajorRadius},e.prototype.SetMajorRaius=function(e){this.m_fMajorRadius=e},e.prototype.GetMinorRadius=function(){return this.m_fMinorRadius},e.prototype.SetMinorRadius=function(e){this.m_fMinorRadius=e},e}(s);r.ToroidalFaceAttribute=p}(M3D||(M3D={})),function(e){var t=function(){};(M3D||(M3D={})).InstanceAttribute=t}(),function(M){var e=function(){function e(){this.IndexArray=[],this.m_linesModeIndexArray=[],this.hardWareVertexBuffer=null,this.hardWareIndexBuffer=null,this.dirty=!0,this.positionArray=new Float32Array(0),this.NormalArray=new Float32Array(0),this.textureCoords=new Float32Array(0),this.m_linesModepositionArray=new Float32Array(0)}return e.prototype.GetBoundingBox=function(){return new M.BoundingBox},e.prototype.GetPositionArray=function(){return this.positionArray},e.prototype.SetPositionArray=function(e){this.positionArray=e},e.prototype.SetUVArray=function(e){this.textureCoords=e},e.prototype.GetUVArray=function(){return this.textureCoords},e.prototype.GetNormalArray=function(){return this.NormalArray},e.prototype.SetNormalArray=function(e){this.NormalArray=e},e.prototype.GetTextureCoordArray=function(){return this.positionArray},e.prototype.GetIndexArray=function(){return this.IndexArray},e.prototype.IsDirty=function(){return this.dirty},e.prototype.MarkDirty=function(){this.dirty=!0},e.prototype.SetUseIndex=function(e){this.useIndex=e},e.prototype.UseIndex=function(){return this.useIndex},e.prototype.GetHardWareVertexBuffer=function(){return this.hardWareVertexBuffer},e.prototype.GetHardWareIndexBuffer=function(){return this.hardWareIndexBuffer},e.prototype.GetLinesModeIndexArray=function(){if(0===this.m_linesModeIndexArray.length&&this.UseIndex){var e=this.IndexArray.length/3;this.m_linesModeIndexArray=new Array(6*e);for(var t=0;t<e;t++)this.m_linesModeIndexArray.push(this.IndexArray[3*t]),this.m_linesModeIndexArray.push(this.IndexArray[3*t+1]),this.m_linesModeIndexArray.push(this.IndexArray[3*t+1]),this.m_linesModeIndexArray.push(this.IndexArray[3*t+2]),this.m_linesModeIndexArray.push(this.IndexArray[3*t+2]),this.m_linesModeIndexArray.push(this.IndexArray[3*t])}return this.m_linesModeIndexArray},e.prototype.GetLinesModePointArray=function(){if(0===this.m_linesModepositionArray.length&&!this.useIndex){var e=this.positionArray.length;this.m_linesModepositionArray=new Float32Array(2*e);for(var t=0;t<e;t+=9){var r=2*t;this.m_linesModepositionArray[r]=this.positionArray[t],this.m_linesModepositionArray[r+1]=this.positionArray[t+1],this.m_linesModepositionArray[r+2]=this.positionArray[t+2],this.m_linesModepositionArray[r+3]=this.positionArray[t+3],this.m_linesModepositionArray[r+4]=this.positionArray[t+4],this.m_linesModepositionArray[r+5]=this.positionArray[t+5],this.m_linesModepositionArray[r+6]=this.positionArray[t+3],this.m_linesModepositionArray[r+7]=this.positionArray[t+4],this.m_linesModepositionArray[r+8]=this.positionArray[t+5],this.m_linesModepositionArray[r+9]=this.positionArray[t+6],this.m_linesModepositionArray[r+10]=this.positionArray[t+7],this.m_linesModepositionArray[r+11]=this.positionArray[t+8],this.m_linesModepositionArray[r+12]=this.positionArray[t+6],this.m_linesModepositionArray[r+13]=this.positionArray[t+7],this.m_linesModepositionArray[r+14]=this.positionArray[t+8],this.m_linesModepositionArray[r+15]=this.positionArray[t+0],this.m_linesModepositionArray[r+16]=this.positionArray[t+1],this.m_linesModepositionArray[r+17]=this.positionArray[t+2]}}return this.m_linesModepositionArray},e.prototype.UpdateHardWareBuffer=function(e){this.dirty&&(this.dirty=!1,null===this.hardWareVertexBuffer&&0<this.positionArray.length&&this.createVertexBuffer(e),null===this.hardWareIndexBuffer&&0<this.IndexArray.length&&this.createIndexBuffer(e))},e.prototype.createVertexBuffer=function(e){var t=e.GetRenderContext().GetGLRenderContext();this.hardWareVertexBuffer=new M.HardWareVertexBuffer(t);var r,i,n,o,a,s,l=[1,0,0,0,1,0,0,0,1];o=this.positionArray.length,a=this.NormalArray.length,s=this.textureCoords.length;for(var h=new Float32Array(o),u=0,p=0;u<o-2;u+=3,p+=3)9===p&&(p=0),h[u+0]=l[p+0],h[u+1]=l[p+1],h[u+2]=l[p+2];var c=(n=(i=0+o)+a)+s;r=o+a+s+h.length;this.hardWareVertexBuffer.Create(0,r)?(this.hardWareVertexBuffer.SetDataRange(this.positionArray,0),this.hardWareVertexBuffer.SetDataRange(this.NormalArray,i),this.hardWareVertexBuffer.SetDataRange(this.textureCoords,n),this.hardWareVertexBuffer.SetDataRange(h,c),this.hardWareVertexBuffer.SetVertexOffset(0),this.hardWareVertexBuffer.SetNormalOffset(4*i),this.hardWareVertexBuffer.SetTextureCoordsOffset(4*n),this.hardWareVertexBuffer.SetCentersCoordsOffset(4*c),this.hardWareVertexBuffer.WriteBuffer()):this.hardWareVertexBuffer=null},e.prototype.createIndexBuffer=function(e){var t=e.GetRenderContext().GetGLRenderContext();this.hardWareIndexBuffer=new M.HardWareIndexBuffer(t);var r=0;r+=this.IndexArray.length;if(this.hardWareIndexBuffer.Create(0,r)){this.hardWareIndexBuffer.SetDataRange(M.ArrayHelper.ConvertToInt8Array(this.IndexArray),r);this.hardWareIndexBuffer.SetOffset(0),this.hardWareIndexBuffer.WriteBuffer()}else this.hardWareIndexBuffer=null},e.prototype.computeVertexNormals=function(){if(this.positionArray){var e=this.positionArray;this.NormalArray=new Float32Array(this.positionArray.length);for(var t=this.NormalArray,r=new M.Vector3,i=new M.Vector3,n=(new M.Vector3,new M.Vector3,new M.Vector3,0),o=e.length;n<o;n+=9){r=new M.Vector3(e[n],e[n+1],e[n+2]),i=new M.Vector3(e[n+3],e[n+4],e[n+5]);var a=new M.Vector3(e[n+6],e[n+7],e[n+8]).Sub(i),s=r.Sub(i);a.CrossProductED(s).NormalizedED(),t[n+0]=a.x,t[n+1]=a.y,t[n+2]=a.z,t[n+3]=a.x,t[n+4]=a.y,t[n+5]=a.z,t[n+6]=a.x,t[n+7]=a.y,t[n+8]=a.z}}},e.prototype.GetVolumeAndArea=function(){var e,t,r=0,i=0,n=new M.Vector3,o=new M.Vector3,a=new M.Vector3,s=(new M.Vector3,0);if(this.UseIndex()){var l=this.IndexArray.length;s=l;for(var h=this.GetHardWareVertexBuffer(),u=this.GetPositionArray(),p=this.GetHardWareIndexBuffer(),c=this.GetIndexArray(),d=0;d<l/3;d+=3){var S=new M.Vector3(u[c[3*d]],u[c[3*d+1]],u[c[3*d+2]]),f=new M.Vector3(u[c[3*(d+1)]],u[c[3*(d+1)+1]],u[c[3*(d+1)+2]]),m=new M.Vector3(u[c[3*(d+2)]],u[c[3*(d+2)+1]],u[c[3*(d+2)+2]]);n.x=S.x,n.y=S.y,n.z=S.z,o.x=f.x,o.y=f.y,o.z=f.z,a.x=m.x,a.y=m.y,a.z=m.z,e=(T=M.MeshHelper.CalculateAirVol(n,o,a,e,t))[0],t=T[1],Math.abs(e)<1e-10&&console.log(" **** Element NULL  i = %d   S = %f\n",d,e),r+=e,i+=t}p&&p.UnBind(),h&&h.UnBind()}else{s=this.GetPositionArray().length;h=this.GetHardWareVertexBuffer();var y=this.GetPositionArray();for(d=0;d<s;d+=9){var T;S=new M.Vector3(y[d],y[d+1],y[d+2]),f=new M.Vector3(y[d+3],y[d+4],y[d+5]),m=new M.Vector3(y[d+6],y[d+7],y[d+8]);n.x=S.x,n.y=S.y,n.z=S.z,o.x=f.x,o.y=f.y,o.z=f.z,a.x=m.x,a.y=m.y,a.z=m.z,e=(T=M.MeshHelper.CalculateAirVol(n,o,a,e,t))[0],t=T[1],Math.abs(e)<1e-10&&console.log(" **** Element NULL  i = %d   S = %f\n",d,e),r+=e,i+=t}}return 1e-16<r&&i/r,[i,r]},e}();M.VertexSet=e}(M3D||(M3D={})),function(n){n.GL=null;var e=function(){function i(e){this.gl=null,this.gl=e}return i.GetRenderContext=function(e){if(null!==e){var t=e.getContext("webgl",{stencil:!0,preserveDrawingBuffer:!0});if(null===t&&(t=e.getContext("experimental-webgl",{stencil:!0,preserveDrawingBuffer:!0})),n.GL=t,console.log(n.GL===t),null===t)return null;var r=new i(t);r.GetGLRenderContext().getExtension("OES_standard_derivatives");r.GetGLRenderContext().getExtension("EXT_shader_texture_lod");return r.GetGLRenderContext().getExtension("OES_standard_derivatives"),i.hasSRGB=r.GetGLRenderContext().getExtension("EXT_SRGB"),i.hasSRGB=null,i.maxTextures=r.GetGLRenderContext().getParameter(n.GL.MAX_TEXTURE_IMAGE_UNITS),i.maxVertexTextures=r.GetGLRenderContext().getParameter(n.GL.MAX_VERTEX_TEXTURE_IMAGE_UNITS),r}},i.GetExtension=function(e,t){if(void 0!==i.extensions[t])return i.extensions[t];var r;switch(t){case"WEBGL_depth_texture":r=e.getExtension("WEBGL_depth_texture")||e.getExtension("MOZ_WEBGL_depth_texture")||e.getExtension("WEBKIT_WEBGL_depth_texture");break;case"EXT_texture_filter_anisotropic":r=e.getExtension("EXT_texture_filter_anisotropic")||e.getExtension("MOZ_EXT_texture_filter_anisotropic")||e.getExtension("WEBKIT_EXT_texture_filter_anisotropic");break;case"WEBGL_compressed_texture_s3tc":r=e.getExtension("WEBGL_compressed_texture_s3tc")||e.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||e.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc");break;case"WEBGL_compressed_texture_pvrtc":r=e.getExtension("WEBGL_compressed_texture_pvrtc")||e.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc");break;case"WEBGL_compressed_texture_etc1":r=e.getExtension("WEBGL_compressed_texture_etc1");break;default:r=e.getExtension(t)}return null===r&&console.warn(t+" extension not supported."),i.extensions[t]=r},i.prototype.GetGLRenderContext=function(){return this.gl},i.prototype.SetViewMatrix=function(e){this.viewMatrix=e},i.prototype.SetProjectMatrix=function(e){this.projectMatrix=e},i.prototype.GetViewMatrix=function(){return this.viewMatrix},i.prototype.GetProjectMatrix=function(){return this.projectMatrix},i.hasSRGB=null,i.maxTextures=6,i.maxVertexTextures=0,i.extensions={},i}();n.RenderContext=e}(M3D||(M3D={})),function(te){var e=function(){function ee(){}return ee.DrawAxis=function(e,t){var r=t.GetRenderContext().GetGLRenderContext(),i=e;if(te.Parameters.Instance().IsShowAxis||i&&i.SetVisible(!1),i&&te.Parameters.Instance().IsShowAxis){i.SetCurrentGLContext(r);var n=t.GetShaderMananger();if(n){var o=n.GetEffect(te.ShaderManager.Axis);if(o){r.disable(te.GL.DEPTH_TEST),r.viewport(i.iViewX,i.iViewY,i.iW,i.iW);var a=i.GetGLWorldTransform(),s=new te.Matrix4;s.Ortho(i.ProArray[0],i.ProArray[1],i.ProArray[2],i.ProArray[3],i.ProArray[4],i.ProArray[5]),o.UseProgram();var l=o.GetShaderAttributeParameter(te.VSP_POSITION).location,h=a.Multiply(s.Transpose());o.SetUniformValue(te.VSP_MVPMAT,h),o.EnableAttributeArray(l);var u=i.GetPositionVBO();u.Bind(),o.SetUniformValue(te.VSP_UCOLOR,i.xColor),o.SetVertexAttribPointer(l,3,te.GL.FLOAT,0,0),r.drawArrays(te.GL.TRIANGLES,0,i.iPntXNum/3),o.SetUniformValue(te.VSP_UCOLOR,i.yColor),o.SetVertexAttribPointer(l,3,te.GL.FLOAT,0,4*i.yOffset),r.drawArrays(te.GL.TRIANGLES,0,i.iPntYNum/3),o.SetUniformValue(te.VSP_UCOLOR,i.zColor),o.SetVertexAttribPointer(l,3,te.GL.FLOAT,0,4*i.zOffset),r.drawArrays(te.GL.TRIANGLES,0,i.iPntZNum/3),o.SetUniformValue(te.VSP_UCOLOR,i.oColor),o.SetVertexAttribPointer(l,3,te.GL.FLOAT,0,4*i.oOffset),r.drawArrays(te.GL.TRIANGLES,0,i.iPntONum/3),o.DisableAttributeArray(l),u.UnBind(),o.ReleaseShaderProgram(),r.enable(te.GL.DEPTH_TEST)}}}},ee.DrawRenderPassGroup=function(e){var t=e.GetRenderContext().GetGLRenderContext();if(this.ApplyCamera(e),this.DoSection(e,!0)){t.clearStencil(0),t.clear(te.GL.STENCIL_BUFFER_BIT),t.enable(te.GL.STENCIL_TEST);for(var r=[].concat(e.enableClip),i=new Array,n=0;n<r.length;n++)i[n]=r[n];for(n=0;n<i.length;n++)if(0!==i[n]){for(var o=r.length=0;o<i.length;o++)r.push(0);r[n]=1,t.clear(te.GL.STENCIL_BUFFER_BIT),t.stencilFunc(te.GL.ALWAYS,0,1),t.stencilOp(te.GL.KEEP,te.GL.INVERT,te.GL.INVERT),t.stencilMask(1),t.colorMask(!1,!1,!1,!1),t.disable(te.GL.DEPTH_TEST),t.depthMask(!1),this.DrawSampleModelPassGroug(e),(r=i)[n]=0,t.colorMask(!0,!0,!0,!0),t.enable(te.GL.DEPTH_TEST),t.depthMask(!0),t.stencilFunc(te.GL.EQUAL,1,1),t.stencilOp(te.GL.KEEP,te.GL.KEEP,te.GL.KEEP),this.DrawCapPolygon(e,n)}r=i,t.stencilOp(te.GL.KEEP,te.GL.KEEP,te.GL.KEEP),t.stencilFunc(te.GL.EQUAL,0,65535),t.disable(te.GL.STENCIL_TEST)}if(500===te.Parameters.Instance().LightingMode);else if(600===te.Parameters.Instance().LightingMode);else{var a=e.GetRenderManager().GetGlobalEffect(),s=e.GetRenderManager().GetEffectManager().getEffect(a);null!==s?s.Render():this.DrawPhongPass(e)}this.DoSection(e,!1),this.DrawDraggerPass(e)},ee.DrawSolidRenderPassGroup=function(e,t){var r=e.GetRenderContext().GetGLRenderContext();r.enable(te.GL.DEPTH_TEST),r.enable(te.GL.POLYGON_OFFSET_FILL),r.depthMask(!0),r.polygonOffset(.1,.1),this.isSVLX?this.RenderFaces(e,t):this.DrawPhongPassGroup(e,t),r.polygonOffset(0,0),r.disable(te.GL.POLYGON_OFFSET_FILL),r.enable(te.GL.DEPTH_TEST)},ee.DrawTranRenderPassGroup=function(e,t){if(0!=t.GetRenderableArray().length){var r=e.GetRenderContext().GetGLRenderContext(),i=e.GetCamera();r.enable(te.GL.DEPTH_TEST),r.enable(te.GL.POLYGON_OFFSET_FILL),r.enable(te.GL.BLEND),r.polygonOffset(.1,.1);for(var n=i.GetProjection(),o=i.GetView(),a=t.GetRenderableArray(),s=0;s<a.length;s++){var l=a[s].GetBody().GetModel().GetWorldBoundingBox().Center(),h=new te.Vector4(l,1);n.Multiply(o).Multiply(h)}this.isSVLX?this.RenderFaces(e,t):this.DrawPhongPassGroup(e,t),r.disable(te.GL.CULL_FACE),r.depthMask(!0),r.polygonOffset(0,0),r.disable(te.GL.BLEND),r.disable(te.GL.POLYGON_OFFSET_FILL),r.enable(te.GL.DEPTH_TEST)}},ee.DrawTriLineRenderPassGroup=function(e,t){if(0!==t.GetRenderableArray().length){var r=e.GetCamera(),i=e.GetRenderContext(),n=i.GetGLRenderContext();if(r){new te.Matrix4,new te.Matrix4,new te.Matrix4;r.GetProjection().Transpose(),r.GetView().ToMatrix4().Transpose();var o=e.GetShaderMananger().GetEffect(te.ShaderManager.Edge);o.UseProgram();var a=o.GetShaderAttributeParameter(te.VSP_POSITION);o.EnableAttributeArray(a.location),o.SetUniformValue(te.VSP_VIEWMAT,i.GetViewMatrix()),o.SetUniformValue(te.VSP_PROJECTIONMAT,i.GetProjectMatrix()),"IE"!==SView.BrowserHelper.myBrowser()&&n.lineWidth(2);for(var s=0,l=t.GetRenderableArray();s<l.length;s++){var h=l[s],u=h.GetDataLength()/3;if(u){var p=h.IsUseIndex(),c=new te.Matrix4;c=c.Multiply(h.GetRenderWorldMatrix()),o.SetUniformValue(te.VSP_MODELMAT,c);var d=h.GetRenderMesh().GetRefMesh().GetLinesModePointArray();if(null==d)continue;var S=n.createBuffer();n.bindBuffer(n.ARRAY_BUFFER,S),n.bufferData(n.ARRAY_BUFFER,d,n.STATIC_DRAW),o.SetVertexAttribPointer(a.location,3,te.GL.FLOAT,0,0);var f=void 0;if(f=h.IsSelected()?h.GetRenderColor():te.Color.YELLOW().Clone(),o.SetUniformValue(te.FSP_DIFFUSE,f),0<u)if(p){var m=h.GetLineModeIndex();n.drawElements(te.GL.LINES,u,te.GL.FLOAT,m)}else n.drawArrays(te.GL.LINES,0,d.length/3);p?n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null):n.bindBuffer(n.ARRAY_BUFFER,null),n.deleteBuffer(S)}}o.DisableAttributeArray(a.location),o.ReleaseShaderProgram()}}},ee.DrawEdgesRenderPassGroup=function(e,t){if(0!==t.GetRenderableArray().length){var r=e.GetRenderContext().GetGLRenderContext(),i=e.GetRenderContext(),n=e.GetCamera(),o=e.GetShaderMananger().GetEffect(te.ShaderManager.Edge);o.UseProgram();for(var a=[],s=0;s<3;s++){var l=new te.Vector4(e.clipPlane[s].Clone());l=n.GetView().ToMatrix4().Inverse().Transpose().Multiply(l),a.push(l.x),a.push(l.y),a.push(l.z),a.push(l.w)}var h=new Float32Array(a);o.SetUniformValue(te.FSP_CLIPPLANE,3,h);var u,p=new Int32Array(e.enableClip);o.SetUniformValue(te.FSP_ENABLECLIP,3,p),n.GetProjection().Transpose(),n.GetView().ToMatrix4().Transpose();var c=o.GetShaderAttributeParameter(te.VSP_POSITION);o.EnableAttributeArray(c.location),o.SetUniformValue(te.VSP_VIEWMAT,i.GetViewMatrix()),o.SetUniformValue(te.VSP_PROJECTIONMAT,i.GetProjectMatrix());var d=t.GetRenderableArray();u=new te.Matrix4;for(var S=0,f=d;S<f.length;S++){var m=f[S],y=m.GetDataLength(),T=m.GetRenderColor(),M=m.GetBody().GetHardWareVertexBuffer();if(!M)return;M.Bind(),u=m.GetRenderWorldMatrix(),o.SetUniformValue(te.VSP_MODELMAT,u),o.SetUniformValue(te.FSP_DIFFUSE,T),o.SetVertexAttribPointer(c.location,3,te.GL.FLOAT,0,m.vertexPos),r.drawArrays(r.LINES,0,y),M.UnBind()}o.DisableAttributeArray(c.location),o.ReleaseShaderProgram()}},ee.DrawPointPassGroup=function(e,t){if(0!=t.GetRenderableArray().length){var r=e.GetCamera();if(r){var i=e.GetRenderContext().GetGLRenderContext(),n=e.GetShaderMananger(),o=[];i.disable(te.GL.DEPTH_TEST),i.depthMask(!0),i.enable(te.GL.BLEND);for(var a=0,s=t.GetRenderableArray();a<s.length;a++){(h=s[a]).IsFrontShow()?o.push(h):ee.DrawPoint(h,n,r)}if(0<o.length){i.disable(te.GL.DEPTH_TEST),i.depthMask(!0),i.enable(te.GL.BLEND);for(var l=0;l<o.length;l++){var h=o[l];ee.DrawPoint(h,n,r)}}}}},ee.DrawPoint=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(3===e.length){var r=e[0],i=e[1],n=e[2],o=void 0;o=r.GetRenderWorldMatrix();r.GetRenderColor();var a=i.GetCurrentAction();if(1<=(d=r.GetDrawType())&&d<=5){(S=i.GetEffect(te.ShaderManager.Image)).UseProgram();for(var s=[],l=0;l<3;l++){var h=new te.Vector4(a.clipPlane[l].Clone());h=n.GetView().ToMatrix4().Inverse().Transpose().Multiply(h),s.push(h.x),s.push(h.y),s.push(h.z),s.push(h.w)}var u=new Float32Array(s);S.SetUniformValue(te.FSP_CLIPPLANE,3,u);var p=new Int32Array(a.enableClip);S.SetUniformValue(te.FSP_ENABLECLIP,3,p),ee.DrawImageBoard(r.GetImageboard(),n,o,S),S.ReleaseShaderProgram()}else if(0==d){(S=i.GetEffect(te.ShaderManager.Edge)).UseProgram();for(s=[],l=0;l<3;l++){h=new te.Vector4(a.clipPlane[l].Clone());h=n.GetView().ToMatrix4().Inverse().Transpose().Multiply(h),s.push(h.x),s.push(h.y),s.push(h.z),s.push(h.w)}u=new Float32Array(s);S.SetUniformValue(te.FSP_CLIPPLANE,3,u);p=new Int32Array(a.enableClip);S.SetUniformValue(te.FSP_ENABLECLIP,3,p),ee.DrawMeshBoard(r.GetMeshBoard(),n,o,S),S.ReleaseShaderProgram()}}else if(4===e.length){r=e[0],i=e[1],n=e[2];var c=e[3];o=void 0;o=r.GetRenderWorldMatrix().Multiply(c);var d;r.GetRenderColor(),a=i.GetCurrentAction();if(1==(d=r.GetDrawType())||2==d||3==d||4==d){(S=i.GetEffect(te.ShaderManager.Image)).UseProgram();for(s=[],l=0;l<3;l++){h=new te.Vector4(a.clipPlane[l].Clone());h=n.GetView().ToMatrix4().Inverse().Transpose().Multiply(h),s.push(h.x),s.push(h.y),s.push(h.z),s.push(h.w)}u=new Float32Array(s);S.SetUniformValue(te.FSP_CLIPPLANE,3,u);p=new Int32Array(a.enableClip);S.SetUniformValue(te.FSP_ENABLECLIP,3,p),ee.DrawImageBoard(r.GetImageboard(),n,o,S),S.ReleaseShaderProgram()}else if(0==d){var S;(S=i.GetEffect(te.ShaderManager.Edge)).UseProgram();for(s=[],l=0;l<3;l++){h=new te.Vector4(a.clipPlane[l].Clone());h=n.GetView().ToMatrix4().Inverse().Transpose().Multiply(h),s.push(h.x),s.push(h.y),s.push(h.z),s.push(h.w)}u=new Float32Array(s);S.SetUniformValue(te.FSP_CLIPPLANE,3,u);p=new Int32Array(a.enableClip);S.SetUniformValue(te.FSP_ENABLECLIP,3,p),ee.DrawMeshBoard(r.GetMeshBoard(),n,o,S),S.ReleaseShaderProgram()}}},ee.DrawImageBoard=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(4===e.length){var r=e[0],i=e[1],n=e[2],o=e[3];if(null===r)return;if(null===(d=r.GetTexture()))return;(S=o.GetGLRenderContext()).enable(te.GL.BLEND),S.disable(te.GL.DEPTH_TEST);var a=void 0,s=void 0,l=void 0;if(s=i.GetProjection().Transpose(),a=i.GetView().ToMatrix4().Transpose(),f=d.GetOGLObj(S)){l=r.GetRenderWorldMatrix().Multiply(n);var h=r.GetRenderColor();r.GetHardWareVertexBuffer().Bind();var u=o.GetShaderAttributeParameter(te.VSP_POSITION);o.SetVertexAttribPointer(u.location,3,te.GL.FLOAT,0,r.GetVertexOffset()),o.EnableAttributeArray(u.location);var p=o.GetShaderAttributeParameter(te.VSP_TEXCOORDS);o.SetVertexAttribPointer(p.location,2,te.GL.FLOAT,0,r.GetTextureCoordsOffset()),o.EnableAttributeArray(p.location);var c=new Int32Array([0]);o.SetUniformValue(te.FSP_SAMPLER0,c),o.SetUniformValue(te.FSP_DIFFUSE,h),o.SetUniformValue(te.VSP_MODELMAT,l),o.SetUniformValue(te.VSP_VIEWMAT,a),o.SetUniformValue(te.VSP_PROJECTIONMAT,s),S.activeTexture(S.TEXTURE0),S.bindTexture(S.TEXTURE_2D,f),S.drawArrays(S.TRIANGLES,0,6),S.bindTexture(S.TEXTURE_2D,null),r.GetHardWareVertexBuffer().UnBind(),o.DisableAttributeArray(u.location),o.DisableAttributeArray(p.location),S.disable(te.GL.BLEND)}else te.LOGI("Draw Point Error texObj is null")}else{var d,S;r=e[0],a=e[1],s=e[2],n=e[3],o=e[4],e[5];if(!r)return;if(!(d=r.GetTexture()))return;(S=o.GetGLRenderContext()).enable(te.GL.BLEND);var f,m=0,y=o.GetShaderUniformParameter("u_useMinDepth");if(r.IsFrontShow()?(S.disable(te.GL.DEPTH_TEST),y&&(m=0,o.SetUniformValue("u_useMinDepth",y.location,m))):(S.enable(te.GL.DEPTH_TEST),y&&(m=1,o.SetUniformValue("u_useMinDepth",y.location,m))),f=d.GetOGLObj(S)){l=new te.Matrix4,new te.Matrix4;l=te.Matrix4.IDENTITY(),r.GetRenderWorldMatrix()&&(l=r.GetRenderWorldMatrix().Multiply(n));h=r.GetRenderColor();r.SetCurrentGLContext(S),r.GetHardWareVertexBuffer().Bind();u=o.GetShaderAttributeParameter(te.VSP_POSITION);o.SetVertexAttribPointer(u.location,3,te.GL.FLOAT,0,r.GetVertexOffset()),o.EnableAttributeArray(u.location);p=o.GetShaderAttributeParameter(te.VSP_TEXCOORDS);o.SetVertexAttribPointer(p.location,2,te.GL.FLOAT,0,r.GetTextureCoordsOffset()),o.EnableAttributeArray(p.location);c=0;o.SetUniformValue(te.FSP_SAMPLER0,1,c),o.SetUniformValue(te.FSP_DIFFUSE,h),o.SetUniformValue(te.VSP_MODELMAT,l),o.SetUniformValue(te.VSP_VIEWMAT,a),o.SetUniformValue(te.VSP_PROJECTIONMAT,s),S.activeTexture(te.GL.TEXTURE0),S.bindTexture(te.GL.TEXTURE_2D,f),S.drawArrays(te.GL.TRIANGLES,0,6),S.bindTexture(te.GL.TEXTURE_2D,null),o.DisableAttributeArray(u.location),o.DisableAttributeArray(p.location),S.disable(te.GL.BLEND)}}},ee.DrawMeshBoard=function(e,t,r,i){if(null!==e){var n,o,a,s=i.GetGLRenderContext();o=t.GetProjection().Transpose(),n=t.GetView().ToMatrix4().Transpose(),a=e.GetRenderWorldMatrix().Multiply(r);for(var l=i.GetShaderAttributeParameter(te.VSP_POSITION),h=s.createBuffer(),u=e.GetLinesVertexs(),p=[],c=0;c<u.length;c++)p.push(u[c].x),p.push(u[c].y),p.push(u[c].z);s.bindBuffer(s.ARRAY_BUFFER,h),s.bufferData(s.ARRAY_BUFFER,new Float32Array(p),s.STATIC_DRAW),i.SetVertexAttribPointer(l.location,3,te.GL.FLOAT,0,0),i.EnableAttributeArray(l.location);var d=e.GetRenderColor();i.SetUniformValue(te.FSP_DIFFUSE,d),i.SetUniformValue(te.VSP_MODELMAT,a),i.SetUniformValue(te.VSP_VIEWMAT,n),i.SetUniformValue(te.VSP_PROJECTIONMAT,o),s.drawArrays(te.GL.LINES,0,4),i.DisableAttributeArray(l.location),s.deleteBuffer(h)}},ee.DrawPointHandler=function(e,t,r,i){if(e||e.IsVisible()){var n=e.GetPoint();ee.DrawPoint(n,t,r,i)}},ee.DrawMeshHandler=function(e){},ee.DrawBoxRenderPassGroup=function(e,t){if(0!==t.GetRenderableArray().length){var r=e.GetRenderContext().GetGLRenderContext(),i=e.GetRenderContext(),n=e.GetCamera(),o=e.GetShaderMananger();"IE"!==SView.BrowserHelper.myBrowser()&&r.lineWidth(2);var a=o.GetEffect(te.ShaderManager.Edge);a.UseProgram();for(var s=[],l=0;l<3;l++){var h=new te.Vector4(e.clipPlane[l].Clone());h=n.GetView().ToMatrix4().Inverse().Transpose().Multiply(h),s.push(h.x),s.push(h.y),s.push(h.z),s.push(h.w)}var u=new Float32Array(s);a.SetUniformValue(te.FSP_CLIPPLANE,3,u);var p=new Int32Array(e.enableClip);a.SetUniformValue(te.FSP_ENABLECLIP,3,p),n.GetProjection().Transpose(),n.GetView().ToMatrix4().Transpose();var c=a.GetShaderAttributeParameter(te.VSP_POSITION);a.EnableAttributeArray(c.location),a.SetUniformValue(te.VSP_VIEWMAT,i.GetViewMatrix()),a.SetUniformValue(te.VSP_PROJECTIONMAT,i.GetProjectMatrix());for(var d=0,S=t.GetRenderableArray();d<S.length;d++)S[d];a.DisableAttributeArray(c.location),a.ReleaseShaderProgram()}},ee.DrawRenderActionBox=function(e){if(e.GetRenderBox().Defined()){var t=e.GetRenderContext().GetGLRenderContext(),r=e.GetRenderContext(),i=e.GetCamera(),n=e.GetShaderMananger();"IE"!==SView.BrowserHelper.myBrowser()&&t.lineWidth(2);var o=n.GetEffect(te.ShaderManager.Edge);o.UseProgram();for(var a=[],s=0;s<3;s++){var l=new te.Vector4(e.clipPlane[s].Clone());l=i.GetView().ToMatrix4().Inverse().Transpose().Multiply(l),a.push(l.x),a.push(l.y),a.push(l.z),a.push(l.w)}var h=new Float32Array(a);o.SetUniformValue(te.FSP_CLIPPLANE,3,h);var u=new Int32Array(e.enableClip);o.SetUniformValue(te.FSP_ENABLECLIP,3,u);var p;i.GetProjection().Transpose(),i.GetView().ToMatrix4().Transpose(),p=te.Matrix4.IDENTITY();var c=o.GetShaderAttributeParameter(te.VSP_POSITION);o.EnableAttributeArray(c.location),o.SetUniformValue(te.VSP_VIEWMAT,r.GetViewMatrix()),o.SetUniformValue(te.VSP_PROJECTIONMAT,r.GetProjectMatrix()),ee.DrawShapeBox(e.GetRenderBox(),!1,c,o,p),o.DisableAttributeArray(c.location),o.ReleaseShaderProgram()}},ee.DrawShapeBox=function(e,t,r,i,n,o){void 0===o&&(o=!0);var a=i.GetGLRenderContext(),s=new te.Color;s=t?te.Parameters.Instance().SelectedColor:te.Parameters.Instance().BoxColor;var l=n.Clone();if(e.Defined()){var h=e.GetVertexs(),u=void 0;u=o?te.BoundingBox.boxIndexs():te.BoundingBox.chicumIndex();var p=te.ArrayHelper.ConvertToUInt8Array(u),c=a.createBuffer();a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,c),a.bufferData(a.ELEMENT_ARRAY_BUFFER,p,a.STATIC_DRAW);var d=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,d),a.bufferData(a.ARRAY_BUFFER,h,a.STATIC_DRAW),i.SetVertexAttribPointer(r.location,3,te.GL.FLOAT,0,0),i.SetUniformValue(te.FSP_DIFFUSE,s),i.SetUniformValue(te.VSP_MODELMAT,l),o?a.drawElements(a.LINES,24,a.UNSIGNED_BYTE,0):a.drawElements(a.LINES,6,a.UNSIGNED_BYTE,0),a.bindBuffer(a.ARRAY_BUFFER,null),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,null),a.deleteBuffer(c),a.deleteBuffer(d)}},ee.DrawRenderSceneBoxNote=function(e){var t=e.GetScene(),r=e.GetCamera();if(r&&t){var i=t.GetSceneBoxNote();if(i){var n=i.GetImageBoards(),o=n.length;if(0!==o){var a=new te.Matrix4,s=new te.Matrix4,l=new te.Matrix4;new te.Matrix4;s=r.GetProjection().Transpose(),a=r.GetView().ToMatrix4().Transpose();var h=e.GetShaderMananger(),u=h.GetEffect(te.ShaderManager.Edge),p=u.GetGLRenderContext();u.UseProgram();var c=u.GetShaderAttributeParameter(te.VSP_POSITION);u.EnableAttributeArray(c.location),u.SetUniformValue(te.VSP_VIEWMAT,a),u.SetUniformValue(te.VSP_PROJECTIONMAT,s);for(var d=[],S=0;S<3;S++){var f=new te.Vector4(e.clipPlane[S].Clone());f=r.GetView().ToMatrix4().Inverse().Transpose().Multiply(f),d.push(f.x),d.push(f.y),d.push(f.z),d.push(f.w)}var m=new Float32Array(d);u.SetUniformValue(te.FSP_CLIPPLANE,3,m);var y=new Int32Array(e.enableClip);u.SetUniformValue(te.FSP_ENABLECLIP,3,y);var T=u.GetShaderUniformParameter(te.FSP_REVERSECLIP);u.SetUniformValue(T.location+"",e.m_bReverseClip),p.enable(te.GL.DEPTH_TEST),this.DrawShapeBox(t.GetSceneBox(),!1,c,u,l,!1),u.DisableAttributeArray(c.location),u.ReleaseShaderProgram();var M=new te.Matrix4;(u=h.GetEffect(te.ShaderManager.NoteImage)).UseProgram(),u.SetUniformValue(te.FSP_CLIPPLANE,3,m),u.SetUniformValue(te.FSP_ENABLECLIP,3,y),T=u.GetShaderUniformParameter(te.FSP_REVERSECLIP),u.SetUniformValue(T.location+"",e.m_bReverseClip);var g=new te.Matrix3x4;e.SetWorldMatrix(g);for(var v=0;v<o;v++)n[v].UpdateRenderData(e),this.DrawImageBoard(n[v],r,M,u);u.ReleaseShaderProgram()}}}},ee.DrawAnnotationRenderPassGroup=function(e,t){if(0!=t.GetRenderableArray().length){var r=e.GetCamera();if(r)for(var i=e.GetShaderMananger(),n=t.GetRenderableArray(),o=0;o<n.length;o++){var a=n[o];r=a&&a.GetFixed()?e.GetScene().GetHudCamera():e.GetCamera();var s=a.GetRenderWorldMatrix();this.DrawAnnotation(a,r,i,s)}}},ee.DrawAnnotation=function(e,t,r,i){if(e){var n=r.GetEffect(te.ShaderManager.NoteEdge);n.UseProgram();for(var o=r.GetCurrentAction(),a=o.GetRenderContext().GetGLRenderContext(),s=[],l=0;l<3;l++){var h=new te.Vector4(o.clipPlane[l].Clone());h=t.GetView().ToMatrix4().Inverse().Transpose().Multiply(h),s.push(h.x),s.push(h.y),s.push(h.z),s.push(h.w)}var u=new Float32Array(s);n.SetUniformValue(te.FSP_CLIPPLANE,3,u);var p=new Int32Array(o.enableClip);n.SetUniformValue(te.FSP_ENABLECLIP,3,p);var c=new te.Matrix4,d=new te.Matrix4,S=new te.Matrix4;new te.Matrix4;d=t.GetProjection().Transpose(),c=t.GetView().ToMatrix4().Transpose(),S=i;var f=n.GetShaderAttributeParameter(te.VSP_POSITION);n.EnableAttributeArray(f.location),n.SetUniformValue(te.VSP_MODELMAT,S),n.SetUniformValue(te.VSP_VIEWMAT,c),n.SetUniformValue(te.VSP_PROJECTIONMAT,d),te.Parameters.Instance().IsShowBox&&this.DrawShapeBox(e.GetBoundingBox(),!1,f,n,i);var m=0,y=n.GetShaderUniformParameter("u_useMinDepth");e.IsFrontShow()?(m=1,a.disable(te.GL.DEPTH_TEST),y&&n.SetUniformValue("u_useMinDepth",m)):(m=0,y&&n.SetUniformValue("u_useMinDepth",m),a.enable(te.GL.DEPTH_TEST)),a.depthMask(!0),a.enable(te.GL.BLEND);var T=e.GetDrawColor();"IE"!==SView.BrowserHelper.myBrowser()&&a.lineWidth(4);for(var M=0;M<e.LineList.length;M++){var g=(L=e.LineList[M]).GetDrawColor(),v=L.GetLineWidth();"IE"!==SView.BrowserHelper.myBrowser()&&a.lineWidth(v);var C=2,_=2,A=[L.StartPoint.x,L.StartPoint.y,L.StartPoint.z,L.EndPoint.x,L.EndPoint.y,L.EndPoint.z],E=a.createBuffer();a.bindBuffer(te.GL.ARRAY_BUFFER,E),a.bufferData(te.GL.ARRAY_BUFFER,te.ArrayHelper.ConvertToFloat32Array(A),te.GL.STATIC_DRAW),n.SetUniformValue(te.FSP_DIFFUSE,g),n.EnableAttributeArray(f.location),n.SetVertexAttribPointer(f.location,3,te.GL.FLOAT,0,0);var G=[0,1],P=te.ArrayHelper.ConvertToInt16Array(G),w=a.createBuffer();a.bindBuffer(te.GL.ELEMENT_ARRAY_BUFFER,w),a.bufferData(te.GL.ELEMENT_ARRAY_BUFFER,P,te.GL.STATIC_DRAW),a.drawElements(te.GL.LINE_STRIP,_,te.GL.UNSIGNED_SHORT,0);for(var D=L.GetStartArrowBuffer(),x=0;x<D.length;x+=3){var R=D[x];n.SetVertexAttribPointer(f.location,3,te.GL.FLOAT,0,x),n.SetUniformValue(te.FSP_DIFFUSE,g),a.drawArrays(te.GL.LINE_STRIP,0,R.length/9)}var I=L.GetEndArrowBuffer();for(x=0;x<I.length;x+=3){R=I[M];n.SetVertexAttribPointer(f.location,3,te.GL.FLOAT,0,x),n.SetUniformValue(te.FSP_DIFFUSE,g),a.drawArrays(te.GL.LINE_STRIP,0,R.length/9)}}for(M=0;M<e.PolyLineList.length;M++){var L;C=(L=e.PolyLineList[M]).GetPointList().length/3,_=0,A=L.GetPointList(),G=0,g=L.GetDrawColor();n.SetUniformValue(te.FSP_DIFFUSE,g);var N=[];for(x=0;x<L.GetPointList().length;x++)if(0!=x){if(0<x){var O=x-1,b=L.GetPointList()[O];N.push(b.x),N.push(b.y),N.push(b.z)}var V=L.GetPointList()[x];N.push(V.x),N.push(V.y),N.push(V.z)}E=a.createBuffer();a.bindBuffer(te.GL.ARRAY_BUFFER,E),a.bufferData(te.GL.ARRAY_BUFFER,te.ArrayHelper.ConvertToFloat32Array(N),te.GL.STATIC_DRAW),0<_?(n.SetVertexAttribPointer(f.location,3,te.GL.FLOAT,0,0),a.drawElements(te.GL.LINE_STRIP,_,te.GL.UNSIGNED_INT,G)):(n.SetVertexAttribPointer(f.location,3,te.GL.FLOAT,0,0),a.drawArrays(te.GL.LINE_STRIP,0,C))}if(0<e.PointList.length){for(M=0;M<e.PointList.length;M++){var F=e.PointList[M];this.DrawPoint(F,r,t)}n.UseProgram()}var B=e.imageBoardList.length;if(0==B){var U=e.GetBillBoard(),H=i;U&&(H=i.Multiply(U.GetGLWorldMatrix()));var k=e.ComTexts;for(M=0;M<k.length;M++){var z=k[M].GetMesh();if(z){var W=z.GetDataLength();if(W){var Y=z.GetRefMesh().UseIndex();z.GetRefMesh().GetPositionArray();if(n.SetUniformValue(te.FSP_DIFFUSE,T),n.SetUniformValue(te.VSP_MODELMAT,H),n.SetVertexAttribPointer(f.location,3,te.GL.FLOAT,0,0),Y){P=te.ArrayHelper.ConvertToInt16Array(z.GetRefMesh().GetIndexArray()),w=a.createBuffer();a.bindBuffer(te.GL.ELEMENT_ARRAY_BUFFER,w),a.bufferData(te.GL.ELEMENT_ARRAY_BUFFER,P,te.GL.STATIC_DRAW),a.drawElements(te.GL.TRIANGLES,W,te.GL.UNSIGNED_SHORT,0),a.bindBuffer(te.GL.ELEMENT_ARRAY_BUFFER,null)}else a.drawArrays(te.GL.TRIANGLES,0,W)}}}}if(n.DisableAttributeArray(f.location),n.ReleaseShaderProgram(),0<B){var X=r.GetEffect(te.ShaderManager.NoteImage);X.UseProgram(),X.SetUniformValue(te.FSP_CLIPPLANE,3,u),X.SetUniformValue(te.FSP_ENABLECLIP,3,p);for(M=0;M<e.imageBoardList.length;M++){var j=e.imageBoardList[M],K=new te.Matrix4,q=new te.Matrix4;new te.Matrix4,new te.Matrix4;t&&(q=t.GetProjection().Transpose(),K=t.GetView().ToMatrix4().Transpose()),this.DrawImageBoard(j,K,q,i,X,!0)}X.ReleaseShaderProgram()}}},ee.DrawNoteRenderPassGroup=function(e,t){if(0!==t.GetRenderableArray().length){var r=e.GetCamera();if(r)for(var i=e.GetShaderMananger(),n=0,o=t.GetRenderableArray();n<o.length;n++){var a=o[n],s=a.GetType(),l=a.GetRenderWorldMatrix();switch(s){case te.ShapeType.SHAPE_VOICE_NOTE:var h=i.GetEffect(te.ShaderManager.Image);h.UseProgram();for(var u=[],p=0;p<3;p++){var c=new te.Vector4(e.clipPlane[p].Clone());c=r.GetView().ToMatrix4().Inverse().Transpose().Multiply(c),u.push(c.x),u.push(c.y),u.push(c.z),u.push(c.w)}var d=new Float32Array(u);h.SetUniformValue(te.FSP_CLIPPLANE,3,d);var S=new Int32Array(e.enableClip);h.SetUniformValue(te.FSP_ENABLECLIP,3,S);break;case te.ShapeType.SHAPE_TEXT_NOTE:case te.ShapeType.SHAPE_THREED_GESTURE_NOTE:case te.ShapeType.SHAPE_SEQUENCE_NUMBER_NOTE:case te.ShapeType.SHAPE_NOTE:ee.DrawNote(a,r,i,l);break;case te.ShapeType.SHAPE_MEASURE_BASE:case te.ShapeType.SHAPE_MEASURE_DISTANCE:case te.ShapeType.SHAPE_MEASURE_ANGLE:case te.ShapeType.SHAPE_MEASURE_PROPERTY:case te.ShapeType.SHAPE_MEASURE_DIAMETRE:ee.DrawNote(a,r,i,l)}}}},ee.DrawNote=function(e,t,r,i){var n=r.GetEffect(te.ShaderManager.Edge);n.UseProgram();for(var o=r.GetCurrentAction(),a=o.GetRenderContext().GetGLRenderContext(),s=[],l=0;l<3;l++){var h=new te.Vector4(o.clipPlane[l].Clone());h=t.GetView().ToMatrix4().Inverse().Transpose().Multiply(h),s.push(h.x),s.push(h.y),s.push(h.z),s.push(h.w)}var u=new Float32Array(s);n.SetUniformValue(te.FSP_CLIPPLANE,3,u);var p,c,d,S=new Int32Array(o.enableClip);n.SetUniformValue(te.FSP_ENABLECLIP,3,S),c=t.GetProjection().Transpose(),p=t.GetView().ToMatrix4().Transpose(),d=i.Clone();var f=n.GetShaderAttributeParameter(te.VSP_POSITION);n.EnableAttributeArray(f.location),n.SetUniformValue(te.VSP_MODELMAT,d),n.SetUniformValue(te.VSP_VIEWMAT,p),n.SetUniformValue(te.VSP_PROJECTIONMAT,c),te.Parameters.Instance().IsShowBox,e.IsFrontShow()?a.disable(te.GL.DEPTH_TEST):a.enable(te.GL.DEPTH_TEST),a.depthMask(!0),a.enable(te.GL.BLEND);var m;e.GetDrawColor();"IE"!==SView.BrowserHelper.myBrowser()&&a.lineWidth(4);for(var y=0;y<e.LineList.length;y++){var T=[],M=e.LineList[y];m=M.GetDrawColor();var g=M.GetLineWidth();"IE"!==SView.BrowserHelper.myBrowser()&&a.lineWidth(g),"exLine"===M.GetName()&&"IE"!==SView.BrowserHelper.myBrowser()&&a.lineWidth(2);var v=[M.StartPoint.x,M.StartPoint.y,M.StartPoint.z,M.EndPoint.x,M.EndPoint.y,M.EndPoint.z];if("dottedLine"===M.GetName()){v=[];var C=[];te.M3DTOOLS.VecSlerp1(M.StartPoint,M.EndPoint,20,C);for(var _=0;_<C.length;_++){var A=C[_];v.push(A.x),v.push(A.y),v.push(A.z)}v.length/3}if(T.push(M.StartPoint.x),T.push(M.StartPoint.y),T.push(M.StartPoint.z),T.push(M.EndPoint.x),T.push(M.EndPoint.y),T.push(M.EndPoint.z),"dottedLine"===M.GetName()){T=[];var E=[];te.M3DTOOLS.VecSlerp1(M.StartPoint,M.EndPoint,20,E);for(_=0;_<E.length;_++){A=E[_];T.push(A.x),T.push(A.y),T.push(A.z)}T.length/3}"exLine"===M.GetName()&&"IE"!==SView.BrowserHelper.myBrowser()&&a.lineWidth(4);var G=a.createBuffer();a.bindBuffer(te.GL.ARRAY_BUFFER,G),a.bufferData(te.GL.ARRAY_BUFFER,te.ArrayHelper.ConvertToFloat32Array(T),te.GL.STATIC_DRAW),n.SetUniformValue(te.FSP_DIFFUSE,m),n.EnableAttributeArray(f.location),n.SetVertexAttribPointer(f.location,3,te.GL.FLOAT,0,0),a.drawArrays(te.GL.LINES,0,T.length/3),n.DisableAttributeArray(f.location),a.deleteBuffer(G)}var P=e.PointList.length;if(0<P){for(y=0;y<P;y++){var w=e.PointList[y];ee.DrawPoint(w,r,t)}n.UseProgram()}var D=e.imageBoardList.length;if(n.DisableAttributeArray(f.location),n.ReleaseShaderProgram(),0<D){var x=r.GetEffect(te.ShaderManager.Image);x.UseProgram(),x.SetUniformValue(te.FSP_CLIPPLANE,3,u),x.SetUniformValue(te.FSP_ENABLECLIP,3,S);for(y=0;y<e.imageBoardList.length;y++){var R=e.imageBoardList[y];ee.DrawImageBoard(R,t,i,x)}x.ReleaseShaderProgram()}},ee.DrawBasePass=function(e,t){var r=e.GetShaderMananger();if(r){var c=e.GetRenderContext().GetGLRenderContext(),d=r.GetEffect(te.ShaderManager.Dragger);if(d){var i=e.GetCamera(),S=i.GetProjection().Transpose(),f=i.GetView().ToMatrix4().Transpose();d.UseProgram(),t.GetRenderableArray().forEach(function(e){var t=e.GetDataLength();if(0<t){var r=e.IsUseIndex(),i=e.GetHardWareVertexBuffer(),n=e.GetHardWareIndexBuffer(),o=(i.Bind(),d.GetShaderAttributeParameter(te.VSP_POSITION)),a=d.GetShaderAttributeParameter(te.VSP_NORMAL),s=e.GetRenderWorldMatrix();d.SetUniformValue(te.VSP_MODELMAT,s),d.SetUniformValue(te.VSP_VIEWMAT,f),d.SetUniformValue(te.VSP_PROJECTIONMAT,S);var l=e.GetRenderColor();d.SetUniformValue(te.VSP_UCOLOR,l);var h=e.GetVertexOffset(),u=e.GetNormalOffset();e.GetTextureCoordsOffset();if(d.SetVertexAttribPointer(o.location,3,te.GL.FLOAT,0,h),d.SetVertexAttribPointer(a.location,3,te.GL.FLOAT,0,u),d.EnableAttributeArray(o.location),d.EnableAttributeArray(a.location),r){var p=e.GetIndexOffset();ee.DrawTriWithIndex(c,i,n,t,p)}else ee.DrawTriNoIndex(c,i,t);d.DisableAttributeArray(o.location)}}),d.ReleaseShaderProgram()}}},ee.DrawDraggerLinePass=function(e,t){if(0!==t.GetRenderableArray().length){var r=e.GetRenderContext().GetGLRenderContext();"IE"!==SView.BrowserHelper.myBrowser()&&r.lineWidth(2);var i=e.GetShaderMananger();if(i){var n=i.GetEffect(te.ShaderManager.Dragger);n.UseProgram();var o=e.GetCamera(),a=o.GetProjection().Transpose(),s=o.GetView().ToMatrix4().Transpose();n.SetUniformValue(te.VSP_VIEWMAT,s),n.SetUniformValue(te.VSP_PROJECTIONMAT,a);var l=new te.Matrix4,h=n.GetShaderAttributeParameter(te.VSP_POSITION);n.EnableAttributeArray(h.location);for(var u=t.GetRenderableArray(),p=0;p<u.length;p++){var c=u[p],d=c.GetRenderColor();c.GetHardWareVertexBuffer(),c.GetHardWareIndexBuffer();l=l.Multiply(c.GetRenderWorldMatrix());var S;S=d;var f=c.GetDataLength();if(f){n.SetVertexAttribPointer(h.location,3,te.GL.FLOAT,0,c.GetVertexOffset()),n.SetUniformValue(te.VSP_MODELMAT,l),n.SetUniformValue(te.VSP_UCOLOR,S);c.GetIndexOffset();r.drawArrays(te.GL.LINES,0,f)}}n.DisableAttributeArray(h.location),n.ReleaseShaderProgram()}}},ee.DrawDraggerPass=function(e){e.SetSection(null);for(var t=e.GetRenderEffect(),r=(t.GetRenderableTypeFilter(),t.GetRenderQueuePriority().GetData()),i=null,n=e.GetDraggerRenderQueueGroup(),o=0;o<r.length;o++){i=r[o];var a=n.get(i.GetRenderGroupType().GetType());if(a){a.SetRenderTech(i);var s=a.GetType().GetType();s==te.RenderableType.RGT_SOLID?ee.DrawBasePass(e,a):s==te.RenderableType.RGT_TRANSPARENT?ee.DrawBasePass(e,a):s==te.RenderableType.RGT_EDGELINE?ee.DrawDraggerLinePass(e,a):s==te.RenderableType.RGT_HANDLER&&ee.DrawHandlerRenderPassGroup(e,a)}}},ee.GetDepthMaterial=function(e,t,r){return ee.depthMaterial||(ee.depthMaterial=t.GetOrCreateMaterial("DepthMaterial",te.MaterialType.MaterialType_Depth)).SetAcceptLight(!1),ee.depthMaterial},ee.ShadowRender=function(e,t){if(0!=t.GetRenderableArray().length){for(var r=e.GetScene().GetResourceManager(),i=e.GetRenderContext().GetGLRenderContext(),n=e.GetScene().GetLightManager(),o=0,a=n.GetAllLight().length;o<a;o++){var s=n.GetAllLight()[o];if(s.CastShadow()){var l=s.GetLightShadow(),h=l.GetCamera();if(!l.RenderTarget()){var u=new te.HardWareFrameBuffer(i);u.SetParameters(1,!1,!1,!0,!1,!1,4),u.setSize(l.GetMapSize().x,l.GetMapSize().y),u.setResourceManager(r),l.SetRenderTarget(u),ee.rendT=l.RenderTarget()}var p=0;if(s.GetLightSourceType()==te.LightType.LightType_Directional)p=e.GetScene().GetSceneBox().Length(),l.SetCameraInfo(p,p*te.NEAR_CLIP_PLANE_FACTOR,p*te.FAR_CLIP_PLANE_FACTOR*3);var c=l.RenderTarget();(ee.renderTarget=c).reShape(),c.bind(),i.enable(te.GL.DEPTH_TEST),i.depthFunc(te.GL.LEQUAL),i.clearColor(0,0,0,1),i.clear(te.GL.DEPTH_BUFFER_BIT|te.GL.COLOR_BUFFER_BIT|te.GL.STENCIL_BUFFER_BIT);for(var d=s.GetLightSourceType()===te.LightType.LightType_Point?6:1,S=s.GetLightSourceType()===te.LightType.LightType_Point,f=0;f<d;f++){S||l.Update(s,e.GetCamera(),1),S||i.viewport(0,0,l.GetMapSize().x,l.GetMapSize().x);l.Matrix();i.enable(te.GL.CULL_FACE),i.cullFace(te.GL.FRONT);var m=ee.GetDepthMaterial(s,r,S);ee.m_currentCamera=null,ee.m_currentMaterial=null;var y=t.GetRenderableArray();if(0==y.length)return;for(var T=0;T<y.length;T++){var M=y[T],g=M.GetBody().GetModel().GetWorldBoundingBox();h.GetFrustum().IsInsideFast(g)!==te.Intersection.OUTSIDE&&ee.RenderFace(e,M,h,m)}i.disable(te.GL.CULL_FACE)}i.disableVertexAttribArray(0),i.disableVertexAttribArray(1),i.disableVertexAttribArray(2),c.unbind()}}var v=e.GetScene().GetCamera().GetViewPort().GetRect();i.viewport(v.left,v.top,v.right,v.bottom)}},ee.DrawHandlerRenderPassGroup=function(e,t){if(0!==t.GetRenderableArray().length){var r=e.GetRenderContext().GetGLRenderContext();r.enable(te.GL.BLEND),r.disable(te.GL.DEPTH_TEST),r.depthMask(!0);var i=e.GetCamera();if(i){for(var n=e.GetShaderMananger(),o=0,a=t.GetRenderableArray();o<a.length;o++){var s=a[o],l=s.GetType(),h=s.GetRenderWorldMatrix();if(l===te.ShapeType.SHAPE_POINT_HANDLE)ee.DrawPointHandler(s,n,i,h);else l!=te.ShapeType.SHAPE_PLANE_HANDLE&&l!=te.ShapeType.SHAPE_AXIS_HANDLE&&l!=te.ShapeType.SHAPE_ROTATE_HANDLE&&l!=te.ShapeType.SHAPE_ROTATECENTER||ee.DrawMeshHandler(s)}r.disable(te.GL.BLEND),r.depthMask(!0),r.enable(te.GL.DEPTH_TEST)}}},ee.DrawPMISRenderPassGroup=function(e,t){if(0!=t.GetRenderableArray().length){var r=e.GetCamera();if(r){e.GetShaderMananger();var i=e.GetRenderContext().GetGLRenderContext();i.disable(te.GL.CULL_FACE),i.disable(te.GL.BLEND),i.enable(te.GL.DEPTH_TEST),i.depthMask(!0),"IE"!==SView.BrowserHelper.myBrowser()&&i.lineWidth(2);for(var n=0,o=t.GetRenderableArray();n<o.length;n++){var a=o[n],s=a.GetRenderWorldMatrix();ee.DrawPMINew(e,a,r,s)}}}},ee.DrawPMINew=function(e,t,r,i){if(0!=t.IsVisible()){var n,o,a,s=e.GetRenderContext().GetGLRenderContext(),l=e.GetShaderMananger().GetEffect(te.ShaderManager.Edge);l.UseProgram(),o=r.GetProjection().Transpose(),n=r.GetView().ToMatrix4().Transpose(),a=i.Clone();var h=t.GetDrawColor(),u=l.GetShaderAttributeParameter(te.VSP_POSITION);l.EnableAttributeArray(u.location),l.SetUniformValue(te.VSP_MODELMAT,a),l.SetUniformValue(te.VSP_VIEWMAT,n),l.SetUniformValue(te.VSP_PROJECTIONMAT,o);for(var p=[],c=0;c<3;c++){var d=new te.Vector4(e.clipPlane[c].Clone());d=r.GetView().ToMatrix4().Inverse().Transpose().Multiply(d),p.push(d.x),p.push(d.y),p.push(d.z),p.push(d.w)}var S=new Float32Array(p);l.SetUniformValue(te.FSP_CLIPPLANE,3,S);var f=new Int32Array(e.enableClip);if(l.SetUniformValue(te.FSP_ENABLECLIP,3,f),0<t.PolyLines.length){"IE"!==SView.BrowserHelper.myBrowser()&&s.lineWidth(4);for(var m=[],y=0;y<t.PolyLines.length;y++)for(var T=t.PolyLines[y],M=0;M<T.GetPoints().length;M++)if(0!=M){if(0<M){var g=M-1,v=T.GetPoints()[g];m.push(v.x),m.push(v.y),m.push(v.z)}var C=T.GetPoints()[M];m.push(C.x),m.push(C.y),m.push(C.z)}var _=s.createBuffer();s.bindBuffer(te.GL.ARRAY_BUFFER,_),s.bufferData(te.GL.ARRAY_BUFFER,te.ArrayHelper.ConvertToFloat32Array(m),te.GL.STATIC_DRAW),l.SetUniformValue(te.FSP_DIFFUSE,h),l.EnableAttributeArray(u.location),l.SetVertexAttribPointer(u.location,3,te.GL.FLOAT,0,0),s.drawArrays(te.GL.LINES,0,m.length/3),l.DisableAttributeArray(u.location),s.deleteBuffer(_)}t.IsParallelScreen&&(a=t.OutFrameMatrix.Multiply(a),l.SetUniformValue(te.VSP_MODELMAT,a)),t.IsParallelScreen?s.disable(te.GL.DEPTH_TEST):s.enable(te.GL.DEPTH_TEST);var A=t.ComTexts;for(y=0;y<A.length;y++){var E=A[y];if(E.IsVisible()){var G=E.GetMesh(),P=G.GetDataLength()/3;if(0!=P){var w=G.GetRefMesh().UseIndex(),D=G.GetRefMesh().GetPositionArray().subarray(G.GetDataOffset(),G.GetDataOffset()+G.dataLength),x=s.createBuffer();if(s.bindBuffer(te.GL.ARRAY_BUFFER,x),s.bufferData(te.GL.ARRAY_BUFFER,D,te.GL.STATIC_DRAW),l.SetUniformValue(te.FSP_DIFFUSE,h),l.SetUniformValue(te.VSP_MODELMAT,a),l.EnableAttributeArray(u.location),l.SetVertexAttribPointer(u.location,3,te.GL.FLOAT,0,0),w){var R=te.ArrayHelper.ConvertToInt16Array(G.GetRefMesh().GetIndexArray()),I=s.createBuffer();s.bindBuffer(te.GL.ELEMENT_ARRAY_BUFFER,I),s.bufferData(te.GL.ELEMENT_ARRAY_BUFFER,R,te.GL.STATIC_DRAW),s.drawElements(te.GL.TRIANGLES,P,te.GL.UNSIGNED_SHORT,0),s.bindBuffer(te.GL.ELEMENT_ARRAY_BUFFER,null),s.deleteBuffer(I)}else s.drawArrays(te.GL.TRIANGLES,0,P);s.bindBuffer(te.GL.ARRAY_BUFFER,null),l.DisableAttributeArray(u.location),s.deleteBuffer(x)}}}}},ee.DoSection=function(e,t){var r=e.clipPlane,i=e.enableClip,n=e.GetSection();if(!n)return!1;var o=n.GetPlaneList();if(t){for(var a=0,s=0;s<o.length;++s,++a)if(o[s].GetEnable()){var l=o[s].GetEquation();r[a].x=l[0],r[a].y=l[1],r[a].z=l[2],r[a].w=l[3],(i[a]=1)==te.Parameters.Instance().clipPlaneMode&&(i[a]=0)}}else{for(a=0,s=0;s<o.length;++s,++a)i[a]=0;if(te.Parameters.Instance().showSection)for(s=0;s<o.length;++s)o[s].GetEnable()&&this.DrawSectionPlane(e,o[s])}return!!n.IsShowCappingPlane()},ee.DrawSectionPlane=function(e,t){if(t){var r=e.GetRenderContext().GetGLRenderContext(),i=e.GetCamera();if(!i)return;t.SetCurrentGLContext(r),r.enable(te.GL.DEPTH_TEST),"IE"!==SView.BrowserHelper.myBrowser()&&r.lineWidth(1),r.enable(te.GL.BLEND),r.depthMask(!1);var n,o,a=new te.Matrix4;o=i.GetProjection().Transpose(),n=i.GetView().ToMatrix4().Transpose();var s=e.GetShaderMananger().GetEffect(te.ShaderManager.Edge);s.UseProgram(),s.SetUniformValue(te.VSP_VIEWMAT,n),s.SetUniformValue(te.VSP_PROJECTIONMAT,o),s.SetUniformValue(te.VSP_MODELMAT,a);for(var l=[],h=0;h<3;h++){var u=new te.Vector4(e.clipPlane[h].Clone());u=i.GetView().ToMatrix4().Inverse().Transpose().Multiply(u),l.push(u.x),l.push(u.y),l.push(u.z),l.push(u.w)}var p=new Float32Array(l);s.SetUniformValue(te.FSP_CLIPPLANE,3,p);var c=new Int32Array(e.enableClip);s.SetUniformValue(te.FSP_ENABLECLIP,3,c);var d=s.GetShaderAttributeParameter(te.VSP_POSITION);s.EnableAttributeArray(d.location);var S=t.GetFacePositionVBO();S.Bind();var f=t.GetFaceColor();s.SetVertexAttribPointer(d.location,3,te.GL.FLOAT,0,0),s.SetUniformValue(te.FSP_DIFFUSE,f),r.drawArrays(te.GL.TRIANGLES,0,6),S.UnBind(),r.disable(te.GL.BLEND),r.depthMask(!0);var m=t.GetEdgePositionVBO();m.Bind();var y=t.GetEdgeColor();s.SetVertexAttribPointer(d.location,3,te.GL.FLOAT,0,0),s.SetUniformValue(te.FSP_DIFFUSE,y),r.drawArrays(te.GL.LINES,0,8),m.UnBind(),s.DisableAttributeArray(d.location),s.ReleaseShaderProgram()}},ee.DrawBackGround=function(e,t){var r=t.GetRenderContext().GetGLRenderContext(),i=e;i.SetCurrentGLContext(r);var n=t.GetShaderMananger();if(n){var o=n.GetEffect(te.ShaderManager.Background);if(o){var a=t.GetCamera(),s=a.GetViewPort().GetRect();1==a.cameraMode?(a.SetAspectRatio(s.Width()/2/s.Height()),r.scissor(s.left,s.top,s.Width()/2,s.Height()),r.viewport(s.left,s.top,s.Width()/2,s.Height())):2==a.cameraMode?(a.SetAspectRatio(s.Width()/2/s.Height()),r.scissor(s.left+s.Width()/2,s.top,s.Width()/2,s.Height()),r.viewport(s.left+s.Width()/2,s.top,s.Width()/2,s.Height())):(a.SetAspectRatio(s.Width()/s.Height()),r.viewport(s.left,s.top,s.Width(),s.Height()));var l=new te.Matrix4,h=new te.Matrix4,u=new te.Matrix4;if(h.Ortho(i.ProArray[0],i.ProArray[1],i.ProArray[2],i.ProArray[3],i.ProArray[4],i.ProArray[5]),l.ToIdentity(),u.ToIdentity(),r.disable(te.GL.DEPTH_TEST),r.disable(te.GL.BLEND),i.IsUseColor()||0==i.IsUseImage()&&0==i.IsUseSkyBox()){o.UseProgram();var p=o.GetShaderAttributeParameter(te.VSP_POSITION),c=o.GetShaderAttributeParameter(te.VSP_COLOR);o.EnableAttributeArray(p.location),o.EnableAttributeArray(c.location);var d=i.GetPositionVBO(),S=i.GetColorVBO();d.Bind(),o.SetVertexAttribPointer(p.location,3,te.GL.FLOAT,0,0),S.Bind(),o.SetVertexAttribPointer(c.location,4,te.GL.FLOAT,0,0);var f=h.Multiply(l);o.SetUniformValue(te.VSP_MVPMAT,f),r.drawArrays(te.GL.TRIANGLES,0,6),d.UnBind(),S.UnBind(),o.DisableAttributeArray(p.location),o.DisableAttributeArray(c.location),o.ReleaseShaderProgram()}else if(i.IsUseSkyBox()||te.Parameters.Instance().cubeMode){r.enable(te.GL.DEPTH_TEST),r.depthMask(!1),(o=n.GetEffect(te.ShaderManager.CubeMap)).UseProgram();var m=t.GetCamera();if(!(v=i.GetSkyBoxTexture())&&!(v=t.GetScene().GetResourceManager().GetDefaultCubeMap()))return;if(v)if(C=v.GetOGLObj(r)){p=o.GetShaderAttributeParameter(te.VSP_POSITION);o.EnableAttributeArray(p.location),(d=i.GetSkyBoxVertexVBO()).Bind(),o.SetVertexAttribPointer(p.location,3,te.GL.FLOAT,0,0);var y=new Int32Array([0]),T=new te.Matrix4(m.GetView().ToMatrix3()),M=new te.Camera;M.SetFov(90),M.SetNearClip(.1),M.SetFarClip(100),M.SetAspectRatio(m.GetAspectRatio()),M.SetOrthographic(!1);var g=M.GetProjection().Clone();g.TransposeED(),o.SetUniformValue(te.FSP_SAMPLERCUBE0,y),o.SetUniformValue(te.VSP_MODELMAT,u),o.SetUniformValue(te.VSP_VIEWMAT,T.Transpose()),o.SetUniformValue(te.VSP_PROJECTIONMAT,g),r.activeTexture(te.GL.TEXTURE0),r.bindTexture(te.GL.TEXTURE_CUBE_MAP,C),r.drawArrays(te.GL.TRIANGLES,0,36),r.bindTexture(te.GL.TEXTURE_CUBE_MAP,null),o.DisableAttributeArray(p.location),o.ReleaseShaderProgram()}r.depthMask(!0),r.disable(te.GL.DEPTH_TEST)}else if(i.IsUseImage()){var v,C;if((o=n.GetEffect(te.ShaderManager.Image)).UseProgram(),v=i.GetTexture(t))if(C=v.GetOGLObj(r)){var _=new te.Color(1,1,1,1),A=(p=o.GetShaderAttributeParameter(te.VSP_POSITION),o.GetShaderAttributeParameter(te.VSP_TEXCOORDS));o.EnableAttributeArray(p.location),o.EnableAttributeArray(A.location);d=i.GetBackImagePositionVBO();var E=i.GetTexCoordsVBO();d.Bind(),o.SetVertexAttribPointer(p.location,3,te.GL.FLOAT,0,0),E.Bind(),o.SetVertexAttribPointer(A.location,2,te.GL.FLOAT,0,0);y=new Int32Array([0]);o.SetUniformValue(te.FSP_SAMPLER0,y),o.SetUniformValue(te.FSP_DIFFUSE,_),o.SetUniformValue(te.VSP_MODELMAT,u),o.SetUniformValue(te.VSP_VIEWMAT,l),o.SetUniformValue(te.VSP_PROJECTIONMAT,h),r.activeTexture(te.GL.TEXTURE0),r.bindTexture(te.GL.TEXTURE_2D,C),r.drawArrays(te.GL.TRIANGLES,0,6),r.bindTexture(te.GL.TEXTURE_2D,null),o.DisableAttributeArray(p.location),o.DisableAttributeArray(A.location),o.ReleaseShaderProgram()}}if(te.Parameters.Instance().useWaterMark)if((o=n.GetEffect("BackGroundImage")).UseProgram(),r.viewport(s.left,s.top,te.Parameters.Instance().waterMarkDrawRect.x,te.Parameters.Instance().waterMarkDrawRect.y),v=i.GetWaterMarkTexture(t))if(C=v.GetOGLObj(r)){_=new te.Color(1,1,1,0),p=o.GetShaderAttributeParameter(te.VSP_POSITION),A=o.GetShaderAttributeParameter(te.VSP_TEXCOORDS);o.EnableAttributeArray(p.location),o.EnableAttributeArray(A.location);d=i.GetBackImagePositionVBO(),E=i.GetWaterMarkTexCoordsVBO();d.Bind(),o.SetVertexAttribPointer(p.location,3,te.GL.FLOAT,0,0),E.Bind(),o.SetVertexAttribPointer(A.location,2,te.GL.FLOAT,0,0);y=new Int32Array([0]);o.SetUniformValue(te.FSP_SAMPLER0,y),o.SetUniformValue(te.FSP_DIFFUSE,_),o.SetUniformValue(te.VSP_MODELMAT,u),o.SetUniformValue(te.VSP_VIEWMAT,l),o.SetUniformValue(te.VSP_PROJECTIONMAT,h),r.activeTexture(te.GL.TEXTURE0),r.bindTexture(te.GL.TEXTURE_2D,C),r.drawArrays(te.GL.TRIANGLES,0,6),o.DisableAttributeArray(p.location),o.DisableAttributeArray(A.location),o.ReleaseShaderProgram()}r.disable(te.GL.BLEND),r.enable(te.GL.DEPTH_TEST)}}},ee.ApplyCamera=function(e){var t,r,i=e.GetRenderContext(),n=e.GetCamera();if(n){var o=n.GetViewPort().rect,a=i.GetGLRenderContext();1==n.cameraMode?(n.SetAspectRatio(o.Width()/2/o.Height()),a.scissor(o.left,o.top,o.Width()/2,o.Height()),a.viewport(o.left,o.top,o.Width()/2,o.Height())):2==n.cameraMode?(n.SetAspectRatio(o.Width()/2/o.Height()),a.scissor(o.left+o.Width()/2,o.top,o.Width()/2,o.Height()),a.viewport(o.left+o.Width()/2,o.top,o.Width()/2,o.Height())):(n.SetAspectRatio(o.Width()/o.Height()),a.viewport(o.left,o.top,o.Width(),o.Height())),t=n.GetProjection().Transpose(),r=n.GetView().ToMatrix4().TransposeED(),i.SetProjectMatrix(t),i.SetViewMatrix(r)}},ee.DrawTriWithIndex=function(e,t,r,i,n){r.Bind(),e.drawElements(te.GL.TRIANGLES,i,te.GL.UNSIGNED_SHORT,n),r.UnBind()},ee.DrawTriNoIndex=function(e,t,r){e.drawArrays(te.GL.TRIANGLES,0,r)},ee.DrawPhongPass=function(e){for(var t=e.GetRenderEffect(),r=(t.GetRenderableTypeFilter(),t.GetRenderQueuePriority().GetData()),i=e.GetRenderQueueGroup(),n=0,o=r;n<o.length;n++){var a=o[n],s=i.get(a.GetRenderGroupType().GetType());if(void 0!==s){s.SetRenderTech(a);var l=s.GetType().GetType();l===te.RenderableType.RGT_SHADOW?te.Parameters.Instance().m_shadowMapEnabled&&ee.ShadowRender(e,s):l===te.RenderableType.RGT_SOLID?ee.DrawSolidRenderPassGroup(e,s):l===te.RenderableType.RGT_POINT?ee.DrawPointPassGroup(e,s):l===te.RenderableType.RGT_TRANSPARENT?ee.DrawTranRenderPassGroup(e,s):l===te.RenderableType.RGT_EDGELINE?ee.DrawEdgesRenderPassGroup(e,s):l===te.RenderableType.RGT_EDGELINEINTOP||(l===te.RenderableType.RGT_PMI?ee.DrawPMISRenderPassGroup(e,s):l===te.RenderableType.RGT_TRILINE?ee.DrawTriLineRenderPassGroup(e,s):l===te.RenderableType.RGT_NOTE?ee.DrawNoteRenderPassGroup(e,s):l===te.RenderableType.RGT_ANNOTATION?ee.DrawAnnotationRenderPassGroup(e,s):l===te.RenderableType.RGT_MEASURE||(l===te.RenderableType.RGT_HANDLER?ee.DrawHandlerRenderPassGroup(e,s):l===te.RenderableType.RGT_INTOP&&(1===te.Parameters.Instance().selectedStyle?ee.DrawOutlinePassGroup(e,s):2===te.Parameters.Instance().selectedStyle?ee.DrawINTOPRenderPassGroup(e,s):te.Parameters.Instance().selectedStyle)))}}ee.DrawImageBoardQueue(e),ee.DrawRenderActionBox(e),ee.DrawGeometry(e),ee.DrawHUBImageQueue(e),ee.DrawRenderSceneBoxNote(e)},ee.GetResourceManager=function(e){return e.GetScene().GetResourceManager()},ee.DrawINTOPRenderPassGroup1=function(e,t){if(0!==t.GetRenderableArray().length){var r=e.GetRenderContext(),i=r.GetGLRenderContext(),n=e.GetCamera(),o=n.GetViewPort().GetRect(),a=e.GetShaderMananger().GetEffect(te.ShaderManager.Outline);a.UseProgram();var s=a.GetShaderAttributeParameter(te.VSP_POSITION);a.GetShaderAttributeParameter(te.VSP_NORMAL);a.EnableAttributeArray(s.location),a.SetUniformValue(te.VSP_VIEWMAT,r.GetViewMatrix()),a.SetUniformValue(te.VSP_PROJECTIONMAT,r.GetProjectMatrix());for(var l=[],h=0;h<3;h++){var u=new te.Vector4(e.clipPlane[h].Clone());u=n.GetView().ToMatrix4().Inverse().Transpose().Multiply(u),l.push(u.x),l.push(u.y),l.push(u.z),l.push(u.w)}var p=new Float32Array(l);a.SetUniformValue(te.FSP_CLIPPLANE,3,p);var c=new Int32Array(e.enableClip);a.SetUniformValue(te.FSP_ENABLECLIP,3,c);var d=new te.Matrix4,S=t.GetRenderableArray(),f=r.GetViewMatrix(),m=new te.Matrix4,y=new te.Matrix4;i.colorMask(!1,!1,!1,!1),i.enable(te.GL.STENCIL_TEST),i.clearStencil(0),i.stencilFunc(te.GL.ALWAYS,1,1),i.stencilOp(te.GL.KEEP,te.GL.KEEP,te.GL.REPLACE),i.disable(te.GL.DEPTH_TEST);for(var T=-2;T<4;T+=4)for(var M=0,g=S;M<g.length;M++){var v=(L=g[M]).GetDataLength(),C=L.IsUseIndex(),_=L.GetHardWareVertexBuffer(),A=L.GetHardWareIndexBuffer();(d=L.GetRenderWorldMatrix()).MultiplyMat4(f,m),y=m.InverseED().TransposeED(),_.Bind();var E=L.GetVertexOffset(),G=(L.GetNormalOffset(),L.GetTextureCoordsOffset(),L.GetCentersCoordsOffset(),L.GetRenderColor());if(a.SetVertexAttribPointer(s.location,3,te.GL.FLOAT,0,E),a.SetUniformValue(te.VSP_MODELMAT,d),a.SetUniformValue(te.VSP_NORMALMAT,y),i.viewport(o.left+T,o.top,o.Width()+T,o.Height()),0<v)if(a.SetUniformValue(te.FSP_DIFFUSE,G),C){var P=L.GetIndexOffset();ee.DrawTriWithIndex(i,_,A,v,P)}else ee.DrawTriNoIndex(i,_,v)}for(T=-2;T<4;T+=4)for(var w=0,D=S;w<D.length;w++){v=(L=D[w]).GetDataLength(),C=L.IsUseIndex(),_=L.GetHardWareVertexBuffer(),A=L.GetHardWareIndexBuffer();(d=L.GetRenderWorldMatrix()).MultiplyMat4(f,m),y=m.InverseED().TransposeED(),_.Bind();E=L.GetVertexOffset(),L.GetNormalOffset(),L.GetTextureCoordsOffset(),L.GetCentersCoordsOffset(),G=L.GetRenderColor();a.SetVertexAttribPointer(s.location,3,te.GL.FLOAT,0,E),a.SetUniformValue(te.VSP_MODELMAT,d),a.SetUniformValue(te.VSP_NORMALMAT,y);for(var x=-2;x<4;x+=4)if(i.viewport(o.left,o.top+x,o.Width(),o.Height()+x),0<v)if(a.SetUniformValue(te.FSP_DIFFUSE,G),C){P=L.GetIndexOffset();ee.DrawTriWithIndex(i,_,A,v,P)}else ee.DrawTriNoIndex(i,_,v)}i.viewport(o.left,o.top,o.Width(),o.Height()),i.stencilFunc(te.GL.ALWAYS,0,0);for(var R=0,I=S;R<I.length;R++){var L;v=(L=I[R]).GetDataLength(),C=L.IsUseIndex(),_=L.GetHardWareVertexBuffer(),A=L.GetHardWareIndexBuffer();(d=L.GetRenderWorldMatrix()).MultiplyMat4(f,m),y=m.InverseED().TransposeED(),_.Bind();E=L.GetVertexOffset(),L.GetNormalOffset(),L.GetTextureCoordsOffset(),L.GetCentersCoordsOffset(),G=L.GetRenderColor();if(a.SetVertexAttribPointer(s.location,3,te.GL.FLOAT,0,E),a.SetUniformValue(te.VSP_MODELMAT,d),a.SetUniformValue(te.VSP_NORMALMAT,y),0<v)if(a.SetUniformValue(te.FSP_DIFFUSE,G),C){P=L.GetIndexOffset();ee.DrawTriWithIndex(i,_,A,v,P)}else ee.DrawTriNoIndex(i,_,v)}i.colorMask(!0,!0,!0,!0),i.stencilFunc(te.GL.EQUAL,1,1),ee.DrawQuad(e),i.enable(te.GL.DEPTH_TEST),i.disable(te.GL.STENCIL_TEST),a.DisableAttributeArray(s.location),a.ReleaseShaderProgram(),i.polygonOffset(0,0),i.disable(te.GL.POLYGON_OFFSET_FILL),i.disable(te.GL.CULL_FACE),i.enable(te.GL.DEPTH_TEST)}},ee.DrawOutlinePassGroup=function(e,t){if(0!==t.GetRenderableArray().length){var r=e.GetRenderManager().GetEffectManager(),i=r.getEffect("OUTLINEEFFECT");i.Render(t);var n=i.GetOutlineTexture(),o=e.GetRenderContext().GetGLRenderContext();o.disable(te.GL.DEPTH_TEST),o.enable(te.GL.BLEND),o.blendEquationSeparate(o.FUNC_ADD,o.FUNC_ADD),o.blendFuncSeparate(te.GL.ONE,te.GL.ONE_MINUS_SRC_ALPHA,o.ONE,o.ONE_MINUS_SRC_ALPHA);var a=e.GetCamera().GetViewPort().GetRect();o.viewport(a.left,a.top,a.right,a.bottom);a.right,a.bottom;var s=e.GetShaderMananger().GetEffect(te.ShaderManager.CombineOutline);s.UseProgram();var l=s.GetShaderAttributeParameter(te.VSP_POSITION),h=r.GetQuadVBO().vertex;o.bindBuffer(o.ARRAY_BUFFER,h),s.EnableAttributeArray(l.location),s.SetVertexAttribPointer(l.location,3,te.GL.FLOAT,0,0);var u=s.GetShaderAttributeParameter(te.VSP_TEXCOORDS),p=r.GetQuadVBO().texcoords;o.bindBuffer(o.ARRAY_BUFFER,p),s.EnableAttributeArray(u.location),s.SetVertexAttribPointer(u.location,2,te.GL.FLOAT,0,0);new te.Matrix4,new te.Matrix4,new te.Matrix4;var c=new Int32Array([0]);s.SetUniformValue(te.FSP_SAMPLER0,c),o.activeTexture(o.TEXTURE0),n&&o.bindTexture(o.TEXTURE_2D,n.GetOGLObj(o)),o.drawArrays(te.GL.TRIANGLE_STRIP,0,4),o.activeTexture(te.GL.TEXTURE0),o.bindTexture(o.TEXTURE_2D,null),s.DisableAttributeArray(l.location),s.DisableAttributeArray(u.location),s.ReleaseShaderProgram(),o.bindBuffer(te.GL.ARRAY_BUFFER,null),o.disable(te.GL.BLEND),o.blendEquationSeparate(o.FUNC_ADD,o.FUNC_ADD),o.blendFuncSeparate(o.SRC_ALPHA,o.ONE_MINUS_SRC_ALPHA,o.ONE,o.ONE_MINUS_SRC_ALPHA),o.enable(te.GL.DEPTH_TEST)}},ee.DrawINTOPRenderPassGroup=function(e,t){if(0!==t.GetRenderableArray().length){var r=e.GetRenderContext(),i=r.GetGLRenderContext(),n=e.GetCamera(),o=(n.GetViewPort().GetRect(),e.GetShaderMananger().GetEffect(te.ShaderManager.Edge));o.UseProgram();var a=o.GetShaderAttributeParameter(te.VSP_POSITION);o.EnableAttributeArray(a.location),o.SetUniformValue(te.VSP_VIEWMAT,r.GetViewMatrix()),o.SetUniformValue(te.VSP_PROJECTIONMAT,r.GetProjectMatrix());for(var s=[],l=0;l<3;l++){var h=new te.Vector4(e.clipPlane[l].Clone());h=n.GetView().ToMatrix4().Inverse().Transpose().Multiply(h),s.push(h.x),s.push(h.y),s.push(h.z),s.push(h.w)}var u=new Float32Array(s);o.SetUniformValue(te.FSP_CLIPPLANE,3,u);var p=new Int32Array(e.enableClip);o.SetUniformValue(te.FSP_ENABLECLIP,3,p);var c=new te.Matrix4,d=t.GetRenderableArray(),S=r.GetViewMatrix(),f=new te.Matrix4;new te.Matrix4;i.disable(te.GL.DEPTH_TEST),i.depthFunc(te.GL.LEQUAL),i.enable(i.BLEND);for(var m=0,y=d;m<y.length;m++){var T=y[m],M=T.GetDataLength(),g=T.IsUseIndex(),v=T.GetHardWareVertexBuffer(),C=T.GetHardWareIndexBuffer();(c=T.GetRenderWorldMatrix()).MultiplyMat4(S,f),f.InverseED().TransposeED(),v.Bind();var _=T.GetVertexOffset(),A=T.GetRenderColor();o.SetVertexAttribPointer(a.location,3,te.GL.FLOAT,0,_),o.SetUniformValue(te.VSP_MODELMAT,c);var E=new te.Color(A.r,A.g,A.b,.3);if(0<M)if(o.SetUniformValue(te.FSP_DIFFUSE,E),g){var G=T.GetIndexOffset();ee.DrawTriWithIndex(i,v,C,M,G)}else ee.DrawTriNoIndex(i,v,M)}o.DisableAttributeArray(a.location),o.ReleaseShaderProgram(),i.enable(te.GL.DEPTH_TEST),i.disable(i.BLEND)}},ee.RenderFaces=function(e,t,r){if(0!=t.GetRenderableArray().length){ee.m_currentCamera=null,ee.m_currentMaterial=null;var i=e.GetRenderContext().GetGLRenderContext(),n=(e.GetScene().GetResourceManager(),e.GetScene().GetLightManager()),o=e.GetCamera();n.SetUp(o);for(var a=t.GetRenderableArray(),s=0;s<a.length;s++){var l=a[s];this.RenderFace(e,l,o,null)}i.disableVertexAttribArray(0),i.disableVertexAttribArray(1),i.disableVertexAttribArray(2),ee.m_shadowState=te.Parameters.Instance().m_shadowMapEnabled}},ee.SetProgram=function(e,t,r,i,n){ee._usedTextureUnits=0;var o=e.GetScene().GetLightManager(),a=!1,s=!1,l=!1,h=n;h.NeedUpdate()||(h.GetProgram()?h.AcceptLight()&&h.LightHash()!==o.GetState().hash&&h.SetNeedUpdate(!0):h.SetNeedUpdate(!0)),ee.m_shadowState!=te.Parameters.Instance().m_shadowMapEnabled&&h.SetNeedUpdate(!0),h.NeedUpdate()&&(this.InitMaterial(e,h,e.GetShaderMananger()),h.SetNeedUpdate(!1),a=!0);var u=null;(u=h.GetProgram())&&u.UseProgram();var p=te.UniformHelper.GetUniformListMaps(u.GetName());e.GetRenderContext();if(ee.m_currentProgram!=u&&(a=l=s=!0,ee.m_currentProgram=u),h!=ee.m_currentMaterial&&(l=!0,ee.m_currentMaterial=h),s||i!=ee.m_currentCamera){var c=i.GetView().ToMatrix4().Transpose(),d=i.GetProjection().Transpose();u.SetUniformValue(te.VIEW_MATRXI,c),u.SetUniformValue(te.PROJECTION_MATRXI,d);for(var S=[],f=0;f<3;f++){var m=e.clipPlane[f].Clone();m=c.Clone().Inverse().Multiply(m),S.push(m.x),S.push(m.y),S.push(m.z),S.push(m.w)}var y=new Float32Array(S),T=new Int32Array(e.enableClip);u.SetUniformValue(te.FSP_CLIPPLANE,3,y),u.SetUniformValue(te.FSP_ENABLECLIP,3,T);var M=u.GetShaderUniformParameter(te.FSP_REVERSECLIP);if(M&&u.SetUniformValue(te.FSP_REVERSECLIP,M.location,e.m_bReverseClip?1:0),ee.m_currentCamera=i,a=l=!0,h.GetMaterialType()==te.MaterialType.MaterialType_Shader||h.GetMaterialType()==te.MaterialType.MaterialType_Phong||h.GetMaterialType()==te.MaterialType.MaterialType_Pbr||h.GetMaterialType()==te.MaterialType.MaterialType_MatCap){var g=i.GetPosition();u.SetUniformValue(te.CAMERA_POSITION,g)}}if(l){var v=t;if(h.GetUseLight()&&a){var C=o.GetAllLight(),_=o.GetState(),A=0,E=0,G=0,P=0;if(u.SetUniformValue(te.AMBIENT_LIGHT_COLOR,_.ambient),te.Parameters.Instance().m_shadowMapEnabled){if(void 0!==p.directionalShadowMap&&null!==p.directionalShadowMap){var w=p.directionalShadowMap.value;w=[],te.UniformHelper.SetUniformValueToMap(p,"directionalShadowMap","Texture2DArray",w)}if(void 0!==p.directionalShadowMatrix&&null!==p.directionalShadowMatrix){w=p.directionalShadowMatrix.value;w=[],te.UniformHelper.SetUniformValueToMap(p,"directionalShadowMatrix","Matrix4Array",w)}}for(var D=0,x=C.length;D<x;D++){var R=C[D];if(R.IsTurnOn()){var I=R.GetLightSourceType();R.GetIntensity(),R.GetLightColor();if(I==te.LightType.LightType_Directional){var L=R.GetLightShadow(),N=_.directional[A],O="directionalLights["+A.toString()+"]";if(u.SetUniformValue(O+".color",N.color),u.SetUniformValue(O+".direction",N.direction),u.SetUniformValue(O+".shadow",0!==N.shadow),R.CastShadow()&&te.Parameters.Instance().m_shadowMapEnabled){if(u.SetUniformValue(O+".shadowBias",N.shadowBias),u.SetUniformValue(O+".shadowRadius",N.shadowRadius),u.SetUniformValue(O+".shadowMapSize",N.shadowMapSize),void 0===p.directionalShadowMap||null===p.directionalShadowMap){w=[];L.RenderTarget()&&w.push(L.RenderTarget().GetColorTarget(0)),te.UniformHelper.SetUniformValueToMap(p,"directionalShadowMap","Texture2DArray",w)}else{w=p.directionalShadowMap.value;L.RenderTarget()&&w.push(L.RenderTarget().GetColorTarget(0)),te.UniformHelper.SetUniformValueToMap(p,"directionalShadowMap","Texture2DArray",w)}if(void 0===p.directionalShadowMatrix||null===p.directionalShadowMatrix){w=[];L.Matrix()&&w.push(L.Matrix().Transpose()),te.UniformHelper.SetUniformValueToMap(p,"directionalShadowMatrix","Matrix4Array",w)}else{w=p.directionalShadowMatrix.value;L.Matrix()&&w.push(L.Matrix().Transpose()),te.UniformHelper.SetUniformValueToMap(p,"directionalShadowMatrix","Matrix4Array",w)}}R.SetNeedUpdateInfo(!1),A++}else if(I==te.LightType.LightType_Point){var b=_.point[E];O="pointLights["+E.toString()+"]";u.SetUniformValue(O+".color",b.color),u.SetUniformValue(O+".position",b.position),u.SetUniformValue(O+".distance",b.distance),u.SetUniformValue(O+".decay",b.decay),u.SetUniformValue(O+".shadow",0!==b.shadow),R.SetNeedUpdateInfo(!1),E++}else if(I==te.LightType.LightType_Spot){var V=_.spot[G];O="spotLights["+G.toString()+"]";u.SetUniformValue(O+".color",V.color),u.SetUniformValue(O+".position",V.position),u.SetUniformValue(O+".direction",V.direction),u.SetUniformValue(O+".distance",V.distance),u.SetUniformValue(O+".decay",V.decay),u.SetUniformValue(O+".coneCos",V.coneCos),u.SetUniformValue(O+".penumbraCos",V.penumbraCos),u.SetUniformValue(O+".shadow",0!==V.shadow),R.SetNeedUpdateInfo(!1),G++}else if(I==te.LightType.LightType_Hemisphere){var F=_.hemisphere[P];O="hemisphereLights["+P.toString()+"]";u.SetUniformValue(O+".skyColor",F.skyColor),u.SetUniformValue(O+".groundColor",F.groundColor),u.SetUniformValue(O+".direction",F.direction),R.SetNeedUpdateInfo(!1),P++}}}}if(h.GetMaterialType()==te.MaterialType.MaterialType_Phong||h.GetMaterialType()==te.MaterialType.MaterialType_Pbr){var B=h.GetUvTransform().Transpose();u.SetUniformValue(te.UV_TRANSFORM_MATRIX,B)}h.GetMaterialType()==te.MaterialType.MaterialType_Phong?ee.RefreshUniformsPhong(e,p,h):h.GetMaterialType()==te.MaterialType.MaterialType_Pbr?ee.RefreshUniformsPbr(e,p,h):h.GetMaterialType()==te.MaterialType.MaterialType_MatCap&&ee.RefreshUniformsMatCap(e,p,h),te.Parameters.Instance().m_useSSAO,h.GetProgram().SetUniformValue(te.OPACITY,v.GetColorAlpha()),te.UniformHelper.UpdateUniform(e,r,u,u.GetShaderUniformMap(),p)}var U=t.GetRenderWorldMatrix().Clone(),H=U.Multiply(i.GetView().ToMatrix4().Transpose()).Inverse().Transpose();u.SetUniformValue(te.MODEL_MATRXI,U),u.SetUniformValue(te.NORMAL_MATRXI,H);var k=t.GetAlpha(),z=new te.Color(1,1,1,k),W=t;return!te.Parameters.Instance().IsShowBox&&W.IsSelected()&&1!==te.Parameters.Instance().selectedStyle&&(z=new te.Color(te.Color.SelectColor().r,te.Color.SelectColor().g,te.Color.SelectColor().b,k)),u.SetUniformValue(te.FSP_SELECTCOLOR,z),u},ee.InitMaterial=function(e,t,r){e.GetScene().GetResourceManager(),e.GetRenderContext().GetGLRenderContext();var i=e.GetScene().GetLightManager();r.CreateParameters(t,i);var n=r.GetProgramCode(t),o=t.GetProgram(),a=!0;o&&(o.GetName()!=n?t.SetProgram(null):a=!1);var s="",l="",h="";if(a){if(t.GetMaterialType()==te.MaterialType.MaterialType_Shader){var u=t;l=u.VertexShader(),h=u.FragmentShader()}else s=t.GetMaterialType()==te.MaterialType.MaterialType_Phong?"PhongMaterial":t.GetMaterialType()==te.MaterialType.MaterialType_Pbr?"PbrMaterial":t.GetMaterialType()==te.MaterialType.MaterialType_MatCap?"MatCapMaterial":t.GetMaterialType()==te.MaterialType.MaterialType_Depth?"DepthMaterial":null,l=te.ShaderLib[s].VertexShader,h=te.ShaderLib[s].FragmentShader;t.SetLightHash(i.GetState().hash),o=r.AcquireProgram(t,l,h,n),t.SetProgram(o)}},ee.RefreshUniformsMatCap=function(e,t,r){r&&t&&(r.GetProgram().SetUniformValue(te.DIFFUSE,r.GetDiffuse()),r.GetProgram().SetUniformValue(te.SPECULAR,r.GetSpecular()),r.GetProgram().SetUniformValue(te.EMISSIVE,r.GetEmissive()),r.GetProgram().SetUniformValue(te.SHININESS,r.GetShininess()),r.GetProgram().SetUniformValue(te.OPACITY,r.GetOpacity()),r.GetNormalMap()&&(te.UniformHelper.SetUniformValueToMap(t,te.NORMAL_MAP,"Texture2D",r.GetNormalMap()),te.UniformHelper.SetUniformValueToMap(t,te.NORMAL_MAP_SCALE,"Vector2",r.GetNormalMapScale())),r.GetMatcapMap()&&te.UniformHelper.SetUniformValueToMap(t,te.MATCAP_MAP,"Texture2D",r.GetMatcapMap()))},ee.RefreshUniformsPhong=function(e,t,r){r&&t&&(r.GetProgram().SetUniformValue(te.DIFFUSE,r.GetDiffuse()),r.GetProgram().SetUniformValue(te.SPECULAR,r.GetSpecular()),r.GetProgram().SetUniformValue(te.EMISSIVE,r.GetEmissive()),r.GetProgram().SetUniformValue(te.SHININESS,r.GetShininess()),r.GetProgram().SetUniformValue(te.OPACITY,r.GetOpacity()),r.GetEmissiveMap()&&te.UniformHelper.SetUniformValueToMap(t,te.EMISSIVE_MAP,"Texture2D",r.GetEmissiveMap()),r.GetDiffuseMap()&&te.UniformHelper.SetUniformValueToMap(t,te.DIFFUSE_TEXTURE,"Texture2D",r.GetDiffuseMap()),r.GetSpecularMap()&&te.UniformHelper.SetUniformValueToMap(t,te.SPECULAR_MAP,"Texture2D",r.GetSpecularMap()),r.GetNormalMap()&&(te.UniformHelper.SetUniformValueToMap(t,te.NORMAL_MAP,"Texture2D",r.GetNormalMap()),te.UniformHelper.SetUniformValueToMap(t,te.NORMAL_MAP_SCALE,"Vector2",r.GetNormalMapScale())),r.GetMatcapMap()&&te.UniformHelper.SetUniformValueToMap(t,te.MATCAP_MAP,"Texture2D",r.GetMatcapMap()),r.GetDisplacementMap()&&(te.UniformHelper.SetUniformValueToMap(t,te.DISPLACEMENT_MAP,"Texture2D",r.GetDisplacementMap()),te.UniformHelper.SetUniformValueToMap(t,te.DISPLACEMENT_SCALE,"Float",r.GetDisplacementScale()),te.UniformHelper.SetUniformValueToMap(t,te.DISPLACEMENT_BIAS,"Float",r.GetDisplacementBias())))},ee.RefreshUniformsPbr=function(e,t,r){var i=e.GetScene().GetResourceManager();if(r&&t){var n=e.GetScene().GetSceneBox(),o=n.Center(),a=(n.min,n.max,n.Length()),s=new te.Vector3(a/2,a/2,a/2),l=o.Sub(s),h=o.Add(s);if(r.GetProgram().SetUniformValue("cubeMapWorldPosition",o),r.GetProgram().SetUniformValue("boxMin",l),r.GetProgram().SetUniformValue("boxMax",h),r.GetProgram().SetUniformValue(te.DIFFUSE,r.AlbedoColor()),r.GetProgram().SetUniformValue(te.EMISSIVE,r.EmissiveColor()),r.GetProgram().SetUniformValue(te.ROUGHNESS,r.RougthnessFactor()),r.GetProgram().SetUniformValue(te.METALNESS,r.MetalnessFactor()),r.GetProgram().SetUniformValue(te.GAMMA,te.Parameters.Instance().m_gammaFactor),r.GetProgram().SetUniformValue(te.TONE_MAPPING_EXPOSURE,te.Parameters.Instance().m_toneMappingExposure),r.GetProgram().SetUniformValue(te.OPACITY,r.Opacity()),r.UseClearCoat()&&(r.GetProgram().SetUniformValue(te.CLEARCOAT,r.ClearCoat()),r.GetProgram().SetUniformValue(te.CLEARCOATROUGHNESS,r.ClearCoatRoughness())),r.AlbedoMap()&&te.UniformHelper.SetUniformValueToMap(t,te.DIFFUSE_TEXTURE,"Texture2D",r.AlbedoMap()),r.EnvMap())te.UniformHelper.SetUniformValueToMap(t,te.ENV_TEXTURE,"TextureCube",r.EnvMap()),te.UniformHelper.SetUniformValueToMap(t,te.ENV_MAP_INTENSITY,"Float",r.EnvMapIntensity());else{var u=i.GetDefaultPBRSpecularTexture();r.SetEnvMap(u),te.UniformHelper.SetUniformValueToMap(t,te.ENV_TEXTURE,"TextureCube",u),te.UniformHelper.SetUniformValueToMap(t,te.ENV_MAP_INTENSITY,"Float",r.EnvMapIntensity())}if(r.EnvIrradianceMap())te.UniformHelper.SetUniformValueToMap(t,te.ENV_DIFFUSE_TEXTURE,"TextureCube",r.EnvIrradianceMap());else{u=i.GetDefaultPBRDiffuseTexture();r.SetEnvIrradianceMap(u),te.UniformHelper.SetUniformValueToMap(t,te.ENV_DIFFUSE_TEXTURE,"TextureCube",u)}r.EmissiveMap()&&te.UniformHelper.SetUniformValueToMap(t,te.EMISSIVE_MAP,"Texture2D",r.EmissiveMap()),r.AmbientOcclusiontMap()&&(r.GetProgram().SetUniformValue(te.AO_MAP_INTENSITY,r.AoMapIntensity()),te.UniformHelper.SetUniformValueToMap(t,te.AO_MAP,"Texture2D",r.AmbientOcclusiontMap())),r.NormalMap()&&(te.UniformHelper.SetUniformValueToMap(t,te.NORMAL_MAP,"Texture2D",r.NormalMap()),te.UniformHelper.SetUniformValueToMap(t,te.NORMAL_MAP_SCALE,"Vector2",r.NormalMapScale())),r.DisplacementMap()&&(te.UniformHelper.SetUniformValueToMap(t,te.DISPLACEMENT_MAP,"Texture2D",r.DisplacementMap()),te.UniformHelper.SetUniformValueToMap(t,te.DISPLACEMENT_SCALE,"Float",r.DisplacementScale()),te.UniformHelper.SetUniformValueToMap(t,te.DISPLACEMENT_BIAS,"Float",r.DisplacementBias())),r.MetalnessRoughnessMap()&&te.UniformHelper.SetUniformValueToMap(t,te.METALLIC_ROUGHNESS_TEXTURE,"Texture2D",r.MetalnessRoughnessMap()),te.UniformHelper.SetUniformValueToMap(t,te.LUT,"Texture2D",i.GetDefaultPBRLUTTexture())}},ee.RenderFace=function(e,t,r,i){var n=e.GetRenderContext().GetGLRenderContext(),o=null==i?t.GetMaterial():i,a=e.GetScene().GetResourceManager().GetMaterial(te.M3D_GLOBLE_MATERIAL);if(null!=a&&null!=a){var s=a.GetiSpecular(),l=new te.Color;o.GetMaterialType()==te.MaterialType.MaterialType_Phong?l=o.GetDiffuse():o.GetMaterialType()==te.MaterialType.MaterialType_Pbr?l=o.AlbedoColor():o.GetMaterialType()==te.MaterialType.MaterialType_MatCap&&(l=o.GetDiffuse()),0<=l.r&&0<=l.g&&0<=l.b&&0<=l.a&&a.SetDiffuse(l),a.SetSpecular(l.Multiply(s/255)),o=a,ee.m_currentMaterial=null}var h={},u=this.SetProgram(e,t,h,r,o),p=u.GetShaderAttributeParameter(te.VSP_POSITION),c=u.GetShaderAttributeParameter(te.VSP_NORMAL),d=u.GetShaderAttributeParameter(te.VSP_TEXCOORDS);u.EnableAttributeArray(p.location),c&&u.EnableAttributeArray(c.location),d&&u.EnableAttributeArray(d.location);var S=t.GetDataLength(),f=t.IsUseIndex(),m=t.GetHardWareVertexBuffer(),y=t.GetHardWareIndexBuffer();m.Bind();var T=t.GetVertexOffset(),M=t.GetNormalOffset(),g=t.GetTextureCoordsOffset();if(!g&&d&&u.DisableAttributeArray(d.location),u.SetVertexAttribPointer(p.location,3,te.GL.FLOAT,0,T),c&&u.SetVertexAttribPointer(c.location,3,te.GL.FLOAT,0,M),d&&g&&u.SetVertexAttribPointer(d.location,3,te.GL.FLOAT,0,g),f){var v=t.GetIndexOffset();ee.DrawTriWithIndex(n,m,y,S,v)}else ee.DrawTriNoIndex(n,m,S);if(m.UnBind(),o!=ee.m_currentMaterial)for(var C in h){var _=h[C];n.activeTexture(te.GL.TEXTURE0+parseInt(C)),n.bindTexture(_,null)}},ee.DrawPhongPassGroup=function(e,t){if(0!==t.GetRenderableArray().length){var r=e.GetRenderContext(),i=r.GetGLRenderContext(),n=e.GetCamera(),o=e.GetShaderMananger().GetEffect(te.ShaderManager.MeshPhong);o.UseProgram();var a=o.GetShaderAttributeParameter(te.VSP_POSITION),s=o.GetShaderAttributeParameter(te.VSP_NORMAL),l=o.GetShaderAttributeParameter(te.VSP_TEXCOORDS),h=o.GetShaderAttributeParameter(te.VSP_CENTER);o.EnableAttributeArray(a.location),o.EnableAttributeArray(s.location),o.EnableAttributeArray(l.location),te.Parameters.Instance().IsShowTrilateralEdge?(o.EnableAttributeArray(h.location),o.SetUniformValue(te.FSP_ENABLE_WRIEFRAME,new Int32Array([1]))):te.Parameters.Instance().IsOnlyShowTrilateralEdge&&(o.EnableAttributeArray(h.location),o.SetUniformValue(te.FSP_ENABLE_ONLY_WRIEFRAME,new Int32Array([1]))),o.SetUniformValue(te.VSP_VIEWMAT,r.GetViewMatrix()),o.SetUniformValue(te.VSP_PROJECTIONMAT,r.GetProjectMatrix());var u=n.GetWorldPosition();o.SetUniformValue(te.VSP_EYEPOSITION,u);var p=new te.Vector4(.1,.1,.1,1),c=new te.Vector4(.7,.7,.7,1),d=new Float32Array([10]),S=new te.Color(1,1,1,1);o.SetUniformValue("u_lights.ambient",new te.Color(1,1,1,1)),o.SetUniformValue("u_lights.diffuse",new te.Color(1,1,1,1)),o.SetUniformValue("u_lights.specular",new te.Color(.5,.5,.5,1));for(var f=[],m=0;m<3;m++){var y=e.clipPlane[m].Clone();y=r.GetViewMatrix().Inverse().Multiply(y),f.push(y.x),f.push(y.y),f.push(y.z),f.push(y.w)}var T=new Float32Array(f);o.SetUniformValue(te.FSP_CLIPPLANE,3,T);var M=new Int32Array(e.enableClip);o.SetUniformValue(te.FSP_ENABLECLIP,3,M);var g=new te.Matrix4,v=t.GetRenderableArray();o.SetUniformValue(te.VSP_LIGHTPOSITION,new te.Vector3(0,0,1));for(var C=r.GetViewMatrix(),_=new te.Matrix4,A=new te.Matrix4,E=new Int32Array([0]),G=new Int32Array([0]),P=new Int32Array([0]),w=new Int32Array([1]),D=new Int32Array([0]),x=new Int32Array([2]),R=0,I=v;R<I.length;R++){var L=I[R];S=te.Color.WHITE();var N=L.GetDataLength(),O=L.IsUseIndex(),b=L.GetHardWareVertexBuffer(),V=L.GetHardWareIndexBuffer();if((g=L.GetRenderWorldMatrix()).MultiplyMat4(C,_),A=_.InverseED().TransposeED(),b){b.Bind();var F=L.GetVertexOffset(),B=L.GetNormalOffset(),U=L.GetTextureCoordsOffset(),H=L.GetCentersCoordsOffset(),k=L.GetRenderColor();if(o.SetVertexAttribPointer(a.location,3,te.GL.FLOAT,0,F),o.SetVertexAttribPointer(s.location,3,te.GL.FLOAT,0,B),o.SetVertexAttribPointer(l.location,2,te.GL.FLOAT,0,U),(te.Parameters.Instance().IsShowTrilateralEdge||te.Parameters.Instance().IsOnlyShowTrilateralEdge)&&o.SetVertexAttribPointer(h.location,3,te.GL.FLOAT,0,H),o.SetUniformValue(te.VSP_MODELMAT,g),o.SetUniformValue(te.VSP_NORMALMAT,A),o.SetUniformValue(te.VSP_TEXTUREMAT,te.Matrix4.IDENTITY()),0<N){var z=this.GetResourceManager(e).GetDeffaultTextureObj();P=new Int32Array([1]),i.activeTexture(i.TEXTURE1),i.bindTexture(i.TEXTURE_2D,z),o.SetUniformValue(te.FSP_USEAMBIENTTEX,P),o.SetUniformValue(te.FSP_SAMPLER1,w);var W=this.GetResourceManager(e).GetDefaultCubeMap();i.activeTexture(te.GL.TEXTURE2),i.bindTexture(te.GL.TEXTURE_CUBE_MAP,W),D=new Int32Array([1]),o.SetUniformValue(te.FSP_USECUBEMAPTEX,D),o.SetUniformValue(te.FSP_SAMPLERCUBE0,x);var Y=L.GetRenderMaterial();if(Y){var X=Y.GetAmbientMap(),j=null;if(X&&(j=X.GetOGLObj(i)),!j){Y.GetDiffuseMap();j=this.GetResourceManager(e).GetDeffaultTextureObj()}if(j&&(i.activeTexture(i.TEXTURE1),i.bindTexture(i.TEXTURE_2D,j),P=new Int32Array([1]),o.SetUniformValue(te.FSP_USEAMBIENTTEX,P),o.SetUniformValue(te.FSP_SAMPLER1,w)),600==te.Parameters.Instance().LightingMode){var K=new te.Color(1,0,0,k.a);o.SetUniformValue(te.FSP_MATERIAL_DIFFUSE,K)}var q=new te.Color(1,1,1,1);if(k==te.Color.SelectColor().Clone()&&(q=k),o.SetUniformValue(te.FSP_SELECTCOLOR,q),400==te.Parameters.Instance().LightingMode||Y.GetReflectiveTextureTexture()){var Q=null;(Q=Y.GetReflectiveTextureTexture()?Y.GetReflectiveTextureTexture().GetOGLObj(i):this.GetResourceManager(e).GetDefaultCubeMap())&&(i.activeTexture(te.GL.TEXTURE2),i.bindTexture(te.GL.TEXTURE_CUBE_MAP,Q),D=new Int32Array([1]),o.SetUniformValue(te.FSP_USECUBEMAPTEX,D),o.SetUniformValue(te.FSP_SAMPLERCUBE0,x))}var Z=Y.GetDiffuseMap();if(Z&&Z.GetName()!==te.DEFAULT_TEXTURE_PATH){if(o.EnableAttributeArray(l.location),$=Z.GetOGLObj(i)){if(E=new Int32Array([1]),o.SetUniformValue(te.FSP_USEDIFFUSETEX,E),o.SetUniformValue(te.FSP_SAMPLER0,G),k.Equals(te.Color.SelectColor())&&(q=k.Clone()),o.SetUniformValue(te.FSP_MATERIAL_DIFFUSE,te.Color.WHITE()),o.SetUniformValue(te.FSP_DIFFUSE,k),o.SetUniformValue(te.FSP_SELECTCOLOR,q),o.SetUniformValue(te.FSP_MATERIAL_AMBIENT,Y.GetAmbient()),o.SetUniformValue(te.FSP_MATERIAL_SPECULAR,Y.GetSpecular()),o.SetUniformValue(te.FSP_MATERIAL_SHININESS,d),i.activeTexture(te.GL.TEXTURE0),i.bindTexture(te.GL.TEXTURE_2D,$),O){var J=L.GetIndexOffset();ee.DrawTriWithIndex(i,b,V,N,J)}else ee.DrawTriNoIndex(i,b,N);i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,null),i.activeTexture(i.TEXTURE1),i.bindTexture(i.TEXTURE_2D,null),i.activeTexture(i.TEXTURE2),i.bindTexture(i.TEXTURE_CUBE_MAP,null)}}else{o.DisableAttributeArray(l.location),k.Equals(te.Color.SelectColor())?(q=k.Clone(),o.SetUniformValue(te.FSP_MATERIAL_DIFFUSE,k)):o.SetUniformValue(te.FSP_MATERIAL_DIFFUSE,Y.GetDiffuse()),o.SetUniformValue(te.FSP_DIFFUSE,k),o.SetUniformValue(te.FSP_SELECTCOLOR,q),o.SetUniformValue(te.FSP_MATERIAL_AMBIENT,Y.GetAmbient()),o.SetUniformValue(te.FSP_MATERIAL_SPECULAR,Y.GetSpecular()),o.SetUniformValue(te.FSP_MATERIAL_SHININESS,d),this.GetResourceManager(e).CreateDeffaultTextureObj();var $=this.GetResourceManager(e).GetDeffaultTextureObj();if(E=new Int32Array([1]),o.SetUniformValue(te.FSP_USEDIFFUSETEX,E),o.SetUniformValue(te.FSP_SAMPLER0,G),i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,$),i.activeTexture(i.TEXTURE1),i.bindTexture(i.TEXTURE_2D,j),O){J=L.GetIndexOffset();ee.DrawTriWithIndex(i,b,V,N,J)}else ee.DrawTriNoIndex(i,b,N);i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,null),i.activeTexture(i.TEXTURE1),i.bindTexture(i.TEXTURE_2D,null),i.activeTexture(i.TEXTURE2),i.bindTexture(i.TEXTURE_CUBE_MAP,null)}}else{o.DisableAttributeArray(l.location),k.Equals(te.Color.SelectColor())&&(S=k.Clone()),o.SetUniformValue(te.FSP_MATERIAL_DIFFUSE,k),o.SetUniformValue(te.FSP_DIFFUSE,k),o.SetUniformValue(te.FSP_SELECTCOLOR,S),o.SetUniformValue(te.FSP_MATERIAL_AMBIENT,p),o.SetUniformValue(te.FSP_MATERIAL_SPECULAR,c),o.SetUniformValue(te.FSP_MATERIAL_SHININESS,d);$=this.GetResourceManager(e).GetDeffaultTextureObj();E=new Int32Array([1]),o.SetUniformValue(te.FSP_USEDIFFUSETEX,E),o.SetUniformValue(te.FSP_SAMPLER0,G),P=new Int32Array([1]),o.SetUniformValue(te.FSP_USEAMBIENTTEX,P),o.SetUniformValue(te.FSP_SAMPLER1,w);Q=this.GetResourceManager(e).GetDefaultCubeMap();if(D=new Int32Array([1]),o.SetUniformValue(te.FSP_USECUBEMAPTEX,D),o.SetUniformValue(te.FSP_SAMPLERCUBE0,x),i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,$),i.activeTexture(i.TEXTURE1),i.bindTexture(i.TEXTURE_2D,$),i.activeTexture(te.GL.TEXTURE2),i.bindTexture(te.GL.TEXTURE_CUBE_MAP,Q),O){J=L.GetIndexOffset();ee.DrawTriWithIndex(i,b,V,N,J)}else ee.DrawTriNoIndex(i,b,N);i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,null),i.activeTexture(i.TEXTURE1),i.bindTexture(i.TEXTURE_2D,null),i.activeTexture(i.TEXTURE2),i.bindTexture(i.TEXTURE_CUBE_MAP,null)}i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,null),i.activeTexture(i.TEXTURE1),i.bindTexture(i.TEXTURE_2D,null),i.activeTexture(i.TEXTURE2),i.bindTexture(i.TEXTURE_CUBE_MAP,null)}b.UnBind()}else;}o.DisableAttributeArray(a.location),o.DisableAttributeArray(s.location),o.DisableAttributeArray(l.location),(te.Parameters.Instance().IsShowTrilateralEdge||te.Parameters.Instance().IsOnlyShowTrilateralEdge)&&(o.DisableAttributeArray(h.location),o.SetUniformValue(te.FSP_ENABLE_WRIEFRAME,new Int32Array([0])),o.SetUniformValue(te.FSP_ENABLE_ONLY_WRIEFRAME,new Int32Array([0]))),o.ReleaseShaderProgram()}},ee.DrawPhongPassSampleGroup=function(e,t){if(0!==t.GetRenderableArray().length){var r=e.GetRenderContext(),i=r.GetGLRenderContext(),n=(e.GetCamera(),e.GetShaderMananger().GetEffect(te.ShaderManager.Base));n.UseProgram();var o=n.GetShaderAttributeParameter(te.VSP_POSITION),a=n.GetShaderAttributeParameter(te.VSP_NORMAL),s=n.GetShaderAttributeParameter(te.VSP_CENTER);n.EnableAttributeArray(o.location),n.EnableAttributeArray(a.location),te.Parameters.Instance().IsShowTrilateralEdge?(n.EnableAttributeArray(s.location),n.SetUniformValue(te.FSP_ENABLE_WRIEFRAME,new Int32Array([1]))):te.Parameters.Instance().IsOnlyShowTrilateralEdge&&(n.EnableAttributeArray(s.location),n.SetUniformValue(te.FSP_ENABLE_ONLY_WRIEFRAME,new Int32Array([1]))),n.SetUniformValue(te.VSP_VIEWMAT,r.GetViewMatrix()),n.SetUniformValue(te.VSP_PROJECTIONMAT,r.GetProjectMatrix());for(var l=[],h=0;h<3;h++){var u=e.clipPlane[h].Clone();u=r.GetViewMatrix().Inverse().Multiply(u),l.push(u.x),l.push(u.y),l.push(u.z),l.push(u.w)}var p=new Float32Array(l);n.SetUniformValue(te.FSP_CLIPPLANE,3,p);var c=new Int32Array(e.enableClip);n.SetUniformValue(te.FSP_ENABLECLIP,3,c);var d=new te.Matrix4,S=t.GetRenderableArray(),f=new te.Vector4(.1,.1,.1,1),m=new te.Vector4(.7,.7,.7,1),y=new Float32Array([10]);new te.Color(1,1,1,1);n.SetUniformValue(te.VSP_LIGHTPOSITION,new te.Vector3(0,0,1));for(var T=r.GetViewMatrix(),M=new te.Matrix4,g=new te.Matrix4,v=0,C=S;v<C.length;v++){var _=C[v],A=_.GetDataLength(),E=_.IsUseIndex(),G=_.GetHardWareVertexBuffer(),P=_.GetHardWareIndexBuffer();(d=_.GetRenderWorldMatrix()).MultiplyMat4(T,M),g=M.InverseED().TransposeED(),G.Bind();var w=_.GetVertexOffset(),D=_.GetNormalOffset(),x=(_.GetTextureCoordsOffset(),_.GetCentersCoordsOffset()),R=_.GetRenderColor();if(n.SetVertexAttribPointer(o.location,3,te.GL.FLOAT,0,w),n.SetVertexAttribPointer(a.location,3,te.GL.FLOAT,0,D),(te.Parameters.Instance().IsShowTrilateralEdge||te.Parameters.Instance().IsOnlyShowTrilateralEdge)&&n.SetVertexAttribPointer(s.location,3,te.GL.FLOAT,0,x),n.SetUniformValue(te.VSP_MODELMAT,d),n.SetUniformValue(te.VSP_NORMALMAT,g),0<A)if(R,n.SetUniformValue(te.FSP_DIFFUSE,R),n.SetUniformValue(te.FSP_AMBIENT,f),n.SetUniformValue(te.FSP_SPECULAR,m),n.SetUniformValue(te.FSP_SHININESS,1,y),E){var I=_.GetIndexOffset();ee.DrawTriWithIndex(i,G,P,A,I)}else ee.DrawTriNoIndex(i,G,A)}n.DisableAttributeArray(o.location),n.DisableAttributeArray(a.location),(te.Parameters.Instance().IsShowTrilateralEdge||te.Parameters.Instance().IsOnlyShowTrilateralEdge)&&(n.DisableAttributeArray(s.location),n.SetUniformValue(te.FSP_ENABLE_WRIEFRAME,new Int32Array([0])),n.SetUniformValue(te.FSP_ENABLE_ONLY_WRIEFRAME,new Int32Array([0]))),n.ReleaseShaderProgram()}},ee.DrawCapPolygon=function(e,t){var r=e.clipPlane,i=(e.enableClip,e.GetCamera());if(i){var n=e.GetSection();if(n){var o=n.GetPlaneList();if(!(t>=o.length||t<0)&&0<o.length)for(var a=0,s=0;s<o.length;s++){var l=o[s];if(l){var h=e.GetRenderContext().GetGLRenderContext();if(l.SetCurrentGLContext(h),!l.GetEnable())continue;if(a===t){h.disable(te.GL.BLEND),h.enable(te.GL.DEPTH_TEST),h.depthMask(!0),"IE"!==SView.BrowserHelper.myBrowser()&&h.lineWidth(1);var u,p,c=new te.Matrix4;p=i.GetProjection().Transpose(),u=i.GetView().ToMatrix4().Transpose();var d=e.GetShaderMananger().GetEffect(te.ShaderManager.Edge);d.UseProgram(),d.SetUniformValue(te.VSP_VIEWMAT,u),d.SetUniformValue(te.VSP_PROJECTIONMAT,p),d.SetUniformValue(te.VSP_MODELMAT,c);for(var S=[],f=i.GetView().ToMatrix4(),m=0;m<3;m++){var y=r[m].Clone();y=f.Inverse().Transpose().Multiply(y),S.push(y.x),S.push(y.y),S.push(y.z),S.push(y.w)}var T=new Float32Array(S);d.SetUniformValue(te.FSP_CLIPPLANE,3,T);var M=[].concat(e.enableClip);M[a]=0;var g=new Int32Array(M);d.SetUniformValue(te.FSP_ENABLECLIP,3,g);var v=d.GetShaderUniformParameter(te.FSP_REVERSECLIP);d.SetUniformValue(v.location+"",0);var C=d.GetShaderAttributeParameter(te.VSP_POSITION);d.EnableAttributeArray(C.location);var _=l.GetFacePositionVBO();_.Bind();var A=new te.Color(.6,.3,0);0===s?A.SetColor(.65,.3,0):1===s?A.SetColor(.5,.3,0):A.SetColor(.6,.3,0),d.SetVertexAttribPointer(C.location,3,te.GL.FLOAT,0,0),d.SetUniformValue(te.FSP_DIFFUSE,A),h.drawArrays(te.GL.TRIANGLES,0,6),_.UnBind(),h.depthMask(!0),d.DisableAttributeArray(C.location),d.ReleaseShaderProgram()}break}a++}}}},ee.DrawSampleModelPassGroug=function(e){for(var t=e.GetRenderEffect(),r=(t.GetRenderableTypeFilter(),t.GetRenderQueuePriority().GetData()),i=e.GetRenderQueueGroup(),n=[],o=0,a=r;o<a.length;o++){var s=a[o],l=i.get(s.GetRenderGroupType().GetType());if(void 0!==l){l.SetRenderTech(s);var h=l.GetType().GetType();h!==te.RenderableType.RGT_SOLID&&h!==te.RenderableType.RGT_TRANSPARENT||n.push(l)}}var u=e.GetRenderContext(),p=u.GetGLRenderContext();p.enable(te.GL.DEPTH_TEST);e.GetCamera();var c=e.GetShaderMananger().GetEffect(te.ShaderManager.Edge);c.UseProgram();var d=c.GetShaderAttributeParameter(te.VSP_POSITION);c.EnableAttributeArray(d.location),c.SetUniformValue(te.VSP_VIEWMAT,u.GetViewMatrix()),c.SetUniformValue(te.VSP_PROJECTIONMAT,u.GetProjectMatrix());for(var S=[],f=0;f<3;f++){var m=e.clipPlane[f].Clone();m=u.GetViewMatrix().Inverse().Multiply(m),S.push(m.x),S.push(m.y),S.push(m.z),S.push(m.w)}var y=new Float32Array(S);c.SetUniformValue(te.FSP_CLIPPLANE,3,y);var T=new Int32Array(e.enableClip);c.SetUniformValue(te.FSP_ENABLECLIP,3,T);for(var M=new te.Matrix4,g=u.GetViewMatrix(),v=new te.Matrix4,C=0;C<n.length;C++)for(var _=0,A=n[C].GetRenderableArray();_<A.length;_++){var E=A[_],G=E.GetDataLength(),P=E.IsUseIndex(),w=E.GetHardWareVertexBuffer(),D=E.GetHardWareIndexBuffer();(M=E.GetRenderWorldMatrix()).MultiplyMat4(g,v),w.Bind();var x=E.GetVertexOffset(),R=E.GetRenderColor();if(c.SetVertexAttribPointer(d.location,3,te.GL.FLOAT,0,x),c.SetUniformValue(te.VSP_MODELMAT,M),0<G)if(c.SetUniformValue(te.FSP_DIFFUSE,R),P){var I=E.GetIndexOffset();ee.DrawTriWithIndex(p,w,D,G,I)}else ee.DrawTriNoIndex(p,w,G)}c.DisableAttributeArray(d.location),c.ReleaseShaderProgram()},ee.InitialGL=function(e){if(null!=e){var t=e.GetRenderContext().GetGLRenderContext();t.enable(te.GL.DEPTH_TEST),t.depthFunc(te.GL.LEQUAL),t.blendEquationSeparate(t.FUNC_ADD,t.FUNC_ADD),t.blendFuncSeparate(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA,t.ONE,t.ONE_MINUS_SRC_ALPHA),t.disable(te.GL.BLEND),t.depthMask(!0),te.Parameters.Instance().m_BackTransparent?t.clearColor(0,0,0,0):t.clearColor(.92,.94,.929,1),t.frontFace(te.GL.CCW),t.clearStencil(0),t.clear(te.GL.DEPTH_BUFFER_BIT|te.GL.COLOR_BUFFER_BIT|te.GL.STENCIL_BUFFER_BIT)}},ee.DrawQuad=function(e){var t=e.GetRenderContext().GetGLRenderContext(),r=e.GetCamera().GetViewPort().GetRect();t.viewport(r.left,r.top,r.right,r.bottom);r.right,r.bottom;var i=e.GetShaderMananger().GetEffect(te.ShaderManager.Quad);i.UseProgram();var n=i.GetShaderAttributeParameter(te.VSP_POSITION),o=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,o),t.bufferData(t.ARRAY_BUFFER,new Float32Array([-1,1,-1,-1,-1,-1,1,1,-1,1,-1,-1]),t.STATIC_DRAW),i.EnableAttributeArray(n.location),i.SetVertexAttribPointer(n.location,3,te.GL.FLOAT,0,0),i.SetUniformValue(te.FSP_DIFFUSE,new te.Color(1,0,0)),t.drawArrays(te.GL.TRIANGLE_STRIP,0,4),i.DisableAttributeArray(n.location),i.ReleaseShaderProgram(),t.bindBuffer(te.GL.ARRAY_BUFFER,null),t.deleteBuffer(o)},ee.SetFocalLength=function(e){var t=e.GetScene(),r=t.GetCamera(),i=t.GetSceneBox().Clone(),n=r.GetWorldPosition().Sub(i.Center()).Length();i.Length();if(i.IsInside(r.GetWorldPosition())==te.OUTSIDE)r.SetPupilDistance(.03*n);else{var o=0,a=r.GetView().ToMatrix3(),s=new te.Vector3(a.Data()[6],0,a.Data()[8]),l=new te.Vector3(a.Data()[0],0,a.Data()[2]);(s=s.Multiply(-1)).Normalize(),(l=l.Multiply(-1)).Normalize();var h=l.Add(s);o=(o=.7071<te.Abs(h.DotProduct(te.Vector3.RIGHT()))?i.GetXLength():i.GetZLength())/4*.03,r.SetPupilDistance(o)}},ee.DrawFrameBufferDebug=function(e){var t=e.GetRenderContext().GetGLRenderContext(),r={},i=e.GetCamera().GetViewPort().GetRect();t.viewport(i.left,i.top,i.right,i.bottom);i.right,i.bottom;var n=e.GetShaderMananger().GetEffect(te.ShaderManager.FBODebug);n.UseProgram();var o={};ee._usedTextureUnits=0;var a=n.GetShaderAttributeParameter(te.VSP_POSITION),s=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,s),t.bufferData(t.ARRAY_BUFFER,new Float32Array([-1,1,-1,-1,-1,-1,1,1,-1,1,-1,-1]),t.STATIC_DRAW),n.EnableAttributeArray(a.location),n.SetVertexAttribPointer(a.location,3,te.GL.FLOAT,0,0);var l=n.GetShaderAttributeParameter(te.VSP_TEXCOORDS),h=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,h),t.bufferData(t.ARRAY_BUFFER,new Float32Array([0,1,0,0,1,1,1,0]),t.STATIC_DRAW),n.EnableAttributeArray(l.location),n.SetVertexAttribPointer(l.location,2,te.GL.FLOAT,0,0);var u=new te.Matrix4,p=new te.Matrix4,c=new te.Matrix4;o[te.VSP_MODELMAT]=new te.Uniform("Matrix4",c),o[te.VSP_VIEWMAT]=new te.Uniform("Matrix4",u),o[te.VSP_PROJECTIONMAT]=new te.Uniform("Matrix4",p),o[te.FSP_SAMPLER0]=new te.Uniform("Texture2D",ee.rendT.getColorTarget(0));var d=n.GetShaderUniformMap();for(var S in te.UniformHelper.UpdateUniform(e,r,n,d,o),t.drawArrays(te.GL.TRIANGLE_STRIP,0,4),r){var f=r[S];t.activeTexture(te.GL.TEXTURE0+parseInt(S)),t.bindTexture(f,null)}n.DisableAttributeArray(a.location),n.DisableAttributeArray(l.location),n.ReleaseShaderProgram(),t.deleteBuffer(s),t.deleteBuffer(h)},ee.DrawImageBoardQueue=function(e){var t=e.GetRenderImageBoards();if(0<t.length){var r=e.GetCamera(),i=(r.GetView().ToMatrix4(),r.GetProjection().Transpose()),n=r.GetView().ToMatrix4().Transpose(),o=e.GetShaderMananger();if(!o)return;var a=o.GetEffect(te.ShaderManager.Image);a.UseProgram();var s=new Int32Array(e.enableClip);a.SetUniformValue(te.FSP_ENABLECLIP,3,s);var l=a.GetShaderUniformParameter(te.FSP_REVERSECLIP);a.SetUniformValue(te.FSP_REVERSECLIP,l.location,e.m_bReverseClip?1:0);for(var h=te.Matrix4.IDENTITY().Clone(),u=0;u<t.length;u++){var p=t[u];p&&p.GetAllowClip()&&a.SetUniformValue(te.FSP_ENABLECLIP,3,s),ee.DrawImageBoard(p,n,i,h,a,!p.IsFrontShow())}a.ReleaseShaderProgram()}},ee.DrawGeometry=function(e){var t=e.GetShaderMananger();if(null!=t){var r=e.GetCamera();if(null!=r){for(var i=e.GetPoints(),n=[],o=0;o<i.length;o++){2==(m=(d=i[o]).GetPointStyle())||3==m?this.DrawPoint(d,t,r):n.push(d)}var a=t.GetEffect(te.ShaderManager.NoteEdge);if(a.UseProgram(),null!=t.GetCurrentAction()){var s,l,h,u=e.GetRenderContext().GetGLRenderContext();e.GetRenderContext();l=r.GetProjection().Transpose(),s=r.GetView().ToMatrix4().Transpose(),h=te.Matrix4.IDENTITY();var p=a.GetShaderAttributeParameter(te.VSP_POSITION);a.EnableAttributeArray(p.location),a.SetUniformValue(te.VSP_MODELMAT,h),a.SetUniformValue(te.VSP_VIEWMAT,s),a.SetUniformValue(te.VSP_PROJECTIONMAT,l);var c=a.GetShaderUniformParameter("u_useMinDepth");1,c&&a.SetUniformValue(String(c.location),1),u.enable(u.DEPTH_TEST),u.depthMask(!1),u.enable(u.BLEND),"IE"!==SView.BrowserHelper.myBrowser()&&u.lineWidth(2);for(o=0;o<n.length;o++){var d;if(null!=(d=n[o])){var S=d.GetSize();40<(S+=4)&&(S=40);var f=te.Color.SelectColor();d.IsSelected()||(f=d.GetColor()),a.SetUniformValue(te.FSP_DIFFUSE,f);var m,y=d.GetCoordinate(),T=[y.x,y.y,y.z],M=u.createBuffer();u.bindBuffer(u.ARRAY_BUFFER,M),u.bufferData(u.ARRAY_BUFFER,new Float32Array(T),u.STATIC_DRAW),a.SetVertexAttribPointer(p.location,3,u.FLOAT,0,0),0==(m=d.GetPointStyle())?u.drawArrays(u.POINTS,0,1):1==m&&u.drawArrays(u.POINTS,0,1),u.deleteBuffer(M)}}var g=e.GetLinePoints();for(o=0;o<g.length;o++){var v=g[o],C=2;if(0!=C){var _=v.GetLineWidth();T=[];if(1==v.GetLineStyle()){var A=[];te.M3DTOOLS.VecSlerp1(v.StartPoint,v.EndPoint,20,A);for(var E=0;E<A.length;E++){var G=A[E];T.push(G.x),T.push(G.y),T.push(G.z)}C=T.length/3}else"IE"!==SView.BrowserHelper.myBrowser()&&(T=[v.StartPoint.x,v.StartPoint.y,v.StartPoint.z,v.EndPoint.x,v.EndPoint.y,v.EndPoint.z]);M=u.createBuffer();u.bindBuffer(u.ARRAY_BUFFER,M),u.bufferData(u.ARRAY_BUFFER,new Float32Array(T),u.STATIC_DRAW);f=te.Color.SelectColor();v.IsSelected()||(f=v.GetColor()),a.SetUniformValue(te.FSP_DIFFUSE,f),a.SetVertexAttribPointer(p.location,3,u.FLOAT,0,0),v.IsShowPoint()&&u.drawArrays(u.POINTS,0,C),"IE"!==SView.BrowserHelper.myBrowser()&&u.lineWidth(_),1==v.GetLineStyle()?u.drawArrays(u.LINES,0,C):u.drawArrays(u.LINE_STRIP,0,C),u.deleteBuffer(M)}}var P=e.GetCurvePoints();for(o=0;o<P.length;o++){var w=P[o],D=0;if(null!=w){var x=[],R=[];if(w.GetType()==te.ShapeType.CURVE_POLYLINE)x=w.GetPoints(),D=w.GetPoints().length,w.GetSelectIndex();else if(w.GetType()==te.ShapeType.CURVE_NURBSCURVE){var I=w;x=I.GetPoints(),D=I.GetPoints().length,R=I.GetCurvePointList(),I.GetSelectIndex()}if(0!=D){_=w.GetWidth(),w.GetType(),f=te.Color.SelectColor();w.IsSelected()||(f=w.GetColor());for(var L=[],N=0;N<x.length;N++){G=x[N];L.push(G.x),L.push(G.y),L.push(G.z)}var O=u.createBuffer();u.bindBuffer(u.ARRAY_BUFFER,O),u.bufferData(u.ARRAY_BUFFER,new Float32Array(L),u.STATIC_DRAW),a.SetUniformValue(te.FSP_DIFFUSE,f),a.SetVertexAttribPointer(p.location,3,u.FLOAT,0,0),w.IsShowPoint()&&u.drawArrays(u.POINTS,0,D),w.GetType()==te.ShapeType.CURVE_NURBSCURVE&&2<D&&(D=(x=R).length),u.deleteBuffer(O);for(var b=[],V=0;V<x.length;V++){G=x[V];b.push(G.x),b.push(G.y),b.push(G.z)}M=u.createBuffer();u.bindBuffer(u.ARRAY_BUFFER,M),u.bufferData(u.ARRAY_BUFFER,new Float32Array(b),u.STATIC_DRAW),a.SetVertexAttribPointer(p.location,3,u.FLOAT,0,0),"IE"!==SView.BrowserHelper.myBrowser()&&u.lineWidth(_),w.GetLineStyle(),u.drawArrays(u.LINE_STRIP,0,D),u.deleteBuffer(M)}}}a.DisableAttributeArray(p.location),a.ReleaseShaderProgram()}}}},ee.AllocTextureUnit=function(){var e=ee._usedTextureUnits;return ee._usedTextureUnits+=1,e},ee.DrawHUBImageQueue=function(e){var t=e.GetHudImages();if(0<t.length){var r=e.GetScene().GetHudCamera(),i=(r.GetView().ToMatrix4(),r.GetProjection().Transpose()),n=r.GetView().ToMatrix4().Transpose(),o=e.GetShaderMananger();if(!o)return;var a=o.GetEffect(te.ShaderManager.Image);a.UseProgram();for(var s=[],l=0;l<3;l++){var h=new te.Vector4(e.clipPlane[l].Clone());h=r.GetView().ToMatrix4().Inverse().Transpose().Multiply(h),s.push(h.x),s.push(h.y),s.push(h.z),s.push(h.w)}var u=new Float32Array(s);a.SetUniformValue(te.FSP_CLIPPLANE,3,u);var p=new Int32Array(e.enableClip);a.SetUniformValue(te.FSP_ENABLECLIP,3,p);var c=a.GetShaderUniformParameter(te.FSP_REVERSECLIP);a.SetUniformValue(te.FSP_REVERSECLIP,c.location,e.m_bReverseClip?1:0);for(var d=te.Matrix4.IDENTITY(),S=0;S<t.length;S++){var f=t[S];ee.DrawImageBoard(f,n,i,d,a,!0)}a.ReleaseShaderProgram()}},ee.isSVLX=!0,ee._usedTextureUnits=0,ee.m_ssaoLastState=!1,ee.depthMaterial=null,ee.rendT=null,ee.m_shadowState=!1,ee.renderTarget=null,ee}();te.GLShapeDrawer=e}(M3D||(M3D={})),function(e){e.VSP_POSITION="a_position",e.VSP_NORMAL="a_normal",e.VSP_COLOR="a_color",e.VSP_CENTER="a_center",e.VSP_UCOLOR="u_color",e.VSP_TEXCOORDS="a_texCoords",e.VSP_MODELMAT="u_modelMat",e.VSP_VIEWMAT="u_viewMat",e.VSP_PROJECTIONMAT="u_projectionMat",e.VSP_NORMALMAT="u_normalMat",e.VSP_LIGHTMAT="u_lightMat",e.VSP_LIGHTPROJECT="u_lightProject",e.VSP_BAIS="u_bais",e.VSP_MODELVIEWMAT="u_modelViewMat",e.VSP_MVPMAT="u_MVPMat",e.VSP_TEXTUREMAT="u_textureMat",e.VSP_LIGHTPOSITION="u_lightPosition",e.VSP_EYEPOSITION="u_eyePosition",e.FSP_AMBIENT="u_ambient",e.FSP_DIFFUSE="u_diffuse",e.FSP_SPECULAR="u_specular",e.FSP_SHININESS="u_shininess",e.FSP_SAMPLER0="u_sampler0",e.FSP_SAMPLER1="u_sampler1",e.FSP_SAMPLER2="u_sampler2",e.FSP_SAMPLERCUBE0="u_samplerCube0",e.FSP_USETEX="u_useTex",e.FSP_FRESNEL0="u_fresnel0",e.FSP_ROUGHNESS="u_roughness",e.FSP_CLIPPLANE="u_clipPlanes",e.FSP_ENABLECLIP="u_enableClips",e.FSP_REVERSECLIP="u_reverseClip",e.FSP_ENABLE_WRIEFRAME="u_enableWireframe",e.FSP_ENABLE_ONLY_WRIEFRAME="u_enableOnlyWireframe",e.FSP_ENABLELIGHTS="u_enbleLights",e.FSP_LIGHTMODEL_AMBIENT="u_lightModel.ambient",e.FSP_LIGHT_0_AMBIENT="u_lights[0].ambient",e.FSP_LIGHT_0_DIFFUSE="u_lights[0].diffuse",e.FSP_LIGHT_0_SPECULAR="u_lights[0].specular",e.FSP_LIGHT_0_POSITION="u_lights[0].position",e.FSP_LIGHT_0_SPOT_DIRECTION="u_lights[0].spotDirection",e.FSP_LIGHT_0_SPOT_EXPONENT="u_lights[0].spotExponent",e.FSP_LIGHT_0_SPOT_CUTOFF="u_lights[0].spotCutoff",e.FSP_LIGHT_0_SPOT_COSCUTOFF="u_lights[0].spotCosCutoff",e.FSP_LIGHT_0_CONST_ATTENUATION="u_lights[0].constant",e.FSP_LIGHT_0_LINEAR_ATTENUATION="u_lights[0].linear",e.FSP_LIGHT_0_QUAD_ATTENUATION="u_lights[0].quadratic",e.FSP_LIGHT_0_INTENSITY="u_lights[0].intensity",e.FSP_LIGHT_1_AMBIENT="u_lights[1].ambient",e.FSP_LIGHT_1_DIFFUSE="u_lights[1].diffuse",e.FSP_LIGHT_1_SPECULAR="u_lights[1].specular",e.FSP_LIGHT_1_POSITION="u_lights[1].position",e.FSP_LIGHT_1_SPOT_DIRECTION="u_lights[1].spotDirection",e.FSP_LIGHT_1_SPOT_EXPONENT="u_lights[1].spotExponent",e.FSP_LIGHT_1_SPOT_CUTOFF="u_lights[1].spotCutoff",e.FSP_LIGHT_1_SPOT_COSCUTOFF="u_lights[1].spotCosCutoff",e.FSP_LIGHT_1_CONST_ATTENUATION="u_lights[1].constant",e.FSP_LIGHT_1_LINEAR_ATTENUATION="u_lights[1].linear",e.FSP_LIGHT_1_QUAD_ATTENUATION="u_lights[1].quadratic",e.FSP_LIGHT_1_INTENSITY="u_lights[1].intensity",e.FSP_MATERIAL_EMISSION="u_materials.emission",e.FSP_MATERIAL_AMBIENT="u_materials.ambient",e.FSP_MATERIAL_DIFFUSE="u_materials.diffuse",e.FSP_MATERIAL_SPECULAR="u_materials.specular",e.FSP_MATERIAL_SHININESS="u_materials.shininess",e.FSP_USEAMBIENTTEX="u_useAmbientTex",e.FSP_USECUBEMAPTEX="u_useCubeMapTex",e.FSP_USEDIFFUSETEX="u_useDiffuseTex",e.FSP_SELECTCOLOR="u_selectColor",e.FSP_SHADOW_LIGHTPOS="u_shadowLPos",e.SHADOW_X_PIXEL_OFFSET="u_xPixelOffset",e.SHADOW_Y_PIXEL_OFFSET="u_yPixelOffset",e.VSP_LIGHT_NORMALMAT="u_lightNormalMat",e.FSP_EDGEDETEC="u_edgeDetecColor",e.MODEL_MATRXI="modelMatrix",e.VIEW_MATRXI="viewMatrix",e.NORMAL_MATRXI="normalMatrix",e.PROJECTION_MATRXI="projectionMatrix",e.UV_TRANSFORM_MATRIX="uvTransform",e.DIFFUSE="diffuse",e.SPECULAR="specular",e.EMISSIVE="emissive",e.SHININESS="shininess",e.DIFFUSE_TEXTURE="diffuseTexture",e.SPECULAR_MAP="specularMap",e.NORMAL_MAP="normalMap",e.MATCAP_MAP="matcapMap",e.NORMAL_MAP_SCALE="normalScale",e.DISPLACEMENT_MAP="displacementMap",e.DISPLACEMENT_SCALE="displacementScale",e.DISPLACEMENT_BIAS="displacementBias",e.EMISSIVE_MAP="emissiveMap",e.AO_MAP="aoMap",e.AO_MAP_INTENSITY="aoMapIntensity",e.ENV_TEXTURE="envTexture",e.ENV_DIFFUSE_TEXTURE="envDiffuseTexture",e.ROUGHNESS="roughness",e.METALNESS="metalness",e.METALLIC_ROUGHNESS_TEXTURE="metallicRoughnessTexture",e.GAMMA="gamma",e.ENV_MAP_INTENSITY="envMapIntensity",e.LUT="lut",e.CAMERA_POSITION="cameraPosition",e.AMBIENT_LIGHT_COLOR="ambientLightColor",e.SPOT_LIGHT_0_COLOR="spotLights[0].color",e.SPOT_LIGHT_0_POSITION="spotLights[0].position",e.SPOT_LIGHT_0_DIRECTION="spotLights[0].direction",e.SPOT_LIGHT_0_DISTANCE="spotLights[0].distance",e.SPOT_LIGHT_0_DECAY="spotLights[0].decay",e.SPOT_LIGHT_0_CONECOS="spotLights[0].coneCos",e.SPOT_LIGHT_0_PENUMBRACOS="spotLights[0].penumbraCos",e.SPOT_LIGHT_0_SHADOW="spotLights[0].shadow",e.TONE_MAPPING_EXPOSURE="toneMappingExposure",e.CLEARCOAT="clearCoat",e.CLEARCOATROUGHNESS="clearCoatRoughness",e.OPACITY="opacity"}(M3D||(M3D={})),function(e){var t=function(i){function e(e,t){var r=i.call(this,e)||this;return r.isCompiled=!1,r.shader=null,r.type=t,r.gl=e,r}return __extends(e,i),e.prototype.AddLineNumbers=function(e){for(var t=e.split("\n"),r=0;r<t.length;r++)t[r]=r+1+": "+t[r];return t.join("\n")},e.prototype.CompileSourceCode=function(e){var t=!0,r=this.gl.createShader(this.type);return this.gl.shaderSource(r,e),this.gl.compileShader(r),!(this.isCompiled=!0)===this.gl.getShaderParameter(r,this.gl.COMPILE_STATUS)&&(""!==this.gl.getShaderInfoLog(r)&&console.log(this.type,"M3DJS Shader Info: "+this.gl.getShaderInfoLog(r),this.AddLineNumbers(e)),t=this.isCompiled=!1),this.shader=r,t},e.prototype.IsCompiled=function(){return this.isCompiled},e.prototype.ShaderObject=function(){return this.shader},e.prototype.DeleteShader=function(){this.isCompiled&&this.gl.deleteShader(this.shader)},e.prototype.GetShaderType=function(){return this.type},e}(e.GPUObject);e.Shader=t}(M3D||(M3D={})),function(e){e.ShaderStrings={},e.ShaderStrings.BaseVert=["precision highp  float;","attribute vec3 a_position;","attribute vec3 a_normal;","attribute vec3 a_center;","uniform mat4 u_modelMat;","uniform mat4 u_viewMat;","uniform mat4 u_projectionMat;","uniform mat4 u_normalMat;","uniform mat4 u_textureMat;","uniform vec3 u_lightPosition;","varying vec3 v_viewDirection;","varying vec3 v_lightDirection;","varying vec3 v_normal;","varying vec3 v_position;","varying vec3 v_center;","void main() { ","gl_Position = u_projectionMat * u_viewMat*u_modelMat* vec4(a_position,1.0);","vec4 fvObjectPosition = u_viewMat*u_modelMat* vec4(a_position,1.0);","v_position = fvObjectPosition.xyz/fvObjectPosition.w;","v_viewDirection  = normalize( -fvObjectPosition.xyz);","v_lightDirection = normalize(u_lightPosition-fvObjectPosition.xyz);"," v_normal         = normalize(vec3((u_normalMat * vec4(a_normal,0.0))));","v_center = a_center;","}"].join("\n"),e.ShaderStrings.BaseFrag=["#extension GL_OES_standard_derivatives : enable \n","precision highp  float;","uniform vec4 u_ambient;","uniform vec4 u_diffuse;","uniform vec4 u_specular;","uniform float u_shininess;","uniform bool u_enableWireframe;","uniform bool u_enableOnlyWireframe;","uniform vec4 u_clipPlane;","uniform bool u_enableClip;","varying vec3 v_viewDirection;","varying vec3 v_lightDirection;","varying vec3 v_normal;","varying vec3 v_position;","varying vec3 v_center;","const vec4 ambientColor = vec4(1.0, 1.0, 1.0,1.0);","const vec4 diffuseColor = vec4(1.0, 1.0, 1.0,1.0);","const vec4 specularColor = vec4(0.5,0.5,0.5,1.0);","float edgeFactorTri() {"," vec3 d = fwidth(v_center.xyz);","vec3 a3 = smoothstep(vec3(0.000001), d * 1.5, v_center.xyz);","  return min(min(a3.x, a3.y), a3.z);"," }","void main() { ","    if(u_enableClip)","    {","       float dPara = u_clipPlane.w;","\t\tfloat testvalue = (dot(vec3(v_position.xyz),vec3(u_clipPlane.xyz))+dPara);","        if( testvalue<0.0)","        {","            discard;","        }","    }","float fNDotL =0.000001;","vec3 \thalfvector;","float fNDotH;"," vec3  fvNormal ;","if(gl_FrontFacing){"," fvNormal         = normalize( v_normal );","}","else {"," fvNormal         = normalize( -v_normal );","}"," fNDotL           = clamp(abs(dot( fvNormal, v_lightDirection )),0.2,1.0);","halfvector        =normalize(v_lightDirection+ v_viewDirection );"," fNDotH            = max(0.000001,dot(fvNormal,halfvector));","vec4  fvTotalAmbient   = u_ambient * ambientColor;","vec4  fvTotalDiffuse   = u_diffuse * fNDotL * diffuseColor; ","vec4  fvTotalSpecular  = u_specular * specularColor *( pow( max(fNDotH,0.000001), u_shininess ) );","vec4 colorLinear = fvTotalAmbient + fvTotalDiffuse + fvTotalSpecular;","if(u_enableWireframe){","gl_FragColor = vec4(colorLinear.xyz,u_diffuse.a)*vec4(vec3(mix( vec3( 0.000001 ), vec3( 1.0 ), edgeFactorTri() )),1.0);","}","else if(u_enableOnlyWireframe){","gl_FragColor = vec4(colorLinear.xyz,u_diffuse.a)*vec4(1.0, 1.0, 1.0,(1.0-edgeFactorTri())*0.95);","}","else{","gl_FragColor = vec4(colorLinear.xyz,u_diffuse.a);","}","}"].join("\n"),e.ShaderStrings.BackgroundVert=["precision highp float;","attribute vec3 a_position;","attribute vec4 a_color;","uniform mat4 u_MVPMat;","varying vec4 v_color;","void main() { ","gl_Position = u_MVPMat * vec4(a_position,1.0);","v_color = a_color;","}"].join("\n"),e.ShaderStrings.BackgroundFrag=["precision highp float;","varying vec4 v_color;","void main() { ","gl_FragColor = v_color;","}"].join("\n"),e.ShaderStrings.EdgeVert=["precision highp float;","attribute vec3 a_position;","uniform mat4 u_modelMat;","uniform mat4 u_viewMat;","uniform mat4 u_projectionMat;","varying vec3 v_position;","#ifdef DEPTH_EDGE","varying vec4 v_projectPos;","#endif","void main(){","gl_Position = u_projectionMat *u_viewMat*u_modelMat*vec4(a_position,1.0);","#ifdef DEPTH_EDGE","v_projectPos = u_projectionMat *u_viewMat*u_modelMat*vec4(a_position,1.0);","#endif","vec4 fvObjectPosition = u_viewMat*u_modelMat* vec4(a_position,1.0);","v_position = fvObjectPosition.xyz;","gl_PointSize = 3.0;","}"].join("\n"),e.ShaderStrings.EdgeFrag=["precision highp float;","uniform vec4 u_diffuse;","uniform vec4 u_clipPlanes[3];","uniform bool u_enableClips[3];","uniform bool u_reverseClip;","#ifdef DEPTH_EDGE","uniform sampler2D u_sampler0;","varying vec4 v_projectPos;","#endif","varying vec3 v_position;","void main() { ","if (u_reverseClip) {","int iEnableNum = 0; ","int iClipNum = 0; ","for (int i = 0; i < 3; i++) {","if (u_enableClips[i]) {","iEnableNum++; ","float dPara = u_clipPlanes[i].w; ","if ((dot(vec3(v_position.xyz), vec3(u_clipPlanes[i].xyz)) + dPara) > 0.0) {","iClipNum++; ","}","}","}","if (iEnableNum == iClipNum && iEnableNum != 0) {","discard; ","}","}","else {","for (int i = 0; i < 3; i++) {","if (u_enableClips[i]) {","float dPara = u_clipPlanes[i].w; ","if ((dot(vec3(v_position.xyz), vec3(u_clipPlanes[i].xyz)) + dPara) < 0.0) {","discard; ","}","}","}","}","#ifdef DEPTH_EDGE","vec3 proj =v_projectPos.xyz/v_projectPos.w;","   proj = proj *0.5+0.5;","float priDepth = texture2D(u_sampler0,proj.xy).x;","if(priDepth<proj.z) discard;","#endif","gl_FragColor = u_diffuse;","}"].join("\n"),e.ShaderStrings.AxisVert=["precision highp float;","attribute vec3 a_position;","uniform vec4 u_color;","uniform mat4 u_MVPMat;","varying vec4 v_color;","void main() { ","gl_Position = u_MVPMat * vec4(a_position,1.0);","v_color = u_color;","}"].join("\n"),e.ShaderStrings.AxisFrag=["precision highp float;","varying vec4 v_color;","void main() { ","gl_FragColor = v_color;","}"].join("\n"),e.ShaderStrings.BackGroundImageVert=["precision highp float;","attribute vec3 a_position;","attribute vec2 a_texCoords;","uniform mat4 u_modelMat;","uniform mat4 u_viewMat;","uniform mat4 u_projectionMat;","varying vec2 v_texCoords;","varying vec3 v_position;","void main(){","gl_Position = u_projectionMat *u_viewMat*u_modelMat*vec4(a_position,1.0);","vec4 fvObjectPosition = u_viewMat*u_modelMat* vec4(a_position,1.0);","v_position = fvObjectPosition.xyz;","v_texCoords = a_texCoords;","}"].join("\n"),e.ShaderStrings.BackGroundImageFrag=["precision highp float;","uniform sampler2D u_sampler0;","uniform vec4 u_diffuse;","uniform vec4 u_clipPlanes[3];","uniform bool u_enableClips[3];","uniform bool u_reverseClip;","varying vec2 v_texCoords;","varying vec3 v_position;","void main() { ","if (u_reverseClip) {","int iEnableNum = 0; ","int iClipNum = 0; ","for (int i = 0; i < 3; i++) {","if (u_enableClips[i]) {","iEnableNum++; ","float dPara = u_clipPlanes[i].w; ","if ((dot(vec3(v_position.xyz), vec3(u_clipPlanes[i].xyz)) + dPara) > -0.0001) {","iClipNum++; ","}","}","}","if (iEnableNum == iClipNum && iEnableNum != 0) {","discard; ","}","}","else {","for (int i = 0; i < 3; i++) {","if (u_enableClips[i]) {","float dPara = u_clipPlanes[i].w; ","if ((dot(vec3(v_position.xyz), vec3(u_clipPlanes[i].xyz)) + dPara) < 0.0001) {","discard; ","}","}","}","}","vec4 pcolor = texture2D(u_sampler0,v_texCoords);","vec4 tcolor = pcolor*u_diffuse;","if (pcolor.a < 0.18 || pcolor == vec4(1.0, 1.0, 1.0, 1.0)) {","   discard;","}","gl_FragColor = vec4(tcolor.xyz,pcolor.a);","}"].join("\n"),e.ShaderStrings.ImageVert=["precision highp float;","attribute vec3 a_position;","attribute vec2 a_texCoords;","uniform mat4 u_modelMat;","uniform mat4 u_viewMat;","uniform mat4 u_projectionMat;","varying vec2 v_texCoords;","varying vec3 v_position;","void main(){","gl_Position = u_projectionMat *u_viewMat*u_modelMat*vec4(a_position,1.0);","vec4 fvObjectPosition = u_viewMat*u_modelMat* vec4(a_position,1.0);","v_position = fvObjectPosition.xyz;","v_texCoords = a_texCoords;","}"].join("\n"),e.ShaderStrings.ImageFrag=["precision highp float;","uniform sampler2D u_sampler0;","uniform vec4 u_diffuse;","uniform vec4 u_clipPlanes[3];","uniform bool u_enableClips[3];","uniform bool u_reverseClip;","varying vec2 v_texCoords;","varying vec3 v_position;","void main() { ","if (u_reverseClip) {","int iEnableNum = 0; ","int iClipNum = 0; ","for (int i = 0; i < 3; i++) {","if (u_enableClips[i]) {","iEnableNum++; ","float dPara = u_clipPlanes[i].w; ","if ((dot(vec3(v_position.xyz), vec3(u_clipPlanes[i].xyz)) + dPara) > -0.0001) {","iClipNum++; ","}","}","}","if (iEnableNum == iClipNum && iEnableNum != 0) {","discard; ","}","}","else {","for (int i = 0; i < 3; i++) {","if (u_enableClips[i]) {","float dPara = u_clipPlanes[i].w; ","if ((dot(vec3(v_position.xyz), vec3(u_clipPlanes[i].xyz)) + dPara) < 0.0001) {","discard; ","}","}","}","}","vec4 pcolor = texture2D(u_sampler0,v_texCoords);","vec4 tcolor = pcolor*u_diffuse;","gl_FragColor = vec4(tcolor.xyz,pcolor.a);","}"].join("\n"),e.ShaderStrings.CubeMapVert=["precision highp float;","attribute vec3 a_position;","uniform mat4 u_modelMat;","uniform mat4 u_viewMat;","uniform mat4 u_projectionMat;","varying vec3 v_cubeTexCoords;","void main(){","gl_Position = u_projectionMat *u_viewMat*u_modelMat*vec4(a_position,1.0);","v_cubeTexCoords = a_position;","}"].join("\n"),e.ShaderStrings.CubeMapFrag=["precision highp float;","uniform samplerCube u_samplerCube0;","varying vec3 v_cubeTexCoords;","void main() { ","vec4 pcolor = textureCube(u_samplerCube0,v_cubeTexCoords);","gl_FragColor = pcolor;","}"].join("\n"),e.ShaderStrings.MultilightVert=["precision highp float;","//#define FBO ","struct Light","{","    vec4 ambient;","    vec4 diffuse;","    vec4 specular;","    vec4 position;","    vec3 intensity;","    vec3 spotDirection;","    float spotExponent;","    float spotCutoff; // (range: [0.0,90.0], 180.0)","    float spotCosCutoff; // (range: [1.0,0.0],-1.0)","    float constant;","    float linear;","    float quadratic;","};","","struct LightModel","{","    vec4 ambient;    // Acs","};","","struct Materials","{","    vec4 emission;","    vec4 ambient;","    vec4 diffuse;","    vec4 specular;","    float shininess;","};","attribute vec3 a_position;","attribute vec3 a_normal;","attribute vec3 a_texCoords;","uniform mat4 u_modelMat;","uniform mat4 u_viewMat;","uniform mat4 u_projectionMat;","uniform mat4 u_normalMat;","#ifdef FBO ","uniform mat4 u_lightMat;","uniform mat4 u_lightProject;","#endif ","uniform mat4 u_textureMat;","uniform vec3 u_eyePosition;","","//varying","varying vec3 v_position;","varying vec4 v_texCoords;","varying vec3 v_diffuseColor;","varying vec3 v_specularColor;","varying vec3 v_diffuseColorN;","varying vec3 v_specularColorN;","varying vec3 v_normal;","varying vec3 v_cubeTexCoords;","#ifdef FBO ","varying vec4 v_lightSpacePos;","varying vec3 v_worldNormal;","varying vec3 v_worldPos;","uniform vec3 u_shadowLPos;","#endif ","//scene ambient","uniform LightModel u_lightModel ;","const int numberOfLights = 1;","uniform Light u_lights[1];","uniform int u_enbleLights[1];","//Materials","uniform Materials u_materials;","void main(void)","{","    gl_Position = u_projectionMat * u_viewMat*u_modelMat* vec4(a_position,1.0);","    vec3 lightDirection;","    float attenuation=1.0;","    vec3 totalLighting = vec3(u_materials.emission)+ vec3(u_lightModel.ambient) * vec3(u_materials.ambient);","    vec3 totalAmbient= vec3(0.0,0.0,0.0);","    vec3 totalDiffuse = vec3(0.0,0.0,0.0);","    vec3 totalSpecular = vec3(0.0,0.0,0.0);","    vec3 totalAmbientBack= vec3(0.0,0.0,0.0);","    vec3 totalDiffuseBack = vec3(0.0,0.0,0.0);","    vec3 totalSpecularBack = vec3(0.0,0.0,0.0);","    vec4 fvObjectPosition = u_viewMat*u_modelMat* vec4(a_position,1.0);","#ifdef FBO ","    v_lightSpacePos = u_lightProject*u_lightMat *u_modelMat* vec4(a_position,1.0);","    v_worldNormal = a_normal;","#endif ","    vec4 tempCoords = u_textureMat*vec4(a_texCoords.xyz,1.0);","    v_position = fvObjectPosition.xyz/fvObjectPosition.w;","    v_texCoords = tempCoords;","    vec3 vNormal= normalize(vec3((u_normalMat * vec4(a_normal,0.0))));","    v_normal = vNormal;","    vec4 worldPos = u_modelMat * vec4(a_position,1.0);","    vec3 worldPosT = worldPos.xyz;","    v_cubeTexCoords =reflect(normalize(worldPosT -u_eyePosition), normalize(a_normal));","#ifdef FBO","   v_worldPos = worldPosT;","#endif","    for(int index = 0;index<numberOfLights;index++)","    {","        if(u_enbleLights[index] == 1)","        {","","            if (0.0 == u_lights[index].position.w) // directional light?","            {","                attenuation = 1.0; // no attenuation","                lightDirection = normalize(vec3(u_lights[index].position));","            }","            else // point light or spotlight (or other kind of light)","            {","                vec3 positionToLightSource = vec3(u_lights[index].position) - fvObjectPosition.xyz ;","                float distance = length(positionToLightSource);","                lightDirection = normalize(positionToLightSource);","                float tempA= u_lights[index].constant + u_lights[index].linear * distance + u_lights[index].quadratic * distance * distance;","                attenuation = 1.0 / tempA;","                if (u_lights[index].spotCutoff <= 90.0) // spotlight?","                {","                    float clampedCosine = max(0.0001, dot(lightDirection, -normalize(u_lights[index].spotDirection)));","                    if (clampedCosine < u_lights[index].spotCosCutoff) // outside of spotlight cone?","                    {","                        attenuation = 0.0;","                    }","                    else","                    {","                        attenuation = attenuation * pow(clampedCosine, u_lights[index].spotExponent);","//attenuation *= clamp((clampedCosine-cos(radians(15.0)) ) / (cos(radians(10.0)) - cos(radians(15.0))), 0.0, 1.0);","                    }","                }","            }","","         //a side","        float fNDotL= clamp(abs(dot( vNormal, lightDirection )),0.3,1.0);","        vec3 diffuseReflection = attenuation","            * vec3(u_lights[index].diffuse) * vec3(u_materials.diffuse)","            * fNDotL;","        //the othor","        fNDotL= clamp(abs(dot( -vNormal, lightDirection )),0.3,1.0);","        vec3 diffuseReflectionBack = attenuation","            * vec3(u_lights[index].diffuse) * vec3(u_materials.diffuse)","            * fNDotL;","","         totalAmbient =vec3(totalAmbient) + vec3(u_lights[index].ambient) * vec3(u_materials.ambient);","\t\t  float intensity = u_lights[index].intensity.x;","         totalDiffuse = totalDiffuse + diffuseReflection*intensity;","         totalDiffuseBack = totalDiffuseBack + diffuseReflectionBack*intensity;","","        vec3 eyeDirection = normalize(- fvObjectPosition.xyz );","        vec3 halfVector = normalize(lightDirection+ eyeDirection);","","\t\tvec3 tempsp = vec3(u_lights[index].specular);","\t\tfloat spv =  tempsp.x*tempsp.x+tempsp.y*tempsp.y+tempsp.z*tempsp.z;","\t\t\tif(spv>0.0){","        //a side","        float fNDotH = max(0.0, abs(dot(vNormal,halfVector)));","        vec3 specularReflection = attenuation * vec3(u_lights[index].specular) * vec3(u_materials.specular)","               * pow(fNDotH, u_materials.shininess);","        //the other","        fNDotH = max(0.0, abs(dot(-vNormal,halfVector)));","        vec3 specularReflectionBack = attenuation * vec3(u_lights[index].specular) * vec3(u_materials.specular)","               * pow(fNDotH, u_materials.shininess);","","         totalSpecular = totalSpecular + specularReflection*intensity;","         totalSpecularBack = totalSpecularBack + specularReflectionBack*intensity;","\t\t\t}","        }","    }","    v_diffuseColor = min(totalLighting+totalAmbient+totalDiffuse,vec3(1.0));","    v_specularColor = min(totalSpecular,vec3(1.0));","","    v_diffuseColorN = min(totalLighting+totalAmbient+totalDiffuseBack,vec3(1.0));","    v_specularColorN = min(totalSpecularBack,vec3(1.0));"," }"].join("\n"),e.ShaderStrings.MultilightFrag=["precision highp float;","//#define FBO ","uniform vec4 u_clipPlane;","uniform bool u_enableClip;","uniform bool u_useTex;","uniform bool u_useAmbientTex;","uniform bool u_useCubeMapTex;","uniform sampler2D u_sampler0;","uniform sampler2D u_sampler1;","uniform sampler2D u_sampler2;","uniform samplerCube u_samplerCube0;","uniform vec4 u_diffuse;","uniform vec4 u_selectColor;","varying vec3 v_position;","varying vec4 v_texCoords;","varying vec3 v_diffuseColor;","varying vec3 v_specularColor;","varying vec3 v_diffuseColorN;","varying vec3 v_specularColorN;","varying vec3 v_normal;","varying vec3 v_cubeTexCoords;","#ifdef FBO ","varying vec4 v_lightSpacePos;","varying vec3 v_worldNormal;","varying vec3 v_worldPos;","uniform vec3 u_shadowLPos;","uniform float u_xPixelOffset;","uniform float u_yPixelOffset;","#endif ","vec4 switchColor = vec4(1.0,1.0,1.0,1.0);","vec4 environment = vec4(1.0);","#ifdef FBO ","float ShadowCalculate(sampler2D sampler,vec4 fragPosLightSpace)","{","   float shadow = 1.0;","\tvec3 proj =fragPosLightSpace.xyz/fragPosLightSpace.w;","   proj = proj *0.5+0.5;","   float currentDepth = proj.z;","   vec3 normal = normalize(v_worldNormal);","   vec3 lightDir = normalize(u_shadowLPos-v_worldPos);","   float bias = max(0.05*(1.0-dot(normal,lightDir)),0.005);","   for(int y=-1; y<=1;y++)","   {","       for(int x=-1; x<=1;x++)","        {","  \t\t\t\t float closeDepth = texture2D(sampler,(proj+vec3(float(x)*u_xPixelOffset,float(y)*u_yPixelOffset,0.05)).xy).x; ","                shadow += (closeDepth<(currentDepth-bias))?0.5:1.0;","         }","    }","   shadow /=16.0;","   shadow += 0.2;","   return shadow;","}","#endif ","vec2 sphereMap(vec3 normal, vec3 ecPosition3)","{","   float m;","   vec3 r;","   vec3 u;","   u = normalize(ecPosition3);","   r = reflect(u, normal);","   m = 2.0 * sqrt(r.x * r.x + r.y * r.y + (r.z + 1.0) * (r.z + 1.0))+0.0001;","   return vec2 (r.x / m + 0.5, r.y / m + 0.5);","}","","void main(void)","{","    if(u_enableClip)","    {","       float dPara = u_clipPlane.w;","\t\tfloat testvalue = (dot(vec3(v_position.xyz),vec3(u_clipPlane.xyz))+dPara);","        if( testvalue<0.0)","        {","            discard;","        }","    }","    if(u_useTex)","    {","        switchColor = texture2D( u_sampler0, v_texCoords.xy );","    }","    if(u_useAmbientTex)","    {","        vec2 sphereCoords = sphereMap(v_normal,v_position);","        environment = texture2D(u_sampler1,sphereCoords.xy);","    }","    if(u_useCubeMapTex)","    {","        environment = textureCube(u_samplerCube0,v_cubeTexCoords.xyz);","    }","    vec4 texColor = switchColor *environment;"," \tfloat shadow = 1.0;","#ifdef FBO ","\t shadow = ShadowCalculate(u_sampler2,v_lightSpacePos);","#endif ","\tfloat alpha = u_diffuse.a;","   if(u_selectColor.y < 0.8)","{","\talpha = 0.3;","}","    if(gl_FrontFacing)","    {","        gl_FragColor = vec4(vec3(texColor)*v_diffuseColor*(shadow)*vec3(u_selectColor)+vec3(v_specularColor)*(shadow),alpha);","    }","    else","    {","        gl_FragColor = vec4(vec3(texColor)*v_diffuseColorN*(shadow)*vec3(u_selectColor)+vec3(v_specularColorN)*(shadow),alpha);","    }","}",""].join("\n"),e.ShaderStrings.MeshPhongVert=["precision highp  float;","attribute vec3 a_position;","attribute vec3 a_normal;","attribute vec3 a_texCoords;","attribute vec3 a_center;","uniform mat4 u_modelMat;","uniform mat4 u_viewMat;","uniform mat4 u_projectionMat;","uniform mat4 u_normalMat;","uniform mat4 u_textureMat;","uniform vec3 u_eyePosition;\n","uniform vec3 u_lightPosition;","varying vec3 v_viewDirection;","varying vec3 v_lightDirection;","varying vec3 v_normal;","varying vec3 v_position;","varying vec4 v_texCoords;","varying vec3 v_center;","varying vec3 v_cubeTexCoords;\n","void main() { ","gl_Position = u_projectionMat * u_viewMat*u_modelMat* vec4(a_position,1.0);","vec4 fvObjectPosition = u_viewMat*u_modelMat* vec4(a_position,1.0);","v_position = fvObjectPosition.xyz/fvObjectPosition.w;","v_texCoords = u_textureMat*vec4(a_texCoords.xy,1.0,1.0);;","v_viewDirection  =vec3(0,0,1)/* normalize( -fvObjectPosition.xyz)*/;","v_lightDirection = normalize(u_lightPosition/*-fvObjectPosition.xyz*/);"," v_normal         = normalize(vec3((u_normalMat * vec4(a_normal,0.0))));"," vec4 worldPos = u_modelMat * vec4(a_position,1.0);\n"," vec3 worldPosT = worldPos.xyz;\n","v_cubeTexCoords =reflect(normalize(worldPosT -u_eyePosition), normalize(a_normal));\n","v_center = a_center;","}"].join("\n"),e.ShaderStrings.MeshPhongFrag=["#extension GL_OES_standard_derivatives : enable \n","precision highp  float;","struct Light","{","    vec4 ambient;","    vec4 diffuse;","    vec4 specular;","    vec4 position;","    vec3 intensity;","};","","struct Materials","{","    vec4 emission;","    vec4 ambient;","    vec4 diffuse;","    vec4 specular;","    float shininess;","};","uniform Light u_lights;","//Materials","uniform Materials u_materials;","uniform vec4 u_diffuse;","uniform bool u_useDiffuseTex;","uniform bool u_useAmbientTex;","uniform bool u_useCubeMapTex;\n","uniform bool u_enableWireframe;","uniform bool u_enableOnlyWireframe;","uniform vec4 u_clipPlane;","uniform bool u_enableClip;","uniform sampler2D u_sampler0;","uniform sampler2D u_sampler1;","uniform samplerCube u_samplerCube0;\n","uniform vec4 u_selectColor;","varying vec3 v_viewDirection;","varying vec3 v_lightDirection;","varying vec3 v_normal;","varying vec3 v_position;","varying vec4 v_texCoords;","varying vec3 v_center;","varying vec3 v_cubeTexCoords;\n","vec4 diffuseTexColor = vec4(1.0,1.0,1.0,1.0);","vec4 environment = vec4(1.0,1.0,1.0,1.0);","vec2 sphereMap(vec3 normal, vec3 ecPosition3)","{","   float m;","   vec3 r;","   vec3 u;","   u = normalize(ecPosition3);","   r = reflect(u, normal);","   m = 2.0 * sqrt(r.x * r.x + r.y * r.y + (r.z + 1.0) * (r.z + 1.0))+0.0001;","   return vec2 (r.x / m + 0.5, r.y / m + 0.5);","}","float edgeFactorTri() {"," vec3 d = fwidth(v_center.xyz);","vec3 a3 = smoothstep(vec3(0.000001), d * 0.8, v_center.xyz);","  return min(min(a3.x, a3.y), a3.z);"," }","void main() { ","    if(u_enableClip)","    {","       float dPara = u_clipPlane.w;","\t\tfloat testvalue = (dot(vec3(v_position.xyz),vec3(u_clipPlane.xyz))+dPara);","        if( testvalue<0.0)","        {","            discard;","        }","    }","float fNDotL =0.000001;","vec3 \thalfvector;","float fNDotH;"," vec3  fvNormal ;","if(gl_FrontFacing){"," fvNormal         = normalize( v_normal );","}","else {"," fvNormal         = normalize( -v_normal );","}"," fNDotL           = clamp((dot( fvNormal, v_lightDirection )),0.2,1.0);","halfvector        =normalize(v_lightDirection+ v_viewDirection );"," fNDotH            = max(0.0,dot(fvNormal,halfvector));","vec3  fvTotalAmbient   = vec3(u_lights.ambient * u_materials.ambient);","vec3  fvTotalDiffuse   = vec3(u_lights.diffuse * fNDotL * u_materials.diffuse); ","vec3  fvTotalSpecular  = vec3(u_lights.specular * u_materials.specular) *( pow( max(fNDotH,0.0), u_materials.shininess));","if(u_useDiffuseTex == true){","   diffuseTexColor = texture2D( u_sampler0, v_texCoords.xy );","}","if(u_useAmbientTex == true)","{","  vec2 sphereCoords = sphereMap(v_normal,v_position);","  environment *= texture2D(u_sampler1,sphereCoords.xy);","}","if(u_useCubeMapTex)\n","{\n","    environment *= textureCube(u_samplerCube0,v_cubeTexCoords.xyz);\n","}\n","diffuseTexColor = diffuseTexColor*environment;","vec4 colorLinear = vec4(min((fvTotalAmbient + fvTotalDiffuse),vec3(1.0))*vec3(diffuseTexColor)*vec3(u_selectColor) + fvTotalSpecular,1.0);","if(u_enableWireframe){","gl_FragColor = vec4(colorLinear.xyz,u_diffuse.a)*vec4(vec3(mix( vec3( 0.0 ), vec3( 1.0 ), edgeFactorTri() )),1.0);","}","else if(u_enableOnlyWireframe){","gl_FragColor = vec4(colorLinear.xyz,u_diffuse.a)*vec4(1.0, 1.0, 1.0,(1.0-edgeFactorTri())*0.95);","}","else{","gl_FragColor = vec4(colorLinear.xyz,u_diffuse.a);","}","}"].join("\n"),e.ShaderStrings.MeshPhongFragMediump=["#extension GL_OES_standard_derivatives : enable \n","precision mediump  float;","precision mediump  int;","struct Light","{","    vec4 ambient;","    vec4 diffuse;","    vec4 specular;","    vec4 position;","    vec3 intensity;","};","","struct Materials","{","    vec4 emission;","    vec4 ambient;","    vec4 diffuse;","    vec4 specular;","    float shininess;","};","uniform Light u_lights;","//Materials","uniform Materials u_materials;","uniform vec4 u_diffuse;","uniform bool u_useDiffuseTex;","uniform bool u_useAmbientTex;","uniform bool u_enableWireframe;","uniform bool u_enableOnlyWireframe;","uniform vec4 u_clipPlane;","uniform bool u_enableClip;","uniform sampler2D u_sampler0;","uniform sampler2D u_sampler1;","uniform vec4 u_selectColor;","varying vec3 v_viewDirection;","varying vec3 v_lightDirection;","varying vec3 v_normal;","varying vec3 v_position;","varying vec4 v_texCoords;","varying vec3 v_center;","vec4 diffuseTexColor = vec4(1.0,1.0,1.0,1.0);","vec4 environment = vec4(1.0,1.0,1.0,1.0);","vec2 sphereMap(vec3 normal, vec3 ecPosition3)","{","   float m;","   vec3 r;","   vec3 u;","   u = normalize(ecPosition3);","   r = reflect(u, normal);","   m = 2.0 * sqrt(r.x * r.x + r.y * r.y + (r.z + 1.0) * (r.z + 1.0))+0.0001;","   return vec2 (r.x / m + 0.5, r.y / m + 0.5);","}","float edgeFactorTri() {"," vec3 d = fwidth(v_center.xyz);","vec3 a3 = smoothstep(vec3(0.0), d * 1.5, v_center.xyz);","  return min(min(a3.x, a3.y), a3.z);"," }","void main() { ","    if(u_enableClip)","    {","       float dPara = u_clipPlane.w;","\t\tfloat testvalue = (dot(vec3(v_position.xyz),vec3(u_clipPlane.xyz))+dPara);","        if( testvalue<0.0)","        {","            discard;","        }","    }","float fNDotL =0.0;","vec3 \thalfvector;","float fNDotH;"," vec3  fvNormal ;","if(gl_FrontFacing){"," fvNormal         = normalize( v_normal );","}","else {"," fvNormal         = normalize( -v_normal );","}"," fNDotL           = clamp((dot( fvNormal, v_lightDirection )),0.2,1.0);","halfvector        =normalize(v_lightDirection+ v_viewDirection );"," fNDotH            = max(0.0,dot(fvNormal,halfvector));","vec3  fvTotalAmbient   = vec3(u_lights.ambient) * vec3(u_materials.ambient);","vec3  fvTotalDiffuse   = vec3(u_lights.diffuse) * fNDotL * vec3(u_materials.diffuse); ","vec3  fvTotalSpecular  = vec3(u_lights.specular) * vec3(u_materials.specular) *( pow( max(fNDotH,0.0), u_materials.shininess) );","if(u_useDiffuseTex == true){","   diffuseTexColor = texture2D( u_sampler0, v_texCoords.xy );","}","if(u_useAmbientTex == true)","{","  vec2 sphereCoords = sphereMap(v_normal,v_position);","  environment = texture2D(u_sampler1,sphereCoords.xy);","}","diffuseTexColor = diffuseTexColor*environment;","vec4 colorLinear = vec4(min((fvTotalAmbient + fvTotalDiffuse),vec3(1.0))*diffuseTexColor*u_selectColor + fvTotalSpecular,1.0);","if(u_enableWireframe){","gl_FragColor = vec4(colorLinear.xyz,u_diffuse.a)*vec4(vec3(mix( vec3( 0.0 ), vec3( 1.0 ), edgeFactorTri() )),1.0);","}","else if(u_enableOnlyWireframe){","gl_FragColor = vec4(colorLinear.xyz,u_diffuse.a)*vec4(1.0, 1.0, 1.0,(1.0-edgeFactorTri())*0.95);","}","else{","gl_FragColor = vec4(colorLinear.xyz,u_diffuse.a);","}","}"].join("\n"),e.ShaderStrings.JewelFrontVert=["attribute vec3 a_position;","attribute vec3 a_normal;","uniform mat4 u_modelMat;","uniform mat4 u_viewMat;","uniform mat4 u_projectionMat;","uniform mat4 u_normalMat;","uniform vec3 u_eyePosition;","uniform vec3 u_lightPosition;","uniform mat4 u_worldNormalMat;","varying vec3 v_position;","varying vec3 v_normal;","varying vec3 v_cubeRefractCoords;","varying vec4 fvObjectPosition;","varying vec3 eyeWorldDirection;","varying vec3 lightWorldDirection;","varying vec3 v_worldNormal;"," void main(void)","{","    gl_Position = u_projectionMat * u_viewMat * u_modelMat * vec4(a_position, 1.0);","    fvObjectPosition = u_viewMat * u_modelMat * vec4(a_position, 1.0);","   //vec4 tempCoords = u_textureMat*vec4(a_texCoords.xyz,1.0);","   v_position = fvObjectPosition.xyz;","    v_normal = normalize(vec3((u_normalMat * vec4(a_normal, 0.0))));","   vec4 worldPos = u_modelMat * vec4(a_position, 1.0);","    vec3 worldPosT = worldPos.xyz;","    eyeWorldDirection = normalize(u_eyePosition - worldPosT);","    lightWorldDirection = normalize(u_lightPosition - worldPosT);","    vec3 worldNormal = vec3(u_worldNormalMat * vec4(a_normal, 0.0));","    v_worldNormal = worldNormal;","    v_cubeRefractCoords = reflect(normalize(worldPosT - u_eyePosition), normalize(worldNormal));","}"].join("\n"),e.ShaderStrings.JewelFrontFrag=["precision highp float;","uniform bool u_useFrontTexture;","uniform bool u_useHighlightTexture;","uniform bool u_useFrontCubeTexture;","uniform sampler2D frontTexture;","uniform sampler2D highlightTexture;","uniform samplerCube frontCubeTexture;","uniform sampler2D depthTexture;","uniform bool u_keepDirection;","uniform vec4 u_diffuse;","uniform vec4 u_selectColor;","varying vec3 v_position;","//varying vec4 v_texCoords;","varying vec3 v_normal;","varying vec3 v_cubeRefractCoords;","varying vec4 fvObjectPosition;","varying vec3 eyeWorldDirection;","varying vec3 lightWorldDirection;","varying vec3 v_worldNormal;","vec4 switchColor = vec4(1.0, 1.0, 1.0, 1.0);","vec4 environment = vec4(1.0, 1.0, 1.0, 1.0);","vec4 environment1 = vec4(1.0, 1.0, 1.0, 1.0);","vec4 environment2 = vec4(1.0, 1.0, 1.0, 1.0);","vec4 highLightColor = vec4(0.0, 0.0, 0.0, 1.0);","vec2 sphereMap(vec3 normal, vec3 ecPosition3)","{","\tfloat m;","\tvec3 r;","\tvec3 u;","\tu = normalize(ecPosition3);","\tr = reflect(u, normal);","\tm = 2.0 * sqrt(r.x * r.x + r.y * r.y + (r.z + 1.0) * (r.z + 1.0)) + 0.0001;","\treturn vec2(r.x / m + 0.5, r.y / m + 0.5);","}","","void main(void)","{","\tvec3 totalAmbient = vec3(0.0, 0.0, 0.0);","\tvec3 totalDiffuse = vec3(0.0, 0.0, 0.0);","\tvec3 totalSpecular = vec3(0.0, 0.0, 0.0);","\tvec3 lightDirection;","\tfloat attenuation = 1.0;","\tvec3 diffuseColor;","\tvec3 specularColor;","\tvec3 vNormal;","\tif (gl_FrontFacing)","\t{","\t\tvNormal = normalize(v_normal);","\t}","\telse","\t{","\t\tvNormal = normalize(-v_normal);","\t}","\tif (u_useFrontTexture == true)","\t{","\t\tvec2 sphereCoords = vec2(1.0, 1.0);","\t\tvec2 matCapCoords = vec2(1.0, 1.0);","\t\tif (u_keepDirection == true)","\t\t{","\t\t\tsphereCoords = sphereMap(normalize(v_worldNormal), v_position);","\t\t\tmatCapCoords = v_worldNormal.xy;","\t\t}","\t\telse","\t\t{","\t\t\tsphereCoords = sphereMap(normalize(v_normal), v_position);","\t\t\tmatCapCoords = v_normal.xy;","\t\t}","\t\tmatCapCoords = matCapCoords * 0.5 + 0.5;","\t\tenvironment1 = texture2D(frontTexture, matCapCoords.xy);","\t}","\tif (u_useHighlightTexture == true)","\t{","\t\tvec2 sphereCoords = sphereMap(normalize(v_normal), v_position);","\t\thighLightColor = texture2D(highlightTexture, sphereCoords.xy);","\t}","\tif (u_useFrontCubeTexture == true)","\t{","\t\tenvironment2 = textureCube(frontCubeTexture, v_cubeRefractCoords.xyz);","\t\tenvironment2.rbg = pow(environment2.rbg, vec3(1.0 / 1.7));","\t}","\tvec4 texColor = switchColor * environment1 * environment2;","\tlightDirection = lightWorldDirection;","\tfloat fNDotL = clamp(abs(dot(vNormal, lightDirection)), 0.3, 1.0);","\tvec3 diffuseReflection =","\t\tvec3(1.0, 1.0, 1.0) * fNDotL;","\ttotalDiffuse = diffuseReflection;","\tvec3 eyeDirection = eyeWorldDirection;","\tvec3 halfVector = normalize(lightDirection + eyeDirection);","\tfloat fNDotH = max(0.0, abs(dot(vNormal, halfVector)));","\tvec3 specularReflection = vec3(1.0) * pow(fNDotH, 10.0);","\tvec3 lightDirection1 = normalize(vec3(vec4(1.0, 0.0, 0.0, 0.0)) - v_position);","\tvec3 lightDirection2 = normalize(vec3(vec4(0.0, -1.0, 0.0, 0.0)) - v_position);","\tvec3 lightDirection3 = normalize(vec3(vec4(0.0, 0.0, 1.0, 0.0)) - v_position);","\tvec3 eyeDirection1 = vec3(0.0, 0.0, 0.0) - v_position;","\tvec3 halfVector1 = normalize(lightDirection1 + eyeDirection1);","\tfloat fNDotH1 = max(0.0, (dot(vNormal, halfVector1)));","\tvec3 specularReflection1 = vec3(1.0) * pow(fNDotH1, 50.0);","\tvec3 eyeDirection2 = eyeDirection1;","\tvec3 halfVector2 = normalize(lightDirection2 + eyeDirection2);","\tfloat fNDotH2 = max(0.0, (dot(vNormal, halfVector2)));","\tvec3 specularReflection2 = vec3(1.0) * pow(fNDotH2, 50.0);","\tvec3 eyeDirection3 = eyeDirection1;","\tvec3 halfVector3 = normalize(lightDirection3 + eyeDirection3);","\tfloat fNDotH3 = max(0.0, (dot(vNormal, halfVector3)));","\tvec3 specularReflection3 = vec3(1.0) * pow(fNDotH3, 50.0);","\ttotalSpecular = totalSpecular + (specularReflection + specularReflection1 + specularReflection2 + specularReflection3);","\tdiffuseColor = min(totalDiffuse, vec3(1.0));","\tspecularColor = min(totalSpecular, vec3(1.0));","\tif (u_useFrontTexture || u_useFrontCubeTexture)","\t{","\t\tif (u_useHighlightTexture == true)","\t\t{","\t\t\tgl_FragColor = vec4(vec3(texColor) * u_diffuse.xyz * vec3(u_selectColor) + highLightColor.rgb, u_diffuse.a);","\t\t}","\t\telse","\t\t{","\t\t\tgl_FragColor = vec4(vec3(texColor) * u_diffuse.xyz * vec3(u_selectColor), u_diffuse.a);","\t\t}","\t\tgl_FragColor.rbg = pow(gl_FragColor.rbg, vec3(1.0 / 1.2));","\t}","\telse","\t{","\t\tgl_FragColor = vec4(vec3(texColor) * diffuseColor * vec3(u_selectColor) + vec3(specularColor), u_diffuse.a);","\t}","}"].join("\n"),e.ShaderStrings.FBODebugVert=["attribute vec3 a_position;","attribute vec2 a_texCoords;","uniform mat4 u_modelMat;","uniform mat4 u_viewMat;","uniform mat4 u_projectionMat;","varying vec2 v_texCoords;","void main()","{","\tgl_Position = u_projectionMat * u_viewMat * u_modelMat * vec4(a_position, 1.0);","\tv_texCoords = a_texCoords;","}"].join("\n"),e.ShaderStrings.FBODebugFrag=["precision highp float;","uniform sampler2D u_sampler0;","varying vec2 v_texCoords;","varying vec3 v_position;","void main()","{","\tvec4 pcolor = texture2D(u_sampler0, v_texCoords);","\tvec4 tcolor = pcolor;","\tgl_FragColor = tcolor;","}"].join("\n"),e.ShaderStrings.DepthVert=["attribute vec3 a_position;","uniform mat4 u_modelMat;","uniform mat4 u_viewMat;","uniform mat4 u_projectionMat;","void main()","{","    gl_Position = u_projectionMat * u_viewMat * u_modelMat * vec4(a_position, 1.0);","}"].join("\n"),e.ShaderStrings.DepthFrag=["precision highp float;","const float PackUpscale = 256. / 255.; // fraction -> 0..1 (including 1)","const vec3 PackFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );","const float ShiftRight8 = 1. / 256.;","vec4 packDepthToRGBA( const in float v ) {","\tvec4 r = vec4( fract( v * PackFactors ), v );","\tr.yzw -= r.xyz * ShiftRight8; // tidy overflow","\treturn r * PackUpscale;","}","","void main()","{","    gl_FragColor = packDepthToRGBA( gl_FragCoord.z );","}"].join("\n"),e.ShaderStrings.JewelBackVert=["attribute vec3 a_position;","attribute vec3 a_normal;","//attribute vec3 a_texCoords;","uniform mat4 u_modelMat;","uniform mat4 u_viewMat;","uniform mat4 u_projectionMat;","uniform mat4 u_normalMat;","//uniform mat4 u_textureMat;","uniform vec3 u_eyePosition;","uniform vec3 u_lightPosition;","uniform mat4 u_worldNormalMat;","varying vec3 v_position;","//varying vec4 v_texCoords;","varying vec3 v_normal;","varying vec3 v_cubeRefractCoords;","varying vec4 fvObjectPosition;","varying vec3 eyeWorldDirection;","varying vec3 lightWorldDirection;","varying vec3 v_worldNormal;","void main(void)","{","\tgl_Position = u_projectionMat * u_viewMat * u_modelMat * vec4(a_position, 1.0);","\tfvObjectPosition = u_viewMat * u_modelMat * vec4(a_position, 1.0);","\t// vec4 tempCoords = u_textureMat*vec4(a_texCoords.xyz,1.0);","\tv_position = fvObjectPosition.xyz;","\t// v_texCoords = tempCoords;","\tv_normal = normalize(vec3((u_normalMat * vec4(a_normal, 0.0))));","\tvec4 worldPos = u_modelMat * vec4(a_position, 1.0);","\tvec3 worldPosT = worldPos.xyz;","\teyeWorldDirection = normalize(u_eyePosition - worldPosT);","\tlightWorldDirection = normalize(u_lightPosition - worldPosT);","\tvec3 worldNormal = vec3(u_worldNormalMat * vec4(a_normal, 0.0));","\tv_worldNormal = worldNormal;","\tv_cubeRefractCoords = reflect(normalize(worldPosT - u_eyePosition), normalize(worldNormal));","}"].join("\n"),e.ShaderStrings.JewelBackFrag=["precision highp float;","uniform bool u_useBackTexture;","uniform bool u_useHighlightTexture;","uniform bool u_useBackCubeTexture;","uniform sampler2D backTexture;","uniform sampler2D highlightTexture;","uniform samplerCube backCubeTexture;","uniform sampler2D depthTexture;","uniform bool u_keepDirection;","uniform vec4 u_diffuse;","uniform vec4 u_selectColor;","varying vec3 v_position;","//varying vec4 v_texCoords;","varying vec3 v_normal;","varying vec3 v_cubeRefractCoords;","varying vec4 fvObjectPosition;","varying vec3 eyeWorldDirection;","varying vec3 lightWorldDirection;","varying vec3 v_worldNormal;","vec4 switchColor = vec4(1.0, 1.0, 1.0, 1.0);","vec4 environment = vec4(1.0, 1.0, 1.0, 1.0);","vec4 environment1 = vec4(1.0, 1.0, 1.0, 1.0);","vec4 environment2 = vec4(1.0, 1.0, 1.0, 1.0);","vec4 highLightColor = vec4(0.0, 0.0, 0.0, 1.0);","vec2 sphereMap(vec3 normal, vec3 ecPosition3)","{","\tfloat m;","\tvec3 r;","\tvec3 u;","\tu = normalize(ecPosition3);","\tr = reflect(u, normal);","\tm = 2.0 * sqrt(r.x * r.x + r.y * r.y + (r.z + 1.0) * (r.z + 1.0)) + 0.0001;","\treturn vec2(r.x / m + 0.5, r.y / m + 0.5);","}","","void main(void)","{","\tvec3 totalAmbient = vec3(0.0, 0.0, 0.0);","\tvec3 totalDiffuse = vec3(0.0, 0.0, 0.0);","\tvec3 totalSpecular = vec3(0.0, 0.0, 0.0);","\tvec3 lightDirection;","\tfloat attenuation = 1.0;","\tvec3 diffuseColor;","\tvec3 specularColor;","\tvec3 vNormal;","\tif (gl_FrontFacing)","\t{","\t\tvNormal = normalize(v_normal);","\t}","\telse","\t{","\t\tvNormal = normalize(-v_normal);","\t}","\tif (u_useBackTexture == true)","\t{","\t\tvec2 sphereCoords = vec2(1.0, 1.0);","\t\tvec2 matCapCoords = vec2(1.0, 1.0);","\t\tif (u_keepDirection == true)","\t\t{","\t\t\tsphereCoords = sphereMap(normalize(v_worldNormal), v_position);","\t\t\tmatCapCoords = v_worldNormal.xy;","\t\t}","\t\telse","\t\t{","\t\t\tsphereCoords = sphereMap(normalize(v_normal), v_position);","\t\t\tmatCapCoords = v_normal.xy;","\t\t}","\t\tmatCapCoords = matCapCoords * 0.5 + 0.5;","\t\tenvironment1 = texture2D(backTexture, matCapCoords.xy);","\t}","\tif (u_useHighlightTexture == true)","\t{","\t\tvec2 sphereCoords = sphereMap(normalize(v_normal), v_position);","\t\thighLightColor = texture2D(highlightTexture, sphereCoords.xy);","\t}","\tif (u_useBackCubeTexture == true)","\t{","\t\tenvironment2 = textureCube(backCubeTexture, v_cubeRefractCoords.xyz);","\t\tenvironment2.rbg = pow(environment2.rbg, vec3(1.0 / 1.7));","\t}","\tvec4 texColor = switchColor * environment1 * environment2;","\tlightDirection = lightWorldDirection;","\tfloat fNDotL = clamp(abs(dot(vNormal, lightDirection)), 0.3, 1.0);","\tvec3 diffuseReflection =","\t\tvec3(1.0, 1.0, 1.0) * fNDotL;","\ttotalDiffuse = diffuseReflection;","\tvec3 eyeDirection = eyeWorldDirection;","\tvec3 halfVector = normalize(lightDirection + eyeDirection);","\tfloat fNDotH = max(0.0, abs(dot(vNormal, halfVector)));","\tvec3 specularReflection = vec3(1.0) * pow(fNDotH, 10.0);","\tvec3 lightDirection1 = normalize(vec3(vec4(1.0, 0.0, 0.0, 0.0)) - v_position);","\tvec3 lightDirection2 = normalize(vec3(vec4(0.0, -1.0, 0.0, 0.0)) - v_position);","\tvec3 lightDirection3 = normalize(vec3(vec4(0.0, 0.0, 1.0, 0.0)) - v_position);","\tvec3 eyeDirection1 = vec3(0.0, 0.0, 0.0) - v_position;","\tvec3 halfVector1 = normalize(lightDirection1 + eyeDirection1);","\tfloat fNDotH1 = max(0.0, (dot(vNormal, halfVector1)));","\tvec3 specularReflection1 = vec3(1.0) * pow(fNDotH1, 50.0);","\tvec3 eyeDirection2 = eyeDirection1;","\tvec3 halfVector2 = normalize(lightDirection2 + eyeDirection2);","\tfloat fNDotH2 = max(0.0, (dot(vNormal, halfVector2)));","\tvec3 specularReflection2 = vec3(1.0) * pow(fNDotH2, 50.0);","\tvec3 eyeDirection3 = eyeDirection1;","\tvec3 halfVector3 = normalize(lightDirection3 + eyeDirection3);","\tfloat fNDotH3 = max(0.0, (dot(vNormal, halfVector3)));","\tvec3 specularReflection3 = vec3(1.0) * pow(fNDotH3, 50.0);","\ttotalSpecular = totalSpecular + (specularReflection + specularReflection1 + specularReflection2 + specularReflection3);","\tdiffuseColor = min(totalDiffuse, vec3(1.0));","\tspecularColor = min(totalSpecular, vec3(1.0));","\tif (u_useBackTexture || u_useBackCubeTexture)","\t{","\t\tif (u_useHighlightTexture == true)","\t\t{","\t\t\tgl_FragColor = vec4(vec3(texColor) * vec3(u_diffuse) * vec3(u_selectColor) + highLightColor.rgb, u_diffuse.a);","\t\t}","\t\telse","\t\t{","\t\t\tgl_FragColor = vec4(vec3(texColor) * vec3(u_diffuse) * vec3(u_selectColor), u_diffuse.a);","\t\t}","\t\tgl_FragColor.rbg = pow(gl_FragColor.rbg, vec3(1.0 / 1.2));","\t}","\telse","\t{","\t\tgl_FragColor = vec4(vec3(texColor) * diffuseColor * vec3(u_selectColor) + vec3(specularColor), u_diffuse.a);","\t}","}"].join("\n"),e.ShaderStrings.RingVert=["attribute vec3 a_position;","attribute vec3 a_normal;","//attribute vec3 a_texCoords;","uniform mat4 u_modelMat;","uniform mat4 u_viewMat;","uniform mat4 u_projectionMat;","uniform mat4 u_normalMat;","//uniform mat4 u_textureMat;","uniform vec3 u_eyePosition;","uniform vec3 u_lightPosition;","uniform mat4 u_worldNormalMat;","varying vec3 v_position;","//varying vec4 v_texCoords;","varying vec3 v_normal;","varying vec3 v_cubeRefractCoords;","varying vec4 fvObjectPosition;","varying vec3 eyeWorldDirection;","varying vec3 lightWorldDirection;","varying vec3 v_worldNormal;","void main(void)","{","\tgl_Position = u_projectionMat * u_viewMat * u_modelMat * vec4(a_position, 1.0);","\tfvObjectPosition = u_viewMat * u_modelMat * vec4(a_position, 1.0);","\tv_position = fvObjectPosition.xyz;","\tv_normal = normalize(vec3((u_normalMat * vec4(a_normal, 0.0))));","\tvec4 worldPos = u_modelMat * vec4(a_position, 1.0);","\tvec3 worldPosT = worldPos.xyz;","\teyeWorldDirection = normalize(u_eyePosition - worldPosT);","\tlightWorldDirection = normalize(u_lightPosition - worldPosT);","\tvec3 worldNormal = vec3(u_worldNormalMat * vec4(a_normal, 0.0));","\tv_worldNormal = worldNormal;","\tv_cubeRefractCoords = reflect(normalize(worldPosT - u_eyePosition), normalize(worldNormal));","}"].join("\n"),e.ShaderStrings.RingFrag=["precision highp float;","uniform bool u_useFrontTexture;","uniform bool u_useFrontCubeTexture;","uniform sampler2D frontTexture;","uniform samplerCube frontCubeTexture;","uniform bool u_useHighlightTexture;","uniform sampler2D highlightTexture;","uniform sampler2D depthTexture;","uniform vec4 u_diffuse;","uniform vec4 u_selectColor;","varying vec3 v_position;","//varying vec4 v_texCoords;","varying vec3 v_normal;","varying vec3 v_cubeRefractCoords;","varying vec4 fvObjectPosition;","varying vec3 eyeWorldDirection;","varying vec3 lightWorldDirection;","varying vec3 v_worldNormal;","vec4 switchColor = vec4(1.0, 1.0, 1.0, 1.0);","vec4 environment = vec4(1.0, 1.0, 1.0, 1.0);","vec4 environment1 = vec4(1.0, 1.0, 1.0, 1.0);","vec4 environment2 = vec4(1.0, 1.0, 1.0, 1.0);","vec4 highLightColor = vec4(0.0, 0.0, 0.0, 1.0);","vec2 sphereMap(vec3 normal, vec3 ecPosition3)","{","\tfloat m;","\tvec3 r;","\tvec3 u;","\tu = normalize(ecPosition3);","\tr = reflect(u, normal);","\tm = 2.0 * sqrt(r.x * r.x + r.y * r.y + (r.z + 1.0) * (r.z + 1.0)) + 0.0001;","\treturn vec2(r.x / m + 0.5, r.y / m + 0.5);","}","","void main(void)","{","\tvec3 totalAmbient = vec3(0.0, 0.0, 0.0);","\tvec3 totalDiffuse = vec3(0.0, 0.0, 0.0);","\tvec3 totalSpecular = vec3(0.0, 0.0, 0.0);","\tvec3 lightDirection;","\tfloat attenuation = 1.0;","\tvec3 diffuseColor;","\tvec3 specularColor;","\tvec3 vNormal;","\tif (gl_FrontFacing)","\t{","\t\tvNormal = normalize(v_normal);","\t}","\telse","\t{","\t\tvNormal = normalize(-v_normal);","\t}","\tif (u_useFrontTexture == true)","\t{","\t\tvec2 matCapCoords = vec2(1.0, 1.0);","\t\tmatCapCoords = vNormal.xy;","\t\tmatCapCoords = matCapCoords * 0.5 + 0.5;","\t\tenvironment1 = texture2D(frontTexture, matCapCoords.xy);","\t}","\tif (u_useFrontCubeTexture == true)","\t{","\t\tenvironment2 = textureCube(frontCubeTexture, v_cubeRefractCoords.xyz);","\t\tenvironment2.rbg = pow(environment2.rbg, vec3(1.0 / 1.7));","\t}","\tif (u_useHighlightTexture == true)","\t{","\t\tvec2 matCapCoords = vec2(1.0, 1.0);","\t\tmatCapCoords = vNormal.xy;","\t\tmatCapCoords = matCapCoords * 0.5 + 0.5;","\t\thighLightColor = texture2D(highlightTexture, matCapCoords.xy);","\t}","\tvec4 texColor = switchColor * environment1 * environment2;","\tif (u_useFrontCubeTexture || u_useFrontTexture)","\t{","\t\tif (u_useHighlightTexture == true)","\t\t{","\t\t\tgl_FragColor = vec4(vec3(texColor) * vec3(u_diffuse) * vec3(u_selectColor) + highLightColor.rgb, u_diffuse.a);","\t\t}","\t\telse","\t\t{","\t\t\tgl_FragColor = vec4(vec3(texColor) * vec3(u_diffuse) * vec3(u_selectColor), u_diffuse.a);","\t\t}","\t\tgl_FragColor.rbg = pow(gl_FragColor.rbg, vec3(1.0 / 1.2));","\t}","\telse","\t{","\t\tgl_FragColor = vec4(vec3(texColor) * diffuseColor * vec3(u_selectColor) + vec3(specularColor), u_diffuse.a);","\t}","}"].join("\n"),e.ShaderStrings.JewelTypeVert=["attribute vec3 a_position;","uniform mat4 u_modelMat;","uniform mat4 u_viewMat;","uniform mat4 u_projectionMat;","","void main(void)","{","\tgl_Position = u_projectionMat * u_viewMat * u_modelMat * vec4(a_position, 1.0);","}"].join("\n"),e.ShaderStrings.JewelTypeFrag=["precision highp float;","uniform float mixFactor;","void main(void)","{","\tgl_FragColor = vec4(0.0, 0.0, 0.0, mixFactor);","}"].join("\n"),e.ShaderStrings.JewelHighLightVert=["attribute vec3 a_position;","attribute vec3 a_normal;","uniform mat4 u_modelMat;","uniform mat4 u_viewMat;","uniform mat4 u_projectionMat;","uniform mat4 u_normalMat;","varying vec3 v_position;","varying vec3 v_normal;","void main(void)","{","\tgl_Position = u_projectionMat * u_viewMat * u_modelMat * vec4(a_position, 1.0);","\tvec4 fvObjectPosition = u_viewMat * u_modelMat * vec4(a_position, 1.0);","\tv_position = fvObjectPosition.xyz / fvObjectPosition.w;","\tv_normal = normalize(vec3((u_normalMat * vec4(a_normal, 0.0))));","}"].join("\n"),e.ShaderStrings.JewelHighLightFrag=["precision highp float;","varying vec3 v_position;","varying vec3 v_normal;","uniform vec3 u_specular;","vec3 lightPoss[4];","vec3 lightSpecular[4];","void main()","{","\tlightPoss[0] = normalize(vec3(-1.0, 0.0, 1.0));","\tlightPoss[1] = normalize(vec3(0.0, 1.0, 0.0));","\tlightPoss[2] = normalize(vec3(1.0, 0.0, 1.0));","\tlightPoss[3] = normalize(vec3(0.0, -1.0, 0.0));","\tlightSpecular[0] = vec3(0.9, 0.9, 0.9);","\tlightSpecular[1] = vec3(0.9, 0.9, 0.9);","\tlightSpecular[2] = vec3(0.9, 0.9, 0.9);","\tlightSpecular[3] = vec3(0.9, 0.9, 0.9);","\tvec3 totalAmbient = vec3(0.0, 0.0, 0.0);","\tvec3 totalDiffuse = vec3(0.0, 0.0, 0.0);","\tvec3 totalSpecular = vec3(0.0, 0.0, 0.0);","\tvec3 lightDirection;","\tfloat attenuation = 1.0;","\tvec3 diffuseColor;","\tvec3 specularColor;","\tvec3 vNormal;","\tif (gl_FrontFacing)","\t{","\t\tvNormal = normalize(v_normal);","\t}","\telse","\t{","\t\tvNormal = normalize(-v_normal);","\t}","\tvec3 viewDir = normalize(v_position);","\tfor (int i = 0; i < 4; i++)","\t{","\t\tvec3 H = normalize(lightPoss[i] - viewDir);","\t\tfloat specular_bsdf = pow(max(dot(vNormal, H), 0.0), 30.0);","\t\ttotalSpecular += lightSpecular[i] * specular_bsdf;","\t}","\tvec3 fragcolor = vec3(0.0);","\tfragcolor = totalSpecular * u_specular.rgb;","\tgl_FragColor = vec4(fragcolor, 1.0);","}"].join("\n"),e.ShaderStrings.JewelBlendQuadVert=["attribute vec3 a_position;","attribute vec2 a_texCoords;","varying vec2 v_texCoords;","","void main(void)","{","\tgl_Position = vec4(a_position, 1.0);","\tv_texCoords = a_texCoords;","}"].join("\n"),e.ShaderStrings.JewelBlendQuadFrag=["precision highp float;","uniform sampler2D u_sampler0;","uniform sampler2D u_sampler1;","uniform sampler2D u_sampler2;","uniform sampler2D u_sampler3;","varying vec2 v_texCoords;","void main()","{","\tvec4 frontColor = texture2D(u_sampler0, v_texCoords);","\tvec4 backColor = texture2D(u_sampler1, v_texCoords);","\tvec4 jewelType = texture2D(u_sampler2, v_texCoords);","\tvec4 highlight = texture2D(u_sampler3, v_texCoords);","\tvec4 FragColor = vec4(0.0);","\tFragColor = vec4(mix(frontColor.rgb, backColor.rgb, jewelType.a) + highlight.rgb * 0.40, frontColor.a);","\tgl_FragColor = FragColor;","}"].join("\n"),e.ShaderStrings.JewelFinalQuadVert=["attribute vec3 a_position;","attribute vec2 a_texCoords;","varying vec2 v_texCoords;","","void main(void)","{","\tgl_Position = vec4(a_position, 1.0);","\tv_texCoords = a_texCoords;","}"].join("\n"),e.ShaderStrings.JewelFinalQuadFrag=["precision highp float;","uniform sampler2D u_sampler0;","uniform sampler2D u_sampler1;","uniform sampler2D u_sampler2;","uniform sampler2D u_sampler3;","varying vec2 v_texCoords;","","","const float UnpackDownscale = 255. / 256.; // 0..1 -> fraction (excluding 1)","","const vec3 PackFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );","const vec4 UnpackFactors = UnpackDownscale / vec4( PackFactors, 1. );","float unpackRGBAToDepth( const in vec4 v ) {","\treturn dot( v, UnpackFactors );","}","","void main()","{","\tvec4 blendColor = texture2D(u_sampler0, v_texCoords);","\tfloat jewelDepth = unpackRGBAToDepth(texture2D(u_sampler1,v_texCoords)); ","\tvec4 ringArmColor = texture2D(u_sampler2, v_texCoords);","\tfloat ringArmDepth = unpackRGBAToDepth(texture2D(u_sampler3,v_texCoords)); ","\tvec4 FragColor = vec4(0.0);","   if(jewelDepth<ringArmDepth)","   {","      FragColor = vec4(blendColor.rgba); ","   }","   else","   {","    FragColor = vec4(ringArmColor.rgba);","   }","\tgl_FragColor = vec4(FragColor.rgba);","}"].join("\n"),e.ShaderStrings.OutlineVert=["precision highp  float;","attribute vec3 a_position;","attribute vec3 a_normal;","uniform mat4 u_modelMat;","uniform mat4 u_viewMat;","uniform mat4 u_projectionMat;","uniform mat4 u_normalMat;","varying vec3 v_position;","void main() { ","   gl_Position = u_projectionMat * u_viewMat*u_modelMat* vec4(a_position,1.0);","   vec4 fvObjectPosition = u_viewMat*u_modelMat* vec4(a_position,1.0);","   v_position = fvObjectPosition.xyz/fvObjectPosition.w;","}"].join("\n"),e.ShaderStrings.OutlineFrag=["#extension GL_OES_standard_derivatives : enable \n","precision highp  float;","uniform vec4 u_diffuse;","uniform vec4 u_clipPlane;","uniform bool u_enableClip;","varying vec3 v_position;","void main() { ","    if(u_enableClip)","    {","       float dPara = u_clipPlane.w;","\t\tfloat testvalue = (dot(vec3(v_position.xyz),vec3(u_clipPlane.xyz))+dPara);","        if( testvalue<0.0)","        {","            discard;","        }","    }","   gl_FragColor =u_diffuse;","}"].join("\n"),e.ShaderStrings.QuadVert=["attribute vec3 a_position;","","void main(void)","{","\tgl_Position = vec4(a_position, 1.0);","}"].join("\n"),e.ShaderStrings.QuadFrag=["precision highp float;","uniform vec4 u_diffuse;","void main()","{","\tgl_FragColor = u_diffuse;","}"].join("\n"),e.ShaderStrings.GaussianBlurVert=["attribute  vec3 a_position;","attribute  vec2 a_texCoords;","varying  vec2 v_texCoords;","","void main(void)","{","    gl_Position = vec4(a_position,1.0);","    v_texCoords = a_texCoords;","}"].join("\n"),e.ShaderStrings.GaussianBlurFrag=["precision highp float;","","varying vec2 v_texCoords;","","uniform sampler2D image;","","uniform bool horizontal;","","uniform float tex_offset;","","void main()","{","float weight[5];","weight[0] = 0.227027;","weight[1] = 0.1945946;","weight[2] = 0.1216216;","weight[3] = 0.054054;","weight[4] = 0.016216;","   ","    vec4 result = texture2D(image, v_texCoords) * weight[0]; // current fragment's contribution","    if (horizontal)","    {","      result += texture2D(image, v_texCoords + vec2(tex_offset * 1.0, 0.0)) * weight[1];","      result += texture2D(image, v_texCoords - vec2(tex_offset * 1.0, 0.0)) * weight[1];","      result += texture2D(image, v_texCoords + vec2(tex_offset * 2.0, 0.0)) * weight[2];","      result += texture2D(image, v_texCoords - vec2(tex_offset * 2.0, 0.0)) * weight[2];","      result += texture2D(image, v_texCoords + vec2(tex_offset * 3.0, 0.0)) * weight[3];","     result += texture2D(image, v_texCoords - vec2(tex_offset * 3.0, 0.0)) * weight[3];","      result += texture2D(image, v_texCoords + vec2(tex_offset * 4.0, 0.0)) * weight[4];","      result += texture2D(image, v_texCoords - vec2(tex_offset * 4.0, 0.0)) * weight[4];","    }","    else","    {","      result += texture2D(image, v_texCoords + vec2(0.0, tex_offset * 1.0)) * weight[1];","      result += texture2D(image, v_texCoords - vec2(0.0, tex_offset * 1.0)) * weight[1];","      result += texture2D(image, v_texCoords + vec2(0.0, tex_offset * 2.0)) * weight[2];","      result += texture2D(image, v_texCoords - vec2(0.0, tex_offset * 2.0)) * weight[2];","      result += texture2D(image, v_texCoords + vec2(0.0, tex_offset * 3.0)) * weight[3];","     result += texture2D(image, v_texCoords - vec2(0.0, tex_offset * 3.0)) * weight[3];","      result += texture2D(image, v_texCoords + vec2(0.0, tex_offset * 4.0)) * weight[4];","     result += texture2D(image, v_texCoords - vec2(0.0, tex_offset * 4.0)) * weight[4];","    }","    gl_FragColor = vec4(result);","}"].join("\n"),e.ShaderStrings.GaussianBlurOutlineVert=["attribute vec3 a_position;","attribute  vec2 a_texCoords;","varying  vec2 v_texCoords;","","void main(void)","{","\tgl_Position = vec4(a_position, 1.0);","    v_texCoords = a_texCoords;","}"].join("\n"),e.ShaderStrings.GaussianBlurOutlineFrag=["precision highp float;","uniform sampler2D height;","uniform sampler2D model;","varying  vec2 v_texCoords;","void main()","{","   vec4 gaussianColor = texture2D(height, v_texCoords);","   vec4 modelColor = texture2D(model, v_texCoords);","  vec4 final = (gaussianColor - modelColor);","  if(final.r<0.0) final.r = 0.0;\n","  if(final.g<0.0) final.g = 0.0;\n","  if(final.b<0.0) final.b = 0.0;\n","  if(final.a<0.0) final.a = 0.0;\n"," ","\tgl_FragColor = vec4(final.rgb*4.0,final.a*4.0);","}"].join("\n"),e.ShaderStrings.CombineOutlineVert=["attribute vec3 a_position;","attribute  vec2 a_texCoords;","varying  vec2 v_texCoords;","","void main(void)","{","\tgl_Position = vec4(a_position, 1.0);","    v_texCoords = a_texCoords;","}"].join("\n"),e.ShaderStrings.CombineOutlineFrag=["precision highp float;","uniform sampler2D u_sampler0;","varying  vec2 v_texCoords;","void main()","{","   vec4 gaussianColor = texture2D(u_sampler0, v_texCoords);","  float alpha = 1.0;"," //  if(gaussianColor.r<=0.0 &&gaussianColor.g<=0.0&&gaussianColor.b<=0.0 ) alpha = 0.0;","\tgl_FragColor = gaussianColor;","}"].join("\n"),e.ShaderStrings.Phong_vert=["#define PHONG","varying vec3 vViewPosition;","varying vec3 vNormal;","#include <common>","#include <uv_pars_vertex>","#include <displacementmap_pars_vertex>","#include <shadowmap_pars_vertex>","#include <clip_pars_vertex>","void main(){","  #include <uv_vertex>","  #include <beginnormal_vertex>","  #include <defaultnormal_vertex>","vNormal = normalize( transformedNormal );","  #include <begin_vertex>","#include <displacementmap_vertex>","  #include <project_vertex>","vViewPosition = - mvPosition.xyz;","  #include <worldpos_vertex>","#include <shadowmap_vertex>","}"].join("\n"),e.ShaderStrings.Phong_frag=["#define PHONG","uniform vec4 diffuse;","uniform vec4 emissive;","uniform vec4 specular;","uniform float shininess;","uniform float opacity;","uniform float selected;","#include <common>","#include <packing>","#include <clip_pars_fragment>","#include <uv_pars_fragment>","#include <map_pars_fragment>","#include <ssao_par_fragment>","#include <emissivemap_pars_fragment>","#include <bsdfs>","#include <lights_pars>","#include <matcap_pars_fragment>","#include <lights_phong_pars_fragment>","#include <normalmap_pars_fragment>","#include <specularmap_pars_fragment>","#include <shadowmap_pars_fragment>\n","void main(){","   #include <clip_fragment>","   vec4 diffuseColor = vec4( diffuse.xyz, diffuse.a );","   ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );","   vec3 totalEmissiveRadiance = emissive.rgb;","   #include <map_fragment>","   #include <specularmap_fragment>","   #include <normal_fragment>","   #include <emissivemap_fragment>","\t#include <lights_phong_fragment>","   #include <lights_template>","\tfloat ssaoFactor = 1.0;","\t#include <ssao_fragment>","\tvec3 outgoingLight = ssaoFactor*(reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular)+ totalEmissiveRadiance ;","   gl_FragColor = vec4(outgoingLight, opacity);","   #include <encodings_fragment>","   if(selected == 0.0){","       gl_FragColor.rgb = gl_FragColor.rgb;","   }else{","       gl_FragColor.rgb = gl_FragColor.rgb * u_selectColor.rgb;","   }","}"].join("\n"),e.ShaderStrings.PBR_vert=["#define PHYSICAL","#define USE_LOCAL_CUBEMAP","uniform float gamma;","varying vec3 vViewPosition;","varying vec3 vNormal;","#include <common>","#include <uv_pars_vertex>","#include <parallax_corrected_cubemap_pars_vertex>","#include <displacementmap_pars_vertex>","#include <shadowmap_pars_vertex>","#include <clip_pars_vertex>","#include <z_depth_pars_vert>","void main(){","  #include <uv_vertex>","  #include <beginnormal_vertex>","  #include <defaultnormal_vertex>","vNormal = normalize( transformedNormal );","  #include <begin_vertex>","#include <displacementmap_vertex>","  #include <project_vertex>","vViewPosition = - mvPosition.xyz;","  #include <worldpos_vertex>"," #include <parallax_corrected_cubemap_vertex>","   #include <shadowmap_vertex>","   #include <z_depth_vert>","}"].join("\n"),e.ShaderStrings.PBR_frag=["#define PHYSICAL","#define USE_LOCAL_CUBEMAP","#define TONE_MAPPING","uniform vec4 diffuse;","uniform vec4 emissive;","uniform float roughness;","vec4 testColor = vec4(0.0);","uniform float metalness;","uniform float opacity;","uniform float gamma;","uniform sampler2D lut;","vec3 test = vec3(1.0,1.0,1.0);","#ifndef STANDARD","uniform float clearCoat;","uniform float clearCoatRoughness;","#endif","varying vec3 vViewPosition;","varying vec3 vNormal;","#include <common>","#include <packing>","#include <clip_pars_fragment>","#include <uv_pars_fragment>","#include <map_pars_fragment>","#include <aomap_pars_fragment>","#include <ssao_par_fragment>","#include <emissivemap_pars_fragment>","#include <parallax_corrected_cubemap_pars_fragment>","#include <envmap_pars_fragment>","#include <bsdfs>","#include <lights_pars>","#include <lights_physical_pars_fragment>","#include <normalmap_pars_fragment>","#include <shadowmap_pars_fragment>","#include <z_depth_pars_frag>","#include <tonemapping_pars_fragment>","#include <metallicRoughness_pars_fragment>","void main(){","#include <z_depth_frag>","   #include <clip_fragment>","   vec4 diffuseColor = vec4( diffuse.xyz, diffuse.a );","   ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );","vec3 totalEmissiveRadiance = emissive.rgb;","   #include <map_fragment>","   #include <metallicRoughness_fragment>","   #include <normal_fragment>","#include <emissivemap_fragment>","\t#include <lights_physical_fragment>","   #include <lights_template>","#include <aomap_fragment>","float ssaoFactor = 1.0;","#include <ssao_fragment>","\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular+ totalEmissiveRadiance ;","//   outgoingLight =OptimizedCineonToneMapping(outgoingLight);","   gl_FragColor = vec4(outgoingLight, opacity);","#include <tonemapping_fragment>","#include <encodings_fragment>","gl_FragColor.rgb = gl_FragColor.rgb*u_selectColor.rgb;","}"].join("\n"),e.ShaderStrings.MatCap_vert=["#define PHONG","varying vec3 vViewPosition;","varying vec3 vNormal;","#include <common>","#include <uv_pars_vertex>","#include <displacementmap_pars_vertex>","#include <shadowmap_pars_vertex>","#include <clip_pars_vertex>","void main(){","  #include <uv_vertex>","  #include <beginnormal_vertex>","  #include <defaultnormal_vertex>","vNormal = normalize( transformedNormal );","  #include <begin_vertex>","#include <displacementmap_vertex>","  #include <project_vertex>","vViewPosition = - mvPosition.xyz;","  #include <worldpos_vertex>","#include <shadowmap_vertex>","}"].join("\n"),e.ShaderStrings.MatCap_frag=["#define PHONG","uniform vec4 diffuse;","uniform vec4 emissive;","uniform vec4 specular;","uniform float shininess;","uniform float opacity;","#include <common>","#include <packing>","#include <clip_pars_fragment>","#include <uv_pars_fragment>","#include <map_pars_fragment>","#include <ssao_par_fragment>","#include <bsdfs>","#include <lights_pars>","#include <matcap_pars_fragment>","#include <lights_phong_pars_fragment>","#include <normalmap_pars_fragment>","#include <specularmap_pars_fragment>","#include <shadowmap_pars_fragment>","void main(){","   #include <clip_fragment>","   vec4 diffuseColor = vec4( diffuse.xyz, diffuse.a );","   ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );","vec3 totalEmissiveRadiance = emissive.rgb;","   #include <map_fragment>","   #include <specularmap_fragment>","   #include <normal_fragment>","\t#include <lights_phong_fragment>","   #include <lights_template>","\tfloat ssaoFactor = 1.0;","\t#include <ssao_fragment>","\tvec3 outgoingLight = ssaoFactor*(reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular)+ totalEmissiveRadiance  ;","   gl_FragColor = vec4(outgoingLight, opacity );","#include <encodings_fragment>","gl_FragColor.rgb = gl_FragColor.rgb*u_selectColor.rgb;","}"].join("\n"),e.ShaderStrings.Depth_vert=["varying vec3 vViewPosition;","#include <common>","#include <clip_pars_vertex>","void main()","{","    #include <begin_vertex>","    #include <project_vertex>","vViewPosition = - mvPosition.xyz;","}"].join("\n"),e.ShaderStrings.Depth_frag=["varying vec3 vViewPosition;","#include <common>","#include <packing>","#include <clip_pars_fragment>","void main()","{","   #include <clip_fragment>","    gl_FragColor = packDepthToRGBA(gl_FragCoord.z);","}"].join("\n"),e.ShaderStrings.Distance_vert=["#include <common>","#include <z_depth_pars_vert>","varying vec3 vWorldPosition;","void main()","{","    #include <begin_vertex>","    #include <project_vertex>","    #include <worldpos_vertex>","    vWorldPosition = worldPosition.xyz;","   #include <z_depth_vert>","}"].join("\n"),e.ShaderStrings.Distance_frag=["#define DISTANCE","uniform vec3 referencePosition;","uniform float nearDistance;","uniform float farDistance;","varying vec3 vWorldPosition;","#include <common>","#include <packing>","#include <z_depth_pars_frag>","","void main()","{","#include <z_depth_frag>","    vec4 diffuseColor = vec4( 1.0 );","float dist = length(vWorldPosition - referencePosition);","dist = (dist - nearDistance) / (farDistance - nearDistance);","dist = saturate(dist); // clamp to [ 0, 1 ]","gl_FragColor = packDepthToRGBA(dist);","}"].join("\n"),e.ShaderStrings.EarlyZCulling_vert=["#include <common>","void main()","{","    #include <begin_vertex>","    #include <project_vertex>","}"].join("\n"),e.ShaderStrings.EarlyZCulling_frag=["#include <common>","","void main()","{","gl_FragColor =vec4(0.0,0.0,0.0,1.0);","}"].join("\n"),e.ShaderStrings.DraggerVert=["//precision highp  float;","attribute vec3 a_position;","attribute vec3 a_normal;","uniform vec4 u_color;","uniform mat4 u_modelMat;","uniform mat4 u_viewMat;","uniform mat4 u_projectionMat;","uniform mat4 u_normalMat;","varying vec4 v_color;","varying vec3 v_normal;","varying vec3 v_position;","void main() { ","gl_Position = u_projectionMat*u_viewMat*u_modelMat*vec4(a_position,1.0);","v_color = u_color;","gl_Position.z = -gl_Position.w;","v_normal = vec3(u_normalMat*vec4(a_normal,0));","v_position = vec3(gl_Position);","}"].join("\n"),e.ShaderStrings.DraggerFrag=["precision mediump  float;","varying vec4 v_color;","varying vec3 v_normal;","varying vec3 v_position;","void main() { ","const vec3 lightPos =  vec3(10.0,10.0,10.0);","const vec3 lightColor =  vec3(1.0,1.0,1.0);","vec3 norm = normalize(v_normal);","vec3 lightDir = normalize(lightPos - v_position);","float diff = max(dot(norm, lightDir), 0.0);","vec3 diffuse = (diff +0.5) * lightColor;","vec4 result = vec4(diffuse.xyz,1.0) * v_color;","gl_FragColor =vec4(result.xyzw);","}"].join("\n"),e.ShaderStrings.NoteEdgeVert=[" precision highp  float;","attribute vec3 a_position;","uniform mat4 u_modelMat;","uniform mat4 u_viewMat;","uniform mat4 u_projectionMat;","varying vec3 v_position;","#ifdef DEPTH_EDGE","varying vec4 v_projectPos;","#endif","void main(){","gl_Position = u_projectionMat *u_viewMat*u_modelMat*vec4(a_position,1.0);","#ifdef DEPTH_EDGE","v_projectPos = u_projectionMat *u_viewMat*u_modelMat*vec4(a_position,1.0);","#endif","vec4 fvObjectPosition = u_viewMat*u_modelMat* vec4(a_position,1.0);","v_position = fvObjectPosition.xyz;","gl_PointSize = 3.0;","}"].join("\n"),e.ShaderStrings.NoteEdgeFrag=["precision highp  float;","uniform vec4 u_diffuse;","uniform vec4 u_clipPlanes[3];","uniform bool u_enableClips[3];","uniform bool u_reverseClip;","uniform bool u_useMinDepth;","#ifdef DEPTH_EDGE","uniform sampler2D u_sampler0;","varying vec4 v_projectPos;","#endif","varying vec3 v_position;","void main() { ","if (u_reverseClip) {","int iEnableNum = 0; ","int iClipNum = 0; ","for (int i = 0; i < 3; i++) {","if (u_enableClips[i]) {","iEnableNum++; ","float dPara = u_clipPlanes[i].w; ","if ((dot(vec3(v_position.xyz), vec3(u_clipPlanes[i].xyz)) + dPara) > 0.0) {","iClipNum++; ","}","}","}","if (iEnableNum == iClipNum && iEnableNum != 0) {","discard; ","}","}","else {","for (int i = 0; i < 3; i++) {","if (u_enableClips[i]) {","float dPara = u_clipPlanes[i].w; ","if ((dot(vec3(v_position.xyz), vec3(u_clipPlanes[i].xyz)) + dPara) < 0.0) {","discard; ","}","}","}","}","#ifdef DEPTH_EDGE","vec3 proj =v_projectPos.xyz/v_projectPos.w;\n ","   proj = proj *0.5+0.5;","float priDepth = texture2D(u_sampler0,proj.xy).x;","if(priDepth<proj.z) discard;","#endif","gl_FragColor = u_diffuse;","}"].join("\n"),e.ShaderStrings.NoteImageVert=["precision highp  float;","attribute vec3 a_position;","attribute vec2 a_texCoords;","uniform mat4 u_modelMat;","uniform mat4 u_viewMat;","uniform mat4 u_projectionMat;","varying vec2 v_texCoords;","varying vec3 v_position;","void main(){","gl_Position = u_projectionMat *u_viewMat*u_modelMat*vec4(a_position,1.0);","vec4 fvObjectPosition = u_viewMat*u_modelMat* vec4(a_position,1.0);","v_position = fvObjectPosition.xyz;","v_texCoords = a_texCoords;","}"].join("\n"),e.ShaderStrings.NoteImageFrag=["precision mediump  float;","precision mediump sampler2D;","uniform sampler2D u_sampler0;","uniform vec4 u_diffuse;","uniform vec4 u_clipPlanes[3];","uniform bool u_enableClips[3];","uniform bool u_reverseClip;","uniform bool u_useMinDepth;","varying vec2 v_texCoords;","varying vec3 v_position;","void main() { ","if (u_reverseClip) {","int iEnableNum = 0; ","int iClipNum = 0; ","for (int i = 0; i < 3; i++) {","if (u_enableClips[i]) {","iEnableNum++; ","float dPara = u_clipPlanes[i].w; ","if ((dot(vec3(v_position.xyz), vec3(u_clipPlanes[i].xyz)) + dPara) > -0.0001) {","iClipNum++; ","}","}","}","if (iEnableNum == iClipNum && iEnableNum != 0) {","discard; ","}","}","else {","for (int i = 0; i < 3; i++) {","if (u_enableClips[i]) {","float dPara = u_clipPlanes[i].w; ","if ((dot(vec3(v_position.xyz), vec3(u_clipPlanes[i].xyz)) + dPara) < 0.0001) {","discard; ","}","}","}","}","vec4 pcolor = texture2D(u_sampler0,v_texCoords);","if (pcolor == vec4(0.0, 0.0, 0.0, 0.0)) {","   discard;","}","vec4 tcolor = pcolor*u_diffuse;","gl_FragColor = vec4(tcolor.xyz,pcolor.a);","}"].join("\n"),e.ShaderLib={Base:{VertexShader:e.ShaderStrings.BaseVert,FragmentShader:e.ShaderStrings.BaseFrag},Dragger:{VertexShader:e.ShaderStrings.DraggerVert,FragmentShader:e.ShaderStrings.DraggerFrag},Background:{VertexShader:e.ShaderStrings.BackgroundVert,FragmentShader:e.ShaderStrings.BackgroundFrag},Multilight:{VertexShader:e.ShaderStrings.MultilightVert,FragmentShader:e.ShaderStrings.MultilightFrag},Axis:{VertexShader:e.ShaderStrings.AxisVert,FragmentShader:e.ShaderStrings.AxisFrag},Edge:{VertexShader:e.ShaderStrings.EdgeVert,FragmentShader:e.ShaderStrings.EdgeFrag},Image:{VertexShader:e.ShaderStrings.ImageVert,FragmentShader:e.ShaderStrings.ImageFrag},CubeMap:{VertexShader:e.ShaderStrings.CubeMapVert,FragmentShader:e.ShaderStrings.CubeMapFrag},MeshPhong:{VertexShader:e.ShaderStrings.MeshPhongVert,FragmentShader:e.ShaderStrings.MeshPhongFrag,FragmentShaderMedium:e.ShaderStrings.MeshPhongFragMediump},JewelFront:{VertexShader:e.ShaderStrings.JewelFrontVert,FragmentShader:e.ShaderStrings.JewelFrontFrag},JewelBack:{VertexShader:e.ShaderStrings.JewelBackVert,FragmentShader:e.ShaderStrings.JewelBackFrag},Ring:{VertexShader:e.ShaderStrings.RingVert,FragmentShader:e.ShaderStrings.RingFrag},JewelType:{VertexShader:e.ShaderStrings.JewelTypeVert,FragmentShader:e.ShaderStrings.JewelTypeFrag},JewelHighLight:{VertexShader:e.ShaderStrings.JewelHighLightVert,FragmentShader:e.ShaderStrings.JewelHighLightFrag},JewelBlendQuad:{VertexShader:e.ShaderStrings.JewelBlendQuadVert,FragmentShader:e.ShaderStrings.JewelBlendQuadFrag},JewelFinalQuad:{VertexShader:e.ShaderStrings.JewelFinalQuadVert,FragmentShader:e.ShaderStrings.JewelFinalQuadFrag},FBODebug:{VertexShader:e.ShaderStrings.FBODebugVert,FragmentShader:e.ShaderStrings.FBODebugFrag},Depth:{VertexShader:e.ShaderStrings.DepthVert,FragmentShader:e.ShaderStrings.DepthFrag},Outline:{VertexShader:e.ShaderStrings.OutlineVert,FragmentShader:e.ShaderStrings.OutlineFrag},Quad:{VertexShader:e.ShaderStrings.QuadVert,FragmentShader:e.ShaderStrings.QuadFrag},GaussianBlur:{VertexShader:e.ShaderStrings.GaussianBlurVert,FragmentShader:e.ShaderStrings.GaussianBlurFrag},GaussianBlurOutline:{VertexShader:e.ShaderStrings.GaussianBlurOutlineVert,FragmentShader:e.ShaderStrings.GaussianBlurOutlineFrag},CombineOutline:{VertexShader:e.ShaderStrings.CombineOutlineVert,FragmentShader:e.ShaderStrings.CombineOutlineFrag},PBR:{VertexShader:e.ShaderStrings.PBRVert,FragmentShader:e.ShaderStrings.PBRFrag},PhongMaterial:{VertexShader:e.ShaderStrings.Phong_vert,FragmentShader:e.ShaderStrings.Phong_frag},PbrMaterial:{VertexShader:e.ShaderStrings.PBR_vert,FragmentShader:e.ShaderStrings.PBR_frag},MatCapMaterial:{VertexShader:e.ShaderStrings.MatCap_vert,FragmentShader:e.ShaderStrings.MatCap_frag},DepthMaterial:{VertexShader:e.ShaderStrings.Depth_vert,FragmentShader:e.ShaderStrings.Depth_frag},DistanceMaterial:{VertexShader:e.ShaderStrings.Distance_vert,FragmentShader:e.ShaderStrings.Distance_frag},EarlyZCullingMaterial:{VertexShader:e.ShaderStrings.EarlyZCulling_vert,FragmentShader:e.ShaderStrings.EarlyZCulling_frag},NoteEdge:{VertexShader:e.ShaderStrings.NoteEdgeVert,FragmentShader:e.ShaderStrings.NoteEdgeFrag},NoteImage:{VertexShader:e.ShaderStrings.NoteImageVert,FragmentShader:e.ShaderStrings.NoteImageFrag},BackGroundImage:{VertexShader:e.ShaderStrings.BackGroundImageVert,FragmentShader:e.ShaderStrings.BackGroundImageFrag}}}(M3D||(M3D={})),function(p){var e=function(h){function u(e){var t=h.call(this,e)||this;t.shaderList=new p.StringDictionary,t.currentAction=null,t.m_shaderStrMap={},t.m_SMTMap={},t.m_currentParameters={},t.m_prefixParameters=[];var r=t.getMaxPrecision("highp");if("highp"!==r){console.warn("Shader:","highp","not supported, using",r,"instead.");var i=p.ShaderLib.MeshPhong.FragmentShader;i=i.replace(/highp/,r);var n=p.ShaderLib.Image.FragmentShader;n=n.replace(/highp/,r);var o=p.ShaderLib.Background.FragmentShader;o=o.replace(/highp/,r);var a=p.ShaderLib.Axis.FragmentShader;a=a.replace(/highp/,r),t.CreateShaderProgramFrmCde(u.MeshPhong,p.ShaderLib.MeshPhong.VertexShader,i),t.CreateShaderProgramFrmCde(u.Image,p.ShaderLib.Image.VertexShader,n),t.CreateShaderProgramFrmCde(u.Background,p.ShaderLib.Background.VertexShader,o),t.CreateShaderProgramFrmCde(u.Axis,p.ShaderLib.Axis.VertexShader,a)}else t.CreateShaderProgramFrmCde(u.MeshPhong,p.ShaderLib.MeshPhong.VertexShader,p.ShaderLib.MeshPhong.FragmentShader),t.CreateShaderProgramFrmCde(u.Background,p.ShaderLib.Background.VertexShader,p.ShaderLib.Background.FragmentShader),t.CreateShaderProgramFrmCde(u.Axis,p.ShaderLib.Axis.VertexShader,p.ShaderLib.Axis.FragmentShader),t.CreateShaderProgramFrmCde(u.Image,p.ShaderLib.Image.VertexShader,p.ShaderLib.Image.FragmentShader);t.CreateShaderProgramFrmCde(u.Image,p.ShaderLib.Dragger.VertexShader,p.ShaderLib.Dragger.FragmentShader);for(var s=["shaderType","precision","emissiveMap","ambientMap","diffuseMap","specularMap","normalMap","displacementMap","envMap","albedoMap","metallicRoughnessMap","ambientOcclusiontMap","envIrradianceMap","numAllLights","numDirectionalLights","numPointLights","numSpotLights","numHemisphereLights","shadowMapEnabled","shadowMapType","doubleSided","outputEncoding","diffuseMapEncoding","envMapEncoding","ssao","matcapMap","useClearCoat"],l=0;l<27;l++)t.m_prefixParameters.push(s[l]),t.m_currentParameters[s[l]]="N";return t}return __extends(u,h),u.prototype.GetEffect=function(e){var t=this.shaderList.get(e);return void 0!==t?t:p.ShaderLib.hasOwnProperty(e)?this.CreateShaderProgramFrmCde(e,p.ShaderLib[e].VertexShader,p.ShaderLib[e].FragmentShader):null},u.prototype.CreateShaderProgramFrmCde=function(e,t,r){var i=this.shaderList.get(e);if(void 0!==i)return i;var n=new p.Shader(this.gl,this.gl.VERTEX_SHADER),o=new p.Shader(this.gl,this.gl.FRAGMENT_SHADER);n.CompileSourceCode(t),o.CompileSourceCode(r);var a=new p.ShaderProgram(this.gl,n,o);if(a.LinkProgram())return this.shaderList.add(e,a),a.SetName(name),a;console.log("End: "+e)},u.prototype.GetCurrentAction=function(){return this.currentAction},u.prototype.SetCurrentAction=function(e){this.currentAction=e},u.prototype.getMaxPrecision=function(e){if("highp"===e){if(0<this.gl.getShaderPrecisionFormat(p.GL.VERTEX_SHADER,p.GL.HIGH_FLOAT).precision&&0<this.gl.getShaderPrecisionFormat(p.GL.FRAGMENT_SHADER,p.GL.HIGH_FLOAT).precision)return"highp";e="mediump"}return"mediump"===e&&0<this.gl.getShaderPrecisionFormat(p.GL.VERTEX_SHADER,p.GL.MEDIUM_FLOAT).precision&&0<this.gl.getShaderPrecisionFormat(p.GL.FRAGMENT_SHADER,p.GL.MEDIUM_FLOAT).precision?"mediump":"lowp"},u.prototype.FilterEmptyLine=function(e){return""!==e},u.prototype.GenerateExtensions=function(e){return["Y"===e.envMap&&p.RenderContext.GetExtension(this.gl,"EXT_shader_texture_lod")?"#extension GL_EXT_shader_texture_lod : enable":"","Y"===e.normalMap?"#extension GL_OES_standard_derivatives : enable":""].filter(this.FilterEmptyLine).join("\n")},u.prototype.ReplaceLightNums=function(e,t){return e.replace(/NUM_DIR_LIGHTS/g,t.numDirectionalLights).replace(/NUM_SPOT_LIGHTS/g,t.numSpotLights).replace(/NUM_POINT_LIGHTS/g,t.numPointLights).replace(/NUM_HEMI_LIGHTS/g,t.numHemisphereLights)},u.prototype.ParseIncludes=function(e){var i=this;return e.replace(/^[ \t]*#include +<([\w\d.]+)>/gm,function(e,t){var r=p.ShaderChunkStrings[t];if(void 0===r)throw new Error("Can not resolve #include <"+t+">");return i.ParseIncludes(r)})},u.prototype.GetProgramCode=function(e){var t=e.GetMaterialType(),r=[];if(r.push(e.GetMaterialTypeStr(t)),t===p.MaterialType.MaterialType_Shader){var i=e;r.push(i.VertexShader()),r.push(i.FragmentShader())}for(var n=0,o=this.m_prefixParameters;n<o.length;n++){var a=o[n];r.push(this.m_currentParameters[a])}return r.join(",")},u.prototype.AcquireProgram=function(e,t,r,i){var n=null;return null==(n=this.shaderList.get(i))&&(n=this.CreateShaderProgram(this.gl,e,t,r,i)),n},u.prototype.GenerateDefines=function(e){var t=[];for(var r in e){var i=e[r];!1!==i&&t.push(i)}return t.join("\n")},u.prototype.CreateShaderProgram=function(e,t,r,i,n){var o=r,a=i,s="ENVTEXTURE_TYPE_CUBE",l="ENVTEXTURE_MODE_REFLECTION",h={envTextureTypeDefine:s,envTextureModeDefine:l};this.SetEnvTexture(t,s,l);var u=this.GenerateExtensions(this.m_currentParameters),p=this.GenerateDefines(t.Define()),c=this.GetPrefixShader(this.m_currentParameters,2.2,p,u,h);o=this.ParseIncludes(o),o=this.ReplaceLightNums(o,this.m_currentParameters),a=this.ParseIncludes(a),a=this.ReplaceLightNums(a,this.m_currentParameters);var d=c.prefixVertex+o,S=c.prefixFragment+"\n"+a;return this.CreateShaderProgramFrmCdeNew(n,d,S)},u.prototype.GetEncodingCompents=function(e){var t=[];switch(e){case p.TextureEncodingType.TEXEL_ENCODING_TYPE_LINEAR:t.push("Linear"),t.push("( value )");case p.TextureEncodingType.TEXEL_ENCODING_TYPE_SRGB:t.push("sRGB"),t.push("( value )");case p.TextureEncodingType.TEXEL_ENCODING_TYPE_RGBE:t.push("RGBE"),t.push("( value )");case p.TextureEncodingType.TEXEL_ENCODING_TYPE_RGBM7:t.push("RGBM"),t.push("( value, 7.0 )");case p.TextureEncodingType.TEXEL_ENCODING_TYPE_RGBM16:t.push("RGBM"),t.push("( value, 16.0 )");case p.TextureEncodingType.TEXEL_ENCODING_TYPE_RGBD:t.push("RGBD"),t.push("( value, 256.0 )");case p.TextureEncodingType.TEXEL_ENCODING_TYPE_GAMMA:t.push("Gamma"),t.push("( value, float( GAMMA_FACTOR ) )");default:return t}},u.prototype.GetTexelDecodingFunction=function(e,t){var r=this.GetEncodingCompents(t);return"vec4 "+e+"( vec4 value )\n{\n return "+r[0]+"ToLinear"+r[1]+";\n}\n"},u.prototype.GetTexelEncodingFunction=function(e,t){var r=this.GetEncodingCompents(t);return"vec4 "+e+"( vec4 value )\n{\n return LinearTo"+r[0]+r[1]+";\n}\n"},u.prototype.CreateShaderProgramFrmCdeNew=function(e,t,r){var i=this.shaderList.get(e);if(void 0!==i)return i;var n=new p.Shader(this.gl,this.gl.VERTEX_SHADER),o=new p.Shader(this.gl,this.gl.FRAGMENT_SHADER);n.CompileSourceCode(t),o.CompileSourceCode(r);var a=new p.ShaderProgram(this.gl,n,o);if(a.LinkProgram())return this.shaderList.add(e,a),a.SetName(e),a;console.log("End: "+e)},u.prototype.GetPrefixShader=function(e,t,r,i,n){var o=2==p.Parameters.Instance().m_shadowMapType?"SHADOWMAP_TYPE_PCF\n":1==p.Parameters.Instance().m_shadowMapType?" SHADOWMAP_TYPE_BASE\n":"SHADOWMAP_TYPE_PCF_SOFT\n";return{prefixVertex:["precision "+e.precision+" float;\n","precision "+e.precision+" int;\n","#define SHADER_NAME "+e.shaderType,i,r,"#define GAMMA_FACTOR "+t,"N"!=e.diffuseMap||"N"!=e.albedoMap?"#define USE_DIFFUSEMAP\n":"","N"!=e.envMap?"#define USE_ENV_TEXTURE\n":"","N"!=e.envMap?"#define "+n.envTextureModeDefine+"\n":"","N"!=e.ambientOcclusiontMap?"#define USE_AOMAP\n":"","N"!=e.emissiveMap?"#define USE_EMISSIVEMAP\n":"","N"!=e.normalMap?"#define USE_NORMALMAP\n":"","N"!=e.displacementMap?"#define USE_DISPLACEMENTMAP\n":"","N"!=e.specularMap?"#define USE_SPECULARMAP\n":"","N"!=e.metallicRoughnessMap?"#define USE_METALLIC_ROUGHNESS_TEXTURE\n":"",("N"!=e.doubleSided?"#define DOUBLE_SIDED\n":"")+("N"!=e.shadowMapEnabled&&"0"!=e.numAllLights?"#define USE_SHADOWMAP\n":""),"N"!=e.shadowMapEnabled&&"0"!=e.numAllLights?"#define "+o+"\n":"","uniform mat4 modelMatrix;\n","uniform mat4 u_worldNormalMat;\n","uniform mat4 projectionMatrix;\n","uniform mat4 viewMatrix;\n","uniform mat4 normalMatrix;\n","uniform mat4 u_textureMat;\n","uniform vec3 cameraPosition;\n","attribute vec3 a_position;\n","attribute vec3 a_normal;\n","attribute vec3 a_texCoords;\n","attribute vec3 a_center;\n"].filter(this.FilterEmptyLine).join("\n"),prefixFragment:[i,"precision "+e.precision+" float;","precision "+e.precision+" int;",r,"#define USE_CLIP","#define SHADER_NAME "+e.shaderType,"#define GAMMA_FACTOR "+t,"N"!=e.diffuseMap||"N"!=e.albedoMap?"#define USE_DIFFUSEMAP\n":"","N"!=e.envMap?"#define USE_ENV_TEXTURE\n":"","N"!=e.envMap?"#define "+n.envTextureTypeDefine+"\n":"","N"!=e.envMap?"#define "+n.envTextureModeDefine+"\n":"","N"!=e.ambientOcclusiontMap?"#define USE_AOMAP\n":"","N"!=e.emissiveMap?"#define USE_EMISSIVEMAP\n":"","N"!=e.normalMap?"#define USE_NORMALMAP\n":"","N"!=e.matcapMap?"#define USE_MATCAPMAP\n":"","N"!=e.specularMap?"#define USE_SPECULARMAP\n":"","N"!=e.metallicRoughnessMap?"#define USE_METALLIC_ROUGHNESS_TEXTURE\n":"","N"!=e.doubleSided?"#define DOUBLE_SIDED\n":"","N"!=e.ssao?"#define SSAO\n":"","N"!=e.shadowMapEnabled&&"0"!=e.numAllLights?"#define USE_SHADOWMAP\n":"","N"!=e.shadowMapEnabled&&"0"!=e.numAllLights?"#define "+o+"\n":"","N"!=e.envMap&&p.RenderContext.GetExtension(this.gl,"EXT_shader_texture_lod")?"#define TEXTURE_LOD_EXT\n":"","N"!=e.outputEncoding||"N"!=e.diffuseMapEncoding||"N"!=e.envMap?p.ShaderChunkStrings.encodings_pars_fragment:"","N"!=e.diffuseMapEncoding?this.GetTexelDecodingFunction("mapTexelToLinear",parseInt(e.diffuseMapEncoding)):"","N"!=e.envMap?this.GetTexelDecodingFunction("envMapTexelToLinear",parseInt(e.envMapEncoding)):"","N"!=e.outputEncoding?this.GetTexelEncodingFunction("linearToOutputTexel",parseInt(e.outputEncoding)):"","uniform vec3 cameraPosition;","uniform vec4 u_selectColor;","uniform mat4 viewMatrix;","uniform bool u_enableWireframe;","uniform bool u_enableOnlyWireframe;"].filter(this.FilterEmptyLine).join("\n")}},u.prototype.ResetParameters=function(){for(var e=0,t=this.m_prefixParameters.length;e<t;e++)this.m_currentParameters[this.m_prefixParameters[e]]="N"},u.prototype.CreateParameters=function(e,t){this.ResetParameters();var r=e.GetMaterialType();switch(this.m_currentParameters.shaderType=r.toString(),r){case p.MaterialType.MaterialType_Phong:var i=e;i&&(this.m_currentParameters.outputEncoding=this.GetTextureEncodingFromMap(null,i.IsGammaOutpute()).toString(),this.m_currentParameters.ambientMap=i.GetAmbientMap()?"Y":"N",this.m_currentParameters.diffuseMap=i.GetDiffuseMap()?"Y":"N",this.m_currentParameters.specularMap=i.GetSpecularMap()?"Y":"N",this.m_currentParameters.displacementMap=i.GetDisplacementMap()?"Y":"N",this.m_currentParameters.emissiveMap=i.GetEmissiveMap()?"Y":"N",this.m_currentParameters.normalMap=i.GetNormalMap()?"Y":"N",this.m_currentParameters.matcapMap=i.GetMatcapMap()?"Y":"N",this.m_currentParameters.envMap=i.GetEvnMap()?"Y":"N",i.GetDiffuseMap()?this.m_currentParameters.diffuseMapEncoding=this.GetTextureEncodingFromMap(i.GetDiffuseMap(),!!i.GetDiffuseMap().GetOGLObj()&&i.GetDiffuseMap().IsGammaInput()).toString():this.m_currentParameters.diffuseMapEncoding="0",i.GetEvnMap()?this.m_currentParameters.envMapEncoding=this.GetTextureEncodingFromMap(i.GetEvnMap(),!!i.GetEvnMap()&&i.GetEvnMap().IsGammaInput()).toString():this.m_currentParameters.envMapEncoding="0");break;case p.MaterialType.MaterialType_Pbr:var n=e;n&&(this.m_currentParameters.outputEncoding=this.GetTextureEncodingFromMap(null,n.IsGammaOutpute()).toString(),this.m_currentParameters.albedoMap=n.AlbedoMap()?"Y":"N",this.m_currentParameters.metallicRoughnessMap=n.MetalnessRoughnessMap()?"Y":"N",this.m_currentParameters.emissiveMap=n.EmissiveMap()?"Y":"N",this.m_currentParameters.normalMap=n.NormalMap()?"Y":"N",this.m_currentParameters.displacementMap=n.DisplacementMap()?"Y":"N",this.m_currentParameters.envIrradianceMap=(n.EnvIrradianceMap(),"Y"),this.m_currentParameters.envMap=(n.EnvMap(),"Y"),this.m_currentParameters.ambientOcclusiontMap=n.AmbientOcclusiontMap()?"Y":"N",this.m_currentParameters.diffuseMapEncoding=this.GetTextureEncodingFromMap(n.AlbedoMap(),!n.AlbedoMap()||n.AlbedoMap().IsGammaInput()).toString(),this.m_currentParameters.envMapEncoding=this.GetTextureEncodingFromMap(n.EnvMap(),!n.EnvMap()||n.EnvMap().IsGammaInput()).toString(),this.m_currentParameters.useClearCoat=n.UseClearCoat()?"Y":"N");break;case p.MaterialType.MaterialType_MatCap:var o=e;this.m_currentParameters.outputEncoding=this.GetTextureEncodingFromMap(null,o.IsGammaOutpute()).toString(),this.m_currentParameters.normalMap=o.GetNormalMap()?"Y":"N",this.m_currentParameters.matcapMap=o.GetMatcapMap()?"Y":"N",this.m_currentParameters.diffuseMapEncoding=this.GetTextureEncodingFromMap(o.GetDiffuseMap(),!!o.GetDiffuseMap()&&o.GetDiffuseMap().IsGammaInput()).toString(),this.m_currentParameters.envMapEncoding=this.GetTextureEncodingFromMap(o.GetEvnMap(),!o.GetEvnMap()||o.GetEvnMap().IsGammaInput()).toString()}this.m_currentParameters.numDirectionalLights=t.DirectionalLightNumber().toString(),this.m_currentParameters.numPointLights=t.PointLightNumber().toString(),this.m_currentParameters.numSpotLights=t.SpotLightNumber().toString(),this.m_currentParameters.numHemisphereLights=t.HemisphereLightNumber().toString(),this.m_currentParameters.numAllLights=(t.DirectionalLightNumber()+t.PointLightNumber()+t.SpotLightNumber()+t.HemisphereLightNumber()).toString(),this.m_currentParameters.shadowMapEnabled=p.Parameters.Instance().m_shadowMapEnabled?"Y":"N",this.m_currentParameters.doubleSided=p.Parameters.Instance().m_doubleSided?"Y":"N",this.m_currentParameters.precision="highp",this.m_currentParameters.ssao=p.Parameters.Instance().m_useSSAO?"Y":"N"},u.prototype.GetTextureEncodingFromMap=function(e,t){var r=p.TextureEncodingType.TEXEL_ENCODING_TYPE_GAMMA;return e?e&&(r=e.TextureEncoding()):r=p.TextureEncodingType.TEXEL_ENCODING_TYPE_LINEAR,r==p.TextureEncodingType.TEXEL_ENCODING_TYPE_LINEAR&&t&&(r=p.TextureEncodingType.TEXEL_ENCODING_TYPE_GAMMA),r},u.prototype.SetEnvTexture=function(e,t,r){if("Y"===this.m_currentParameters.envMap)if(e.GetMaterialType()==p.MaterialType.MaterialType_Phong){var i=e;switch(i.GetEnvTextureMapping()){case p.EnvTextureMappingType.CubeReflectionMapping:case p.EnvTextureMappingType.CubeRefractionMapping:t.envMapTypeDefine="ENVTEXTURE_TYPE_CUBE";break;case p.EnvTextureMappingType.CubeUVReflectionMapping:case p.EnvTextureMappingType.CubeUVRefractionMapping:t.envMapTypeDefine="ENVTEXTURE_TYPE_CUBE_UV";break;case p.EnvTextureMappingType.EquirectangularReflectionMapping:case p.EnvTextureMappingType.EquirectangularRefractionMapping:t.envMapTypeDefine="ENVTEXTURE_TYPE_EQUIREC";break;case p.EnvTextureMappingType.SphericalReflectionMapping:t.envMapTypeDefine="ENVTEXTURE_TYPE_SPHERE"}switch(i.GetEnvTextureMapping()){case p.EnvTextureMappingType.CubeRefractionMapping:case p.EnvTextureMappingType.EquirectangularRefractionMapping:r.envMapModeDefine="ENVTEXTURE_MODE_REFRACTION"}}else if(e.GetMaterialType()==p.MaterialType.MaterialType_Pbr){var n=e;switch(n.EnvTextureMapping()){case p.EnvTextureMappingType.CubeReflectionMapping:case p.EnvTextureMappingType.CubeRefractionMapping:t.envMapTypeDefine="ENVTEXTURE_TYPE_CUBE";break;case p.EnvTextureMappingType.CubeUVReflectionMapping:case p.EnvTextureMappingType.CubeUVRefractionMapping:t.envMapTypeDefine="ENVTEXTURE_TYPE_CUBE_UV";break;case p.EnvTextureMappingType.EquirectangularReflectionMapping:case p.EnvTextureMappingType.EquirectangularRefractionMapping:t.envMapTypeDefine="ENVTEXTURE_TYPE_EQUIREC";break;case p.EnvTextureMappingType.SphericalReflectionMapping:t.envMapTypeDefine="ENVTEXTURE_TYPE_SPHERE"}switch(n.EnvTextureMapping()){case p.EnvTextureMappingType.CubeRefractionMapping:case p.EnvTextureMappingType.EquirectangularRefractionMapping:r.envMapModeDefine="ENVTEXTURE_MODE_REFRACTION"}}},u.Base="Base",u.MeshPhong="MeshPhong",u.BaseVertex="BaseVertex",u.Background="Background",u.Wireframe="Wireframe",u.Edge="Edge",u.Brdf="Brdf",u.LightWithoutTexture="LightWithoutTexture",u.LightWithTexture="LightWithTexture",u.Axis="Axis",u.Dragger="Dragger",u.Image="Image",u.Multilight="Multilight",u.CubeMap="CubeMap",u.DepthMap="DepthMap",u.FBODebug="FBODebug",u.PlaneShadow="PlaneShadow",u.Blur="Blur",u.Specular="Specular",u.EdgeDetection="EdgeDetection",u.NoteEdge="NoteEdge",u.NoteImage="NoteImage",u.JewelFront="JewelFront",u.JewelBack="JewelBack",u.JewelType="JewelType",u.JewelHighLight="JewelHighLight",u.JewelBlendQuad="JewelBlendQuad",u.JewelFinalQuad="JewelFinalQuad",u.Ring="Ring",u.Depth="Depth",u.Outline="Outline",u.Quad="Quad",u.GaussianBlur="GaussianBlur",u.GaussianBlurOutline="GaussianBlurOutline",u.CombineOutline="CombineOutline",u.SceneGround="SceneGround",u.SsaoEffect="SsaoEffect",u.SsaoBlur="SsaoBlur",u}(p.GPUObject);p.ShaderManager=e}(M3D||(M3D={})),function(e){var t=function(e,t,r,i){void 0===i&&(i=1),this.location=0,this.name="",this.size=1,this.location=e,this.type=t,this.name=r,this.size=i};(M3D||(M3D={})).ShaderParameter=t}(),function(h){var e;(e=h.ShaderMaterialType||(h.ShaderMaterialType={}))[e.SMT_MultiLight=0]="SMT_MultiLight",e[e.SMT_Brdf=1]="SMT_Brdf",e[e.SMT_DepthMap=2]="SMT_DepthMap",e[e.SMT_Image=3]="SMT_Image",e[e.SMT_FBODebug=4]="SMT_FBODebug",e[e.SMT_CubeMap=5]="SMT_CubeMap",e[e.SMT_BaseVertex=6]="SMT_BaseVertex",e[e.SMT_Background=7]="SMT_Background",e[e.SMT_Axis=8]="SMT_Axis",e[e.SMT_Dragger=9]="SMT_Dragger",e[e.SMT_Edge=10]="SMT_Edge",e[e.SMT_PlaneShadow=11]="SMT_PlaneShadow",e[e.SMT_Blur=12]="SMT_Blur",e[e.SMT_Specular=13]="SMT_Specular",e[e.SMT_EdgeDetection=14]="SMT_EdgeDetection",e[e.SMT_Quad=15]="SMT_Quad",e[e.SMT_MultilightPerFrag=16]="SMT_MultilightPerFrag",e[e.SMT_NoteEdge=17]="SMT_NoteEdge",e[e.SMT_NoteImage=18]="SMT_NoteImage",e[e.SMT_CapPlane=19]="SMT_CapPlane",e[e.SMT_JewelFront=20]="SMT_JewelFront",e[e.SMT_JewelBack=21]="SMT_JewelBack",e[e.SMT_JewelFinalQuad=22]="SMT_JewelFinalQuad",e[e.SMT_Ring=23]="SMT_Ring",e[e.SMT_JewelType=24]="SMT_JewelType",e[e.SMT_JewelHighLight=25]="SMT_JewelHighLight",e[e.SMT_JewelBlendQuad=26]="SMT_JewelBlendQuad",e[e.SMT_Outline=27]="SMT_Outline",e[e.SMT_GaussianBlur=28]="SMT_GaussianBlur",e[e.SMT_GaussianBlurOutline=29]="SMT_GaussianBlurOutline",e[e.SMT_CombineOutline=30]="SMT_CombineOutline",e[e.SMT_SceneGround=31]="SMT_SceneGround",e[e.SMT_SsaoEffect=32]="SMT_SsaoEffect",e[e.SMT_SsaoBlur=33]="SMT_SsaoBlur";var t=function(n){function e(e,t,r){var i=n.call(this,e)||this;return i.program=null,i.vsh=null,i.fsh=null,i.dirty=!1,i.shaderUniformMap=new h.StringDictionary,i.shaderAttributeMap=new h.StringDictionary,i.isLinked=!1,i.shaderUniformKeyArry=[],i.shaderUniformValueArray=[],i.CreateShaderProgram(),i.vsh=t,i.fsh=r,i.AddShader(t),i.AddShader(r),i}return __extends(e,n),e.prototype.GetShaderUniformKeyValueArray=function(){var r=this,e={key:this.shaderUniformKeyArry,value:this.shaderUniformValueArray};return 0<this.shaderUniformKeyArry.length||this.shaderUniformMap.forEach(function(e,t){r.shaderUniformKeyArry.push(e),r.shaderUniformValueArray.push(t)}),e},e.prototype.GetShaderUniformMap=function(){return this.shaderUniformMap},e.prototype.IsDirty=function(){return this.dirty},e.prototype.MakeDirty=function(){this.dirty=!0},e.prototype.AddShader=function(e){var t=!1;return e.IsCompiled()?(null!==this.program&&(this.gl.attachShader(this.program,e.ShaderObject()),this.gl.VERTEX_SHADER===e.GetShaderType()?this.vsh=e:this.gl.FRAGMENT_SHADER===e.GetShaderType()&&(this.fsh=e),t=!0),t):t=!1},e.prototype.GetShaderProgram=function(){return this.program},e.prototype.LinkProgram=function(){return null!==this.vsh||null!==this.fsh||this.vsh.IsCompiled()||this.fsh.IsCompiled()?(this.gl.linkProgram(this.program),this.gl.getProgramParameter(this.program,this.gl.LINK_STATUS)?(this.isLinked=!0,this.MakeDirty()):""!==this.gl.getProgramInfoLog(this.program)&&(console.log("M3DJS Program Info: ",this.gl.getProgramInfoLog(this.program)),this.isLinked=!1,this.gl.deleteProgram(this.program)),this.vsh.DeleteShader(),this.fsh.DeleteShader()):this.isLinked=!1,this.isLinked},e.prototype.UseProgram=function(){if(this.IsDirty()){var e=0;if(this.shaderAttributeMap.clear(),this.shaderUniformMap.clear(),this.isLinked){this.gl.useProgram(this.program);this.gl.FLOAT;var t,r=void 0,i=void 0,n=void 0,o=void 0;e=this.gl.getProgramParameter(this.program,this.gl.ACTIVE_UNIFORMS);for(var a=0;a<e;a++){n=(i=(r=this.gl.getActiveUniform(this.program,a)).name).indexOf("[0]"),o=i.indexOf("."),-1!==n&&-1===o&&(i=i.substring(0,n)),t=this.gl.getUniformLocation(this.program,i);var s=new h.ShaderParameter(t,r.type,i);this.shaderUniformMap.add(i,s)}e=0,this.gl.FLOAT,e=this.gl.getProgramParameter(this.program,this.gl.ACTIVE_ATTRIBUTES);for(var l=0;l<e;l++){n=(i=(r=this.gl.getActiveAttrib(this.program,l)).name).indexOf("[0]"),o=i.indexOf("."),-1!==n&&-1===o&&(i=i.substring(0,n)),t=this.gl.getAttribLocation(this.program,i);s=new h.ShaderParameter(t,r.type,i);this.shaderAttributeMap.add(i,s)}this.dirty=!1}}else this.gl.useProgram(this.program)},e.prototype.CreateShaderProgram=function(){this.program=this.gl.createProgram()},e.prototype.ReleaseShaderProgram=function(){this.gl.useProgram(null)},e.prototype.DeleteShaderProgram=function(){this.isLinked=!1},e.prototype.GetAttributeLocation=function(e){return this.gl.getAttribLocation(this.program,e)},e.prototype.GetUniformLocation=function(e){return this.gl.getUniformLocation(this.program,e)},e.prototype.BindAttributeLocation=function(e,t){this.gl.bindAttribLocation(this.program,t,e)},e.prototype.EnableAttributeArray=function(e){this.gl.enableVertexAttribArray(e)},e.prototype.DisableAttributeArray=function(e){this.gl.disableVertexAttribArray(e)},e.prototype.SetVertexAttribPointer=function(e,t,r,i,n){this.gl.vertexAttribPointer(e,t,r,!1,i,n)},e.prototype.GetShaderUniformParameter=function(e){return this.shaderUniformMap.get(e)},e.prototype.GetShaderAttributeParameter=function(e){return this.shaderAttributeMap.get(e)},e.prototype.SetUniformValue=function(e){for(var t=[],r=1;r<arguments.length;r++)t[r-1]=arguments[r];if(1===t.length){if(t[0]instanceof Float32Array){if(null!==this.program&&void 0!==(a=this.GetShaderUniformParameter(e)))switch(a.type){case this.gl.FLOAT:this.gl.uniform1f(a.location,t[0][0]);break;case this.gl.FLOAT_VEC2:this.gl.uniform2f(a.location,t[0][0],t[0][1]);break;case this.gl.FLOAT_VEC3:this.gl.uniform3f(a.location,t[0][0],t[0][1],t[0][2]);break;case this.gl.FLOAT_VEC4:this.gl.uniform4f(a.location,t[0][0],t[0][1],t[0][2],t[0][3])}}else if(t[0]instanceof Int32Array){if(null!==this.program)if(void 0!==(a=this.GetShaderUniformParameter(e)))switch(a.type){case this.gl.INT:case this.gl.SAMPLER_2D:case this.gl.SAMPLER_CUBE:this.gl.uniform1i(a.location,t[0][0]);break;case this.gl.INT_VEC2:this.gl.uniform2i(a.location,t[0][0],t[0][1]);break;case this.gl.INT_VEC3:this.gl.uniform3i(a.location,t[0][0],t[0][1],t[0][2]);break;case this.gl.INT_VEC4:this.gl.uniform4i(a.location,t[0][0],t[0][1],t[0][2],t[0][3]);break;case this.gl.BOOL:this.gl.uniform1i(a.location,t[0][0]);break;case this.gl.BOOL_VEC2:this.gl.uniform2i(a.location,t[0][0],t[0][1]);break;case this.gl.BOOL_VEC3:this.gl.uniform3i(a.location,t[0][0],t[0][1],t[0][2]);break;case this.gl.BOOL_VEC4:this.gl.uniform4i(a.location,t[0][0],t[0][1],t[0][2],t[0][3])}}else if(t[0]instanceof h.Color)this.SetUniformValue(e,1,t[0].Data());else if(t[0]instanceof h.Vector2)this.SetUniformValue(e,1,t[0].Data());else if(t[0]instanceof h.Vector3)this.SetUniformValue(e,1,t[0].Data());else if(t[0]instanceof h.Vector4)this.SetUniformValue(e,1,t[0].Data());else if(t[0]instanceof h.Matrix3)this.SetUniformValue(e,1,!1,t[0].Data());else if(t[0]instanceof h.Matrix4)this.SetUniformValue(e,1,!1,t[0].Data());else if(t[0]instanceof h.Matrix3x4){var i=new h.Matrix4;i.data[0]=t[0].data[0],i.data[1]=t[0].data[1],i.data[2]=t[0].data[2],i.data[3]=t[0].data[3],i.data[4]=t[0].data[4],i.data[5]=t[0].data[5],i.data[6]=t[0].data[6],i.data[7]=t[0].data[7],i.data[8]=t[0].data[8],i.data[9]=t[0].data[9],i.data[10]=t[0].data[10],i.data[11]=t[0].data[11],this.SetUniformValue(e,i)}else if("number"==typeof t[0]){(n=this.GetShaderUniformParameter(e))&&this.gl.uniform1f(n.location,t[0])}else if("boolean"==typeof t[0]){var n;(n=this.GetShaderUniformParameter(e))&&this.gl.uniform1i(n.location,t[0]?1:0)}}else if(2===t.length){if("number"==typeof t[0])if(t[1]instanceof Float32Array){if(null!==this.program)if(void 0!==(a=this.GetShaderUniformParameter(e))){var o=void 0;switch(a.type){case this.gl.FLOAT:(o=new Float32Array(1))[0]=t[1][0],this.gl.uniform1fv(a.location,o);break;case this.gl.FLOAT_VEC2:(o=new Float32Array(2))[0]=t[1][0],o[1]=t[1][1],this.gl.uniform2fv(a.location,o);break;case this.gl.FLOAT_VEC3:(o=new Float32Array(3))[0]=t[1][0],o[1]=t[1][1],o[2]=t[1][2],this.gl.uniform3fv(a.location,o);break;case this.gl.FLOAT_VEC4:o=new Float32Array(4),1===t[0]?(o[0]=t[1][0],o[1]=t[1][1],o[2]=t[1][2],o[3]=t[1][3]):o=t[1],this.gl.uniform4fv(a.location,o)}}}else if(t[1]instanceof Int32Array){if(null!==this.program)if(void 0!==(a=this.GetShaderUniformParameter(e)))switch(a.type){case this.gl.BOOL:case this.gl.INT:this.gl.uniform1iv(a.location,t[1]);break;case this.gl.INT_VEC2:this.gl.uniform2iv(a.location,t[1]);break;case this.gl.INT_VEC3:this.gl.uniform3iv(a.location,t[1]);break;case this.gl.INT_VEC4:this.gl.uniform4iv(a.location,t[1])}}else if("number"==typeof t[1]){if(null!==this.program)if(void 0!==(a=this.GetShaderUniformParameter(e)))switch(a.type){case this.gl.FLOAT:this.gl.uniform1fv(a.location,t[1]);break;case this.gl.FLOAT_VEC2:this.gl.uniform2fv(a.location,t[1]);break;case this.gl.FLOAT_VEC3:this.gl.uniform3fv(a.location,t[1]);break;case this.gl.FLOAT_VEC4:this.gl.uniform4fv(a.location,t[1])}}}else if(3===t.length){var a;if(null!==this.program)if(void 0!==(a=this.GetShaderUniformParameter(e)))switch(a.type){case this.gl.FLOAT_MAT2:this.gl.uniformMatrix2fv(a.location,t[1],t[2]);break;case this.gl.FLOAT_MAT3:this.gl.uniformMatrix3fv(a.location,t[1],t[2]);break;case this.gl.FLOAT_MAT4:this.gl.uniformMatrix4fv(a.location,t[1],t[2])}}},e.prototype.SetName=function(e){this.name=e},e.prototype.GetName=function(){return this.name},e.prototype.GetType=function(){return this.m_type},e.prototype.SetType=function(e){this.m_type=e},e}(h.GPUObject);h.ShaderProgram=t}(M3D||(M3D={})),function(h){var e=function(){function e(e){this.maxFPS=30,this.sceneMgr=null,this.fps=0,this.evenFPS=15,this.renderEffect=null,this.showRotateCenter=!0,this.excludeSmallModel=!0,this.lodLevel=-1,this.cullerHelper=new h.CullerHelper,this.useLowQuality=!1,this.allowRedraw=!0,this.iScreenWidth=100,this.iScreenHeigh=100,this.FRAME_BUFFER_COUNT=20,this.renderCanvas=null,this.BufferCounter=1,this.allowDraw=!0,this.rameCount=0,this.frameCount=0,this.lastTime=0,this.lastEventFPSTime=0,this.effectManager=null,this.globalEffect="",this.sceneMgr=e,this.renderAction=new h.RenderAction(this),this.renderAction.SetScene(this.sceneMgr),this.allowDraw=!1,this.renderEffect=null,this.effectManager=new h.EffectManager(this.renderAction),this.Reset()}return e.prototype.ClearDelayDrawList=function(){this.renderAction&&this.renderAction.ClearDelayDraw()},e.prototype.Reset=function(){this.lodLevel=-1,this.useLowQuality=!1},e.prototype.GetRenderEffect=function(){return this.renderEffect},e.prototype.SetRenderEffect=function(e){this.renderEffect=e},e.prototype.CalculateFPS=function(){this.evenFPS=60;var e=new Date,t=e.getTime()-this.lastEventFPSTime;0<t&&(this.lastEventFPSTime=e.getTime(),this.evenFPS=1e3/t);var r=e.getTime()-this.lastTime;this.frameCount++,1e3<=r&&(this.fps=this.frameCount,this.lastTime=e.getTime(),this.frameCount=0)},e.prototype.GetFPS=function(){return this.fps},e.prototype.SetGLVersion=function(e){this.renderCanvas=e},e.prototype.GetGLVersion=function(){return this.renderCanvas},e.prototype.GetMaxLimitFPS=function(){return this.maxFPS},e.prototype.SetMaxLimitFPS=function(e){this.maxFPS=e},e.prototype.InitRenderEffect=function(){var e=new h.RenderEffect(h.RenderEffect.RENDER_NORMALEFFCT);e.GetRenderQueuePriority().InitialNormalEffect(),this.renderEffect=e},e.prototype.LimitDrawFPS=function(){return!1},e.prototype.Render=function(){this.sceneMgr.GetSceneRoot();var e=this.renderAction;if(null!==e){this.CalculateFPS(),e.SetRenderContext(this.GLContext),e.SetCamera(this.sceneMgr.GetCamera()),e.SetSection(this.sceneMgr.GetSection()),e.SetLights(this.sceneMgr.GetLights()),e.Optimize(),e.SetFPS(this.GetFPS()),e.SetRenderEffect(this.renderEffect),e.Begin();for(var t=this.sceneMgr.GetSceneRoot(),r=0;r<t.Size();r++){var i=t.GetChild(r);i.GetName()!==h.MAINGROUP&&i.FindVisiableObject(e)}this.FindVisiableObject(e),e.Execute(),e.End()}},e.prototype.FindVisiableObject=function(e){if(null!==this.sceneMgr.GetOcTree()){var t=e.GetCamera(),r=t.GetFrustum(),i=this.sceneMgr.GetFrustumQueryResulets(),n=new h.FrustumOctreeQuery(i,r,0,0);n.SetRenderAction(e),n.SetCamera(t),this.sceneMgr.GetOcTree().GetDrawables(n);var o=h.Parameters.Instance().IsShowBox;e.GetRenderEffect().GetRenderableTypeFilter().Contain(h.RenderableType.RGT_BOX)&&(o=!0);for(var a=0;a<i.length;++a){var s=i[a],l=e.GetCullerHelper().IsLittleModel(s.GetWorldBoundingBox(),t);2==l||s.FindVisiableObjectFast(e,l),o&&s.GetModel().IsSelected()&&s.GetModel().IsVisible()&&e.PrepareRenderBox(s)}this.sceneMgr.GetExtendInfoManager().FindVisiableObject(e)}},e.prototype.IsExcludeSmallModel=function(){return this.excludeSmallModel},e.prototype.ExcludeSmallModel=function(e){this.excludeSmallModel=e},e.prototype.CloseRenderActionThread=function(){},e.prototype.ShowRotationCenter=function(e){this.showRotateCenter=e},e.prototype.IsShowRotationCenter=function(){return this.showRotateCenter},e.prototype.GetLodLevel=function(){return this.lodLevel},e.prototype.SetLodLevel=function(e){this.lodLevel=e},e.prototype.UseLowQuality=function(e){this.useLowQuality=e;var t=this.sceneMgr.GetCamera();null!==t&&this.cullerHelper.AllowCuller(t,this.useLowQuality),!0===this.useLowQuality?(this.SetLodLevel(h.LOD_LODMIN),this.renderAction.ClearDelayDraw()):this.SetLodLevel(h.LOD_LODMAX)},e.prototype.GetCullerHelper=function(){return this.cullerHelper},e.prototype.InitialRender=function(e){this.GLContext=h.RenderContext.GetRenderContext(e),this.InitRenderEffect(),this.sceneMgr.GetResourceManager().SetRenderContext(this.GLContext.GetGLRenderContext()),this.sceneMgr.GetResourceManager().CreateDeffaultTextureObj(),this.sceneMgr.GetResourceManager().CreateDeffaultTextureObj(!0),this.sceneMgr.GetResourceManager().CreateDefaultCubeMap(),this.sceneMgr.GetResourceManager().GeneratePBRSpecularTextures(),this.sceneMgr.GetResourceManager().GeneratePBRDiffuseTextures(),this.sceneMgr.GetResourceManager().GeneratePBRLUTTexture(),this.sceneMgr.GetResourceManager().GeneratePbrTextures()},e.prototype.OnDraw=function(){this.sceneMgr.UpdateScene();var e=this.sceneMgr.GetCamera();null!==e&&this.cullerHelper.AllowCuller(e,!1),this.Render()},e.prototype.IsNeedRedraw=function(){return!(this.BufferCounter<1)&&(this.BufferCounter--,!0)},e.prototype.WindowSizeChanged=function(e,t){this.iScreenWidth=e,this.iScreenHeigh=t;var r=this.sceneMgr.GetCamera(),i=this.GetWindowHeight(),n=this.GetWindowWidth();if(r.SetViewPort(0,0,n,i),r){var o=this.sceneMgr.GetSceneBox();i<=n?t=(e=o.Length())*i/n:e=(t=o.Length())*n/i,this.GetCullerHelper().SetModelLength(o.Length()),r.SetOrthoSize(new h.Vector2(2*e,2*t))}var a=this.sceneMgr.GetSceneRoot(),s=a.Search(h.BACKGROUNDCOLOR);null!==s&&s.SetBackgroundSize(this.iScreenWidth,this.iScreenHeigh);var l=a.Search(h.AXIS);null!==l&&l.SetViewSize(this.iScreenWidth,this.iScreenHeigh,.25),this.renderAction&&this.renderAction.ResizeFBOs(this.iScreenWidth,this.iScreenHeigh),this.effectManager&&this.effectManager.setSize(this.iScreenWidth,this.iScreenHeigh),this.ResizeHubViewport(),this.RequestRedraw()},e.prototype.GetWindowWidth=function(){return this.iScreenWidth},e.prototype.GetWindowHeight=function(){return this.iScreenHeigh},e.prototype.AllowRedraw=function(e){this.allowRedraw=e},e.prototype.RequestRedraw=function(){this.BufferCounter=this.FRAME_BUFFER_COUNT},e.prototype.ClearGLResource=function(){this.renderAction&&this.renderAction.ClearGLResource()},e.prototype.GetQualityStatus=function(){return this.useLowQuality},e.prototype.GetEventFPS=function(){return this.evenFPS},e.prototype.GetRenderAction=function(){return this.renderAction},e.prototype.SetRenderAction=function(e){this.renderAction=e},e.prototype.GetEffectManager=function(){return this.effectManager},e.prototype.GetGlobalEffect=function(){return this.globalEffect},e.prototype.SetGlobalEffect=function(e){this.globalEffect=e},e.prototype.RequestUpdateWhenSceneBoxChanged=function(){var e=this.sceneMgr.GetCamera(),t=this.GetWindowHeight(),r=this.GetWindowWidth();if(e.SetViewPort(0,0,r,t),e){var i=this.sceneMgr.GetSceneBox(),n=0<i.Length(),o=this.iScreenWidth,a=this.iScreenHeigh,s=o;n&&t<=r?(a=(o=i.Length())*t/r,s=i.Length()):n&&(o=(a=i.Length())*r/t,s=i.Length()),this.GetCullerHelper().SetModelLength(s),e.SetOrthoSize(new h.Vector2(2*o,2*a))}},e.prototype.ResizeHubViewport=function(){var e=this.sceneMgr.GetHudCamera();if(!e){e=new h.Camera,this.sceneMgr.SetHudCamera(e);var t=this.sceneMgr.GetOcTreeWorldBoundingBox(),r=(this.sceneMgr.GetOcTreeWorldBoundingBox().Length(),t.Center());r.z+=t.Length()*h.CAMERA_POSFACTOR,e.SetWorldPosition(r),this.sceneMgr.GetDefaultFocusLength(),e.SetNearClip(.1),e.SetFarClip(100),e.SetFov(90),e.LookAt(t.Center(),new h.Vector3(0,1,0),h.Camera.TS_WORLD)}var i=this.GetWindowHeight(),n=this.GetWindowWidth(),o=new h.Vector3(0,0,-10),a=new h.Vector3(n,i,10),s=new h.BoundingBox(o,a);this.sceneMgr.SetHudLayerBox(s),e.SetViewPort(0,0,n,i),e.SetOrthoSize(new h.Vector2(n,i))},e}();h.RenderManager=e}(M3D||(M3D={})),function(f){var n,e,t=function(){function t(){this.allTextures=new f.Map,this.allOGLTextures=new f.Map,this.allImages=new f.Map,this.allMaterials={},this.modelMap=new f.Map,this.gl=null,this.glVBOCache=[],this.glTextureCache=[],this.diffaultTexture=null,this.diffaultImage=null,this.diffaultTexObj=null,this.defaultBlackObj=null,this.waterMarkStr="",this.m_cubeMappingTextures=new Array,this.VoiceImagePath=null,this.PntImagePath="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAMAAACdt4HsAAAAV1BMVEUAAAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AABpj0HLAAAAHHRSTlMA0PHftyyWF6db5/hlgApzPTcgh22uU0sQwJ+Lt8SbIQAAAj5JREFUWMPtl9mWoyAQQNkERFDjmtj1/985B5AG7STC5MzLnL5PKFVSGwWif4ZYzIxVAwAEM15XZdrViOGE4muudqsxPEUZkaM+KXhJwy8/sdIojeU4aT2Z7UEgQLq36ncZBLHp04lhYt8zb+J5o/sy/ImQ6PbZRp+9DoO68QLjK0f1Hh6evlwIzH40+Vk2vInw6GVmFLEfre2g89Y7+y69ZPGNDbC09rsJellxdx9NiQL2mSDU+wjnVAp3oqMbB8tvQjn9O0LZX1hD2dsHw5z9AuUhXbSCNLWq7k3+jsMhFdEgl4uqY3TLcWMgiRNLKFHpy+QLZVA7jb04GjggUQ7M2+x4wIElr+UkJhiIUN6XZMIL92Grz3pA2dysyhYT+TA3VAZ2JeypdVumHEsY/T2DD8IHfNld/RFDhX75JVINn+mz0MbKie2g2IZzZ+jK9dq6Tk5HXLqqsZ2U+oetsDMMerZrnnqizI0YpxAxyUGVt7cXOPBIjhmW38wjTZuYUOe1MYuS+HgKrXZMhpzcbZR1lbc5vW7NUJTKymWBxkQiQUoyIagLmkljvwaDMrhjFwdxLOEx+wvC6Te9L2F2ShC7X/rvC6neVUi6qy30oqa1r+Iu1I9CkRkcY/tmGzAvMwWryfLz/gdKv/J+3G/j3zV3Xkt7AaCdeOI8J3DpZYVhh02HwuzN94x8H+cu+bt5bMb+8owSNxCg62WaeQMvUVObUylGPVfH+Tehlasf2mPpz2vNGSY2aQrPZhHo/+UP36VVNHxLFh8AAAAASUVORK5CYII=",this.PointOImagePath="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALoAAAC6AgMAAABkYL9iAAAACVBMVEUAAAD/8gDtHCQuHbtOAAAAAXRSTlMAQObYZgAAAuVJREFUaN7tmkFuq0AQRBFLjsJ98MJHmFNwiWxYzcaImVP+iMQuWmWmui1Zyo9S65ehqiCx6U73TH39VO68GuuXZh9eH8o+HMpuM15LQ7UigJqx2oR5UhZuSOJ4UhbHk8TxpKzL0RXhVrFmfby+ANKyfGkTEgfswJC2U1qGakNZ2CFDys70qVSh9s36mHZdECGTHYvjB04MDQbnHzi3U4AjAz1DNiqERk/s3yx/RQCyn3A8X4Ds43i6AAeAe9KzAD0dTxfYmC843l4ggUfcFd1bJQ484tayLhzYpCVR4J4fBTa0WX6FHTa03nnEXWqq04m+fgts3FRghw0lE5huFt2yxQSmNrlR8KhnOpUtaGi2iUaPfDL2KYDhR9hvBpiP/FKnhgwP++0AGfUsbJ8DbOCr4C8HfkBcEdjwU1MHfkRcEXi+82tNgr+WB4+4LR6FIq4IHOa3e/2J6iGBRz2qoO27/uLk686jnnZB4NcIP6IeWdD8Gr+gznah+ft2rR5+efDJc37C+ahf832E33a+oP6Grg++vpMfcLscN2znVz8fOj8ZXup4/uTk6XET/Bzhl513+0n1wZf/lc/7r1eQr0uQrzcPf/3j//jfyRc3/8P+Pvw8PvJ5Eee7N/Pxz+s+wm9R/v3fT7oIH//+FufHV/jqfdzi/BD4vt2F+fj7Re/l4+9HcR7vd4p//f1xdPMzePk+C35w8x14VVAC33sK4vnDh3f+gEJ1nVSQqgd8EXHBDzowzZfUvAg8BjR6nOMdGKVnfNXjJR546fEVAt/kOM0GLk07zFc9DuSBox43InA5sY+4CCznvTSvFvPkZ3zR42E9gK6Ii8By3j4bfpDzfNpHIDGlhX29MEiwLxcSvI7gALWx7tALlXS6oGrvg3InFki8PtILKuCb2McVeCc7bIg1x/eJLLEeDBiK7lvD+9zYBV7ZRwcSx/fp8gKpfTwkjo/+v4GO3CmRGyXClQhXoudGqT9v5h9X3BzxJAP6gAAAAABJRU5ErkJggg==",this.PntR2ImagePath="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAH0AAAB2AgMAAACYKXR1AAAADFBMVEUAAAD///8AAADtHCSzlY10AAAAAnRSTlMAPFn8sb8AAAHSSURBVEjHndfBTQMxEIXh5EAJaNtJCTmAOKYU+jEHSkgTpInccwGBsSZafqGn9wzZKxbzzRvHu978fraP+0187vpbXrD0S15w6J+79Pftc+/7TOgZsYwFl12ocOidGqYCNUyFnhodFT76aDQ1eS5EILTjQATCV3sdiEB4by+F8ITWCuEJrRCB0AoRCA2EIYAwhFHDIJaqcK1xMYRzq2dFKKFdn2MhhFBNgnCEFbGTChBoVJsEITWWH4JJ+wCBtDVni4AAwhBAOAIIQwBhCCAMAYQjgAgERq4EGTmj5pF9x6h5CqG7TRHsNkWc1gVPELRRbVLTpkmTNjmbtMlZEYYAAoJBQDAICA4BwSAgGAQEg4BgEUXwNcYCKmiNWkAFrfHH/9BbMpgu2LizHKZJzmcxn2beD/MdNd+TIPxP6z7/LvhxK+HBHA/k7A8YjhgaNYcUjZomadSeH6StTRoEOXsEBBCekE97EI7AezcQSNu9vTmNNWcada8TRq6j1kYh/PvzgLS1SdI2OYMwOYPwBBAQDAKCQUBQxKjhCaRdOUOQkUvOMnJG7RrVUecP7/zpnj/+8/UhX0BuvsJwCQoIQ+BjBYKtcbr1Mpivk/lCmq+000vxN1tb70YRF3RqAAAAAElFTkSuQmCC",this.defaultSkyBoxObj=null,this.defaultPBRSpecularTextures=[],this.defaultPBRDiffuseTextures=[]}return t.prototype.ClearResource=function(){this.zipFile=null,this.allTextures.Clear(),this.allOGLTextures.Clear(),this.allImages.Clear(),this.allMaterials={},this.modelMap.Clear(),this.glVBOCache=[],this.glTextureCache=[],this.m_cubeMappingTextures=new Array},t.prototype.GetDeffaultTextureObj=function(e){return void 0===e&&(e=!1),e?this.defaultBlackObj:this.diffaultTexObj},t.prototype.CreateWaterTextureObj=function(e){var t=this.GetOrCreateTexture("waterMark"+e);if(this.waterMarkStr===e)return t;if((t.GetImageArray().length=0)===t.GetImageArray().length){var r=f.Parameters.Instance().waterMarkResolution.x,i=f.Parameters.Instance().waterMarkResolution.y,n=document.createElement("canvas");n.width=r,n.height=i;var o=n.getContext("2d");o.fillStyle="black",o.font=f.Parameters.Instance().waterMarkFontSize+"px  bold",o.textAlign="center",o.textBaseline="middle",o.translate(r/2,i/2),o.rotate(-f.Parameters.Instance().waterMarkRotation*Math.PI/180),o.fillText(e,0,0),o.restore();var a=n.toDataURL("image/png"),s=this.GetOrCreateImage("waterMark"+e,a);t.AddImage(s)}return t},t.prototype.CreateDeffaultTextureObj=function(e){if(void 0===e&&(e=!1),e){if(!this.defaultBlackObj){var t=new Image;t.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAIAAAAC64paAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAATSURBVDhPYxgFo2AUjIIhCxgYAATEAAHN+RzrAAAAAElFTkSuQmCC";var r=this;t.onload=function(){var e=f.ImageLoader.createPowerTwoImage(t);r.defaultBlackObj=r.gl.createTexture(),r.gl.bindTexture(f.GL.TEXTURE_2D,r.defaultBlackObj),r.gl.texParameteri(f.GL.TEXTURE_2D,f.GL.TEXTURE_MAG_FILTER,f.GL.LINEAR),r.gl.texParameteri(f.GL.TEXTURE_2D,f.GL.TEXTURE_MIN_FILTER,f.GL.LINEAR),r.gl.texParameteri(f.GL.TEXTURE_2D,f.GL.TEXTURE_WRAP_S,f.GL.CLAMP_TO_EDGE),r.gl.texParameteri(f.GL.TEXTURE_2D,f.GL.TEXTURE_WRAP_T,f.GL.CLAMP_TO_EDGE),r.gl.texImage2D(f.GL.TEXTURE_2D,0,f.GL.RGBA,f.GL.RGBA,f.GL.UNSIGNED_BYTE,e),r.gl.bindTexture(f.GL.TEXTURE_2D,null)}}}else if(!this.diffaultTexObj){this.diffaultTexture=new f.Texture2D,this.diffaultImage=new f.ImageM3D;var i=new Image;i.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIcAAACICAIAAABC02+IAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAE5SURBVHhe7dExAQAADMOg+Tfd2eAIFrjF04qoFVErolZErYhaEbUiakXUiqgVUSuiVkStiFoRtSJqRdSKqBVRK6JWRK2IWhG1ImpF1IqoFVErolZErYhaEbUiakXUiqgVUSuiVkStiFoRtSJqRdSKqBVRK6JWRK2IWhG1ImpF1IqoFVErolZErYhaEbUiakXUiqgVUSuiVkStiFoRtSJqRdSKqBVRK6JWRK2IWhG1ImpF1IqoFVErolZErYhaEbUiakXUiqgVUSuiVkStiFoRtSJqRdSKqBVRK6JWRK2IWhG1ImpF1IqoFVErolZErYhaEbUiakXUiqgVUSuiVkStiFoRtSJqRdSKqBVRK6JWRK2IWhG1ImpF1IqoFVErolZErYhaEbUiakXUiqgVUSuiVkStiFoRteLZHuaXXWPcIIy2AAAAAElFTkSuQmCC";var n=this;i.onload=function(){var e=f.ImageLoader.createPowerTwoImage(i);n.diffaultTexObj=n.gl.createTexture(),n.gl.bindTexture(f.GL.TEXTURE_2D,n.diffaultTexObj),n.gl.texParameteri(f.GL.TEXTURE_2D,f.GL.TEXTURE_MAG_FILTER,f.GL.LINEAR),n.gl.texParameteri(f.GL.TEXTURE_2D,f.GL.TEXTURE_MIN_FILTER,f.GL.LINEAR),n.gl.texParameteri(f.GL.TEXTURE_2D,f.GL.TEXTURE_WRAP_S,f.GL.CLAMP_TO_EDGE),n.gl.texParameteri(f.GL.TEXTURE_2D,f.GL.TEXTURE_WRAP_T,f.GL.CLAMP_TO_EDGE),n.gl.texImage2D(f.GL.TEXTURE_2D,0,f.GL.RGBA,f.GL.RGBA,f.GL.UNSIGNED_BYTE,e),n.gl.bindTexture(f.GL.TEXTURE_2D,null)}}},t.prototype.SetZipFile=function(e){this.zipFile=e},t.prototype.SetRenderContext=function(e){this.gl=e},t.prototype.GetRenderContext=function(){return this.gl},t.prototype.SetSourcePath=function(e){this.sourcePath=e},t.prototype.GetTexture=function(e){return this.allTextures.Get(e)},t.prototype.GetOrCreateTexture=function(e,t){void 0===t&&(t=1);var r=this.GetTexture(e);if(!r){switch(t){case f.Texture.TEXTURE_BASE:case f.Texture.TEXTURE_2D:r=new f.Texture2D;break;case f.Texture.TEXTURE_CUBE:r=new f.TextureCube;break;case f.Texture.TEXTURE_GEO:r=new f.TextureTarget}r.SetResourceManager(this),r.SetName(e),this.AddTexture(e,r)}return r},t.prototype.AddTexture=function(e,t){var r=!1;return this.allTextures.Get(e)||(this.allTextures.Put(e,t),r=!0),r},t.prototype.RemoveTexture=function(e){return this.allTextures.Remove(e)},t.prototype.GetMaterial=function(e){return this.allMaterials[e]},t.prototype.getMaxMaterialKey=function(){var e=0;for(var t in this.allMaterials)Number(t)>e&&(e=Number(t));return e},t.prototype.GetOrCreateMaterial=function(e,t,r){var i=this.GetMaterial(e);if(!i){switch(t){case f.MaterialType.MaterialType_Base:i=new f.BaseMaterial;break;case f.MaterialType.MaterialType_Phong:i=new f.Material;break;case f.MaterialType.MaterialType_MatCap:i=new f.MatCapMaterial;break;case f.MaterialType.MaterialType_Pbr:i=new f.PbrMaterial;break;case f.MaterialType.MaterialType_Inner:i=new f.InnerMaterial;break;case f.MaterialType.MaterialType_Depth:i=new f.DepthMaterial;break;case f.MaterialType.MaterialType_Shader:case 101:case 102:case 103:case 104:i=new f.ShaderMaterial;break;default:i=new f.Material}if(i.setResourceManager(this),i.SetName(e),this.AddMaterial(e,i),this.zipFile&&r){var n=this.zipFile.file(r);n&&f.MaterialReader.Instance().LoadMtl(n.asText(),this)}}return i},t.prototype.AddMaterial=function(e,t){var r=!1;return null!==this.allMaterials[e]&&void 0!==this.allMaterials[e]||((this.allMaterials[e]=t).setResourceManager(this),r=!0),r},t.prototype.RemoveMaterial=function(e){delete this.allMaterials[e]},t.prototype.GetAllMaterials=function(){return this.allMaterials},t.prototype.GetOrCreateImage=function(e,t){var r=this.allImages.Get(e);if(!r)if(r=new f.ImageM3D,this.allImages.Put(e,r),t)r.SetSourceMode(f.ImageSource.FromURL),r.SetImagePath(t);else if(r.SetSourceMode(f.ImageSource.FromeZip),this.zipFile){var i=this.zipFile.file(e);if(i){var n=e.lastIndexOf(".");0<=n&&n<e.length&&e.substr(n+1);var o=new Blob([i.asArrayBuffer()],{type:"application/octet-binary"}),a=URL.createObjectURL(o);r.SetImagePath(a)}}return r},t.prototype.GetOrCreateImageById=function(e,t,r){var i=this.allImages.Get(e);if(!i)if((i=new f.ImageM3D).SetId(t),this.allImages.Put(e,i),r)i.SetSourceMode(f.ImageSource.FromURL),i.SetImagePath(r);else if(i.SetSourceMode(f.ImageSource.FromeZip),this.zipFile){var n=this.zipFile.file(e);if(n){var o=e.lastIndexOf(".");0<=o&&o<e.length&&e.substr(o+1);var a=new Blob([n.asArrayBuffer()],{type:"application/octet-binary"}),s=URL.createObjectURL(a);i.SetImagePath(s)}}return i},t.prototype.getMaxImageId=function(){for(var e=0,t=0;t<this.allImages.elements.length;t++){var r=this.allImages.elements[t].value;r&&r.GetId()&&r.GetId()>e&&(e=r.GetId())}return e},t.prototype.GetImage=function(e){return this.allImages.Get(e)},t.prototype.GetOGLTexture=function(e){return this.allOGLTextures.Get(e)},t.prototype.AddOGLTexture=function(e,t){var r=!1;return this.allOGLTextures.Get(e)||(this.allOGLTextures.Put(e,t),r=!0),r},t.prototype.RemoveOGLTexture=function(e){return this.allOGLTextures.Remove(e)},t.DefaultVoiceImage=function(){return null===t.defaultVoiceImage&&(t.defaultVoiceImage=new f.Texture),t.defaultVoiceImage},t.prototype.getDefaultPointTexture=function(e){var t=null;if(1===e){var r=this.GetOrCreateImage("PointOImagePath",this.PointOImagePath);(i=this.GetOrCreateTexture("PointOImagePath")).AddImage(r),t=i}else if(2===e){r=this.GetOrCreateImage("PntImagePath",this.PntImagePath);(i=this.GetOrCreateTexture("PntImagePath")).AddImage(r),t=i}else if(3===e){var i;r=this.GetOrCreateImage("PntR2ImagePath",this.PntR2ImagePath);(i=this.GetOrCreateTexture("PntR2ImagePath")).AddImage(r),t=i}return t},t.DefaultPntTexture=function(){return null===t.defaultPntTexture&&(t.defaultPntTexture=new f.Texture),t.defaultPntTexture},t.DefaultPntTextureO=function(){return null===t.defaultPntTextureO&&(t.defaultPntTextureO=new f.Texture),t.defaultPntTextureO},t.DefaultPntTexturer2=function(){return null===t.defaultPntTexturer2&&(t.defaultPntTexturer2=new f.Texture),t.defaultPntTexturer2},t.DefaultSphereTexture=function(){return null===t.defaultSphereTexture&&(t.defaultSphereTexture=new f.Texture),t.defaultSphereTexture},t.DefaultCubeMapTexture=function(){return null===t.defaultCubeMapTexture&&(t.defaultCubeMapTexture=new f.Texture),t.defaultCubeMapTexture},t.prototype.GetDefaultVoiceImage=function(){if(!t.defaultVoiceImage){var e=f.Parameters.Instance().appWorkPath+this.VoiceImagePath;t.defaultVoiceImage=this.GetOrCreateTexture(e)}return t.defaultVoiceImage},t.prototype.GetDefaultPointTexture=function(e){},t.prototype.GetDefaultSphereMap=function(){},t.prototype.GetDefaultCubeMap=function(){return this.defaultSkyBoxObj},t.prototype.CreateDefaultCubeMap=function(){if(!this.defaultSkyBoxObj){var r=new Image;r.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIcAAACICAIAAABC02+IAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAE5SURBVHhe7dExAQAADMOg+Tfd2eAIFrjF04qoFVErolZErYhaEbUiakXUiqgVUSuiVkStiFoRtSJqRdSKqBVRK6JWRK2IWhG1ImpF1IqoFVErolZErYhaEbUiakXUiqgVUSuiVkStiFoRtSJqRdSKqBVRK6JWRK2IWhG1ImpF1IqoFVErolZErYhaEbUiakXUiqgVUSuiVkStiFoRtSJqRdSKqBVRK6JWRK2IWhG1ImpF1IqoFVErolZErYhaEbUiakXUiqgVUSuiVkStiFoRtSJqRdSKqBVRK6JWRK2IWhG1ImpF1IqoFVErolZErYhaEbUiakXUiqgVUSuiVkStiFoRtSJqRdSKqBVRK6JWRK2IWhG1ImpF1IqoFVErolZErYhaEbUiakXUiqgVUSuiVkStiFoRteLZHuaXXWPcIIy2AAAAAElFTkSuQmCC";var i=this;r.onload=function(){var e=f.ImageLoader.createPowerTwoImage(r);i.defaultSkyBoxObj=i.gl.createTexture(),i.gl.bindTexture(f.GL.TEXTURE_CUBE_MAP,i.defaultSkyBoxObj),i.gl.texParameteri(f.GL.TEXTURE_CUBE_MAP,f.GL.TEXTURE_MAG_FILTER,f.GL.LINEAR),i.gl.texParameteri(f.GL.TEXTURE_CUBE_MAP,f.GL.TEXTURE_MIN_FILTER,f.GL.LINEAR),i.gl.texParameteri(f.GL.TEXTURE_CUBE_MAP,f.GL.TEXTURE_WRAP_S,f.GL.CLAMP_TO_EDGE),i.gl.texParameteri(f.GL.TEXTURE_CUBE_MAP,f.GL.TEXTURE_WRAP_T,f.GL.CLAMP_TO_EDGE);for(var t=0;t<6;t++)i.gl.texImage2D(i.gl.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,f.GL.RGBA,f.GL.RGBA,i.gl.UNSIGNED_BYTE,e);i.gl.bindTexture(f.GL.TEXTURE_CUBE_MAP,null)}}},t.prototype.GeneratePBRSpecularTextures=function(){var e="./textures/papermill/specular/",t=["0","1","2","3","4","5"],r=this.GetOrCreateTexture(e,f.Texture.TEXTURE_CUBE);if(r.IsUseMipMap=!0,f.RenderContext.hasSRGB){var i=new f.TextureParameter;i.internalrFromat=f.RenderContext.hasSRGB.SRGB_EXT,i.format=f.RenderContext.hasSRGB.SRGB_EXT,r.SetTextureParameter(i)}for(var n=0;n<1;n+=1){for(var o=[],a=0;a<6;a++){var s="specular_"+t[a]+".jpg";s;var l=e+s,h=this.GetImage(s);null===h&&(h=this.GetOrCreateImage(s,l)),o.push(h)}r.AddImages(o)}r.SetIsGammaInput(!0),this.defaultPBRSpecularTextures.push(r)},t.prototype.GeneratePbrTextures=function(){for(var e="./textures/papermill/specular/",t=["right","left","top","bottom","front","back"],r=[],i="",n=0;n<6;n++){var o="specular_"+t[n]+".jpg",a=e+o;r.push(a),i+=o}this.defaultPBRSpecularTexture=this.GetOrCreateCubeMappingTexture(i,r),this.defaultPBRSpecularTexture.SetMipMap(!0),this.defaultPBRSpecularTexture.SetMinFliter(f.GL.LINEAR_MIPMAP_LINEAR),this.defaultPBRSpecularTexture.SetWrapS(f.GL.CLAMP_TO_EDGE),this.defaultPBRSpecularTexture.SetWrapT(f.GL.CLAMP_TO_EDGE),this.defaultPBRSpecularTexture.SetIsGammaInput(!0),e="./textures/papermill/diffuse/",r=[],i="";for(n=0;n<6;n++){var s="diffuse_"+t[n]+".bmp";a=e+s;r.push(a),i+=s}this.defaultPBRDiffuseTexture=this.GetOrCreateCubeMappingTexture(i,r),this.defaultPBRDiffuseTexture.SetIsGammaInput(!0)},t.prototype.GetOrCreateCubeMappingTexture=function(e,t){var r=null,i=this.m_cubeMappingTextures[e];if(i)return i;for(var n=new f.TextureCube,o=[],a=0;a<t.length;a++){var s=t[a],l=this.GetImage(s);l||(l=this.GetOrCreateImage(s,s)),o.push(l)}return n.AddImages(o),(this.m_cubeMappingTextures[e]=n).SetResourceManager(this),(r=n).SetResourceManager(this),r},t.prototype.GeneratePBRDiffuseTextures=function(){for(var e=["0","1","2","3","4","5"],t=0;t<2;t+=2){for(var r=[],i="",n=0;n<6;n++){var o="diffuse_"+e[n]+".bmp";i+=o;var a="./textures/papermill/diffuse/"+o,s=this.GetImage(o);null===s&&(s=this.GetOrCreateImage(o,a)),r.push(s)}var l=this.GetOrCreateTexture(i,f.Texture.TEXTURE_CUBE);if(l.AddImages(r),l.IsUseMipMap=!1,f.RenderContext.hasSRGB){var h=new f.TextureParameter;h.internalrFromat=f.RenderContext.hasSRGB.SRGB_EXT,h.format=f.RenderContext.hasSRGB.SRGB_EXT,l.SetTextureParameter(h)}this.defaultPBRDiffuseTextures.push(l)}},t.prototype.GeneratePBRLUTTexture=function(){var e="./textures/papermill/brdfLUT.png",t="brdfLUT.png",r=this.GetImage(t);null===r&&(r=this.GetOrCreateImage(t,e));var i=this.GetOrCreateTexture(e),n=new f.TextureParameter;f.RenderContext.hasSRGB&&(n.internalrFromat=f.RenderContext.hasSRGB.SRGB_EXT,n.format=f.RenderContext.hasSRGB.SRGB_EXT),n.wrapS=f.GL.CLAMP_TO_EDGE,n.wrapT=f.GL.CLAMP_TO_EDGE,i.SetTextureParameter(n),i.AddImage(r),i.IsUseMipMap=!1,this.defaultPBRLUTTexture=i},t.prototype.GetDefaultPBRSpecularTexture=function(){return this.defaultPBRSpecularTextures[0]},t.prototype.GetDefaultPBRDiffuseTexture=function(){return this.defaultPBRDiffuseTextures[0]},t.prototype.GetDefaultPBRLUTTexture=function(){return this.defaultPBRLUTTexture},t.prototype.GetPreMaterial=function(e){var t=1,r=1,i=1;switch(e){case n.Wood:t=1,r=.04;break;case n.Wall:t=.8,r=.04;break;case n.Pottery:t=.2,r=.04;break;case n.Metal:t=.35,r=.74;break;case n.FrostedMetal:t=.5,r=.8;break;case n.Plastic:r=t=.1;break;case n.FrostedPlastic:t=.5,r=.1;break;case n.Glass:t=.1,r=.04,i=.5;break;default:r=t=.5}return{roughness:t,metalness:r,alpha:i}},t.prototype.MaterialToJSON=function(){var e='{"materials":[',t=[];for(var r in this.allMaterials){var i=this.allMaterials[r];if(e+='{"id":'+r+",",1===i.GetMaterialType()){e+='"type": 1,',i.GetDisplayName()&&(e+='"name":"'+i.GetDisplayName()+'",');var n=i.GetDiffuse();n&&(e+='"diffuseColor":['+n.r+","+n.g+","+n.b+","+n.a+"],");var o=i.GetAmbient();o&&(e+='"ambientColor":['+o.r+","+o.g+","+o.b+","+o.a+"],");var a=i.GetSpecular();a&&(e+='"specularColor":['+a.r+","+a.g+","+a.b+","+a.a+"],");var s=i.GetEmissive();if(s&&(e+='"emissiveColor":['+s.r+","+s.g+","+s.b+","+s.a+"],"),i.GetShininess()&&(e+='"shininess":'+i.GetShininess()+","),i.GetNormalMapScale()&&(e+='"normalMapScale":['+i.GetNormalMapScale().x+","+i.GetNormalMapScale().y+"],"),i.GetOpacity()&&(e+='"transparency":'+i.GetOpacity()+","),p=i.GetDiffuseMap()){e+='"diffuseTexture":{"ref":[';for(var l=p.GetImageArray(),h=0;h<l.length;h++){e+=l[h].GetId()+",";var u='{"uri":"'+(this.GetImageKeyById(l[h].GetId())||p.GetName())+'","id":'+l[h].GetId()+"}";t.push(u)}e=e.substring(0,e.length-1),e+="]},"}if(d=i.GetNormalMap()){e+='"normalMap":{"ref":[';for(l=d.GetImageArray(),h=0;h<l.length;h++){e+=l[h].GetId()+",";u='{"uri":"'+(this.GetImageKeyById(l[h].GetId())||d.GetName())+'","id":'+l[h].GetId()+"}";t.push(u)}e=e.substring(0,e.length-1),e+="]},"}if(S=i.GetMatcapMap()){e+='"matcapMap":{"ref":[';for(l=S.GetImageArray(),h=0;h<l.length;h++){e+=l[h].GetId()+",";u='{"uri":"'+(this.GetImageKeyById(l[h].GetId())||S.GetName())+'","id":'+l[h].GetId()+"}";t.push(u)}e=e.substring(0,e.length-1),e+="]},"}i.GetUvTranslate()&&(e+='"uvTranslate":['+i.GetUvTranslate().x+","+i.GetUvTranslate().y+"],"),i.GetUvScale()&&(e+='"uvScale":['+i.GetUvScale().x+","+i.GetUvScale().y+"],"),i.GetUvRotate()?e+='"uvRotate":'+i.GetUvRotate()+"},":(e=e.substring(0,e.length-1),e+="},")}else if(2===i.GetMaterialType()){var p;if(i.GetDisplayName()&&(e+='"name":"'+i.GetDisplayName()+'",'),e+='"type":2,',(f=i.AlbedoColor())&&(e+='"diffuseColor":['+f.r+","+f.g+","+f.b+"],"),i.Opacity()&&(e+='"transparency":'+i.Opacity()+","),i.MetalnessFactor()&&(e+='"metalnessFactor":'+i.MetalnessFactor()+","),i.RougthnessFactor()&&(e+='"roughnessFactor":'+i.RougthnessFactor()+","),e+='"useClearCoat":'+i.UseClearCoat()+",",i.ClearCoat()&&(e+='"clearCoat":'+i.ClearCoat()+","),i.ClearCoatRoughness()&&(e+='"clearCoatRoughness":'+i.ClearCoatRoughness()+","),p=i.AlbedoMap()){e+='"diffuseTexture":{"ref":[';for(l=p.GetImageArray(),h=0;h<l.length;h++){e+=l[h].GetId()+",";u='{"uri":"'+(this.GetImageKeyById(l[h].GetId())||p.GetName())+'","id":'+l[h].GetId()+"}";t.push(u)}e=e.substring(0,e.length-1),e+="]},"}if(d=i.NormalMap()){e+='"normalMap":{"ref":[';for(l=d.GetImageArray(),h=0;h<l.length;h++){e+=l[h].GetId()+",";u='{"uri":"'+(this.GetImageKeyById(l[h].GetId())||d.GetName())+'","id":'+l[h].GetId()+"}";t.push(u)}e=e.substring(0,e.length-1),e+="]},"}var c=i.MetalnessRoughnessMap();if(c){e+='"metalnessRoughnessMap":{"ref":[';for(l=c.GetImageArray(),h=0;h<l.length;h++){e+=l[h].GetId()+",";u='{"uri":"'+(this.GetImageKeyById(l[h].GetId())||c.GetName())+'","id":'+l[h].GetId()+"}";t.push(u)}e=e.substring(0,e.length-1),e+="]},"}i.NormalMapScale()&&(e+='"normalMapScale":['+i.NormalMapScale().x+","+i.NormalMapScale().y+"],"),i.GetUvTranslate()&&(e+='"uvTranslate":['+i.GetUvTranslate().x+","+i.GetUvTranslate().y+"],"),i.GetUvScale()&&(e+='"uvScale":['+i.GetUvScale().x+","+i.GetUvScale().y+"],"),i.GetUvRotate()?e+='"uvRotate":'+i.GetUvRotate()+"},":(e=e.substring(0,e.length-1),e+="},")}else if(4===i.GetMaterialType()){e+='"name":"'+i.GetDisplayName()+'",',e+='"type":4,';var d,S,f,m=i.GetSpecular();if(m&&(e+='"specularColor":['+m.r+","+m.g+","+m.b+"],"),i.GetShininess()&&(e+='"shininess":'+i.GetShininess()+","),d=i.GetNormalMap()){e+='"normalMap":{"ref":[';for(l=d.GetImageArray(),h=0;h<l.length;h++){e+=l[h].GetId()+",";u='{"uri":"'+(this.GetImageKeyById(l[h].GetId())||d.GetName())+'","id":'+l[h].GetId()+"}";t.push(u)}e=e.substring(0,e.length-1),e+="]},"}if(S=i.GetMatcapMap()){e+='"matcapMap":{"ref":[';for(l=S.GetImageArray(),h=0;h<l.length;h++){e+=l[h].GetId()+",";u='{"uri":"'+(this.GetImageKeyById(l[h].GetId())||S.GetName())+'","id":'+l[h].GetId()+"}";t.push(u)}e=e.substring(0,e.length-1),e+="]},"}(f=i.GetDiffuse())&&(e+='"diffuseColor":['+f.r+","+f.g+","+f.b+"],"),i.GetOpacity()?e+='"transparency":'+i.GetOpacity()+"},":(e=e.substring(0,e.length-1),e+="},")}}return e=e.substring(0,e.length-1),e+="]",e+=',"images":['+(t=this.arrayUnique(t))+"]}"},t.prototype.arrayUnique=function(e){for(var t=[],r=0;r<e.length;r++)-1==t.indexOf(e[r])&&t.push(e[r]);return t},t.prototype.GetImageKeyById=function(e){for(var t,r=0;r<this.allImages.elements.length;r++){var i=this.allImages.elements[r].value;if(i&&i.GetId()&&i.GetId()===e){t=this.allImages.elements[r].key;break}}return t},t.prototype.CopyMaterial=function(e,t){if(!t)return null;t.GetMaterialType();var r=f.IDCreator.GetUUID(),i="material_phong_"+r;return(e=t.Clone()).SetUuid(r),e.SetName(i),this.AddMaterial(i,e),e},t.prototype.IsMaterialUsed=function(e,t,r){var i=e.GetFaceMaterial();if(i&&i.Compare(t)&&e!==r)return!0;for(var n=e.GetSubModels(),o=0;o<n.length;o++){var a=n[o];if(this.IsMaterialUsed(a,t,r))return!0}return!1},t.prototype.IsMaterialExisted=function(e,t){var r=null,i=this.GetAllMaterials();if(i)for(var n in i){var o=i[n];switch(o.GetMaterialType()){case f.MaterialType.MaterialType_Phong:var a=o.Clone(),s=a.GetDiffuse(),l=a.GetOpacity();if(s.Equals(e)&&t===l)return r=a;break;case f.MaterialType.MaterialType_Pbr:var h=o.Clone(),u=h.AlbedoColor(),p=h.Opacity();if(u.Equals(e)&&t===p)return r=h;break;case f.MaterialType.MaterialType_MatCap:var c=o.Clone(),d=c.GetDiffuse(),S=c.GetOpacity();if(d.Equals(e)&&t===S)return r=c}}return r},t.prototype.IsMaterialExistedByKey=function(e,t){var r=null,i=this.GetAllMaterials();if(i)for(var n in i){var o=i[n];if(o.Compare(e)&&n!==t)return r=o}return r},t.defaultVoiceImage=null,t.defaultPntTexture=null,t.defaultPntTextureO=null,t.defaultPntTexturer2=null,t.defaultSphereTexture=null,t.defaultCubeMapTexture=null,t}();f.ResourceManager=t,(e=n=f.PreMaterialType||(f.PreMaterialType={}))[e.Wood=0]="Wood",e[e.Wall=1]="Wall",e[e.Pottery=2]="Pottery",e[e.Metal=3]="Metal",e[e.FrostedMetal=4]="FrostedMetal",e[e.Plastic=5]="Plastic",e[e.FrostedPlastic=6]="FrostedPlastic",e[e.Glass=7]="Glass"}(M3D||(M3D={})),function(f){var e,t;(t=e=f.SceneManagerType||(f.SceneManagerType={})).TASK="task",t.MAINTENANCE="maintenance",t.RING="ring",t.SHOW="show",t.GENERAL="general";var i=function(){function e(e){this.scene=null,this.scene=e}return e.onExecute=function(e,t){null!==t&&t.Reset()},e.onExecuteModel=function(e,t){null!==t&&t.Restore(!1)},e}(),n=function(){function e(e){this.scene=null,this.scene=e}return e.onExecute=function(e,t){if(null!==t&&null!==t&&t instanceof f.ShapeNode){var r=e.sceneBox,i=t.GetWorldBoundingBox();null!==i&&i.Defined()&&r.Merge(i)}},e.onExecuteModel=function(e,t){if(null!==t&&null!==t&&t instanceof f.Model){var r=e.sceneBox,i=t.GetWorldBoundingBox();null!==i&&i.Defined()&&r.Merge(i)}},e}(),o=(function(){function e(e){this.scene=null,this.scene=e}e.onExecute=function(e,t){if(null!==t&&null!==t&&t instanceof f.ShapeNode)e.sceneBox}}(),function(){function e(e){this.nodesmap=null,this.nodesmap=e}return e.onExecute=function(e,t){var r=e[t.GetName()];r?r=t:e[t.GetName()]=t},e.onExecuteModel=function(e,t){var r=e[t.GetSVLPath()];r?r=t:e[t.GetSVLPath()]=t},e}()),r=function(){function r(){this.pSceneRoot=null,this.camera=null,this.sceneBox=new f.BoundingBox,this.RenderMgr=null,this.iSelectType=0,this.TopModel=null,this.lights=[],this.noteGroup=null,this.measureGroup=null,this.resourceMgr=null,this.nodesMap={},this.shapesIDMap={},this.isModelDirty=!0,this.glueObj=null,this.frustumQueryResulets=[],this.m_hudCamera=null,this.sceneType=e.GENERAL,this.modelFillMgr=null,this.RenderMgr=new f.RenderManager(this),this.Init()}return r.prototype.GetHudCamera=function(){return this.m_hudCamera},r.prototype.SetHudCamera=function(e){this.m_hudCamera=e},r.prototype.GetHudLayerBox=function(){return this.m_HudLayerBox},r.prototype.SetHudLayerBox=function(e){this.m_HudLayerBox=e},r.prototype.GetFrustumQueryResulets=function(){return[]},r.prototype.GetSceneType=function(){return this.sceneType},r.prototype.SetSceneType=function(e){this.sceneType=e},r.prototype.GetOcTree=function(){return this.ocTree},r.prototype.GetNearrestPickPoint=function(){return this.nearRestPickPoint},r.prototype.SetNearrestPickPoint=function(e){this.nearRestPickPoint=e},r.prototype.GetResourceManager=function(){return null==this.resourceMgr&&(this.resourceMgr=new f.ResourceManager),this.resourceMgr},r.prototype.GetSceneRoot=function(){return this.pSceneRoot},r.prototype.Init=function(){this.TopModel=null,this.pSceneRoot=new f.GroupNode,this.glueObj=new f.GlueObj,this.isModelDirty=!1,this.ocTree=new f.Octree,this.extendinfoMgr=null},r.prototype.RemoveModel=function(){this.GetRenderManager().ClearDelayDrawList(),this.SetModel(null),this.ocTree&&this.ocTree.Clear(),this.ClearModelAndHandles(),this.GetRenderManager().ClearGLResource(),this.GetRenderManager().RequestRedraw()},r.prototype.OptimizeScene=function(){this.Reset(),this.sceneBox.Clear(),this.UpdataNodePathMap(),this.isModelDirty=!0,this.RequestUpdateWhenSceneBoxChanged()},r.prototype.UpdateScene=function(){this.UpdateHardwareBuffer(),this.ocTree&&this.ocTree.Update()},r.prototype.UpdateSceneByModel=function(e){var t=!1;if(!e)return t;var r=new f.BoundingBox;return r=e.GetWorldBoundingBox(),this.sceneBox.IsInside(r)!=f.INSIDE&&(this.sceneBox.Merge(r),this.RequestUpdateWhenSceneBoxChanged(),t=!0),t},r.prototype.UpdateHardwareBuffer=function(){this.isModelDirty&&(this.isModelDirty=!1)},r.prototype.GetExtendInfoManager=function(){return null==this.extendinfoMgr&&(this.extendinfoMgr=new f.ExtendInfoManager,this.extendinfoMgr.SetScene(this)),this.extendinfoMgr},r.prototype.AsynRemoveModelFromeScene=function(e,t){var r=!1;return e&&t&&(this.GetRenderManager().ClearDelayDrawList(),this.AsynUpdateModelCacheInfo(t,!1),e.RemoveSubModel(t),this.RequestUpdateWhenSceneBoxChanged(),r=!0),r},r.prototype.Reset=function(){var e=new f.CallBackAction;e.SetActionData(this),e.SetActionFun(i.onExecute),e.SetActionFunModel(i.onExecuteModel),this.ExecuteAction(e),this.GetRenderManager().RequestRedraw()},r.prototype.GetModelFillManager=function(){return null==this.modelFillMgr&&(this.modelFillMgr=new f.ModelFillManager(this)),this.modelFillMgr},r.prototype.RayOctreeAction=function(e){var t=!1;if(e&&this.ocTree){this.ocTree;var r=e.GetData().GetCameraRay(),i=[],n=new f.RayOctreeQuery(i,r,f.RayQueryLevel.RAY_AABB,.001);this.ocTree.RaycastSingleFast(n);for(var o=0;o<i.length;o++){var a=i[o];null!==a&&a.RayPick(e)}this.GetNoteGroup().RayPick(e),this.GetMeasureGroup().RayPick(e),this.GetExtendInfoManager().RayPick(e),t=!0}return t},r.prototype.FrameOctreeAction=function(e){var t=!1;if(e&&this.ocTree){var r=this.ocTree,i=(e.GetData().GetCameraRay(),e.GetData().GetFramePickFrustum()),n=[],o=new f.FrustumOctreeQuery(n,i,0,0);r.GetDrawables(o);for(var a=0;a<n.length;a++){var s=n[a];s&&s.FramePick(e)}t=!0}return t},r.prototype.FrustumOctreeAction=function(e){if(e&&this.ocTree){var t=this.GetCamera().GetFrustum(),r=[],i=new f.FrustumOctreeQuery(r,t,0,0);this.ocTree.GetDrawables(i);for(var n=0;n<r.length;++n);}return!1},r.prototype.ExecuteAction=function(e){if(null!==e){var t=this.pSceneRoot.Search(f.MAINMODELROOT);null!==t&&t.Traverse(e)}},r.prototype.SetRenderManager=function(e){this.RenderMgr=e},r.prototype.GetSectionNode=function(){if(!this.sectionNode){var e=this.GetSceneRoot(),t=new f.SectionNode;t.SetScene(this),t.SetName(f.SECTION_GROUP_PATH),e.AddChild(t),this.sectionNode=t}return this.sectionNode},r.prototype.GetCamera=function(){return this.camera},r.prototype.SetCamera=function(e){this.camera=e,this.camera&&this.camera.SetSceneManager(this)},r.prototype.GetLights=function(){return null},r.prototype.GetModel=function(){return this.TopModel},r.prototype.AddModel=function(e,t){if(null!==e){(null===t||0===t.length?this.TopModel:this.GetShape(t)).GetSubModels().push(e),this.OptimizeScene(),this.RenderMgr.RequestRedraw()}},r.prototype.SetModel=function(e){if((null===e||this.TopModel!==e)&&(this.TopModel=e,null!==this.TopModel)){if(f.Parameters.Instance().OptimizeBigModel){var t=this.TopModel.GetPlaceMatrix();t.SetScale(.001),this.TopModel.SetPlaceMatrix(t)}var r=new f.ShapeNode;r.SetName(f.MAINMODELROOT),r.SetShape(this.TopModel),this.GetSceneRoot().Search(f.MAINGROUP).AddChild(r),this.TopModel.SetModelExtInfo(this.extendinfoMgr,!0),this.OptimizeScene(),this.RenderMgr.RequestRedraw()}},r.prototype.GetScreenUILayerGroup=function(){return this.pSceneRoot.Search(f.SCREENUILAYER_GROUPNODE)},r.prototype.GetAnnotationGroup=function(){var e=this.pSceneRoot.Search(f.ANNOTATION_GROUP_PATH);return e.SetScene(this),e},r.prototype.GetHandlerGroup=function(){return this.pSceneRoot.Search(f.HANDLER_GROUPNODE)},r.prototype.GetNoteGroup=function(){if(null==this.noteGroup||null==this.noteGroup){var e=this.GetSceneRoot(),t=new f.NoteGroup;t.SetName(f.NOTE_GROUP_PATH),e.AddChild(t),this.noteGroup=t}return this.noteGroup},r.prototype.GetMeasureGroup=function(){if(!this.measureGroup){var e=this.GetSceneRoot(),t=new f.MeasureGroup;t.SetScene(this),t.SetName(f.MEASURE_GROUP_PATH),e.AddChild(t),this.measureGroup=t}return this.measureGroup},r.prototype.GetSceneBoxNote=function(){return f.Parameters.Instance().m_bShowSceneBoxNote?this.m_pSceneBoxNote||this.CreateSceneBoxNote():this.m_pSceneBoxNote&&(this.m_pSceneBoxNote=null),this.m_pSceneBoxNote},r.prototype.UpdateSceneBoxNote=function(){this.m_pSceneBoxNote},r.prototype.CreateSceneBoxNote=function(){if(this.GetModel()&&null==this.m_pSceneBoxNote){this.m_pSceneBoxNote=new f.TextNote;var e=this.GetSceneBox(),t=new f.Vector3,r=new f.Vector3,i=new f.Vector3;t.x=e.max.x,t.y=e.min.y,t.z=e.min.z;var n=String(e.GetXLength());r.x=e.min.x,r.y=e.max.y,r.z=e.min.z;var o=String(e.GetYLength());i.x=e.min.x,i.y=e.min.y,i.z=e.max.z;var a=String(e.GetZLength()),s=[],l=null;(l=new f.Texts2D).setSize(14),l.setTexts(""),s.push(l),(l=new f.Texts2D).setSize(14),l.setTexts("x:"+n),s.push(l);f.MeasureDisplayHelper.createNoteTextsImageN(this,null,s,t,this.m_pSceneBoxNote),s=[],(l=new f.Texts2D).setSize(14),l.setTexts(""),s.push(l),(l=new f.Texts2D).setSize(14),l.setTexts("y:"+o),s.push(l);f.MeasureDisplayHelper.createNoteTextsImageN(this,null,s,r,this.m_pSceneBoxNote),s=[],(l=new f.Texts2D).setSize(14),l.setTexts(""),s.push(l),(l=new f.Texts2D).setSize(14),l.setTexts("z:"+a),s.push(l);f.MeasureDisplayHelper.createNoteTextsImageN(this,null,s,i,this.m_pSceneBoxNote),this.m_pSceneBoxNote.SetFrontShow(!0)}},r.prototype.RestoreRotationCenter=function(){var e=this.GetSceneBox();return this.SetRotationCenter(e.Center()),!1},r.prototype.SetRotationCenterByScreenPnt=function(e,t,r){var i=new f.Vector3,n=new f.Vector2(e,t);1.2<this.GetCamera().GetZoom()&&f.Parameters.Instance().isSpecifiedRotation&&this.GetPickPoint(n,i,!0)||(i=this.GetSceneBox().Center()),r||this.conRotationCenterId||(i=this.GetSceneBox().Center()),0<this.rotationCenterId&&this.RemoveShape(this.rotationCenterId);var o=null,a=this.GetHandlerGroup();if(null!==a){this.GetSceneBox();o=a.CreatePointHandler(i,2,3,this)}return this.AddShapeIDToMap(o),this.rotationCenterId=o.GetID(),this.SetRotationCenter(i),this.rotationCenterId},r.prototype.SetRotationCenter=function(e){var t=this.camera;return null!==t?(t.SetRotateCenter(e),!0):(f.LOGI("SetRotationCenter Camera is null"),this.GetRenderManager().RequestRedraw(),!1)},r.prototype.GetPickShape=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(4!==e.length)return this.GetPickShape(e[0].x,e[0].y,e[1],e[2]);var r=new f.RayPickAction(this);r.SetPickShapeType(e[2]),r.SetPickGeoType(e[3]),r.SetRay(e[0],e[1]),this.RayOctreeAction(r)||this.pSceneRoot.Traverse(r);for(var i=this.GetSceneRoot(),n=0;n<i.Size();n++){var o=i.GetChild(n);o.GetName()!=f.MAINGROUP&&o.RayPick(r)}var a=r.GetNearPickShape();return a&&(a.GetType(),this.AddShapeIDToMap(a),this.SetNearrestPickPoint(r.GetNearestPickPoint())),a},r.prototype.GetPickPoint=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];switch(e.length){case 2:var r=new f.Vector3;if((l=new f.RayPickAction(this)).SetPickShapeType(f.ShapeType.SHAPE_MODEL),l.SetPickGeoType(f.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_UNKNOWN),l.SetRay(e[0],e[1]),this.pSceneRoot.Traverse(l),!(h=l.GetNearPickPoint(r))){var i=l.GetData().GetCameraRay(),n=new f.Vector3,o=this.GetSceneBox();n.copyFrom(o.Center());var a=i.direction.LengthSquared(),s=n.Sub(i.origin).DotProduct(i.direction)*(1/a);r=i.direction.Multiply(s).Add(i.origin)}return this.GetRenderManager().RequestRedraw(),r;case 3:var l,h,u=!1;r=new f.Vector3;if((l=new f.RayPickAction(this)).SetPickShapeType(f.ShapeType.SHAPE_FACE),l.SetPickGeoType(f.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_UNKNOWN),l.SetRay(e[0]),this.RayOctreeAction(l)||this.pSceneRoot.Traverse(l),(h=l.GetNearPickPoint(r))||e[2])h&&(u=!0);else{i=l.GetData().GetCameraRay(),n=new f.Vector3,o=this.GetSceneBox();n.copyFrom(o.Center());a=i.direction.LengthSquared(),s=n.Sub(i.origin).DotProduct(i.direction)*(1/a);r=i.direction.Multiply(s).Add(i.origin),u=!0}return this.GetRenderManager().RequestRedraw(),e[1].copyFrom(r),u}},r.prototype.SetSelectType=function(e){this.iSelectType=e},r.prototype.GetNodes=function(e,t){for(var r=this.nodesMap[t];null!=r;){if(r.GetType()===e)return r;r=r.GetParent()}return r},r.prototype.SetMatrixByPlcPath=function(e,t){var r="M3D|MAIN|"+e,i=this.GetNode(r);if(null!==i){var n=new f.Matrix3x4(t);i.GetPlaceMatrix(n)}},r.prototype.GetMatrixByPlcPath=function(e,t){var r="M3D|MAIN|"+e,i=this.GetNode(r);if(null!==i){var n=i.GetPlaceMatrix();f.Matrix4.IDENTITY().Data(),n.Data()}},r.prototype.AddHandle=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(3===e.length){var r=e[0],i=e[1],n=e[2],o=this.GetPickPoint(r,i),a=this.CreateShape(o,n);return this.GetRenderManager().RequestRedraw(),a.GetID()}r=e[0],i=e[1];var s=e[2],l=(n=e[3],new f.Vector3(r,i,s));a=this.CreateShape(l,n);return this.GetRenderManager().RequestRedraw(),a.GetID()},r.prototype.AddShape=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(3===e.length){var r=e[0],i=e[1],n=e[2],o=this.GetPickPoint(r,i);return(a=this.CreateShape(o,n))?a.GetID():-1}r=e[0],i=e[1];var a,s=e[2],l=(n=e[3],new f.Vector3(r,i,s));return(a=this.CreateShape(l,n))?a.GetID():-1},r.prototype.CreateShape=function(e,t){switch(t){case f.ShapeType.SHAPE_POINT_HANDLE:case f.ShapeType.SHAPE_VOICE_NOTE:case f.ShapeType.SHAPE_NOTE:}return null},r.prototype.GetRenderManager=function(){return this.RenderMgr},r.prototype.GetShapePos=function(e,t,r){var i=this.GetShape(e);if(null!==i)if(0===t);else if(1===t){var n=i.GetSceneNode();null!==n&&n.GetPosition()}},r.prototype.GetShapeColor=function(e,t){var r=new f.Color,i=this.GetShape(e);return null!==i?r=i.GetColor():f.LOGE(" GetShapeColor error: shape is null!"),r},r.prototype.GetSceneBox=function(){if(!this.sceneBox.Defined()){var e=new f.CallBackAction;e.SetActionData(this),e.SetActionFun(r.ComputeLBox),e.SetActionFunModel(n.onExecuteModel),this.ExecuteAction(e)}return this.sceneBox},r.ComputeLBox=function(e,t){if(null!==t&&(t.GetType()==f.ShapeType.SHAPE_MODEL||t.GetType()==f.ShapeType.IMAGEMODEL_SHAPE)){var r=e.sceneBox,i=t.GetWorldBoundingBox();i&&i.Defined()&&r.Merge(i)}},r.prototype.SetSceneBox=function(e){this.sceneBox=e},r.prototype.GetNode=function(e){return this.nodesMap[e]},r.prototype.UpdataNodePathMap=function(){this.nodesMap={},this.shapesIDMap={};var e=new f.CallBackAction;e.SetActionData(this.nodesMap),e.SetActionFun(o.onExecute),e.SetActionFunModel(o.onExecuteModel),this.pSceneRoot.Traverse(e)},r.prototype.RemoveShape=function(e){var t=this.shapesIDMap[e];t&&(t.GetSceneNode().GetParent().DeleteChild(t.GetSceneNode()),t=null,delete this.shapesIDMap[e]);return!0},r.prototype.AddShapeIDToMap=function(e){e&&(this.shapesIDMap[e.GetID()]=e)},r.prototype.RemoveShapeIDFromMap=function(e){e&&delete this.shapesIDMap[e.GetID()]},r.prototype.ReIndexIDMapAfterAddModel=function(e){if(null!==e&&e instanceof f.Model){var t=e;this.AddShapeIDToMap(t);for(var r=t.GetBodys(),i=0;i<r.length;i++){var n=r[i];this.AddShapeIDToMap(n);for(var o=n.GetFaces(),a=0;a<o.length;a++){var s=o[a];this.AddShapeIDToMap(s);for(var l=s.GetEdges(),h=0;h<l.length;h++){var u=l[h];this.AddShapeIDToMap(u)}}var p=n.GetEdges();for(h=0;h<p.length;h++){u=p[h];this.AddShapeIDToMap(u)}var c=n.GetPoints();for(h=0;h<c.length;h++){var d=c[h];this.AddShapeIDToMap(d)}}var S=t.GetSubModels();for(i=0;i<S.length;i++)this.ReIndexIDMapAfterAddModel(S[i])}},r.prototype.ReIndexIDMapAfterAddSingleModel=function(e){if(null!=e){if(e.GetType()==f.ShapeType.SHAPE_MODEL){var t=e;if(this.AddShapeIDToMap(t),f.Parameters.Instance().useBodyObject){var r=t.GetBodys();if(r)for(var i=0;i<r.length;i++){var n=r[i];this.AddShapeIDToMap(n);for(var o=n.GetFaces(),a=0;a<o.length;a++){var s=o[a];this.AddShapeIDToMap(s);var l=s.GetEdges();if(l)for(var h=0;h<l.length;h++){var u=l[h];this.AddShapeIDToMap(u)}}var p=n.GetEdges();if(p)for(h=0;h<p.length;h++){u=p[h];this.AddShapeIDToMap(u)}var c=n.GetPoints();if(c)for(h=0;h<c.length;h++){var d=c[h];this.AddShapeIDToMap(d)}}}}this.GetRenderManager().RequestRedraw()}},r.prototype.RemoveModelCachePath=function(e){e&&this.GetNode(e.GetPlcPath())&&delete this.nodesMap[e.GetPlcPath()]},r.prototype.ReIndexIDMapAfterDeleteModel=function(e){if(null!==e&&e instanceof f.Model){var t=e;if(this.RemoveShapeIDFromMap(t),f.Parameters.Instance().useSimplePath&&this.RemoveModelCachePath(t),f.Parameters.Instance().useBodyObject)for(var r=t.GetBodys(),i=0;i<r.length;i++){var n=r[i];this.RemoveShapeIDFromMap(n);for(var o=n.GetFaces(),a=0;a<o.length;a++){var s=o[a];this.RemoveShapeIDFromMap(s);var l=s.GetEdges();if(l)for(var h=0;h<l.length;h++){var u=l[h];this.RemoveShapeIDFromMap(u)}}var p=n.GetEdges();for(h=0;h<p.length;h++){u=p[h];this.RemoveShapeIDFromMap(u)}var c=n.GetPoints();for(h=0;h<c.length;h++){var d=c[h];this.RemoveShapeIDFromMap(d)}}var S=t.GetSubModels();for(i=0;i<S.length;i++)this.ReIndexIDMapAfterDeleteModel(S[i])}},r.prototype.SetGluObj=function(e){this.glueObj=e},r.prototype.GetGlueObj=function(){return this.glueObj},r.prototype.CreateModelNodes=function(e,t,r){var i=t+"|"+(""+e.GetPlcId().toString(16)),n=new f.ModelNode;n.SetName(i),n.SetOrigPlcMatrix(e.GetPlaceMatrix().ToMatrix3x4());var o=new f.ShapeNode;o.SetName(i+"|ShapeModel"),e.SetSceneNode(o),o.SetShape(e),n.SetShapeNode(o);for(var a=e.GetSubModels(),s=0;s<a.length;s++)n.AddChild(this.CreateModelNodes(a[s],i,e.GetID()));return n},r.prototype.ClearModelAndHandles=function(){f.LOGE("clear start");var e=this.GetSceneRoot().Search(f.MAINGROUP);this.nodesMap={},e.DeleteAllChildren(),f.LOGE("clear end")},r.prototype.GetFitViewSceneBox=function(){return this.GetSceneBox(),this.sceneBox},r.prototype.GetOcTreeWorldBoundingBox=function(){var e=this.GetSceneBox().Length()/2,t=this.GetSceneBox().Center(),r=t.Sub(new f.Vector3(e,e,e)),i=t.Add(new f.Vector3(e,e,e));return new f.BoundingBox(r,i)},r.prototype.GetShape=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if("number"==typeof e[0]){var r=e[0];return this.shapesIDMap[r]}var i=e[0],n=this.GetNode(i);return null===n?(f.LOGE("GetShape null"),null):n},r.prototype.ShowRotationCenter=function(e){null!==this.RenderMgr&&(this.RenderMgr.ShowRotationCenter(e),this.GetRenderManager().RequestRedraw())},r.prototype.setSectionEnable=function(e){this.GetSectionNode().GetSection().SetVisible(e),this.GetRenderManager().RequestRedraw()},r.prototype.SetSections=function(e){0<e.length&&this.GetSection().AddPlane(e[0]);this.GetRenderManager().RequestRedraw()},r.prototype.AsynUpdateModelCacheInfo=function(e,t){e&&(this.GetShape(e.GetID())||(t?this.ReIndexIDMapAfterAddSingleModel(e):this.ReIndexIDMapAfterDeleteModel(e)))},r.prototype.GetSection=function(){var e=this.GetSceneRoot().Search(f.MAINGROUP),t=e.Search("SectionNode"),r=null;if(null!==t)null===(r=t.GetShape())&&(r=new f.Section,t.SetShape(r));else{r=new f.Section;var i=new f.ShapeNode;i.SetShape(r),i.SetName("SectionNode"),e.AddChild(i)}r.SetBox(this.GetSceneBox());var n=this.GetSceneBox().Clone();return n.ScaleBox(1.3),r.SetDrawRection(n),r},r.prototype.GetDefaultZoom=function(){var e=this.GetCamera().GetViewPort(),t=e.GetRect().Height(),r=e.GetRect().Width(),i=f.Parameters.Instance().DefaultZoomFactor;return i=i*t/r,r<t&&(i=.5*i*(1*r/t)),i},r.prototype.GetDefaultFocusLength=function(){return 1.5*this.GetSceneBox().Length()},r.prototype.GetFramePickShape=function(e,t,r,i,n){var o=new f.RayPickAction(this);(o.SetPickShapeType(r),o.SetPickGeoType(i),o.SetFramePickSection(e,t),o.SetFramePickType(n),this.FrameOctreeAction(o))||this.pSceneRoot.Traverse(o);return o.GetFramePickShapes()},r.prototype.RequestUpdateWhenSceneBoxChanged=function(){if(null!==this.ocTree){this.GetSceneBox().Clear();this.ocTree.GetWorldBoundingBox();var e=this.GetOcTreeWorldBoundingBox();this.ocTree.Clear(),this.ocTree.SetSize(e,8);var t=new f.CallBackAction;t.SetActionData(this),t.SetActionFun(null),t.SetActionFunModel(r.AddNodeToOCTree),this.ExecuteAction(t),this.RenderMgr.GetRenderAction().SetSceneBoxChanged(!0)}},r.prototype.AddNodeToOCTree=function(e){if(e.GetType()===f.ShapeType.SHAPE_MODEL){var t=e.GetModelShape();if(null!==t&&null!==this.ocTree){var r=t.GetWorldBoundingBox();null!==r&&r.Defined()&&(this.ocTree.InsertDrawable(t),t.SetOctree(this.ocTree))}}},r.AddNodeToOCTree=function(e,t){var r=e;null!==r&&t.GetType()==f.ShapeType.SHAPE_MODEL&&r.AddNodeToOCTree(t)},r.prototype.OptimizeCameraView=function(e){var t=this.GetCamera();e&&this.GetRenderManager().RequestUpdateWhenSceneBoxChanged();var r=this.GetSceneBox(),i=r.Length();if(i=this.GetDefaultFocusLength(),t.IsOrthographic()){var n=this.GetSceneBox(),o=t.GetPosition().Clone();if(n.IsInside(o)==f.INSIDE){var a=t.GetView().ToMatrix3(),s=new f.Vector3(a.data[6],a.data[7],a.data[8]);s.Normalize();var l=o.Add(s.Multiply(n.Length()));t.SetWorldPosition(l)}}t.SetNearClip(i*f.NEAR_CLIP_PLANE_FACTOR),t.SetFarClip(i*f.FAR_CLIP_PLANE_FACTOR),t.SetInitRotateCenter(r.Center())},r.prototype.GetLightManager=function(){return this.m_lightManager||(this.m_lightManager=new f.LightManager,this.m_lightManager.SetSceneManager(this),this.m_lightManager.CreateDefaultLights(),this.GetLightGroup()),this.m_lightManager},r.prototype.GetCameraManager=function(){return this.m_cameraManager||(this.m_cameraManager=new f.CameraManager,this.m_cameraManager.SetSceneManager(this),this.GetCameraGroup()),this.m_cameraManager},r.prototype.GetLightGroup=function(){if(!this.m_lightGroup){var e=this.GetSceneRoot();this.m_lightGroup=new f.LightGroup,this.m_lightGroup.SetName(f.LIGHT_GROUP_PATH),e.AddChild(this.m_lightGroup),this.m_lightGroup.SetScene(this)}return this.m_lightGroup},r.prototype.GetCameraGroup=function(){if(!this.m_cameraGroup){var e=this.GetSceneRoot();this.m_cameraGroup=new f.CameraGroup,this.m_cameraGroup.SetName(f.CAMERA_GROUP_PATH),e.AddChild(this.m_cameraGroup),this.m_cameraGroup.SetScene(this)}return this.m_cameraGroup},r.prototype.GetGeometryGroup=function(){var e=this.pSceneRoot.Search(f.GEOMETRY_GROUPNODE);if(!e){var t=new f.GeometryGroup(this);(e=t).SetName(f.GEOMETRY_GROUPNODE),this.pSceneRoot.AddChild(t)}return e},r.prototype.getGeometryManager=function(e){return this.m_geometryManager||(this.m_geometryManager=new f.GeometryManager(e)),this.m_geometryManager},r}();f.SceneManager=r}(M3D||(M3D={})),function(c){var e=function(t){function p(){var e=t.call(this)||this;return e.iPntXNum=1062,e.iPntYNum=1062,e.iPntZNum=1062,e.iPntONum=3240,e.ProArray=[-10,10,-10,10,-10,10],e.iViewX=0,e.iViewY=0,e.iWidth=1600,e.iHeight=1e3,e.iW=500,e.xColor=c.Color.RED(),e.yColor=c.Color.GREEN(),e.zColor=c.Color.BLUE(),e.oColor=c.Color.YELLOW(),e.xOffset=0,e.yOffset=0,e.zOffset=0,e.oOffset=0,e.gl=null,e.positionBuffer=null,e.colorBuffer=null,e.SetAxisPosition(p.LEFTDOWN),e}return __extends(p,t),p.prototype.SetViewSize=function(e,t,r){void 0===r&&(r=.3),this.axisPosition=p.NONE,this.iWidth=e*r,this.iHeight=t*r,this.iWidth>this.iHeight?this.iWidth=this.iHeight:this.iHeight=this.iWidth,this.srcWidth=e,this.srcHeigh=t,this.iW=this.iWidth>=this.iHeight?this.iHeight:this.iWidth},p.prototype.FindVisiableObject=function(e){if(this.IsVisible()){var t=e.GetCamera().GetRotation().RotationMatrix().Inverse(),r=new c.Quaternion(t);this.SetRotation(r),e.SetAxisNode(this)}else e.SetAxisNode(null)},p.prototype.SetAxisPosition=function(e){if(this.axisPosition=e,this.axisPosition!==e){this.axisPosition=e;var t=this.srcWidth,r=this.srcHeigh;this.iViewY=e===p.LEFTTOP?(this.iViewX=0,r-this.iHeight):e===p.LEFTDOWN?this.iViewX=0:e===p.RIGHTTOP?(this.iViewX=t-this.iWidth,r-this.iHeight):(this.iViewX=e===p.RIGHTDOWN?t-this.iWidth:0,0)}},p.prototype.GetPositionVBO=function(){if(null===this.gl)return null;if(null!==this.positionBuffer)return this.positionBuffer;this.positionBuffer=new c.HardWareVertexBuffer(this.gl);var e=new Float32Array(p.axisPntX),t=new Float32Array(p.axisPntY),r=new Float32Array(p.axisPntZ),i=new Float32Array(p.axisPntO);return this.positionBuffer.Create(0,e.length+t.length+r.length+i.length),this.xOffset=0,this.positionBuffer.SetDataRange(e,0),this.yOffset=e.length,this.positionBuffer.SetDataRange(t,this.yOffset),this.zOffset=this.yOffset+t.length,this.positionBuffer.SetDataRange(r,this.zOffset),this.oOffset=this.zOffset+r.length,this.positionBuffer.SetDataRange(i,this.oOffset),this.positionBuffer.WriteBuffer(),this.positionBuffer},p.prototype.GetColorVBO=function(){if(null===this.gl)return null;if(null!==this.colorBuffer)return this.colorBuffer;for(var e=new Float32Array(p.axisPntX.length),t=0;t<e.length-2;t+=3)e[t]=1,e[t+1]=0,e[t+2]=0;for(var r=new Float32Array(p.axisPntY.length),i=0;i<r.length-2;i+=3)r[i]=0,r[i+1]=1,r[i+2]=0;for(var n=new Float32Array(p.axisPntZ.length),o=0;o<n.length-2;o+=3)n[o]=0,n[o+1]=0,n[o+2]=1;for(var a=new Float32Array(p.axisPntO.length),s=0;s<a.length-2;s+=3)a[s]=1,a[s+1]=1,a[s+2]=0;this.colorBuffer=new c.HardWareVertexBuffer(this.gl),this.colorBuffer.Create(0,e.length+r.length+n.length+a.length);this.colorBuffer.SetDataRange(e,0);var l=e.length;this.colorBuffer.SetDataRange(r,l);var h=this.yOffset+r.length;this.colorBuffer.SetDataRange(n,h);var u=this.zOffset+n.length;return this.colorBuffer.SetDataRange(a,u),this.colorBuffer.WriteBuffer(),this.colorBuffer},p.prototype.SetCurrentGLContext=function(e){this.gl=e},p.axisPntX=[0,-.046352549,.14265847,0,.046352549,.14265847,0,.088167787,.12135254,0,-.14265847,-.046352549,0,-.046352549,-.14265847,0,-.088167787,-.12135254,0,-.14265847,-.046352549,0,.046352549,-.14265847,0,0,-.15,0,-.046352549,.14265847,0,0,.15,0,.046352549,.14265847,0,.12135254,.088167787,0,-.12135254,.088167787,0,-.088167787,.12135254,0,.046352549,-.14265847,0,-.14265847,-.046352549,0,-.15,0,0,0,-.15,0,-.046352549,-.14265847,0,-.14265847,-.046352549,0,-.14265847,.046352549,0,.12135254,.088167787,0,.14265847,.046352549,0,-.088167787,.12135254,0,-.046352549,.14265847,0,.12135254,.088167787,0,-.088167787,-.12135254,0,-.12135254,-.088167787,0,-.14265847,-.046352549,0,-.14265847,.046352549,0,.12135254,-.088167787,0,.088167787,-.12135254,0,.14265847,.046352549,0,.15,0,0,-.14265847,.046352549,0,.12135254,.088167787,0,-.14265847,.046352549,0,-.12135254,.088167787,0,.088167787,-.12135254,0,.046352549,-.14265847,0,-.14265847,.046352549,0,.088167787,.12135254,0,.12135254,.088167787,0,-.046352549,.14265847,0,-.14265847,.046352549,0,.14265847,-.046352549,0,.12135254,-.088167787,0,-.15,0,0,-.14265847,.046352549,0,.046352549,-.14265847,0,.15,0,0,.14265847,-.046352549,0,-.14265847,.046352549,0,.046352549,-.14265847,5,.046352549,-.14265847,5,0,-.15,0,.088167787,-.12135254,5,.088167787,-.12135254,5,.046352549,-.14265847,0,.12135254,-.088167787,5,.12135254,-.088167787,5,.088167787,-.12135254,0,.14265847,-.046352549,5,.14265847,-.046352549,5,.12135254,-.088167787,0,.15,0,5,.15,0,5,.14265847,-.046352549,0,.14265847,.046352549,5,.14265847,.046352549,5,.15,0,0,.12135254,.088167787,5,.12135254,.088167787,5,.14265847,.046352549,0,.088167787,.12135254,5,.088167787,.12135254,5,.12135254,.088167787,0,.046352549,.14265847,5,.046352549,.14265847,5,.088167787,.12135254,0,0,.15,5,0,.15,5,.046352549,.14265847,0,-.046352549,.14265847,5,-.046352549,.14265847,5,0,.15,0,-.088167787,.12135254,5,-.088167787,.12135254,5,-.046352549,.14265847,0,-.12135254,.088167787,5,-.12135254,.088167787,5,-.088167787,.12135254,0,-.14265847,.046352549,5,-.14265847,.046352549,5,-.12135254,.088167787,0,-.15,0,5,-.15,0,5,-.14265847,.046352549,0,-.14265847,-.046352549,5,-.14265847,-.046352549,5,-.15,0,0,-.12135254,-.088167787,5,-.12135254,-.088167787,5,-.14265847,-.046352549,0,-.088167787,-.12135254,5,-.088167787,-.12135254,5,-.12135254,-.088167787,0,-.046352549,-.14265847,5,-.046352549,-.14265847,5,-.088167787,-.12135254,0,0,-.15,5,0,-.15,5,-.046352549,-.14265847,5,-.046352549,-.14265847,0,-.046352549,-.14265847,0,0,-.15,5,-.088167787,-.12135254,0,-.088167787,-.12135254,0,-.046352549,-.14265847,5,-.12135254,-.088167787,0,-.12135254,-.088167787,0,-.088167787,-.12135254,5,-.14265847,-.046352549,0,-.14265847,-.046352549,0,-.12135254,-.088167787,5,-.15,0,0,-.15,0,0,-.14265847,-.046352549,5,-.14265847,.046352549,0,-.14265847,.046352549,0,-.15,0,5,-.12135254,.088167787,0,-.12135254,.088167787,0,-.14265847,.046352549,5,-.088167787,.12135254,0,-.088167787,.12135254,0,-.12135254,.088167787,5,-.046352549,.14265847,0,-.046352549,.14265847,0,-.088167787,.12135254,5,0,.15,0,0,.15,0,-.046352549,.14265847,5,.046352549,.14265847,0,.046352549,.14265847,0,0,.15,5,.088167787,.12135254,0,.088167787,.12135254,0,.046352549,.14265847,5,.12135254,.088167787,0,.12135254,.088167787,0,.088167787,.12135254,5,.14265847,.046352549,0,.14265847,.046352549,0,.12135254,.088167787,5,.15,0,0,.15,0,0,.14265847,.046352549,5,.14265847,-.046352549,0,.14265847,-.046352549,0,.15,0,5,.12135254,-.088167787,0,.12135254,-.088167787,0,.14265847,-.046352549,5,.088167787,-.12135254,0,.088167787,-.12135254,0,.12135254,-.088167787,5,.046352549,-.14265847,0,.046352549,-.14265847,0,.088167787,-.12135254,5,0,-.15,0,0,-.15,0,.046352549,-.14265847,5,.15450849,.47552825,5,.046352549,.14265847,5,0,.15,5,.29389262,.40450849,5,.088167787,.12135254,5,.046352549,.14265847,5,.40450849,.29389262,5,.12135254,.088167787,5,.088167787,.12135254,5,.40450849,.29389262,5,.47552825,.15450849,5,.14265847,.046352549,5,-.15450849,-.47552825,5,-.046352549,-.14265847,5,0,-.15,5,-.29389262,-.40450849,5,-.088167787,-.12135254,5,-.046352549,-.14265847,5,.046352549,.14265847,5,.15450849,.47552825,5,.29389262,.40450849,5,.14265847,.046352549,5,.12135254,.088167787,5,.40450849,.29389262,5,.5,0,5,.15,0,5,.14265847,.046352549,5,.47552825,-.15450849,5,.14265847,-.046352549,5,.15,0,5,-.046352549,-.14265847,5,-.15450849,-.47552825,5,-.29389262,-.40450849,5,-.40450849,-.29389262,5,-.12135254,-.088167787,5,-.088167787,-.12135254,5,-.47552825,-.15450849,5,-.14265847,-.046352549,5,-.12135254,-.088167787,5,-.5,0,5,-.15,0,5,-.14265847,-.046352549,5,-.47552825,.15450849,5,-.14265847,.046352549,5,-.15,0,5,-.40450849,.29389262,5,-.12135254,.088167787,5,-.14265847,.046352549,5,.088167787,.12135254,5,.29389262,.40450849,5,.40450849,.29389262,5,.15,0,5,.5,0,5,.47552825,-.15450849,5,.40450849,-.29389262,5,.12135254,-.088167787,5,.14265847,-.046352549,5,.29389262,-.40450849,5,.088167787,-.12135254,5,.12135254,-.088167787,5,-.088167787,-.12135254,5,-.29389262,-.40450849,5,-.40450849,-.29389262,5,-.14265847,-.046352549,5,-.47552825,-.15450849,5,-.5,0,5,-.14265847,.046352549,5,-.47552825,.15450849,5,-.40450849,.29389262,5,-.29389262,.40450849,5,-.088167787,.12135254,5,-.12135254,.088167787,5,.14265847,.046352549,5,.47552825,.15450849,5,.5,0,5,.12135254,-.088167787,5,.40450849,-.29389262,5,.29389262,-.40450849,5,.15450849,-.47552825,5,.046352549,-.14265847,5,.088167787,-.12135254,5,0,-.5,5,0,-.15,5,.046352549,-.14265847,5,-.12135254,-.088167787,5,-.40450849,-.29389262,5,-.47552825,-.15450849,5,-.12135254,.088167787,5,-.40450849,.29389262,5,-.29389262,.40450849,5,-.15450849,.47552825,5,-.046352549,.14265847,5,-.088167787,.12135254,5,0,.5,5,0,.15,5,-.046352549,.14265847,5,.14265847,-.046352549,5,.47552825,-.15450849,5,.40450849,-.29389262,5,.046352549,-.14265847,5,.15450849,-.47552825,5,0,-.5,5,-.15,0,5,-.5,0,5,-.47552825,.15450849,5,-.046352549,.14265847,5,-.15450849,.47552825,5,0,.5,5,.088167787,-.12135254,5,.29389262,-.40450849,5,.15450849,-.47552825,5,-.088167787,.12135254,5,-.29389262,.40450849,5,-.15450849,.47552825,5,0,-.15,5,0,-.5,5,-.15450849,-.47552825,5,0,.15,5,0,.5,5,.15450849,.47552825,5,0,-.5,5,.15450849,-.47552825,7,0,0,5,.15450849,-.47552825,5,.29389262,-.40450849,7,0,0,5,.29389262,-.40450849,5,.40450849,-.29389262,7,0,0,5,.40450849,-.29389262,5,.47552825,-.15450849,7,0,0,5,.47552825,-.15450849,5,.5,0,7,0,0,5,.5,0,5,.47552825,.15450849,7,0,0,5,.47552825,.15450849,5,.40450849,.29389262,7,0,0,5,.40450849,.29389262,5,.29389262,.40450849,7,0,0,5,.29389262,.40450849,5,.15450849,.47552825,7,0,0,5,.15450849,.47552825,5,0,.5,7,0,0,5,0,.5,5,-.15450849,.47552825,7,0,0,5,-.15450849,.47552825,5,-.29389262,.40450849,7,0,0,5,-.29389262,.40450849,5,-.40450849,.29389262,7,0,0,5,-.40450849,.29389262,5,-.47552825,.15450849,7,0,0,5,-.47552825,.15450849,5,-.5,0,7,0,0,5,-.5,0,5,-.47552825,-.15450849,7,0,0,5,-.47552825,-.15450849,5,-.40450849,-.29389262,7,0,0,5,-.40450849,-.29389262,5,-.29389262,-.40450849,7,0,0,5,-.29389262,-.40450849,5,-.15450849,-.47552825,7,0,0,5,-.15450849,-.47552825,5,0,-.5,7,0,0],p.axisPntY=[.12135254,0,-.088167787,.12135254,0,.088167787,.088167787,0,.12135254,-.14265847,0,.046352549,-.14265847,0,-.046352549,-.12135254,0,-.088167787,.12135254,0,-.088167787,.14265847,0,.046352549,.12135254,0,.088167787,.14265847,0,.046352549,.12135254,0,-.088167787,.14265847,0,-.046352549,-.14265847,0,.046352549,-.15,0,0,-.14265847,0,-.046352549,-.088167787,0,-.12135254,-.088167787,0,.12135254,-.12135254,0,.088167787,.12135254,0,-.088167787,.046352549,0,.14265847,0,0,.15,.14265847,0,-.046352549,.15,0,0,.14265847,0,.046352549,-.046352549,0,.14265847,-.088167787,0,-.12135254,-.046352549,0,-.14265847,-.12135254,0,.088167787,-.14265847,0,.046352549,-.088167787,0,-.12135254,.088167787,0,.12135254,.046352549,0,.14265847,.12135254,0,-.088167787,-.046352549,0,-.14265847,0,0,-.15,-.046352549,0,.14265847,-.088167787,0,-.12135254,-.046352549,0,.14265847,-.088167787,0,.12135254,-.046352549,0,.14265847,.088167787,0,-.12135254,.12135254,0,-.088167787,-.12135254,0,-.088167787,-.088167787,0,-.12135254,-.14265847,0,.046352549,-.046352549,0,.14265847,.046352549,0,-.14265847,.088167787,0,-.12135254,0,0,.15,-.046352549,0,.14265847,.12135254,0,-.088167787,0,0,-.15,.046352549,0,-.14265847,-.046352549,0,.14265847,.14265847,0,-.046352549,.14265847,5,-.046352549,.15,5,0,.12135254,0,-.088167787,.12135254,5,-.088167787,.14265847,5,-.046352549,.088167787,0,-.12135254,.088167787,5,-.12135254,.12135254,5,-.088167787,.046352549,0,-.14265847,.046352549,5,-.14265847,.088167787,5,-.12135254,0,0,-.15,0,5,-.15,.046352549,5,-.14265847,-.046352549,0,-.14265847,-.046352549,5,-.14265847,0,5,-.15,-.088167787,0,-.12135254,-.088167787,5,-.12135254,-.046352549,5,-.14265847,-.12135254,0,-.088167787,-.12135254,5,-.088167787,-.088167787,5,-.12135254,-.14265847,0,-.046352549,-.14265847,5,-.046352549,-.12135254,5,-.088167787,-.15,0,0,-.15,5,0,-.14265847,5,-.046352549,-.14265847,0,.046352549,-.14265847,5,.046352549,-.15,5,0,-.12135254,0,.088167787,-.12135254,5,.088167787,-.14265847,5,.046352549,-.088167787,0,.12135254,-.088167787,5,.12135254,-.12135254,5,.088167787,-.046352549,0,.14265847,-.046352549,5,.14265847,-.088167787,5,.12135254,0,0,.15,0,5,.15,-.046352549,5,.14265847,.046352549,0,.14265847,.046352549,5,.14265847,0,5,.15,.088167787,0,.12135254,.088167787,5,.12135254,.046352549,5,.14265847,.12135254,0,.088167787,.12135254,5,.088167787,.088167787,5,.12135254,.14265847,0,.046352549,.14265847,5,.046352549,.12135254,5,.088167787,.15,0,0,.15,5,0,.14265847,5,.046352549,.14265847,5,.046352549,.14265847,0,.046352549,.15,0,0,.12135254,5,.088167787,.12135254,0,.088167787,.14265847,0,.046352549,.088167787,5,.12135254,.088167787,0,.12135254,.12135254,0,.088167787,.046352549,5,.14265847,.046352549,0,.14265847,.088167787,0,.12135254,0,5,.15,0,0,.15,.046352549,0,.14265847,-.046352549,5,.14265847,-.046352549,0,.14265847,0,0,.15,-.088167787,5,.12135254,-.088167787,0,.12135254,-.046352549,0,.14265847,-.12135254,5,.088167787,-.12135254,0,.088167787,-.088167787,0,.12135254,-.14265847,5,.046352549,-.14265847,0,.046352549,-.12135254,0,.088167787,-.15,5,0,-.15,0,0,-.14265847,0,.046352549,-.14265847,5,-.046352549,-.14265847,0,-.046352549,-.15,0,0,-.12135254,5,-.088167787,-.12135254,0,-.088167787,-.14265847,0,-.046352549,-.088167787,5,-.12135254,-.088167787,0,-.12135254,-.12135254,0,-.088167787,-.046352549,5,-.14265847,-.046352549,0,-.14265847,-.088167787,0,-.12135254,0,5,-.15,0,0,-.15,-.046352549,0,-.14265847,.046352549,5,-.14265847,.046352549,0,-.14265847,0,0,-.15,.088167787,5,-.12135254,.088167787,0,-.12135254,.046352549,0,-.14265847,.12135254,5,-.088167787,.12135254,0,-.088167787,.088167787,0,-.12135254,.14265847,5,-.046352549,.14265847,0,-.046352549,.12135254,0,-.088167787,.15,5,0,.15,0,0,.14265847,0,-.046352549,.29389262,5,-.40450849,.088167787,5,-.12135254,.046352549,5,-.14265847,.40450849,5,-.29389262,.12135254,5,-.088167787,.088167787,5,-.12135254,.47552825,5,.15450849,.14265847,5,.046352549,.15,5,0,.40450849,5,.29389262,.12135254,5,.088167787,.14265847,5,.046352549,.088167787,5,-.12135254,.29389262,5,-.40450849,.40450849,5,-.29389262,.47552825,5,-.15450849,.14265847,5,-.046352549,.12135254,5,-.088167787,.14265847,5,.046352549,.47552825,5,.15450849,.40450849,5,.29389262,.29389262,5,.40450849,.088167787,5,.12135254,.12135254,5,.088167787,.15450849,5,.47552825,.046352549,5,.14265847,.088167787,5,.12135254,0,5,.5,0,5,.15,.046352549,5,.14265847,-.15450849,5,.47552825,-.046352549,5,.14265847,0,5,.15,-.29389262,5,.40450849,-.088167787,5,.12135254,-.046352549,5,.14265847,-.47552825,5,.15450849,-.14265847,5,.046352549,-.12135254,5,.088167787,-.5,5,0,-.15,5,0,-.14265847,5,.046352549,-.47552825,5,-.15450849,-.14265847,5,-.046352549,-.15,5,0,-.40450849,5,-.29389262,-.12135254,5,-.088167787,-.14265847,5,-.046352549,.15450849,5,-.47552825,.046352549,5,-.14265847,0,5,-.15,.12135254,5,-.088167787,.40450849,5,-.29389262,.47552825,5,-.15450849,.12135254,5,.088167787,.40450849,5,.29389262,.29389262,5,.40450849,.046352549,5,.14265847,.15450849,5,.47552825,0,5,.5,-.046352549,5,.14265847,-.15450849,5,.47552825,-.29389262,5,.40450849,-.40450849,5,.29389262,-.12135254,5,.088167787,-.088167787,5,.12135254,-.14265847,5,.046352549,-.47552825,5,.15450849,-.5,5,0,-.14265847,5,-.046352549,-.47552825,5,-.15450849,-.40450849,5,-.29389262,-.29389262,5,-.40450849,-.088167787,5,-.12135254,-.12135254,5,-.088167787,-.29389262,5,-.40450849,-.15450849,5,-.47552825,-.046352549,5,-.14265847,.046352549,5,-.14265847,.15450849,5,-.47552825,.29389262,5,-.40450849,.5,5,0,.15,5,0,.14265847,5,-.046352549,.088167787,5,.12135254,.29389262,5,.40450849,.15450849,5,.47552825,-.088167787,5,.12135254,-.29389262,5,.40450849,-.40450849,5,.29389262,-.15,5,0,-.5,5,0,-.47552825,5,-.15450849,-.046352549,5,-.14265847,-.088167787,5,-.12135254,-.29389262,5,-.40450849,.14265847,5,-.046352549,.47552825,5,-.15450849,.5,5,0,0,5,.15,0,5,.5,-.15450849,5,.47552825,-.12135254,5,-.088167787,-.40450849,5,-.29389262,-.29389262,5,-.40450849,0,5,-.5,0,5,-.15,-.046352549,5,-.14265847,.15,5,0,.5,5,0,.47552825,5,.15450849,-.046352549,5,-.14265847,-.15450849,5,-.47552825,0,5,-.5,-.12135254,5,.088167787,-.40450849,5,.29389262,-.47552825,5,.15450849,0,5,-.15,0,5,-.5,.15450849,5,-.47552825,.5,5,0,.47552825,5,-.15450849,0,7,0,.47552825,5,-.15450849,.40450849,5,-.29389262,0,7,0,.40450849,5,-.29389262,.29389262,5,-.40450849,0,7,0,.29389262,5,-.40450849,.15450849,5,-.47552825,0,7,0,.15450849,5,-.47552825,0,5,-.5,0,7,0,0,5,-.5,-.15450849,5,-.47552825,0,7,0,-.15450849,5,-.47552825,-.29389262,5,-.40450849,0,7,0,-.29389262,5,-.40450849,-.40450849,5,-.29389262,0,7,0,-.40450849,5,-.29389262,-.47552825,5,-.15450849,0,7,0,-.47552825,5,-.15450849,-.5,5,0,0,7,0,-.5,5,0,-.47552825,5,.15450849,0,7,0,-.47552825,5,.15450849,-.40450849,5,.29389262,0,7,0,-.40450849,5,.29389262,-.29389262,5,.40450849,0,7,0,-.29389262,5,.40450849,-.15450849,5,.47552825,0,7,0,-.15450849,5,.47552825,0,5,.5,0,7,0,0,5,.5,.15450849,5,.47552825,0,7,0,.15450849,5,.47552825,.29389262,5,.40450849,0,7,0,.29389262,5,.40450849,.40450849,5,.29389262,0,7,0,.40450849,5,.29389262,.47552825,5,.15450849,0,7,0,.47552825,5,.15450849,.5,5,0,0,7,0],p.axisPntZ=[-.14265847,-.046352549,0,-.14265847,.046352549,0,-.12135254,.088167787,0,.046352549,-.14265847,0,.14265847,-.046352549,0,.12135254,-.088167787,0,.046352549,-.14265847,0,.14265847,.046352549,0,.15,0,0,-.14265847,-.046352549,0,-.15,0,0,-.14265847,.046352549,0,-.088167787,.12135254,0,-.088167787,-.12135254,0,-.12135254,-.088167787,0,.14265847,.046352549,0,.046352549,-.14265847,0,0,-.15,0,.15,0,0,.14265847,-.046352549,0,.046352549,-.14265847,0,-.046352549,-.14265847,0,-.088167787,.12135254,0,-.046352549,.14265847,0,-.12135254,-.088167787,0,-.14265847,-.046352549,0,-.088167787,.12135254,0,.12135254,-.088167787,0,.088167787,-.12135254,0,.046352549,-.14265847,0,-.046352549,-.14265847,0,.088167787,.12135254,0,.12135254,.088167787,0,-.046352549,.14265847,0,0,.15,0,-.046352549,-.14265847,0,-.088167787,.12135254,0,-.046352549,-.14265847,0,-.088167787,-.12135254,0,.12135254,.088167787,0,.14265847,.046352549,0,-.046352549,-.14265847,0,-.12135254,.088167787,0,-.088167787,.12135254,0,-.14265847,-.046352549,0,-.046352549,-.14265847,0,.046352549,.14265847,0,.088167787,.12135254,0,0,-.15,0,-.046352549,-.14265847,0,.14265847,.046352549,0,0,.15,0,.046352549,.14265847,0,-.046352549,-.14265847,0,.14265847,.046352549,0,.14265847,.046352549,5,.15,0,5,.12135254,.088167787,0,.12135254,.088167787,5,.14265847,.046352549,5,.088167787,.12135254,0,.088167787,.12135254,5,.12135254,.088167787,5,.046352549,.14265847,0,.046352549,.14265847,5,.088167787,.12135254,5,0,.15,0,0,.15,5,.046352549,.14265847,5,-.046352549,.14265847,0,-.046352549,.14265847,5,0,.15,5,-.088167787,.12135254,0,-.088167787,.12135254,5,-.046352549,.14265847,5,-.12135254,.088167787,0,-.12135254,.088167787,5,-.088167787,.12135254,5,-.14265847,.046352549,0,-.14265847,.046352549,5,-.12135254,.088167787,5,-.15,0,0,-.15,0,5,-.14265847,.046352549,5,-.14265847,-.046352549,0,-.14265847,-.046352549,5,-.15,0,5,-.12135254,-.088167787,0,-.12135254,-.088167787,5,-.14265847,-.046352549,5,-.088167787,-.12135254,0,-.088167787,-.12135254,5,-.12135254,-.088167787,5,-.046352549,-.14265847,0,-.046352549,-.14265847,5,-.088167787,-.12135254,5,0,-.15,0,0,-.15,5,-.046352549,-.14265847,5,.046352549,-.14265847,0,.046352549,-.14265847,5,0,-.15,5,.088167787,-.12135254,0,.088167787,-.12135254,5,.046352549,-.14265847,5,.12135254,-.088167787,0,.12135254,-.088167787,5,.088167787,-.12135254,5,.14265847,-.046352549,0,.14265847,-.046352549,5,.12135254,-.088167787,5,.15,0,0,.15,0,5,.14265847,-.046352549,5,.14265847,-.046352549,5,.14265847,-.046352549,0,.15,0,0,.12135254,-.088167787,5,.12135254,-.088167787,0,.14265847,-.046352549,0,.088167787,-.12135254,5,.088167787,-.12135254,0,.12135254,-.088167787,0,.046352549,-.14265847,5,.046352549,-.14265847,0,.088167787,-.12135254,0,0,-.15,5,0,-.15,0,.046352549,-.14265847,0,-.046352549,-.14265847,5,-.046352549,-.14265847,0,0,-.15,0,-.088167787,-.12135254,5,-.088167787,-.12135254,0,-.046352549,-.14265847,0,-.12135254,-.088167787,5,-.12135254,-.088167787,0,-.088167787,-.12135254,0,-.14265847,-.046352549,5,-.14265847,-.046352549,0,-.12135254,-.088167787,0,-.15,0,5,-.15,0,0,-.14265847,-.046352549,0,-.14265847,.046352549,5,-.14265847,.046352549,0,-.15,0,0,-.12135254,.088167787,5,-.12135254,.088167787,0,-.14265847,.046352549,0,-.088167787,.12135254,5,-.088167787,.12135254,0,-.12135254,.088167787,0,-.046352549,.14265847,5,-.046352549,.14265847,0,-.088167787,.12135254,0,0,.15,5,0,.15,0,-.046352549,.14265847,0,.046352549,.14265847,5,.046352549,.14265847,0,0,.15,0,.088167787,.12135254,5,.088167787,.12135254,0,.046352549,.14265847,0,.12135254,.088167787,5,.12135254,.088167787,0,.088167787,.12135254,0,.14265847,.046352549,5,.14265847,.046352549,0,.12135254,.088167787,0,.15,0,5,.15,0,0,.14265847,.046352549,0,-.47552825,.15450849,5,-.14265847,.046352549,5,-.15,0,5,-.40450849,.29389262,5,-.12135254,.088167787,5,-.14265847,.046352549,5,-.29389262,.40450849,5,-.088167787,.12135254,5,-.12135254,.088167787,5,-.29389262,.40450849,5,-.15450849,.47552825,5,-.046352549,.14265847,5,.47552825,-.15450849,5,.14265847,-.046352549,5,.15,0,5,.40450849,-.29389262,5,.12135254,-.088167787,5,.14265847,-.046352549,5,-.14265847,.046352549,5,-.47552825,.15450849,5,-.40450849,.29389262,5,-.046352549,.14265847,5,-.088167787,.12135254,5,-.29389262,.40450849,5,0,.5,5,0,.15,5,-.046352549,.14265847,5,.15450849,.47552825,5,.046352549,.14265847,5,0,.15,5,.14265847,-.046352549,5,.47552825,-.15450849,5,.40450849,-.29389262,5,.29389262,-.40450849,5,.088167787,-.12135254,5,.12135254,-.088167787,5,.15450849,-.47552825,5,.046352549,-.14265847,5,.088167787,-.12135254,5,0,-.5,5,0,-.15,5,.046352549,-.14265847,5,-.15450849,-.47552825,5,-.046352549,-.14265847,5,0,-.15,5,-.29389262,-.40450849,5,-.088167787,-.12135254,5,-.046352549,-.14265847,5,-.12135254,.088167787,5,-.40450849,.29389262,5,-.29389262,.40450849,5,0,.15,5,0,.5,5,.15450849,.47552825,5,.29389262,.40450849,5,.088167787,.12135254,5,.046352549,.14265847,5,.40450849,.29389262,5,.12135254,.088167787,5,.088167787,.12135254,5,.12135254,-.088167787,5,.40450849,-.29389262,5,.29389262,-.40450849,5,.046352549,-.14265847,5,.15450849,-.47552825,5,0,-.5,5,-.046352549,-.14265847,5,-.15450849,-.47552825,5,-.29389262,-.40450849,5,-.40450849,-.29389262,5,-.12135254,-.088167787,5,-.088167787,-.12135254,5,-.046352549,.14265847,5,-.15450849,.47552825,5,0,.5,5,.088167787,.12135254,5,.29389262,.40450849,5,.40450849,.29389262,5,.47552825,.15450849,5,.14265847,.046352549,5,.12135254,.088167787,5,.5,0,5,.15,0,5,.14265847,.046352549,5,.088167787,-.12135254,5,.29389262,-.40450849,5,.15450849,-.47552825,5,-.088167787,-.12135254,5,-.29389262,-.40450849,5,-.40450849,-.29389262,5,-.47552825,-.15450849,5,-.14265847,-.046352549,5,-.12135254,-.088167787,5,-.5,0,5,-.15,0,5,-.14265847,-.046352549,5,.046352549,.14265847,5,.15450849,.47552825,5,.29389262,.40450849,5,.14265847,.046352549,5,.47552825,.15450849,5,.5,0,5,0,-.15,5,0,-.5,5,-.15450849,-.47552825,5,-.14265847,-.046352549,5,-.47552825,-.15450849,5,-.5,0,5,.12135254,.088167787,5,.40450849,.29389262,5,.47552825,.15450849,5,-.12135254,-.088167787,5,-.40450849,-.29389262,5,-.47552825,-.15450849,5,.15,0,5,.5,0,5,.47552825,-.15450849,5,-.15,0,5,-.5,0,5,-.47552825,.15450849,5,.5,0,5,.47552825,.15450849,5,0,0,7,.47552825,.15450849,5,.40450849,.29389262,5,0,0,7,.40450849,.29389262,5,.29389262,.40450849,5,0,0,7,.29389262,.40450849,5,.15450849,.47552825,5,0,0,7,.15450849,.47552825,5,0,.5,5,0,0,7,0,.5,5,-.15450849,.47552825,5,0,0,7,-.15450849,.47552825,5,-.29389262,.40450849,5,0,0,7,-.29389262,.40450849,5,-.40450849,.29389262,5,0,0,7,-.40450849,.29389262,5,-.47552825,.15450849,5,0,0,7,-.47552825,.15450849,5,-.5,0,5,0,0,7,-.5,0,5,-.47552825,-.15450849,5,0,0,7,-.47552825,-.15450849,5,-.40450849,-.29389262,5,0,0,7,-.40450849,-.29389262,5,-.29389262,-.40450849,5,0,0,7,-.29389262,-.40450849,5,-.15450849,-.47552825,5,0,0,7,-.15450849,-.47552825,5,0,-.5,5,0,0,7,0,-.5,5,.15450849,-.47552825,5,0,0,7,.15450849,-.47552825,5,.29389262,-.40450849,5,0,0,7,.29389262,-.40450849,5,.40450849,-.29389262,5,0,0,7,.40450849,-.29389262,5,.47552825,-.15450849,5,0,0,7,.47552825,-.15450849,5,.5,0,5,0,0,7],p.axisPntO=[.15450849,0,-.47552825,.14694631,.047745751,-.47552825,.27950849,.090817816,-.40450849,.14694631,.047745751,-.47552825,.125,.090817816,-.47552825,.23776412,.17274575,-.40450849,.125,.090817816,-.47552825,.090817816,.125,-.47552825,.17274575,.23776412,-.40450849,.090817816,.125,-.47552825,.047745751,.14694631,-.47552825,.090817816,.27950849,-.40450849,.047745751,.14694631,-.47552825,0,.15450849,-.47552825,0,.29389262,-.40450849,0,.15450849,-.47552825,-.047745751,.14694631,-.47552825,-.090817816,.27950849,-.40450849,-.047745751,.14694631,-.47552825,-.090817816,.125,-.47552825,-.17274575,.23776412,-.40450849,-.090817816,.125,-.47552825,-.125,.090817816,-.47552825,-.23776412,.17274575,-.40450849,-.125,.090817816,-.47552825,-.14694631,.047745751,-.47552825,-.27950849,.090817816,-.40450849,-.14694631,.047745751,-.47552825,-.15450849,0,-.47552825,-.29389262,0,-.40450849,-.15450849,0,-.47552825,-.14694631,-.047745751,-.47552825,-.27950849,-.090817816,-.40450849,-.14694631,-.047745751,-.47552825,-.125,-.090817816,-.47552825,-.23776412,-.17274575,-.40450849,-.125,-.090817816,-.47552825,-.090817816,-.125,-.47552825,-.17274575,-.23776412,-.40450849,-.090817816,-.125,-.47552825,-.047745751,-.14694631,-.47552825,-.090817816,-.27950849,-.40450849,-.047745751,-.14694631,-.47552825,0,-.15450849,-.47552825,0,-.29389262,-.40450849,0,-.15450849,-.47552825,.047745751,-.14694631,-.47552825,.090817816,-.27950849,-.40450849,.047745751,-.14694631,-.47552825,.090817816,-.125,-.47552825,.17274575,-.23776412,-.40450849,.090817816,-.125,-.47552825,.125,-.090817816,-.47552825,.23776412,-.17274575,-.40450849,.125,-.090817816,-.47552825,.14694631,-.047745751,-.47552825,.27950849,-.090817816,-.40450849,.14694631,-.047745751,-.47552825,.15450849,0,-.47552825,.29389262,0,-.40450849,.29389262,0,-.40450849,.27950849,.090817816,-.40450849,.38471044,.125,-.29389262,.27950849,.090817816,-.40450849,.23776412,.17274575,-.40450849,.32725424,.23776412,-.29389262,.23776412,.17274575,-.40450849,.17274575,.23776412,-.40450849,.23776412,.32725424,-.29389262,.17274575,.23776412,-.40450849,.090817816,.27950849,-.40450849,.125,.38471044,-.29389262,.090817816,.27950849,-.40450849,0,.29389262,-.40450849,0,.40450849,-.29389262,0,.29389262,-.40450849,-.090817816,.27950849,-.40450849,-.125,.38471044,-.29389262,-.090817816,.27950849,-.40450849,-.17274575,.23776412,-.40450849,-.23776412,.32725424,-.29389262,-.17274575,.23776412,-.40450849,-.23776412,.17274575,-.40450849,-.32725424,.23776412,-.29389262,-.23776412,.17274575,-.40450849,-.27950849,.090817816,-.40450849,-.38471044,.125,-.29389262,-.27950849,.090817816,-.40450849,-.29389262,0,-.40450849,-.40450849,0,-.29389262,-.29389262,0,-.40450849,-.27950849,-.090817816,-.40450849,-.38471044,-.125,-.29389262,-.27950849,-.090817816,-.40450849,-.23776412,-.17274575,-.40450849,-.32725424,-.23776412,-.29389262,-.23776412,-.17274575,-.40450849,-.17274575,-.23776412,-.40450849,-.23776412,-.32725424,-.29389262,-.17274575,-.23776412,-.40450849,-.090817816,-.27950849,-.40450849,-.125,-.38471044,-.29389262,-.090817816,-.27950849,-.40450849,0,-.29389262,-.40450849,0,-.40450849,-.29389262,0,-.29389262,-.40450849,.090817816,-.27950849,-.40450849,.125,-.38471044,-.29389262,.090817816,-.27950849,-.40450849,.17274575,-.23776412,-.40450849,.23776412,-.32725424,-.29389262,.17274575,-.23776412,-.40450849,.23776412,-.17274575,-.40450849,.32725424,-.23776412,-.29389262,.23776412,-.17274575,-.40450849,.27950849,-.090817816,-.40450849,.38471044,-.125,-.29389262,.27950849,-.090817816,-.40450849,.29389262,0,-.40450849,.40450849,0,-.29389262,.40450849,0,-.29389262,.38471044,.125,-.29389262,.45225424,.14694631,-.15450849,.38471044,.125,-.29389262,.32725424,.23776412,-.29389262,.38471044,.27950849,-.15450849,.32725424,.23776412,-.29389262,.23776412,.32725424,-.29389262,.27950849,.38471044,-.15450849,.23776412,.32725424,-.29389262,.125,.38471044,-.29389262,.14694631,.45225424,-.15450849,.125,.38471044,-.29389262,0,.40450849,-.29389262,0,.47552825,-.15450849,0,.40450849,-.29389262,-.125,.38471044,-.29389262,-.14694631,.45225424,-.15450849,-.125,.38471044,-.29389262,-.23776412,.32725424,-.29389262,-.27950849,.38471044,-.15450849,-.23776412,.32725424,-.29389262,-.32725424,.23776412,-.29389262,-.38471044,.27950849,-.15450849,-.32725424,.23776412,-.29389262,-.38471044,.125,-.29389262,-.45225424,.14694631,-.15450849,-.38471044,.125,-.29389262,-.40450849,0,-.29389262,-.47552825,0,-.15450849,-.40450849,0,-.29389262,-.38471044,-.125,-.29389262,-.45225424,-.14694631,-.15450849,-.38471044,-.125,-.29389262,-.32725424,-.23776412,-.29389262,-.38471044,-.27950849,-.15450849,-.32725424,-.23776412,-.29389262,-.23776412,-.32725424,-.29389262,-.27950849,-.38471044,-.15450849,-.23776412,-.32725424,-.29389262,-.125,-.38471044,-.29389262,-.14694631,-.45225424,-.15450849,-.125,-.38471044,-.29389262,0,-.40450849,-.29389262,0,-.47552825,-.15450849,0,-.40450849,-.29389262,.125,-.38471044,-.29389262,.14694631,-.45225424,-.15450849,.125,-.38471044,-.29389262,.23776412,-.32725424,-.29389262,.27950849,-.38471044,-.15450849,.23776412,-.32725424,-.29389262,.32725424,-.23776412,-.29389262,.38471044,-.27950849,-.15450849,.32725424,-.23776412,-.29389262,.38471044,-.125,-.29389262,.45225424,-.14694631,-.15450849,.38471044,-.125,-.29389262,.40450849,0,-.29389262,.47552825,0,-.15450849,.47552825,0,-.15450849,.45225424,.14694631,-.15450849,.47552825,.15450849,0,.45225424,.14694631,-.15450849,.38471044,.27950849,-.15450849,.40450849,.29389262,0,.38471044,.27950849,-.15450849,.27950849,.38471044,-.15450849,.29389262,.40450849,0,.27950849,.38471044,-.15450849,.14694631,.45225424,-.15450849,.15450849,.47552825,0,.14694631,.45225424,-.15450849,0,.47552825,-.15450849,0,.5,0,0,.47552825,-.15450849,-.14694631,.45225424,-.15450849,-.15450849,.47552825,0,-.14694631,.45225424,-.15450849,-.27950849,.38471044,-.15450849,-.29389262,.40450849,0,-.27950849,.38471044,-.15450849,-.38471044,.27950849,-.15450849,-.40450849,.29389262,0,-.38471044,.27950849,-.15450849,-.45225424,.14694631,-.15450849,-.47552825,.15450849,0,-.45225424,.14694631,-.15450849,-.47552825,0,-.15450849,-.5,0,0,-.47552825,0,-.15450849,-.45225424,-.14694631,-.15450849,-.47552825,-.15450849,0,-.45225424,-.14694631,-.15450849,-.38471044,-.27950849,-.15450849,-.40450849,-.29389262,0,-.38471044,-.27950849,-.15450849,-.27950849,-.38471044,-.15450849,-.29389262,-.40450849,0,-.27950849,-.38471044,-.15450849,-.14694631,-.45225424,-.15450849,-.15450849,-.47552825,0,-.14694631,-.45225424,-.15450849,0,-.47552825,-.15450849,0,-.5,0,0,-.47552825,-.15450849,.14694631,-.45225424,-.15450849,.15450849,-.47552825,0,.14694631,-.45225424,-.15450849,.27950849,-.38471044,-.15450849,.29389262,-.40450849,0,.27950849,-.38471044,-.15450849,.38471044,-.27950849,-.15450849,.40450849,-.29389262,0,.38471044,-.27950849,-.15450849,.45225424,-.14694631,-.15450849,.47552825,-.15450849,0,.45225424,-.14694631,-.15450849,.47552825,0,-.15450849,.5,0,0,.5,0,0,.47552825,.15450849,0,.45225424,.14694631,.15450849,.47552825,.15450849,0,.40450849,.29389262,0,.38471044,.27950849,.15450849,.40450849,.29389262,0,.29389262,.40450849,0,.27950849,.38471044,.15450849,.29389262,.40450849,0,.15450849,.47552825,0,.14694631,.45225424,.15450849,.15450849,.47552825,0,0,.5,0,0,.47552825,.15450849,0,.5,0,-.15450849,.47552825,0,-.14694631,.45225424,.15450849,-.15450849,.47552825,0,-.29389262,.40450849,0,-.27950849,.38471044,.15450849,-.29389262,.40450849,0,-.40450849,.29389262,0,-.38471044,.27950849,.15450849,-.40450849,.29389262,0,-.47552825,.15450849,0,-.45225424,.14694631,.15450849,-.47552825,.15450849,0,-.5,0,0,-.47552825,0,.15450849,-.5,0,0,-.47552825,-.15450849,0,-.45225424,-.14694631,.15450849,-.47552825,-.15450849,0,-.40450849,-.29389262,0,-.38471044,-.27950849,.15450849,-.40450849,-.29389262,0,-.29389262,-.40450849,0,-.27950849,-.38471044,.15450849,-.29389262,-.40450849,0,-.15450849,-.47552825,0,-.14694631,-.45225424,.15450849,-.15450849,-.47552825,0,0,-.5,0,0,-.47552825,.15450849,0,-.5,0,.15450849,-.47552825,0,.14694631,-.45225424,.15450849,.15450849,-.47552825,0,.29389262,-.40450849,0,.27950849,-.38471044,.15450849,.29389262,-.40450849,0,.40450849,-.29389262,0,.38471044,-.27950849,.15450849,.40450849,-.29389262,0,.47552825,-.15450849,0,.45225424,-.14694631,.15450849,.47552825,-.15450849,0,.5,0,0,.47552825,0,.15450849,.47552825,0,.15450849,.45225424,.14694631,.15450849,.38471044,.125,.29389262,.45225424,.14694631,.15450849,.38471044,.27950849,.15450849,.32725424,.23776412,.29389262,.38471044,.27950849,.15450849,.27950849,.38471044,.15450849,.23776412,.32725424,.29389262,.27950849,.38471044,.15450849,.14694631,.45225424,.15450849,.125,.38471044,.29389262,.14694631,.45225424,.15450849,0,.47552825,.15450849,0,.40450849,.29389262,0,.47552825,.15450849,-.14694631,.45225424,.15450849,-.125,.38471044,.29389262,-.14694631,.45225424,.15450849,-.27950849,.38471044,.15450849,-.23776412,.32725424,.29389262,-.27950849,.38471044,.15450849,-.38471044,.27950849,.15450849,-.32725424,.23776412,.29389262,-.38471044,.27950849,.15450849,-.45225424,.14694631,.15450849,-.38471044,.125,.29389262,-.45225424,.14694631,.15450849,-.47552825,0,.15450849,-.40450849,0,.29389262,-.47552825,0,.15450849,-.45225424,-.14694631,.15450849,-.38471044,-.125,.29389262,-.45225424,-.14694631,.15450849,-.38471044,-.27950849,.15450849,-.32725424,-.23776412,.29389262,-.38471044,-.27950849,.15450849,-.27950849,-.38471044,.15450849,-.23776412,-.32725424,.29389262,-.27950849,-.38471044,.15450849,-.14694631,-.45225424,.15450849,-.125,-.38471044,.29389262,-.14694631,-.45225424,.15450849,0,-.47552825,.15450849,0,-.40450849,.29389262,0,-.47552825,.15450849,.14694631,-.45225424,.15450849,.125,-.38471044,.29389262,.14694631,-.45225424,.15450849,.27950849,-.38471044,.15450849,.23776412,-.32725424,.29389262,.27950849,-.38471044,.15450849,.38471044,-.27950849,.15450849,.32725424,-.23776412,.29389262,.38471044,-.27950849,.15450849,.45225424,-.14694631,.15450849,.38471044,-.125,.29389262,.45225424,-.14694631,.15450849,.47552825,0,.15450849,.40450849,0,.29389262,.40450849,0,.29389262,.38471044,.125,.29389262,.27950849,.090817816,.40450849,.38471044,.125,.29389262,.32725424,.23776412,.29389262,.23776412,.17274575,.40450849,.32725424,.23776412,.29389262,.23776412,.32725424,.29389262,.17274575,.23776412,.40450849,.23776412,.32725424,.29389262,.125,.38471044,.29389262,.090817816,.27950849,.40450849,.125,.38471044,.29389262,0,.40450849,.29389262,0,.29389262,.40450849,0,.40450849,.29389262,-.125,.38471044,.29389262,-.090817816,.27950849,.40450849,-.125,.38471044,.29389262,-.23776412,.32725424,.29389262,-.17274575,.23776412,.40450849,-.23776412,.32725424,.29389262,-.32725424,.23776412,.29389262,-.23776412,.17274575,.40450849,-.32725424,.23776412,.29389262,-.38471044,.125,.29389262,-.27950849,.090817816,.40450849,-.38471044,.125,.29389262,-.40450849,0,.29389262,-.29389262,0,.40450849,-.40450849,0,.29389262,-.38471044,-.125,.29389262,-.27950849,-.090817816,.40450849,-.38471044,-.125,.29389262,-.32725424,-.23776412,.29389262,-.23776412,-.17274575,.40450849,-.32725424,-.23776412,.29389262,-.23776412,-.32725424,.29389262,-.17274575,-.23776412,.40450849,-.23776412,-.32725424,.29389262,-.125,-.38471044,.29389262,-.090817816,-.27950849,.40450849,-.125,-.38471044,.29389262,0,-.40450849,.29389262,0,-.29389262,.40450849,0,-.40450849,.29389262,.125,-.38471044,.29389262,.090817816,-.27950849,.40450849,.125,-.38471044,.29389262,.23776412,-.32725424,.29389262,.17274575,-.23776412,.40450849,.23776412,-.32725424,.29389262,.32725424,-.23776412,.29389262,.23776412,-.17274575,.40450849,.32725424,-.23776412,.29389262,.38471044,-.125,.29389262,.27950849,-.090817816,.40450849,.38471044,-.125,.29389262,.40450849,0,.29389262,.29389262,0,.40450849,.29389262,0,.40450849,.27950849,.090817816,.40450849,.14694631,.047745751,.47552825,.27950849,.090817816,.40450849,.23776412,.17274575,.40450849,.125,.090817816,.47552825,.23776412,.17274575,.40450849,.17274575,.23776412,.40450849,.090817816,.125,.47552825,.17274575,.23776412,.40450849,.090817816,.27950849,.40450849,.047745751,.14694631,.47552825,.090817816,.27950849,.40450849,0,.29389262,.40450849,0,.15450849,.47552825,0,.29389262,.40450849,-.090817816,.27950849,.40450849,-.047745751,.14694631,.47552825,-.090817816,.27950849,.40450849,-.17274575,.23776412,.40450849,-.090817816,.125,.47552825,-.17274575,.23776412,.40450849,-.23776412,.17274575,.40450849,-.125,.090817816,.47552825,-.23776412,.17274575,.40450849,-.27950849,.090817816,.40450849,-.14694631,.047745751,.47552825,-.27950849,.090817816,.40450849,-.29389262,0,.40450849,-.15450849,0,.47552825,-.29389262,0,.40450849,-.27950849,-.090817816,.40450849,-.14694631,-.047745751,.47552825,-.27950849,-.090817816,.40450849,-.23776412,-.17274575,.40450849,-.125,-.090817816,.47552825,-.23776412,-.17274575,.40450849,-.17274575,-.23776412,.40450849,-.090817816,-.125,.47552825,-.17274575,-.23776412,.40450849,-.090817816,-.27950849,.40450849,-.047745751,-.14694631,.47552825,-.090817816,-.27950849,.40450849,0,-.29389262,.40450849,0,-.15450849,.47552825,0,-.29389262,.40450849,.090817816,-.27950849,.40450849,.047745751,-.14694631,.47552825,.090817816,-.27950849,.40450849,.17274575,-.23776412,.40450849,.090817816,-.125,.47552825,.17274575,-.23776412,.40450849,.23776412,-.17274575,.40450849,.125,-.090817816,.47552825,.23776412,-.17274575,.40450849,.27950849,-.090817816,.40450849,.14694631,-.047745751,.47552825,.27950849,-.090817816,.40450849,.29389262,0,.40450849,.15450849,0,.47552825,0,0,.5,.14694631,-.047745751,.47552825,.15450849,0,.47552825,0,0,.5,.125,-.090817816,.47552825,.14694631,-.047745751,.47552825,0,0,.5,.090817816,-.125,.47552825,.125,-.090817816,.47552825,0,0,.5,.047745751,-.14694631,.47552825,.090817816,-.125,.47552825,0,0,.5,0,-.15450849,.47552825,.047745751,-.14694631,.47552825,0,0,.5,-.047745751,-.14694631,.47552825,0,-.15450849,.47552825,0,0,.5,-.090817816,-.125,.47552825,-.047745751,-.14694631,.47552825,0,0,.5,-.125,-.090817816,.47552825,-.090817816,-.125,.47552825,0,0,.5,-.14694631,-.047745751,.47552825,-.125,-.090817816,.47552825,0,0,.5,-.15450849,0,.47552825,-.14694631,-.047745751,.47552825,0,0,.5,-.14694631,.047745751,.47552825,-.15450849,0,.47552825,0,0,.5,-.125,.090817816,.47552825,-.14694631,.047745751,.47552825,0,0,.5,-.090817816,.125,.47552825,-.125,.090817816,.47552825,0,0,.5,-.047745751,.14694631,.47552825,-.090817816,.125,.47552825,0,0,.5,0,.15450849,.47552825,-.047745751,.14694631,.47552825,0,0,.5,.047745751,.14694631,.47552825,0,.15450849,.47552825,0,0,.5,.090817816,.125,.47552825,.047745751,.14694631,.47552825,0,0,.5,.125,.090817816,.47552825,.090817816,.125,.47552825,0,0,.5,.14694631,.047745751,.47552825,.125,.090817816,.47552825,0,0,.5,.15450849,0,.47552825,.14694631,.047745751,.47552825,.15450849,0,.47552825,.14694631,-.047745751,.47552825,.27950849,-.090817816,.40450849,.14694631,-.047745751,.47552825,.125,-.090817816,.47552825,.23776412,-.17274575,.40450849,.125,-.090817816,.47552825,.090817816,-.125,.47552825,.17274575,-.23776412,.40450849,.090817816,-.125,.47552825,.047745751,-.14694631,.47552825,.090817816,-.27950849,.40450849,.047745751,-.14694631,.47552825,0,-.15450849,.47552825,0,-.29389262,.40450849,0,-.15450849,.47552825,-.047745751,-.14694631,.47552825,-.090817816,-.27950849,.40450849,-.047745751,-.14694631,.47552825,-.090817816,-.125,.47552825,-.17274575,-.23776412,.40450849,-.090817816,-.125,.47552825,-.125,-.090817816,.47552825,-.23776412,-.17274575,.40450849,-.125,-.090817816,.47552825,-.14694631,-.047745751,.47552825,-.27950849,-.090817816,.40450849,-.14694631,-.047745751,.47552825,-.15450849,0,.47552825,-.29389262,0,.40450849,-.15450849,0,.47552825,-.14694631,.047745751,.47552825,-.27950849,.090817816,.40450849,-.14694631,.047745751,.47552825,-.125,.090817816,.47552825,-.23776412,.17274575,.40450849,-.125,.090817816,.47552825,-.090817816,.125,.47552825,-.17274575,.23776412,.40450849,-.090817816,.125,.47552825,-.047745751,.14694631,.47552825,-.090817816,.27950849,.40450849,-.047745751,.14694631,.47552825,0,.15450849,.47552825,0,.29389262,.40450849,0,.15450849,.47552825,.047745751,.14694631,.47552825,.090817816,.27950849,.40450849,.047745751,.14694631,.47552825,.090817816,.125,.47552825,.17274575,.23776412,.40450849,.090817816,.125,.47552825,.125,.090817816,.47552825,.23776412,.17274575,.40450849,.125,.090817816,.47552825,.14694631,.047745751,.47552825,.27950849,.090817816,.40450849,.14694631,.047745751,.47552825,.15450849,0,.47552825,.29389262,0,.40450849,.29389262,0,.40450849,.27950849,-.090817816,.40450849,.38471044,-.125,.29389262,.27950849,-.090817816,.40450849,.23776412,-.17274575,.40450849,.32725424,-.23776412,.29389262,.23776412,-.17274575,.40450849,.17274575,-.23776412,.40450849,.23776412,-.32725424,.29389262,.17274575,-.23776412,.40450849,.090817816,-.27950849,.40450849,.125,-.38471044,.29389262,.090817816,-.27950849,.40450849,0,-.29389262,.40450849,0,-.40450849,.29389262,0,-.29389262,.40450849,-.090817816,-.27950849,.40450849,-.125,-.38471044,.29389262,-.090817816,-.27950849,.40450849,-.17274575,-.23776412,.40450849,-.23776412,-.32725424,.29389262,-.17274575,-.23776412,.40450849,-.23776412,-.17274575,.40450849,-.32725424,-.23776412,.29389262,-.23776412,-.17274575,.40450849,-.27950849,-.090817816,.40450849,-.38471044,-.125,.29389262,-.27950849,-.090817816,.40450849,-.29389262,0,.40450849,-.40450849,0,.29389262,-.29389262,0,.40450849,-.27950849,.090817816,.40450849,-.38471044,.125,.29389262,-.27950849,.090817816,.40450849,-.23776412,.17274575,.40450849,-.32725424,.23776412,.29389262,-.23776412,.17274575,.40450849,-.17274575,.23776412,.40450849,-.23776412,.32725424,.29389262,-.17274575,.23776412,.40450849,-.090817816,.27950849,.40450849,-.125,.38471044,.29389262,-.090817816,.27950849,.40450849,0,.29389262,.40450849,0,.40450849,.29389262,0,.29389262,.40450849,.090817816,.27950849,.40450849,.125,.38471044,.29389262,.090817816,.27950849,.40450849,.17274575,.23776412,.40450849,.23776412,.32725424,.29389262,.17274575,.23776412,.40450849,.23776412,.17274575,.40450849,.32725424,.23776412,.29389262,.23776412,.17274575,.40450849,.27950849,.090817816,.40450849,.38471044,.125,.29389262,.27950849,.090817816,.40450849,.29389262,0,.40450849,.40450849,0,.29389262,.40450849,0,.29389262,.38471044,-.125,.29389262,.45225424,-.14694631,.15450849,.38471044,-.125,.29389262,.32725424,-.23776412,.29389262,.38471044,-.27950849,.15450849,.32725424,-.23776412,.29389262,.23776412,-.32725424,.29389262,.27950849,-.38471044,.15450849,.23776412,-.32725424,.29389262,.125,-.38471044,.29389262,.14694631,-.45225424,.15450849,.125,-.38471044,.29389262,0,-.40450849,.29389262,0,-.47552825,.15450849,0,-.40450849,.29389262,-.125,-.38471044,.29389262,-.14694631,-.45225424,.15450849,-.125,-.38471044,.29389262,-.23776412,-.32725424,.29389262,-.27950849,-.38471044,.15450849,-.23776412,-.32725424,.29389262,-.32725424,-.23776412,.29389262,-.38471044,-.27950849,.15450849,-.32725424,-.23776412,.29389262,-.38471044,-.125,.29389262,-.45225424,-.14694631,.15450849,-.38471044,-.125,.29389262,-.40450849,0,.29389262,-.47552825,0,.15450849,-.40450849,0,.29389262,-.38471044,.125,.29389262,-.45225424,.14694631,.15450849,-.38471044,.125,.29389262,-.32725424,.23776412,.29389262,-.38471044,.27950849,.15450849,-.32725424,.23776412,.29389262,-.23776412,.32725424,.29389262,-.27950849,.38471044,.15450849,-.23776412,.32725424,.29389262,-.125,.38471044,.29389262,-.14694631,.45225424,.15450849,-.125,.38471044,.29389262,0,.40450849,.29389262,0,.47552825,.15450849,0,.40450849,.29389262,.125,.38471044,.29389262,.14694631,.45225424,.15450849,.125,.38471044,.29389262,.23776412,.32725424,.29389262,.27950849,.38471044,.15450849,.23776412,.32725424,.29389262,.32725424,.23776412,.29389262,.38471044,.27950849,.15450849,.32725424,.23776412,.29389262,.38471044,.125,.29389262,.45225424,.14694631,.15450849,.38471044,.125,.29389262,.40450849,0,.29389262,.47552825,0,.15450849,.47552825,0,.15450849,.45225424,-.14694631,.15450849,.47552825,-.15450849,0,.45225424,-.14694631,.15450849,.38471044,-.27950849,.15450849,.40450849,-.29389262,0,.38471044,-.27950849,.15450849,.27950849,-.38471044,.15450849,.29389262,-.40450849,0,.27950849,-.38471044,.15450849,.14694631,-.45225424,.15450849,.15450849,-.47552825,0,.14694631,-.45225424,.15450849,0,-.47552825,.15450849,0,-.5,0,0,-.47552825,.15450849,-.14694631,-.45225424,.15450849,-.15450849,-.47552825,0,-.14694631,-.45225424,.15450849,-.27950849,-.38471044,.15450849,-.29389262,-.40450849,0,-.27950849,-.38471044,.15450849,-.38471044,-.27950849,.15450849,-.40450849,-.29389262,0,-.38471044,-.27950849,.15450849,-.45225424,-.14694631,.15450849,-.47552825,-.15450849,0,-.45225424,-.14694631,.15450849,-.47552825,0,.15450849,-.5,0,0,-.47552825,0,.15450849,-.45225424,.14694631,.15450849,-.47552825,.15450849,0,-.45225424,.14694631,.15450849,-.38471044,.27950849,.15450849,-.40450849,.29389262,0,-.38471044,.27950849,.15450849,-.27950849,.38471044,.15450849,-.29389262,.40450849,0,-.27950849,.38471044,.15450849,-.14694631,.45225424,.15450849,-.15450849,.47552825,0,-.14694631,.45225424,.15450849,0,.47552825,.15450849,0,.5,0,0,.47552825,.15450849,.14694631,.45225424,.15450849,.15450849,.47552825,0,.14694631,.45225424,.15450849,.27950849,.38471044,.15450849,.29389262,.40450849,0,.27950849,.38471044,.15450849,.38471044,.27950849,.15450849,.40450849,.29389262,0,.38471044,.27950849,.15450849,.45225424,.14694631,.15450849,.47552825,.15450849,0,.45225424,.14694631,.15450849,.47552825,0,.15450849,.5,0,0,.5,0,0,.47552825,-.15450849,0,.45225424,-.14694631,-.15450849,.47552825,-.15450849,0,.40450849,-.29389262,0,.38471044,-.27950849,-.15450849,.40450849,-.29389262,0,.29389262,-.40450849,0,.27950849,-.38471044,-.15450849,.29389262,-.40450849,0,.15450849,-.47552825,0,.14694631,-.45225424,-.15450849,.15450849,-.47552825,0,0,-.5,0,0,-.47552825,-.15450849,0,-.5,0,-.15450849,-.47552825,0,-.14694631,-.45225424,-.15450849,-.15450849,-.47552825,0,-.29389262,-.40450849,0,-.27950849,-.38471044,-.15450849,-.29389262,-.40450849,0,-.40450849,-.29389262,0,-.38471044,-.27950849,-.15450849,-.40450849,-.29389262,0,-.47552825,-.15450849,0,-.45225424,-.14694631,-.15450849,-.47552825,-.15450849,0,-.5,0,0,-.47552825,0,-.15450849,-.5,0,0,-.47552825,.15450849,0,-.45225424,.14694631,-.15450849,-.47552825,.15450849,0,-.40450849,.29389262,0,-.38471044,.27950849,-.15450849,-.40450849,.29389262,0,-.29389262,.40450849,0,-.27950849,.38471044,-.15450849,-.29389262,.40450849,0,-.15450849,.47552825,0,-.14694631,.45225424,-.15450849,-.15450849,.47552825,0,0,.5,0,0,.47552825,-.15450849,0,.5,0,.15450849,.47552825,0,.14694631,.45225424,-.15450849,.15450849,.47552825,0,.29389262,.40450849,0,.27950849,.38471044,-.15450849,.29389262,.40450849,0,.40450849,.29389262,0,.38471044,.27950849,-.15450849,.40450849,.29389262,0,.47552825,.15450849,0,.45225424,.14694631,-.15450849,.47552825,.15450849,0,.5,0,0,.47552825,0,-.15450849,.47552825,0,-.15450849,.45225424,-.14694631,-.15450849,.38471044,-.125,-.29389262,.45225424,-.14694631,-.15450849,.38471044,-.27950849,-.15450849,.32725424,-.23776412,-.29389262,.38471044,-.27950849,-.15450849,.27950849,-.38471044,-.15450849,.23776412,-.32725424,-.29389262,.27950849,-.38471044,-.15450849,.14694631,-.45225424,-.15450849,.125,-.38471044,-.29389262,.14694631,-.45225424,-.15450849,0,-.47552825,-.15450849,0,-.40450849,-.29389262,0,-.47552825,-.15450849,-.14694631,-.45225424,-.15450849,-.125,-.38471044,-.29389262,-.14694631,-.45225424,-.15450849,-.27950849,-.38471044,-.15450849,-.23776412,-.32725424,-.29389262,-.27950849,-.38471044,-.15450849,-.38471044,-.27950849,-.15450849,-.32725424,-.23776412,-.29389262,-.38471044,-.27950849,-.15450849,-.45225424,-.14694631,-.15450849,-.38471044,-.125,-.29389262,-.45225424,-.14694631,-.15450849,-.47552825,0,-.15450849,-.40450849,0,-.29389262,-.47552825,0,-.15450849,-.45225424,.14694631,-.15450849,-.38471044,.125,-.29389262,-.45225424,.14694631,-.15450849,-.38471044,.27950849,-.15450849,-.32725424,.23776412,-.29389262,-.38471044,.27950849,-.15450849,-.27950849,.38471044,-.15450849,-.23776412,.32725424,-.29389262,-.27950849,.38471044,-.15450849,-.14694631,.45225424,-.15450849,-.125,.38471044,-.29389262,-.14694631,.45225424,-.15450849,0,.47552825,-.15450849,0,.40450849,-.29389262,0,.47552825,-.15450849,.14694631,.45225424,-.15450849,.125,.38471044,-.29389262,.14694631,.45225424,-.15450849,.27950849,.38471044,-.15450849,.23776412,.32725424,-.29389262,.27950849,.38471044,-.15450849,.38471044,.27950849,-.15450849,.32725424,.23776412,-.29389262,.38471044,.27950849,-.15450849,.45225424,.14694631,-.15450849,.38471044,.125,-.29389262,.45225424,.14694631,-.15450849,.47552825,0,-.15450849,.40450849,0,-.29389262,.40450849,0,-.29389262,.38471044,-.125,-.29389262,.27950849,-.090817816,-.40450849,.38471044,-.125,-.29389262,.32725424,-.23776412,-.29389262,.23776412,-.17274575,-.40450849,.32725424,-.23776412,-.29389262,.23776412,-.32725424,-.29389262,.17274575,-.23776412,-.40450849,.23776412,-.32725424,-.29389262,.125,-.38471044,-.29389262,.090817816,-.27950849,-.40450849,.125,-.38471044,-.29389262,0,-.40450849,-.29389262,0,-.29389262,-.40450849,0,-.40450849,-.29389262,-.125,-.38471044,-.29389262,-.090817816,-.27950849,-.40450849,-.125,-.38471044,-.29389262,-.23776412,-.32725424,-.29389262,-.17274575,-.23776412,-.40450849,-.23776412,-.32725424,-.29389262,-.32725424,-.23776412,-.29389262,-.23776412,-.17274575,-.40450849,-.32725424,-.23776412,-.29389262,-.38471044,-.125,-.29389262,-.27950849,-.090817816,-.40450849,-.38471044,-.125,-.29389262,-.40450849,0,-.29389262,-.29389262,0,-.40450849,-.40450849,0,-.29389262,-.38471044,.125,-.29389262,-.27950849,.090817816,-.40450849,-.38471044,.125,-.29389262,-.32725424,.23776412,-.29389262,-.23776412,.17274575,-.40450849,-.32725424,.23776412,-.29389262,-.23776412,.32725424,-.29389262,-.17274575,.23776412,-.40450849,-.23776412,.32725424,-.29389262,-.125,.38471044,-.29389262,-.090817816,.27950849,-.40450849,-.125,.38471044,-.29389262,0,.40450849,-.29389262,0,.29389262,-.40450849,0,.40450849,-.29389262,.125,.38471044,-.29389262,.090817816,.27950849,-.40450849,.125,.38471044,-.29389262,.23776412,.32725424,-.29389262,.17274575,.23776412,-.40450849,.23776412,.32725424,-.29389262,.32725424,.23776412,-.29389262,.23776412,.17274575,-.40450849,.32725424,.23776412,-.29389262,.38471044,.125,-.29389262,.27950849,.090817816,-.40450849,.38471044,.125,-.29389262,.40450849,0,-.29389262,.29389262,0,-.40450849,.29389262,0,-.40450849,.27950849,-.090817816,-.40450849,.14694631,-.047745751,-.47552825,.27950849,-.090817816,-.40450849,.23776412,-.17274575,-.40450849,.125,-.090817816,-.47552825,.23776412,-.17274575,-.40450849,.17274575,-.23776412,-.40450849,.090817816,-.125,-.47552825,.17274575,-.23776412,-.40450849,.090817816,-.27950849,-.40450849,.047745751,-.14694631,-.47552825,.090817816,-.27950849,-.40450849,0,-.29389262,-.40450849,0,-.15450849,-.47552825,0,-.29389262,-.40450849,-.090817816,-.27950849,-.40450849,-.047745751,-.14694631,-.47552825,-.090817816,-.27950849,-.40450849,-.17274575,-.23776412,-.40450849,-.090817816,-.125,-.47552825,-.17274575,-.23776412,-.40450849,-.23776412,-.17274575,-.40450849,-.125,-.090817816,-.47552825,-.23776412,-.17274575,-.40450849,-.27950849,-.090817816,-.40450849,-.14694631,-.047745751,-.47552825,-.27950849,-.090817816,-.40450849,-.29389262,0,-.40450849,-.15450849,0,-.47552825,-.29389262,0,-.40450849,-.27950849,.090817816,-.40450849,-.14694631,.047745751,-.47552825,-.27950849,.090817816,-.40450849,-.23776412,.17274575,-.40450849,-.125,.090817816,-.47552825,-.23776412,.17274575,-.40450849,-.17274575,.23776412,-.40450849,-.090817816,.125,-.47552825,-.17274575,.23776412,-.40450849,-.090817816,.27950849,-.40450849,-.047745751,.14694631,-.47552825,-.090817816,.27950849,-.40450849,0,.29389262,-.40450849,0,.15450849,-.47552825,0,.29389262,-.40450849,.090817816,.27950849,-.40450849,.047745751,.14694631,-.47552825,.090817816,.27950849,-.40450849,.17274575,.23776412,-.40450849,.090817816,.125,-.47552825,.17274575,.23776412,-.40450849,.23776412,.17274575,-.40450849,.125,.090817816,-.47552825,.23776412,.17274575,-.40450849,.27950849,.090817816,-.40450849,.14694631,.047745751,-.47552825,.27950849,.090817816,-.40450849,.29389262,0,-.40450849,.15450849,0,-.47552825,.15450849,0,-.47552825,.14694631,-.047745751,-.47552825,0,0,-.5,.14694631,-.047745751,-.47552825,.125,-.090817816,-.47552825,0,0,-.5,.125,-.090817816,-.47552825,.090817816,-.125,-.47552825,0,0,-.5,.090817816,-.125,-.47552825,.047745751,-.14694631,-.47552825,0,0,-.5,.047745751,-.14694631,-.47552825,0,-.15450849,-.47552825,0,0,-.5,0,-.15450849,-.47552825,-.047745751,-.14694631,-.47552825,0,0,-.5,-.047745751,-.14694631,-.47552825,-.090817816,-.125,-.47552825,0,0,-.5,-.090817816,-.125,-.47552825,-.125,-.090817816,-.47552825,0,0,-.5,-.125,-.090817816,-.47552825,-.14694631,-.047745751,-.47552825,0,0,-.5,-.14694631,-.047745751,-.47552825,-.15450849,0,-.47552825,0,0,-.5,-.15450849,0,-.47552825,-.14694631,.047745751,-.47552825,0,0,-.5,-.14694631,.047745751,-.47552825,-.125,.090817816,-.47552825,0,0,-.5,-.125,.090817816,-.47552825,-.090817816,.125,-.47552825,0,0,-.5,-.090817816,.125,-.47552825,-.047745751,.14694631,-.47552825,0,0,-.5,-.047745751,.14694631,-.47552825,0,.15450849,-.47552825,0,0,-.5,0,.15450849,-.47552825,.047745751,.14694631,-.47552825,0,0,-.5,.047745751,.14694631,-.47552825,.090817816,.125,-.47552825,0,0,-.5,.090817816,.125,-.47552825,.125,.090817816,-.47552825,0,0,-.5,.125,.090817816,-.47552825,.14694631,.047745751,-.47552825,0,0,-.5,.14694631,.047745751,-.47552825,.15450849,0,-.47552825,0,0,-.5],p.NONE=0,p.LEFTTOP=1,p.LEFTDOWN=2,p.RIGHTTOP=3,p.RIGHTDOWN=4,p.CENTER=5,p}(c.SceneNode);c.AxisNode=e}(M3D||(M3D={})),function(e){var t=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.SetSceneHeight=function(e){},t}(e.SceneNode);e.FPSNode=t}(M3D||(M3D={})),function(o){var a,e;(e=a=o.SkyBoxType||(o.SkyBoxType={}))[e.SKYBOX_SKY=0]="SKYBOX_SKY",e[e.SKYBOX_OCEAN=1]="SKYBOX_OCEAN",e[e.SKYBOX_CITY=2]="SKYBOX_CITY",e[e.SKYBOX_DESERT=3]="SKYBOX_DESERT",e[e.SKYBOX_CUSTOM=4]="SKYBOX_CUSTOM";var t=function(t){function e(){var e=t.call(this)||this;return e.isNeedUpdate=!0,e.topColor=new o.Color,e.bottomColor=new o.Color,e.ProArray=new Array(6),e.backColor=new Float32Array(24),e.backPnt=new Float32Array(18),e.points=new Float32Array(18),e.textCoords=new Float32Array(12),e.skyBoxPosition=null,e.cubeImagePath=[],e.gl=null,e.vertexBuffer=null,e.colorBuffer=null,e.texCoordsBuffer=null,e.waterMarktexCoordsBuffer=null,e.imagePositionBuffer=null,e.skyBoxPositionBuffer=null,e.texture=null,e.cubeTexture=null,e.skyBoxTexture={},e.isUseSkyBox=!1,e.isUseColor=!0,e.Initial(),e}return __extends(e,t),e.prototype.FindVisiableObject=function(e){this.IsVisible()?e.SetBackGroundNode(this):e.SetBackGroundNode(null)},e.prototype.SetBackgroundSize=function(e,t){this.iWidth=e,this.iHeight=t},e.prototype.SetTopColor=function(e){this.topColor!==e&&(this.topColor=e,this.UpdateTopColor())},e.prototype.SetBottomColor=function(e){this.bottomColor!==e&&(this.bottomColor=e,this.UpdateBottomColor())},e.prototype.GetTopColor=function(e){e.r=this.backColor[0],e.g=this.backColor[1],e.b=this.backColor[2],e.a=this.backColor[3],e.r=this.backColor[12],e.g=this.backColor[13],e.b=this.backColor[14],e.a=this.backColor[15],e.r=this.backColor[20],e.g=this.backColor[21],e.b=this.backColor[22],e.a=this.backColor[23]},e.prototype.GetBottomColor=function(e){e.r=this.backColor[4],e.g=this.backColor[5],e.b=this.backColor[6],e.a=this.backColor[7],e.r=this.backColor[8],e.g=this.backColor[9],e.b=this.backColor[10],e.a=this.backColor[11],e.r=this.backColor[16],e.g=this.backColor[17],e.b=this.backColor[18],e.a=this.backColor[19]},e.prototype.GetVertexs=function(){},e.prototype.InitVertexs=function(){new o.Vector3;this.points[0]=-1,this.points[1]=-1,this.points[2]=0,this.points[3]=1,this.points[4]=-1,this.points[5]=0,this.points[6]=-1,this.points[7]=1,this.points[8]=0,this.points[9]=-1,this.points[10]=1,this.points[11]=0,this.points[12]=1,this.points[13]=-1,this.points[14]=0,this.points[15]=1,this.points[16]=1,this.points[17]=0},e.prototype.GetTextureCoords=function(){},e.prototype.InitTextureCoords=function(){var e=new o.Rect(new o.Vector2(0,0),new o.Vector2(1,1));e.min,e.max;this.textCoords[0]=0,this.textCoords[1]=1,this.textCoords[2]=1,this.textCoords[3]=1,this.textCoords[4]=0,this.textCoords[5]=0,this.textCoords[6]=0,this.textCoords[7]=0,this.textCoords[8]=1,this.textCoords[9]=1,this.textCoords[10]=1,this.textCoords[11]=0},e.prototype.InitSkyBoxVertexs=function(){this.skyBoxPosition=new Float32Array([-1,1,-1,-1,-1,-1,1,-1,-1,1,-1,-1,1,1,-1,-1,1,-1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,-1,-1,1,1,-1,-1,1,1,-1,-1,1,-1,1,1,1,1,1,1,1,1,1,-1,1,-1,-1,-1,-1,1,-1,1,1,1,1,1,1,1,1,1,-1,1,-1,-1,1,-1,1,-1,1,1,-1,1,1,1,1,1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,1,-1,-1,1,-1,-1,-1,-1,1,1,-1,1])},e.prototype.SetImage=function(e){0<e.length&&(this.imagePath=e,this.isImageDirty=!0)},e.prototype.SetCubeImage=function(e){0<e.length&&(this.cubeImagePath=e,this.isCubeImageDirty=!0)},e.prototype.SetUseImage=function(e){(this.isUseImage=e)&&(this.isUseColor=!1,this.isUseSkyBox=!1)},e.prototype.IsUseImage=function(){return this.isUseImage},e.prototype.SetTexture=function(e){e&&this.texture!==e&&(this.texture&&(this.texture.ClearResource(),this.texture=null),this.texture=e,this.isImageDirty=!1)},e.prototype.GetTexture=function(e){if(this.isImageDirty||null===this.texture){this.texture&&(this.texture=null),this.texture=new o.Texture2D;var t=e.GetScene().GetResourceManager().GetOrCreateImage(this.imagePath);this.texture.AddImage(t),this.isImageDirty=!1}return this.texture},e.prototype.GetWaterMarkTexture=function(e){return e.GetScene().GetResourceManager().CreateWaterTextureObj(o.Parameters.Instance().waterMarkStr)},e.prototype.GetCubeTexture=function(e){if(this.isCubeImageDirty||null===this.cubeTexture){this.cubeTexture&&(this.cubeTexture=null),this.cubeTexture=new o.TextureCube;for(var t=0;t<this.cubeImagePath.length;t++){var r=e.GetScene().GetResourceManager().GetOrCreateImage(this.cubeImagePath[t]);this.cubeTexture.AddImage(r)}this.isCubeImageDirty=!1}return this.cubeTexture},e.prototype.AddSkyBoxTexture=function(e,t){this.skyBoxType=a.SKYBOX_CUSTOM,this.currentSkyBoxTexture=e,this.skyBoxTexture[e]||(this.skyBoxTexture[e]=t)},e.prototype.GetSkyBoxTexture=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(1===e.length){var r=e[0];return this.skyBoxTexture[r]}if(0===e.length){var i=null,n=Object.getOwnPropertyNames(this.skyBoxTexture);switch(this.skyBoxType){case a.SKYBOX_CUSTOM:if(""!==this.currentSkyBoxTexture){var o=this.skyBoxTexture[this.currentSkyBoxTexture];if(o){i=o;break}}0<n.length&&(i=this.skyBoxTexture[n[n.length-1]])}return i}},e.prototype.IsUseSkyBox=function(){return this.isUseSkyBox},e.prototype.SetUseSkyBox=function(e){(this.isUseSkyBox=e)&&(this.isUseColor=!1,this.isUseImage=!1)},e.prototype.IsUseColor=function(){return this.isUseColor},e.prototype.SetUseColor=function(e){(this.isUseColor=e)&&(this.isUseImage=!1,this.isUseSkyBox=!1)},e.prototype.Initial=function(){this.iViewX=0,this.iViewY=0,this.iWidth=1600,this.iHeight=1e3,this.UpdateTopColor(),this.UpdateBottomColor(),this.ProArray=new Array(6),this.ProArray[0]=-1,this.ProArray[1]=1,this.ProArray[2]=-1,this.ProArray[3]=1,this.ProArray[4]=-1,this.ProArray[5]=1,this.fAspectRatio=1,this.backPnt[0]=-1,this.backPnt[1]=1,this.backPnt[2]=1,this.backPnt[3]=-1,this.backPnt[4]=-1,this.backPnt[5]=1,this.backPnt[6]=1,this.backPnt[7]=-1,this.backPnt[8]=1,this.backPnt[9]=-1,this.backPnt[10]=1,this.backPnt[11]=1,this.backPnt[12]=1,this.backPnt[13]=-1,this.backPnt[14]=1,this.backPnt[15]=1,this.backPnt[16]=1,this.backPnt[17]=1,this.isUseImage=!1,this.imagePath="",this.skyBoxType=a.SKYBOX_SKY,this.currentSkyBoxTexture="",this.InitVertexs(),this.InitTextureCoords(),this.InitSkyBoxVertexs()},e.prototype.UpdateTopColor=function(){this.backColor[0]=this.topColor.r,this.backColor[1]=this.topColor.g,this.backColor[2]=this.topColor.b,this.backColor[3]=this.topColor.a,this.backColor[12]=this.topColor.r,this.backColor[13]=this.topColor.g,this.backColor[14]=this.topColor.b,this.backColor[15]=this.topColor.a,this.backColor[20]=this.topColor.r,this.backColor[21]=this.topColor.g,this.backColor[22]=this.topColor.b,this.backColor[23]=this.topColor.a,this.isNeedUpdate=!0},e.prototype.UpdateBottomColor=function(){this.backColor[4]=this.bottomColor.r,this.backColor[5]=this.bottomColor.g,this.backColor[6]=this.bottomColor.b,this.backColor[7]=this.bottomColor.a,this.backColor[8]=this.bottomColor.r,this.backColor[9]=this.bottomColor.g,this.backColor[10]=this.bottomColor.b,this.backColor[11]=this.bottomColor.a,this.backColor[16]=this.bottomColor.r,this.backColor[17]=this.bottomColor.g,this.backColor[18]=this.bottomColor.b,this.backColor[19]=this.bottomColor.a,this.isNeedUpdate=!0},e.prototype.SetCurrentGLContext=function(e){this.gl=e},e.prototype.GetPositionVBO=function(){return null===this.gl?null:(null!==this.vertexBuffer||(this.vertexBuffer=new o.HardWareVertexBuffer(this.gl),this.vertexBuffer.Create(0,this.backPnt.length),this.vertexBuffer.SetDataRange(this.backPnt,0),this.vertexBuffer.WriteBuffer()),this.vertexBuffer)},e.prototype.GetColorVBO=function(){return null===this.gl?null:null===this.colorBuffer||this.isNeedUpdate?this.isNeedUpdate?(this.colorBuffer||(this.colorBuffer=new o.HardWareVertexBuffer(this.gl)),this.colorBuffer.Create(0,this.backColor.length),this.colorBuffer.SetDataRange(this.backColor,0),this.colorBuffer.WriteBuffer(),this.isNeedUpdate=!1,this.colorBuffer):void 0:this.colorBuffer},e.prototype.GetWaterMarkTexCoordsVBO=function(){if(null===this.gl)return null;if(null!==this.waterMarktexCoordsBuffer)return this.waterMarktexCoordsBuffer;var e=new o.Rect;e.min=new o.Vector2(0,0),e.max=o.Parameters.Instance().waterMarkDrawRect;var t=new Float32Array(12),r=o.Parameters.Instance().waterMarkResolution,i=1,n=1;return i=(i=Number(e.max.x/r.x))<1?1:i,n=(n=Number(e.max.y/r.y))<1?1:n,t[0]=0,t[1]=n,t[2]=i,t[3]=n,t[4]=0,t[5]=0,t[6]=0,t[7]=0,t[8]=i,t[9]=n,t[10]=i,t[11]=0,this.waterMarktexCoordsBuffer=new o.HardWareVertexBuffer(this.gl),this.waterMarktexCoordsBuffer.Create(0,t.length),this.waterMarktexCoordsBuffer.SetDataRange(t,0),this.waterMarktexCoordsBuffer.WriteBuffer(),this.waterMarktexCoordsBuffer},e.prototype.GetTexCoordsVBO=function(){return null===this.gl?null:(null!==this.texCoordsBuffer||(this.texCoordsBuffer=new o.HardWareVertexBuffer(this.gl),this.texCoordsBuffer.Create(0,this.textCoords.length),this.texCoordsBuffer.SetDataRange(this.textCoords,0),this.texCoordsBuffer.WriteBuffer()),this.texCoordsBuffer)},e.prototype.GetBackImagePositionVBO=function(){return null===this.gl?null:(null!==this.imagePositionBuffer||(this.imagePositionBuffer=new o.HardWareVertexBuffer(this.gl),this.imagePositionBuffer.Create(0,this.points.length),this.imagePositionBuffer.SetDataRange(this.points,0),this.imagePositionBuffer.WriteBuffer()),this.imagePositionBuffer)},e.prototype.GetSkyBoxVertexVBO=function(){return null===this.gl?null:(null!==this.skyBoxPositionBuffer||(this.skyBoxPositionBuffer=new o.HardWareVertexBuffer(this.gl),this.skyBoxPositionBuffer.Create(0,this.skyBoxPosition.length),this.skyBoxPositionBuffer.SetDataRange(this.skyBoxPosition,0),this.skyBoxPositionBuffer.WriteBuffer()),this.skyBoxPositionBuffer)},e.prototype.SetBackGroundSkyBoxType=function(e){this.skyBoxType=e},e}(o.SceneNode);o.BackgroundNode=t}(M3D||(M3D={})),function(e){var t=function(t){function e(){var e=t.call(this)||this;return e.scene=null,e}return __extends(e,t),e.prototype.SetScene=function(e){this.scene=e},e}(e.GroupNode);e.MeasureGroup=t}(M3D||(M3D={})),function(e){var t=function(e){function t(){return e.call(this)||this}return __extends(t,e),t}(e.GroupNode);e.NoteGroup=t}(M3D||(M3D={})),function(M){var e=function(T){function i(e){var t=T.call(this)||this;return t.updateDraggerModelBoundingbox=!0,t.scene=e,t.Initialize(),t.m_PointHandlers=new Array,t.m_svlTools={},t}return __extends(i,T),i.prototype.Initialize=function(){this.m_rotateCenterPoint=null,this.m_rotateCenterSize=1,this.m_TransformHandlerNode=null,this.m_RotateCylinderAxisDragger=null,this.m_ScaleAxisDragger=null},i.prototype.Clear=function(){this.RemoveAllTools(),this.RemoveRotateCenter(),this.DeleteAllChildren()},i.prototype.RemoveRotateCenter=function(){this.m_rotateCenterPoint&&(this.scene&&this.RemoveRotateCenterHandler(this.m_rotateCenterPoint,this.scene),this.m_rotateCenterPoint=null)},i.prototype.RemoveRotateCenterHandler=function(e,t){null!=e&&e.GetSceneNode().GetParent().DeleteChild(e.GetSceneNode())},i.prototype.RemoveAllTools=function(){for(var e in this.m_svlTools)this.m_svlTools[e];this.m_svlTools={}},i.prototype.GetType=function(){return M.HANDLER_GROUP_NODE},i.prototype.CreatePointHandler=function(e,t,r,i){var n=null;if(null==i)return n;(n=new M.HandlerPoint(e,t)).SetDrawType(r);var o=new M.ShapeNode;o.SetShape(n),n.SetSceneNode(o);var a;return a=o.GetID().toString(),o.SetName(this.GetName()+"|"+a),this.AddChild(o),i.AddShapeIDToMap(n),n},i.prototype.CreateRotateCenterHandler=function(e,t,r){var i=null;if(null==r)return i;(i=new M.HandlerPoint(e,t)).SetDrawType(0);var n=new M.ShapeNode;return n.SetShape(i),this.AddChild(n),i},i.prototype.Traverse=function(e){T.prototype.Traverse.call(this,e)},i.prototype.HandleDragger=function(e){!e.getHandled()&&this.m_TransformHandlerNode&&this.m_TransformHandlerNode.IsVisible()&&this.m_TransformHandlerNode.handle(e);!e.getHandled()&&this.m_RotateCylinderAxisDragger&&this.m_RotateCylinderAxisDragger.IsVisible()&&this.m_RotateCylinderAxisDragger.handle(e);!e.getHandled()&&this.m_ScaleAxisDragger&&this.m_ScaleAxisDragger.IsVisible()&&this.m_ScaleAxisDragger.handle(e)},i.prototype.GetDraggerTotalBoundingBox=function(e){for(var t=new M.BoundingBox,r=0,i=e._draggerList;r<i.length;r++){var n=i[r]._drawModel;if(!n)return this.updateDraggerModelBoundingbox=!0,new M.BoundingBox;var o=n.GetModelShape().GetWorldBoundingBox();o&&o.Defined()&&t.Merge(o)}return this.updateDraggerModelBoundingbox=!1,t},i.prototype.FindVisiableObject=function(e){if(this.m_TransformHandlerNode&&this.m_TransformHandlerNode.IsVisible()){if(e.GetSceneBoxChanged()||this.m_TransformHandlerNode.GetNeedScale()||this.updateDraggerModelBoundingbox){var t=M.ShapeHelper.GetCommonSize(e.GetScene(),new M.Vector2(4.5,4.5));if(M.Parameters.Instance().dynamicSetDraggerPercentage){var r=this.GetDraggerTotalBoundingBox(this.m_TransformHandlerNode),i=(r.max.Sub(r.min).Length(),this.m_TransformHandlerNode.getDraggerCallbacks()[0]);if(0<i.m_draggerModels.length){var n=(m=i.m_draggerModels[0]).GetModelShape().GetWorldBoundingBox(),o=n.max.Sub(n.min).Length();if(t.x<o){var a=1+(M.Parameters.Instance().draggerPercentage*o-t.x)/o;t.x=t.x*a}}}this.m_TransformHandlerNode.SetOrigScale(new M.Vector3(t.x,t.x,t.x)),this.m_TransformHandlerNode.SetNeedScale(!1)}var s=this.m_TransformHandlerNode.GetWorldTransform().Multiply(new M.Vector3(0,0,0)).Clone(),l=M.Billboard.GetFitShowScale(e,s)/.4,h=new M.Vector3(l,l,l);u=(u=this.m_TransformHandlerNode.GetOrigScale()).Multiply(h).Clone(),this.m_TransformHandlerNode.SetScale(u)}if(this.m_RotateCylinderAxisDragger&&this.m_RotateCylinderAxisDragger.IsVisible()){if(e.GetSceneBoxChanged()||this.m_RotateCylinderAxisDragger.GetNeedScale()){t=M.ShapeHelper.GetCommonSize(e.GetScene(),new M.Vector2(4.5,4.5));this.m_RotateCylinderAxisDragger.SetOrigScale(new M.Vector3(t.x,t.x,t.x)),this.m_RotateCylinderAxisDragger.SetNeedScale(!1)}s=this.m_RotateCylinderAxisDragger.GetWorldTransform().Multiply(new M.Vector3(0,0,0)),l=M.Billboard.GetFitShowScale(e,s)/.4,h=new M.Vector3(l,l,l);u=(u=this.m_RotateCylinderAxisDragger.GetOrigScale()).Multiply(h).Clone(),this.m_RotateCylinderAxisDragger.SetScale(u)}if(this.m_ScaleAxisDragger&&this.m_ScaleAxisDragger.IsVisible()){if(e.GetSceneBoxChanged()||this.m_ScaleAxisDragger.GetNeedScale()){t=M.ShapeHelper.GetCommonSize(e.GetScene(),new M.Vector2(4.5,4.5));this.m_ScaleAxisDragger.SetOrigScale(new M.Vector3(t.x,t.x,t.x)),this.m_ScaleAxisDragger.SetNeedScale(!1)}var u;s=this.m_ScaleAxisDragger.GetWorldTransform().Multiply(new M.Vector3(0,0,0)),l=M.Billboard.GetFitShowScale(e,s)/.4,h=new M.Vector3(l,l,l);u=(u=this.m_ScaleAxisDragger.GetOrigScale()).Multiply(h).Clone(),this.m_ScaleAxisDragger.SetScale(u)}var p=e.GetWorkingRenderQueueGroup(),c=e.GetDraggerRenderQueueGroup();e.SetWorkingRenderQueueGroup(c),T.prototype.FindVisiableObject.call(this,e),e.SetWorkingRenderQueueGroup(p);var d=!0;for(var S in this.m_svlTools)d=!1;if(!d)for(var f in this.m_svlTools)for(var m=this.m_svlTools[f],y=0;y<m.length;y++)m[y].FindVisiableObject(e);e.SetHandlerGroupNode(this)},i.prototype.RayPick=function(e){T.prototype.RayPick.call(this,e);var t=!0;for(var r in this.m_svlTools)t=!1;if(!t)for(var i in this.m_svlTools)for(var n=this.m_svlTools[i],o=0;o<n.length;o++)n[o].IsVisible()&&n[o].RayPick(e)},i.prototype.GetSVLTool=function(e){return this.m_svlTools[e]},i.prototype.AddSVLTool=function(e,t){var r;null==this.m_svlTools[t]?(this.m_svlTools[t]=[],this.m_svlTools[t].push(e),(r=new M.CallBackAction).SetActionFun(i.CacheNodeToMap),r.SetActionData(this.scene.nodesMap),e.Traverse(r)):(this.m_svlTools[t].push(e),(r=new M.CallBackAction).SetActionFun(i.CacheNodeToMap),r.SetActionData(this.scene.nodesMap),e.Traverse(r))},i.prototype.RemoveSVLTool=function(e){null!==this.m_svlTools[e]&&delete this.m_svlTools[e]},i.prototype.ShowSVLTool=function(e){if(null!==this.m_svlTools[e])for(var t=this.m_svlTools[e],r=0;r<t.length;r++)t[r].SetVisible(!0)},i.prototype.HideAllSVLTools=function(){for(var e in this.m_svlTools)for(var t=this.m_svlTools[e],r=0;r<t.length;r++)t[r].SetVisible(!1)},i.prototype.HideSVLTool=function(e){if(null!==this.m_svlTools[e])for(var t=this.m_svlTools[e],r=0;r<t.length;r++)t[r].SetVisible(!1)},i.prototype.SetRotateCenterVisible=function(e){this.m_rotateCenterPoint&&this.m_rotateCenterPoint.SetVisible(e)},i.prototype.GetRotateCenterVisible=function(){var e=!1;return this.m_rotateCenterPoint&&(e=this.m_rotateCenterPoint.IsVisible()),e},i.prototype.UpdateRotateCenterPos=function(e){this.m_rotateCenterPos.Equals(e)||(this.m_rotateCenterPos=e,this.RemoveRotateCenter(),this.m_rotateCenterPoint=this.CreateRotateCenterHandler(this.m_rotateCenterPos,this.m_rotateCenterSize,this.scene))},i.prototype.UpdateRoteateCenterSize=function(e){this.m_rotateCenterSize=e,this.RemoveRotateCenter(),this.m_rotateCenterPoint=this.CreatePointHandler(this.m_rotateCenterPos,this.m_rotateCenterSize,2,this.scene)},i.prototype.GetRotateCenter=function(){return this.m_rotateCenterPoint},i.prototype.GetTransformHandler=function(){return null==this.m_TransformHandlerNode&&(this.m_TransformHandlerNode=new M.TranslateAxisDragger,this.m_TransformHandlerNode.setupDefaultGeometry(),this.AddChild(this.m_TransformHandlerNode)),this.m_TransformHandlerNode},i.CacheNodeToMap=function(e,t){var r=e;null==e[t.GetName()]&&(r[t.GetName()]=t)},i.prototype.GetHandlerSize=function(e){var t=1;if(e){var r=e.GetCamera(),i=r.GetAspectRatio();t=r.GetOrthoSize().y*i,t/=40}return new M.Vector2(t,t)},i.prototype.GetScaleAxisDragger=function(){return null==this.m_ScaleAxisDragger&&(this.m_ScaleAxisDragger=new M.ScaleAxisDragger,this.m_ScaleAxisDragger.setupDefaultGeometry(),this.AddChild(this.m_ScaleAxisDragger)),this.m_ScaleAxisDragger},i.prototype.GetRotateCylinderAxisDragger=function(){return null==this.m_RotateCylinderAxisDragger&&(this.m_RotateCylinderAxisDragger=new M.RotateCylinderAxisDragger,this.m_RotateCylinderAxisDragger.setupDefaultGeometry(),this.AddChild(this.m_RotateCylinderAxisDragger)),this.m_RotateCylinderAxisDragger},i}(M.GroupNode);M.HandlerGroup=e}(M3D||(M3D={})),function(o){var e=function(n){function e(){var e=n.call(this)||this;return e.shapeNode=null,e}return __extends(e,n),e.prototype.GetType=function(){return o.MODEL_NODE},e.prototype.Traverse=function(e){if(!e.IsFinish()){e.Apply(this);var t=this.shapeNode;null!==t&&t.Traverse(e);for(var r=0,i=this.pChildrenList;r<i.length;r++){i[r].Traverse(e)}}},e.prototype.RayPick=function(e){var t=this.shapeNode;null!==t&&t.RayPick(e);for(var r=0,i=this.pChildrenList;r<i.length;r++){i[r].RayPick(e)}},e.prototype.FindVisiableObject=function(e){var t=this.shapeNode;null!==t&&t.FindVisiableObject(e);for(var r=0,i=this.pChildrenList;r<i.length;r++){i[r].FindVisiableObject(e)}},e.prototype.ComputeBox=function(){if(!this.bdBox.Defined()){var e=new o.BoundingBox,t=this.shapeNode;null!=t&&e.Merge(t.GetBoundingBox());for(var r=0;r<this.pChildrenList.length;r++){var i=this.pChildrenList[r].GetBoundingBox();i.Defined()&&e.Merge(i.Transformed(this.pChildrenList[r].GetLocalTransform()))}e.Defined()&&(this.bdBox=e)}},e.prototype.OnMarkedDirty=function(){var e=this.shapeNode;null!=e&&e.MarkDirty(),n.prototype.OnMarkedDirty.call(this)},e.prototype.GetShapeNode=function(){return this.shapeNode},e.prototype.SetShapeNode=function(e){e.SetParent(this),this.shapeNode=e},e.prototype.UpdateName=function(){if(this.shapeNode){var e=this.shapeNode.GetShape();if(e&&e instanceof o.Model){var t=this.GetParent(),r=e.GetPlcId().toString(16),i=t.GetName()+"|"+r;this.SetName(i),this.shapeNode.UpdateName()}}return n.prototype.UpdateName.call(this),!0},e}(o.GroupNode);o.ModelNode=e}(M3D||(M3D={})),function(r){var e=function(t){function e(){var e=t.call(this)||this;return e.shape=null,e}return __extends(e,t),e.prototype.SetShape=function(e){this.shape=e,this.shape.SetSceneNode(this)},e.prototype.GetType=function(){return r.SHAPE_NODE},e.prototype.GetShape=function(){return this.shape},e.prototype.Traverse=function(e){e.IsFinish()||(t.prototype.Traverse.call(this,e),null!==this.shape&&this.shape.Traverse(e))},e.prototype.RayPick=function(e){null!==this.shape&&(e.IsPickAll()?e.FramePick(this.shape):this.shape.AllowExculding()&&e.GetData().GetCameraRay().HitDistance(this.GetWorldBoundingBox())===r.INFINITY||(e.UpdataModelRay(this.GetWorldTransform()),e.RayPick(this.shape)))},e.prototype.FindVisiableObject=function(e){if(null!==this.shape&&this.shape.IsVisible()){if(null!=this.shape&&!this.shape.AllowExculding())return e.SetWorldMatrix(this.GetWorldTransform()),e.SetGLWorldMatrix(this.GetGLWorldTransform()),void this.shape.FindVisiableObject(e);var t=e.GetCullerHelper().IsLittleModel(this.GetWorldBoundingBox(),e.GetCamera());if(2!==t)e.GetCullerHelper().InViewPort(this.GetWorldBoundingBox(),e.GetCamera())!==r.OUTSIDE&&null!=this.shape&&(e.SetWorldMatrix(this.GetWorldTransform()),e.SetGLWorldMatrix(this.GetGLWorldTransform()),0==t&&this.shape.FindVisiableObject(e))}},e.prototype.ComputeBox=function(){if(!this.bdBox.Defined()){var e=this.GetShape();if(null!==e){var t=e.GetBoundingBox();t.Defined()&&this.bdBox.copyFrom(t)}}},e.prototype.OnMarkedDirty=function(){this.shape&&(this.shape.GetBoundingBox().Clear(),this.shape.GetType()==r.ShapeType.SHAPE_MODEL&&this.shape.SetOrigPlcMatrix(this.GetWorldTransform()))},e.prototype.UpdateName=function(){var e=this.GetParent().GetName();return this.SetName(e+"|ShapeModel"),!0},e}(r.SceneNode);r.ShapeNode=e}(M3D||(M3D={})),function(t){var e=function(){function e(){}return e.FRONT_MVMATRIX=function(){return null==e._FRONT_MVMATRIX&&(e._FRONT_MVMATRIX=new t.ControlInfo(1,0,0,0)),e._FRONT_MVMATRIX},e.BACK_MVMATRIX=function(){return null==e._BACK_MVMATRIX&&(e._BACK_MVMATRIX=new t.ControlInfo(0,0,1,0)),e._BACK_MVMATRIX},e.LEFT_MVMATRIX=function(){return null==e._LEFT_MVMATRIX&&(e._LEFT_MVMATRIX=new t.ControlInfo(.70710677,0,-.70710677,0)),e._LEFT_MVMATRIX},e.RIGHT_MVMATRIX=function(){return null==e._RIGHT_MVMATRIX&&(e._RIGHT_MVMATRIX=new t.ControlInfo(.70710677,0,.70710677,0)),e._RIGHT_MVMATRIX},e.TOP_MVMATRIX=function(){return null==e._TOP_MVMATRIX&&(e._TOP_MVMATRIX=new t.ControlInfo(.70710677,-.70710677,0,0)),e._TOP_MVMATRIX},e.BOTTOMVMATRIX=function(){return null==e._BOTTOMVMATRIX&&(e._BOTTOMVMATRIX=new t.ControlInfo(.70710677,.70710677,0,0)),e._BOTTOMVMATRIX},e.ISOMETRIC_MVMATRIX=function(){return null==e._ISOMETRIC_MVMATRIX&&(e._ISOMETRIC_MVMATRIX=new t.ControlInfo(.88047838,.36470398,-.27984396,-.11591448)),e._ISOMETRIC_MVMATRIX},e.DEFAULT_MVMATRIX=function(){return null==e._DEFAULT_MVMATRIX&&(e._DEFAULT_MVMATRIX=new t.ControlInfo(.88047838,.36470398,-.27984396,-.11591448)),e._DEFAULT_MVMATRIX},e.FRONT=0,e.BACK=1,e.LEFT=2,e.RIGHT=3,e.TOP=4,e.BOTTOM=5,e.ISOMETRIC=6,e.DEFAULT=7,e.CUSTOM=9,e.DISTRI=0,e}();t.PerspectiveData=e}(M3D||(M3D={})),function(p){var e=function(){function e(){this.Initialize()}return e.prototype.Initialize=function(){this.SetAnimationState(!1),this.animationTo=new p.ControlInfo,this.animationmvMatrix=new p.ControlInfo,this.animationdistimvMatrix=new p.ControlInfo,this.newAnimationTo=new p.ControlInfo,this.slerpCount=60,this.midRotation=[],this.midTran=[],this.midScale=[];for(var e=0;e<this.slerpCount;++e)this.midRotation.push(new p.Quaternion),this.midTran.push(new p.Vector3),this.midScale.push(0);this.timer=new p.Timer,this.pMatrix=new Float32Array(16),this.animationKeepMsecond=30},e.prototype.SetAnimationState=function(e){this.isAnimation=e},e.GetInstance=function(){return null==e.Instance&&(e.Instance=new e),e.Instance},e.prototype.Show=function(e,t,r,i,n){void 0===r&&(r=!0),void 0===i&&(i=!1),void 0===n&&(n=!1),this.Apply(e,t,r,i,n)},e.prototype.Apply=function(e,t,r,i,n){void 0===r&&(r=!0),void 0===i&&(i=!1),void 0===n&&(n=!1),this.pView=e,this.pSelectedNodes=this.pView.GetWorkNodes(),this.iViewType=t,this.bAllowRotate=r,this.bAllowScale=i,this.bAllowTran=n,this.HandleStandardView()},e.prototype.HandleStandardView=function(){switch(this.iViewType){case p.PerspectiveData.FRONT:this.CreatePerspectiveAnimation(p.PerspectiveData.FRONT_MVMATRIX());break;case p.PerspectiveData.BACK:this.CreatePerspectiveAnimation(p.PerspectiveData.BACK_MVMATRIX());break;case p.PerspectiveData.LEFT:this.CreatePerspectiveAnimation(p.PerspectiveData.LEFT_MVMATRIX());break;case p.PerspectiveData.RIGHT:this.CreatePerspectiveAnimation(p.PerspectiveData.RIGHT_MVMATRIX());break;case p.PerspectiveData.TOP:this.CreatePerspectiveAnimation(p.PerspectiveData.TOP_MVMATRIX());break;case p.PerspectiveData.BOTTOM:this.CreatePerspectiveAnimation(p.PerspectiveData.BOTTOMVMATRIX());break;case p.PerspectiveData.ISOMETRIC:this.CreatePerspectiveAnimation(p.PerspectiveData.ISOMETRIC_MVMATRIX());break;case p.PerspectiveData.DEFAULT:this.CreatePerspectiveAnimation(p.PerspectiveData.DEFAULT_MVMATRIX())}},e.prototype.GetAnimationState=function(){return this.timer.IsStart()},e.prototype.CreatePerspectiveAnimation=function(e){this.GetAnimationState()&&this.FinishAnimation(),this.currentAniFrame=0,this.animationTo=e,p.Trackball.ISMOVING=!0,this.pSelectedNodes.GetMVMatrix(this.animationmvMatrix,this.animationdistimvMatrix),this.animationdistimvMatrix.rotation=e.rotation,this.StartAnimation(),p.Trackball.ISMOVING=!1},e.prototype.ExecuteCommonCameraAnimation=function(e,t,r,i,n,o,a){this.GetAnimationState()&&this.FinishAnimation(),this.currentAniFrame=0,this.bAllowRotate=o,this.bAllowScale=a,this.bAllowTran=n;var s=e.GetSceneManager().GetCamera();this.animationmvMatrix.moveVector=s.GetWorldPosition().Clone(),this.animationmvMatrix.rotation=s.GetRotation().Clone(),this.animationmvMatrix.scaleFactor=s.GetZoom(),this.newAnimationTo.moveVector=t.Clone(),this.newAnimationTo.rotation=r.Clone(),this.newAnimationTo.scaleFactor=i.x,p.Trackball.ISMOVING=!0,this.StartCommonAnimation(),p.Trackball.ISMOVING=!1},e.prototype.StartAnimation=function(){var e=this.animationmvMatrix,t=this.animationTo;return p.M3DTOOLS.RotationSlerp(e.rotation,t.rotation,this.slerpCount,this.midRotation),p.M3DTOOLS.FloatSlerp(e.scaleFactor,t.scaleFactor,this.slerpCount,this.midScale),p.M3DTOOLS.VecSlerp(e.moveVector,t.moveVector,this.slerpCount,this.midTran),this.starttime=(new Date).getTime(),this.timer.SetTimer(this.timerTask,this,this.animationKeepMsecond),this.timer.StartTimer(),!0},e.prototype.StartCommonAnimation=function(){var e=this.animationmvMatrix,t=this.newAnimationTo;return p.M3DTOOLS.RotationSlerp(e.rotation,t.rotation,this.slerpCount,this.midRotation),p.M3DTOOLS.FloatSlerp(e.scaleFactor,t.scaleFactor,this.slerpCount,this.midScale),p.M3DTOOLS.VecSlerp(e.moveVector,t.moveVector,this.slerpCount,this.midTran),this.starttime=(new Date).getTime(),this.timer.SetTimer(this.commonTimerTask,this,this.animationKeepMsecond),this.timer.StartTimer(),!0},e.prototype.timerTask=function(e){var t=e,r=t.bAllowRotate,i=t.bAllowTran,n=t.bAllowScale,o=t.midRotation,a=t.midScale,s=t.midTran,l=(new Date).getTime(),h=Math.round(t.slerpCount*(l-t.starttime)/500);(500<l-t.starttime||!0===p.Parameters.Instance().ignoreRestoreAnimation)&&(h=t.slerpCount-1),r&&o[h]&&t.ApplyRotationToSelectedNode(o[h]),n&&a[h]&&t.ApplyScaleToSelectedNode(a[h]),i&&s[h]&&t.ApplyMovementToSelectedNode(s[h]),t.pView.OnDraw(),h>=t.slerpCount-1&&t.FinishAnimation()},e.prototype.commonTimerTask=function(e){var t=e,r=t.bAllowRotate,i=t.bAllowTran,n=t.bAllowScale,o=t.midRotation,a=t.midScale,s=t.midTran,l=(new Date).getTime(),h=Math.round(t.slerpCount*(l-t.starttime)/500);(500<l-t.starttime||!0===p.Parameters.Instance().ignoreRestoreAnimation)&&(h=t.slerpCount-1);var u=t.pView.GetSceneManager().GetCamera();r&&o[h]&&u.SetRotation(o[h].Clone()),n&&a[h]&&u.SetZoom(a[h]),i&&s[h]&&u.SetWorldPosition(s[h].Clone()),t.pView.OnDraw(),h>=t.slerpCount-1&&t.FinishAnimation()},e.prototype.FinishAnimation=function(){return this.timer.IsStart()&&this.timer.StopTimer(),this.currentAniFrame=0,this.animationKeepMsecond=30,!0},e.prototype.ApplyRotationToSelectedNode=function(e){this.pSelectedNodes.SetRotationAroundCenter(e)},e.prototype.ApplyMovementToSelectedNode=function(e){this.pSelectedNodes.SetPosition(e)},e.prototype.ApplyScaleToSelectedNode=function(e){this.pSelectedNodes.SetZoom(e)},e}();p.PerspectiveOperator=e}(M3D||(M3D={})),function(s){var p=function(){function e(){}return e.X=1,e.Y=2,e.Z=3,e}();s.Direction=p;var e=function(){function o(){this.direction=-1,this.directionX=-1,this.fPercentage=-1,this.fPercentageX=-1,this.directionY=-1,this.fPercentageY=-1,this.directionZ=-1,this.fPercentageZ=-1,this.isShowClipPlane=!1,this.isShowCutPlane=!1,this.isShowCappingPlane=!1,this.pView=null,this.pSceneManager=null,this.pModelNode=null,this.pCurSectionPlane=null,this.model=null}return o.GetSectionInfo=function(e,t,r,i){var n=e.GetSceneManager().GetSceneBox(),o=0,a=n.min.Clone(),s=0,l=0,h=0,u=0;switch(t){case-p.X:o=n.GetXLength()*r,s=-1,u=a.x+o;break;case p.X:o=n.GetXLength()*r,s=1,u=-(a.x+o);break;case-p.Y:o=n.GetYLength()*r,l=-1,u=a.y+o;break;case p.Y:o=n.GetYLength()*r,l=1,u=-(a.y+o);break;case-p.Z:o=n.GetZLength()*r,h=-1,u=a.z+o;break;case p.Z:o=n.GetZLength()*r,h=1,u=-(a.z+o)}i.SetPlaneParam(s,l,h,u)},o.Show=function(e,t,r,i,n){null===o.Instance&&(o.Instance=new o),o.Instance.Init(e,t,r,i,n);e.GetSceneManager();o.Instance.Handle()},o.prototype.getInstance=function(){return o.Instance},o.Clear=function(e){var t=e.GetSceneManager();null!==o.Instance&&t.GetSection().ClearPlanes(),t.GetRenderManager().RequestRedraw()},o.prototype.Init=function(e,t,r,i,n){var o=(this.pView=e).GetSceneManager();this.model=o.GetModel(),this.pSceneManager=o,this.direction=t,this.fPercentage=r,Math.abs(r-1)<.01&&(this.fPercentage=1.01),Math.abs(r)<.01&&(this.fPercentage=-.01),this.isShowClipPlane=i,this.isShowCutPlane=n,this.isShowCappingPlane=n;var a=1001+this.pView.GetSceneManager().GetSection().GetPlaneList().length;null===this.pCurSectionPlane&&(this.pCurSectionPlane=new s.SectionPlane),this.pCurSectionPlane.SetID(a)},o.prototype.Handle=function(){this.CreateSectionPlane(this.model,this.direction,this.fPercentage,this.pCurSectionPlane),this.pView.GetSceneManager().GetSection().AddPlane(this.pCurSectionPlane),this.pView.GetSceneManager().GetRenderManager().RequestRedraw()},o.prototype.RequestDraw=function(){},o.prototype.CreateSectionPlane=function(e,t,r,i){o.GetSectionInfo(this.pView,t,r,i),i.SetEnable(!0),i.SetShowPlaneRect(this.isShowClipPlane),i.SetShowCutPlane(this.isShowCutPlane),i.SetShowCappingPlane(this.isShowCappingPlane)},o.prototype.GetModel=function(){return this.model},o.Instance=null,o}();s.SectionOperator=e}(M3D||(M3D={})),function(n){var e=function(){function e(){this.workNodesMap=new n.StringDictionary}return e.prototype.AddNode=function(e,t){var r=this.workNodesMap.get(e);void 0!==r?r=t:this.workNodesMap.add(e,t)},e.prototype.RemoveNode=function(e){void 0!==this.workNodesMap.get(e)&&this.workNodesMap.remove(e)},e.prototype.Size=function(){return this.workNodesMap.count},e.prototype.SetPosition=function(e){var t=this.workNodesMap.get(n.MAINCAMERA);void 0!==t&&t.SetWorldPosition(e)},e.prototype.SetZoom=function(e){var t=this.workNodesMap.get(n.MAINCAMERA);void 0!==t&&t.SetZoom(1/e)},e.prototype.GetMVMatrix=function(e,t){var r=this.workNodesMap.get(n.MAINCAMERA);if(void 0!==r){var i=r;e.rotation=i.GetRotation(),e.moveVector=i.GetPosition(),e.scaleFactor=i.GetZoom(),t.rotation=i.GetOldRotation(),t.moveVector=i.GetOldPosition(),t.scaleFactor=i.GetZoom()}},e.prototype.SetRotationAroundCenter=function(e){var t=this.workNodesMap.get(n.AXIS);if(void 0!==t&&t.SetRotation(e.Inverse()),void 0!==(t=this.workNodesMap.get(n.MAINCAMERA))){var r=t,i=e.Inverse();i=r.GetRotation().Inverse().MultiplyED(i),r.RotateAroundCenter(i,n.SceneNode.TS_WORLD)}},e.prototype.SetRotation=function(e){var t=this.workNodesMap.get(n.AXIS);(void 0!==t&&t.SetRotation(e.Inverse()),void 0!==(t=this.workNodesMap.get(n.MAINCAMERA)))&&t.SetRotation(e)},e.prototype.GetRotaton=function(e){var t=this.workNodesMap.get(n.MAINCAMERA);void 0!==t&&t.GetRotation()},e.prototype.RotateAroundCenter=function(e){var t=e,r=this.workNodesMap.get(n.MAINCAMERA);void 0!==r&&r.RotateAroundCenter(t,n.SceneNode.TS_WORLD);void 0!==(r=this.workNodesMap.get(n.AXIS))&&r.Rotate(t)},e.prototype.Rotate=function(e){var t=e,r=this.workNodesMap.get(n.MAINCAMERA);void 0!==r&&r.Rotate(t,n.SceneNode.TS_WORLD);void 0!==(r=this.workNodesMap.get(n.AXIS))&&r.Rotate(t)},e.prototype.Translate=function(e,t){},e.prototype.Zoom=function(e){},e}();n.WorkNodes=e}(M3D||(M3D={})),function(c){var i,e;(e=i=c.TwoOperateType||(c.TwoOperateType={}))[e.all=0]="all",e[e.move=1]="move",e[e.zoom=2]="zoom",e[e.translate=3]="translate",e[e.movezoom=4]="movezoom",e[e.movetranslate=5]="movetranslate",e[e.zoomtranslate=6]="zoomtranslate";var t=function(t){function e(){var e=t.call(this)||this;return e.twoOperateType=i.all,e.touchHandlerType=c.TouchHandlerType.HANDLER_COMMON,e.oribitMode=!0,e.controlLockXY=!1,e.oberveMode=1,e.oribitPhi=90,e.oribitTheta=0,e}return __extends(e,t),e.prototype.OnUpDataTouchIntent=function(){var e=this.trackBall.mvMatrix.rotation.Inverse(),t=this.sceneManager.GetCamera();t.RotateAroundCenter(e,c.SceneNode.TS_WORLD),this.twoOperateType!==i.all&&this.twoOperateType!==i.move&&this.twoOperateType!==i.movezoom&&this.twoOperateType!==i.movetranslate||t.Translate(this.trackBall.mvMatrix.moveVector.Multiply(-1),c.SceneNode.TS_LOCAL),this.twoOperateType!==i.all&&this.twoOperateType!==i.zoom&&this.twoOperateType!==i.movezoom&&this.twoOperateType!==i.zoomtranslate||t.ZoomView(1/this.trackBall.mvMatrix.scaleFactor)},e.prototype.FreeViewRotate=function(){var e=this.trackBall.mvMatrix.rotation.Inverse(),t=this.sceneManager.GetCamera();t.RotateAroundCenter(e,c.SceneNode.TS_WORLD),this.twoOperateType!==i.all&&this.twoOperateType!==i.move&&this.twoOperateType!==i.movezoom&&this.twoOperateType!==i.movetranslate||t.Translate(this.trackBall.mvMatrix.moveVector.Multiply(-1),c.SceneNode.TS_LOCAL),this.twoOperateType!==i.all&&this.twoOperateType!==i.zoom&&this.twoOperateType!==i.movezoom&&this.twoOperateType!==i.zoomtranslate||t.ZoomView(1/this.trackBall.mvMatrix.scaleFactor)},e.prototype.OrbitControl=function(e){var t=this.sceneManager.GetCamera(),r=(t.GetWorldPosition(),t.GetRotation());this.oribitControlTarget=t.GetRotateCenter(),t.Translate(this.trackBall.mvMatrix.moveVector.Multiply(-1),c.SceneNode.TS_LOCAL);var i=this.trackBall.GetMoveDelta();this.m_fYaw+=.5*i.x,this.m_fPitch+=.5*i.y,this.m_fPitch=c.Clamp(this.m_fPitch,-90,90),t.SetRotation(new c.Quaternion(this.m_fPitch,this.m_fYaw,0));var n=r.Inverse().Multiply(t.GetPosition().Sub(this.oribitControlTarget)),o=t.GetRotation().Multiply(n).Add(this.oribitControlTarget);t.SetWorldPosition(o),t.ZoomView(1/this.trackBall.mvMatrix.scaleFactor)},e.prototype.RotateAroundAxis=function(){var e=this.sceneManager.GetCamera(),t=e.GetRotateCenter(),r=this.trackBall.mvMatrix.rotation.EulerAngles(),i=new c.Quaternion(3*-r.y,c.Vector3.UP()),n=new c.Matrix4,o=new c.Matrix4,a=new c.Matrix4,s=new c.Matrix4;n.MultiTranslate(t.Multiply(-1)),o.MultiRotatiton(i),a.MultiTranslate(t),s=a.Multiply(o).Multiply(n);var l=e.GetView().ToMatrix4(),h=l.Multiply(s).Multiply(l.Inverse());e.Translate(h.Translation(),c.SceneNode.TS_LOCAL),e.Rotate(h.Rotation()),e.Translate(this.trackBall.mvMatrix.moveVector.Multiply(-1),c.SceneNode.TS_LOCAL),e.ZoomView(1/this.trackBall.mvMatrix.scaleFactor)},e.prototype.LookRound=function(){},e.prototype.OnUpDateTouchIntent=function(e){this.freeViewMode?this.FreeViewRotate():this.oribitMode?this.OrbitControl(e):this.controlLockXY?this.RotateAroundAxis():this.bLookaroundMode?this.LookRound():this.FreeViewRotate()},e.prototype.UpdateCamera=function(){t.prototype.InitCamera.call(this)},e.prototype.InitCamera=function(){if(null!=this.sceneManager){var e=this.sceneManager.GetCamera(),t=this.sceneManager.GetSceneBox();if(this.GetRestoreCamera()){e.ReSet();var r=t.Length(),i=t.Center();this.oribitControlTarget=i.Clone(),i.z+=t.Length()*c.CAMERA_POSFACTOR,e.SetWorldPosition(i),r=this.sceneManager.GetDefaultFocusLength(),e.SetNearClip(r*c.NEAR_CLIP_PLANE_FACTOR),e.SetFarClip(r*c.FAR_CLIP_PLANE_FACTOR),e.LookAt(t.Center(),new c.Vector3(0,1,0),c.SceneNode.TS_WORLD),this.trackBall.SetRotateSpeed(2)}else{var n=t.Length(),o=e.GetRotateCenter().Clone(),a=e.GetWorldPosition().Clone().Sub(o).Normalized();e.SetWorldPosition(o.Add(a.Multiply(t.Length()).Multiply(c.CAMERA_POSFACTOR))),n=this.sceneManager.GetDefaultFocusLength(),e.SetNearClip(n*c.NEAR_CLIP_PLANE_FACTOR),e.SetFarClip(n*c.FAR_CLIP_PLANE_FACTOR)}var s=e.GetViewPort(),l=s.rect.Height(),h=s.rect.Width();this.sceneManager.GetRenderManager().WindowSizeChanged(h,l),e.SetZoom(this.sceneManager.GetDefaultZoom()),e.SetInitRotateCenter(t.Center()),this.GetRestoreCamera()&&this.pView&&(c.PerspectiveOperator.GetInstance().Show(this.pView,this.GetDefaultView(),!0,!1,!1),this.SetUpDirection(c.Parameters.Instance().m_upDirectionValue,this.pView));var u=e.GetViewPort().rect,p=u.Width()>u.Height()?u.Height():u.Width();this.trackBall.SetTrackWindow(p,p)}},e.prototype.OptimizeCamera=function(){},e.prototype.OnTouchUp=function(e,t){if(c.Parameters.Instance().IsConRotate)if(1==t)if(3<this.trackBall.angle){var r=this.trackBall.angle;r=0<r?Math.min(r,15):Math.max(r,-15),14<Math.abs(this.trackBall.angle)&&this.trackBall.mvMatrix.rotation.FromAngleAxis(r,this.trackBall.axis),this.StartKeepState()}else this.EndKeepState();else 2==t&&this.trackBall.TwoPointsUp(e,t);else 1===t?(this.EndKeepState(),this.trackBall.OnePointUp(e,t)):2===t&&this.trackBall.TwoPointsUp(e,t),this.trackBall.Reset();this.UpdateRenderQuality(!1),this.UpDataTouchIntent(t)},e.prototype.OnTouchMove=function(e,t,r){this.OptimizeCamera(),1===r?1===e?this.trackBall.OnePointRotate(t,r):2===e?this.trackBall.OnePointsMove(t,r):3===e&&this.trackBall.OnePointsScale(t,r):2===r&&(1===e?this.twoOperateType=i.translate:2===e?this.twoOperateType=i.move:3===e?this.twoOperateType=i.zoom:0===e?this.twoOperateType=i.all:4===e?this.twoOperateType=i.movezoom:6===e?this.twoOperateType=i.movetranslate:7===e&&(this.twoOperateType=i.zoomtranslate),this.trackBall.TwoPointsMove(t,r),this.twoOperateType!==i.all&&this.twoOperateType!==i.translate&&this.twoOperateType!==i.movetranslate&&this.twoOperateType!==i.zoomtranslate||this.TwoFingersRotate(t,r),this.PriPointTwo1.x=t[0],this.PriPointTwo1.y=t[1],this.PriPointTwo2.x=t[2],this.PriPointTwo2.y=t[3],this.twoOperateType=i.all),this.StateChanged()&&this.UpDataTouchIntent(r),this.UpdateRenderQuality(!0)},e.prototype.OnTouchDown=function(e,t){this.trackBall.Reset(),1===t?this.trackBall.OnePointStart(e,t):2===t&&(this.PriPointTwo1.x=e[0],this.PriPointTwo1.y=e[1],this.PriPointTwo2.x=e[2],this.PriPointTwo2.y=e[3],this.trackBall.TwoPointsStart(e,t));var r=this.sceneManager.GetCamera().GetRotation();this.m_fYaw=r.YawAngle(),this.m_fPitch=r.PitchAngle()},e.prototype.ResetViewCamera=function(){if(null!=this.sceneManager){var e=this.sceneManager.GetCamera(),t=e.GetWorldPosition().Clone(),r=this.sceneManager.GetSceneBox(),i=e.GetViewPort(),n=i.rect.Height(),o=i.rect.Width();this.sceneManager.GetRenderManager().WindowSizeChanged(o,n);var a=r.Length(),s=r.Center(),l=t.Sub(s).Normalized(),h=s.Add(l.Multiply(r.Length()*c.CAMERA_POSFACTOR));e.SetWorldPosition(h),a=this.sceneManager.GetDefaultFocusLength(),e.SetNearClip(a*c.NEAR_CLIP_PLANE_FACTOR),e.SetFarClip(a*c.FAR_CLIP_PLANE_FACTOR),e.SetZoom(this.sceneManager.GetDefaultZoom()),e.SetInitRotateCenter(r.Center()),e.LookAt(r.Center(),new c.Vector3(0,1,0),c.SceneNode.TS_WORLD),this.trackBall.SetRotateSpeed(2);var u=e.GetViewPort().rect,p=u.Width()>u.Height()?u.Height():u.Width();this.trackBall.SetTrackWindow(p,p)}},e}(c.TouchHandler);c.CommonTouchHandler=t}(M3D||(M3D={})),function(C){var e=function(r){function e(){var e=r.call(this)||this;return e.PirDistance=0,e.CurrDistance=0,e.cachePriPoint=C.Vector3.ZERO().Clone(),e.cacheCurPointNear=C.Vector3.ZERO().Clone(),e.cacheCurPointFar=C.Vector3.ZERO().Clone(),e.cameraToCenterDis=0,e.movSpeed=0,e.oldDirectionVector=C.Vector3.UP().Clone(),e.insideBoundingBox=!1,e.speedControlValue=1,e.isUpDirection=!1,e.transMat=C.Matrix4.IDENTITY().Clone(),e.lastDepthPos=C.Vector3.ZERO().Clone(),e.needMoveValue=C.Vector3.ZERO().Clone(),e.useOribit=!1,e.oribitControlOffset=C.Vector3.ZERO().Clone(),e.isOribteRotateState=!1,e.deltaPhi=1,e.insectPoint=C.Vector3.ZERO().Clone(),e.phi=0,e.virtualKeyTarget=C.Vector3.ZERO().Clone(),e.bflyMode=!1,e.cameraToCenterDis=1e-4,e.movSpeed=1e-5,e.touchHandlerType=C.TouchHandlerType.HANDLER_WALKTHROUGH,e.firstPersionSpeed=8,e.changeDisOnRotate=!0,e.modelRotation=C.Quaternion.IDENTITY().Clone(),e.insideBoundingBox=!1,e.isUpDirection=!1,e.speedControlValue=1,e.standardSpeed=1,e.isOribteRotateState=!0,e.useOribit=!0,e.phi=0,e.controlLockXY=!0,e.freeViewMode=!0,e.virtualKeyTarget=C.Vector3.ZERO().Clone(),e.m_bfirstPersion=!0,e.bflyMode=!1,e}return __extends(e,r),e.prototype.UpdateCamera=function(){r.prototype.InitCamera.call(this)},e.prototype.InitCamera=function(){if(this.sceneManager){var e=this.sceneManager.GetCamera(),t=e.GetViewPort(),r=t.rect.Height(),i=t.rect.Width();this.sceneManager.GetRenderManager().WindowSizeChanged(i,r);var n=e.GetViewPort().rect,o=n.Width()>n.Height()?n.Height():n.Width();this.trackBall.SetTrackWindow(o,o)}},e.prototype.InitModelViewCamera=function(){if(this.sceneManager){var e=this.sceneManager,t=e.GetCamera();t.ReSet(),t.SetOrthographic(!1);var r=e.GetSceneBox(),i=t.GetViewPort(),n=i.GetRect().Height(),o=i.GetRect().Width();this.sceneManager.GetRenderManager().WindowSizeChanged(o,n);var a=r.Length(),s=r.Center();t.IsOrthographic()?s.z+=8.5*r.Length():s.z+=1.5*r.Length(),t.SetWorldPosition(s),t.SetNearClip(.005*a),t.SetFarClip(2.5*a);var l=C.Parameters.Instance().DefaultZoomFactor;l=l*n/o,o<n&&(l=.5*l*(1*o/n)),t.SetZoom(l),t.SetInitRotateCenter(r.Center()),t.LookAt(r.Center(),C.Vector3.UP().Clone(),C.Camera.TS_WORLD)}},e.prototype.SetFirstPersionParameter=function(e){this.firstPersionSpeed=e},e.prototype.GetFirstPersionParameter=function(){return this.firstPersionSpeed},e.prototype.OptimizeCamera=function(){if(this.sceneManager){(this.controlLockXY||this.oribitMode)&&(this.insideBoundingBox?this.useOribit=!1:this.useOribit=!0);var e=this.sceneManager,t=e.GetCamera(),r=e.GetSceneBox();this.cameraToCenterDis=t.GetWorldPosition().Sub(r.Center()).Length();r.Length();r.IsInside(t.GetWorldPosition())==C.OUTSIDE?(this.useOribit||t.SetRotateCenter(r.Center()),this.movSpeed=.5*this.cameraToCenterDis*this.firstPersionSpeed+r.Length()/100,this.trackBall.SetRotateSpeed(.5),this.insideBoundingBox=!1):(this.useOribit||t.SetRotateCenter(t.GetPosition()),this.trackBall.SetRotateSpeed(.5),this.insideBoundingBox=!0)}},e.prototype.RotateAroundAxis=function(){var e=this.sceneManager.GetCamera(),t=(e.GetWorldPosition().Sub(this.oribitControlTarget),this.trackBall.mvMatrix.rotation.EulerAngles()),r=new C.Quaternion(1.5*-t.y,C.Vector3.UP().Clone()),i=C.Matrix4.IDENTITY().Clone(),n=C.Matrix4.IDENTITY().Clone(),o=C.Matrix4.IDENTITY().Clone(),a=(C.Matrix4.IDENTITY().Clone(),C.Matrix4.IDENTITY().Clone());i.MultiTranslate(this.oribitControlTarget.Multiply(-1)),n.MultiRotatiton(r),o.MultiTranslate(this.oribitControlTarget),a=o.Multiply(n).Multiply(i);var s=e.GetView().ToMatrix4(),l=s.Multiply(a).Multiply(s.Inverse());e.Translate(l.Translation(),C.Camera.TS_LOCAL),e.Rotate(l.Rotation()),e.Translate(this.trackBall.mvMatrix.moveVector.Multiply(-1),C.Camera.TS_LOCAL),e.ZoomView(this.trackBall.mvMatrix.scaleFactor)},e.prototype.FreeViewRotate=function(){var e=this.trackBall.GetMoveDelta(),t=C.Parameters.Instance().m_fMouseSensitivity;this.m_fYaw+=t*e.x,this.m_fPitch+=t*e.y,this.m_fPitch=C.Clamp(this.m_fPitch,-90,90),this.sceneManager.GetCamera().SetRotation(new C.Quaternion(this.m_fPitch,this.m_fYaw,0))},e.prototype.OnUpDateTouchIntent=function(e){this.oribitMode||this.controlLockXY?r.prototype.OnUpDateTouchIntent.call(this,e):this.FreeViewRotate()},e.prototype.TwoPointsUp=function(e,t){this.Reset()},e.prototype.TwoPointsDis=function(e){var t=e[0]-e[2],r=e[1]-e[3];return Math.sqrt(t*t+r*r)},e.prototype.TwoPointsStart=function(e,t){this.PriPointTwo1.x=e[0],this.PriPointTwo1.y=e[1],this.PriPointTwo2.x=e[2],this.PriPointTwo2.y=e[3];var r=this.PriPointTwo1.Add(this.PriPointTwo2).Divide(2);if(this.PirDistance=this.TwoPointsDis(e),null!=this.sceneManager){var i=this.sceneManager.GetCamera();this.cachePriPoint=i.GetView().Multiply(i.GetViewPort().ScreenToWorldPoint(r.x,r.y,this.screenDepth))}this.insectPoint=this.cachePriPoint.Clone()},e.prototype.ControlCloseRangeByScreenCenter=function(){this.OptimizeCamera();var e=this.sceneManager.GetCamera().GetViewPort().GetRect(),t=new C.Vector2((e.left+e.right)/2,(e.bottom+e.top)/2),r=this.sceneManager.GetCamera(),i=r.GetViewPort().ScreenToWorldPoint(t.x,t.y,.5);if(this.movSpeed=this.standardSpeed,this.oribitControlTarget=i.Clone(),this.insideBoundingBox){var n=new C.Vector2(t.x,t.y),o=new C.Vector3,a=(this.sceneManager.GetPickPoint(n,o,!1),r.GetPosition().Sub(o).Length()),s=(this.movSpeed,a/8);this.movSpeed=C.Max(.1*this.standardSpeed,s)}},e.prototype.VirtualKeyControlSpeed=function(){var e=this.sceneManager.GetCamera().GetViewPort().GetRect(),t=new C.Vector2((e.left+e.right)/2,(e.bottom+e.top)/2);if(this.insideBoundingBox){var r=new C.Vector2(t.x,t.y),i=new C.Vector3;this.sceneManager.GetPickPoint(r,i,!1);this.virtualKeyTarget=i;var n=this.sceneManager.GetCamera().GetPosition().Sub(i).Length(),o=(this.movSpeed,n/8);this.movSpeed=C.Max(.1*this.standardSpeed,o)}},e.prototype.IsNeedUpdateSpeed=function(e){var t=!1,r=this.sceneManager.GetCamera().GetPosition(),i=this.virtualKeyTarget.Sub(r);return i.Normalize(),i.DotProduct(e)<.966&&(t=!0),t},e.prototype.VirtualKeyControlTask=function(e){return e.VirtualKeyControlSpeed(),null},e.prototype.StartVirtualKeyControlTask=function(){this.virtualKeyControlTimer.IsStart()&&this.virtualKeyControlTimer.StopTimer(),this.virtualKeyControlTimer.StartTimer(),this.virtualKeyControlTimer.SetTimer(this.VirtualKeyControlTask,this,33)},e.prototype.EndVirtualKeyControlTask=function(){this.virtualKeyControlTimer.IsStart()&&this.virtualKeyControlTimer.StopTimer()},e.prototype.VirtualKeyMove=function(e,t){if(!(C.Abs(e)<.01&&C.Abs(t)<.01)){this.ControlCloseRangeByScreenCenter();var r=this.sceneManager.GetCamera(),i=r.GetPosition(),n=r.GetView().ToMatrix3(),o=new C.Vector3(n.Value(2,0),0,n.Value(2,2)),a=new C.Vector3(n.Value(0,0),0,n.Value(0,2));(o=o.Multiply(-1)).Normalize(),(a=a.Multiply(-1)).Normalize();var s,l=o.Add(a);if(l.Normalize(),this.insideBoundingBox){var h=this.GetDirectionDistance(l,0);this.movSpeed=h/800,this.movSpeed=this.movSpeed*this.firstPersionSpeed,s=i.Add(o.Multiply(e*this.movSpeed*.3)).Add(a.Multiply(t*this.movSpeed*.3))}else this.movSpeed=this.movSpeed*this.firstPersionSpeed,s=i.Add(o.Multiply(e*this.movSpeed).Add(a.Multiply(t*this.movSpeed)));r.SetWorldPosition(s),this.isOribteRotateState=!1}},e.prototype.ControlCloseRangeSpeed=function(e){var t=this.sceneManager.GetCamera(),r=(this.insectPoint,new C.Vector2(e.x,e.y),t.GetView().ToMatrix3()),i=new C.Vector3(r.Value(2,0),0,r.Value(2,2));if((i=i.Multiply(-1)).Normalize(),this.insideBoundingBox){var n=this.GetDirectionDistance(i,0);this.movSpeed=C.Min(this.movSpeed,n/800)}else{n=this.GetDirectionDistance(i,0);this.movSpeed=C.Min(this.movSpeed,n/10)}this.useOribit&&this.updateOribitControlTarget()},e.prototype.TwoPointsMove=function(e,t){this.CurrDistance=this.TwoPointsDis(e);var r=this.PirDistance/this.CurrDistance;if(this.trackBall.mvMatrix.rotation=C.Quaternion.IDENTITY().Clone(),this.trackBall.mvMatrix.moveVector=C.Vector3.ZERO().Clone(),(1<Math.abs(this.PriPointTwo1.x-e[0])||1<Math.abs(this.PriPointTwo1.y-e[1])||1<Math.abs(this.PriPointTwo2.x-e[2])||1<Math.abs(this.PriPointTwo2.y-e[3]))&&null!=this.sceneManager){var i=this.sceneManager.GetCamera();if(!i.IsOrthographic()){C.Trackball.ISMOVING=!0,C.Trackball.KEEPINGSTATETIMES=C.Trackball.TIMES;var n=new C.Vector2((e[0]+e[2])/2,(e[1]+e[3])/2),o=this.PriPointTwo1.Add(this.PriPointTwo2).Divide(2),a=new C.Vector2(e[0],e[1]),s=new C.Vector2(e[2],e[3]),l=this.PriPointTwo1.Sub(this.PriPointTwo2).Length(),h=a.Sub(s).Length(),u=Math.abs(l-h),p=Math.abs(h-this.PirDistance);if(this.ControlCloseRangeSpeed(n),25<p){var c=i.GetViewPort().ScreenToWorldPoint(n.x,n.y,this.screenDepth),d=i.GetPosition(),S=this.movSpeed*r*(1<r?-1:1);i.SetWorldPosition(d.Add(c.Sub(d).Normalized().Multiply(S))),this.PirDistance=this.CurrDistance}else if(u<8){new C.Vector2(o.x,o.y);var f=this.insectPoint,m=(this.sceneManager.GetSceneBox().Center(),d=i.GetPosition(),i.GetViewPort().ScreenToWorldPoint(o.x,o.y,this.screenDepth)),y=i.GetViewPort().ScreenToWorldPoint(n.x,n.y,this.screenDepth),T=(i.GetViewPort().ScreenToWorldPoint(o.x,o.y,this.screenDepth/2),i.GetViewPort().ScreenToWorldPoint(n.x,n.y,this.screenDepth/2),d.Sub(m).Length()),M=d.Sub(f).Length(),g=m.Sub(y).Length()*M/T,v=y.Sub(m).Normalized();i.SetWorldPosition(d.Sub(v.Multiply(g))),this.needMoveValue=v.Multiply(-g)}this.trackBall.mvMatrix.scaleFactor=1}}this.PriPointTwo1.x=e[0],this.PriPointTwo1.y=e[1],this.PriPointTwo2.x=e[2],this.PriPointTwo2.y=e[3]},e.prototype.LimitCamera=function(){null!=this.sceneManager&&this.sceneManager.GetCamera().IsOrthographic()},e.prototype.TwoPointsRotate=function(e,t,r,i){var n=e.GetViewPort().ScreenToWorldPoint(r.x,r.y,this.screenDepth),o=e.GetViewPort().ScreenToWorldPoint(i.x,i.y,this.screenDepth);e.GetPosition();e.GetWorldPosition();var a=new C.Vector2(t[0],t[1]),s=new C.Vector2(t[2],t[3]),l=C.Matrix4.IDENTITY().Clone();this.GetTwoPointsRotateMatrix(this.PriPointTwo1,this.PriPointTwo2,a,s,this.sceneManager,n.Add(o).Divide(2),l,this.screenDepth),l=l.Inverse(),e.Translate(l.Translation(),C.Camera.TS_WORLD),e.Rotate(l.Rotation(),C.Camera.TS_WORLD)},e.prototype.LockPointer=function(){if(C.Parameters.Instance().m_upDirectionValue!=C.Vector3.ZERO().Clone()){var e=this.sceneManager,t=e.GetCamera(),r=(t.GetPosition(),e.GetSceneBox().Center(),t.GetWorldRotation().EulerAngles()),i=r.x;if(i=C.Max(-85,C.Min(85,i)),this.controlLockXY){var n=new C.Quaternion(this.phi,r.y,0);t.SetRotation(n)}else{n=new C.Quaternion(i,r.y,0);t.SetRotation(n)}}var o=this.trackBall.mvMatrix.rotation.Inverse(),a=this.sceneManager.GetCamera();a.RotateAroundCenter(o,C.Camera.TS_WORLD),a.Translate(this.trackBall.mvMatrix.moveVector.Multiply(-1),C.Camera.TS_LOCAL),a.ZoomView(1/this.trackBall.mvMatrix.scaleFactor)},e.prototype.ConstraintMode=function(e){if(e){var t=this.sceneManager,r=t.GetCamera(),i=(r.GetPosition(),t.GetSceneBox().Center(),r.GetWorldRotation().EulerAngles().x);this.phi=i,this.oribitMode=!1,this.freeViewMode=!1}this.controlLockXY=e},e.prototype.OribitMode=function(e){e&&(this.controlLockXY=!1,this.freeViewMode=!1),this.oribitMode=e},e.prototype.FreeViewMode=function(e){e&&(this.oribitMode=!1,this.controlLockXY=!1),this.freeViewMode=e},e.prototype.TwoPointsRotateAngle=function(e,t,r,i,n,o,a,s){var l,h,u,p;h=e.x<t.x?(l=e,t):(l=t,e),p=r.x<i.x?(u=r,i):(u=i,r);var c=n.GetViewPort().ScreenToWorldPoint(l.x,l.y,a),d=n.GetViewPort().ScreenToWorldPoint(h.x,h.y,a),S=n.GetViewPort().ScreenToWorldPoint(u.x,u.y,a),f=n.GetViewPort().ScreenToWorldPoint(p.x,p.y,a),m=d.Sub(c);m.Normalize();var y=f.Sub(S);y.Normalize();var T=C.Acos(m.DotProduct(y));m.CrossProduct(y).Normalized()},e.prototype.TwoPointsRotate2=function(e,t,r,i,n,o,a,s,l){var h,u=a.Sub(o);this.TwoPointsRotateAngle(e,t,r,i,n,void 0,l,0),h.FromAngleAxis(0,void 0),h.Normalize();var p=new C.Quaternion(0,u.x,u.y,u.z),c=h.Multiply(p).Multiply(h).Inverse();new C.Vector3(c.x,c.y,c.z).Add(o)},e.prototype.GetTwoPointsRotateMatrix=function(e,t,r,i,n,o,a,s){var l=n.GetCamera();this.TwoPointsRotateAngle(e,t,r,i,l,void 0,s,0);var h=new C.Vector3,u=new C.Vector2(r.Add(i).x/2,r.Add(i).y/2);if(n.GetPickPoint(u,h,!0)){var p=new C.Matrix4;p.SetTranslation(h.Multiply(-1)),(void 0).FromAngleAxis(0,void 0),p.MultiRotatiton(void 0),p.MultiTranslate(h),p}},e.prototype.OrbitControl=function(){var e,t,r=this.sceneManager.GetCamera(),i=r.GetWorldPosition(),n=C.Quaternion.IDENTITY().Clone();n.Normalize();var o=i.Sub(this.oribitControlTarget);o=n.Multiply(o),e=Math.atan2(o.x,o.z),t=Math.atan2(Math.sqrt(o.x*o.x+o.z*o.z),o.y);var a=this.trackBall.mvMatrix.rotation.EulerAngles();e-=a.y,this.oribitMode&&(t-=a.x,t=C.Max(.1,C.Min(179.9,t)));var s=o.Length();o.x=s*Math.sin(t)*Math.sin(e),o.y=s*Math.cos(t),o.z=s*Math.sin(t)*Math.sin(e),o=n.Inverse().Multiply(o),i=this.oribitControlTarget.Add(o),r.SetWorldPosition(i),r.LookAt(this.oribitControlTarget,n.Multiply(C.Vector3.UP()),C.Camera.TS_WORLD)},e.prototype.MoveStraight=function(e){var t=Math.abs(e);if(!(t<.01)){e=1e3<this.sceneManager.GetSceneBox().Length()?e/t*100:e/t*.1,this.ControlCloseRangeByScreenCenter();var r=this.sceneManager.GetCamera(),i=r.GetPosition(),n=r.GetRotation(),o=new C.Quaternion(this.m_fPitch,0,0);new C.Vector3;n.Multiply(o.Inverse()).Multiply(C.Vector3.BACK());var a,s=r.GetView().ToMatrix3(),l=new C.Vector3(s.Value(2,0),0,s.Value(2,2));if((l=l.Multiply(-1)).Normalize(),this.insideBoundingBox){var h=this.GetDirectionDistance(l,0);this.movSpeed=h/400,this.movSpeed=this.movSpeed*this.firstPersionSpeed,a=i.Add(l.Multiply(e*this.movSpeed*.3))}else a=i.Add(l.Multiply(e*this.movSpeed));r.SetWorldPosition(a),this.pView.RequestDraw(),this.isOribteRotateState=!1}},e.prototype.MoveSideways=function(e){var t=Math.abs(e);if(!(t<.01)){e=1e3<this.sceneManager.GetSceneBox().Length()?e/t*100:e/t*.1,this.ControlCloseRangeByScreenCenter();var r=this.sceneManager.GetCamera(),i=r.GetPosition(),n=r.GetRotation(),o=new C.Quaternion(this.m_fPitch,0,0);new C.Vector3;n.Multiply(o.Inverse()).Multiply(C.Vector3.LEFT());var a,s=r.GetView().ToMatrix3(),l=new C.Vector3(s.Value(0,0),0,s.Value(0,2));if((l=l.Multiply(-1)).Normalize(),this.insideBoundingBox){var h=this.GetDirectionDistance(l,0);this.movSpeed=h/400,this.movSpeed=this.movSpeed*this.firstPersionSpeed,a=i.Add(l.Multiply(e*this.movSpeed*.3))}else a=i.Add(l.Multiply(e*this.movSpeed));r.SetWorldPosition(a),this.pView.RequestDraw(),this.isOribteRotateState=!1}},e.prototype.MoveUpAndDown=function(e){var t=Math.abs(e);if(!(t<.01)){e=1e3<this.sceneManager.GetSceneBox().Length()?e/t*100:e/t*.1,this.ControlCloseRangeByScreenCenter();var r,i=this.sceneManager.GetCamera(),n=i.GetPosition(),o=(i.GetView().ToMatrix3(),C.Vector3.UP().Clone());if((o=o.Multiply(-1)).Normalize(),this.insideBoundingBox){var a=this.GetDirectionDistance(o,0);this.movSpeed=a/800*this.firstPersionSpeed,r=n.Add(o.Multiply(e*this.movSpeed*.3))}else r=n.Sub(C.Vector3.UP().Multiply(e).Multiply(this.firstPersionSpeed));i.SetWorldPosition(r),this.pView.RequestDraw(),this.isOribteRotateState=!1}},e.prototype.RotateUpAndDown=function(e){if(!(C.Abs(e)<.01)){var t=this.sceneManager.GetCamera(),r=t.GetView().ToMatrix3(),i=(new C.Vector3(r.Value(1,0),r.Value(1,1),r.Value(1,2)),t.GetWorldRotation().EulerAngles()),n=i.x+e;n=C.Max(-85,C.Min(85,n));var o=new C.Quaternion(n,i.y,0);this.pView.RequestDraw(),t.SetRotation(o)}},e.prototype.RotateSideways=function(e){if(!(C.Abs(e)<.01)){var t=this.sceneManager.GetCamera(),r=t.GetView().ToMatrix3(),i=(new C.Vector3(r.Value(1,0),r.Value(1,1),r.Value(1,2)),t.GetWorldRotation().EulerAngles()),n=i.y-e,o=new C.Quaternion(i.x,n,0);this.pView.RequestDraw(),t.SetRotation(o)}},e.prototype.OnTouchDown=function(e,t){r.prototype.OnTouchDown.call(this,e,t)},e.prototype.updateOribitControlTarget=function(){var e=this.sceneManager.GetCamera().GetViewPort().GetRect(),t=new C.Vector2((e.left+e.right)/2,(e.bottom+e.top)/2),r=new C.Vector3;this.sceneManager.GetPickPoint(t,r,!1);this.oribitControlTarget=r.Clone()},e.prototype.SetCameraFov=function(e){this.sceneManager.GetCamera().SetFov(e)},e.prototype.GetCameraFov=function(){return this.sceneManager.GetCamera().GetFov()},e.prototype.GetDirectionDistance=function(e,t){var r=0,i=this.sceneManager.GetSceneBox();switch(t){case 0:r=.7071<Math.abs(e.DotProduct(C.Vector3.RIGHT().Clone()))?i.GetXLength():i.GetZLength();break;case 3:r=.7071<Math.abs(e.DotProduct(C.Vector3.FORWARD().Clone()))?i.GetZLength():i.GetXLength()}return r},e}(C.CommonTouchHandler);C.WalkthroughHandler=e}(M3D||(M3D={})),function(e){var t,r;(r=t=e.LinkActionType||(e.LinkActionType={}))[r.LinkTypeView=0]="LinkTypeView",r[r.LinkTypeAnimation=1]="LinkTypeAnimation",r[r.LinkTypeOpenFile=2]="LinkTypeOpenFile",r[r.LinkTypeStory=3]="LinkTypeStory";var i=function(){function e(e,t,r,i,n,o){if(this.srcType=e,this.srcPath=t,this.targetType=r,this.targetPath=i,"view"===r)this.action=new p(Number(this.targetPath));else if("animation"===r){var a=this.targetPath.split("|");this.action=new c(a[0],1<a.length?a[1]:"")}else if("story"===r){var s=o.id,l=o.name,h=o.views;this.action=new d(s,l,h)}if(""!==n&&4<(this.condition=n).length&&"pos="===n.substring(0,4)){var u=n.substring(4).split(" ");3===u.length&&(this.conditionX=Number(u[0]),this.conditionY=Number(u[1]),this.conditionZ=Number(u[2]),this.hasPosCondition=!0)}}return Object.defineProperty(e.prototype,"srcType",{get:function(){return this._srcType},set:function(e){this._srcType=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"srcPath",{get:function(){return this._srcPath},set:function(e){this._srcPath=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"targetType",{get:function(){return this._targetType},set:function(e){this._targetType=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"targetPath",{get:function(){return this._targetPath},set:function(e){this._targetPath=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"conditionX",{get:function(){return this._conditionX},set:function(e){this._conditionX=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"conditionY",{get:function(){return this._conditionY},set:function(e){this._conditionY=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"conditionZ",{get:function(){return this._conditionZ},set:function(e){this._conditionZ=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"condition",{get:function(){return this._condition},set:function(e){this._condition=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"hasPosCondition",{get:function(){return this._hasPosCondition},set:function(e){this._hasPosCondition=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"action",{get:function(){return this._action},set:function(e){this._action=e},enumerable:!0,configurable:!0}),e.prototype.onExecute=function(){this.action&&this.action.Execure()},e}();e.Link=i;var n=function(){function e(){}return e.prototype.Execure=function(){},e.prototype.GetActionType=function(){},e.prototype.clearViewsId=function(){},e.prototype.clearTimeIds=function(){},e}(),p=function(i){function e(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=i.call(this)||this;return 0<e.length&&(r.viewID=Number(e[0])),r}return __extends(e,i),e.prototype.getViewID=function(){return this.viewID},e.prototype.Execure=function(){this.view.view.ShowModelView(Number(this.getViewID()),!0,!0)},e.prototype.GetActionType=function(){return t.LinkTypeView},e}(e.LinkAction=n);e.LinkOpenViewAction=p;var c=function(i){function e(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=i.call(this)||this;return 0<e.length&&(r.processID=e[0],r.stepID=e[1]),r}return __extends(e,i),e.prototype.Execure=function(){this.view.GetAnimationPlayer().playAnimation(Number(this.processID),this.stepID?Number(this.stepID):null)},e.prototype.GetActionType=function(){return t.LinkTypeAnimation},e.prototype.GetStepID=function(){return this.stepID},e.prototype.GetProcessID=function(){return this.processID},e}(n);e.LinkOpenAniAction=c;var d=function(a){function e(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=a.call(this)||this;if(r.viewsId=[],r.timeIds=[],r.views={},0<e.length&&(r.id=e[0],r.name=e[1],e[2]&&0<e[2].length))for(var i=0,n=e[2];i<n.length;i++){var o=n[i];o.time&&(r.views[o.id]=o.time)}return r}return __extends(e,a),e.prototype.Execure=function(){var e=this;if(this.viewsId=[],this.view.view.ShowLinkStoryListener=function(){e.ShowLinkStoryListener()},this.viewsId=new Array,this.view.view.StopModelViewAnimation(),this.views)for(var t in this.views)this.viewsId.push(t);if(0!==this.viewsId.length){var r=this.viewsId[0];if(this.viewsId.shift(),this.views[r]){var i=this.views[r];this.view.view.setCameraAnimationTime(1e3*i),this.view.view.setModelExplosiveAnimationTime(1e3*i),this.view.view.ShowModelView(r,!0,!0)}}},e.prototype.ShowLinkStoryListener=function(){if(0!==this.viewsId.length){var e=this.viewsId[0];if(this.viewsId.shift(),this.views[e]){var t=this.views[e];this.view.view.setCameraAnimationTime(1e3*t),this.view.view.setModelExplosiveAnimationTime(1e3*t);var r=this,i=window.setTimeout(function(){r.view.view.startLinkAni&&r.view.view.ShowModelView(e,!0,!0)},800);this.timeIds.push(i)}}else this.ShowLastLinkStoryListener&&this.ShowLastLinkStoryListener()},e.prototype.clearViewsId=function(){this.viewsId=[]},e.prototype.clearTimeIds=function(){if(this.timeIds)for(var e=0;e<this.timeIds.length;e++)window.clearTimeout(this.timeIds[e])},e.prototype.GetActionType=function(){return t.LinkTypeStory},e.prototype.GetID=function(){return this.id},e.prototype.GetName=function(){return this.name},e.prototype.GetViews=function(){return this.views},e}(n);e.LinkStoryAction=d}(SView||(SView={})),function(t){var e=function(){function e(){this._links=[],this._svlFilePath="",this._version="2.0"}return e.Instance=function(){return null==e.instance&&(e.instance=new e),e.instance},Object.defineProperty(e.prototype,"svlFilePath",{get:function(){return this._svlFilePath},set:function(e){this._svlFilePath=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"version",{get:function(){return this._version},set:function(e){this._version=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"view",{get:function(){return this._view},set:function(e){this._view=e},enumerable:!0,configurable:!0}),e.prototype.GetLinkByPart=function(e){var t=[];if(0<this.GetAllLinkList().length)for(var r=0,i=this.GetAllLinkList();r<i.length;r++){var n=i[r];e==n.srcPath&&t.push(n)}return t},e.prototype.GetAllLinkList=function(){return this._links},e.prototype.ClearStoryLinkViews=function(){this.view.view.startLinkAni=!1;for(var e=0;e<this._links.length;e++)this._links[e].action instanceof t.LinkStoryAction&&this._links[e].action.clearViewsId()},e.prototype.ClearData=function(){this._links=[]},e.prototype.AddLink=function(e){this._links.push(e),e.action.view=this.view},e.prototype.DeleteLink=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(1===e.length){var r=e[0];-1<this._links.indexOf(r)&&this._links.splice(this._links.indexOf(r),1)}else if(2===e.length)for(var i=e[0],n=e[1],o=0;o<this._links.length;o++){if((r=this._links[o]).srcPath===i&&r.condition===n)return void this._links.splice(o,1)}},e.prototype.GetLink=function(e,t){for(var r=[],i=0;i<this._links.length;i++){var n=this._links[i];t&&n.condition?n.srcPath===e&&n.conditionX===Number(t.x.toFixed(2))&&n.conditionY===Number(t.y.toFixed(2))&&n.conditionZ===Number(t.z.toFixed(2))&&r.push(n):n.srcPath===e&&r.push(n)}return r},e.instance=null,e}();t.LinkManager=e}(SView||(SView={})),function(e){var t=function(){this.onBeforeSelect=function(e,t){return!0},this.onSelected=function(e,t){},this.onUnSelected=function(e,t){},this.onClearSelected=function(e){},this.onShapesSelected=function(e,t){},this.OnModelSelected=function(e,t){}};(M3D||(M3D={})).SelectorListener=t}(),function(e){var t=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t}(M3D.SelectorListener);e.SViewSelctorListener=t;var r=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t}(M3D.ReadListener);e.SViewReadListener=r;var i=function(){this.onBegin=function(e){},this.onExecute=function(e){},this.onEnd=function(e){}};e.SViewExecuteListener=i}(SView||(SView={})),function(a){var e=function(){function t(e){this.view=e}return t.Instance=function(e){return null==t.instance&&(t.instance=new t(e)),t.instance},t.prototype.InserTo=function(e,t,r){var i,n=new a.AddFileOperation(this.view,e,t);return i=n.execute(),n.GetNewModel(),i},t.prototype.MoveTo=function(e,t){return new a.MoveModelOperation(this.view,e,t).execute()},t.prototype.CopyTo=function(e,t){var r=new a.CopyModelOperation(this.view,e,t);return[r.execute(),r.GetNewMode()]},t.prototype.Remove=function(e){return new a.RemoveModelOperation(this.view,e).execute()},t.prototype.ReName=function(e,t){return new a.RenameOperation(this.view,e,t).execute()},t.prototype.Move=function(e,t){var r=t.split(","),i=this.view.GetModelBySVLPath(e),n=new a.Matrix4(Number(r[0]),Number(r[1]),Number(r[2]),Number(r[3]),Number(r[4]),Number(r[5]),Number(r[6]),Number(r[7]),Number(r[8]),Number(r[9]),Number(r[10]),Number(r[11]),Number(r[12]),Number(r[13]),Number(r[14]),Number(r[15])),o=new a.Matrix3x4(n);a.ModelTransformHelper.SetWorldMatrix(i,o)},t.instance=null,t}();a.BomManager=e}(M3D||(M3D={})),function(e){var t=function(e){this.sview=e};(SView||(SView={})).SViewManager=t}(),function(e){var t=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.curClipDirection=1,e.curClipValue=0,e.curIsShowCappingPlane=!1,e}return __extends(e,t),e.prototype.SetClipParam=function(e,t){},e}(e.SViewManager);e.ClipManager=t}(SView||(SView={})),function(e){var t=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.curExplosiveStyle=0,e.curExplosivePercentage=0,e}return __extends(e,t),e.prototype.SetExplosiveParam=function(e,t){switch(e){case"percentage":this.curExplosivePercentage=t,this.sview.view.SetExplosiveView(this.curExplosiveStyle,this.curExplosivePercentage,!1);break;case"style":this.curExplosiveStyle=t,this.sview.view.SetExplosiveView(this.curExplosiveStyle,this.curExplosivePercentage,!1)}},e.prototype.OpenExplosive=function(e,t){this.sview.view.SetExplosiveView(e,t,!1),this.sview.view.SetPerspective(6)},e.prototype.CloseExplosive=function(){this.sview.view.CloseExplosiveView(),this.curExplosivePercentage=0},e}(e.SViewManager);e.ExplosiveManager=t}(SView||(SView={})),function(s){var r,e;(e=r=s.InterpolationMode||(s.InterpolationMode={}))[e.BEZIER_CURVE=0]="BEZIER_CURVE",e[e.CATMULL_ROM_CURVE=1]="CATMULL_ROM_CURVE",e[e.LINEAR_CURVE=2]="LINEAR_CURVE",e[e.CATMULL_ROM_FULL_CURVE=3]="CATMULL_ROM_FULL_CURVE";var t=function(){function e(e){this.knots_=[],this.interpolationMode_=e}return e.prototype.AddKnot=function(e){0<this.knots_.length&&typeof this.knots_[0]==typeof e?this.knots_.push(e):0==this.knots_.length&&this.knots_.push(e)},e.prototype.GetPoint=function(e){if(this.knots_.length<2)return 1==this.knots_.length?this.knots_[0]:null;switch(1<e?e=1:e<0&&(e=0),this.interpolationMode_){case r.CATMULL_ROM_FULL_CURVE:var t=[];return 1<this.knots_.length&&(t=this.knots_[0]!=this.knots_[this.knots_.length-1]?[this.knots_[0]].concat(this.knots_).concat([this.knots_[this.knots_.length-1]]):[this.knots_[this.knots_.length-2]].concat(this.knots_).concat([this.knots_[1]])),this.CatmullRomInterpolation(t,e);default:return s.LOGI("Unsupported interpolation mode"),null}},e.prototype.CatmullRomInterpolation=function(e,t){if(e.length<4)return null;if(1<=t)return e[e.length-2];var r=parseInt(String(t*(e.length-3))),i=(t=t*(e.length-3)%1)*t,n=i*t;return this.CalculateCatmullRom(e[r],e[r+1],e[r+2],e[r+3],t,i,n)},e.prototype.CalculateCatmullRom=function(e,t,r,i,n,o,a){var s=t.Multiply(2).Multiply(.5),l=r.Sub(e).Multiply(n).Multiply(.5),h=e.Multiply(2).Sub(t.Multiply(5)).Add(r.Multiply(4)).Sub(i).Multiply(o).Multiply(.5),u=t.Multiply(3).Sub(e).Sub(r.Multiply(3)).Add(i).Multiply(a).Multiply(.5);return s.Add(l).Add(h).Add(u)},e.prototype.LinearInterpolation=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(2===e.length){var r=e[0],i=e[1];if(r.length<2)return null;if(1<=i)return r[r.length-1];var n=s.Clamp(i*(r.length-1),0,r.length-2);return i=i*(r.length-1)%1,this.LinearInterpolation(r[n],r[n+1],i)}var o=e[0],a=e[1];i=e[2];switch(o.GetType()){case s.VariantType.VAR_FLOAT:return s.Lerp(o,a,i);default:return null}},e}();s.Spline=t}(M3D||(M3D={})),function(e){var i,t;(t=i=e.VariantType||(e.VariantType={}))[t.VAR_NONE=0]="VAR_NONE",t[t.VAR_INT=1]="VAR_INT",t[t.VAR_BOOL=2]="VAR_BOOL",t[t.VAR_FLOAT=3]="VAR_FLOAT",t[t.VAR_VECTOR2=4]="VAR_VECTOR2",t[t.VAR_VECTOR3=5]="VAR_VECTOR3",t[t.VAR_VECTOR4=6]="VAR_VECTOR4",t[t.VAR_QUATERNION=7]="VAR_QUATERNION",t[t.VAR_COLOR=8]="VAR_COLOR",t[t.VAR_STRING=9]="VAR_STRING",t[t.VAR_BUFFER=10]="VAR_BUFFER",t[t.VAR_VOIDPTR=11]="VAR_VOIDPTR",t[t.VAR_RESOURCEREF=12]="VAR_RESOURCEREF",t[t.VAR_RESOURCEREFLIST=13]="VAR_RESOURCEREFLIST",t[t.VAR_VARIANTVECTOR=14]="VAR_VARIANTVECTOR",t[t.VAR_VARIANTMAP=15]="VAR_VARIANTMAP",t[t.VAR_INTRECT=16]="VAR_INTRECT",t[t.VAR_INTVECTOR2=17]="VAR_INTVECTOR2",t[t.VAR_PTR=18]="VAR_PTR",t[t.VAR_MATRIX3=19]="VAR_MATRIX3",t[t.VAR_MATRIX3X4=20]="VAR_MATRIX3X4",t[t.VAR_MATRIX4=21]="VAR_MATRIX4",t[t.VAR_DOUBLE=22]="VAR_DOUBLE",t[t.VAR_STRINGVECTOR=23]="VAR_STRINGVECTOR",t[t.VAR_RECT=24]="VAR_RECT",t[t.VAR_INTVECTOR3=25]="VAR_INTVECTOR3",t[t.VAR_INT64=26]="VAR_INT64",t[t.MAX_VAR_TYPES=27]="MAX_VAR_TYPES";var r=["None","Int","Bool","Float","Vector2","Vector3","Vector4","Quaternion","Color","String","Buffer","VoidPtr","ResourceRef","ResourceRefList","VariantVector","VariantMap","IntRect","IntVector2","Ptr","Matrix3","Matrix3x4","Matrix4","Double","StringVector","Rect","IntVector3","Int64",0],n=function(){function e(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(1===e.length){var r=e[0];this.type_=r}else this.type_=i.VAR_NONE}return e.prototype.GetType=function(){return this.type_},e.prototype.GetTypeName=function(){return r[this.type_]},e.prototype.GetFloat=function(){},e}();e.Variant=n}(M3D||(M3D={})),function(a){var e=function(){function e(){}return e.ConvertToFloat32Array=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(e[0][0]instanceof a.Vector3){for(var r=new Float32Array(3*e[0].length),i=0;i<e[0].length;++i){var n=e[0][i];r[3*i]=n.x,r[3*i+1]=n.y,r[3*i+2]=n.z}return r}if("number"==typeof e[0][0]){for(r=new Float32Array(e[0].length),i=0;i<e[0].length;++i){var o=e[0][i];r[i]=o}return r}},e.ConvertToInt8Array=function(e){for(var t=new Int8Array(e.length),r=0;r<e.length;++r){var i=e[r];t[r]=i}return t},e.ConvertToUInt8Array=function(e){for(var t=new Uint8Array(e.length),r=0;r<e.length;++r){var i=e[r];t[r]=i}return t},e.ConvertToInt16Array=function(e){for(var t=new Int16Array(e.length),r=0;r<e.length;++r){var i=e[r];t[r]=i}return t},e.RemoveByValue=function(e,t){for(var r=0;r<e.length;r++)if(e[r]===t){e.splice(r,1),t=null;break}},e.ConvertToFloat32ArrayV2=function(e){for(var t=new Float32Array(2*e.length),r=0;r<e.length;++r){var i=e[r];t[2*r]=i.x,t[2*r+1]=i.y}return t},e}();a.ArrayHelper=e}(M3D||(M3D={})),function(SView){var BrowserHelper=function(){function BrowserHelper(){}return BrowserHelper.myBrowser=function(){var e=navigator.userAgent,t=-1<e.indexOf("Opera");return t?"Opera":-1<e.indexOf("Edge")?"Edge":-1<e.indexOf("Firefox")?"FF":-1<e.indexOf("Chrome")?"Chrome":-1<e.indexOf("Safari")?"Safari":"ActiveXObject"in window?"IE":-1<e.indexOf("compatible")&&-1<e.indexOf("MSIE")&&!t?"IE":void 0},BrowserHelper.JSONToObject=function(jsonStr,object){var json=eval("("+jsonStr+")");for(var key in json)object[key]=json[key];return object},BrowserHelper}();SView.BrowserHelper=BrowserHelper}(SView||(SView={})),function(e){e.IsObjectExist=function(e){return null!=e},e.IsStringNotEmpty=function(e){return null!=e&&0===e.length}}(M3D||(M3D={})),function(e){var t=function(){function e(){}return e.AddCookie=function(e,t,r){var i=e+"="+encodeURI(t);if(0<r){var n=new Date;n.setTime(n.getTime()+24*r*3600*1e3),i=i+"; expires="+n.toUTCString()}document.cookie=i},e.GetCookie=function(e){for(var t=document.cookie.split("; "),r=0;r<t.length;r++){var i=t[r].split("=");if(i[0]==e)return decodeURI(i[1])}},e.DeleteCookie=function(e){var t=new Date;t.setTime(t.getTime()-1e4),document.cookie=e+"=v; expires="+t.toUTCString()},e}();e.CookieHelper=t}(M3D||(M3D={})),function(s){s.OUTSIDE=0,s.INTERSECTS=1,s.INSIDE=2;var e=function(){function e(){this.drawLLLimit=0,this.drawLimit=0,this.modelLength=0,this.cullerStyle=0,this.screenLength=200,this.priCameraScale=1,this.cullerbase=0,this.cullerPercent=0}return e.prototype.InViewPort=function(e,t){var r=s.INTERSECTS;t&&(r=t.GetFrustum().IsInsideFast(e));return r},e.prototype.IsLittleModel=function(e,t){var r=0;if(e.Defined()){var i=e.Length();if(!t.IsOrthographic())i=1e3*i/t.GetWorldPosition().Sub(e.Center()).Length();0<i&&(i<this.drawLLLimit?r=2:i<this.drawLimit&&(r=1))}return r},e.prototype.SetModelLength=function(e){this.modelLength=e},e.prototype.SetScreenLength=function(e){},e.prototype.AddCullerRatio=function(e){},e.prototype.ReduceCullerRatio=function(e){},e.prototype.UpDate=function(e){var t=e.GetViewPort();this.cullerbase=s.Parameters.Instance().RemoveSize;var r=s.Parameters.Instance().RemoveSize,i=this.cullerbase/4;if(0===s.Parameters.Instance().RemoveMode)this.drawLimit=this.modelLength*r/100;else if(1===s.Parameters.Instance().RemoveMode){var n=t.ScreenToWorldPoint(0,0,.5),o=t.ScreenToWorldPoint(0,r,.5);this.drawLimit=n.Sub(o).Length();var a=t.ScreenToWorldPoint(0,i,.5);this.drawLLLimit=n.Sub(a).Length()}},e.prototype.AllowCuller=function(e,t){this.allowCuller=t,this.UpDate(e)},e}();s.CullerHelper=e}(M3D||(M3D={})),function(e){var t=function(){function e(){}return e.GetSuffix=function(e){var t="";return null!=e&&0<e.length&&(t=e.split(".").pop().toLowerCase()),t},e.GetUnionStylePath=function(e){var t=e;return t.replace("\\","/"),t},e.GetFileNameFromUrl=function(e){var t="";if(null!=e&&0<e.length){var r=e.lastIndexOf("/");r+1<e.length&&(t=e.substring(r+1))}return t},e}();e.FileHelper=t}(M3D||(M3D={})),function(t){var e=function(){function e(){this.currentTypeIndex=-1,this.IDMap=new t.Map,this.IDMap.Put(e.DEFAULT,1e5),this.currentTypeIndex=this.IDMap.Find(e.DEFAULT)}return e.GetDefaultID=function(){return null===e.pcreator&&(e.pcreator=new e),e.pcreator.GetID(e.DEFAULT)},e.prototype.Initialize=function(e,t){this.currentTypeIndex!==this.IDMap.Size()-1&&e===this.IDMap.Element(this.currentTypeIndex).key||(this.currentTypeIndex=this.IDMap.Find(e),this.currentTypeIndex===this.IDMap.Size()-1&&(this.IDMap.Put(e,t),this.currentTypeIndex=this.IDMap.Find(e))),this.IDMap.Element(this.currentTypeIndex).value=t},e.prototype.GetID=function(e){if(this.currentTypeIndex<this.IDMap.Size()){if(e===this.IDMap.Element(this.currentTypeIndex).key){var t=this.IDMap.Element(this.currentTypeIndex).value;return t+=1,this.IDMap.Element(this.currentTypeIndex).value=t,this.IDMap.Element(this.currentTypeIndex).value}this.currentTypeIndex=this.IDMap.Find(e),this.currentTypeIndex===this.IDMap.Size()-1&&(this.IDMap.Put(e,-1),this.currentTypeIndex=this.IDMap.Find(e));t=this.IDMap.Element(this.currentTypeIndex).value;return t+=1,this.IDMap.Element(this.currentTypeIndex).value=t,this.IDMap.Element(this.currentTypeIndex).value}this.currentTypeIndex=this.IDMap.Find(e),this.currentTypeIndex===this.IDMap.Size()-1&&(this.IDMap.Put(e,-1),this.currentTypeIndex=this.IDMap.Find(e));t=this.IDMap.Element(this.currentTypeIndex).value;return t+=1,this.IDMap.Element(this.currentTypeIndex).value=t,this.IDMap.Element(this.currentTypeIndex).value},e.GetIDFromTime=function(){},e.DEFAULT=-1,e.MODEL=0,e.NODE=1,e.SHAPE=2,e.HANDLE=3,e.pcreator=null,e.GetUUID=function(e,t){void 0===e&&(e=32),void 0===t&&(t=16);var r,i="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),n=[];if(t=t||i.length,e)for(r=0;r<e;r++)n[r]=i[0|Math.random()*t];else{var o=void 0;for(n[8]=n[13]=n[18]=n[23]="-",n[14]="4",r=0;r<36;r++)n[r]||(o=0|16*Math.random(),n[r]=i[19==r?3&o|8:o])}return n.join("")},e}();t.IDCreator=e}(M3D||(M3D={})),function(e){var t=function(){function e(){}return e.GetUriKeyValueStr=function(e,t){return e+"="+encodeURIComponent(t)},e}();e.KeyValueHelper=t}(M3D||(M3D={})),function(p){var e=function(){function t(){this.initState=!1}return t.prototype.SetLicenseOption=function(e){if(!e)return this.SetInitState(!1),void this.SetInitStateCode(p.READLICENSESTATE_OPENFAILURE);if(e.indexOf("\r")<0)return this.SetInitState(!1),void this.SetInitStateCode(p.READLICENSESTATE_FILECONTENTERROR);for(var t=e.split("\r"),r={},i=1;i<t.length;i++){var n=t[i].substring(1,t[i].length).split("=");r[n[0]]=n[1]}if(!r.LicenseType)return this.SetInitState(!1),void this.SetInitStateCode(p.READLICENSESTATE_FILECONTENTERROR);if(this.SetInitStateCode(p.READLICENSESTATE_SUCCESS),"3"===r.LicenseType[0]){this.SetInitState(!0),this.checkLicenceType=0;r.ServerAddress;var o=r.ID,a=p.CookieHelper.GetCookie(p.LICENCEID);a&&a!==o&&p.CookieHelper.DeleteCookie(p.LICENCETOKEN),this.SetID(o),this.SetProductName(r.ProductName),this.SetProductVersion(r.ProductVersion),this.SetLicenseType(r.LicenseType),this.SetServerAddress(r.ServerAddress),p.CookieHelper.AddCookie(p.LICENCEID,o,2/24)}else{this.checkLicenceType=2;var s=e.lastIndexOf("\r",e.length-2),l="";-1!==s&&(l=e.substring(0,s+2)),this.SetContentStr(l),this.SetInitState(!0),this.SetID(r.ID),this.SetProductName(r.ProductName),this.SetProductVersion(r.ProductVersion),this.SetLicenseType(r.LicenseType),this.SetTerm(r.Term),this.SetSeat(r.Seat);var h=r.BeginDate;h&&h.indexOf(" ")<0?this.SetBeginDate(h+" 00:00:00"):this.SetBeginDate(h);var u=r.EndDate;u&&u.indexOf(" ")<0?this.SetEndDate(u+" 23:59:59"):this.SetEndDate(u),this.SetServerMAC(r.ServerMAC),this.SetDevices(r.Devices),this.SetUsers(r.Users),this.SetModules(r.Modules),this.SetCustomer(r.Customer),this.SetCustomerEmail(r.CustomerEmail),this.SetCreator(r.Creator),this.SetCreateDate(r.CreateDate),this.SetCopyRight(r.CopyRight),this.SetSingCode(r.SignCode)}},t.prototype.GetCheckLicenseType=function(){return this.checkLicenceType},t.prototype.GetInitStateCode=function(){return this.initStateCode},t.prototype.SetInitStateCode=function(e){this.initStateCode=e},t.prototype.GetInitState=function(){return this.initState},t.prototype.SetInitState=function(e){this.initState=e},t.prototype.GetID=function(){return this.ID},t.prototype.SetID=function(e){this.ID=e},t.prototype.GetProductName=function(){return this.ProductName},t.prototype.SetProductName=function(e){this.ProductName=e},t.prototype.GetProductVersion=function(){return this.ProductVersion},t.prototype.SetProductVersion=function(e){this.ProductVersion=e},t.prototype.GetLicenseType=function(){return this.LicenseType},t.prototype.SetLicenseType=function(e){this.LicenseType=e},t.prototype.GetSeat=function(){return this.Seat},t.prototype.SetSeat=function(e){this.Seat=e},t.prototype.GetServerMAC=function(){return this.ServerMAC},t.prototype.SetServerMAC=function(e){this.ServerMAC=e},t.prototype.GetTerm=function(){return this.Term},t.prototype.SetTerm=function(e){this.Term=e},t.prototype.GetBeginDate=function(){return this.BeginDate},t.prototype.SetBeginDate=function(e){this.BeginDate=e},t.prototype.GetEndDate=function(){return this.EndDate},t.prototype.SetEndDate=function(e){this.EndDate=e},t.prototype.GetDevices=function(){return this.Devices},t.prototype.SetDevices=function(e){this.Devices=e},t.prototype.GetUsers=function(){return this.Users},t.prototype.SetUsers=function(e){this.Users=e},t.prototype.GetModules=function(){return this.Modules},t.prototype.SetModules=function(e){this.Modules=e},t.prototype.GetServerAddress=function(){return this.ServerAddress},t.prototype.SetServerAddress=function(e){this.ServerAddress=e},t.prototype.GetCustomer=function(){return this.Customer},t.prototype.SetCustomer=function(e){this.Customer=e},t.prototype.GetCustomerEmail=function(){return this.CustomerEmail},t.prototype.SetCustomerEmail=function(e){this.CustomerEmail=e},t.prototype.GetCreator=function(){return this.Creator},t.prototype.SetCreator=function(e){this.Creator=e},t.prototype.GetCreateDate=function(){return this.CreateDate},t.prototype.SetCreateDate=function(e){this.CreateDate=e},t.prototype.GetCopyRight=function(){return this.CopyRight},t.prototype.SetCopyRight=function(e){this.CopyRight=e},t.prototype.GetSingCode=function(){return this.SingCode},t.prototype.SetSingCode=function(e){this.SingCode=e},t.prototype.GetContentStr=function(){return this.contentStr},t.prototype.SetContentStr=function(e){this.contentStr=e},t.prototype.Copy=function(){var e=new t;return e.SetID(this.GetID()),e.SetProductName(this.GetProductName()),e.SetProductVersion(this.GetProductVersion()),e.SetLicenseType(this.GetLicenseType()),e.SetSeat(this.GetSeat()),e.SetServerMAC(this.GetServerMAC()),e.SetTerm(this.GetTerm()),e.SetBeginDate(this.GetBeginDate()),e.SetEndDate(this.GetEndDate()),e.SetDevices(this.GetDevices()),e.SetUsers(this.GetUsers()),e.SetModules(this.GetModules()),e.SetServerAddress(this.GetServerAddress()),e.SetCustomer(this.GetCustomer()),e.SetCustomerEmail(this.GetCustomerEmail()),e.SetCreator(this.GetCreator()),e.SetCreateDate(this.GetCreateDate()),e.SetCopyRight(this.GetCopyRight()),e.SetSingCode(this.GetSingCode()),e},t}();p.LicenseHelper=e}(M3D||(M3D={})),function(S){var e=function(){function e(e){this.licenceOption={userId:"123",funcode:"vSvaPZ2WeKJrRp9F+JI7rA75xt3lPowbhZoX1ARV2Llj8KrUDgYD0jngZQ6knF6G"},this.token=null,this.expries=null,this.sview=e}return e.prototype.SetLicenceOptionUserId=function(e){this.licenceOption.userId=e},e.prototype.GetLicenceOptionUserId=function(){return this.licenceOption.userId},e.prototype.access=function(n,o){if(2===this.sview.GetLicenseHelper().GetCheckLicenseType())o();else{var e=S.CookieHelper.GetCookie(S.LICENCETOKEN);if(e)return this.token=this.GetDString(e,S.LICENCETOKENHASH),void o();var a=this,s=a.sview.GetLicenseHelper();if(!s.GetID())return this.SetCheckState(!1),this.SetCheckStateCode(S.READLICENSESTATE_FILECONTENTERROR),void this.sview.ShowLicenseStateInfo();if(!s.GetProductName())return this.SetCheckState(!1),this.SetCheckStateCode(S.READLICENSESTATE_FILECONTENTERROR),void this.sview.ShowLicenseStateInfo();if(s.GetProductName()!==S.PRODUCTNAME)return this.SetCheckState(!1),this.SetCheckStateCode(S.CHECKSTATE_INCORRECTPRODUCTNAME),void this.sview.ShowLicenseStateInfo();if(!s.GetProductVersion())return this.SetCheckState(!1),this.SetCheckStateCode(S.READLICENSESTATE_FILECONTENTERROR),void this.sview.ShowLicenseStateInfo();if(0!==S.PRODUCTVERSION.indexOf(s.GetProductVersion()))return this.SetCheckState(!1),this.SetCheckStateCode(S.CHECKSTATE_INCORRECTVERSION),void this.sview.ShowLicenseStateInfo();Fingerprint2.getV18(function(e){var t=new XMLHttpRequest,r=S.KeyValueHelper.GetUriKeyValueStr("id",s.GetID())+"&"+S.KeyValueHelper.GetUriKeyValueStr("name",S.PRODUCTNAME)+"&"+S.KeyValueHelper.GetUriKeyValueStr("version",S.PRODUCTVERSION)+"&"+S.KeyValueHelper.GetUriKeyValueStr("state",a.GetRandomString())+"&"+S.KeyValueHelper.GetUriKeyValueStr("devices",e),i=s.GetServerAddress()+"/api/licence/access?"+r;t.open("POST",i,n),t.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),t.addEventListener("load",function(e){var t=e.target.response,r=JSON.parse(t);if("0"!==r.result)return a.SetCheckState(!1),a.SetCheckStateCode(S.CHECKSTATE_ACCESSFAILURE),void a.sview.ShowLicenseStateInfo();a.token=r.token,a.expries=r.expires,S.CookieHelper.AddCookie(S.LICENCETOKEN,a.GetEnString(r.token),Number(r.expires)/3600/24),o()},!1),t.addEventListener("error",function(e){a.SetCheckState(!1),a.SetCheckStateCode(S.CHECKSTATE_CONNECTSERVERFAILURE),a.sview.ShowLicenseStateInfo()},!1);try{t.send(null)}catch(e){return console.log(e.code+"\n"+e.message),a.SetCheckState(!1),a.SetCheckStateCode(S.CHECKSTATE_CONNECTSERVERFAILURE),void a.sview.ShowLicenseStateInfo()}})}},e.prototype.check=function(e,c){var d=this;this.access(e,function(){var h=d.sview.GetLicenseHelper();if(0===h.GetCheckLicenseType()){var e=S.CookieHelper.GetCookie(S.LICENCECONTEXT);if(e){d.GetDString(e,S.LICENCETOKENHASH);return c&&c(),d.sview.setOpenFileLicence(!0),d.sview.setMeasureLicence(!0),d.sview.setExplosiveLicence(!0),void d.sview.setAnimationLicence(!0)}Fingerprint2.getV18(function(e){if(null==d.token)return d.SetCheckState(!1),d.SetCheckStateCode(S.CHECKSTATE_TOKENERROR),void d.sview.ShowLicenseStateInfo();var t=S.KeyValueHelper.GetUriKeyValueStr("token",d.token)+"&"+S.KeyValueHelper.GetUriKeyValueStr("type",d.sview.GetLicenseHelper().GetLicenseType()[3])+"&"+S.KeyValueHelper.GetUriKeyValueStr("devices",e)+"&"+S.KeyValueHelper.GetUriKeyValueStr("users",d.licenceOption.userId)+"&"+S.KeyValueHelper.GetUriKeyValueStr("modules",d.GetDString(d.licenceOption.funcode,S.LICENCETOKENHASH))+"&"+S.KeyValueHelper.GetUriKeyValueStr("state",d.GetRandomString()),r=new XMLHttpRequest,i=h.GetServerAddress()+"/api/licence/check?"+t;r.open("POST",i,!0),r.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),r.addEventListener("load",function(e){var t=e.target.response;if(!t)return d.SetCheckState(!1),d.SetCheckStateCode(S.CHECKSTATE_LICENSEAUTHENTICATIONFAILURE),void d.sview.ShowLicenseStateInfo();var r=JSON.parse(t);if(r.result!==S.NETWORK_RESULT_0)return d.SetCheckState(!1),r.result===S.NETWORK_RESULT_2004?d.SetCheckStateCode(S.CHECKSTATE_NOAVAILABLEPOINTS):r.result===S.NETWORK_RESULT_2006?d.SetCheckStateCode(S.CHECKSTATE_UNEXISTEDAUTHENTICATIONINFO):r.result===S.NETWORK_RESULT_2007?d.SetCheckStateCode(S.CHECKSTATE_INCORRECTPRODUCTNAME):r.result===S.NETWORK_RESULT_2008?d.SetCheckStateCode(S.CHECKSTATE_INCORRECTVERSION):r.result===S.NETWORK_RESULT_2009?d.SetCheckStateCode(S.CHECKSTATE_TOKENEXPIRES):r.result===S.NETWORK_RESULT_2010?d.SetCheckStateCode(S.CHECKSTATE_LICENSENOTSTARTED):r.result===S.NETWORK_RESULT_2011?d.SetCheckStateCode(S.CHECKSTATE_LICENSEEXPIRED):r.result===S.NETWORK_RESULT_2012?d.SetCheckStateCode(S.CHECKSTATE_NOPERMISSION):r.result===S.NETWORK_RESULT_2013?d.SetCheckStateCode(S.CHECKSTATE_AUTHENTICATIONMODEMISMATCHED):r.result===S.NETWORK_RESULT_2014?d.SetCheckStateCode(S.CHECKSTATE_MACADDRASSMISMATCHED):r.result===S.NETWORK_RESULT_2017?d.SetCheckStateCode(S.CHECKSTATE_UNEXISTEDAUTHENTICATIONINFO):r.result===S.NETWORK_RESULT_2018?d.SetCheckStateCode(S.CHECKSTATE_LICENSERESCINDEDERROR):r.result===S.NETWORK_RESULT_2019?d.SetCheckStateCode(S.CHECKSTATE_PROHIBITIONAGAINST):r.result===S.NETWORK_RESULT_2020?d.SetCheckStateCode(S.CHECKSTATE_LICENSEAUTHENTICATIONFAILURE):r.result===S.NETWORK_RESULT_2021?d.SetCheckStateCode(S.CHECKSTATE_LICENSESIGNDISMATCHED):r.result===S.NETWORK_RESULT_2022?d.SetCheckStateCode(S.CHECKSTATE_TOKENERROR):r.result===S.NETWORK_RESULT_2023&&d.SetCheckStateCode(S.CHECKSTATE_TOKENERROR),void d.sview.ShowLicenseStateInfo();if(!r.context)return d.SetCheckState(!1),d.SetCheckStateCode(S.CHECKSTATE_LICENSEAUTHENTICATIONFAILURE),void d.sview.ShowLicenseStateInfo();var i=d.GetDString(r.context);S.CookieHelper.AddCookie(S.LICENCECONTEXT,d.GetEnString(i),Number(d.expries)/3600/24),d.SetCheckState(!0),d.SetCheckStateCode(S.CHECKSTATE_SUCCESS),c&&c(),d.sview.setOpenFileLicence(!0),d.sview.setMeasureLicence(!0),d.sview.setExplosiveLicence(!0),d.sview.setAnimationLicence(!0)},!1),r.addEventListener("error",function(e){d.SetCheckState(!1),d.SetCheckStateCode(S.CHECKSTATE_CONNECTSERVERFAILURE),d.sview.ShowLicenseStateInfo()},!1);try{r.send(null)}catch(e){return d.SetCheckState(!1),d.SetCheckStateCode(S.CHECKSTATE_CONNECTSERVERFAILURE),d.sview.ShowLicenseStateInfo(),void console.log(e.code+"\n"+e.message)}})}else if(2===h.GetCheckLicenseType()){var t="SViewLicense"+h.GetContentStr(),u=CryptoJS.MD5(t).toString(),r=h.GetSingCode();if(u!==r)return d.SetCheckState(!1),d.SetCheckStateCode(S.CHECKSTATE_LICENSESIGNDISMATCHED),void d.sview.ShowLicenseStateInfo();var i=function(){if("0"===p[2]){if(!h.GetBeginDate()||!h.GetEndDate())return d.SetCheckState(!1),d.SetCheckStateCode(S.READLICENSESTATE_FILECONTENTERROR),void d.sview.ShowLicenseStateInfo();var e=null,t=null;if("IE"===SView.BrowserHelper.myBrowser()){var r=h.GetBeginDate();r=r.replace(/-/g,"/");var i=h.GetBeginDate();i=i.replace(/-/g,"/"),e=new Date(r),t=new Date(i)}else e=new Date(h.GetBeginDate()),t=new Date(h.GetEndDate());var n=(t.getTime()-(new Date).getTime())/864e5,o=(e.getTime()-(new Date).getTime())/864e5;if(n<0)return d.SetCheckState(!1),d.SetCheckStateCode(S.CHECKSTATE_LICENSEEXPIRED),void d.sview.ShowLicenseStateInfo();if(0<o)return d.SetCheckState(!1),d.SetCheckStateCode(S.CHECKSTATE_LICENSENOTSTARTED),void d.sview.ShowLicenseStateInfo();c&&c(),d.SetCheckState(!0),d.SetCheckStateCode(S.CHECKSTATE_SUCCESS),d.sview.setOpenFileLicence(!0),d.sview.setMeasureLicence(!0),d.sview.setExplosiveLicence(!0),d.sview.setAnimationLicence(!0)}else if("1"===p[2]){var a=S.CookieHelper.GetCookie(S.LICENCESIGNCODE);if(a&&a===u){var s=S.CookieHelper.GetCookie(S.FIRSTOPENDATE),l=null;if(l=("IE"===SView.BrowserHelper.myBrowser()&&(s=s.replace(/-/g,"/")),new Date(s)),!(((new Date).getTime()-l.getTime())/864e5<=Number(h.GetTerm())))return d.SetCheckState(!1),d.SetCheckStateCode(S.CHECKSTATE_LICENSEEXPIRED),void d.sview.ShowLicenseStateInfo();c&&c(),d.SetCheckState(!0),d.SetCheckStateCode(S.CHECKSTATE_SUCCESS),d.sview.setOpenFileLicence(!0),d.sview.setMeasureLicence(!0),d.sview.setExplosiveLicence(!0),d.sview.setAnimationLicence(!0)}else S.CookieHelper.AddCookie(S.LICENCESIGNCODE,u,1e6),S.CookieHelper.AddCookie(S.FIRSTOPENDATE,new Date,1e6),d.SetCheckState(!0),d.SetCheckStateCode(S.CHECKSTATE_SUCCESS),c&&c(),d.sview.setOpenFileLicence(!0),d.sview.setMeasureLicence(!0),d.sview.setExplosiveLicence(!0),d.sview.setAnimationLicence(!0)}else"2"===p[2]&&(c&&c(),d.SetCheckState(!0),d.SetCheckStateCode(S.CHECKSTATE_SUCCESS),d.sview.setOpenFileLicence(!0),d.sview.setMeasureLicence(!0),d.sview.setExplosiveLicence(!0),d.sview.setAnimationLicence(!0))};if(!h.GetID())return d.SetCheckState(!1),d.SetCheckStateCode(S.READLICENSESTATE_FILECONTENTERROR),void d.sview.ShowLicenseStateInfo();if(!h.GetProductName())return d.SetCheckState(!1),d.SetCheckStateCode(S.READLICENSESTATE_FILECONTENTERROR),void d.sview.ShowLicenseStateInfo();if(h.GetProductName()!==S.PRODUCTNAME)return d.SetCheckState(!1),d.SetCheckStateCode(S.CHECKSTATE_INCORRECTPRODUCTNAME),void d.sview.ShowLicenseStateInfo();if(!h.GetProductVersion())return d.SetCheckState(!1),d.SetCheckStateCode(S.READLICENSESTATE_FILECONTENTERROR),void d.sview.ShowLicenseStateInfo();if(0!==S.PRODUCTVERSION.indexOf(h.GetProductVersion()))return d.SetCheckState(!1),d.SetCheckStateCode(S.CHECKSTATE_INCORRECTVERSION),void d.sview.ShowLicenseStateInfo();var p=h.GetLicenseType();if("0"===p[3]||"2"===p[3])h.GetDevices()?Fingerprint2.getV18(function(e){var t=h.GetDevices(),r=[];if(0<=t.indexOf(",")?r=t.split(","):r.push(t),-1===r.indexOf(e))return d.SetCheckState(!1),d.SetCheckStateCode(S.CHECKSTATE_MACADDRASSMISMATCHED),void d.sview.ShowLicenseStateInfo();i()}):i();else if("1"===p[3]||"3"===p[3])if(h.GetUsers()){var n=h.GetUsers(),o=[];if(0<=n.indexOf(",")?o=n.split(","):o.push(n),o.indexOf(d.licenceOption.userId)<0)return d.SetCheckState(!1),d.SetCheckStateCode(S.CHECKSTATE_INCORRECTUSER),void d.sview.ShowLicenseStateInfo();i()}else i()}else{if(!(0<(new Date(this.sview.atou("MjAxOCUyNTJGMTIlMjUyRjMx")).getTime()-(new Date).getTime())/864e5))return d.SetCheckState(!1),d.SetCheckStateCode(S.CHECKSTATE_LICENSEEXPIRED),void d.sview.ShowLicenseStateInfo();c&&c(),d.sview.setOpenFileLicence(!0),d.sview.setMeasureLicence(!0),d.sview.setExplosiveLicence(!0),d.sview.setAnimationLicence(!0)}})},e.prototype.info=function(o){var a=this;if(2===this.sview.GetLicenseHelper().GetCheckLicenseType()){var e=this.sview.GetLicenseHelper().Copy();if("1"===e.GetLicenseType()[2]){var t=S.CookieHelper.GetCookie(S.FIRSTOPENDATE),r=null;r=("IE"===SView.BrowserHelper.myBrowser()&&(t=t.replace(/-/g,"/")),new Date(t));var i=e.GetTerm(),n=new Date(r.getTime()+24*Number(i)*60*60*1e3),s=n.getFullYear()+"-"+(n.getMonth()+1)+"-"+n.getDate();e.SetEndDate(s),o(e)}else"2"===e.GetLicenseType()[2]?e.SetEndDate("不限期"):0<=e.GetEndDate().indexOf(" ")&&e.SetEndDate(e.GetEndDate().split(" ")[0]),o(e)}else{var l=function(){Fingerprint2.getV18(function(e){var t=a.sview.GetLicenseHelper(),r=new XMLHttpRequest,i=S.KeyValueHelper.GetUriKeyValueStr("token",a.token)+"&"+S.KeyValueHelper.GetUriKeyValueStr("names","all")+"&"+S.KeyValueHelper.GetUriKeyValueStr("state",a.GetRandomString())+"&"+S.KeyValueHelper.GetUriKeyValueStr("devices",e),n=t.GetServerAddress()+"/api/licence/info?"+i;r.open("POST",n,!0),r.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),r.addEventListener("load",function(e){var t=e.target.response,r=JSON.parse(t);if("0"===r.result){var i=JSON.parse(r.context),n=new S.LicenseHelper;n.SetProductName(i.ProductName),n.SetProductVersion(i.ProductVersion),n.SetBeginDate(i.BeginDate),n.SetEndDate(i.EndDate),n.SetCopyRight(i.CopyRight),n.SetCreateDate(i.CreateDate),n.SetCreator(i.Creator),n.SetCustomer(i.Customer),n.SetCustomerEmail(i.CustomerEmail),n.SetID(i.ID),n.SetLicenseType(i.LicenseType),n.SetSeat(i.Seat),n.SetModules(i.Modules),n.SetTerm(i.Term),o(n)}else o(null)},!1),r.addEventListener("error",function(e){o(null)},!1);try{r.send(null)}catch(e){return console.log(e.code+"\n"+e.message),void o(null)}})};if(null==a.token)return void this.access(!0,l);l()}},e.prototype.GetDString=function(e,t){var r=CryptoJS.enc.Utf8.parse(CryptoJS.MD5(t||this.GetRandomString()).toString()),i=CryptoJS.enc.Utf8.parse(CryptoJS.MD5(t||this.GetRandomString()).toString().substring(0,16));return CryptoJS.AES.decrypt(e,r,{iv:i,mode:CryptoJS.mode.CBC,padding:CryptoJS.pad.Pkcs7}).toString(CryptoJS.enc.Utf8)},e.prototype.GetEnString=function(e){var t=CryptoJS.enc.Utf8.parse(CryptoJS.MD5(S.LICENCETOKENHASH).toString()),r=CryptoJS.enc.Utf8.parse(CryptoJS.MD5(S.LICENCETOKENHASH).toString().substring(0,16));return CryptoJS.AES.encrypt(e,t,{iv:r,mode:CryptoJS.mode.CBC,padding:CryptoJS.pad.Pkcs7}).toString()},e.prototype.GetRandomString=function(e){if(this.random)return this.random;e=e||8;for(var t="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678oOLl9gqVvUuI1",r=t.length,i="",n=0;n<e;n++)i+=t.charAt(Math.floor(Math.random()*r));return this.random=i,this.random},e.prototype.GetCheckState=function(){return this.checkState},e.prototype.SetCheckState=function(e){return this.checkState},e.prototype.GetCheckStateCode=function(){return this.checkStateCode},e.prototype.SetCheckStateCode=function(e){this.checkStateCode=e},e}();S.LicenseTools=e}(M3D||(M3D={})),function(i){i.LOGE=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t]},i.LOGI=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];console.log(e)};var e=function(){function r(){this.level=r.ERROR,this.onError=function(e,t){console.error("Error:"+e+t)},this.onWarning=function(e,t){console.warn("Warning:"+e+t)},this.onDebug=function(e,t){console.debug("Debug:"+e+t)},this.onInfo=function(e,t){console.info("Info:"+e+t)}}return r.prototype.SetLevel=function(e){this.level=e},r.prototype.Debug=function(e,t){this.level<=r.DEBUG&&i.IsObjectExist(this.onDebug)&&this.onDebug(e,t)},r.prototype.Info=function(e,t){this.level<=r.INFO&&i.IsObjectExist(this.onInfo)&&this.onInfo(e,t)},r.prototype.Error=function(e,t){i.IsObjectExist(this.onError)&&this.onError(e,t)},r.prototype.Warning=function(e,t){i.IsObjectExist(this.onWarning)&&this.onWarning(e,t)},r.DEBUG=3,r.ERROR=1,r.INFO=2,r}();i.Logger=e,i.Log=null}(M3D||(M3D={})),function(e){var t=function(){function e(){}return e.RotationSlerp=function(e,t,r,i){for(var n=e,o=t,a=0;a<r-1;a++){var s=n.Slerp(o,1*a/r);i[a]=s}return i[r-1]=t.Clone(),!0},e.VecSlerp=function(e,t,r,i){for(var n=0;n<r-1;n++)i[n]=e.Add(t.Sub(e).MultiplyED(1*n/r));return i[r-1]=t.Clone(),!0},e.VecSlerp1=function(e,t,r,i){for(var n=0;n<r;n++)i[n]=e.Add(t.Sub(e).MultiplyED(1*n/(r-1)));return!0},e.FloatSlerp=function(e,t,r,i){for(var n=0;n<r-1;n++)i[n]=e+(t-e)*n/r;return i[r-1]=t,!0},e.Random=function(e,t){return Math.random()*(t-e)+e},e.VersionCompare=function(e,t){var r=0;if(e===t)r=0;else{var i=Number(e),n=Number(t);1e-5<i-n?r=1:i-n<-1e-5&&(r=-1)}return r},e}();e.M3DTOOLS=t}(M3D||(M3D={})),function(e){var t=function(){function e(){this.elements=[]}return e.prototype.Size=function(){return this.elements.length},e.prototype.Clear=function(){this.elements.length=0},e.prototype.IsEmperty=function(){return this.elements.length<1},e.prototype.ContainKey=function(e){for(var t=!1,r=0;r<this.elements.length;r++)this.elements[r].key===e&&(t=!0);return t},e.prototype.ContainValue=function(e){for(var t=!1,r=0;r<this.elements.length;r++)this.elements[r].value===e&&(t=!0);return t},e.prototype.Find=function(e){for(var t=-1,r=0;r<this.elements.length;r++)this.elements[r].key===e&&(!0,t=r);return t},e.prototype.Put=function(e,t){!0===this.ContainKey(e)&&this.Get(e)!=t?!0===this.Remove(e)&&this.elements.push({key:e,value:t}):this.elements.push({key:e,value:t})},e.prototype.Remove=function(e){for(var t=0;t<this.elements.length;t++)if(this.elements[t].key===e)return this.elements.splice(t,1),!0;return!1},e.prototype.Get=function(e){for(var t=0;t<this.elements.length;t++)if(this.elements[t].key===e)return this.elements[t].value;return null},e.prototype.Element=function(e){return e<0||e>=this.elements.length?null:this.elements[e]},e.prototype.Keys=function(){for(var e=new Array,t=0;t<this.elements.length;t++)e.push(this.elements[t].key);return e},e.prototype.Values=function(){for(var e=new Array,t=0;t<this.elements.length;t++)e.push(this.elements[t].value);return e},e}();e.Map=t}(M3D||(M3D={})),function(p){var e=function(){function e(){}return e.ReadSingleModel=function(e,t,o){var a=!1,s=null,r=p.FileHelper.GetUnionStylePath(e),l=p.Reader.GetReader(r)[0];r="res/model/"+r.split(".")[0]+".zip";var h=new XMLHttpRequest;h.open("GET",r,!0),h.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),h.responseType="arraybuffer",h.onreadystatechange=function(){if(4===h.readyState&&200===h.status){var e,t=h.response,r=new JSZip(t);e=new RegExp(".*.stl$","i");var i=r.file(e);s=l.ReadFile(i[0].asBinary());var n=new p.ReadListener;l.AddListener(n),n.onReadEnd=function(e){(s=e.GetModel())&&(s,a=!0),e&&(e=null),o(a,s)}}},h.onerror=function(e){console.log("error")},h.send(null)},e.GetUVArrayByPositionArrayTest1=function(e,t){for(var r=new p.Vector3,i=new p.Vector3,n=0;n<e.length;n+=3){(h=new p.Vector3).x=e[n],h.y=e[n+1],h.z=e[n+2],r.x>h.x&&(r.x=h.x),r.y>h.y&&(r.y=h.y),i.x<h.x&&(i.x=h.x),i.y<h.y&&(i.y=h.y),r.z>h.z&&(r.z=h.z),i.z<h.z&&(i.z=h.z)}var o=i.x-r.x,a=i.y-r.y,s=i.z-r.z,l=[];for(n=0;n<e.length;n+=3){var h,u=new p.Vector3;if((h=new p.Vector3).x=e[n],h.y=e[n+1],h.z=e[n+2],u.x=(h.x-r.x)/o,u.y=(h.y-r.y)/a,u.z=(h.z-r.z)/s,t)switch(t){case"x":l.push(u.y),l.push(u.z),l.push(0);break;case"y":l.push(u.x),l.push(u.z),l.push(0);break;default:l.push(u.x),l.push(u.y),l.push(0)}else l.push(u.x),l.push(u.y),l.push(u.z)}return l},e.GetUVArrayByPositionArray=function(e,t,r){new p.Vector3,new p.Vector3;for(var i=t.GetXLength(),n=t.GetYLength(),o=t.GetZLength(),a=[],s=0;s<e.length;s+=3){var l=new p.Vector3,h=new p.Vector3,u=new p.Vector3;u.x=r[s],u.y=r[s+1],u.z=r[s+2],(u=u.Abs()).Normalize(),h.x=e[s],h.y=e[s+1],h.z=e[s+2],.57735<u.z?(l.x=(h.x-t.min.x)/i,l.y=(h.y-t.min.y)/n):.57735<u.y?(l.x=(h.x-t.min.x)/i,l.y=(h.z-t.min.z)/o):.57735<u.x?(l.x=(h.y-t.min.y)/n,l.y=(h.z-t.min.z)/o):(l.x=(h.x-t.min.x)/i,l.y=(h.y-t.min.y)/n),l.z=0,a.push(l.x),a.push(l.y),a.push(0)}return a},e.CalculateAirVol=function(e,t,r,i,n){var o=t.x-e.x,a=t.y-e.y,s=t.z-e.z,l=r.x-e.x,h=r.y-e.y,u=r.z-e.z,p=a*u-s*h,c=s*l-o*u,d=o*h-a*l;return i=Math.sqrt(p*p+c*c+d*d)/2,o=t.x-e.x,a=t.y-e.y,l=r.x-e.x,[i,(o*(h=r.y-e.y)-a*l)*(e.z+t.z+r.z)/6]},e}();p.MeshHelper=e}(M3D||(M3D={})),function(e){var t=function(){function t(){}return t.GetSVLPath=function(e){return t.M3DPathToSVLPath(t.GetM3DPath(e))},t.GetM3DPath=function(e){return e&&e.GetSceneNode()&&e.GetSceneNode().GetParent()?e.GetSceneNode().GetParent().GetName():""},t.M3DPathToSVLPath=function(e){return null!=e&&e.length>t.M3D_PATH_PRE.length+1?e.substr(t.M3D_PATH_PRE.length,e.length):""},t.SVLPathToM3D=function(e){return 0<e.indexOf(t.M3D_PATH_PRE)?e:t.M3D_PATH_PRE+e},t.SVLPathDecToHex=function(e){for(var t=e.split("|"),r=["PATH"],i=1;i<t.length;i++){var n=Number(t[i]);r.push(n.toString(16))}return r.join("|")},t.SVLPathHexToDec=function(e){for(var t=e.split("|"),r=["PATH"],i=1;i<t.length;i++)r.push(parseInt(t[i],16).toString());return r.join("|")},t.M3D_PATH_PRE="M3D|MAIN|",t}();e.PathHelper=t}(M3D||(M3D={})),function(u){var e=function(){function h(){}return h.SelectShape=function(e,t,r,i){var n=null;if(t===u.ShapeType.SHAPE_COORDINATE){var o=new u.Vector3;i.GetPickPoint(e,o,!0)&&(n=this.AddPointHandler(o,1,i))}else if(t===u.ShapeType.SHAPE_FEATURE_COORDINATE){var a=new u.Vector3;u.RayPickAction.PickFeaturePnt(e,i,a)&&(n=this.AddPointHandler(a,1,i))}else n=i.GetPickShape(e,t,r);return n},h.AddPointHandler=function(e,t,r){var i=null,n=r.GetHandlerGroup();if(null!==n){r.GetSceneBox();i=n.CreatePointHandler(e,t,3,r)}return r.AddShapeIDToMap(i),i},h.GetCommonSize=function(e,t){var r=100,i=100,n=h.getDPI()[0],o=e.GetCamera().GetViewPort().GetRect().Width(),a=e.GetCamera().GetViewPort().GetRect().Height();if(e){var s=e.GetCamera(),l=s.GetAspectRatio();i=s.orthoSize,1<l?(r=i*l,o=a):r=i}return r/=o/(2.5*n)*20,new u.Vector2(r*t.x,r*t.y)},h.GetShapeWorldMatrix=function(e){var t=new u.Matrix3x4;if(!e)return t;if(e.GetType()==u.ShapeType.SHAPE_EDGE){var r=e;null!=r.GetBody()?t=r.GetBody().GetModel().GetWorldTransform().ToMatrix3x4():null!=r.GetFace()&&(t=r.GetFace().GetBody().GetModel().GetWorldTransform().ToMatrix3x4())}else if(e.GetType()==u.ShapeType.SHAPE_FACE){t=e.GetBody().GetModel().GetWorldTransform().ToMatrix3x4()}else if(e.GetType()==u.ShapeType.SHAPE_BODY){t=e.GetModel().GetWorldTransform().ToMatrix3x4()}else if(e.GetType()==u.ShapeType.SHAPE_MODEL){t=e.GetWorldTransform().ToMatrix3x4()}return t},h.getDPI=function(){var e=new Array;if(window.screen.deviceXDPI)e[0]=window.screen.deviceXDPI,e[1]=window.screen.deviceYDPI;else{var t=document.createElement("DIV");t.style.cssText="width:1in;height:1in;position:absolute;left:0px;top:0px;z-index:99;visibility:hidden",document.body.appendChild(t),e[0]=parseInt(t.offsetWidth+""),e[1]=parseInt(t.offsetHeight+""),t.parentNode.removeChild(t)}return e},h}();u.ShapeHelper=e}(M3D||(M3D={})),function(e){var t=function(){function e(){}return e.CreateTexture2D=function(e,t){var r=new Image;r.src=t.imagePath;var i=e.createTexture();return e.bindTexture(e.TEXTURE_2D,i),e.texImage2D(e.TEXTURE_2D,0,t.internalrFromat,t.format,e.UNSIGNED_BYTE,r),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,t.filterMag),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,t.filterMin),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,t.wrapS),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,t.wrapT),e.bindTexture(e.TEXTURE_2D,null),i},e}();e.TextureCreator=t}(M3D||(M3D={})),function(s){var e=function(){function i(){this.axis=s.Vector3.UP().Clone(),this.mvMatrix=new s.ControlInfo,this.mvPriMatrix=new s.ControlInfo,this.priPointOne=new s.Vector2,this.priPointOneScale=new s.Vector2,this.priPointOneScaleCenter=new s.Vector2,this.priPointOneMove=new s.Vector2,this.priPointTwo1=new s.Vector2,this.priPointTwo2=new s.Vector2,this.pirDistance=1,this.currDistance=1,this.priRotationCenter=s.Vector3.ZERO().Clone(),this.rotationAxis=s.Vector3.ZERO().Clone(),this.cachePriPoint=s.Vector3.ZERO().Clone(),this.cacheCurPointNear=s.Vector3.ZERO().Clone(),this.cacheCurPointFar=s.Vector3.ZERO().Clone(),this.cacheCentPoint=s.Vector3.ZERO().Clone(),this.startPos=s.Vector3.ZERO().Clone(),this.stopPos=s.Vector3.ZERO().Clone(),this.iWidth=400,this.iHeight=400,this.iCenterX=200,this.iCenterY=200,this.iRadius=200,this.iMouseX=200,this.iMouseY=200,this.start=s.Vector3.ZERO().Clone(),this.stop=s.Vector3.ZERO().Clone(),this.scalerChanged=!0,this.screenDepth=.5,this.rotateSpeed=1.5,this.cp=0,this.cy=0,this.lastQuat=s.Quaternion.IDENTITY().Clone(),this.rolateAngle=s.Vector3.ZERO().Clone(),this.moveDelta=new s.Vector2,this.lastPos=new s.Vector2}return i.prototype.Tracking=function(e,t,r){var i;if(Math.abs(e)<1&&Math.abs(t)<1)return 0;this.stop=this.ScreenToVector(this.iWidth/2+e,this.iHeight/2+t),r.copyFrom(this.start.CrossProduct(this.stop)),r.Normalize();return(i=this.rotateSpeed*Math.acos(this.start.DotProduct(this.stop))/3.14159*180)<.01&&(i=.01),this.start=this.stop.Clone(),i},i.prototype.ScreenToVector=function(e,t){var r=new s.Vector3(0,0,0);this.iCenterX>=this.iWidth/2?r.x=(e-this.iCenterX)/this.iCenterX:r.x=(e-this.iCenterX)/(this.iWidth-this.iCenterX),this.iCenterY>=this.iHeight/2?r.y=(this.iCenterY-t)/this.iCenterY:r.y=(this.iCenterY-t)/(this.iHeight-this.iCenterY);var i=Math.sqrt(r.x*r.x+r.y*r.y);return r.z=Math.cos(1.570796325*(i<1?i:1)),r.Normalize(),r},i.prototype.TwoPointsDis=function(e,t){void 0===t&&(t=2);var r=e[0]-e[2],i=e[1]-e[3];return Math.sqrt(r*r+i*i)},i.prototype.TwoPointsTrackingAngle=function(e,t){void 0===t&&(t=2);var r=Math.atan2(this.priPointTwo1.y-this.priPointTwo2.y,this.priPointTwo1.x-this.priPointTwo2.x),i=e[0]-e[t],n=e[1]-e[t+1];return(r-Math.atan2(n,i))/3.14159*360},i.prototype.ScreenToDepthVector=function(e){var t=s.Vector3.ZERO().Clone();if(null!=this.pSceneManager){var r=this.pSceneManager.GetCamera();t=r.GetView().Multiply(r.GetViewPort().ScreenToWorldPoint(e.x,e.y,this.screenDepth))}return t},i.prototype.AdjustScaleToMoveVector=function(e){if(null!=this.pSceneManager){var t=this.pSceneManager.GetCamera(),r=this.mvMatrix.scaleFactor;if(!t.IsOrthographic()&&.01<Math.abs(r-1)){var i=t.GetViewPort().ScreenToWorldPoint(e.x,e.y,this.screenDepth),n=t.GetPosition(),o=t.GetRotateCenter(),a=1;a=n.Sub(o).Length()>.01*this.pSceneManager.GetSceneBox().Length()?.1*n.Sub(o).Length()*r*(1<r?-1:1):.01*this.pSceneManager.GetSceneBox().Length()*r*(1<r?-1:1),this.mvMatrix.moveVector=i.Sub(n).Normalized().Multiply(a),t.SetWorldPosition(n.Add(this.mvMatrix.moveVector)),this.mvMatrix.moveVector=s.Vector3.ZERO().Clone(),this.mvMatrix.scaleFactor=1}}},i.prototype.Reset=function(){this.mvMatrix.ReSet(),this.isMoving=!1,i.ISMOVING=!1,i.ISROTATING=!1,i.MOVESTATE=-1,i.KEEPINGSTATETIMES=i.TIMES,i.drawLimit=0,this.scalerChanged=!0,this.angle=0,this.axis=new s.Vector3(0,0,1),this.moveDelta=s.Vector2.ZERO(),this.lastPos=s.Vector2.ZERO()},i.prototype.OnePointUp=function(e,t){this.Reset()},i.prototype.TwoPointsUp=function(e,t){this.Reset()},i.prototype.OnePointStart=function(e,t){void 0===t&&(t=1),this.priPointOne.x=e[0],this.priPointOne.y=e[1],this.priPointOneScale=this.priPointOne.Clone(),this.priPointOneScaleCenter=this.priPointOne.Clone(),null!==this.pSceneManager&&(this.cachePriPoint=this.ScreenToDepthVector(this.priPointOne)),this.priPointOneMove=this.priPointOne.Clone(),this.moveDelta=s.Vector2.ZERO(),this.lastPos=new s.Vector2(e[0],e[1])},i.prototype.TwoPointsStart=function(e,t){void 0===t&&(t=2),this.priPointTwo1.x=e[0],this.priPointTwo1.y=e[1],this.priPointTwo2.x=e[2],this.priPointTwo2.y=e[3];var r=this.priPointTwo1.Add(this.priPointTwo2).MultiplyED(.5);this.pirDistance=this.TwoPointsDis(e);var i=this.pSceneManager.GetCamera();if(!i.IsOrthographic()){var n=new s.Vector3,o=new s.Vector2(r.x,r.y);this.pSceneManager.GetPickPoint(o,n,!1),this.pSceneManager.SetRotationCenter(n)}this.screenDepth=i.GetFitClip(),this.cachePriPoint=this.ScreenToDepthVector(r)},i.prototype.OnePointRotate=function(e,t){void 0===t&&(t=1),this.start=this.ScreenToVector(this.iWidth/2,this.iHeight/2),this.angle=this.Tracking(e[0]-this.priPointOne.x,e[1]-this.priPointOne.y,this.axis),.01<Math.abs(this.angle)&&(i.ISMOVING=!0,i.ISROTATING=!0,i.MOVESTATE=0,i.KEEPINGSTATETIMES=i.TIMES,this.mvMatrix.rotation.FromAngleAxis(this.angle,this.axis)),this.priPointOne.x=e[0],this.priPointOne.y=e[1];var r=new s.Vector2(e[0],e[1]);this.moveDelta=this.lastPos.Sub(r),this.lastPos=r},i.prototype.OnePointsMove=function(e,t){void 0===t&&(t=1);var r=new s.Vector2(e[0],e[1]);if(4<this.priPointOneScale.Sub(r).LengthSquared()){if(null!==this.pSceneManager){i.ISMOVING=!0,i.KEEPINGSTATETIMES=i.TIMES,i.MOVESTATE=1;this.pSceneManager.GetCamera();this.cacheCurPointNear=this.ScreenToDepthVector(r),this.cachePriPoint=this.ScreenToDepthVector(this.priPointOneScale),this.mvMatrix.moveVector=this.cacheCurPointNear.Sub(this.cachePriPoint),this.cachePriPoint.copyFrom(this.cacheCurPointNear)}this.priPointOneScale.copyFrom(r)}else this.mvMatrix.moveVector=s.Vector3.ZERO().Clone(),this.mvMatrix.rotation=s.Quaternion.IDENTITY().Clone(),this.mvMatrix.scaleFactor=1},i.prototype.OnePointsScale=function(e,t){if(void 0===t&&(t=1),1<Math.abs(this.priPointOneScale.y-e[1])){if(null!==this.pSceneManager){i.ISMOVING=!0,i.MOVESTATE=2,i.KEEPINGSTATETIMES=i.TIMES;var r=this.pSceneManager.GetCamera().GetViewPort().rect;this.cacheCurPointNear,this.ScreenToDepthVector(this.priPointOneScaleCenter),this.mvMatrix.scaleFactor=(r.bottom-this.priPointOneScale.y)/(r.bottom-e[1]),this.mvMatrix.moveVector=this.cacheCurPointNear.Sub(this.cachePriPoint),this.cachePriPoint=this.cacheCurPointNear.Clone()}}else this.mvMatrix.moveVector=s.Vector3.ZERO().Clone(),this.mvMatrix.rotation=s.Quaternion.IDENTITY().Clone(),this.mvMatrix.scaleFactor=1;this.priPointOneScale.x=e[0],this.priPointOneScale.y=e[1]},i.prototype.TwoPointsMove=function(e,t){if(void 0===t&&(t=2),this.currDistance=this.TwoPointsDis(e),this.mvMatrix.scaleFactor=this.pirDistance/this.currDistance,this.mvMatrix.moveVector=s.Vector3.ZERO().Clone(),this.mvMatrix.rotation=s.Quaternion.IDENTITY().Clone(),(.1<Math.abs(this.priPointTwo1.x-e[0])||.1<Math.abs(this.priPointTwo1.y-e[1])||.1<Math.abs(this.priPointTwo2.x-e[2])||.1<Math.abs(this.priPointTwo2.y-e[3]))&&null!==this.pSceneManager){i.ISMOVING=!0,i.KEEPINGSTATETIMES=i.TIMES;this.pSceneManager.GetCamera().GetViewPort().rect;var r=new s.Vector2((e[0]+e[2])/2,(e[1]+e[3])/2);this.cacheCurPointNear=this.ScreenToDepthVector(r),this.mvMatrix.moveVector=this.cacheCurPointNear.Sub(this.cachePriPoint),this.AdjustScaleToMoveVector(r),this.cachePriPoint=this.cacheCurPointNear.Clone(),i.ISMOVING=!0,i.ISROTATING=!0}this.pirDistance=this.currDistance,this.priPointTwo1.x=e[0]-.1,this.priPointTwo1.y=e[1]-.1,this.priPointTwo2.x=e[2]-.1,this.priPointTwo2.y=e[3]-.1},i.prototype.SetTrackWindow=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];2===e.length?(this.iWidth=e[0],this.iHeight=e[1],this.iCenterX=this.iWidth/2,this.iCenterY=this.iHeight/2):(this.iWidth=e[0],this.iHeight=e[1],this.iCenterX=e[2],this.iCenterY=e[3]),this.iRadius=this.iWidth>this.iHeight?this.iCenterY:this.iCenterX},i.prototype.SetSceneManager=function(e){this.pSceneManager=e},i.prototype.SetRotateSpeed=function(e){this.rotateSpeed=e},i.prototype.GetRotateSpeed=function(){return this.rotateSpeed},i.prototype.GetMoveDelta=function(){return this.moveDelta},i.ISROTATING=!1,i.MOVESTATE=-1,i.KEEPINGSTATETIMES=i.TIMES=10,i.CURRENTMODELSIZE=1e3,i.ISMOVING=!1,i.drawLimit=0,i}();s.Trackball=e}(M3D||(M3D={})),function(e){var t=function(){function e(){}return e.Supported=function(){return void 0!==Worker},e.BuildBridgedWorker=function(e,t,r,i){return function(e,t,r,i){var n=e.toString().match(/^\s*function\s*\(\s*\)\s*\{(([\s\S](?!\}$))*[\s\S])/)[1],o=[];o.push("var main = {};\n");for(var a=0;a<r.length;a++){var s=r[a];"*"==s.charAt(s.length-1)?(s=s.substr(0,s.length-1),r[a]=s,o.push("main."+s+" = function(/* arguments */){\n var args = Array.prototype.slice.call(arguments); var buffers = args.pop(); \n self.postMessage({foo:'"+s+"', args:args},buffers)\n}; \n")):o.push("main."+s+" = function(/* arguments */){\n var args = Array.prototype.slice.call(arguments); \n self.postMessage({foo:'"+s+"', args:args})\n}; \n")}for(var l=[],a=0;a<t.length;a++){var s=t[a];s="*"==s.charAt(s.length-1)?s.substr(0,s.length-1):s,l.push(s+": "+s)}o.push("var foos={"+l.join(",")+"};\n"),o.push("self.onmessage = function(e){\n"),o.push("if(e.data.foo in foos) \n  foos[e.data.foo].apply(null, e.data.args); \n else \n throw(new Error('Main thread requested function ' + e.data.foo + '. But it is not available.'));\n"),o.push("\n};\n");var h=n+"\n\n/*==== STUFF ADDED BY BuildBridgeWorker ==== */\n\n"+o.join(""),u=window.URL.createObjectURL(new Blob([h],{type:"text/javascript"})),p=new Worker(u);p.onmessage=function(e){var t=r.indexOf(e.data.foo);if(-1==t)throw new Error("Worker requested function "+e.data.foo+". But it is not available.");i[t].apply(null,e.data.args)};for(var c={blobURL:u},d=function(r,e){return e?function(){var e=Array.prototype.slice.call(arguments),t=e.pop();p.postMessage({foo:r,args:e},t)}:function(){var e=Array.prototype.slice.call(arguments);p.postMessage({foo:r,args:e})}},a=0;a<t.length;a++){var s=t[a];"*"==s.charAt(s.length-1)?(s=s.substr(0,s.length-1),c[s]=d(s,!0)):c[s]=d(s,!1)}return c}(e,t,r,i)},e}();e.WorkerHelper=t}(M3D||(M3D={})),function(i){var e=function(){function r(){this.IsConRotate=!1,this.RemoveSize=10,this.RemoveMode=1,this.selectedStyle=1,this.measureUnitStyle=1,this.isFullScreenExpand=!0,this.m_defaultViewType=6,this.m_upDirectionValue=i.Vector3.UP(),this.m_fieldSize=90,this.ModelSelectedColor=new i.Color(1,0,0),this.isProgressiveDisplay=!0,this.isMergeFace=!1,this.isIgnoreEdge=!1,this.ignoreRestoreAnimation=!1,this.useBodyObject=!0,this.genetateTexCood=!1,this.m_useSSAO=!1,this.m_useGroundGrid=!1,this.m_shadowMapEnabled=!1,this.m_doubleSided=!1,this.m_gammaFactor=2.2,this.m_shadowMapType=1,this.m_toneMappingExposure=1,this.g_LumInfluence=.7,this.g_SSAOContrast=3,this.g_SSAO_Bias=.1,this.g_Displace=.2,this.g_Aear=4,this.g_aoClamp=.24,this.g_radius=4,this.IBLFactor=[1],this.metellic=.35,this.roughness=.75,this.shadowBias=5e-5,this.refeshUpDirection=!1,this.m_BackTransparent=!1,this.IsShowTrilateralEdge=!1,this.IsOnlyShowTrilateralEdge=!1,this.IsShowTransparent=!1,this.Alpha=.5,this.IsMulSelect=!1,this.IsShowBox=!1,this.BoxColor=new i.Color(0,0,1,1),this.DefaultNoteColornew=new i.Color(0,0,0,0),this.SelectedColor=new i.Color(1,0,0,1),this.IsShowPMIs=!0,this.DefaultZoomFactor=2,this.showSection=!1,this.OptimizeBigModel=!1,this.clipPlaneMode=0,this.isShowAniTrochoid=!1,this.useBackGroundImage=!1,this.hotSpotImageSize=1.5,this.IsShowSHotSpot=!0,this.m_bShowSceneBoxNote=!1,this.isSpecifiedRotation=!0,this.useSimplePath=!1,this.m_internationalLanguage=0,this.dynamicSetDraggerPercentage=!1,this.draggerPercentage=.8,this.m_annotationDisplayColor=new i.Color(0,0,0,1),this.m_annotationUser="",this.m_annotationDepartment="",this.m_annotationCharacter="",this.waterMarkResolution=new i.Vector2(144,90),this.waterMarkDrawRect=new i.Vector2(1600,1e3),this.waterMarkFontSize="20",this.waterMarkRotation=30,this.waterMarkStr="SView",this.useWaterMark=!0,this.canRotation=!0,this.onMouseWheel=!0,this.noteHiddenLine=!1,this.canPickModel=!1,this.IsShowAxis=!0,this.IsShowFPS=!1,this.IsNoteFrontDisplay=!1,this.IsUseVBO=!1,this.IsTouchRotation=!1,this.OpenGLESVersion=2,this.IsHighPerformanceView=!1,this.IsUseAnimationCamera=!1,this.IsUseCatiaMode=!1,this.IsUseIndexMode=!0,this.IsUseBoxMoving=!1,this.NeverSeeScreenPixelSize=5,this.camera3dMode=0,this.useCubeMapping=!1,this.simplityMode=!1,this.bufferType=1,this.foucsScalFactor=.5,this.m_isShowSpacePoint=!0,this.m_fMouseSensitivity=.1,this.LicenceType=0}return r.Instance=function(){return null==r.instance&&((r.instance=new r).screenPPI=i.ShapeHelper.getDPI()[0]),r.instance},r.prototype.SetParameter=function(e,t){r.Instance()[e]instanceof i.Color?r.Instance()[e]=SView.BrowserHelper.JSONToObject(t,new i.Color):r.Instance()[e]instanceof i.Vector2?r.Instance()[e]=SView.BrowserHelper.JSONToObject(t,new i.Vector2):"boolean"==typeof r.Instance()[e]?r.Instance()[e]=t:"number"==typeof r.Instance()[e]?r.Instance()[e]=t:"string"==typeof r.Instance()[e]&&(r.Instance()[e]=t+"")},r.prototype.GetParamter=function(e){return r.Instance()[e]},r.instance=null,r}();i.Parameters=e}(M3D||(M3D={})),function(S){var e=function(){function e(e){this.selectorListeners=[],this.selectList=[],this.scene=null,this.scene=e}return e.prototype.Set=function(e){this.Clear(),this.Add(e)},e.prototype.Add=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(e[0]instanceof S.Shape){var r=e[0],i=!0;if(null!==this.selectorListeners&&void 0!==this.selectorListeners)for(var n=0,o=this.selectorListeners;n<o.length;n++){var a=(d=o[n]).onBeforeSelect(this,r);i&&!a&&(i=!1)}if(i){if(r.SetSelected(!0),this.selectList.push(r),null!==this.selectorListeners&&void 0!==this.selectorListeners)for(var s=0,l=this.selectorListeners;s<l.length;s++){(d=l[s]).onSelected(this,r),d.OnModelSelected(r.GetID().toString(),!0)}this.scene.GetRenderManager().RequestRedraw()}}else if(e[0]instanceof Array){for(var h=e[0],u=0;u<h.length;u++){(r=h[u]).SetSelected(!0),this.selectList.push(r)}if(null!==this.selectorListeners&&void 0!==this.selectorListeners)for(var p=0,c=this.selectorListeners;p<c.length;p++){var d;(d=c[p]).onShapesSelected(this,h)}this.scene.GetRenderManager().RequestRedraw()}},e.prototype.Remove=function(e){e.SetSelected(!1);for(var t=0;t!==this.selectList.length;){if(e.GetID()===this.selectList[t].GetID()){this.selectList.splice(t,1);break}t++}if(null!==this.selectorListeners&&void 0!==this.selectorListeners)for(var r=0,i=this.selectorListeners;r<i.length;r++){var n=i[r];n.onUnSelected(this,e),n.OnModelSelected(e.GetID().toString(),!1)}this.scene.GetRenderManager().RequestRedraw()},e.prototype.Clear=function(){for(var e=0;e<this.selectList.length;e++){this.selectList[e].SetSelected(!1)}if(null!==this.selectorListeners&&void 0!==this.selectorListeners)for(var t=0,r=this.selectorListeners;t<r.length;t++){r[t].onClearSelected(this)}this.selectList.length=0,this.scene.GetRenderManager().RequestRedraw()},e.prototype.GetAll=function(){return this.selectList},e.prototype.Count=function(){return this.selectList.length},e.prototype.Exist=function(e){for(var t=0;t!==this.selectList.length;){if(e.GetID()===this.selectList[t].GetID())return!0;t++}return!1},e.prototype.SetListeners=function(e){this.selectorListeners=e},e.prototype.GetListeners=function(){return this.selectorListeners},e.prototype.AddListener=function(e){return null!=e&&-1===this.selectorListeners.indexOf(e)&&this.selectorListeners.push(e),!0},e.prototype.RemoveListener=function(e){return null!=e&&-1!==this.selectorListeners.indexOf(e)&&this.selectorListeners.splice(this.selectorListeners.indexOf(e),1),!0},e.prototype.Get=function(){return 0===this.selectList.length?null:this.selectList[0]},e}();S.Selector=e}(M3D||(M3D={})),function(M3D){var View=function(){function View(){this.interpolatorCount=1e3,this.cameraAnimationTimer=500,this.modelExplosiveAnimationTimer=500,this.timerKeepMsecond=30,this.updateModelMap={},this.isChangeModelView=!1,this.viewIdArray=[],this.renderManager=null,this.sceneManager=null,this.sannotationManager=null,this.walkthroughHandler=null,this.workTouchHandler=null,this.commonTouchHandler=null,this.draggerHandler=null,this.selector=null,this.usingTouchHandlerType=M3D.TouchHandlerType.HANDLER_COMMON,this.backgroundNode=null,this.axisNode=null,this.explosiveViewOperator=null,this.pSAManager=null,this.animationPlaySpeed=1,this.animationContinuousPlay=!1,this.isAnimationPlayCamera=!1,this.isAnimationShowPMI=!1,this.isNeedChangeViewAnimation=!1,this.pTDriver=null,this.modleViewsList=[],this.modelManager=null,this.curModelView=null,this.startLinkAni=!1,this.bomManager=null,this.isInitialized=!1}return View.prototype.Initial=function(e){if(!this.isInitialized){this.pWorkNodeGroup=new M3D.WorkNodes,this.isInitialized=!0,this.commonTouchHandler=new M3D.CommonTouchHandler,this.draggerHandler=new M3D.DraggerHandler,this.walkthroughHandler=new M3D.WalkthroughHandler,this.draggerManager=new M3D.DraggerManager(this),this.workTouchHandler=this.commonTouchHandler,this.sceneManager=new M3D.SceneManager,this.sceneManager.GetRenderManager().InitialRender(e),this.SetSceneManager(this.sceneManager),this.selector=new M3D.Selector(this.sceneManager),this.fUnitScale=1;var t=new M3D.Camera;t.SetName(M3D.MAINCAMERA),this.sceneManager.SetCamera(t),t.SetSceneManager(this.sceneManager);var r=this.sceneManager.GetSceneRoot();r.SetName(M3D.ROOT);var i=new M3D.BackgroundNode;i.SetName(M3D.BACKGROUNDCOLOR),r.AddChild(i),this.backgroundNode=i;var n=new M3D.AxisNode;n.SetName(M3D.AXIS),r.AddChild(n),this.axisNode=n;var o=new M3D.HandlerGroup(this.sceneManager);o.SetName(M3D.HANDLER_GROUPNODE),r.AddChild(o);var a=new M3D.ScreenUILayerGroup(this.sceneManager);a.SetName(M3D.SCREENUILAYER_GROUPNODE),r.AddChild(a);var s=new M3D.AnnotationGroup;s.SetName(M3D.ANNOTATION_GROUP_PATH),r.AddChild(s);var l=new M3D.GeometryGroup(this.sceneManager);l.SetName(M3D.GEOMETRY_GROUPNODE),r.AddChild(l),this.setCookie();var h=new M3D.GroupNode;h.SetName(M3D.MAINGROUP),r.AddChild(h),null===this.pSAManager&&(this.pSAManager=M3D.SimulationAnimationManager.Instance()),null===this.pTDriver&&(this.pTDriver=new M3D.Timer,this.pTDriver.SetTimer(this.AnimationTick,this,10))}},View.prototype.setCookie=function(){this.SetCookieBackColor(),this.SetCookieCatia(),this.SetCookieContinueRotate(),this.SetCookieMergeFace(),this.SetCookieWaterMark(),this.SetCookieHighPerformance(),this.SetCookieMeasureUnit(),this.SetCookieRemoveSmallSize(),this.SetCookieRemoveSmallThing(),this.SetCookieSelectType(),this.SetCookieRoamAutomatic(),this.SetCookieUseLOD(),this.SetCookieUsePMI(),this.SetCookieEdgeSelectorColor(),this.SetCookieUpDirectionValue(),this.SetCookieObserveMode()},View.prototype.AnimationTick=function(e){var t=new Date;M3D.HTManager.GetHTManager().Tick(t.getTime()/1e3)},View.prototype.InitCamera=function(){this.workTouchHandler.Open()},View.prototype.ReSetCamera=function(){this.workTouchHandler.RefreshModelViewCamera()},View.prototype.SetSceneManager=function(e){this.sceneManager=e,this.commonTouchHandler.SetView(this),this.draggerHandler.SetView(this),this.walkthroughHandler.SetView(this)},View.prototype.SetRenderManager=function(e){this.renderManager=e},View.prototype.GetSceneManager=function(){return this.sceneManager},View.prototype.GetSAnnotationManager=function(){return null!==this.sannotationManager?this.sannotationManager:this.sannotationManager=new SView.SAnnotations},View.prototype.WindowSizeChange=function(e,t){this.sceneManager.GetRenderManager().WindowSizeChanged(e,t)},View.prototype.RestoreView=function(){this.model&&(this.model.SetVisible(!0),this.model.ResetColor()),this.commonTouchHandler.Reset(),this.draggerHandler.Reset(),this.walkthroughHandler.Reset(),this.sceneManager.Reset(),null!==this.selector&&this.selector.Clear(),this.InitCamera()},View.prototype.SetPerspective=function(e){M3D.PerspectiveOperator.GetInstance().Show(this,e)},View.prototype.CloseFile=function(){null!==this.selector&&this.selector.Clear(),this.commonTouchHandler.Reset(),this.draggerHandler.Reset(),this.walkthroughHandler.Reset(),this.model,this.model=null,this.sceneManager.RemoveModel()},View.prototype.ReadModel=function(e){this.CloseFile(),this.model=e,this.model.SetModleViewList(this.GetModelViewsList());M3D.M3D_STATUS.Read_NO_DEFINE_Error;return this.sceneManager.SetModel(this.model),this.RestoreView(),this.SetDefaultWorkNodes(),M3D.M3D_STATUS.Read_OK},View.prototype.CloseSceneAnimation=function(){return this.commonTouchHandler.CloseKeepState(),this.draggerHandler.CloseKeepState(),!0},View.prototype.SetDefaultWorkNodes=function(){null!=this.sceneManager&&(this.pWorkNodeGroup.AddNode(M3D.MAINCAMERA,this.sceneManager.GetCamera()),this.pWorkNodeGroup.AddNode(M3D.MAINMODELROOT,this.sceneManager.GetSceneRoot().Search(M3D.MAINMODELROOT)),this.pWorkNodeGroup.AddNode(M3D.AXIS,this.sceneManager.GetSceneRoot().Search(M3D.AXIS)),this.pWorkNodeGroup.AddNode(M3D.FPS_FLAG,this.sceneManager.GetSceneRoot().Search(M3D.FPS_FLAG)))},View.prototype.ReadFile=function(e){M3D.M3D_STATUS.Read_NO_DEFINE_Error,this.GetSceneManager();return this.model=this.reader.ReadFile(this.curFilePath),this.sceneManager.SetModel(this.model),this.sceneManager.OptimizeScene(),this.RestoreView(),M3D.M3D_STATUS.Read_OK},View.prototype.SetCameraProjectionType=function(e){var t=this.sceneManager.GetCamera(),r=t.GetFov();if(1==e){if(t.IsOrthographic()){var i=t.GetZoom(),n=this.sceneManager.GetDefaultZoom();t.SetZoom(n);var o=n/i,a=t.GetWorldPosition(),s=M3D.Vector3.ZERO().Clone(),l=t.GetViewPort().GetRect().Center().Clone();this.sceneManager.GetPickPoint(l,s,!1);var h=(p=this.sceneManager.GetDefaultFocusLength())/90*o/(2*M3D.Tan(.5*r/180*M3D.PI)),u=a.Sub(s).Normalized();t.SetWorldPosition(s.Add(u.Multiply(h))),t.SetOrthographic(!1)}}else if(0==e&&!t.IsOrthographic()){i=t.GetZoom(),n=this.sceneManager.GetDefaultZoom();t.SetZoom(n);a=t.GetWorldPosition(),s=new M3D.Vector3,l=t.GetViewPort().GetRect().Center().Clone();this.sceneManager.GetPickPoint(l,s,!1);this.sceneManager.GetDefaultFocusLength();var p=this.sceneManager.GetDefaultFocusLength();o=s.Sub(a).Length()/(p/90)*(2*M3D.Tan(.5*r/180*M3D.PI)),u=a.Sub(s).Normalized().Multiply(p);t.SetWorldPosition(s.Add(u)),t.ZoomView(1/o),t.SetOrthographic(!0)}},View.prototype.GetCameraProjectionType=function(){var e=0,t=this.sceneManager.GetCamera();return null!=t&&(e=t.IsOrthographic()?0:1),e},View.prototype.GetSelector=function(){return this.selector},View.prototype.GetPickShape=function(e,t,r,i){return null!==this.sceneManager?this.sceneManager.GetPickShape(e,t,r,i):null},View.prototype.SetRotationCenter=function(e,t){if(null!==this.sceneManager){var r=this.sceneManager.SetRotationCenterByScreenPnt(e,t,this.workTouchHandler.freeViewMode);if(0<r)return this.workTouchHandler.freeViewMode||(this.sceneManager.conRotationCenterId=r),this.sceneManager.GetRenderManager().RequestRedraw(),!0}return!1},View.prototype.TouchDown=function(e,t){this.workTouchHandler.HandleTouchEvent(e,t,M3D.CommonTouchHandler.TOUCHDOWN)},View.prototype.TouchMove=function(e,t,r){this.workTouchHandler.HandleTouchEvent(t,r,M3D.CommonTouchHandler.TOUCHMOVE,e)},View.prototype.TouchUp=function(e,t){this.workTouchHandler.HandleTouchEvent(e,t,M3D.CommonTouchHandler.TOUCHUP)},View.prototype.OnDraw=function(){this.sceneManager.GetRenderManager().OnDraw()},View.prototype.GetWorkNodes=function(){return this.pWorkNodeGroup},View.prototype.SetClipPlane=function(e,t,r,i){M3D.SectionOperator.Show(this,e,t,r,i)},View.prototype.SetClipPlaneColor=function(e,t){this.GetSceneManager().GetSection().GetPlaneById(t).SetFaceColor(e)},View.prototype.ClearClipPlane=function(){M3D.SectionOperator.Clear(this)},View.prototype.SetExplosiveView=function(e,t,r){this.GetExplosiveView().SetPercent(this,e,t,r)},View.prototype.SetExplosiveViewNoRestore=function(e,t,r){this.GetExplosiveView().SetPercentNoRestore(this,e,t,r)},View.prototype.GetExplosiveView=function(){return null===this.explosiveViewOperator&&(this.explosiveViewOperator=new M3D.ExplosiveViewOperator,this.explosiveViewOperator.SetView(this)),this.explosiveViewOperator},View.prototype.CloseExplosiveView=function(){null!==this.explosiveViewOperator&&this.explosiveViewOperator.Close(this)},View.prototype.SetUsingTouchHandlerType=function(e){this.usingTouchHandlerType!==e&&(this.usingTouchHandlerType=e,this.usingTouchHandlerType===M3D.TouchHandlerType.HANDLER_WALKTHROUGH?(this.workTouchHandler.Close(),this.workTouchHandler=this.walkthroughHandler,this.SetCameraProjectionType(1),this.workTouchHandler.Open()):this.usingTouchHandlerType===M3D.TouchHandlerType.HANDLER_COMMON?(this.SetCameraProjectionType(0),this.workTouchHandler=this.commonTouchHandler):this.usingTouchHandlerType===M3D.TouchHandlerType.HANDLER_DRAGGER&&(this.SetCameraProjectionType(0),this.workTouchHandler=this.draggerHandler))},View.prototype.GetUsingTouchHandlerType=function(){return this.usingTouchHandlerType},View.prototype.GetTouchHandler=function(){return this.workTouchHandler},View.prototype.SetConRotate=function(e){M3D.Parameters.Instance().IsConRotate=e},View.prototype.SetMergeFace=function(e){M3D.Parameters.Instance().isMergeFace=e},View.prototype.SetWaterMark=function(e){M3D.Parameters.Instance().useWaterMark=e},View.prototype.SetCatia=function(e){M3D.Parameters.Instance().IsUseCatiaMode=e},View.prototype.SetHighPerformance=function(e){M3D.Parameters.Instance().IsHighPerformanceView=e},View.prototype.SetUseLOD=function(e){M3D.Parameters.Instance().IsUseLOD=e},View.prototype.SetUsePMI=function(e){M3D.Parameters.Instance().IsShowPMIs=e},View.prototype.SetEdgeSelector=function(e){M3D.Parameters.Instance().ModelSelectedColor=e},View.prototype.SetRoamAutomatic=function(e){M3D.Parameters.Instance().IsUseAnimationCamera=e},View.prototype.SetRemoveSmallThing=function(e){M3D.Parameters.Instance().RemoveMode=e},View.prototype.SetRemoveSmallSize=function(e){M3D.Parameters.Instance().RemoveSize=e},View.prototype.SetMeasureUnit=function(e){M3D.Parameters.Instance().measureUnitStyle=e},View.prototype.SetBackgroundColor=function(e,t){var r=!1,i=(M3D.BACKGROUNDCOLOR,this.GetSceneManager().GetSceneRoot().Search(M3D.BACKGROUNDCOLOR));return null!==i?(i.SetTopColor(e),i.SetBottomColor(t),i.SetUseImage(!1),i.SetUseSkyBox(!1)):r=!1,r},View.prototype.GetBackgroundColor=function(e,t){var r=!1,i=this.GetSceneManager().GetSceneRoot().Search(M3D.BACKGROUNDCOLOR);return null!==i?(i.GetTopColor(e),i.GetBottomColor(t)):r=!1,r},View.prototype.SetBackgroundImage=function(e){var t=!1,r=this.GetSceneManager().GetSceneRoot().Search(M3D.BACKGROUNDCOLOR);return null!==r&&(r.SetImage(e),t=!0),t},View.prototype.SetBackgroundUseImage=function(e){var t=this.GetSceneManager().GetSceneRoot().Search(M3D.BACKGROUNDCOLOR);null!==t&&t.SetUseImage(e)},View.prototype.GetBackgroundUseImage=function(){var e=!1,t=this.GetSceneManager().GetSceneRoot().Search(M3D.BACKGROUNDCOLOR);return null!==t&&(e=t.IsUseImage()),e},View.prototype.SetBackgroundTexture=function(e){var t=this.GetSceneManager().GetSceneRoot().Search(M3D.BACKGROUNDCOLOR);null!==t&&(t.SetTexture(e),t.SetUseImage(!0),t.SetUseSkyBox(!1))},View.prototype.GetBackgroundTexture=function(){var e=this.GetSceneManager().GetSceneRoot().Search(M3D.BACKGROUNDCOLOR);if(null!==e){var t=e.GetTexture(null);if(t)return t}return null},View.prototype.AddBackgroundSkyBoxTexture=function(e,t){var r=this.GetSceneManager().GetSceneRoot().Search(M3D.BACKGROUNDCOLOR);null!==r&&r.AddSkyBoxTexture(e,t)},View.prototype.SetBackgroundUseSkyBox=function(e){var t=this.GetSceneManager().GetSceneRoot().Search(M3D.BACKGROUNDCOLOR);null!==t&&t.SetUseSkyBox(e)},View.prototype.GetBackgroundUseSkyBox=function(){var e=this.GetSceneManager().GetSceneRoot().Search(M3D.BACKGROUNDCOLOR);null!==e&&e.IsUseSkyBox()},View.prototype.SetBackgroundUseColor=function(e){var t=this.GetSceneManager().GetSceneRoot().Search(M3D.BACKGROUNDCOLOR);null!==t&&t.SetUseColor(e)},View.prototype.SetCookieBackColor=function(){var e=M3D.CookieHelper.GetCookie(M3D.BOTTOCOLOR_KEY),t=M3D.CookieHelper.GetCookie(M3D.TOP_COLOR_KEY);if(e&&t){var r=e.split(" "),i=t.split(" "),n=new M3D.Color(parseFloat(r[0]),parseFloat(r[1]),parseFloat(r[2])),o=new M3D.Color(parseFloat(i[0]),parseFloat(i[1]),parseFloat(i[2]));this.SetBackgroundColor(o,n)}else this.SetBackgroundColor(new M3D.Color(.5803922,.7921569,.9372549,1),new M3D.Color(1,1,1,1))},View.prototype.SetCookieContinueRotate=function(){var e=M3D.CookieHelper.GetCookie(M3D.ROTATE);e?this.SetConRotate(Boolean(Number(e))):this.SetConRotate(!1)},View.prototype.SetCookieMergeFace=function(){var e=M3D.CookieHelper.GetCookie(M3D.MERGEFACE);e?this.SetMergeFace(Boolean(Number(e))):this.SetMergeFace(!0)},View.prototype.SetCookieWaterMark=function(){var e=M3D.CookieHelper.GetCookie(M3D.WATERMARK);e?this.SetWaterMark(Boolean(Number(e))):this.SetWaterMark(!1)},View.prototype.SetCookieCatia=function(){var e=M3D.CookieHelper.GetCookie(M3D.CATIA);e?this.SetCatia(Boolean(Number(e))):this.SetCatia(!1)},View.prototype.SetCookieHighPerformance=function(){var e=M3D.CookieHelper.GetCookie(M3D.HIGHPERFORMANCE);e?this.SetHighPerformance(Boolean(Number(e))):this.SetHighPerformance(!1)},View.prototype.SetCookieUseLOD=function(){var e=M3D.CookieHelper.GetCookie(M3D.USELOD);e?this.SetUseLOD(Boolean(Number(e))):this.SetUseLOD(!1)},View.prototype.SetCookieUsePMI=function(){var e=M3D.CookieHelper.GetCookie(M3D.USEPMI);e?this.SetUsePMI(Boolean(Number(e))):this.SetUsePMI(!1)},View.prototype.SetCookieEdgeSelectorColor=function(){var e=M3D.CookieHelper.GetCookie(M3D.EDGECOLOR);if(e){var t=e.split(" "),r=new M3D.Color(parseFloat(t[0]),parseFloat(t[1]),parseFloat(t[2]));this.SetEdgeSelector(r)}else{r=new M3D.Color(1,0,0);this.SetEdgeSelector(r)}},View.prototype.SetCookieRoamAutomatic=function(){var e=M3D.CookieHelper.GetCookie(M3D.ROAMAUTOMATIC);this.SetRoamAutomatic(Boolean(Number(e)))},View.prototype.SetCookieSelectType=function(){var e=M3D.CookieHelper.GetCookie(M3D.SELECTTYPE),t=1;e&&(t=Number("1"==e?1:"2"==e?2:3)),M3D.Parameters.Instance().selectedStyle=t},View.prototype.SetCookieRemoveSmallThing=function(){var e=M3D.CookieHelper.GetCookie(M3D.REMOVESMALLTHING);e?this.SetRemoveSmallThing(Number("model"==e?"0":"1")):this.SetRemoveSmallThing(1)},View.prototype.SetCookieRemoveSmallSize=function(){var e=M3D.CookieHelper.GetCookie(M3D.REMOVESMALLSIZE);e?this.SetRemoveSmallSize(Number(e)):this.SetRemoveSmallSize(10)},View.prototype.SetCookieMeasureUnit=function(){var e=M3D.CookieHelper.GetCookie(M3D.MEASUREUNIT);e?this.SetMeasureUnit(Number(e)):this.SetMeasureUnit(1)},View.prototype.SetCookieUpDirectionValue=function(){var e=M3D.CookieHelper.GetCookie(M3D.UPDIRECTION);if(null!=e){var t=new M3D.Vector3;switch(Number(e)){case 0:t=M3D.Vector3.RIGHT().Clone();break;case 1:t=M3D.Vector3.LEFT().Clone();break;case 2:t=M3D.Vector3.UP().Clone();break;case 3:t=M3D.Vector3.DOWN().Clone();break;case 4:t=M3D.Vector3.FORWARD().Clone();break;case 5:t=M3D.Vector3.BACK().Clone()}this.workTouchHandler.SetUpDirection(t,this)}},View.prototype.SetCookieObserveMode=function(){var e=M3D.CookieHelper.GetCookie(M3D.OBSERVEMODE);if(null!=e){switch(Number(e)){case 0:this.commonTouchHandler.freeViewMode=!0,this.commonTouchHandler.controlLockXY=!1,this.commonTouchHandler.oribitMode=!1;break;case 1:this.commonTouchHandler.freeViewMode=!1,this.commonTouchHandler.controlLockXY=!1,this.commonTouchHandler.oribitMode=!0;break;case 2:this.commonTouchHandler.freeViewMode=!1,this.commonTouchHandler.controlLockXY=!0,this.commonTouchHandler.oribitMode=!1}this.commonTouchHandler.oberveMode=Number(e)}},View.prototype.AnimationPlay=function(){if(this.pSAManager){this.pSAManager.SetPlaySpeed(this.animationPlaySpeed),this.pSAManager.SetContinuousPlay(this.animationContinuousPlay);var e=this.pSAManager.GetAnimationStepManager();return this.pSAManager.IsPlaying()?e.Stop():(this.SaveAnimatinState(),e.SetPlayMode(M3D.AnimationPlayMode.PLAY_MODE_PROCESS),e.Pause(),e.Play(M3D.AnimationPlayMode.PLAY_MODE_PROCESS)),!0}},View.prototype.SaveAnimatinState=function(){},View.prototype.AnimationContinuousPlayState=function(){var e=this.animationContinuousPlay;return this.pSAManager&&(e=this.pSAManager.GetContinuousPlay()),e},View.prototype.AnimationContinuousPlay=function(e){return this.animationContinuousPlay=e,this.pSAManager&&this.pSAManager.SetContinuousPlay(e),!1},View.prototype.AnimationRewind=function(){if(this.pSAManager)return!1;var e=this.pSAManager.GetAnimationStepManager();return null!==e&&(e.Rewind(M3D.AnimationPlayMode.PLAY_MODE_PROCESS,!1),this.RestoreAnimationState(),!0)},View.prototype.RestoreAnimationState=function(){M3D.PerspectiveOperator.GetInstance().FinishAnimation(),this.isNeedChangeViewAnimation=!0},View.prototype.AnimationSetTick=function(e){var t=this.pSAManager.GetCurrentSA();return!!t&&(this.pSAManager.IsPlaying()?(this.pSAManager.StopAll(),t.SetCurrentTickByPercentage(e),t.ExecuteAnimations(t.GetCurrentTick(),0),t.Continue()):(t.SetCurrentTickByPercentage(e),t.ExecuteAnimations(t.GetCurrentTick(),0)),!0)},View.prototype.AnimationGetTick=function(){var e=0;if(null!==this.pSAManager){var t=this.pSAManager.GetAnimationStepManager();if(t){var r=t.GetCurrentProcess();if(r){var i=r.GetBehaviorManager();i&&(e=i.GetCurrentTickByPercentage())}}}return e},View.prototype.AnimationIsPlaying=function(){return null!==this.pSAManager&&this.pSAManager.IsPlaying()},View.prototype.AnimationTransitionIsPlaying=function(){return null!==this.pSAManager&&null!==this.pSAManager.GetAnimationStepManager().GetBehaviorActionChgCam()},View.prototype.AnimationExecute=function(e){var t=this.pSAManager.GetCurrentSA();if(null===t)return!1;t.ScheduleAllAnimations(!0),t.SetCurrentTickByPercentage(e),t.ExecuteAnimations(t.GetCurrentTick(),0)},View.prototype.AnimationPlayCamera=function(e){return this.isAnimationPlayCamera=e,!0},View.prototype.AnimationPlaySpeed=function(e){var t=!0;if(0<(this.animationPlaySpeed=e)&&e<10&&null!==this.pSAManager){var r=this.pSAManager.GetCurrentSA();if(null===r)return!1;if(this.pSAManager.IsPlaying()){r.Stop(),r.GetSimulationAnimationManager().SetPlaySpeed(this.animationPlaySpeed);var i=r.IsReversePlay();r.ScheduleAllAnimations(!0),i?r.ContinueReverse():r.Continue()}else r.GetSimulationAnimationManager().SetPlaySpeed(this.animationPlaySpeed)}else t=!1;return t},View.prototype.AnimationSetActiveStep=function(e,t){var r=!1,i=this.pSAManager.GetAnimationStepManager().FindProcessManagerByID(e);return i&&(i.SetCurProcessByID(t),r=!0),r},View.prototype.AnimationGetPlayCamera=function(){return this.isAnimationPlayCamera},View.prototype.OnAnimationTick=function(){this.AnimationTick(null)},View.prototype.GetSimulationMgr=function(){return this.pSAManager},View.prototype.AnimationGetInfo=function(){var e=[];if(!this.pSAManager.HasAnimations())return e;var t=this.GetSimulationMgr();if(t){var r=t.GetAnimationStepManager();if(r){var i=r.GetProcessManagerList();if(!i)return e;for(var n=[],o=0;o<i.length;o++)n.push(i[o]);for(o=0;o<i.length;o++)for(var a=i[o].ChildProcessManagerList,s=0;s<a.length;s++)for(var l=0;l<n.length;l++)n[l].GetID()===a[s].GetID()&&(n.splice(l,1),l--);for(var h=null,u=0;u<n.length;u++){if(0,!(h=n[u]))return e;var p=h.GetProcessList();if(!p)return e;var c=new M3D.SAnimationProcess(this);c.SetId(h.GetID()),c.SetName(h.GetName());for(var d=null,S=0;S<p.length;S++){0,d=p[S];var f=new M3D.SAnimationStep(this);f.SetName(d.GetName()),f.SetId(d.GetID());var m=d.GetDesc();m.replace("\r\n","--;;--"),f.SetStepInfo(m),f.SetProcessId(h.GetID()),c.AddStep(f)}for(var y=h.ChildProcessManagerList,T=0;T<y.length;T++){var M=this.ResetAnimationInfo(y[T],h.GetID());c.AddChildProcess(M)}e.push(c)}}}return e},View.prototype.ResetAnimationInfo=function(e,t){var r=new M3D.SAnimationProcess(this);r.SetId(e.GetID()),r.SetName(e.GetName()),r.SetProcessId(t);var i=e.ChildProcessManagerList;if(i)for(var n=0;n<i.length;n++){var o=i[n];(l=new M3D.SAnimationProcess(this)).SetName(o.GetName()),l.SetId(o.GetID()),l.SetProcessId(e.GetID());var a=this.ResetAnimationInfo(o,e.GetID());l.AddChildProcess(a),r.AddChildProcess(l)}var s=e.GetProcessList();if(s)for(n=0;n<s.length;n++){var l,h=s[n];(l=new M3D.SAnimationStep(this)).SetName(h.GetName()),l.SetId(h.GetID());var u=h.GetDesc();u.replace("\r\n","--;;--"),l.SetStepInfo(u),l.SetProcessId(e.GetID()),r.AddStep(l)}return r},View.prototype.HasAnimations=function(){return this.pSAManager.HasAnimations()},View.prototype.AnimationIit=function(){for(var e=this.pSAManager.BehaviorManagerList,t=0;t<e.length;t++)e[t].DeleteAllAnimation()},View.prototype.FoucusView=function(e,t,r){var i=this.GetSceneManager(),n=i.GetCamera(),o=null,a=null,s=null;if(null!=n&&n.IsOrthographic()){var l=e.Center(),h=n.GetViewPort().WorldToScreenPoint(l),u=t,p=n.GetViewPort().ScreenToWorldPoint(h.x,h.y,.5),c=n.GetViewPort().ScreenToWorldPoint(u.x,u.y,.5),d=p.Sub(c);o=T=(T=n.GetWorldPosition().Clone()).Add(d);var S=i.GetRenderManager().GetWindowHeight(),f=i.GetRenderManager().GetWindowWidth();i.GetRenderManager().WindowSizeChanged(f,S);var m=M3D.Parameters.Instance().DefaultZoomFactor;m=m*S/f,f<S&&(m=.5*m*(1*f/S));var y=1.3*m*i.GetSceneBox().Length()/e.Length();s=new M3D.Vector3(y,y,y),a=n.GetRotation().Clone()}else if(n&&!n.IsOrthographic()){l=e.Center();i.SetRotationCenter(l);var T,M=n.GetFitClip();u=n.GetViewPort().GetRect().Center(),c=n.GetViewPort().ScreenToWorldPoint(u.x,u.y,M),d=(p=l).Sub(c);T=(T=n.GetWorldPosition().Clone()).Add(d);i.GetSceneBox();var g=.6*e.Length();d=l.Sub(T).Normalized().Multiply(g);y=n.GetZoom();s=new M3D.Vector3(y,y,y),a=n.GetRotation().Clone(),o=l.Sub(d)}return a=a.Inverse(),r?M3D.PerspectiveOperator.GetInstance().ExecuteCommonCameraAnimation(this,o,a,s,!0,!1,!0):(n.SetRotation(a),n.SetWorldPosition(o),n.SetZoom(s.x)),!0},View.prototype.GetModelManager=function(){return null===this.modelManager&&(this.modelManager=new M3D.ModelManager(this)),this.modelManager},View.prototype.GetBomManager=function(){return null===this.bomManager&&(this.bomManager=M3D.BomManager.Instance(this)),this.bomManager},View.prototype.GetModelBySVLPath=function(e){var t=null,r=M3D.PathHelper.SVLPathToM3D(e),i=this.GetSceneManager().GetNode(r);return i&&i instanceof M3D.Model&&(t=i),t},View.prototype.GetModelByPlacePath=function(e){var t=null,r=M3D.PathHelper.SVLPathToM3D(e),i=this.GetSceneManager().GetNode(r);return i&&i instanceof M3D.Model&&(t=i),t},View.prototype.addHandler=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(3===e.length){var r=e[0],i=e[1],n=e[2];return this.GetSceneManager().AddHandle(r,i,n)}r=e[0],i=e[1];var o=e[2];n=e[3];return this.GetSceneManager().AddHandle(r,i,o,n)},View.prototype.addShape=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(4===e.length){var r=e[0],i=e[1],n=e[2],o=e[3];return this.GetSceneManager().AddShape(r,i,n,o)}r=e[0],i=e[1],o=e[2];return this.GetSceneManager().AddShape(r,i,o)},View.prototype.RemoveShape=function(e){M3D.LOGE("View::RemoveShape"),this.GetSceneManager().RemoveShape(e)},View.prototype.GetShapePos=function(e,t,r){var i=new M3D.Vector3;this.GetSceneManager().GetShapePos(e,t,i),r[0]=i.x,r[1]=i.y,r[2]=i.z},View.prototype.AddLineLengthNote=function(e,t,r){return-1},View.prototype.AddRadiusLengthNote=function(e,t,r){return-1},View.prototype.moveRadiusLengthNote=function(e,t,r){},View.prototype.GetShapeColor=function(e,t){return this.GetSceneManager().GetShapeColor(e,t)},View.prototype.InterpolatorCamera=function(e){if(e.startLinkAni){var t=e.GetSceneManager().GetCamera(),r=(new Date).getTime(),i=Math.round(e.interpolatorCount*(r-e.startTime)/e.cameraAnimationTimer);r-e.startTime>e.cameraAnimationTimer&&(i=e.interpolatorCount-1);var n=e.midRotation[i];n&&t.SetRotation(n);var o=e.midScale[i];o&&t.SetZoom(o);var a=e.midTran[i];if(a){t.SetPosition(a);var s=e.sceneManager.GetSceneBox();if(t.IsOrthographic()){var l=t.GetPosition();if(s.IsInside(l)==M3D.INSIDE){var h=t.GetView().ToMatrix3(),u=new M3D.Vector3(h.data[6],h.data[7],h.data[8]);u.Normalize();var p=l.Add(u.Multiply(s.Length()));t.SetWorldPosition(p)}}}i>=e.interpolatorCount-1&&(e.StopModelViewAnimation(),t.isAnimation=!1,0<Object.getOwnPropertyNames(e.updateModelMap).length?e.StartAnimation(e.InterPolatorModel,e):(e.isChangeModelView=!1,e.ShowLinkStoryListener&&e.ShowLinkStoryListener()))}else e.StopModelViewAnimation()},View.prototype.InterPolatorModel=function(e){if(e.startLinkAni){var t=(new Date).getTime(),r=Math.round(e.interpolatorCount*(t-e.startTime)/e.modelExplosiveAnimationTimer);for(var i in(t-e.startTime>e.modelExplosiveAnimationTimer||r===e.interpolatorCount)&&(r=e.interpolatorCount-1),e.updateModelMap){var n=e.GetShapeBySVLPath(i);if(n){var o=e.updateModelMap[i][0],a=e.updateModelMap[i][1];if(o[r]&&a[r]){var s=new M3D.Matrix4(o[r],a[r],n.GetPlaceMatrix().Scale());n.SetPlaceMatrix(s)}else console.log("没有获取到该差值数据")}}r>=e.interpolatorCount-1&&(e.GetSceneManager().RequestUpdateWhenSceneBoxChanged(),e.StopModelViewAnimation(),e.isChangeModelView=!1,e.updateModelMap={},M3D.AnimationHelper.RemoveTrochoid("ModelViewTrochoid",e),e.ShowLinkStoryListener&&e.ShowLinkStoryListener())}else e.StopModelViewAnimation()},View.prototype.InterPolatorModelWorld=function(e){if(e.startLinkAni){var t=(new Date).getTime(),r=Math.round(e.interpolatorCount*(t-e.startTime)/e.modelExplosiveAnimationTimer);for(var i in(t-e.startTime>e.modelExplosiveAnimationTimer||r===e.interpolatorCount)&&(r=e.interpolatorCount-1),e.updateModelMap){var n=e.GetShapeBySVLPath(i);if(n){var o=e.updateModelMap[i][0],a=e.updateModelMap[i][1];if(o[r]&&a[r]){new M3D.Matrix4(o[r],a[r],n.GetWorldTransform().Scale());n.SetWorldPosition(o[r])}else console.log("没有获取到该差值数据")}}r>=e.interpolatorCount-1&&(e.GetSceneManager().RequestUpdateWhenSceneBoxChanged(),e.StopModelViewAnimation(),e.isChangeModelView=!1,e.updateModelMap={},M3D.AnimationHelper.RemoveTrochoid("ModelViewTrochoid",e),e.ShowLinkStoryListener&&e.ShowLinkStoryListener())}else e.StopModelViewAnimation()},View.prototype.GetModelViewAnimationTimer=function(){return this.modelViewAnimationTimer||(this.modelViewAnimationTimer=new M3D.Timer),this.modelViewAnimationTimer},View.prototype.StopModelViewAnimation=function(){this.GetModelViewAnimationTimer().IsStart()&&this.modelViewAnimationTimer.StopTimer(),this.midRotation=[],this.midScale=[],this.midTran=[]},View.prototype.StartAnimation=function(e,t){t.startTime=(new Date).getTime(),t.GetModelViewAnimationTimer().SetTimer(e,t,this.timerKeepMsecond),t.GetModelViewAnimationTimer().StartTimer()},View.prototype.setCameraAnimationTime=function(e){this.cameraAnimationTimer=e},View.prototype.setModelExplosiveAnimationTime=function(e){this.modelExplosiveAnimationTimer=e},View.prototype.ShowModelView=function(e,t,r,i){this.startLinkAni=!0;var n=this.GetModel(),o=n.GetModleView(e);if(null!=o){this.StopModelViewAnimation(),this.updateModelMap={},M3D.AnimationHelper.RemoveTrochoid("ModelViewTrochoid",this),this.isChangeModelView=!0;var a=o.GetInstanceAttributeMap();this.SetCurrentModelView(o);if(o.GetUpDataCameraState()){var s=o.GetCamera(),l=this.GetSceneManager().GetCamera(),h=s.GetPosition(),u=this.sceneManager.GetSceneBox();if(t){this.StopModelViewAnimation();var p=1;if(l.IsOrthographic()&&0<l.GetOrthoSize().y&&s.GetOrthoSize().y)p=l.GetOrthoSize().y/s.GetOrthoSize().y*s.GetZoom();else p=c=this.sceneManager.GetDefaultZoom();M3D.M3DTOOLS.VecSlerp(l.GetPosition(),h,this.interpolatorCount,this.midTran),M3D.M3DTOOLS.RotationSlerp(l.GetRotation(),s.GetRotation(),this.interpolatorCount,this.midRotation),M3D.M3DTOOLS.FloatSlerp(l.GetZoom(),p,this.interpolatorCount,this.midScale),this.startTime=(new Date).getTime(),l.isAnimation=!0,this.StartAnimation(this.InterpolatorCamera,this)}else{if(l.SetPosition(h),l.SetRotation(s.GetRotation()),l.SetOrthographic(s.IsOrthographic()),l.IsOrthographic()&&0<l.GetOrthoSize().y&&s.GetOrthoSize().y)l.SetZoom(l.GetOrthoSize().y/s.GetOrthoSize().y*s.GetZoom());else{var c=this.sceneManager.GetDefaultZoom();l.SetZoom(c)}if(s.IsOrthographic()){var d=u.Center(),S=l.GetPosition();if(u.IsInside(S)==M3D.INSIDE){var f=s.GetRotation().RotationMatrix(),m=new M3D.Vector3(f.Data()[2],f.Data()[5],f.Data()[8]),y=S.Add(m.Multiply(.8*u.Length()));l.SetWorldPosition(y)}else if(!o.GetUpDataModelState()){f=s.GetRotation().RotationMatrix(),m=new M3D.Vector3(f.Data()[2],f.Data()[5],f.Data()[8]);var T=new M3D.Plane(m,d).Project(h),M=[0,0];M[0]=l.GetOrthoSize().x,M[1]=l.GetOrthoSize().y;var g=.5*s.GetOrthoSize().y;s.GetZoom()<1&&(g/=s.GetZoom());var v=M[0]/M[1];1<=v?g*=v:g/=v;var C=new M3D.Vector3(d.x-g,d.y-g,d.z-g),_=new M3D.Vector3(d.x+g,d.y+g,d.z+g);new M3D.BoundingBox(C,_).IsInside(T)!=M3D.INSIDE&&(h=u.Center().Add(m.Multiply(.8*u.Length())),l.SetWorldPosition(h))}}0<Object.getOwnPropertyNames(this.updateModelMap).length&&this.StartAnimation(this.InterPolatorModel,this)}}else 0<Object.getOwnPropertyNames(this.updateModelMap).length&&this.StartAnimation(this.InterPolatorModel,this);for(var A=0;A<a.Keys().length;A++){var E=a.Values()[A],G=this.GetShapeBySVLPath(E.path);if(G&&G.GetType()==M3D.ShapeType.SHAPE_MODEL){var P=G;if(P.SetVisible(E.visible),E.hasColor&&0<=E.insColor.r&&0<=E.insColor.g&&0<=E.insColor.b){var w=E.insColor,D=E.insColor.a;if(P.GetColor()&&P.GetColor().Equals(w)&&P.GetAlpha()===D)continue;var x=!0;if(P.GetBodys())for(var R=!0,I=new M3D.Color,L=void 0,N=0;N<P.GetBodys().length;N++){var O=P.GetBodys()[N];if(O)for(var b=0;b<O.GetFaces().length;b++){var V=O.GetFaces()[b];if(V)if(R)I=V.GetColor(),L=V.GetAlpha(),R=!1;else if(!V.GetColor().Equals(I)||V.GetAlpha()!=L){x=!1;break}}if(!x)break}if(!x)continue;var F=P.GetFaceMaterial();if(F){var B=this.GetSceneManager().GetModel();switch(F.GetMaterialType()){case M3D.MaterialType.MaterialType_Phong:var U=F,H=(Q="material_phong_uuid_"+M3D.IDCreator.GetUUID(),U.Clone());H.SetDiffuse(w),H.Opacity(D);var k=this.GetSceneManager().GetResourceManager().IsMaterialExistedByKey(H,Q);if(k)H=null,P.SetFaceMaterial(k);else if(this.GetSceneManager().GetResourceManager().IsMaterialUsed(B,U,P)){H.SetName(Q);this.GetSceneManager().GetResourceManager().AddMaterial(Q,H);H.SetResourceManager(this.GetSceneManager().GetResourceManager()),P.SetFaceMaterial(H)}else U.SetDiffuse(w),U.Opacity(D),P.SetFaceMaterial(U),H=null;break;case M3D.MaterialType.MaterialType_Pbr:var z=F,W=(Q="material_pbr_uuid_"+M3D.IDCreator.GetUUID(),z.Clone());W.SetAlbedoColor(w),W.SetOpacity(D);var Y=this.GetSceneManager().GetResourceManager().IsMaterialExistedByKey(W,Q);if(Y)W=null,P.SetFaceMaterial(Y);else if(this.GetSceneManager().GetResourceManager().IsMaterialUsed(B,z,P)){W.SetName(Q);this.GetSceneManager().GetResourceManager().AddMaterial(Q,W);W.setResourceManager(this.GetSceneManager().GetResourceManager()),P.SetFaceMaterial(W)}else z.SetAlbedoColor(w),z.SetOpacity(D),P.SetFaceMaterial(z),W=null;break;case M3D.MaterialType.MaterialType_MatCap:var X=F,j=(Q="material_matCap_uuid_"+M3D.IDCreator.GetUUID(),X.Clone());j.SetDiffuse(w),j.Opacity(D);var K=this.GetSceneManager().GetResourceManager().IsMaterialExistedByKey(j,Q);if(K)P.SetFaceMaterial(K),j=null;else if(this.GetSceneManager().GetResourceManager().IsMaterialUsed(B,X,P)){j.SetName(Q);this.GetSceneManager().GetResourceManager().AddMaterial(Q,j);j.SetResourceManager(this.GetSceneManager().GetResourceManager()),P.SetFaceMaterial(j)}else X.SetDiffuse(w),X.Opacity(D),P.SetFaceMaterial(X),j=null}}else{var q=this.GetSceneManager().GetResourceManager().IsMaterialExisted(w,D);if(q)P.SetFaceMaterial(q);else{var Q="material_phong_uuid_"+M3D.IDCreator.GetUUID(),Z=this.GetSceneManager().GetResourceManager().GetOrCreateMaterial(Q,M3D.MaterialType.MaterialType_Phong);Z.SetDiffuse(w),Z.Opacity(D),P.SetFaceMaterial(Z)}}}if(!E.placeMatrix.Equals(P.plcMatrix))if(r){var J=new M3D.Vector3,$=new M3D.Quaternion,ee=new M3D.Vector3;P.GetPlaceMatrix().Decompose(J,$,ee);var te=new M3D.Vector3,re=new M3D.Quaternion;E.placeMatrix.Decompose(te,re,ee);var ie=[],ne=[];M3D.M3DTOOLS.VecSlerp(J,te,this.interpolatorCount,ie),M3D.M3DTOOLS.RotationSlerp($,re,this.interpolatorCount,ne),this.updateModelMap[E.path]=[ie,ne];var oe=new M3D.Vector3,ae=new M3D.Vector3;if(P.GetParent()&&P.GetParent().GetParent()){var se=P.GetParent().GetWorldTransform();oe=se.Multiply(te),ae=se.Multiply(J)}else oe=te,ae=J;M3D.Parameters.Instance().isShowAniTrochoid&&M3D.AnimationHelper.AddTrochoid([ae,oe],"ModelViewTrochoid",this)}else P.SetPlaceMatrix(E.placeMatrix)}else console.log("didn`t find model")}this.GetSceneManager().GetSection().ClearPlanes();var le=n.GetSectionPlaneList();if(null!=le&&0<le.length)for(A=0;A<le.length;A++){(ue=le[A]).GetEnable()&&ue.SetEnable(!1)}var he=o.GetSectionPlaneIDList();if(0<he.length)for(A=0;A<le.length;A++){var ue=le[A];for(b=0;b<he.length;b++)if(he[b]==ue.GetID()){ue.SetEnable(!0),this.sceneManager.GetSection().AddPlane(ue);break}}var pe=this.GetSceneManager().GetNoteGroup();if(pe){for(pe.Size(),A=0;A<pe.Size();A++){if(Me=pe.GetChild(A))(ge=Me.GetShape())&&ge.SetVisible(!1)}var ce=0;ce=(Te=o.GetNoteList()).length;for(A=0;A<Te.length;A++){var de=Te[A];for(b=0;b<pe.Size();b++){if(Me=pe.GetChild(b))if((ge=Me.GetShape())&&de==Me.GetID()){ge.SetVisible(!0);break}}}}var Se=this.GetSceneManager().GetAnnotationGroup();if(Se){var fe=Se.Size();for(A=0;A<fe;A++){if(Me=Se.GetChild(A))(ge=Me.GetShape())&&ge.SetVisible(!1)}ce=0;ce=(Te=o.GetNoteList()).length;for(A=0;A<ce;A++)for(de=Te[A],b=0;b<Se.Size();b++){if(Me=Se.GetChild(b))if((ge=Me.GetShape())&&de==ge.GetCreateID()){ge.SetVisible(!0);break}}}var me=this.GetSceneManager().GetMeasureGroup();if(me){var ye=me.Size();for(A=0;A<ye;A++){if(Me=me.GetChild(A))(ge=Me.GetShape())&&ge.SetVisible(!1)}var Te;ce=0;ce=(Te=o.GetNoteList()).length;for(A=0;A<ce;A++)for(de=Te[A],b=0;b<me.Size();b++){var Me,ge;if(Me=me.GetChild(b))if((ge=Me.GetShape())&&de==ge.GetID()){ge.SetVisible(!0);break}}}var ve=this.GetSceneManager().GetExtendInfoManager(),Ce=ve.GetModelPMIRef(this.GetModel().GetProtoTypeId());if(null!=Ce&&0<Ce.length)if(0===o.GetViewType())for(var _e=0;_e<Ce.length;_e++){(Ae=ve.pmiMap.Get(Ce[_e]))&&Ae.SetVisible(!0)}else{for(_e=0;_e<Ce.length;_e++){(Ae=ve.pmiMap.Get(Ce[_e]))&&Ae.SetVisible(!1)}for(A=0;A<o.GetPMIList().length;A++){var Ae;o.GetPMIList()[A];(Ae=ve.pmiMap.Get(Ce[A]))&&Ae.SetVisible(!0)}}}else M3D.LOGE("modleViewId:%d not found!",e)},View.prototype.ShowNewModelView=function(e,t){var r=this.GetModel(),i=r.GetModleView(e);if(null!=i){if(t)this.ShowModelViewAnimation(i);else{if(i.GetUpDataCameraState()){var n=i.GetCamera(),o=this.GetSceneManager().GetCamera(),a=n.GetPosition();if(o.SetPosition(a),o.SetRotation(n.GetRotation()),o.SetOrthographic(n.IsOrthographic()),o.IsOrthographic()&&0<o.GetOrthoSize().y&&n.GetOrthoSize().y)o.SetZoom(o.GetOrthoSize().y/n.GetOrthoSize().y*n.GetZoom());else{var s=this.sceneManager.GetDefaultZoom();o.SetZoom(s)}if(n.IsOrthographic()){var l=this.sceneManager.GetSceneBox(),h=l.Center(),u=o.GetPosition();if(l.IsInside(u)==M3D.INSIDE){var p=n.GetRotation().RotationMatrix(),c=new M3D.Vector3(p.Data()[2],p.Data()[5],p.Data()[8]),d=u.Add(c.Multiply(l.Length()).Multiply(.8));o.SetWorldPosition(d)}else if(!i.GetUpDataModelState()){p=n.GetRotation().RotationMatrix(),c=new M3D.Vector3(p.Data()[2],p.Data()[5],p.Data()[8]);var S=new M3D.Plane(c,h).Project(a),f=[0,0];f[0]=o.GetOrthoSize().x,f[1]=o.GetOrthoSize().y;var m=.5*n.GetOrthoSize().y;n.GetZoom()<1&&(m/=n.GetZoom());var y=f[0]/f[1];1<=y?m*=y:m/=y;var T=new M3D.Vector3(h.x-m,h.y-m,h.z-m),M=new M3D.Vector3(h.x+m,h.y+m,h.z+m);new M3D.BoundingBox(T,M).IsInside(S)!=M3D.INSIDE&&(a=l.Center().Add(c.Multiply(l.Length()).Multiply(.8)),o.SetWorldPosition(a))}}}if(i.GetUpDataModelState()){c=i.getExplosiveType();var g=i.getExplosivePercent();this.GetExplosiveView().SetPercent(this,0,0,!1),-1!==c&&(this.GetExplosiveView().Reset(),this.GetExplosiveView().SetPercent(this,c,g,!1)),this.GetExplosiveView().explosivePercent=0,this.GetExplosiveView().explosiveStyle=-1;var v=i.GetInstanceAttributeMap();this.SetCurrentModelView(i);for(var C=0;C<v.Keys().length;C++){var _=v.Values()[C],A=this.GetShapeBySVLPath(_.path);if(A&&A.GetType()==M3D.ShapeType.SHAPE_MODEL){var E=A;E.SetVisible(_.visible);var G=_.placeMatrix;G.Equals(M3D.Matrix4.ZERO())||E.SetPlaceMatrix(G)}}}}this.GetSceneManager().GetSection().ClearPlanes();var P=r.GetSectionPlaneList();if(null!=P&&0<P.length)for(C=0;C<P.length;C++){(D=P[C]).GetEnable()&&D.SetEnable(!1)}var w=i.GetSectionPlaneIDList();if(0<w.length)for(C=0;C<P.length;C++)for(var D=P[C],x=0;x<w.length;x++)if(w[x]==D.GetID()){D.SetEnable(!0),this.sceneManager.GetSection().AddPlane(D);break}var R=this.GetSceneManager().GetNoteGroup();if(R){for(R.Size(),C=0;C<R.Size();C++){if(B=R.GetChild(C))(U=B.GetShape())&&U.SetVisible(!1)}var I=0;I=(F=i.GetNoteList()).length;for(C=0;C<F.length;C++){var L=F[C];for(x=0;x<R.Size();x++){if(B=R.GetChild(x))if((U=B.GetShape())&&L==B.GetID()){U.SetVisible(!0);break}}}}var N=this.GetSceneManager().GetAnnotationGroup();if(N){var O=N.Size();for(C=0;C<O;C++){if(B=N.GetChild(C))(U=B.GetShape())&&U.SetVisible(!1)}I=0;I=(F=i.GetNoteList()).length;for(C=0;C<I;C++)for(L=F[C],x=0;x<N.Size();x++){if(B=N.GetChild(x))if((U=B.GetShape())&&L==U.GetCreateID()){U.SetVisible(!0);break}}}var b=this.GetSceneManager().GetMeasureGroup();if(b){var V=b.Size();for(C=0;C<V;C++){if(B=b.GetChild(C))(U=B.GetShape())&&U.SetVisible(!1)}var F;I=0;I=(F=i.GetNoteList()).length;for(C=0;C<I;C++)for(L=F[C],x=0;x<b.Size();x++){var B,U;if(B=b.GetChild(x))if((U=B.GetShape())&&L==U.GetID()){U.SetVisible(!0);break}}}var H=this.GetSceneManager().GetExtendInfoManager(),k=H.GetModelPMIRef(this.GetModel().GetProtoTypeId());if(null!=k&&0<k.length)if(0===i.GetViewType())for(var z=0;z<k.length;z++){(W=H.pmiMap.Get(k[z]))&&W.SetVisible(!0)}else{for(z=0;z<k.length;z++){(W=H.pmiMap.Get(k[z]))&&W.SetVisible(!1)}for(C=0;C<i.GetPMIList().length;C++){var W;i.GetPMIList()[C];(W=H.pmiMap.Get(k[C]))&&W.SetVisible(!0)}}}else M3D.LOGE("modleViewId:%d not found!",e)},View.prototype.ShowModelViewAnimation=function(e){if(e&&this.pSAManager){this.pSAManager.GetCurSAID();var t=this.pSAManager.GetAnimationStepManager().GetBehaviorActionChgCam();t&&(t.DeleteAllAnimations(),e.GetUpDataCameraState())}},View.prototype.GetShapeBySVLPath=function(e){var t=M3D.PathHelper.SVLPathToM3D(e);return this.GetShapeByM3DPath(t)},View.prototype.GetShapeByM3DPath=function(e){return this.GetSceneManager().GetShape(e)},View.prototype.SetCurrentModelView=function(e){this.curModelView=e},View.prototype.GetCurrentModelView=function(){return this.curModelView?this.curModelView:this.GetDefaultModelView()},View.prototype.ShowAnyAnnotation=function(e){for(var t=this.GetSceneManager().GetAnnotationGroup().GetAnnotationIdList(),r=0,i=t;r<i.length;r++){i[r].SetVisible(!1)}for(var n=0;n<e.length;n++)for(var o=0;o<t.length;o++){var a=t[o];a.GetCreateID()===e[n]&&a.SetVisible(!0)}},View.prototype.ShowAnySign=function(e){for(var t=SView.ScreenUILayerManager.Instance().getHudModels(),r=0,i=t;r<i.length;r++){i[r].SetVisible(!1)}for(var n=0;n<e.length;n++)for(var o=0;o<t.length;o++){var a=e[n];Number(t[o].GetID())===a&&t[o].SetVisible(!0)}},View.prototype.ShowAllAnnotation=function(){for(var e=0,t=this.GetSceneManager().GetAnnotationGroup().GetAnnotationIdList();e<t.length;e++){t[e].SetVisible(!0)}},View.prototype.ShowAnnotationByType=function(e){for(var t=this.GetSceneManager().GetAnnotationGroup().GetAnnotationIdList(),r=this.GetSAnnotationManager().GetAnnotations(),i=0;i<r.length;i++)if(r[i].GetAnnotationType()===e)for(var n=0;n<t.length;n++)r[i].GetCreateID()===t[n].GetCreateID()&&t[n].SetVisible(!0)},View.prototype.HiddenAllAnnotation=function(){for(var e=0,t=this.GetSceneManager().GetAnnotationGroup().GetAnnotationIdList();e<t.length;e++){t[e].SetVisible(!1)}},View.prototype.ShowAllSign=function(){for(var e=0,t=SView.ScreenUILayerManager.Instance().getHudModels();e<t.length;e++){t[e].SetVisible(!0)}},View.prototype.HiddenAllSign=function(){for(var e=0,t=SView.ScreenUILayerManager.Instance().getHudModels();e<t.length;e++){t[e].SetVisible(!1)}},View.prototype.LoadModelViewList=function(e){console.log("LoadMV"+(new Date).toISOString());var t=new SView.ViewManager;return this.modleViewsList=t.GetModleViewList(e,this.modleViewsList),this.modleViewsList},View.prototype.GetModelViewsList=function(){return 0<this.modleViewsList.length?this.modleViewsList:this.GetModel().GetModelViewList()},View.prototype.getModelViews=function(){return 0<this.modleViewsList.length?this.modleViewsList:this.GetModel().GetModelViewList()},View.prototype.GetModelViewById=function(e){return this.GetModel().GetModleView(e)},View.prototype.GetModel=function(){return this.model},View.prototype.LoadAllUserViews=function(e){var t;t=this.LoadModelViewList(e);for(var r=0;r<t.length;r++){var i=t[r];i.SetUpDataCamera(!0),i.SetUpDataModel(!0),this.GetModel().AddModelView(i)}return!0,M3D.LOGI("viewCnt:%d",t.length),M3D.LOGI("View::LoadAllUserViews end. "),!0},View.prototype.AddModelView=function(){var e=(new Date).toISOString(),t=new M3D.ModleView;t.SetName(e),t.SetViewType(2);this.UpdateViewByCurrentScene(t),this.GetModel().AddModelView(t)},View.prototype.RemoveModelView=function(e){this.GetModel().RemoveModelView(e)},View.prototype.GetDefaultModelView=function(){for(var e=null,t=this.GetModel().GetModelViewList(),r=0;r<t.length;r++)if(t[r].GetViewType()===M3D.ViewTypeEnum.DefaultView){e=t[r],M3D.LOGI("DefaultModelView found!");break}return null==e&&((e=new M3D.ModleView).SetViewType(M3D.ViewTypeEnum.DefaultView),e.SetName("DefaultView"),this.GetModel().AddModelView(e)),e},View.prototype.SetDefaultModelView=function(e){for(var t=this.GetModel().GetModelViewList(),r=0;r<t.length;r++){if(t[r].GetViewType()===M3D.ViewTypeEnum.DefaultView){t[r].SetViewType(M3D.ViewTypeEnum.UserView),M3D.LOGI("DefaultModelView found!");break}t[r].GetID()===e&&t[r].SetViewType(M3D.ViewTypeEnum.DefaultView)}},View.prototype.UpdateViewByCurrentScene=function(e){var t=!1;if(!e)return t;if(e.SetUpDataCamera(!0),e.SetUpDataModel(!0),e.GetUpDataCameraState()){var r=this.GetSceneManager().GetCamera(),i=(new M3D.Camera).Clone(r);i.SetPosition(r.GetPosition()),i.SetRotation(r.GetRotation()),i.SetZoom(r.GetZoom());var n,o;n=r.GetOrthoSize().x,o=r.GetOrthoSize().y,i.SetOrthoSize(new M3D.Vector2(n,o)),i.SetOrthographic(r.IsOrthographic()),i.SetAspectRatio(r.GetAspectRatio()),i.SetFov(r.GetFov()),i.SetFarClip(r.GetFarClip()),i.SetNearClip(r.GetNearClip()),e.SetCamera(i),e.SetUpDataCamera(!0)}e.GetUpDataModelState();if(e.GetUpDataModelState()){var a=this.GetExplosiveView().explosiveStyle,s=this.GetExplosiveView().explosivePercent;e.setExplosiveType(a),e.setExplosivePercent(50*s);var l=new M3D.Map,h=[],u=this.GetSceneManager().GetModel();h.push(u),u.GetAllSubModels(h);for(var p=0;p<h.length;p++){var c=new M3D.InstanceAttribute,d=h[p];if(c.id=d.GetID(),c.path=M3D.PathHelper.M3DPathToSVLPath(d.GetSVLPath()),c.visible=d.IsVisible(),d.GetSubModelCount()<=0&&d!=u){var S=d.GetColor(),f=d.GetFaceMaterial(),m=new M3D.Color;if(f){switch(f.GetMaterialType()){case M3D.MaterialType.MaterialType_Phong:m=f.GetDiffuse();break;case M3D.MaterialType.MaterialType_Pbr:m=f.AlbedoColor();break;case M3D.MaterialType.MaterialType_MatCap:m=f.GetDiffuse()}c.hasColor=!0,c.insColor=m}else c.insColor=S?(c.hasColor=!0,d.GetColor()):(c.hasColor=!1,M3D.Color.GRAY())}else c.hasColor=!1;if(d.GetModelShape()){var y=new M3D.Matrix4(d.plcMatrix);c.placeMatrix=y}else c.placeMatrix=M3D.Matrix4.IDENTITY();l.Put(c.id,c)}e.setInstanceAttributeMap(l)}if(this.GetSceneManager().GetSectionNode()){var T=this.GetSceneManager().GetSection();if(T){u=this.GetSceneManager().GetModel();e.ClearSectionPlaneId();var M=T.GetPlaneList();if(M)for(p=0;p<M.length;p++){var g=M[p];if(g&&g.GetEnable()){var v=u.GetSectionPlaneList();if(v&&v.length,e.AddSectionPlaneId(g.GetID()),!u.GetSectionPlane(g.GetID())){var C=new M3D.SectionPlane;C.Copy(g),u.AddSectionPlane(C)}}}}}var _=[],A=this.GetSceneManager().GetExtendInfoManager(),E=A.GetModelPMIRef(this.GetModel().GetProtoTypeId());if(null!=E&&void 0!==E&&0<E.length)for(var G=0;G<E.length;G++){var P=A.pmiMap.Get(E[G]);P&&(P.IsVisible()&&_.push(P.GetID()))}e.SetPMIIds(_);var w=[],D=this.GetSceneManager().GetNoteGroup();if(M3D.LOGI("UpdateViewByCurrentScene::SHAPE_TEXT_NOTE"),0<D.Size()){M3D.LOGI("begin update textnote by current scene");var x=D.Size();M3D.LOGI("noteCount %d",x);for(p=0;p<x;p++){if((F=D.GetChild(p))&&F.GetType()==M3D.SHAPE_NODE){var R=F.GetShape();if(!F.IsVisible()||!R||!R.IsVisible())continue;if(R.GetType()==M3D.ShapeType.SHAPE_TEXT_NOTE){var I=R;w.push(I.GetID());var L=M3D.NoteFactory.TextNoteToXMLElement(this.GetSceneManager(),I);e.GetNoteDataList(M3D.ShapeType.SHAPE_TEXT_NOTE).push(L)}else if(R.GetType()==M3D.ShapeType.SHAPE_VOICE_NOTE){M3D.LOGI("UpdateViewByCurrentScene::SHAPE_VOICE_NOTE");I=R;w.push(I.GetID())}else if(R.GetType()==M3D.ShapeType.SHAPE_SEQUENCE_NUMBER_NOTE){M3D.LOGI("UpdateViewByCurrentScene::SHAPE_SEQUENCE_NUMBER_NOTE");I=R;w.push(I.GetID())}else if(R.GetType()==M3D.ShapeType.SHAPE_THREED_GESTURE_NOTE){M3D.LOGI("UpdateViewByCurrentScene::SHAPE_THREED_GESTURE_NOTE");I=R;w.push(I.GetID())}}}var N=this.GetSceneManager().GetAnnotationGroup();if(N&&0<N.Size()){var O=N.Size();for(p=0;p<O;p++){if((F=N.GetChild(p))&&F.GetType()==M3D.SHAPE_NODE)(R=F.GetShape())&&F.IsVisible()&&R.IsVisible()&&w.push(R.GetCreateID())}}var b=this.GetSceneManager().GetMeasureGroup();if(b&&0<b.Size()){var V=b.Size();for(p=0;p<V;p++){var F;if((F=b.GetChild(p))&&F.GetType()==M3D.SHAPE_NODE)(R=F.GetShape())&&F.IsVisible()&&R.IsVisible()&&w.push(R.GetID())}}e.SetNoteIds(w)}if(null!=M3D.SectionOperator.Instance){a=M3D.SectionOperator.Instance.direction;var B=100*M3D.SectionOperator.Instance.fPercentage,U=M3D.SectionOperator.Instance.directionX,H=M3D.SectionOperator.Instance.fPercentageX,k=M3D.SectionOperator.Instance.directionY,z=M3D.SectionOperator.Instance.fPercentageY,W=M3D.SectionOperator.Instance.directionZ,Y=M3D.SectionOperator.Instance.fPercentageZ,X=M3D.Parameters.Instance().showSection,j=this.GetSceneManager().GetSectionNode().GetSection().IsShowCappingPlane(),K=this.GetSceneManager().GetSectionNode().GetSection().IsReverseClipping();e.SetSectionPlaneDirection(a),e.SetSectionPlanePercentage(B),e.SetSectionPlaneDirectionAndPercentage(U,k,W,H,z,Y),e.SetShowClipSectionPlane(X),e.SetShowSectionCappingPlane(j),e.SetReverseClipping(K)}return M3D.LOGI("end update textnote by current scene"),t=!0},View.prototype.CreateDefaultView=function(e){this.enableCreateDefaultView=e},View.prototype.GetMVListXMLStr=function(){for(var e="",t=0;t<this.modleViewsList.length;t++){this.modleViewsList[t].GetInstanceAttributeMap();e+='<View ID="'+this.modleViewsList[t].GetID()+'" Name="'+this.modleViewsList[t].GetName()+'" Type="'+this.modleViewsList[t].GetViewType()+'"> <Camera '+this.modleViewsList[t].GetCamera().toString()+'/> <BackgroundColor/><Notes>< GestureNote ID= "0" Created= "" UserID= "1" Layer= "0" > <ProjectMatrix/> < Polylines /> </GestureNote> < /Notes>  < PMIs />  <SectionPlanes/><Instances></Instances></View><Lights/>'}return"<SVL><Model><Notes/><Views>"+e+"</Views></Model></SVL>"},View.prototype.SetSelectType=function(e){if(null!==this.sceneManager)return this.sceneManager.SetSelectType(e)},View.prototype.PreSelect=function(e,t){var r=this.GetSceneManager().GetShape(e);null!=r&&(t?r.SetSelected(!0):r.SetSelected(!1))},View.prototype.SelectTempShape=function(e,t,r,i){var n=0,o=new M3D.Vector2(e,t),a=M3D.ShapeHelper.SelectShape(o,r,i,this.GetSceneManager());return null!=a&&(n=a.GetID()),n},View.prototype.UpdatePropertyImagePos=function(e,t,r){if(null!=e){var i=new M3D.Vector2(t,r);M3D.NoteFactory.UpdatePerpNoteImagePos(e,i,this.GetSceneManager())}},View.prototype.UpdateAnnotationImagePos=function(e,t,r){if(null!=e&&e){var i=new M3D.Vector2(t,r);M3D.AnnotationFactory.UpdateNoteImagePos(e,i,this.GetSceneManager())}},View.prototype.UpdateMeasureImagePos=function(e,t,r){if(null!==e)if(e instanceof M3D.TextNote||e instanceof M3D.SequenceNumberNote){var i=new M3D.Vector2(t,r);M3D.Parameters.Instance().noteHiddenLine||M3D.NoteFactory.UpdateNoteImagePos(e,i,this.GetSceneManager())}else i=new M3D.Vector2(t,r)},View.prototype.FrameSelectShape=function(e,t,r,i,n){var o=[];return null!==this.sceneManager&&(o=this.sceneManager.GetFramePickShape(e,t,r,i,n)),o},View.prototype.getDrawMode=function(){return this.curDrawMode},View.prototype.setDrawMode=function(e){window,this.curDrawMode=e;var t=this.GetSceneManager().GetRenderManager().GetRenderEffect();if(t){var r=t.GetRenderableTypeFilter();switch(e){case 0:null!=this.model&&this.model.ResetAlpha(),r.SetRenderTypes(M3D.RenderableTypeGroup.RENDERDATA_NORMALEFFCT),r.Close(M3D.RenderableType.RGT_EDGELINE);break;case 1:case 2:r.SetRenderTypes(M3D.RenderableTypeGroup.RENDERDATA_NORMALEFFCT),r.Close(M3D.RenderableType.RGT_SOLID),r.Close(M3D.RenderableType.RGT_TRANSPARENT);break;case 3:r.SetRenderTypes(M3D.RenderableTypeGroup.RENDERDATA_NORMALEFFCT),r.Close(M3D.RenderableType.RGT_SOLID),r.Open(M3D.RenderableType.RGT_EDGELINE);break;case 4:r.SetRenderTypes(M3D.RenderableTypeGroup.RENDERDATA_NORMALEFFCT),1==M3D.Parameters.Instance().IsShowTrilateralEdge&&r.Open(M3D.RenderableType.RGT_TRILINE);break;case 5:r.SetRenderTypes(M3D.RenderableTypeGroup.RENDERDATA_NORMALEFFCT);break;case 6:null!=this.model&&this.model.ResetAlpha();break;case 7:M3D.Parameters.Instance().IsShowBox=!M3D.Parameters.Instance().IsShowBox,1==M3D.Parameters.Instance().IsShowBox?r.Open(M3D.RenderableType.RGT_BOX):0==M3D.Parameters.Instance().IsShowBox&&r.Close(M3D.RenderableType.RGT_BOX)}1==M3D.Parameters.Instance().IsShowTrilateralEdge?r.Open(M3D.RenderableType.RGT_TRILINE):0==M3D.Parameters.Instance().IsShowTrilateralEdge&&r.Close(M3D.RenderableType.RGT_TRILINE),1==M3D.Parameters.Instance().IsShowTransparent?null!=this.model&&this.model.SetAlpha(M3D.Parameters.Instance().Alpha):0==M3D.Parameters.Instance().IsShowTransparent&&null!=this.model&&this.model.ResetAlpha(),1==M3D.Parameters.Instance().IsShowBox?r.Open(M3D.RenderableType.RGT_BOX):0==M3D.Parameters.Instance().IsShowBox&&r.Close(M3D.RenderableType.RGT_BOX),1==M3D.Parameters.Instance().IsShowPMIs?r.Open(M3D.RenderableType.RGT_PMI):0==M3D.Parameters.Instance().IsShowPMIs&&r.Close(M3D.RenderableType.RGT_PMI),this.GetSceneManager().GetRenderManager().RequestRedraw()}},View.prototype.RequestDraw=function(){this.sceneManager.GetRenderManager().UseLowQuality(!0),this.sceneManager.GetRenderManager().RequestRedraw()},View.prototype.GetAllPMIs=function(e){var t=this.GetSceneManager().GetExtendInfoManager();return null!=e&&null!=e?t.GetModelPMIRef(e.GetProtoTypeId()):t.GetModelPMIRef(this.GetModel().GetProtoTypeId())},View.prototype.SetWalkThroughParameters=function(e){var t=JSON.parse(e);M3D.CookieHelper.AddCookie("walkThroughSpeed",t.WalkThroughSpeed,"30"),M3D.CookieHelper.AddCookie("walkThroughUpdirection",t.UpDirection,"30"),M3D.CookieHelper.AddCookie("walkThroughFov",t.CameraFov,"30")},View.prototype.GetWalkThroughParameters=function(){var e=M3D.CookieHelper.GetCookie("walkThroughSpeed"),t=M3D.CookieHelper.GetCookie("walkThroughFov"),r='{"Type":"1","WalkThroughSpeed":"'+e+'","UpDirection":"'+M3D.CookieHelper.GetCookie("walkThroughUpdirection")+'","CameraFov":"'+t+'"}';return JSON.parse(r)},View.prototype.WalkThrough=function(e,t,r,i){},View.prototype.CancelWalkThrough=function(){this.SetUsingTouchHandlerType(M3D.TouchHandlerType.HANDLER_COMMON)},View.prototype.GetUnitScale=function(){return this.fUnitScale},View.prototype.SetUnitScale=function(e){this.fUnitScale=e},View.prototype.SetParameter=function(e,t){M3D.Parameters.Instance().SetParameter(e,t)},View.prototype.GetParameter=function(e){return M3D.Parameters.Instance().GetParamter(e)},View.prototype.SetParameters=function(jsonStr){var parameterJson=eval("("+jsonStr+")");for(var key in parameterJson)null!==this.GetParameter(key)&&void 0!==this.GetParameter(key)&&this.SetParameter(key,parameterJson[key])},View.prototype.GetParameters=function(){return JSON.stringify(M3D.Parameters.Instance())},View.prototype.SetOrbitMode=function(e){if(null!=e){switch(e){case 0:this.commonTouchHandler.freeViewMode=!0,this.commonTouchHandler.controlLockXY=!1,this.commonTouchHandler.oribitMode=!1;break;case 1:this.commonTouchHandler.freeViewMode=!1,this.commonTouchHandler.controlLockXY=!1,this.commonTouchHandler.oribitMode=!0;break;case 2:this.commonTouchHandler.freeViewMode=!1,this.commonTouchHandler.controlLockXY=!0,this.commonTouchHandler.oribitMode=!1;break;default:this.commonTouchHandler.freeViewMode=!0,this.commonTouchHandler.controlLockXY=!1,this.commonTouchHandler.oribitMode=!1}this.commonTouchHandler.oberveMode=e}},View.prototype.Restore=function(e,t){if(void 0===e&&(e=null),void 0===t&&(t=0),e)for(var r=0;r<e.length;r++){var i=e[r];switch(t){case 0:i.Restore(!0);break;case 1:i.ResetMovement();break;case 2:i.ResetColor();break;case 3:i.SetVisible(i.IsOrigVisible())}}else{i=this.GetModel();switch(t){case 0:i.Restore(!0);break;case 1:i.ResetMovement();break;case 2:i.ResetColor();break;case 3:i.SetVisible(i.IsOrigVisible())}}},View.prototype.Focus=function(e){void 0===e&&(e=[]),new M3D.SelectionOperator(this).Foces(e)},View.prototype.RestoreRotationCenter=function(){this.GetSceneManager().RestoreRotationCenter()},View.prototype.Move=function(e,t){this.startLinkAni=!0;var r=new M3D.Vector3,i=new M3D.Quaternion,n=new M3D.Vector3;e.GetWorldTransform().Decompose(r,i,n);var o=t,a=i,s=[],l=[];M3D.M3DTOOLS.VecSlerp(r,o,this.interpolatorCount,s),M3D.M3DTOOLS.RotationSlerp(i,a,this.interpolatorCount,l),this.updateModelMap[e.GetUserSVLPath()]=[s,l];new M3D.Vector3,new M3D.Vector3;M3D.AnimationHelper.AddTrochoid([r,o],"ModelViewTrochoid",this),this.StartAnimation(this.InterPolatorModelWorld,this)},View.prototype.SetModelRandomColor=function(){var e=this.GetModel();this.SetRandomColor(e)},View.prototype.SetRandomColor=function(e){if(e){var t=e.GetSubModels();if(0!==e.GetSubModels().length)for(var r=0;r<t.length;r++){var i=t[r];n=this.GetModelRandomColor(i);i.SetInitColor(n),this.SetRandomColor(i)}else{var n=this.GetModelRandomColor(e);e.SetInitColor(n)}}},View.prototype.GetModelRandomColor=function(e){var t=e.GetColor(),r=1;return t&&(r=t.a),new M3D.Color(Math.random(),Math.random(),Math.random(),r)},View}();M3D.View=View}(M3D||(M3D={})),function(k){var e=function(){function H(){}return H.createTextNote=function(e,t,r,i){var n;return(n=this.createPntTextNote(e,t,r,i))&&H.AddNoteToScene(i,n),n},H.createPropertyTextNote=function(e,t,r,i,n){var o;return(o=this.createPropTextNote(e,t,r,i,n))&&H.AddNoteToScene(r,o),o},H.createVoiceNote=function(e,t,r){var i;return(i=this.createPntVoiceNote(e,t,r))&&this.AddNoteToScene(r,i),i},H.CreateSequenceNumberNote=function(e,t,r,i){var n;return(n=this.createPntSequenceNumberNote(e,t,r,i))&&this.AddNoteToScene(i,n),n},H.createPropTextNote=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r,i,n,o,a,s,l,h,u=new k.TextNote,p=new k.Vector3;if(e[1]instanceof k.Vector2){if(r=e[3],o=e[2],l=e[1],!(s=r.GetShape(e[0]))||s.GetType()!==k.ShapeType.SHAPE_POINT_HANDLE)return u;if(n=s.GetPosition(),!r.GetPickPoint(l,p,!1))return k.LOGE("MeasureFactory::createPntToPntDistance shape is NULL"),u;u.SetTextPos(p)}else n=e[0],o=e[1],r=e[2],a=e[3],h=e[4],u.SetTextPos(n);i=r.GetCamera().WorldToScreenPoint(n),u.SetNotePos(n);r.GetSceneBox().Length();var c=new k.Point(n);c.SetDrawType(1),c.SetSize(.8),console.log("point1",n.Tostring());var d=new k.Point(p);d.SetDrawType(1),d.SetSize(.8),console.log("point2",p.Tostring());var S,f=r.GetCamera().GetViewPort().GetScreenRay(i.x,i.y),m=new k.Plane(f.GetDirection(),n);if(e[1]instanceof k.Vector2)S=m.Project(p);else{var y=new k.Vector3;if(h)y=h;else{var T,M;T=800*Math.random()+71,M=500*Math.random()+71,r.GetPickPoint(new k.Vector2(T,M),y,!1)}S=y}var g=new k.Line3D(n,S);console.log("pntInPlane",S.Tostring());var v=new k.Color(.03,0,38,.73);if(g.SetColor(v),g.SetName("TextImageLeader"),u.SetTextPos(S),k.Parameters.Instance().noteHiddenLine||(u.AddLine(g),u.AddPoint(c)),e[1]instanceof k.Vector2){var C=Object.keys(o).length,_=new k.Shape2DSet,A=0;for(var E in o){var G=k.Color.WHITE().Clone(),P=k.Color.WHITE().Clone(),w=k.Color.BLACK().Clone(),D=k.Color.BLACK().Clone(),x=(k.Color.GREEN().Clone(),k.Color.RED().Clone(),k.Color.BLUE().Clone(),new k.Vector2(1,1+100*A)),R=new k.Vector2(260,100+100*A);k.MeasureDisplayHelper.createRectImage(_,x,R,450,G,P,w,D,E,o[E],16,!0),A++}k.MeasureDisplayHelper.addImageToMemory(r,null,_,p,5.5,C+2,u)}else{a&&(k.MeasureDisplayHelper.createNoteTextsImageN(r,null,o,S,u),u.AddImage(null));var I=new k.ComText,L=new k.CText,N="";for(var O in o)N+=O+o[O];L.SetText(N),I.AddCText(L),u.ComTexts.push(I)}return u},H.createPntTextNote=function(e,t,r,i){var n=null,o=i.GetShape(e);if(o&&o.GetType()===k.ShapeType.SHAPE_POINT_HANDLE){n=new k.TextNote;var a=o.GetPosition();n.SetNotePos(a);var s=new k.Vector3;if(i.GetPickPoint(t,s,!1)){n.SetTextPos(s);var l=r,h=(i.GetSceneBox().Length(),new k.Point(a));h.SetDrawType(1),h.SetSize(.8),console.log("point1",a.Tostring());var u=new k.Point(s);u.SetDrawType(1),u.SetSize(.8),console.log("point2",s.Tostring());var p=i.GetCamera().GetViewPort().GetScreenRay(t.x,t.y),c=new k.Plane(p.GetDirection(),a).Project(s),d=new k.Line3D(a,c);console.log("pntInPlane",c.Tostring());var S=new k.Color(.03,.38,.73);d.SetColor(S),d.SetName("TextImageLeader"),n.SetTextPos(c);var f=new k.Texts2D;f.setSize(14),f.setTexts("内容");var m=new k.Texts2D;m.setSize(14),m.setTexts(l);var y=[f,m];k.MeasureDisplayHelper.createNoteTextsImageN(i,null,y,c,n),n.AddLine(d),n.AddImage(null),n.AddPoint(h);var T=new k.ComText,M=new k.CText;M.SetText(r),T.AddCText(M),n.ComTexts.push(T)}else k.LOGE("MeasureFactory::createPntToPntDistance shape is NULL");return n}},H.createPntVoiceNote=function(e,t,r){var i=null,n=new k.Vector3;if(r.GetPickPoint(e,n,!1)){var o=new k.Vector2(1,1);i=new k.VoiceNote(n,k.ShapeHelper.GetCommonSize(r,o),r)}return i},H.createPntSequenceNumberNote=function(e,t,r,i){var n=null,o=i.GetShape(e);if(o&&o.GetType()==k.ShapeType.SHAPE_POINT_HANDLE){n=new k.SequenceNumberNote;var a=o.GetPosition();n.SetNotePos(a);var s=new k.Vector3;if(i.GetPickPoint(t,s,!1)){var l=r,h=(i.GetSceneBox().Length(),new k.Point(a));h.SetDrawType(1),h.SetSize(.8);var u=new k.Point(s);u.SetDrawType(1),u.SetSize(.8);var p=i.GetCamera().GetViewPort().GetScreenRay(t.x,t.y),c=new k.Plane(p.GetDirection(),a).Project(s),d=new k.Line3D(a,c),S=new k.Color(.03,.38,.73);d.SetColor(S),d.SetName("SequenceNumberImageLeader"),n.SetTextPos(c);var f=new k.Texts2D;f.setSize(14),f.setTexts(l);k.MeasureDisplayHelper.CreateSequenceNumberImage(i,null,f,c,n),n.AddLine(d),n.AddImage(null),n.AddPoint(h);var m=new k.ComText,y=new k.CText;y.SetText(r),m.AddCText(y),n.ComTexts.push(m),n.SetFrontShow(!1)}}return n},H.UpdatePerpNoteImagePos=function(e,t,r){if(null!=e&&null!=r){var i=e.GetSceneNode(),n=void 0;n=i?i.GetWorldTransform().Clone():k.Matrix3x4.IDENTITY().Clone();var o=e.GetTextPos(),a=e.GetWorldTextPos(),s=r.GetCamera().GetViewPort().GetScreenRay(t.x,t.y),l=new k.Plane(s.GetDirection().Clone(),a).Project(s.GetOrigin()).Clone();o;var h=n.Inverse().Multiply(l);e.SetTextPos(h),r.GetRenderManager().RequestRedraw();for(var u=e.LineList,p=0;p<u.length;p++){var c=u[p];c&&("TextImageLeader"!=c.GetName()&&"SequenceNumberImageLeader"!=c.GetName()||(c.EndPoint=h.Clone()))}}},H.UpdateNoteImagePos=function(e,t,r){var i;if(null!=e&&null!=r){for(var n=e.GetImageBoards(),o=0;o<n.length;o++){var a=n[o];if(a){var s=a.GetPosition().Clone(),l=r.GetCamera().GetViewPort().GetScreenRay(t.x,t.y);if(s=new k.Plane(l.GetDirection().Clone(),s).Project(l.GetOrigin()).Clone(),a.SetPosition(s),i=s,e.GetType()==k.ShapeType.SHAPE_TEXT_NOTE)e.SetTextPos(s);else if(e.GetType()==k.ShapeType.SHAPE_SEQUENCE_NUMBER_NOTE){e.SetTextPos(s)}}r.GetRenderManager().RequestRedraw()}var h=e.LineList;for(o=0;o<h.length;o++){var u=h[o];u&&("TextImageLeader"!=u.GetName()&&"SequenceNumberImageLeader"!=u.GetName()||(u.EndPoint=i))}}},H.UpdateNoteTextValue=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=e[2],i=e[0];if("string"==typeof e[1])for(var n=e[1],o=i.GetImageBoards(),a=0;a<o.length;a++){if(d=o[a]){var s=d.GetPosition();d=null;var l=new Array,h=new k.Texts2D;h.setSize(14),h.setTexts("内容"),l.push(h);var u=new k.Texts2D;u.setSize(14),u.setTexts(n),l.push(u);if(i.GetType()==k.ShapeType.SHAPE_SEQUENCE_NUMBER_NOTE)if(k.MeasureDisplayHelper.CreateSequenceNumberImage(r,null,u,s,o,a),i.ComTexts.length<1){var p=new k.ComText;(c=new k.CText).SetText(n),p.AddCText(c),i.ComTexts.push(p)}else i.ComTexts[0].GetCText(0).SetText(n);else if(i.GetType()==k.ShapeType.SHAPE_ANNOTATION_NOTE){if(k.MeasureDisplayHelper.createNoteTextsImageN(r,null,l,s,o,a),i.ComTexts.length<1){var c;p=new k.ComText;(c=new k.CText).SetText(n),p.AddCText(c),i.ComTexts.push(p)}else i.ComTexts[0].GetCText(0).SetText(n)}r.GetRenderManager().RequestRedraw()}}else{var d,S=e[1];if(null!=i&&null!=r)if(d=(o=i.GetImageBoards())[0]){s=d.GetPosition();d=null;var f=Object.keys(S).length,m=new k.Shape2DSet,y=0;for(var T in S){var M=k.Color.WHITE().Clone(),g=k.Color.WHITE().Clone(),v=k.Color.BLACK().Clone(),C=k.Color.BLACK().Clone(),_=(k.Color.GREEN().Clone(),k.Color.RED().Clone(),k.Color.BLUE().Clone(),new k.Vector2(1,1+100*y)),A=new k.Vector2(260,100+100*y);k.MeasureDisplayHelper.createRectImage(m,_,A,450,M,g,v,C,T,S[T],30,!0),y++}k.MeasureDisplayHelper.addImageToMemory(r,d,m,s,5.5,f+2,i)}}},H.AddNoteToScene=function(e,t){var r=!1;if(null==e||null==t)return r;var i=e.GetNoteGroup(),n=new k.ShapeNode;return n.SetShape(t),n.SetName(i.GetName()+"|"+new String(n.GetID())),i.AddChild(n),e.AddShapeIDToMap(t),e.GetRenderManager().RequestRedraw(),r=!0},H.CreateThreeDGestureNote=function(e,t){for(var r=new k.ThreeDGesturesNote,i=(t.GetCamera(),e.m_pointSet.length),n=0;n<i;n++){var o=e.m_pointSet[n],a=e.m_colorSet[n];r.GetOriginalProjectColors().push(a);var s=e.m_lineWidthSet[n];r.GetOriginalProjectWidths().push(s);var l=o.GetPointList(),h=l.length;if(h<2)return null;for(var u=[],p=0;p<h;p++){var c=new k.Vector3,d=new k.Vector2(l[p].x,l[p].y);t.GetPickPoint(d,c,!1)&&u.push(c)}r.GetOriginalProjectPns().push(u);var S=[];S=this.InsectPoint(t,l,u,S);for(var f=0;f<S.length;f++)for(p=0;p<S[f].length;p++){var m=new k.Line3D(S[f][p],S[f][p+1]);m.SetColor(a),m.SetLineWidth(s),r.AddLine(m)}}return r&&(r.SetIsShowSpacePoint(k.Parameters.Instance().m_isShowSpacePoint),r.SetFrontShow(!0),this.AddNoteToScene(t,r)),r},H.InsectPoint=function(e,t,r,i){for(var n=t.length,o=0;o<n-1;o++){var a=[],s=new k.Vector2(t[o].x,t[o].y),l=new k.Vector2(t[o+1].x,t[o+1].y).Sub(s),h=l.Length()/1;l.Normalize();for(var u=0;u<=1;u++){var p=l.Multiply(u*h).Add(s),c=new k.Vector3;(k.Parameters.Instance().m_isShowSpacePoint?e.GetPickPoint(p,c,!1):e.GetPickPoint(p,c,!0))&&a.push(c)}0<a.length&&i.push(a)}return i},H.TextNoteToXMLElement=function(e,t){var r=document,i=r.createElement(H.Serializer_XML_Element_TextNote);i.setAttribute(H.Serializer_XML_Attribute_ID,String(t.GetID())),i.setAttribute(H.Serializer_XML_Attribute_IsParallelScreen,String(t.IsParallelScreen())),i.setAttribute(H.Serializer_XML_Attribute_IsFix,String(t.IsFix())),i.setAttribute(H.Serializer_XML_Attribute_Visible,String(t.IsVisible()));var n=r.createElement(H.Serializer_XML_Element_Color);i.appendChild(n);var o=t.GetColor();n.setAttribute(H.Serializer_XML_Attribute_R,String(o.r)),n.setAttribute(H.Serializer_XML_Attribute_G,String(o.g)),n.setAttribute(H.Serializer_XML_Attribute_B,String(o.b));var a=r.createElement(H.Serializer_XML_Element_Leaders);i.appendChild(a);var s=r.createElement(H.Serializer_XML_Element_Leader);s.setAttribute(H.Serializer_XML_Attribute_Type,String(1)),a.appendChild(s);var l=r.createElement(H.Serializer_XML_Element_Terminator);s.appendChild(l),l.setAttribute(H.Serializer_XML_Attribute_Type,String(4)),l.setAttribute(H.Serializer_XML_Attribute_Width,String(3)),l.setAttribute(H.Serializer_XML_Attribute_Height,String(1));var h=r.createElement(H.Serializer_XML_Element_Location);l.appendChild(h),h.setAttribute(H.Serializer_XML_Attribute_X,String(0)),h.setAttribute(H.Serializer_XML_Attribute_Y,String(0)),h.setAttribute(H.Serializer_XML_Attribute_Z,String(0));var u=r.createElement(H.Serializer_XML_Element_Direction);l.appendChild(u),u.setAttribute(H.Serializer_XML_Attribute_X,String(-.7)),u.setAttribute(H.Serializer_XML_Attribute_Y,String(.7)),u.setAttribute(H.Serializer_XML_Attribute_Z,String(0));var p=r.createElement(H.Serializer_XML_Element_Polyline);s.appendChild(p),p.setAttribute(H.Serializer_XML_Attribute_ID,String(0)),p.setAttribute(H.Serializer_XML_Attribute_Type,String(1)),p.setAttribute(H.Serializer_XML_Attribute_Min,String(0)),p.setAttribute(H.Serializer_XML_Attribute_Max,String(0));var c=r.createElement(H.Serializer_XML_Element_Point);p.appendChild(c),c.setAttribute(H.Serializer_XML_Attribute_X,String(t.GetNotePos().x)),c.setAttribute(H.Serializer_XML_Attribute_Y,String(t.GetNotePos().y)),c.setAttribute(H.Serializer_XML_Attribute_Z,String(t.GetNotePos().z));c=r.createElement(H.Serializer_XML_Element_Point);p.appendChild(c),c.setAttribute(H.Serializer_XML_Attribute_X,String(t.GetTextPos().x)),c.setAttribute(H.Serializer_XML_Attribute_Y,String(t.GetTextPos().y)),c.setAttribute(H.Serializer_XML_Attribute_Z,String(t.GetTextPos().z));var d=r.createElement(H.Serializer_XML_Element_ExtendLines);i.appendChild(d);var S=r.createElement(H.Serializer_XML_Element_CompositeTexts);if(i.appendChild(S),0<t.ComTexts.length){var f=r.createElement(H.Serializer_XML_Element_CompositeText);S.appendChild(f);var m=r.createElement(H.Serializer_XML_Element_Texts);f.appendChild(m);var y=r.createElement(H.Serializer_XML_Element_Text);m.appendChild(y),y.setAttribute(H.Serializer_XML_Attribute_Value,t.ComTexts[0].GetCText(0).GetText());var T=r.createElement(H.Serializer_XML_Element_TextStyle);y.appendChild(T);var M=r.createElement(H.Serializer_XML_Element_CharHeight);T.appendChild(M);t.ComTexts[0].GetCText(0).GetCharWidthHeight();var g=r.createTextNode(String(15));M.appendChild(g);var v=r.createElement(H.Serializer_XML_Element_LineSpacing);T.appendChild(v);g=r.createTextNode(String(0));v.appendChild(g);var C=r.createElement(H.Serializer_XML_Element_Font);T.appendChild(C),C.setAttribute(H.Serializer_XML_Attribute_Name,String(e.GetSceneBox().Length()/20));var _=r.createElement(H.Serializer_XML_Element_UsageType);T.appendChild(_),_.setAttribute(H.Serializer_XML_Attribute_Name,String(2));h=r.createElement(H.Serializer_XML_Element_Location);y.appendChild(h);var A=String(t.GetNotePos().x)+" "+String(t.GetNotePos().y)+" "+String(t.GetNotePos().z);g=r.createTextNode(A);h.appendChild(g);var E=r.createElement(H.Serializer_XML_Element_Rotation);y.appendChild(E);g=r.createTextNode("1.000000 0.000000 0.000000 0.000000 1.000000 0.000000");E.appendChild(g);var G=r.createElement(H.Serializer_XML_Element_OuterBox);m.appendChild(G);g=r.createTextNode("1.000000 1.000000 1.000000-1.000000 -1.000000 -1.000000");G.appendChild(g)}var P=r.createElement(H.Serializer_XML_Element_Attributes);return i.appendChild(P),i.outerHTML},H.CreateTextNoteFromXMLElement=function(e,t){var r,i,n,o,a=new k.TextNote;if(0==t.length)return a;var s=t.firstChild;if(null==s)return null;s.getAttribute(H.Serializer_XML_Attribute_ID);var l=Boolean(s.getAttribute(H.Serializer_XML_Attribute_IsParallelScreen));a.SetParallelScreen(l);var h=Boolean(s.getAttribute(H.Serializer_XML_Attribute_IsFix));a.SetFix(h);var u=Boolean(s.getAttribute(H.Serializer_XML_Attribute_Visible));a.SetVisible(u);var p=s.getElementsByTagName(H.Serializer_XML_Element_Leaders)[0];if(p){var c=p.getElementsByTagName(H.Serializer_XML_Element_Leader)[0];if(c){var d=c.getElementsByTagName(H.Serializer_XML_Element_Polyline)[0];if(d){for(var S=d.getElementsByTagName(H.Serializer_XML_Element_Point),f=new Array,m=0;m<S.length;m++){var y=new k.Vector3;y.x=Number(S[m].getAttribute(H.Serializer_XML_Attribute_X)),y.y=Number(S[m].getAttribute(H.Serializer_XML_Attribute_Y)),y.z=Number(S[m].getAttribute(H.Serializer_XML_Attribute_Z)),f.push(y)}n=f[0],o=f[1],a.SetNotePos(f[0]),a.SetTextPos(f[1])}}}var T=s.getElementsByTagName(H.Serializer_XML_Element_CompositeTexts)[0];if(T){var M=T.getElementsByTagName(H.Serializer_XML_Element_CompositeText)[0];if(M){var g=M.getElementsByTagName(H.Serializer_XML_Element_Texts)[0];if(g){var v=g.getElementsByTagName(H.Serializer_XML_Element_Text)[0],C=v.getAttribute(H.Serializer_XML_Attribute_Value);if(i=C,0<a.ComTexts.length){(_=new k.CText).SetText(C),a.ComTexts[0].AddCText(_)}else{var _,A=new k.ComText;(_=new k.CText).SetText(C),A.AddCText(_),a.ComTexts.push(A)}if(v){var E=v.getElementsByTagName(H.Serializer_XML_Element_TextStyle)[0];if(E){var G=E.getElementsByTagName(H.Serializer_XML_Element_CharHeight)[0];if(G){var P="1";P=""==G.innerHTML?"15":G.innerHTML,""!==G.textContent&&void 0!==G.textContent&&(P=G.textContent);var w=Number(P);w<1&&(w=15),r=w}}var D=v.getElementsByTagName(H.Serializer_XML_Element_Location)[0],x=(""!==D.innerHTML&&void 0!==D.innerHTML?D.innerHTML:""!==D.textContent&&void 0!==D.textContent?D.textContent:"1.222 1.222 1.222").split(" ");if(3==x.length){var R=Number(x[0]),I=Number(x[1]),L=Number(x[2]);new k.Vector3(R,I,L)}}}}}var N=new k.Line3D(n,o);N.SetName("TextImageLeader");var O=new k.Color(.03,.38,.73);N.SetColor(O);var b=new k.Point(n);b.SetDrawType(1),b.SetSize(.8);var V=new k.Point(o);V.SetDrawType(1),V.SetSize(.8);var F=new Array,B=new k.Texts2D;B.setTexts("内容"),B.setSize(r),F.push(B);var U=new k.Texts2D;U.setTexts(i),U.setSize(r),F.push(U);return a.AddLine(N),a.AddPoint(b),k.MeasureDisplayHelper.createNoteTextsImageN(e,null,F,o,a),a.SetFrontShow(!1),a&&H.AddNoteToScene(e,a),a},H.Serializer_XML_Element_SVL="svl",H.Serializer_XML_Element_Header="header",H.Serializer_XML_Element_Version="version",H.Serializer_XML_Element_Author="author",H.Serializer_XML_Element_Created="created",H.Serializer_XML_Element_Generator="generator",H.Serializer_XML_Element_Model="model",H.Serializer_XML_Element_Users="users",H.Serializer_XML_Element_User="user",H.Serializer_XML_Element_Notes="notes",H.Serializer_XML_Element_TextNote="textnote",H.Serializer_XML_Element_VoiceNote="voicenote",H.Serializer_XML_Element_SequenceNote="sequencenote",H.Serializer_XML_Element_ThreeDGestureNote="threedgestureNote",H.Serializer_XML_Element_Color="color",H.Serializer_XML_Element_VoiceData="voicedata",H.Serializer_XML_Element_ThreeDGestureNoteLine="threedgestureNoteLine",H.Serializer_XML_Element_Leaders="leaders",H.Serializer_XML_Element_Leader="leader",H.Serializer_XML_Element_Terminator="terminator",H.Serializer_XML_Element_Location="location",H.Serializer_XML_Element_Direction="direction",H.Serializer_XML_Element_Polyline="polyline",H.Serializer_XML_Element_Point="point",H.Serializer_XML_Element_ExtendLines="extendLines",H.Serializer_XML_Element_CompositeTexts="compositetexts",H.Serializer_XML_Element_CompositeText="compositetext",H.Serializer_XML_Element_Texts="texts",H.Serializer_XML_Element_Text="text",H.Serializer_XML_Element_TextStyle="textstyle",H.Serializer_XML_Element_CharHeight="charheight",H.Serializer_XML_Element_LineSpacing="linespacing",H.Serializer_XML_Element_Font="font",H.Serializer_XML_Element_UsageType="usagetype",H.Serializer_XML_Element_Rotation="rotation",H.Serializer_XML_Element_OuterBox="outerbox",H.Serializer_XML_Element_ProjectMatrix="projectmatrix",H.Serializer_XML_Element_Attributes="attributes",H.Serializer_XML_Element_Attribute="attribute",H.Serializer_XML_Attribute_ID="id",H.Serializer_XML_Attribute_UserID="userid",H.Serializer_XML_Attribute_Created="created",H.Serializer_XML_Attribute_IsParallelScreen="isparallelscreen",H.Serializer_XML_Attribute_IsFix="isfix",H.Serializer_XML_Attribute_Visible="visible",H.Serializer_XML_Attribute_R="r",H.Serializer_XML_Attribute_G="g",H.Serializer_XML_Attribute_B="b",H.Serializer_XML_Attribute_Color="color",H.Serializer_XML_Attribute_X="x",H.Serializer_XML_Attribute_Y="y",H.Serializer_XML_Attribute_Z="z",H.Serializer_XML_Attribute_Value="value",H.Serializer_XML_Attribute_Type="type",H.Serializer_XML_Attribute_Key="key",H.Serializer_XML_Attribute_URI="uri",H.Serializer_XML_Attribute_Width="width",H.Serializer_XML_Attribute_Height="height",H.Serializer_XML_Attribute_Name="name",H.Serializer_XML_Attribute_Min="min",H.Serializer_XML_Attribute_Max="max",H.Serializer_XML_Attribute_Format="format",H}();k.NoteFactory=e}(M3D||(M3D={})),function(r){var e=function(t){function e(){var e=t.call(this)||this;return e.textPos=new r.Vector3,e.notePos=new r.Vector3,e.InitMeasureDistance(),e}return __extends(e,t),e.prototype.InitMeasureDistance=function(){this.SetType(r.ShapeType.SHAPE_TEXT_NOTE)},e.prototype.GetWorldTextPos=function(){var e=this.GetSceneNode();return(e?e.GetWorldTransform().Clone():r.Matrix3x4.IDENTITY().Clone()).Multiply(this.textPos)},e.prototype.SetTextPos=function(e){this.textPos=e.Clone()},e.prototype.GetTextPos=function(){return this.textPos},e.prototype.SetNotePos=function(e){this.notePos=e.Clone()},e.prototype.GetNotePos=function(){return this.notePos},e.prototype.GetWorldNotePos=function(){var e=this.GetSceneNode();return(e?e.GetWorldTransform().Clone():r.Matrix3x4.IDENTITY().Clone()).Multiply(this.notePos)},e}(r.Measure);r.TextNote=e}(M3D||(M3D={})),function(n){var e=function(i){function e(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=i.call(this)||this;if(r.imageBoard=null,r.textImage=null,r.position=new n.Vector3,1==e.length)e[0]instanceof n.SceneManager&&r.InitVoice(e[0]);else if(2==e.length){if(e[0]instanceof n.Vector3&&e[1]instanceof n.SceneManager){r.SetType(n.ShapeType.SHAPE_VOICE_NOTE);r.imageBoard=new n.ImageBoard(e[0],new n.Vector2(5,5)),r.imageBoard.setTexture(e[1].GetResourceManager().GetDefaultVoiceImage()),r.SetPosition(e[0])}}else 3==e.length&&(r.SetType(n.ShapeType.SHAPE_VOICE_NOTE),r.imageBoard=new n.ImageBoard(e[0],e[1]),r.imageBoard.setTexture(e[2].GetResourceManager().GetDefaultVoiceImage()),r.Set(e[0],e[1]),r.SetPosition(e[0]));return r}return __extends(e,i),e.prototype.InitVoice=function(e){this.imageBoard=new n.ImageBoard(n.Vector3.ZERO().Clone(),new n.Vector2(5,5)),this.imageBoard.setTexture(e.GetResourceManager().GetDefaultVoiceImage()),this.SetType(n.ShapeType.SHAPE_VOICE_NOTE)},e.prototype.SetPosition=function(e){this.position=e,this.imageBoard&&this.imageBoard.SetPosition(e)},e.prototype.GetPosition=function(){return this.position},e.prototype.GetImageboard=function(){return this.imageBoard},e.prototype.RayPick=function(e){if(this.IsVisible()&&e.CanPickShape(this.GetType())){var t=this.imageBoard.GetIntersects(e);if(0<t.length)for(var r=0,i=t;r<i.length;r++){var n=i[r];e.AddIntersectPnt(n)}e.AddShape(this)}},e.prototype.Set=function(e,t){this.imageBoard&&this.imageBoard.Set(e,t)},e.prototype.SetSelected=function(e){this.SetSelected(e),this.imageBoard&&this.imageBoard.SetSelected(e)},e.prototype.ComputeBox=function(){this.BoundingBox=new n.BoundingBox(n.Vector3.MINIMUM().Clone(),n.Vector3.MAXMUN().Clone())},e.prototype.FindVisiableObject=function(e){this.IsVisible()&&(this.SetRenderWorldMatrix(e.GetGLWorldMatrix()),this.imageBoard&&this.imageBoard.UpdateRenderData(e),e.PrepareRenderNote(this))},e.prototype.SetUri=function(e){this.uri=e},e.prototype.GetUri=function(){return this.uri},e.prototype.SetFormat=function(e){this.format=e},e.prototype.GetFormat=function(){return this.format},e.prototype.SetVoiceData=function(e){this.voiceData=e},e.prototype.GetVoiceData=function(){return this.voiceData},e}(n.Measure);n.VoiceNote=e}(M3D||(M3D={})),function(r){var e=function(t){function e(){var e=t.call(this)||this;return e.textPos=new r.Vector3,e.notePos=new r.Vector3,e.InitMeasureDistance(),e}return __extends(e,t),e.prototype.InitMeasureDistance=function(){this.SetType(r.ShapeType.SHAPE_SEQUENCE_NUMBER_NOTE)},e.prototype.SetTextPos=function(e){this.textPos=e},e.prototype.GetTextPos=function(){return this.textPos},e.prototype.SetNotePos=function(e){this.notePos=e},e.prototype.GetNotePos=function(){return this.notePos},e}(r.Measure);r.SequenceNumberNote=e}(M3D||(M3D={})),function(o){var e=function(r){function e(e){var t=r.call(this,e)||this;return t.inputTextNoteString=function(e,t){},t.SetCommandType(o.MeasureCommandType.MEASURE_TEXT_NOTE),t.nativaShapeIds=new Array,t}return __extends(e,r),e.prototype.OnTouchHandle=function(e,t){var r=!1,i=this.ProcessEditAndDrag(e,t);if(1==i)return!0;if(2==i)return!1;var n=this.GetMeasure();return null!=n&&(n.GetMeasureType()==o.SMeasure.MEASURE_TEXT_NOTE&&(this.textNoteStep0(t),r=!0),r)},e.prototype.textNoteStep0=function(e){var i=this.GetMeasure();if(M3D.ShapeType.SHAPE_POINT==M3D.ShapeType.SHAPE_POINT){var t,n=e.getX(),o=e.getY();if(0!=(t=this.SelectedPnt(n,o,this.IsUseFeaturePnt()))){i.SetFirstShape(t);this.sview.isShowTextNoteAlert=!0,this.inputTextNoteString(this,function(e,t,r){t?(i.SetTextString(e),r.SetMeasure(i),r.textNoteStep1(n,o)):(r.SetMeasure(i),r.Close(),r.ExecuteNew())})}}},e.prototype.textNoteStep1=function(e,t){var r=this.GetMeasure();r.SetAnchorX(e);var i=t;i<this.sview.view.sceneManager.GetCamera().GetViewPort().GetRect().Height()/2?r.SetAnchorY(i-50*window.devicePixelRatio):r.SetAnchorY(i+100*window.devicePixelRatio),r.Create()?(this.sview.GetNativeShapeManager().AddShape(r.GetID(),r.GetNoteObj()),this.setMeasureStep(0),this.SaveMeasure(r),this.Close(),this.ExecuteNew()):this.ProcessError()},e.prototype.ProcessError=function(){this.Close(),this.ExecuteNew()},e.prototype.Close=function(){r.prototype.Close.call(this),this.ClearTmpSource()},e.prototype.ClearTmpSource=function(){var e=this.GetMeasure();if((this.setMeasureStep(0),null!=e)&&(e.GetMeasureType()==o.SMeasure.MEASURE_TEXT_NOTE&&e instanceof o.STextNote)){var t=e.GetFirstShape();if(this.sview.isShowTextNoteAlert=!1,1<this.nativaShapeIds.length){for(var r=0,i=this.nativaShapeIds;r<i.length;r++){var n=i[r];this.sview.view.RemoveShape(n)}this.nativaShapeIds.splice(0,this.nativaShapeIds.length)}else 0<t&&this.sview.view.RemoveShape(t)}},e}(o.MeasureCommand);o.TextNoteCommand=e}(SView||(SView={})),function(o){var e=function(r){function e(e){var t=r.call(this,e)||this;return t.SetCommandType(o.MeasureCommandType.MEASURE_VOICE_NOTE),t}return __extends(e,r),e.prototype.OnTouchHandle=function(e,t){var r=!1,i=this.ProcessEditAndDrag(e,t);if(1==i)return!0;if(2==i)return!1;var n=this.GetMeasure();return null!=n&&(n.GetMeasureType()==o.SMeasure.MEASURE_VOICE_NOTE&&(this.voiceNoteStep0(t),r=!0),r)},e.prototype.voiceNoteStep0=function(e){if(0==this.getMeasureStep()){var t=this.GetMeasure();t.SetAnchorX(e.getX()),t.SetAnchorY(e.getY()),this.voiceNoteStep1(e)}},e.prototype.voiceNoteStep1=function(e){var t=this.GetMeasure();t.Create()?(this.sview.GetNativeShapeManager().AddShape(t.GetID(),t.GetMeasureObj()),this.setMeasureStep(0),this.SaveMeasure(t),this.Close(),this.ExecuteNew()):this.ProcessError()},e.prototype.ProcessError=function(){this.Close(),this.ExecuteNew()},e.prototype.Close=function(){r.prototype.Close.call(this),this.ClearTmpSource()},e.prototype.ClearTmpSource=function(){var e=this.GetMeasure();if((this.setMeasureStep(0),null!=e)&&(e.GetMeasureType()==o.SMeasure.MEASURE_TYPE_PNT_PNT_DISTANCE&&e instanceof o.SVoiceNote)){var t=e.GetFirstShape();0<t&&this.sview.view.RemoveShape(t)}},e}(o.MeasureCommand);o.VoiceNoteCommand=e}(SView||(SView={})),function(o){var e=function(r){function e(e){var t=r.call(this,e)||this;return t.number=0,t.SetCommandType(o.MeasureCommandType.MEASURE_SEQUENCE_NUM),t}return __extends(e,r),e.prototype.OnTouchHandle=function(e,t){var r=!1,i=this.ProcessEditAndDrag(e,t);if(1==i)return!0;if(2==i)return!1;var n=this.GetMeasure();return null!=n&&(n.GetMeasureType()==o.SMeasure.MEASURE_SEQUENCE_NUMBER_NOTE&&(this.sequenceNumberNoteStep0(t),r=!0),r)},e.prototype.sequenceNumberNoteStep0=function(e){var t=this.GetMeasure();if(M3D.ShapeType.SHAPE_POINT==M3D.ShapeType.SHAPE_POINT){var r,i=e.getX(),n=e.getY();0!=(r=this.SelectedPnt(i,n,this.IsUseFeaturePnt()))&&(t.SetFirstShape(r),this.number++,t.SetTextString(String(this.number)),this.sequenceNumberNoteStep1(i,n))}},e.prototype.sequenceNumberNoteStep1=function(e,t){var r=this.GetMeasure();r.SetAnchorX(e);var i=t;i<this.sview.view.sceneManager.GetCamera().GetViewPort().GetRect().Height()/2?r.SetAnchorY(i-50*window.devicePixelRatio):r.SetAnchorY(i+100*window.devicePixelRatio),r.Create()?(this.sview.GetNativeShapeManager().AddShape(r.GetID(),r.GetNoteObj()),this.setMeasureStep(0),this.SaveMeasure(r),this.Close(),this.ExecuteNew()):this.ProcessError()},e.prototype.ProcessError=function(){this.Close(),this.ExecuteNew()},e.prototype.Close=function(){r.prototype.Close.call(this),this.ClearTmpSource()},e.prototype.ClearTmpSource=function(){var e=this.GetMeasure();if((this.setMeasureStep(0),null!=e)&&(e.GetMeasureType()==o.SMeasure.MEASURE_SEQUENCE_NUMBER_NOTE&&e instanceof o.SSequenceNumberNote)){var t=e.GetFirstShape();0<t&&this.sview.view.RemoveShape(t)}},e}(o.MeasureCommand);o.SequenceNumberNoteCommand=e}(SView||(SView={})),function(s){var e=function(t){function n(){var e=t.call(this)||this;return e.firstShape=0,e.textString="",e.Init(),e}return __extends(n,t),n.prototype.Create=function(){var e=!1,t=null,r=this.GetMeasureType(),i=this.firstShape,n=this.GetAnchorX(),o=this.GetAnchorY(),a=new M3D.Vector2(n,o);return r==s.SMeasure.MEASURE_TEXT_NOTE&&(t=M3D.NoteFactory.createTextNote(i,a,this.GetTextString(),this.view.GetSceneManager())),t&&(this.nativeNote=t,e=!0),e},n.prototype.Init=function(){this.SetType(M3D.ShapeType.SHAPE_TEXT_NOTE)},n.prototype.GetFirstShape=function(){return this.firstShape},n.prototype.SetFirstShape=function(e){this.firstShape=e},n.prototype.Delete=function(){return 0<this.GetID()&&(this.view.RemoveShape(this.GetID()),!0),!1},n.prototype.SetTextString=function(e){this.textString=e},n.prototype.GetTextString=function(){return this.textString},n.prototype.Clear=function(){return!1},n.CreateFromXML=function(e,t){var r=null;if(null!=e&&0!=e.length){r=new n;var i=M3D.NoteFactory.CreateTextNoteFromXMLElement(t.view.GetSceneManager(),t.ParseXmlString(e));if(i){r.SetView(t.view),r.SetNativeNoteObj(i);i.GetID()}return r}},n}(s.SMeasure);s.STextNote=e}(SView||(SView={})),function(a){var e=function(t){function e(){var e=t.call(this)||this;return e.firstShape=0,e.textString="",e.Init(),e}return __extends(e,t),e.prototype.Create=function(){var e=!1,t=null,r=this.GetMeasureType(),i=(this.firstShape,this.GetAnchorX()),n=this.GetAnchorY(),o=new M3D.Vector2(i,n);return r==a.SMeasure.MEASURE_TEXT_NOTE&&(t=M3D.NoteFactory.createVoiceNote(o,this.GetTextString(),this.view.GetSceneManager())),t&&(this.nativeMeasure=t,e=!0),e},e.prototype.Init=function(){this.SetType(M3D.ShapeType.SHAPE_TEXT_NOTE)},e.prototype.GetFirstShape=function(){return this.firstShape},e.prototype.SetFirstShape=function(e){this.firstShape=e},e.prototype.Delete=function(){return 0<this.GetID()&&(this.view.RemoveShape(this.GetID()),!0),!1},e.prototype.SetTextString=function(e){this.textString=e},e.prototype.GetTextString=function(){return this.textString},e.prototype.Clear=function(){return!1},e}(a.SMeasure);a.SVoiceNote=e}(SView||(SView={})),function(s){var e=function(t){function e(){var e=t.call(this)||this;return e.firstShape=0,e.textString="",e.Init(),e}return __extends(e,t),e.prototype.Create=function(){var e=!1,t=null,r=this.GetMeasureType(),i=this.firstShape,n=this.GetAnchorX(),o=this.GetAnchorY(),a=new M3D.Vector2(n,o);return r==s.SMeasure.MEASURE_SEQUENCE_NUMBER_NOTE&&(t=M3D.NoteFactory.CreateSequenceNumberNote(i,a,this.GetTextString(),this.view.GetSceneManager())),t&&(this.nativeNote=t,e=!0),e},e.prototype.Init=function(){this.SetType(M3D.ShapeType.SHAPE_SEQUENCE_NUMBER_NOTE)},e.prototype.GetFirstShape=function(){return this.firstShape},e.prototype.SetFirstShape=function(e){this.firstShape=e},e.prototype.Delete=function(){return 0<this.GetID()&&(this.view.RemoveShape(this.GetID()),!0),!1},e.prototype.SetTextString=function(e){this.textString=e},e.prototype.GetTextString=function(){return this.textString},e.prototype.Clear=function(){return!1},e}(s.SMeasure);s.SSequenceNumberNote=e}(SView||(SView={}));
function initToobarClick(t){$(window).bind("resize",function(e){!function(){var e=document.getElementById("gesture_canvas");if(!e){return;}e.width=sviewFrameDiv.width(),e.height=sviewFrameDiv.height();var i=$(window).width()-$("#sview_anima_step_panel_lit").width();if($("#sview_anima_step_panel_lit").css({left:i,top:0}),c.reset(),c.list_map)for(var s=0;s<c.list_map.length;s++)for(var t=c.list_map[s],a=t.x,n=t.y,r=0;r<a.length;r++)c.cxt.beginPath(),t.clickDrag[r]&&r?c.cxt.moveTo(a[r-1],n[r-1]):c.cxt.moveTo(a[r]-1,n[r]),c.cxt.lineTo(a[r],n[r]),c.cxt.closePath(),c.cxt.stroke()}()}),sviewFrameDiv.find("#RestoreView").click(function(){RestoreView()}),sviewFrameDiv.find("#modelproperties").click(function(){$("#measurePorpertyList").hasClass("hide")?function(){var e=sview.view.GetSceneManager().GetModel(),i=[];0<(i=sview.view.GetSelector().GetAll()).length&&(e=i[0]);var s=e.GetProperties();null!=s&&0<s.length&&sview.MeasurePropertyStr(s)}():$("#measurePorpertyList").addClass("hide"),sviewFrameDiv.find("#bottomMenu").addClass("hide"),sviewFrameDiv.find("#mainMenu").removeClass(BACKCOLOR[1])}),sviewFrameDiv.find("#front").click(function(){SetPerspective(0)}),sviewFrameDiv.find("#back").click(function(){SetPerspective(1)}),sviewFrameDiv.find("#left").click(function(){SetPerspective(3)}),sviewFrameDiv.find("#right").click(function(){SetPerspective(2)}),sviewFrameDiv.find("#top").click(function(){SetPerspective(5)}),sviewFrameDiv.find("#bottom").click(function(){SetPerspective(4)}),sviewFrameDiv.find("#isometric").click(function(){SetPerspective(6)}),sviewFrameDiv.find("#perspective").click(function(){sview.view.SetCameraProjectionType(0==sview.view.GetCameraProjectionType()?1:0),0==sview.view.GetCameraProjectionType()?sviewFrameDiv.find("#perspective").removeClass(BACKCOLOR[0]):sviewFrameDiv.find("#perspective").addClass(BACKCOLOR[0])}),sviewFrameDiv.find("#showEdgeLine").click(function(){setRenderMode(5)}),sviewFrameDiv.find("#notshowEdgeLine").click(function(){setRenderMode(0)}),sviewFrameDiv.find("#onlyshowEdgeLine").click(function(){setRenderMode(3)}),sviewFrameDiv.find("#IsShowTransparent").click(function(){sview.ShowTransparent()}),sviewFrameDiv.find("#showTrilateralEdge").click(function(e){sview.IsShowWireframe(),e.stopPropagation()}),sviewFrameDiv.find("#mulSelect").click(function(e){sview.setIsMulSelect(this.checked),e.stopPropagation()}),sviewFrameDiv.find("#showBox").click(function(e){sview.setShowBox(this.checked),e.stopPropagation()}),sviewFrameDiv.find("#assembly").click(function(){sviewFrameDiv.find(".leftbar").toggle()}),sviewFrameDiv.find("#add").click(function(){addAsemble()}),sviewFrameDiv.find("#delete").click(function(){delAsemble()}),sviewFrameDiv.find("#copy").click(function(){copyAsemble()}),sviewFrameDiv.find("#cut").click(function(){cutAsemble()}),sviewFrameDiv.find("#paste").click(function(){pasteAsemble()}),sviewFrameDiv.find("#rename").click(function(){renameAsemble()}),sviewFrameDiv.find("#lipq").click(function(){sviewFrameDiv.find("#section_bar").hasClass("hide")&&(sviewFrameDiv.find("#bottomMenu").addClass("hide"),sviewFrameDiv.find("#mainMenu").removeClass(BACKCOLOR[1]),sviewFrameDiv.find("#section_bar").removeClass("hide"),SetClipValue(0),sviewFrameDiv.find("#section_percentage").val(.5),SetClipValue(.5),$("#section_percentage").css("background-size","50% 100%"))}),sviewFrameDiv.find("#section_bar_main").click(function(){sviewFrameDiv.find("#section_bar_type").hasClass("show")?sviewFrameDiv.find("#section_bar_type").removeClass("show"):sviewFrameDiv.find("#section_bar_type").addClass("show")}),sviewFrameDiv.find("#section_exit").click(function(){sviewFrameDiv.find("#bottomMenu").removeClass("hide"),sviewFrameDiv.find("#mainMenu").addClass(BACKCOLOR[1]),sviewFrameDiv.find("#section_bar").addClass("hide"),sviewFrameDiv.find("#section_percentage").val(0),sview.CloseClipPlane(),sviewFrameDiv.find("#section_exit").hasClass(BACKCOLOR[0])&&sviewFrameDiv.find("#section_exit").removeClass(BACKCOLOR[0]),sviewFrameDiv.find("#section_bar_type").hasClass("show")&&sviewFrameDiv.find("#section_bar_type").removeClass("show")}),sviewFrameDiv.find("#li_explosive").click(function(){sview.getExplosiveLicence()&&sviewFrameDiv.find("#explose_bar").hasClass("hide")&&(sviewFrameDiv.find("#bottomMenu").addClass("hide"),sviewFrameDiv.find("#mainMenu").removeClass(BACKCOLOR[1]),sviewFrameDiv.find("#explose_bar").removeClass("hide"),$("#explosive_per").val(0),$("#explosive_per").css("background-size","0% 100%"))}),sviewFrameDiv.find("#explose_bar_third_main").click(function(){sviewFrameDiv.find("#explose_bar_third_type").hasClass("show")?sviewFrameDiv.find("#explose_bar_third_type").removeClass("show"):sviewFrameDiv.find("#explose_bar_third_type").addClass("show")}),sviewFrameDiv.find("#explose_exit").click(function(){sviewFrameDiv.find("#bottomMenu").removeClass("hide"),sviewFrameDiv.find("#mainMenu").addClass(BACKCOLOR[1]),sviewFrameDiv.find("#explose_bar").addClass("hide"),sviewFrameDiv.find("#explosive_per").val(0),sviewFrameDiv.find("#explose_bar_third_type").hasClass("show")&&sviewFrameDiv.find("#explose_bar_third_type").removeClass("show"),sview.ClearExplosive()}),sviewFrameDiv.find("#RestoreView_li").mousedown(function(e){$(this).addClass(BACKCOLOR[1]),e.stopPropagation()}),document.getElementById("RestoreView_li").addEventListener("touchstart",function(e){$(this).addClass(BACKCOLOR[1]),e.stopPropagation()},!1),document.getElementById("RestoreView_li").addEventListener("touchend",function(e){$(this).removeClass(BACKCOLOR[1]),e.stopPropagation()},!1),sviewFrameDiv.find("#RestoreView_li").mouseup(function(e){$(this).removeClass(BACKCOLOR[1]),e.stopPropagation()}),sviewFrameDiv.find("#li_Snopt").click(function(){oDownLoad(sview.SnoptImage(!0),(new Date).getTime()+".png")}),sviewFrameDiv.find(".rt-sus li").click(function(){"mainMenu"!=$(this).attr("id")&&($(this).hasClass(BACKCOLOR[1])?($(this).removeClass(BACKCOLOR[1]),"block"===$(".leftbar").css("display")&&$("#assembly").addClass(BACKCOLOR[1]),$("#measurePorpertyList").hasClass("hide")||$("#modelproperties").addClass(BACKCOLOR[1]),$(this).children(".ul-dropmenu").removeClass("show")):"RestoreView_li"!==$(this).attr("id")&&(sviewFrameDiv.find(".rt-sus li").removeClass(BACKCOLOR[1]),"block"===$(".leftbar").css("display")&&$("#assembly").addClass(BACKCOLOR[1]),$("#measurePorpertyList").hasClass("hide")||$("#modelproperties").addClass(BACKCOLOR[1]),$(this).addClass(BACKCOLOR[1]),sviewFrameDiv.find(".rt-sus li").children(".ul-dropmenu").removeClass("show"),"walking"==$(this).attr("id")&&(M3D.CookieHelper.GetCookie("walkThroughSpeed")&&$(".walking_speed").val(M3D.CookieHelper.GetCookie("walkThroughSpeed")),M3D.CookieHelper.GetCookie("walkThroughFov")&&$(".walking_fov").val(M3D.CookieHelper.GetCookie("walkThroughFov")),M3D.CookieHelper.GetCookie("walkThroughUpdirection")&&$(".walking_updirection ").val(M3D.CookieHelper.GetCookie("walkThroughUpdirection"))),"mainMenu"==$(this).attr("id")||$(this).children(".ul-dropmenu").addClass("show")))});var i=new function(){var i,s,t,a,n=["RequestFullscreen","RequestFullScreen"],r=["ExitFullscreen","CancelFullScreen"],o=function(s,e,t){var a,n;return e.map(function(e){return s+e}).forEach(function(e){var i;n||(0===s.length&&(e=(i=e).slice(0,1).toLowerCase()+i.slice(1)),e in t&&(a=e,n=!0))}),a};["","webkit","moz","ms"].forEach(function(e){i&&s||(t=o(e,n,document.documentElement),i=Boolean(t),a=o(e,r,document),s=Boolean(a))}),this.request=function(e){(document.querySelector(e)||document.documentElement)[t]()},this.exit=function(){document[a]()},this.isFullScreen=function(){return document.fullscreenElement||document.msFullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||!1}},s="",a="";function e(){i.isFullScreen()?(M3D.Parameters.Instance().isFullScreenExpand&&$("#sview0").css({width:"100%",height:"100%"}),sviewFrameDiv.find("#fullscreen").addClass("hide"),sviewFrameDiv.find("#exitfullscreen").removeClass("hide")):(M3D.Parameters.Instance().isFullScreenExpand&&""!=s&&""!=a&&$("#sview0").css({width:s,height:a}),sviewFrameDiv.find("#exitfullscreen").addClass("hide"),sviewFrameDiv.find("#fullscreen").removeClass("hide")),sviewFrameDiv.find("#fullscreen").removeClass(BACKCOLOR[1]),sviewFrameDiv.find("#exitfullscreen").removeClass(BACKCOLOR[1])}sviewFrameDiv.find("#fullscreen").click(function(){s=$("#sview0").width(),a=$("#sview0").height(),i.request()}),sviewFrameDiv.find("#exitfullscreen").click(function(){i.exit()}),document.addEventListener("fullscreenchange",function(){e()},!1),document.addEventListener("webkitfullscreenchange",function(){e()},!1),document.addEventListener("mozfullscreenchange",function(){e()},!1),document.addEventListener("MSFullscreenChange",function(){e()},!1),$(document).keydown(function(e){(e=e||window.event||arguments.callee.caller.arguments[0])&&122==e.keyCode&&(i.isFullScreen()||(s=$("#sview0").width(),a=$("#sview0").height(),i.request()),e.preventDefault())}),sviewFrameDiv.find("#section_yzsection").click(function(){SetClipDir(1),sviewFrameDiv.find("#section_bar_third_main_img").attr("src",sviewBaseUrl+"Platform/Ctrls/SView/sview/css/images/button_yzsection.png"),$("#section_reversal").hasClass(BACKCOLOR[0])&&$("#section_reversal").removeClass(BACKCOLOR[0])}),sviewFrameDiv.find("#section_xysection").click(function(){SetClipDir(3),sviewFrameDiv.find("#section_bar_third_main_img").attr("src",sviewBaseUrl+"Platform/Ctrls/SView/sview/css/images/button_xysection.png"),$("#section_reversal").hasClass(BACKCOLOR[0])&&$("#section_reversal").removeClass(BACKCOLOR[0])}),sviewFrameDiv.find("#section_xzsection").click(function(){SetClipDir(2),sviewFrameDiv.find("#section_bar_third_main_img").attr("src",sviewBaseUrl+"Platform/Ctrls/SView/sview/css/images/button_zxsection.png"),$("#section_reversal").hasClass(BACKCOLOR[0])&&$("#section_reversal").removeClass(BACKCOLOR[0])}),sviewFrameDiv.find("#section_reversal").click(function(e){$(this).hasClass(BACKCOLOR[0])?$(this).removeClass(BACKCOLOR[0]):$(this).addClass(BACKCOLOR[0]),SetOppositeDir(),e.stopPropagation()}),sviewFrameDiv.find("#section_plane").click(function(e){$(this).hasClass(BACKCOLOR[0])?$(this).removeClass(BACKCOLOR[0]):$(this).addClass(BACKCOLOR[0]),IsShowClipHelppingPlane(),e.stopPropagation()}),sviewFrameDiv.find("#section_cappingPlane").click(function(e){$(this).hasClass(BACKCOLOR[0])?$(this).removeClass(BACKCOLOR[0]):$(this).addClass(BACKCOLOR[0]),IsShowCappingPlane(),e.stopPropagation()});var n=sviewFrameDiv.find("#section_percentage");function r(){$(".ani-pause").html("<img src='"+sviewBaseUrl+"Platform/Ctrls/SView/sview/css/images/button_ani_play.png' alt='开始' title='开始'>"),options[0].animationStatus=!1,sview.Pause()}function d(){sview.GetAnimationTaskLinstener().UpdateWorkTask=function(){null!=sview.animationPlayer.GetActiveTask()&&AnimationPlayListener.selectStep(sview.animationPlayer.GetActiveTask().GetId(),sview.animationPlayer.GetActiveTask().GetProcessId())},sview.GetAnimationTaskLinstener().UpdatePercent=function(){$("#ani_percentage").val(sview.animationPlayer.GetPercent()/100),$("#ani_percentage").css("background-size",String(sview.animationPlayer.GetPercent())+"% 100%")},sview.GetAnimationTaskLinstener().UpdateStopPlaying=function(){sview.animationPlayer.IsLoop()||100!=Math.floor(sview.animationPlayer.GetPercent())||r()}}window.ActiveXObject||"ActiveXObject"in window?n.on("change",function(){setPlanePosition()}):n.on("input",function(){setPlanePosition()}),sviewFrameDiv.find(".section_xyz").click(function(e){sviewFrameDiv.find(".section_xyz").removeClass(BACKCOLOR[0]),$(this).addClass(BACKCOLOR[0]),e.stopPropagation()}),sviewFrameDiv.find("#explosive_center").click(function(){SetExplosiveStyle(0),sviewFrameDiv.find("#explos_bar_third_main_img").attr("src",sviewBaseUrl+"Platform/Ctrls/SView/sview/css/images/explosive_global.png")}),sviewFrameDiv.find("#explosive_by_x").click(function(){SetExplosiveStyle(1),sviewFrameDiv.find("#explos_bar_third_main_img").attr("src",sviewBaseUrl+"Platform/Ctrls/SView/sview/css/images/explosive_three_dimensional.png")}),sviewFrameDiv.find("#explosive_by_y").click(function(){SetExplosiveStyle(2),sviewFrameDiv.find("#explos_bar_third_main_img").attr("src",sviewBaseUrl+"Platform/Ctrls/SView/sview/css/images/explosive_plane.png")}),sviewFrameDiv.find("#explosive_per").mouseup(function(e){sview.view.GetSceneManager().GetSceneBox().Clear()}),window.ActiveXObject||"ActiveXObject"in window?sviewFrameDiv.find("#explosive_per").on("change",function(){SetExplosivePosition()}):sviewFrameDiv.find("#explosive_per").on("input",function(){SetExplosivePosition()}),sviewFrameDiv.find("#more").click(function(){sviewFrameDiv.find("#main_bottobar").toggle()}),sviewFrameDiv.find(".viewAngle_main").click(function(e){sviewFrameDiv.find(".viewAngle_main").removeClass(BACKCOLOR[0]),$(this).addClass(BACKCOLOR[0]),e.stopPropagation()}),sviewFrameDiv.find(".viewAngle").click(function(e){"IsShowTransparent"==$(this).attr("id")&&($(this).hasClass(BACKCOLOR[0])?$(this).removeClass(BACKCOLOR[0]):$(this).addClass(BACKCOLOR[0])),e.stopPropagation()}),sviewFrameDiv.find(".viewAngle").mousedown(function(e){"IsShowTransparent"!=$(this).attr("id")&&"ObserveSelect"!=$(this).attr("id")&&$(this).addClass(BACKCOLOR[0]),e.stopPropagation()}),sviewFrameDiv.find(".viewAngle").mouseup(function(e){"IsShowTransparent"!=$(this).attr("id")&&$(this).removeClass(BACKCOLOR[0]),e.stopPropagation()}),$("#ObserveSelect").mousedown(function(e){e.stopPropagation()}),sviewFrameDiv.find("#ObserveSelect").click(function(e){e.stopPropagation()}),sviewFrameDiv.find("#ObserveSelect").change(function(e){var i=$(this).val();switch(i){case"0":case"1":case"2":sview.SetObserveMode(Number(i),!0)}e.stopPropagation()}),sviewFrameDiv.find(".explosive").click(function(e){sviewFrameDiv.find(".explosive").removeClass(BACKCOLOR[0]),$(this).addClass(BACKCOLOR[0]),e.stopPropagation()}),sviewFrameDiv.find("#section_percentage").click(function(e){e.stopPropagation()}),sviewFrameDiv.find("#explosive_percentage").click(function(e){e.stopPropagation()}),sviewFrameDiv.find("#dragger-first").click(function(e){var i=$(this).find(".ul-dropmenu ");i.hasClass("show")?i.removeClass("show"):i.addClass("show"),e.stopPropagation()}),sviewFrameDiv.find(".dragger-class").click(function(e){sviewFrameDiv.find(".dragger-class").removeClass(BACKCOLOR[0]),$(this).addClass(BACKCOLOR[0]),sviewFrameDiv.find(".DGLI").removeClass(BACKCOLOR[0]),sviewFrameDiv.find(".dface").addClass(BACKCOLOR[0]),sview.SetDraggerAxis(3)}),sviewFrameDiv.find(".DGLI").click(function(e){sviewFrameDiv.find(".DGLI").removeClass(BACKCOLOR[0]),$(this).addClass(BACKCOLOR[0]),e.stopPropagation()}),sviewFrameDiv.find("#trans").click(function(){sviewFrameDiv.find("#dragger-main-img").attr("alt",$(this).children("#trans-img").attr("alt")),sviewFrameDiv.find("#dragger-main-img").attr("src",$(this).children("#trans-img").attr("src")),sviewFrameDiv.find("#dragger-main-img").attr("title",$(this).children("#trans-img").attr("title")),sviewFrameDiv.find("#dragger-translation").removeClass("show"),sviewFrameDiv.find("#dragger-rotation").removeClass("show"),sviewFrameDiv.find("#dragger-scaling").removeClass("show"),sviewFrameDiv.find("#dragger-translation").addClass("show"),sview.SetDraggerMode(0),sview.SetDraggerAxis(3)}),sviewFrameDiv.find("#rot").click(function(){sviewFrameDiv.find("#rot-img"),sviewFrameDiv.find("#rot-img").attr("alt"),sviewFrameDiv.find("#rot-img").attr("src"),sviewFrameDiv.find("#rot-img").attr("title");sviewFrameDiv.find("#dragger-main-img").attr("alt",sviewFrameDiv.find("#rot").children("#rot-img").attr("alt")),sviewFrameDiv.find("#dragger-main-img").attr("src",sviewFrameDiv.find("#rot").children("#rot-img").attr("src")),sviewFrameDiv.find("#dragger-main-img").attr("title",sviewFrameDiv.find("#rot").children("#rot-img").attr("title")),sviewFrameDiv.find("#dragger-translation").removeClass("show"),sviewFrameDiv.find("#dragger-rotation").removeClass("show"),sviewFrameDiv.find("#dragger-scaling").removeClass("show"),sviewFrameDiv.find("#dragger-rotation").addClass("show"),sview.SetDraggerMode(1),sview.SetDraggerAxis(3)}),sviewFrameDiv.find("#sca").click(function(){sviewFrameDiv.find("#dragger-main-img").attr("alt",$(this).children("#sca-img").attr("alt")),sviewFrameDiv.find("#dragger-main-img").attr("src",$(this).children("#sca-img").attr("src")),sviewFrameDiv.find("#dragger-main-img").attr("title",$(this).children("#sca-img").attr("title")),sviewFrameDiv.find("#dragger-translation").removeClass("show"),sviewFrameDiv.find("#dragger-rotation").removeClass("show"),sviewFrameDiv.find("#dragger-scaling").removeClass("show"),sviewFrameDiv.find("#dragger-scaling").addClass("show"),sview.SetDraggerMode(2),sview.SetDraggerAxis(3)}),sviewFrameDiv.find(".dragger-face").click(function(){sview.view.CloseSceneAnimation(),sview.SetDraggerAxis(3)}),sviewFrameDiv.find(".dragger-x").click(function(){sview.view.CloseSceneAnimation(),sview.SetDraggerAxis(0)}),sviewFrameDiv.find(".dragger-y").click(function(){sview.view.CloseSceneAnimation(),sview.SetDraggerAxis(1)}),sviewFrameDiv.find(".dragger-z").click(function(){sview.view.CloseSceneAnimation(),sview.SetDraggerAxis(2)}),sviewFrameDiv.find(".dragger-exit").click(function(e){sview.SetUsingTouchHandlerType(1),sview.SetDraggerAxis(3),sviewFrameDiv.find(".DGLI").removeClass(BACKCOLOR[0]),sviewFrameDiv.find("#dagger_bar").hide(),sviewFrameDiv.find(".pull-right").show(),sviewFrameDiv.find("#bottomMenu").is(":hidden")||sviewFrameDiv.find("#bottomMenu").show(),e.stopPropagation()}),sviewFrameDiv.find(".ani-more").click(function(e){sviewFrameDiv.find("#setSpeed").hasClass("show")?sviewFrameDiv.find("#setSpeed").removeClass("show"):sviewFrameDiv.find("#setSpeed").addClass("show"),e.stopPropagation()}),sviewFrameDiv.find(".ani-forward").click(function(e){sviewFrameDiv.find(".ani-pause").html("<img src='Platform/Ctrls/SView/sview/css/images/button_ani_pause.png' alt='暂停' title='暂停'>"),t.animationStatus=!0,sview.AnimationNext()}),sviewFrameDiv.find(".ani-backward").click(function(e){sviewFrameDiv.find(".ani-pause").html("<img src='Platform/Ctrls/SView/sview/css/images/button_ani_pause.png' alt='暂停' title='暂停'>"),t.animationStatus=!0,sview.AnimationPre()}),sviewFrameDiv.find(".ani-exit").click(function(e){AnimationStop(),RestoreView(),sviewFrameDiv.find("#animation").removeClass(BACKCOLOR[1]),sviewFrameDiv.find(".pull-right").show(),sviewFrameDiv.find(".rotation").show(),sviewFrameDiv.find(".ani-pause").html("<img src='"+sviewBaseUrl+"Platform/Ctrls/SView/sview/css/images/button_ani_pause.png' alt='暂停' title='暂停'>"),t.animationStatus=!0,sviewFrameDiv.find("#animation_bar").addClass("hide"),sviewFrameDiv.find("#bottomMenu").removeClass("hide"),sviewFrameDiv.find("#mainMenu").addClass(BACKCOLOR[1]),sview_anima_step_panel.hide(),sview_anima_step_panel_lite.hide(),sview_anima_step_toggle_btn.hide(),$(".rotation").hide(),sviewFrameDiv.find("#setSpeed").removeClass("show"),e.stopPropagation()}),sviewFrameDiv.find("#animation").click(function(e){if(sview.getAnimationLicence()){if(sviewFrameDiv.find("#animation_bar").hasClass("hide")){sview.ClearExplosive(),sview.AnimationOpenFile(),sviewFrameDiv.find("#animation_bar").removeClass("hide"),sviewFrameDiv.find("#animation_bar").show(),sviewFrameDiv.find(".pull-right").hide(),sviewFrameDiv.find(".rotation").hide(),sviewFrameDiv.find(".leftbar").hide(),$("#assembly").removeClass(BACKCOLOR[1]),sviewFrameDiv.find("#bottomMenu").addClass("hide"),sviewFrameDiv.find("#mainMenu").removeClass(BACKCOLOR[1]),$("#hideBtnDiv").css("padding-top",$(document).height()/3),$("#hideBtnDiv img").attr("src",sviewBaseUrl+"Platform/Ctrls/SView/sview/css/images/sview_ani_anilist_close.png");var i=Get_Animation_Option("#speedSelect");$("#speedSelect").val(i);var s=sview.animationPlayer.GetTaskList();if(null!=s&&1<s.length&&sview.animationPlayer){sview_anima_step_panel.show(),sview_anima_step_panel_lite.show(),sview_anima_step_toggle_btn.show();var t=setAni(s);InitAnimaStepTree(t),d()}else if(null!=s&&1==s.length){sview_anima_step_panel.show(),sview_anima_step_panel_lite.show(),sview_anima_step_toggle_btn.show();var a=" ",n=0,r=" ";if(Object.prototype.toString.call("[object Array]"===s[0]))for(var o=s[0].GetStepList(),v=0;v<o.length;v++)null!=r?r+='{ name:"'+o[v].GetName()+'",id:"stepId_'+o[v].GetId()+'",steps_id:"'+n+'",step_info:"'+o[v].GetStepInfo()+'" },':r='{ name:"'+o[v].GetName()+'",id:"step_'+o[v].GetId()+'",steps_id:"'+n+'",step_info:"'+o[v].GetStepInfo()+'" },',++n;null!=a?a+='{name:"'+s[0].GetName()+'",id:"processId_'+s[0].GetId()+'",open:true,children:['+r+"]},":a='{name:"'+s[0].GetName()+'",id:"processId_'+s[0].GetId()+'",open:true,children:['+r+"]},",InitAnimaStepTree(a),d()}else $(".rotation").show(),sviewFrameDiv.find("#animation_bar").addClass("hide"),sview.SetRotateSpeed(1),sview.SetExplosiveStyleNoRestore(0),sview.StartRotateAndExplosive(),$(".rotation").find("#RAndEimage").attr("src",sviewBaseUrl+"Platform/Ctrls/SView/sview/css/images/rotation-1.png"),sviewFrameDiv.find(".pull-right").hide();sview.Play(),sview.animationPlayer.SetAutoWalkCamera(Get_Animation_Option("#autoWalk")),sview.animationPlayer.SetSpeed(Get_Animation_Option("#speedSelect")),sview.animationPlayer.SetLoop(Get_Animation_Option("#aniLoop"))}else sviewFrameDiv.find("#animation_bar").addClass("hide"),sviewFrameDiv.find("#animation_bar").hide(),sviewFrameDiv.find("#bottomMenu").removeClass("hide"),sviewFrameDiv.find("#mainMenu").addClass(BACKCOLOR[1]),sviewFrameDiv.find(".rotation").show(),sview_anima_step_panel.hide(),sview_anima_step_panel_lite.hide(),sview_anima_step_toggle_btn.hide(),AnimationStop(),RestoreView();e.stopPropagation()}}),sviewFrameDiv.find("#ringani-pause").click(function(e){t.ringAnimationStatus?($("#ringani-pause").html("<img src='"+sviewBaseUrl+"Platform/Ctrls/SView/sview/css/images/button_ani_play.png' alt='开始' title='开始'>"),options[0].ringAnimationStatus=!1,sview.EndRotateAndExplosive()):($("#ringani-pause").html("<img src='"+sviewBaseUrl+"Platform/Ctrls/SView/sview/css/images/button_ani_pause.png' alt='暂停' title='暂停'>"),options[0].ringAnimationStatus=!0,sview.StartRotateAndExplosive())}),sviewFrameDiv.find("#mainMenu").click(function(e){sviewFrameDiv.find("#bottomMenu").hasClass("hide")?(sviewFrameDiv.find("#note_bar").hasClass("hide")&&sviewFrameDiv.find("#gesture_bar").hasClass("hide")&&sviewFrameDiv.find("#animation_bar").hasClass("hide")&&sviewFrameDiv.find("#measure_bar").hasClass("hide")&&sviewFrameDiv.find("#section_bar").hasClass("hide")&&sviewFrameDiv.find("#explose_bar").hasClass("hide")&&(sviewFrameDiv.find("#bottomMenu").removeClass("hide"),sviewFrameDiv.find("#mainMenu").addClass(BACKCOLOR[1])),$("#assembly").hasClass(BACKCOLOR[1])||sviewFrameDiv.find(".pull-left").hide(),$("#modelproperties").hasClass(BACKCOLOR[1])&&($("#measurePorpertyList").addClass("hide"),$("#modelproperties").removeClass(BACKCOLOR[1]))):(sviewFrameDiv.find("#mainMenu").removeClass(BACKCOLOR[1]),sviewFrameDiv.find("#bottomMenu").addClass("hide"))}),sviewFrameDiv.find("#_scaleL").click(function(e){if(sviewFrameDiv.find("#gesture_bar").hasClass("hide")){sviewFrameDiv.find("#bottomMenu").addClass("hide"),sviewFrameDiv.find("#note_bar").addClass("hide"),sviewFrameDiv.find("#mainMenu").removeClass(BACKCOLOR[1]),sviewFrameDiv.find("#gesture_bar").removeClass("hide");var i=document.getElementById("gesture_canvas");i.width=sviewFrameDiv.width(),i.height=sviewFrameDiv.height(),c.init(),sviewFrameDiv.find("#gesture_canvas").show()}}),sviewFrameDiv.find("#gesture_bar_first").click(function(e){var i=$(this).find(".ul-dropmenu ");i.hasClass("show")?i.removeClass("show"):i.addClass("show"),sviewFrameDiv.find("#gesture_bar_third_type").hasClass("show")&&sviewFrameDiv.find("#gesture_bar_third_type").removeClass("show"),sviewFrameDiv.find("#gesture_bar_second_type").hasClass("show")&&sviewFrameDiv.find("#gesture_bar_second_type").removeClass("show"),e.stopPropagation()}),sviewFrameDiv.find("#gesture_bar_second").click(function(e){var i=$(this).find(".ul-dropmenu ");i.hasClass("show")?i.removeClass("show"):i.addClass("show"),sviewFrameDiv.find("#gesture_bar_third_type").hasClass("show")&&sviewFrameDiv.find("#gesture_bar_third_type").removeClass("show"),sviewFrameDiv.find("#gesture_bar_type").hasClass("show")&&sviewFrameDiv.find("#gesture_bar_type").removeClass("show"),e.stopPropagation()}),sviewFrameDiv.find("#gesture_bar_third").click(function(e){var i=$(this).find(".ul-dropmenu ");i.hasClass("show")?i.removeClass("show"):i.addClass("show"),sviewFrameDiv.find("#gesture_bar_second_type").hasClass("show")&&sviewFrameDiv.find("#gesture_bar_second_type").removeClass("show"),sviewFrameDiv.find("#gesture_bar_type").hasClass("show")&&sviewFrameDiv.find("#gesture_bar_type").removeClass("show"),e.stopPropagation()}),sviewFrameDiv.find(".gesture-class").click(function(e){sviewFrameDiv.find(".gesture-class").removeClass(BACKCOLOR[0]),$(this).addClass(BACKCOLOR[0]),sviewFrameDiv.find("#gesture_bar_main_img").attr("alt",$(this).children("img").attr("alt")),sviewFrameDiv.find("#gesture_bar_main_img").attr("src",$(this).children("img").attr("src")),sviewFrameDiv.find("#gesture_bar_main_img").attr("title",$(this).children("img").attr("title"))}),sviewFrameDiv.find(".gesture-second-class").click(function(e){sviewFrameDiv.find(".gesture-second-class").removeClass(BACKCOLOR[0]),$(this).addClass(BACKCOLOR[0]),sviewFrameDiv.find("#gesture_bar_second_main_img").attr("alt",$(this).children("img").attr("alt")),sviewFrameDiv.find("#gesture_bar_second_main_img").attr("src",$(this).children("img").attr("src")),sviewFrameDiv.find("#gesture_bar_second_main_img").attr("title",$(this).children("img").attr("title"))}),sviewFrameDiv.find(".gesture_third_class").click(function(e){sviewFrameDiv.find(".gesture_third_class").removeClass(BACKCOLOR[0]),$(this).addClass(BACKCOLOR[0]),sviewFrameDiv.find("#gesture_bar_third_main_img").attr("alt",$(this).children("img").attr("alt")),sviewFrameDiv.find("#gesture_bar_third_main_img").attr("src",$(this).children("img").attr("src")),sviewFrameDiv.find("#gesture_bar_third_main_img").attr("title",$(this).children("img").attr("title"))}),sviewFrameDiv.find(".GESTL").mousedown(function(e){$(this).addClass(BACKCOLOR[0]),e.stopPropagation()}),sviewFrameDiv.find(".GESTL").mouseup(function(e){$(this).removeClass(BACKCOLOR[0]),e.stopPropagation()}),sviewFrameDiv.find("#freedom").click(function(){sviewFrameDiv.find("#gesture_bar_main_img").attr("alt",$(this).children("#freedoimg").attr("alt")),sviewFrameDiv.find("#gesture_bar_main_img").attr("src",$(this).children("#freedoimg").attr("src")),sviewFrameDiv.find("#gesture_bar_main_img").attr("title",$(this).children("#freedoimg").attr("title")),0!=o&&(c.cxt.clearRect(0,0,screenWidth,screenHeight),c.list_map.length=0),o=0}),sviewFrameDiv.find("#circle").click(function(){sviewFrameDiv.find("#gesture_bar_main_img").attr("alt",$(this).children("#circle_img").attr("alt")),sviewFrameDiv.find("#gesture_bar_main_img").attr("src",$(this).children("#circle_img").attr("src")),sviewFrameDiv.find("#gesture_bar_main_img").attr("title",$(this).children("#circle_img").attr("title")),1!=o&&(c.cxt.clearRect(0,0,screenWidth,screenHeight),c.list_map.length=0),o=1}),sviewFrameDiv.find("#rect").click(function(){sviewFrameDiv.find("#gesture_bar_main_img").attr("alt",$(this).children("#rect_img").attr("alt")),sviewFrameDiv.find("#gesture_bar_main_img").attr("src",$(this).children("#rect_img").attr("src")),sviewFrameDiv.find("#gesture_bar_main_img").attr("title",$(this).children("#rect_img").attr("title")),2!=o&&(c.cxt.clearRect(0,0,screenWidth,screenHeight),c.list_map.length=0),o=2}),sviewFrameDiv.find("#triangle").click(function(){sviewFrameDiv.find("#gesture_bar_main_img").attr("alt",$(this).children("#triangle_img").attr("alt")),sviewFrameDiv.find("#gesture_bar_main_img").attr("src",$(this).children("#triangle_img").attr("src")),sviewFrameDiv.find("#gesture_bar_main_img").attr("title",$(this).children("#triangle_img").attr("title")),3!=o&&(c.cxt.clearRect(0,0,screenWidth,screenHeight),c.list_map.length=0),o=3}),sviewFrameDiv.find("#gesture_black").click(function(){sviewFrameDiv.find("#gesture_bar_second_main_img").attr("alt",$(this).children("#gesture_black_img").attr("alt")),sviewFrameDiv.find("#gesture_bar_second_main_img").attr("src",$(this).children("#gesture_black_img").attr("src")),sviewFrameDiv.find("#gesture_bar_second_main_img").attr("title",$(this).children("#gesture_black_img").attr("title")),v=0}),sviewFrameDiv.find("#gesture_red").click(function(){sviewFrameDiv.find("#gesture_bar_second_main_img").attr("alt",$(this).children("#gesture_red_img").attr("alt")),sviewFrameDiv.find("#gesture_bar_second_main_img").attr("src",$(this).children("#gesture_red_img").attr("src")),sviewFrameDiv.find("#gesture_bar_second_main_img").attr("title",$(this).children("#gesture_red_img").attr("title")),v=1}),sviewFrameDiv.find("#gesture_blue").click(function(){sviewFrameDiv.find("#gesture_bar_second_main_img").attr("alt",$(this).children("#gesture_blue_img").attr("alt")),sviewFrameDiv.find("#gesture_bar_second_main_img").attr("src",$(this).children("#gesture_blue_img").attr("src")),sviewFrameDiv.find("#gesture_bar_second_main_img").attr("title",$(this).children("#gesture_blue_img").attr("title")),v=2}),sviewFrameDiv.find("#gesture_green").click(function(){sviewFrameDiv.find("#gesture_bar_second_main_img").attr("alt",$(this).children("#gesture_green_img").attr("alt")),sviewFrameDiv.find("#gesture_bar_second_main_img").attr("src",$(this).children("#gesture_green_img").attr("src")),sviewFrameDiv.find("#gesture_bar_second_main_img").attr("title",$(this).children("#gesture_green_img").attr("title")),v=3}),sviewFrameDiv.find("#gesture_yellow").click(function(){sviewFrameDiv.find("#gesture_bar_second_main_img").attr("alt",$(this).children("#gesture_yellow_img").attr("alt")),sviewFrameDiv.find("#gesture_bar_second_main_img").attr("src",$(this).children("#gesture_yellow_img").attr("src")),sviewFrameDiv.find("#gesture_bar_second_main_img").attr("title",$(this).children("#gesture_yellow_img").attr("title")),v=4}),sviewFrameDiv.find("#gesture_orange").click(function(){sviewFrameDiv.find("#gesture_bar_second_main_img").attr("alt",$(this).children("#gesture_orange_img").attr("alt")),sviewFrameDiv.find("#gesture_bar_second_main_img").attr("src",$(this).children("#gesture_orange_img").attr("src")),sviewFrameDiv.find("#gesture_bar_second_main_img").attr("title",$(this).children("#gesture_orange_img").attr("title")),v=5}),sviewFrameDiv.find("#gesture_gray").click(function(){sviewFrameDiv.find("#gesture_bar_second_main_img").attr("alt",$(this).children("#gesture_gray_img").attr("alt")),sviewFrameDiv.find("#gesture_bar_second_main_img").attr("src",$(this).children("#gesture_gray_img").attr("src")),sviewFrameDiv.find("#gesture_bar_second_main_img").attr("title",$(this).children("#gesture_gray_img").attr("title")),v=6}),sviewFrameDiv.find("#gesture_purple").click(function(){sviewFrameDiv.find("#gesture_bar_second_main_img").attr("alt",$(this).children("#gesture_purple_img").attr("alt")),sviewFrameDiv.find("#gesture_bar_second_main_img").attr("src",$(this).children("#gesture_purple_img").attr("src")),sviewFrameDiv.find("#gesture_bar_second_main_img").attr("title",$(this).children("#gesture_purple_img").attr("title")),v=7}),sviewFrameDiv.find("#gesture_brown").click(function(){sviewFrameDiv.find("#gesture_bar_second_main_img").attr("alt",$(this).children("#gesture_brown_img").attr("alt")),sviewFrameDiv.find("#gesture_bar_second_main_img").attr("src",$(this).children("#gesture_brown_img").attr("src")),sviewFrameDiv.find("#gesture_bar_second_main_img").attr("title",$(this).children("#gesture_brown_img").attr("title")),v=8}),sviewFrameDiv.find("#gesture_pink").click(function(){sviewFrameDiv.find("#gesture_bar_second_main_img").attr("alt",$(this).children("#gesture_pink_img").attr("alt")),sviewFrameDiv.find("#gesture_bar_second_main_img").attr("src",$(this).children("#gesture_pink_img").attr("src")),sviewFrameDiv.find("#gesture_bar_second_main_img").attr("title",$(this).children("#gesture_pink_img").attr("title")),v=9}),sviewFrameDiv.find("#gesture_white").click(function(){sviewFrameDiv.find("#gesture_bar_second_main_img").attr("alt",$(this).children("#gesture_white_img").attr("alt")),sviewFrameDiv.find("#gesture_bar_second_main_img").attr("src",$(this).children("#gesture_white_img").attr("src")),sviewFrameDiv.find("#gesture_bar_second_main_img").attr("title",$(this).children("#gesture_white_img").attr("title")),v=10}),sviewFrameDiv.find("#gesture_strong_line").click(function(){sviewFrameDiv.find("#gesture_bar_third_main_img").attr("alt",$(this).children("#gesture_strong_line_img").attr("alt")),sviewFrameDiv.find("#gesture_bar_third_main_img").attr("src",$(this).children("#gesture_strong_line_img").attr("src")),sviewFrameDiv.find("#gesture_bar_third_main_img").attr("title",$(this).children("#gesture_strong_line_img").attr("title")),l=2}),sviewFrameDiv.find("#gesture_middle_line").click(function(){sviewFrameDiv.find("#gesture_bar_third_main_img").attr("alt",$(this).children("#gesture_middle_line_img").attr("alt")),sviewFrameDiv.find("#gesture_bar_third_main_img").attr("src",$(this).children("#gesture_middle_line_img").attr("src")),sviewFrameDiv.find("#gesture_bar_third_main_img").attr("title",$(this).children("#gesture_middle_line_img").attr("title")),l=1}),sviewFrameDiv.find("#gesture_thin_line").click(function(){sviewFrameDiv.find("#gesture_bar_third_main_img").attr("alt",$(this).children("#gesture_thin_line_img").attr("alt")),sviewFrameDiv.find("#gesture_bar_third_main_img").attr("src",$(this).children("#gesture_thin_line_img").attr("src")),sviewFrameDiv.find("#gesture_bar_third_main_img").attr("title",$(this).children("#gesture_thin_line_img").attr("title")),l=0}),sviewFrameDiv.find("#gesture_undo").click(function(){}),sviewFrameDiv.find("#gesture_exit").click(function(){sviewFrameDiv.find("#gesture_bar").hasClass("hide")||(sviewFrameDiv.find("#gesture_bar_third_main_img").attr("alt","粗细"),sviewFrameDiv.find("#gesture_bar_third_main_img").attr("src","Platform/Ctrls/SView/sview/css/images/button_gesture3D_width.png"),sviewFrameDiv.find("#gesture_bar_third_main_img").attr("title",getLocalizedString(language,"GestureMenuTitle","gesture_bar_third_main")),sviewFrameDiv.find("#gesture_strong_line").removeClass("bg-blue"),sviewFrameDiv.find("#gesture_middle_line").addClass("bg-blue"),sviewFrameDiv.find("#gesture_thin_line").removeClass("bg-blue"),l=1,sviewFrameDiv.find("#gesture_bar").addClass("hide"),sviewFrameDiv.find("#_scaleL").removeClass(BACKCOLOR[1]),sviewFrameDiv.find("#note_bar").removeClass("hide"),c.cxt.clearRect(0,0,screenWidth,screenHeight),sviewFrameDiv.find("#gesture_canvas").hide(),sviewFrameDiv.find("#gesture_bar_second_type").hasClass("show")&&sviewFrameDiv.find("#gesture_bar_second_type").removeClass("show"),sviewFrameDiv.find("#gesture_bar_third_type").hasClass("show")&&sviewFrameDiv.find("#gesture_bar_third_type").removeClass("show"),sviewFrameDiv.find("#gesture_bar_type").hasClass("show")&&sviewFrameDiv.find("#gesture_bar_type").removeClass("show"))});var o=0,v=0,l=1,c={init:function(){this.load()},load:function(){this.x=[],this.y=[],this.clickDrag=[],this.list_map=new Array,this.lock=!1,this.fontType=[1,2,3,4],this.color=["#000000","#D81E06","#1296DB","#2CB936","#F4EA2A","#E98F36","#8A8A8A","#A92DC8","#811204","#ffc0cb","#FFFFFF"],this.fontWeight=[2,5,8],this.storageFontType=this.fontType[o],this.storageColor=this.color[v],this.storageFont=this.fontWeight[l],this.$=function(e){return"string"==typeof e?document.getElementById(e):e},this.canvas=this.$("gesture_canvas"),this.canvas.getContext?($(document).on("touchmove",function(e){e.cancleable&&(e.defaultPrevented||e.preventDefault())}),this.reset(),this.revocation=this.$("gesture_undo"),this.confim=this.$("gesture_confirm"),this.w=this.canvas.width,this.h=this.canvas.height,this.touch="createTouch"in document,this.StartEvent=this.touch?"touchstart":"mousedown",this.MoveEvent=this.touch?"touchmove":"mousemove",this.EndEvent=this.touch?"touchend":"mouseup",this.bind()):alert(getLocalizedString(language,"warning","browserNotSupportCanvas"))},reset:function(){this.canvas&&(this.cxt=this.canvas.getContext("2d"),this.cxt.lineJoin="round",this.cxt.lineWidth=this.storageFont,this.cxt.strokeStyle=this.storageColor)},bind:function(){var a=this;this.canvas["on"+a.StartEvent]=function(e){a.width=sviewFrameDiv.width(),a.height=sviewFrameDiv.height(),a.w=sviewFrameDiv.width(),a.h=sviewFrameDiv.height(),e.cancleable&&(e.defaultPrevented||e.preventDefault());var i=a.touch?e.touches[0]:e,s=null!=i.offsetX?i.offsetX:e.layerX?e.layerX:i.clientX,t=null!=i.offsetY?i.offsetY:e.layerY?e.layerY:i.clientY;a.movePoint(s,t),1==a.storageFontType&&a.drawPoint(),a.lock=!0},this.canvas["on"+a.MoveEvent]=function(e){a.width=sviewFrameDiv.width(),a.height=sviewFrameDiv.height(),a.w=sviewFrameDiv.width(),a.h=sviewFrameDiv.height(),e.cancleable&&(e.defaultPrevented||e.preventDefault());var i=a.touch?e.touches[0]:e;if(a.lock){var s=null!=i.offsetX?i.offsetX:e.layerX?e.layerX:i.clientX,t=null!=i.offsetY?i.offsetY:e.layerY?e.layerY:i.clientY;a.movePoint(s,t,!0),a.drawPoint()}},this.canvas["on"+a.EndEvent]=function(e){a.width=sviewFrameDiv.width(),a.height=sviewFrameDiv.height(),a.w=sviewFrameDiv.width(),a.h=sviewFrameDiv.height();var i={};i.x=a.x,i.y=a.y,i.clickDrag=a.clickDrag,i.color=a.cxt.strokeStyle,i.font=a.cxt.lineWidth,a.list_map.push(i),a.lock=!1,a.x=[],a.y=[],a.clickDrag=[]},this.revocation.onclick=function(){a.redraw(),console.log(a.list_map),2!=a.storageFontType&&3!=a.storageFontType&&4!=a.storageFontType||(a.list_map=[])},this.confim.onclick=function(){sview.Create3DGestureNote(a.list_map,a.storageFontType),c.cxt.clearRect(0,0,screenWidth,screenHeight),c.list_map.length=0},this.changeColor()},movePoint:function(e,i,s){if(0<this.x.length){var t=this.x[this.x.length-1],a=this.y[this.y.length-1];(9<=e*e+i*i-(t*t+a*a)||9<=t*t+a*a-(e*e+i*i))&&(this.x.push(e),this.y.push(i),this.clickDrag.push(i))}else this.x.push(e),this.y.push(i),this.clickDrag.push(i)},drawPoint:function(e,i,s){for(var t=0;t<this.x.length;t++)1==this.storageFontType&&(this.cxt.beginPath(),this.clickDrag[t]&&t?this.cxt.moveTo(this.x[t-1],this.y[t-1]):this.cxt.moveTo(this.x[t]-1,this.y[t]),this.cxt.lineTo(this.x[t],this.y[t]),this.cxt.closePath(),this.cxt.stroke()),2==this.storageFontType&&(this.cxt.clearRect(0,0,screenWidth,screenHeight),this.cxt.beginPath(),this.cxt.arc(this.x[0],this.y[0],Math.pow((this.x[t]-this.x[0])*(this.x[t]-this.x[0])+(this.y[t]-this.y[0])*(this.y[t]-this.y[0]),.5),0,2*Math.PI,!0),this.cxt.stroke()),3==this.storageFontType&&(this.cxt.clearRect(0,0,screenWidth,screenHeight),this.cxt.strokeRect(this.x[0],this.y[0],this.x[t]-this.x[0],this.y[t]-this.y[0])),4==this.storageFontType&&(this.cxt.clearRect(0,0,screenWidth,screenHeight),this.cxt.beginPath(),this.cxt.moveTo(this.x[0]+(this.x[t]-this.x[0])/2,this.y[0]),this.cxt.lineTo(this.x[0],this.y[t]),this.cxt.lineTo(this.x[t],this.y[t]),this.cxt.closePath(),this.cxt.stroke())},redraw:function(){var e=this;if(e.cxt.restore(),e.cxt.clearRect(0,0,screenWidth,screenHeight),1==e.storageFontType){e.list_map.pop();for(var i=0;i<e.list_map.length;i++){var s=e.list_map[i];e.cxt.strokeStyle=s.color,e.cxt.lineWidth=s.font;for(var t=0;t<s.x.length;t++)e.cxt.beginPath(),s.clickDrag[t]&&t?e.cxt.moveTo(s.x[t-1],s.y[t-1]):e.cxt.moveTo(s.x[t]-1,s.y[t]),e.cxt.lineTo(s.x[t],s.y[t]),e.cxt.closePath(),e.cxt.stroke()}}e.cxt.lineWidth=e.storageFont,e.cxt.strokeStyle=e.storageColor},preventDefault:function(e){var i=this.touch?e.touches[0]:e;this.touch?i.preventDefault():window.event.returnValue=!1},changeColor:function(){for(var e=this,i=this.$("gesture_bar_type").getElementsByTagName("a"),s=this.$("gesture_bar_second_type").getElementsByTagName("a"),t=this.$("gesture_bar_third_type").getElementsByTagName("a"),a=0,n=i.length;a<n;a++)e.cxt.save(),i[a].index=a,i[a].onclick=function(){e.storageFontType=e.fontType[this.index]};for(a=0,n=s.length;a<n;a++)s[a].index=a,s[a].onclick=function(){e.cxt.save(),e.cxt.strokeStyle=e.color[this.index],e.storageColor=e.color[this.index],e.cxt.strokeStyle=e.storageColor};for(a=0,n=t.length;a<n;a++)e.cxt.save(),t[a].index=a,t[a].onclick=function(){e.cxt.lineWidth=e.fontWeight[this.index],e.storageFont=e.fontWeight[this.index],e.cxt.strokeStyle=e.storageColor}}};sviewFrameDiv.find("#_note").click(function(e){sviewFrameDiv.find("#note_bar").hasClass("hide")&&(sviewFrameDiv.find("#bottomMenu").addClass("hide"),sviewFrameDiv.find("#mainMenu").removeClass(BACKCOLOR[1]),sviewFrameDiv.find(".pull-right").hide(),sviewFrameDiv.find("#note_bar").removeClass("hide"),sview.onAnnotationBase(),sview.GetSelector().Clear(),$("#context-menu").addClass("disabled"))}),sviewFrameDiv.find("#node_exit").click(function(e){sviewFrameDiv.find("#note_bar").hasClass("hide")||(sviewFrameDiv.find("#note_bar").addClass("hide"),sviewFrameDiv.find("#bottomMenu").removeClass("hide"),sviewFrameDiv.find("#mainMenu").addClass(BACKCOLOR[1]),sviewFrameDiv.find(".pull-right").show(),sviewFrameDiv.find("#node_text").removeClass(BACKCOLOR[1]),sviewFrameDiv.find("#node_component").removeClass(BACKCOLOR[1]),sviewFrameDiv.find("#node_sequence").removeClass(BACKCOLOR[1]),sviewFrameDiv.find("#node_voice").removeClass(BACKCOLOR[1]),sviewFrameDiv.find("#node_hotspot").removeClass(BACKCOLOR[1]),sview.onAnnotationExit())}),sviewFrameDiv.find("#node_text").click(function(e){sviewFrameDiv.find("#node_text").hasClass(BACKCOLOR[1])?sviewFrameDiv.find("#node_text").removeClass(BACKCOLOR[1]):(sviewFrameDiv.find("#node_voice").removeClass(BACKCOLOR[1]),sviewFrameDiv.find("#node_sequence").removeClass(BACKCOLOR[1]),sviewFrameDiv.find("#node_component").removeClass(BACKCOLOR[1]),sviewFrameDiv.find("#node_text").addClass(BACKCOLOR[1]),sviewFrameDiv.find("#node_hotspot").removeClass(BACKCOLOR[1])),sview.onTextNote()}),sviewFrameDiv.find("#node_del").click(function(e){sview.onNoteDelete()}),sviewFrameDiv.find("#node_voice").click(function(e){sviewFrameDiv.find("#node_voice").hasClass(BACKCOLOR[1])?sviewFrameDiv.find("#node_voice").removeClass(BACKCOLOR[1]):(sviewFrameDiv.find("#node_text").removeClass(BACKCOLOR[1]),sviewFrameDiv.find("#node_sequence").removeClass(BACKCOLOR[1]),sviewFrameDiv.find("#node_voice").addClass(BACKCOLOR[1]),sviewFrameDiv.find("#node_hotspot").removeClass(BACKCOLOR[1]))}),sviewFrameDiv.find("#node_sequence").click(function(e){sviewFrameDiv.find("#node_sequence").hasClass(BACKCOLOR[1])?sviewFrameDiv.find("#node_sequence").removeClass(BACKCOLOR[1]):(sviewFrameDiv.find("#node_text").removeClass(BACKCOLOR[1]),sviewFrameDiv.find("#node_sequence").addClass(BACKCOLOR[1]),sviewFrameDiv.find("#node_component").removeClass(BACKCOLOR[1]),sviewFrameDiv.find("#node_voice").removeClass(BACKCOLOR[1]),sviewFrameDiv.find("#node_hotspot").removeClass(BACKCOLOR[1])),sview.onSequenceNote()}),sviewFrameDiv.find("#node_component").click(function(e){sviewFrameDiv.find("#node_component").hasClass(BACKCOLOR[1])?sviewFrameDiv.find("#node_component").removeClass(BACKCOLOR[1]):(sviewFrameDiv.find("#node_text").removeClass(BACKCOLOR[1]),sviewFrameDiv.find("#node_sequence").removeClass(BACKCOLOR[1]),sviewFrameDiv.find("#node_component").addClass(BACKCOLOR[1]),sviewFrameDiv.find("#node_voice").removeClass(BACKCOLOR[1]),sviewFrameDiv.find("#node_hotspot").removeClass(BACKCOLOR[1])),sview.onComponentNameNote()}),sviewFrameDiv.find("#node_hotspot").click(function(e){sviewFrameDiv.find("#node_hotspot").hasClass(BACKCOLOR[1])?sviewFrameDiv.find("#node_hotspot").removeClass(BACKCOLOR[1]):(sviewFrameDiv.find("#node_text").removeClass(BACKCOLOR[1]),sviewFrameDiv.find("#node_sequence").removeClass(BACKCOLOR[1]),sviewFrameDiv.find("#node_component").removeClass(BACKCOLOR[1]),sviewFrameDiv.find("#node_hotspot").addClass(BACKCOLOR[1]),sviewFrameDiv.find("#node_voice").removeClass(BACKCOLOR[1])),sview.onSHotSpot()}),sviewFrameDiv.find("#node_edit").click(function(e){if(1<sview.GetSelector().GetAll().length)return CreateInfoWindow(e,getLocalizedString(language,"Alert","Alert_Prompt"),getLocalizedString(language,"Edit","TextNoteMulEdit")),void sview.GetSelector().Clear();if(0<sview.GetSelector().GetAll().length&&sview.CanEditNote()){$("#editNote").modal("show");var i=sview.GetSelector().GetAll();$("#editNote_input").val(i[0].getText()),sviewFrameDiv.find("#confirmEditNote").click(function(){isConfirmTextNote=!0;var e=sview.GetSelector().GetAll()[0],i=$("#editNote_input").val();isNaN(i,10)&&sview.editSequenceNote()?alert(getLocalizedString(language,"TextNote","InputNumber")):sview.UpdateNote(e.GetID(),$("#editNote_input").val()),sviewFrameDiv.find("#confirmEditNote").unbind("click"),$("#editNote_input").val(getLocalizedString(language,"TextNote","InputContent")),document.getElementById("editNote_input").style.color="gray"}),sviewFrameDiv.find("#cancleEditNote").click(function(){sviewFrameDiv.find("#cancleEditNote").unbind("click")}),$("#editNote").on("hide.bs.modal",function(){isConfirmTextNote})}}),sviewFrameDiv.find("#measure").click(function(e){sview.getMeasureLicence()&&sviewFrameDiv.find("#measure_bar").hasClass("hide")&&(sviewFrameDiv.find("#bottomMenu").addClass("hide"),sviewFrameDiv.find("#mainMenu").removeClass(BACKCOLOR[1]),sviewFrameDiv.find(".pull-right").hide(),sviewFrameDiv.find("#measure_bar").removeClass("hide"),$("#measureDistance").show(),$("#measureProperty").hide(),$("#measureAngle").hide(),sview.onMeasureBase(),sview.GetSelector().Clear(),$("#context-menu").addClass("disabled"),g(0),sview.loadMeasure())});var m=0;function w(e){switch(m){case 1:sviewFrameDiv.find("#measure_PntToPnt").removeClass(BACKCOLOR[1]);break;case 2:sviewFrameDiv.find("#measure_PntToLine").removeClass(BACKCOLOR[1]);break;case 3:sviewFrameDiv.find("#measure_PntToFace").removeClass(BACKCOLOR[1]);break;case 4:sviewFrameDiv.find("#measure_LineToLine").removeClass(BACKCOLOR[1]);break;case 5:sviewFrameDiv.find("#measure_LineToFace").removeClass(BACKCOLOR[1]);break;case 6:sviewFrameDiv.find("#measure_FaceToFace").removeClass(BACKCOLOR[1]);break;case 11:sviewFrameDiv.find("#measure_LineWithLine").removeClass(BACKCOLOR[1]);break;case 12:sviewFrameDiv.find("#measure_LineWithFace").removeClass(BACKCOLOR[1]);break;case 13:sviewFrameDiv.find("#measure_FaceWithFace").removeClass(BACKCOLOR[1]);break;case 21:sviewFrameDiv.find("#measure_Point").removeClass(BACKCOLOR[1]);break;case 22:sviewFrameDiv.find("#measure_Line").removeClass(BACKCOLOR[1]);break;case 23:sviewFrameDiv.find("#measure_Face").removeClass(BACKCOLOR[1]);break;case 24:sviewFrameDiv.find("#measure_Model").removeClass(BACKCOLOR[1])}$("#measurePorpertyList").addClass("hide")}function g(e){w(),m=0,sview.GetSelector().Clear(),sview.onMeasureBase(),767<screenWidth?(sviewFrameDiv.find("#measureBar").width(0===e?"415px":"280px"),sviewFrameDiv.find("#commonEdit").width(0===e?"90px":1===e?"90px":"45px")):375<=screenWidth<=767?(sviewFrameDiv.find("#measureBar").width(0===e?"330px":"230px"),sviewFrameDiv.find("#commonEdit").width(0===e?"90px":1===e?"90px":"45px")):screenWidth<=375&&(sviewFrameDiv.find("#measureBar").width(0===e?"310px":"205px"),sviewFrameDiv.find("#commonEdit").width(0===e?"90px":1===e?"90px":"45px")),sviewFrameDiv.find("#measure_bar_third_type").removeClass("show")}sviewFrameDiv.find("#measure_CurrentType").click(function(){sviewFrameDiv.find("#measure_bar_third_type").hasClass("show")?sviewFrameDiv.find("#measure_bar_third_type").removeClass("show"):sviewFrameDiv.find("#measure_bar_third_type").addClass("show")}),sviewFrameDiv.find(".measure").click(function(e){sviewFrameDiv.find(".measure").removeClass(BACKCOLOR[0]),$(this).addClass(BACKCOLOR[0]),e.stopPropagation()});var u=0;sviewFrameDiv.find("#measure_Type_Distance").click(function(){g(0),sviewFrameDiv.find("#measure_CurrentType_Image").attr("src",sviewBaseUrl+"Platform/Ctrls/SView/sview/css/images/sview_measure_distance.png"),sviewFrameDiv.find("#measure_CurrentType_Image").attr("title",$(this).children("img").attr("title")),$("#measureDistance").show(),$("#measureProperty").hide(),$("#measureAngle").hide(),$("#measure_del").hasClass("hide")&&$("#measure_del").removeClass("hide"),u=0}),sviewFrameDiv.find("#measure_Type_Angle").click(function(e){if(M3D.Parameters.Instance().isMergeFace)switch(CreateInfoWindow(e,getLocalizedString(language,"Alert","Alert_Prompt"),getLocalizedString(language,"Alert","Alert_MergeFace")),u){case 0:sviewFrameDiv.find(".measure").removeClass(BACKCOLOR[0]),sviewFrameDiv.find("#measure_Type_Distance").addClass(BACKCOLOR[0]);break;case 2:sviewFrameDiv.find(".measure").removeClass(BACKCOLOR[0]),sviewFrameDiv.find("#measure_Type_Property").addClass(BACKCOLOR[0])}else g(1),sviewFrameDiv.find("#measure_CurrentType_Image").attr("src",sviewBaseUrl+"Platform/Ctrls/SView/sview/css/images/sview_measure_angle.png"),sviewFrameDiv.find("#measure_CurrentType_Image").attr("title",$(this).children("img").attr("title")),$("#measureDistance").hide(),$("#measureProperty").hide(),$("#measureAngle").show(),$("#measure_del").hasClass("hide")&&$("#measure_del").removeClass("hide"),u=1}),sviewFrameDiv.find("#measure_Type_Property").click(function(){g(2),sviewFrameDiv.find("#measure_CurrentType_Image").attr("src",sviewBaseUrl+"Platform/Ctrls/SView/sview/css/images/sview_measure_attributes.png"),sviewFrameDiv.find("#measure_CurrentType_Image").attr("title",$(this).children("img").attr("title")),$("#measureDistance").hide(),$("#measureProperty").show(),$("#measureAngle").hide(),$("#measure_del").hasClass("hide")||$("#measure_del").addClass("hide"),u=2}),sviewFrameDiv.find(".measureBackground").click(function(e){w()}),sviewFrameDiv.find("#measure_PntToPnt").click(function(e){1!==m?(m=1,sviewFrameDiv.find("#measure_PntToPnt").addClass(BACKCOLOR[1])):m=0,sview.onMeasureDistancePntToPnt()}),sviewFrameDiv.find("#measure_PntToLine").click(function(e){if(M3D.Parameters.Instance().isMergeFace)switch(CreateInfoWindow(e,getLocalizedString(language,"Alert","Alert_Prompt"),getLocalizedString(language,"Alert","Alert_MergeFace")),m){case 1:sviewFrameDiv.find("#measure_PntToPnt").addClass(BACKCOLOR[1]);break;case 21:sviewFrameDiv.find("#measure_Point").addClass(BACKCOLOR[1]);break;case 24:sviewFrameDiv.find("#measure_Model").addClass(BACKCOLOR[1])}else 2!==m?(m=2,sviewFrameDiv.find("#measure_PntToLine").addClass(BACKCOLOR[1])):m=0,sview.onMeasureDistancePntToLine()}),sviewFrameDiv.find("#measure_PntToFace").click(function(e){if(M3D.Parameters.Instance().isMergeFace)switch(CreateInfoWindow(e,getLocalizedString(language,"Alert","Alert_Prompt"),getLocalizedString(language,"Alert","Alert_MergeFace")),m){case 1:sviewFrameDiv.find("#measure_PntToPnt").addClass(BACKCOLOR[1]);break;case 21:sviewFrameDiv.find("#measure_Point").addClass(BACKCOLOR[1]);break;case 24:sviewFrameDiv.find("#measure_Model").addClass(BACKCOLOR[1])}else 3!==m?(m=3,sviewFrameDiv.find("#measure_PntToFace").addClass(BACKCOLOR[1])):m=0,sview.onMeasureDistancePntToFace()}),sviewFrameDiv.find("#measure_LineToLine").click(function(e){if(M3D.Parameters.Instance().isMergeFace)switch(CreateInfoWindow(e,getLocalizedString(language,"Alert","Alert_Prompt"),getLocalizedString(language,"Alert","Alert_MergeFace")),m){case 1:sviewFrameDiv.find("#measure_PntToPnt").addClass(BACKCOLOR[1]);break;case 21:sviewFrameDiv.find("#measure_Point").addClass(BACKCOLOR[1]);break;case 24:sviewFrameDiv.find("#measure_Model").addClass(BACKCOLOR[1])}else 4!==m?(m=4,sviewFrameDiv.find("#measure_LineToLine").addClass(BACKCOLOR[1])):m=0,sview.onMeasureDistanceLineToLine()}),sviewFrameDiv.find("#measure_LineToFace").click(function(e){if(M3D.Parameters.Instance().isMergeFace)switch(CreateInfoWindow(e,getLocalizedString(language,"Alert","Alert_Prompt"),getLocalizedString(language,"Alert","Alert_MergeFace")),m){case 1:sviewFrameDiv.find("#measure_PntToPnt").addClass(BACKCOLOR[1]);break;case 21:sviewFrameDiv.find("#measure_Point").addClass(BACKCOLOR[1]);break;case 24:sviewFrameDiv.find("#measure_Model").addClass(BACKCOLOR[1])}else 5!==m?(m=5,sviewFrameDiv.find("#measure_LineToFace").addClass(BACKCOLOR[1])):m=0,sview.onMeasureDistanceLineToFace()}),sviewFrameDiv.find("#measure_FaceToFace").click(function(e){if(M3D.Parameters.Instance().isMergeFace)switch(CreateInfoWindow(e,getLocalizedString(language,"Alert","Alert_Prompt"),getLocalizedString(language,"Alert","Alert_MergeFace")),m){case 1:sviewFrameDiv.find("#measure_PntToPnt").addClass(BACKCOLOR[1]);break;case 21:sviewFrameDiv.find("#measure_Point").addClass(BACKCOLOR[1]);break;case 24:sviewFrameDiv.find("#measure_Model").addClass(BACKCOLOR[1])}else 6!==m?(m=6,sviewFrameDiv.find("#measure_FaceToFace").addClass(BACKCOLOR[1])):m=0,sview.onMeasureDistanceFaceToFace()}),sviewFrameDiv.find("#measure_LineWithLine").click(function(e){if(M3D.Parameters.Instance().isMergeFace)switch(CreateInfoWindow(e,getLocalizedString(language,"Alert","Alert_Prompt"),getLocalizedString(language,"Alert","Alert_MergeFace")),m){case 1:sviewFrameDiv.find("#measure_PntToPnt").addClass(BACKCOLOR[1]);break;case 21:sviewFrameDiv.find("#measure_Point").addClass(BACKCOLOR[1]);break;case 24:sviewFrameDiv.find("#measure_Model").addClass(BACKCOLOR[1])}else 11!==m?(m=11,sviewFrameDiv.find("#measure_LineWithLine").addClass(BACKCOLOR[1])):m=0,sview.onMeasureAngleLineToLine()}),sviewFrameDiv.find("#measure_LineWithFace").click(function(e){if(M3D.Parameters.Instance().isMergeFace)switch(CreateInfoWindow(e,getLocalizedString(language,"Alert","Alert_Prompt"),getLocalizedString(language,"Alert","Alert_MergeFace")),m){case 1:sviewFrameDiv.find("#measure_PntToPnt").addClass(BACKCOLOR[1]);break;case 21:sviewFrameDiv.find("#measure_Point").addClass(BACKCOLOR[1]);break;case 24:sviewFrameDiv.find("#measure_Model").addClass(BACKCOLOR[1])}else 12!==m?(m=12,sviewFrameDiv.find("#measure_LineWithFace").addClass(BACKCOLOR[1])):m=0,sview.onMeasureAngleLineToFace()}),sviewFrameDiv.find("#measure_FaceWithFace").click(function(e){if(M3D.Parameters.Instance().isMergeFace)switch(CreateInfoWindow(e,getLocalizedString(language,"Alert","Alert_Prompt"),getLocalizedString(language,"Alert","Alert_MergeFace")),m){case 1:sviewFrameDiv.find("#measure_PntToPnt").addClass(BACKCOLOR[1]);break;case 21:sviewFrameDiv.find("#measure_Point").addClass(BACKCOLOR[1]);break;case 24:sviewFrameDiv.find("#measure_Model").addClass(BACKCOLOR[1])}else 13!==m?(m=13,sviewFrameDiv.find("#measure_FaceWithFace").addClass(BACKCOLOR[1])):m=0,sview.onMeasureAngleFaceToFace()}),sviewFrameDiv.find("#measure_Point").click(function(e){21!==m?(m=21,sviewFrameDiv.find("#measure_Point").addClass(BACKCOLOR[1])):m=0,sview.onMeasurePropertyPoint()}),sviewFrameDiv.find("#measure_Line").click(function(e){if(M3D.Parameters.Instance().isMergeFace)switch(CreateInfoWindow(e,getLocalizedString(language,"Alert","Alert_Prompt"),getLocalizedString(language,"Alert","Alert_MergeFace")),m){case 1:sviewFrameDiv.find("#measure_PntToPnt").addClass(BACKCOLOR[1]);break;case 21:sviewFrameDiv.find("#measure_Point").addClass(BACKCOLOR[1]),$("#measurePorpertyList").removeClass("hide");break;case 24:sviewFrameDiv.find("#measure_Model").addClass(BACKCOLOR[1]),$("#measurePorpertyList").removeClass("hide")}else 22!==m?(m=22,sviewFrameDiv.find("#measure_Line").addClass(BACKCOLOR[1])):m=0,sview.onMeasurePropertyLine()}),sviewFrameDiv.find("#measure_Face").click(function(e){if(M3D.Parameters.Instance().isMergeFace)switch(CreateInfoWindow(e,getLocalizedString(language,"Alert","Alert_Prompt"),getLocalizedString(language,"Alert","Alert_MergeFace")),m){case 1:sviewFrameDiv.find("#measure_PntToPnt").addClass(BACKCOLOR[1]);break;case 21:sviewFrameDiv.find("#measure_Point").addClass(BACKCOLOR[1]),$("#measurePorpertyList").removeClass("hide");break;case 24:sviewFrameDiv.find("#measure_Model").addClass(BACKCOLOR[1]),$("#measurePorpertyList").removeClass("hide")}else 23!==m?(m=23,sviewFrameDiv.find("#measure_Face").addClass(BACKCOLOR[1])):m=0,sview.onMeasurePropertyFace()}),sviewFrameDiv.find("#measure_Model").click(function(e){24!==m?(m=24,sviewFrameDiv.find("#measure_Model").addClass(BACKCOLOR[1])):m=0,sview.onMeasurePropertyModel()}),sviewFrameDiv.find("#measure_del").click(function(e){sview.onNoteDelete()}),sviewFrameDiv.find("#measure_exit").click(function(e){sviewFrameDiv.find("#measure_bar").hasClass("hide")||(sviewFrameDiv.find("#measure_bar").addClass("hide"),sviewFrameDiv.find("#bottomMenu").removeClass("hide"),sviewFrameDiv.find("#mainMenu").addClass(BACKCOLOR[1]),sviewFrameDiv.find(".pull-right").show(),sviewFrameDiv.find("#measure_PntToPnt").removeClass(BACKCOLOR[1]),sviewFrameDiv.find("#measure_bar_third_type").removeClass("show"),sview.onMeasureExit(),w(),0!==u&&(sviewFrameDiv.find(2===u?"#measure_Type_Property":"#measure_Type_Angle").removeClass(BACKCOLOR[0]),sviewFrameDiv.find("#measure_Type_Distance").addClass(BACKCOLOR[0])),sviewFrameDiv.find("#measure_CurrentType_Image").attr("src",sviewBaseUrl+"Platform/Ctrls/SView/sview/css/images/sview_measure_distance.png"),$("#measurePorpertyList").addClass("hide"),sview.removeMeasure())});var h={},f=navigator.platform;h.win=0==f.indexOf("Win"),h.mac=0==f.indexOf("Mac"),h.x11="X11"==f||0==f.indexOf("Linux"),h.win||h.mac||h.xll?$("#ani_percentage").mousedown(function(e){t.animationStatus&&sview.Pause(),e.stopPropagation()}).mouseup(function(e){sview.animationPlayer.SetPercent(100*$("#ani_percentage").val()),t.animationStatus&&sview.Play()}):(document.getElementById("ani_percentage").addEventListener("touchstart",function(e){t.animationStatus&&sview.Pause(),e.stopPropagation()},!1),document.getElementById("ani_percentage").addEventListener("touchstart",function(e){sview.animationPlayer.SetPercent(100*$("#ani_percentage").val())},!1),document.getElementById("ani_percentage").addEventListener("touchend",function(e){sview.animationPlayer.SetPercent(100*$("#ani_percentage").val()),t.animationStatus&&sview.Play()},!1)),sviewFrameDiv.find("#autoWalk").click(function(e){sview.animationPlayer.SetAutoWalkCamera($("#autoWalk").is(":checked")),M3D.CookieHelper.AddCookie("sview_autoWalk",$("#autoWalk").is(":checked"),30),e.stopPropagation()}),sviewFrameDiv.find("#speedSelect").on("change",function(e){e.stopPropagation(),sview.animationPlayer.SetSpeed($("#speedSelect option:selected").val()),M3D.CookieHelper.AddCookie("sview_speedSelect",$("#speedSelect option:selected").val(),30)}),sviewFrameDiv.find("#aniLoop").click(function(e){sview.animationPlayer.SetLoop($("#aniLoop").is(":checked")),M3D.CookieHelper.AddCookie("sview_aniLoop",$("#aniLoop").is(":checked"),30)}),sviewFrameDiv.find(".ani-pause").click(function(e){t.animationStatus?r():($(".ani-pause").html("<img src='"+sviewBaseUrl+"Platform/Ctrls/SView/sview/css/images/button_ani_pause.png' alt='暂停' title='暂停'>"),options[0].animationStatus=!0,sview.Play()),e.stopPropagation()}),sviewFrameDiv.find("#walking_touch_handler").click(function(e){var i=this.checked;if("block"==$("#infoModal").css("display")&&$("#infoModal").modal("hide"),i){sview.SetUsingTouchHandlerType(0),sview.SetObserveMode(0,!1),CreateJoystick(),t.isOpenJoystick=!0;var s=M3D.CookieHelper.GetCookie("walkThroughUpdirection");s&&$(".walking_updirection ").val(s),sviewFrameDiv.find("#perspective").hasClass(BACKCOLOR[0])||sviewFrameDiv.find("#perspective").addClass(BACKCOLOR[0])}else{DestoryJoystick(),t.isOpenJoystick=!1,sview.SetUsingTouchHandlerType(1),sview.SetObserveMode(sview.view.commonTouchHandler.oberveMode,!1),sviewFrameDiv.find("#perspective").hasClass(BACKCOLOR[0])&&sviewFrameDiv.find("#perspective").removeClass(BACKCOLOR[0])}e.stopPropagation()}),sviewFrameDiv.find("#walking_joystick").click(function(e){if(!(sview.view.GetTouchHandler()instanceof M3D.WalkthroughHandler))return CreateInfoWindow(e,getLocalizedString(language,"Prompt","Prompt"),getLocalizedString(language,"Alert","Alert_Context")),this.checked=!1,e.stopPropagation(),!0;var i=this.checked;t.isOpenJoystick=i?(null==joystick&&CreateJoystick(),!0):(DestoryJoystick(),!1),e.stopPropagation()}),$(".walking_speed").mousedown(function(e){return!!(sview.view.GetTouchHandler()instanceof M3D.WalkthroughHandler)||(CreateInfoWindow(e,getLocalizedString(language,"Prompt","Prompt"),getLocalizedString(language,"Alert","Alert_Context")),this.checked=!1)}),sviewFrameDiv.find(".walking_speed").click(function(e){e.stopPropagation()}),sviewFrameDiv.find(".walking_speed").change(function(e){switch($(this).val()){case"0.05x":sview.SetWalkingSpeed(.05);break;case"0.25x":sview.SetWalkingSpeed(.25);break;case"0.5x":sview.SetWalkingSpeed(.5);break;case"0.75x":sview.SetWalkingSpeed(.75);break;case"1x":sview.SetWalkingSpeed(1);break;case"2x":sview.SetWalkingSpeed(2);break;case"4x":sview.SetWalkingSpeed(4);break;case"6x":sview.SetWalkingSpeed(6)}e.stopPropagation()}),$(".walking_updirection").mousedown(function(e){return!!(sview.view.GetTouchHandler()instanceof M3D.WalkthroughHandler)||(CreateInfoWindow(e,getLocalizedString(language,"Prompt","Prompt"),getLocalizedString(language,"Alert","Alert_Context")),this.checked=!1)}),sviewFrameDiv.find(".walking_updirection").click(function(e){e.stopPropagation()}),sviewFrameDiv.find(".walking_updirection").change(function(e){switch($(this).val()){case"0":sview.SetUpdirection(0);break;case"1":sview.SetUpdirection(1);break;case"2":sview.SetUpdirection(2);break;case"3":sview.SetUpdirection(3);break;case"4":sview.SetUpdirection(4);break;case"5":sview.SetUpdirection(5)}e.stopPropagation()}),$(".walking_fov").mousedown(function(e){return!!(sview.view.GetTouchHandler()instanceof M3D.WalkthroughHandler)||(CreateInfoWindow(e,getLocalizedString(language,"Prompt","Prompt"),getLocalizedString(language,"Alert","Alert_Context")),this.checked=!1)}),sviewFrameDiv.find(".walking_fov").click(function(e){e.stopPropagation()}),sviewFrameDiv.find(".walking_fov").change(function(e){switch($(this).val()){case"50°":sview.SetCameraFov(50);break;case"60°":sview.SetCameraFov(60);break;case"70°":sview.SetCameraFov(70);break;case"80°":sview.SetCameraFov(80);break;case"90°":sview.SetCameraFov(90);break;case"100°":sview.SetCameraFov(100);break;case"110°":sview.SetCameraFov(110);break;case"120°":sview.SetCameraFov(120);break;case"130°":sview.SetCameraFov(130);break;case"140°":sview.SetCameraFov(140);break;case"150°":sview.SetCameraFov(150)}e.stopPropagation()}),$("#contextmenudiv").on("click","a",function(e){sviewFrameDiv.find(".contextMenu").removeClass(BACKCOLOR[0]),$(this).addClass(BACKCOLOR[0]),e.stopPropagation()}),$("#contextmenudiv").on("click",'[id="contextMenu0"]',function(e){sview.IsUseModelContextMenu()?selectionOperator.HideCurrent():t.usem2&&selectionOperator.ExchangeHidden()}),$("#contextmenudiv").on("click",'[id="contextMenu1"]',function(e){sview.IsUseModelContextMenu()?$(e.target).click(void selectionOperator.OnlyDisplayCurrent()):t.usem2&&selectionOperator.DisplayAll()}),$("#contextmenudiv").on("click",'[id="contextMenu2"]',function(e){sview.IsUseModelContextMenu()?selectionOperator.DisplayInCenter():t.usem2&&(sview.SetUsingTouchHandlerType(3),sviewFrameDiv.find("#dagger_bar").show(),sviewFrameDiv.find(".dface").addClass(BACKCOLOR[0]))}),$("#contextmenudiv").on("click",'[id="contextMenu3"]',function(e){sview.IsUseModelContextMenu()?selectionOperator.ContinuousRotation():t.usem2&&selectionOperator.DisplayInCenter()}),$("#contextmenudiv").on("click",'[id="contextMenu4"]',function(e){sview.IsUseModelContextMenu()?$(e.target).click(void $("#aboutModal").modal("toggle")):t.usem2&&selectionOperator.ContinuousRotation()}),$("#contextmenudiv").on("click",'[id="contextMenu5"]',function(e){sview.IsUseModelContextMenu()||t.usem2&&$(e.target).click(void $("#aboutModal").modal("toggle"))});var _=1;sviewFrameDiv.find(".rotation").click(function(){$("#context-menu").addClass("disabled"),1==_?(sview.SetRotateSpeed(2),sviewFrameDiv.find("#RAndEimage").attr("src",sviewBaseUrl+"Platform/Ctrls/SView/sview/css/images/rotation-2.png"),_++):2==_?(sview.SetRotateSpeed(4),sviewFrameDiv.find("#RAndEimage").attr("src",sviewBaseUrl+"Platform/Ctrls/SView/sview/css/images/rotation-4.png"),_++):3==_&&(sview.EndRotateAndExplosive(),$(this).hide(),sviewFrameDiv.find("#animation").removeClass("bg-yellow"),sviewFrameDiv.find(".pull-right").show(),sviewFrameDiv.find("#bottomMenu").removeClass("hide"),sviewFrameDiv.find("#mainMenu").addClass(BACKCOLOR[1]),_=1,RestoreView())}),sviewFrameDiv.find(".backcolor").click(function(){var e,i;switch($(this).find("img").attr("id")){case"white":i=new M3D.Color(1,1,1),e=new M3D.Color(1,1,1);break;case"black":i=new M3D.Color(0,0,0),e=new M3D.Color(0,0,0);break;case"179.179.192":i=new M3D.Color(179/255,179/255,192/255),e=new M3D.Color(179/255,179/255,192/255);break;case"234.234.234":i=new M3D.Color(234/255,234/255,234/255),e=new M3D.Color(234/255,234/255,234/255);break;case"236-248-255":i=new M3D.Color(236/255,248/255,1),e=new M3D.Color(236/255,248/255,1);break;case"148.202.239-255.255.255":i=new M3D.Color(148/255,202/255,239/255),e=new M3D.Color(1,1,1);break;case"128.128.128-240.240.240":i=new M3D.Color(128/255,128/255,128/255),e=new M3D.Color(240/255,240/255,240/255);break;case"230.230.230-170.170.170":i=new M3D.Color(230/255,230/255,230/255),e=new M3D.Color(170/255,170/255,170/255);break;case"defaultcolor":i=new M3D.Color(.25,.63,1),e=new M3D.Color(.88,.96,1)}sview.view.SetBackgroundColor(i,e),M3D.CookieHelper.AddCookie(M3D.TOP_COLOR_KEY,i.Tostring(),30),M3D.CookieHelper.AddCookie(M3D.BOTTOCOLOR_KEY,e.Tostring(),30)})}function SetPerspective(e){sview.view.CloseSceneAnimation(),sview.SetPerspective(e)}function isShowWireFrame(){sview.IsShowWireframe()}function isOnlyShowWireFrame(){sview.IsOnlyShowWireframe()}function setRenderMode(e){sview.setRenderMode(e)}function SetClipValue(e){sview.SetClipValue(e)}function SetClipDir(e){sview.SetClipDirection(e)}function SetOppositeDir(){sview.SetOppositeDir()}function IsShowClipHelppingPlane(){sview.IsShowClipHelppingPlane()}function IsShowCappingPlane(){sview.IsShowCappingPlane()}function SetExplosiveStyle(e){sview.SetExplosiveStyle(e)}function SetExplosivePersentage(e){sview.SetExplosivePersentage(e)}function SetExplosivePosition(){var e=sviewFrameDiv.find("#explosive_per")[0].value;0<=e&&e<1&&SetExplosivePersentage(e)}var joystick=null;function CreateJoystick(){(joystick=nipplejs.create({zone:sviewFrameDiv.find(".joystick")[0],position:{top:"50%",left:"50%"},mode:"static",color:""})).on("move dir start",function(e,i){if(i.angle&&i.distance){sview.joyStickOption.isJoysticPressing=!0;var s=i.angle.radian;sview.joyStickOption.strightSpd=i.distance*Math.sin(s)/80,sview.joyStickOption.sideSpd=i.distance*Math.cos(s)/-80}}).on("end",function(e,i){sview.joyStickOption.isJoysticPressing=!1}),sviewFrameDiv.find(".back").css("opacity","1.0").css("filter","alpha(opacity = 100)").css("-ms-filter","alpha(opacity=100)"),sviewFrameDiv.find(".back").append("<img src = '"+sviewBaseUrl+"Platform/Ctrls/SView/sview/css/images/back.png' style='width:100%;height:100%; position:absolute;'/>"),sviewFrameDiv.find(".front").append("<img src = '"+sviewBaseUrl+"Platform/Ctrls/SView/sview/css/images/front.png' style='width:100%;height:100%; position:absolute;'/>"),$("#walking_joystick").prop("checked",!0),sview.StartJoystick()}function RestoreSelectedModel(){sview.RestoreSelectedModel()}function SetModelColor(e,i,s){sview.SetSelectModelColor(e/255,i/255,s/255),$("#selectColor").modal("hide")}function DestoryJoystick(){sview.EndJoystick(),joystick&&(joystick.destroy(),joystick=null),$("#walking_joystick").prop("checked",!1)}function myBrowser(){var e=navigator.userAgent,i=-1<e.indexOf("Opera");return i?"Opera":-1<e.indexOf("Edge")?"Edge":-1<e.indexOf("Firefox")?"FF":-1<e.indexOf("Chrome")?"Chrome":-1<e.indexOf("Safari")?"Safari":!window.ActiveXObject||"ActiveXObject"in window?"IE":-1<e.indexOf("compatible")&&-1<e.indexOf("MSIE")&&!i?"IE":void 0}function SaveAs5(e,i){for(var s=e.split(","),t=s[0].match(/:(.*?);/)[1],a=atob(s[1]),n=a.length,r=new Uint8Array(n);n--;)r[n]=a.charCodeAt(n);var o=new Blob([r],{type:t});if("msSaveOrOpenBlob"in navigator)window.navigator.msSaveOrOpenBlob(o,i);else{var v=document.createElement("a");v.download=i,$(v).css("display","none"),v.href=URL.createObjectURL(o),document.body.appendChild(v),v.click(),document.body.removeChild(v)}}function oDownLoad(e,i){"Edge"===myBrowser()||"IE"===myBrowser()?SaveAs5(e,i):download(e,i)}function download(e,i){var s=e.replace("image/png","image/octet-stream"),t=document.createElementNS("http://www.w3.org/1999/xhtml","a");t.href=s,t.download=(new Date).getTime()+".png";var a=document.createEvent("MouseEvents");a.initMouseEvent("click",!0,!1,window,0,0,0,0,0,!1,!1,!1,!1,0,null),t.dispatchEvent(a)}
"use strict"; var imgBtn, ani_step_lit, ani_step_all, rotate, ani_autoWalk = "ani_autoWalk", ani_speed = "ani_speed", ani_loop = "ani_loop", screenWidth = document.documentElement.clientWidth, screenHeight = document.documentElement.clientHeight, topModle, isConfirmTextNote, currentJSPath = document.scripts[document.scripts.length - 1].src, currentJSArray = document.scripts[document.scripts.length - 1].src.split("/"); currentJSArray.pop(), currentJSArray.pop(); for (var jsFilePath = "", num = 0; num < currentJSArray.length; num++)jsFilePath = jsFilePath + currentJSArray[num] + "/"; var sviewBaseUrl = "", sview_anima_step_panel = null, sview_anima_step_panel_lite = null, sview_anima_step_toggle_btn = null, BACKCOLOR = ["bg-blue", "bg-yellow"], sviewList = [], frameDivList = [], options = [], renderCanvas = null, sview = null, fileInput = null, sviewFrameDiv = null, assemblyTreeId = null, isAssemlyOpen, htmlelement = null, language, random = "", getdevicelock = "", option = { isOpenCrot: !1, animationStatus: !0, ringAnimationStatus: !1, usem2: !1, isOpenJoystick: !1, walkingMode: !1, usePMI: !0, pmiServer: "http://localhost:8070/", decryptoFile: !1, decryptoServer: "" }; document.onselectstart = null; var omitformtags = ["input", "textarea"]; function disableselect() { return !!event.srcElement.tagName && (-1 != omitformtags.indexOf("|" + event.srcElement.tagName.toLowerCase() + "|") && void 0) } function stopScroll() { document.getElementsByClassName("container-fluid")[0].addEventListener("touchstart", function (e) { 1 < e.touches.length && e.preventDefault() }), document.getElementsByClassName("container-fluid")[0].addEventListener("touchmove", function (e) { 1 < e.touches.length && e.preventDefault() }); var n = 0; document.getElementsByClassName("container-fluid")[0].addEventListener("touchend", function (e) { var t = (new Date).getTime(); t - n <= 300 && e.preventDefault(), n = t }, !1) } function SViewVersion() { return "V5.0.5ceshi" } omitformtags = "|" + omitformtags.join("|") + "|", window.onresize = function () { window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth; 1 !== devicePixelRatio && setTimeout(function () { sview.view.RestoreView(), sview.view.sceneManager.GetRenderManager().RequestRedraw() }, 100), console.log(devicePixelRatio) }; var sviewframeLayoutCode = function () { }; Function.prototype.getMultiLine = function () { var e = new String(this); return e = e.substring(e.indexOf("/*") + 3, e.lastIndexOf("*/")) }; var setting = null; function initSView(m, e) { if (m = m, void 0 !== typeof e && "{}" !== JSON.stringify(e)) for (var t in e) option[t] = e[t]; var n; options.push(option), document.oncontextmenu = function () { return !1 }, $.ajax({ url: jsFilePath + "Platform/Ctrls/SView/sview/res/layouts.html?version=5.0.3", data: null, type: "GET", contentType: "text/html", async: !1, success: function (e) { n = e }, error: function (e) { alert(e.statusText) } }), n = n.replace("SViewFrameName", m + "-SViewFrame"), null != sviewBaseUrl && (n = n.replace(/'images\//g, "'" + sviewBaseUrl + "Platform/Ctrls/SView/sview/css/images/")), $("#" + m).html(n), settingAbout();var i=M3D.CookieHelper.GetCookie("languageType");null==i&&(i="cn"),$.ajax({beforeSend:function(){},type:"GET",url:jsFilePath+"Platform/Ctrls/SView/sview/lang/lang_"+i+".json?version=5.0.3",dataType:"json",contentType:"application/json; charset=utf-8",async:!1,cache:!1,success:function(e,t){language=e,$("#"+m+" *").each(function(e,t){var n=language,i=$(t).attr("langID");if(i){for(var o=i.split("."),a=0;a<o.length;a++)n=n[o[a]];$(t).html(n)}(0<=navigator.userAgent.indexOf("MSIE")&&navigator.userAgent.indexOf("Opera")<0||-1<navigator.userAgent.indexOf("Edge"))&&$(t).hasClass("mui-switch")&&($(t).width(26),$(t).height(26));var s=$(t).attr("TitleID");if(s){for(o=s.split("."),a=0;a<o.length;a++)n=n[o[a]];$(t).attr("title",n)}var l=$(t).attr("type");"range"!=l||-1<navigator.userAgent.indexOf("Edge")||window.ActiveXObject||"ActiveXObject"in window||-1<navigator.userAgent.indexOf("Firefox")?"range"==l&&(-1<navigator.userAgent.indexOf("Edge")?($(t).css("height","25px"),$(t).css("margin","0px")):(window.ActiveXObject||"ActiveXObject"in window)&&($(t).css("margin-top","-12px"),console.log("IE"))):($(t).css("background","-webkit-linear-gradient(#059CFA, #059CFA) no-repeat"),$(t).css("background-size","0% 100%"),$(t).css("margin","2.5px 0px")),"rotateswitch_label"==$(t).attr("id")&&(window.ActiveXObject||"ActiveXObject"in window)&&$(t).css("right","10px"),"mergefaceswitch_label"==$(t).attr("id")&&(window.ActiveXObject||"ActiveXObject"in window)&&$(t).css("right","10px"),"watermarkswitch_label"==$(t).attr("id")&&(window.ActiveXObject||"ActiveXObject"in window)&&$(t).css("right","10px"),"fpsswitch_label"==$(t).attr("id")&&(window.ActiveXObject||"ActiveXObject"in window)&&$(t).css("right","10px");var r=$(t).attr("id");"textNote_input"==r?$(t).attr("value",getLocalizedString(language,"TextNote","InputTextNoteContent")):"editNote_input"==r&&$(t).attr("value",getLocalizedString(language,"TextNote","InputContent")),"waterMark_input"==$(t).attr("id")&&$(t).attr("placeholder",getLocalizedString(language,"waterMark","InputWaterMarkContent"))}),stopScroll()},error:function(e,t,n){console.log("ssss")}}),assemblyTreeId=(m+="-SViewFrame")+"assebmlyTree",$("#assebmlyTreeDiv,#top_viewDiv").resizable({disabled:!1,handles:"e,s,se",minWidth:180,minHeight:10,maxWidth:500,maxHeight:320,edge:10});function o(){$("#textNote_input").focus()}setting={checked:!0,selectedMulti:!0,check:{enable:!0,chkboxType:{Y:"s",N:"s"}},data:{simpleData:{enable:!0}},callback:{onClick:onClick,onCheck:onCheck,onRightClick:onRightClick,beforeRename:beforeRename,onRename:onRename,beforeRemove:beforeRemove,onRemove:onRemove}},sviewFrameDiv=$("#"+m),renderCanvas=sviewFrameDiv.children("#renderCanvas")[0],sview=SView.CreateViewer(renderCanvas);var a=new M3D.SelectionOperator(sview.view);!function(){var e,o=0,t=($(window),$("#"+m));e=t.children("#renderCanvas")[0];var n=t.children("#myProgress"),a=t.find("#myBar"),s=t.find("#label"),i=($("#"+m)[0],t.width()-e.offsetLeft),l=t.height()-e.offsetTop,r=i/4,d=l/20,c=e.offsetLeft+(i-r)/2,p=e.offsetTop+(l-d)/2;n.css("position","absolute").css("left",c+"px").css("top",p+"px").css("width",r+"px").css("height",d+"px"),a.css("position","absolute").css("width",r+"px").css("height",d+"px"),s.css("position","absolute").css("line-height",d+"px").css("width",r+"px").css("height",d+"px");e.offsetLeft,e.offsetTop,n.hide();var u=new SView.SViewReadListener;u.onReadBegin=function(e){n.show(),e instanceof M3D.LoadingEvent?(a.css("width","0%"),o=0):a.css("width","0%")},u.onReading=function(e){n.show(),function(e){if(e instanceof M3D.LoadingEvent){var t=e.percent;o=50*t;var n=Math.floor(o)+"%";a.css("width",n),n=getLocalizedString(language,"Prompt","Downloading")+e.fileName+n,s.text(n)}else{var i=e.GetReadPercent();n=Math.floor(o+i*(100-o))+"%",a.css("width",n),n=getLocalizedString(language,"Prompt","isOpening")+"   "+e.currentFilesName+n,s.text(n)}}(e)},u.onReadEnd=function(e){a.css("width","100%"),n.hide(),null!=(topModle=e.GetModel()).GetName()&&"undefined"!=topModle.GetName()||topModle.SetName(null==e.fileName?e.currentFilesName:e.fileName),isAssemlyOpen?fileInput.value="":InitTree(e.GetModel()),RestoreView(),isAssemlyOpen=!1},setAnimation(),sview.AddReadListener(u)}(),sview.updateAssemblyTree=function(e){var t=$.fn.zTree.getZTreeObj(assemblyTreeId),n=t.getSelectedNodes(),i=new SView.JSONAssembly(e);t.addNodes(n[0],i),asmFileInput.value=""},sview.addAssemblyOver=function(){isOver=!0},sview.MeasureError=function(e){CreateInfoWindow(e,getLocalizedString(language,"Alert","Alert_Prompt"),getLocalizedString(language,"Alert","Alert_MeasureError"))},sview.openModelsEnd=function(e){"ring"===sview.getSceneManagerType()?(sviewFrameDiv.find("#animation_bar").removeClass("hide"),sviewFrameDiv.find("#animation_bar").show(),sviewFrameDiv.find("#animationbar").css({width:"45px"}),sviewFrameDiv.find(".rotation").hide(),$("#assembly").removeClass(BACKCOLOR[1]),sviewFrameDiv.find("#mainMenu").hide(),sviewFrameDiv.find("#bottomMenu").addClass("hide"),$("#ring_animationbar").show(),$("#general_animationbar").hide()):"task"===sview.getSceneManagerType()||"maintenance"===sview.getSceneManagerType()||("show"===sview.getSceneManagerType()?(sviewFrameDiv.find("#animation_bar").removeClass("hide"),sviewFrameDiv.find("#animation_bar").show(),sviewFrameDiv.find("#animationbar").css({width:"45px"}),sviewFrameDiv.find(".rotation").hide(),$("#assembly").removeClass(BACKCOLOR[1]),sviewFrameDiv.find("#mainMenu").hide(),sviewFrameDiv.find("#bottomMenu").addClass("hide"),$("#ring_animationbar").show(),$("#general_animationbar").hide()):"general"===sview.getSceneManagerType()&&($("#ring_animationbar").hide(),$("#general_animationbar").show())),InitTree(e),RestoreView()},sview.inputTextNote=function(t){var n=!1,i=!1;$("#inputTextNote").modal("show"),setTimeout(o,200),sviewFrameDiv.find("#confirmTextNote").on("click",function(e){n=!0,0==i&&(t($("#textNote_input").val(),!0),i=!0),$("#textNote_input").val(getLocalizedString(language,"TextNote","InputTextNoteContent")),document.getElementById("textNote_input").style.color="gray"}),sviewFrameDiv.find("#cancleTextNote").on("click",function(e){t($("#textNote_input").val(),!1)}),$("#inputTextNote").one("show.bs.modal",function(){1!=n&&t($("#textNote_input").val(),!1),sviewFrameDiv.find("#confirmTextNote").unbind("click"),sviewFrameDiv.find("#cancleTextNote").unbind("click")}),$("#inputTextNote").one("hide.bs.modal",function(){1!=n&&t($("#textNote_input").val(),!1)})},sview.inputSHotSpot=function(t){var n=!1,i=!1;$("#inputSHotSpot").modal("show"),$("#hotspot_modelview").find("option").remove(),$("#hotspot_modelview").append('<option value="-1" langID=""></option>');var e=sview.view.GetModelViewsList();if(e)for(var o=0;o<e.length;o++)$("#hotspot_modelview").append('<option value="'+e[o].GetID()+'" langID="">'+e[o].GetName()+"</option>");0===sview.animationPlayer._animationTasksWithProcess.length&&sview.animationPlayer.OpenFile();var a=sview.animationPlayer._animationTasksWithProcess;if(a)for(o=0;o<a.length;o++)a[o]instanceof M3D.SAnimationProcess&&$("#hotspot_animation_process").append('<option value="'+a[o].GetId()+'" langID="">'+a[o].GetName()+"</option>");$("#hotspot_animation_process").change(function(){$("#hotspot_animation_step").empty(),$("#hotspot_animation_step").append('<option value="-1"  langID=""></option>');for(var e=0;e<a.length;e++)a[e].GetProcessId()===Number($("#hotspot_animation_process option:selected").val())&&$("#hotspot_animation_step").append('<option value="'+a[e].GetId()+'" langID="">'+a[e].GetName()+"</option>")}),sviewFrameDiv.find("#confirmSHotSpot").on("click",function(e){n=!0,0==i&&(t($("#htospot_name").val(),$("#hotspot_description").val(),null,null,Number($("#hotspot_modelview option:selected").val()),Number($("#hotspot_animation_process option:selected").val()),Number($("#hotspot_animation_step option:selected").val()),!0),i=!0,$("#htospot_name").val(""),$("#hotspot_description").val(""))}),sviewFrameDiv.find("#cancleSHotSpot").on("click",function(e){t($("#htospot_name").val(),$("#hotspot_description").val(),null,null,Number($("#hotspot_modelview option:selected").val()),$("#hotspot_animation_process option:selected").val(),$("#hotspot_animation_step option:selected").val(),!1)}),$("#inputSHotSpot").one("show.bs.modal",function(){1!=n&&t($("#htospot_name").val(),$("#hotspot_description").val(),null,null,Number($("#hotspot_modelview option:selected").val()),$("#hotspot_animation_process option:selected").val(),$("#hotspot_animation_step option:selected").val(),!1),sviewFrameDiv.find("#confirmSHotSpot").unbind("click"),sviewFrameDiv.find("#cancleSHotSpot").unbind("click")}),$("#inputSHotSpot").one("hide.bs.modal",function(){1!=n&&t($("#htospot_name").val(),$("#hotspot_description").val(),null,null,Number($("#hotspot_modelview option:selected").val()),$("#hotspot_animation_process option:selected").val(),$("#hotspot_animation_step option:selected").val(),!1)})},sview.showRightMenuInIos=function(e){sviewFrameDiv.children("#renderCanvas").showContextMenu(e)},sview.CloseRightMenuInIos=function(e){sviewFrameDiv.children("#renderCanvas").CloseContextMenu()},sview.PorpertyMeasureCallBack=function(e){var o,a,s,l,t,n;if($("#measurePorpertyList").hasClass("hide")&&($("#measurePorpertyList").removeClass("hide"),$("#measurePorpertyList").css({position:"absolute",top:10,left:10,height:300,width:250,"z-index":2})),l="#measurePorpertyList",t={},n=navigator.platform,t.win=0==n.indexOf("Win"),t.mac=0==n.indexOf("Mac"),t.x11="X11"==n||0==n.indexOf("Linux"),t.win||t.mac||t.xll?($(l).mousedown(function(e){s=!0,o=e.pageX-$(l).offset().left,a=e.pageY-$(l).offset().top,DragDiv("#measurePorpertyList",e,o,a)}),$(l).mouseup(function(e){s=!1})):($(l).resize(function(e){var t=$(window).width()-$(l).width(),n=$(l);n.css({left:t,top:0})}),document.getElementById("measurePorpertyList").addEventListener("touchstart",function(e){e.preventDefault(),s=!0,o=e.touches[0].clientX-$(l).offset().left,a=e.touches[0].clientY-$(l).offset().top},!1),document.getElementById("measurePorpertyList").addEventListener("touchmove",function(e){if(e.preventDefault(),s){var t=e.touches[0].clientX-o,n=e.touches[0].clientY-a;if(t>=$(window).width()-$(l).width()&&(t=$(window).width()-$(l).width()),n>=$(window).height()-$(l).height()&&(n=$(window).height()-$(l).height()),"none"!=$(sview_anima_step_panel).css("display")&&(parseInt($(sview_anima_step_panel).css("top")),parseInt($(sview_anima_step_panel).css("left")),parseInt($(sview_anima_step_panel).width()),parseInt($(sview_anima_step_panel).height()),parseInt($(l).css("top")),parseInt($(l).css("left")),parseInt($(l).width()),parseInt($(l).height())),t<0&&(t=0),n<0&&(n=0),s){var i=$(l);i.css({left:t,top:n})}}},!1),document.getElementById("measurePorpertyList").addEventListener("touchend",function(e){e.preventDefault(),s=!1},!1)),0<e.length){for(var i=e.split(";;"),r="",d="",c=0;c<i.length;c++){var p=i[c].split("::");"Name"!==p[0]&&"Color"!==p[0]&&"SubmodelsCount"!==p[0]&&"InstanceCount"!==p[0]&&"ModleViewCount"!==p[0]&&"PMICount"!==p[0]&&"LOD0PatchCount"!==p[0]&&"Volume"!==p[0]&&"Area"!==p[0]&&"Point"!==p[0]&&"Line"!==p[0]&&"CircleCenter"!==p[0]&&"CircleRadius"!==p[0]&&"CircleArcLength"!==p[0]||(p[0]=getLocalizedString(language,"Property",p[0])),"id"===p[0].toLowerCase()?d="<li><p>"+p[0]+"："+p[1]+"</p></li>":r+="<li><p>"+p[0]+"："+p[1]+"</p></li>"}d="<ul>"+d+r+"</ul>",$("#measurePorpertyList").html(d)}},sview.DoubleTouchListener=function(e){},sview.ShowLicenceStateInfoListener=ShowLicenceStateInfoListener,sview.SHotSpotDescribeListener=function(e){null!=e&&null!=e&&""!=e?(setStepInfo(e,"",""),sview_anima_step_panel_lite.show()):sview_anima_step_toggle_btn.is(":visible")||sview_anima_step_panel_lite.hide()},sview.pmiOptions.usePMI=option.usePMI,sview.pmiOptions.pmiServer=option.pmiServer,ContextMenu(m,a),initToobarClick(option),setTree(sviewFrameDiv),(fileInput=document.createElement("input")).type="file",fileInput.multiple=!0,sviewFrameDiv.find("#section_plane").addClass(BACKCOLOR[0]),sviewFrameDiv.find("#section_cappingPlane").addClass(BACKCOLOR[0]),sviewFrameDiv.find("#showEdgeLine").addClass(BACKCOLOR[0]),IsShowClipHelppingPlane(),IsShowCappingPlane();return fileInput.addEventListener("change",function(e){"OK"!==sview.OpenFile(fileInput.files)&&alert(getLocalizedString(language,"OpenErorr","SelectBin"))}),-1==sviewList.indexOf(sview)&&(sviewList.push(sview),frameDivList.push(sviewFrameDiv)),initAnimatioTools(),animate(),sview.SetSViewBaseUrl(sviewBaseUrl),sview}function ClearSubmit(e){if(13==e.keyCode)return!1}function DragDiv(i,e,o,a){var t=e||window.event,s=(t.clientX,$(i).offset().left,t.clientY,$(i).offset().right,!0);$(document).mousemove(function(e){if(s){var t=event.clientX-o,n=event.clientY-a;if(t>=$(window).width()-$(i).width()&&(t=$(window).width()-$(i).width()),n>=$(window).height()-$(i).height()&&(n=$(window).height()-$(i).height()),"none"!=$(sview_anima_step_panel).css("display"))parseInt($(sview_anima_step_panel).css("top")),parseInt($(sview_anima_step_panel).css("left")),parseInt($(sview_anima_step_panel).width()),parseInt($(sview_anima_step_panel).height()),parseInt($(i).css("top")),parseInt($(i).css("left")),parseInt($(i).width()),parseInt($(i).height());t<0&&(t=0),n<0&&(n=0),$(i).css({left:t,top:n})}}).mouseup(function(){s=!1})}function getLocalizedString(e,t,n){var i=e[t][n];return null==i&&alert("not found this lanaguage resource"),i}function CreateInfoWindow(e,t,n){$("#infoModal").remove();var i=[' <div class="modal fade" id="infoModal" role="dialog" aria-hidden="true">','<div class="modal-dialog">','<div class="modal-content">','<div class="modal-header modal-header-about">','<button type="button" class="close" data-dismiss="modal" aria-hidden="true">',"&times;","</button>",'<h4 class="modal-title" id="myModalLabel" align="center">',t,"</h4>","</div>","<div class='modal-body' align='center' style='background-color: #f9f9f9;'>",n,"</div>",'<div class="modal-footer modal-footer-about">',"<div class='center-block'>"," <button type='button' class='btn btn-default' data-dismiss='modal'>"+getLocalizedString(language,"common","close")+"</button>","</div>","</div>","</div>","</div>","</div>"].join("\n");sviewFrameDiv.append(i),$("#infoModal").modal("show"),$("#closeInfoModal").click(void(document.getElementById("settingModal").style.overflowY="auto"))}function Get_Animation_Option(e){var t=M3D.CookieHelper.GetCookie("sview_"+e.substring(1));$(e);if(null!=t&&""!=t)0!=$(e)[0].childElementCount?$(e).val(t):$(e).attr("checked",t);else{if(0!=$(e)[0].childElementCount)t=$(e+" option:selected").val();else t=$(e).is(":checked");$(htmlelement).find("option:selected");M3D.CookieHelper.AddCookie("sview_"+e.substring(1),t,30)}return"true"==t&&(t=!0),"false"==t&&(t=!1),t}function InitAnimaStepTree(stepTreeNodes){var zTreeObj,onClick=onClick1,setting={view:{showLine:!1,showIcon:!1,selectedMulti:!1,dblClickExpand:!0},data:{simpleData:{enable:!0}},callback:{beforeClick:anzTreeBeforeClick,onClick:onClick1}},zNodes=eval("["+stepTreeNodes+"]");zTreeObj=$.fn.zTree.init($("#stepPanelTree"),setting,zNodes);var nodes=zTreeObj.getNodes(),old_stepId,old_processId;0<nodes.length&&(zTreeObj.selectNode(nodes[0].children[0]),setStepInfo(nodes[0].name,nodes[0].children[0].name,nodes[0].children[0].step_info)),AnimationPlayListener.selectStep=function(e,t){if(old_stepId!=e||old_processId!=t){old_processId=t,old_stepId=e;var n=$.fn.zTree.getZTreeObj("stepPanelTree"),i=n.getNodeByParam("id","stepId_"+e,n.getNodeByParam("id","processId_"+t));n.selectNode(i),setStepInfo(i.getParentNode().name,i.name,i.step_info)}}}function anzTreeBeforeClick(e,t,n){return!t.isParent}function onClick1(e,t,n){$(".ani-pause").html("<img src='"+sviewBaseUrl+"Platform/Ctrls/SView/sview/css/images/button_pause.png' alt='暂停' title='"+getLocalizedString(language,"AnimationMenuTitle","pause")+"'>"),option.animationStatus=!0,PlayStepAnim(n.steps_id)}function openfile(){fileInput.click()}function closefile(){sview.CloseFile()}function ShowLicenceStateInfoListener(e,t){var n=$("#sview_license_info_panel_lit"),i=$("#sview_license_info_panel_lit_info");i.html(getLocalizedString(language,"License",e)),i.append("<p>"+t+"</p>"),n.show(),n.fadeOut(3e3)}function GetVolume(){var e=sview.GetSelector().GetAll()[0];e.GetVolumeAndArea(),alert(e.modelExtInfo.volume)}function GetArea(){var e=sview.GetSelector().GetAll()[0];e.GetVolumeAndArea(),alert(e.modelExtInfo.area)}function showFPS(){$("#FPSShow").html("FPS:"+sview.GetFPS())}function InitTree(topModel){void 0===topModel.GetName()&&topModel.SetName(sview.GetCurFileName());var modeljson=new SView.JSONAssembly(topModel),jsonstring=JSON.stringify(modeljson),zNodes=eval("("+jsonstring+")");sviewFrameDiv.find("#assebmlyTreeDiv").html("<ul id='"+assemblyTreeId+"'class='ztree' style='margin:0px;padding:0px'></ul>"),$.fn.zTree.init($("#"+assemblyTreeId),setting,zNodes);var selectorListener=new SView.SViewSelctorListener;selectorListener.onSelected=function(e,t){var n=$.fn.zTree.getZTreeObj(assemblyTreeId),i=n.getNodeByParam("id",t.GetID());if(M3D.Parameters.Instance().IsMulSelect?n.selectNode(i,!0):n.selectNode(i,!1),console.log(t.Name),!$("#measurePorpertyList").hasClass("hide")){var o=t.GetProperties();null!=o&&0<o.length&&sview.MeasurePropertyStr(o)}},selectorListener.OnModelSelected=function(e,t){},selectorListener.onClearSelected=function(e){$("#testPro").css("display","none");for(var t=$.fn.zTree.getZTreeObj(assemblyTreeId),n=t.getSelectedNodes(),i=0;i<n.length;i++)isAssemlyOpen||t.cancelSelectedNode(n[i]);if(!$("#measurePorpertyList").hasClass("hide")){var o=sview.view.GetSceneManager().GetModel();if(null!=o){var a=o.GetProperties();null!=a&&0<a.length&&sview.MeasurePropertyStr(a)}}},selectorListener.onUnSelected=function(e,t){$("#testPro").css("display","none");var n=$.fn.zTree.getZTreeObj(assemblyTreeId),i=n.getNodeByParam("id",t.GetID());n.cancelSelectedNode(i)},sview.AddSelectListener(selectorListener)}
function RestoreView(){sviewFrameDiv.find("#mainMenu").hasClass(BACKCOLOR[1])&&$("#note_bar").is(":hidden")&&$("#gesture_bar").is(":hidden")&&$("#measure_bar").is(":hidden")&&sviewFrameDiv.find("#bottomMenu").removeClass("hide"),sviewFrameDiv.find("#section_bar_type").hasClass("show")&&sviewFrameDiv.find("#section_bar_type").removeClass("show"),sviewFrameDiv.find("#explose_bar").addClass("hide"),sview.ClearExplosive(),sviewFrameDiv.find("#explosive_per").val(0),sview.view.GetSceneManager().GetSceneBox().Clear(),SetExplosivePersentage(0),sviewFrameDiv.find("#explose_bar_third_type").hasClass("show")&&sviewFrameDiv.find("#explose_bar_third_type").removeClass("show"),sviewFrameDiv.find("#section_bar").addClass("hide"),$(IsShowTransparent).hasClass(BACKCOLOR[0])&&($(IsShowTransparent).removeClass(BACKCOLOR[0]),sview.ShowTransparent());var e=$.fn.zTree.getZTreeObj(assemblyTreeId),s=e.getSelectedNodes(),i=e.getNodes(),a=e.transformToArray(i);if(0<a.length){for(var r=0;r<a.length;r++)a[r].checked=a[r].orcChecked,e.updateNode(a[r]);e.refresh()}isAssemlyOpen&&e.selectNode(s[0],!0),sview.RestoreView()}
function ContextMenu(e,d){var p=$("#"+e);p.children("#renderCanvas").contextmenu({target:"#context-menu",before:function(e){if(!sview.singleClickFlag)return!1;if("none"!==$(".rightbar").css("display")&&$("#measure_bar").hasClass("hide")&&$("#note_bar").hasClass("hide")){sview.isShowRightMenu(!0);var t=this.getMenu(),n=$(t).find(".dropdown-menu");return n.html(""),sview.IsUseModelContextMenu()?(n.append("<li><a tabindex='0' style='font-weight:bold' langID='RightMenu.RightMenu_Hide'><span>&nbsp&nbsp</span>"+getLocalizedString(language,"RightMenu","RightMenu_Hide")+"</a></li>"),n.append("<li><a tabindex='1' style='font-weight:bold' langID='RightMenu.RightMenu_Single_display'><span>&nbsp&nbsp</span>"+getLocalizedString(language,"RightMenu","RightMenu_Single_display")+"</a></li>"),n.append("<li><a tabindex='7' style='font-weight:bold' langID='RightMenu.RightMenu_SetColor'><span>&nbsp&nbsp</span>"+getLocalizedString(language,"RightMenu","RightMenu_SetColor")+"</a></li>"),n.append("<li><a tabindex='8' style='font-weight:bold' langID='RightMenu.RightMenu_ResetSelect'><span>&nbsp&nbsp</span>"+getLocalizedString(language,"RightMenu","RightMenu_ResetSelect")+"</a></li>"),n.append(" <li role='separator' class='divider'></li>"),n.append("<li><a tabindex='2' style='font-weight:bold' langID='RightMenu.RightMenu_Centered_display'><span>&nbsp&nbsp</span>"+getLocalizedString(language,"RightMenu","RightMenu_Centered_display")+"</a></li>"),n.append(" <li role='separator' class='divider'></li>"),n.append("<li><a tabindex='4' style='font-weight:bold' langID='RightMenu.RightMenu_About'><span>&nbsp&nbsp</span>"+getLocalizedString(language,"RightMenu","RightMenu_About")+"</a></li>")):(n.append("<li><a tabindex='0' style='font-weight:bold' langID='RightMenu.RightMenu_Explicit_exchange'><span>&nbsp&nbsp</span>"+getLocalizedString(language,"RightMenu","RightMenu_Explicit_exchange")+"</a></li>"),n.append("<li><a tabindex='1' style='font-weight:bold' langID='RightMenu.RightMenu_Show_all'><span>&nbsp&nbsp</span>"+getLocalizedString(language,"RightMenu","RightMenu_Show_all")+"</a></li>"),n.append(" <li role='separator' class='divider'></li>"),p.find("#note_bar").hasClass("hide")&&p.find("#measure_bar").hasClass("hide")&&p.find("#section_bar").hasClass("hide")&&p.find("#explose_bar").hasClass("hide")&&(n.append("<li><a tabindex='2' style='font-weight:bold' langID='RightMenu.RightMenu_Move'><span>&nbsp&nbsp</span>"+getLocalizedString(language,"RightMenu","RightMenu_Move")+"</a></li>"),n.append(" <li role='separator' class='divider'></li>")),n.append("<li><a tabindex='3' style='font-weight:bold' langID='RightMenu.RightMenu_Centered_display'><span>&nbsp&nbsp</span>"+getLocalizedString(language,"RightMenu","RightMenu_Centered_display")+"</a></li>"),n.append(" <li role='separator' class='divider'></li>"),n.append("<li><a tabindex='8' style='font-weight:bold' langID='RightMenu.RightMenu_Setting'><span>&nbsp&nbsp</span>"+getLocalizedString(language,"RightMenu","RightMenu_Setting")+"</a></li>"),n.append(" <li role='separator' class='divider'></li>"),n.append("<li><a tabindex='5' style='font-weight:bold' langID='RightMenu.RightMenu_About'><span>&nbsp&nbsp</span>"+getLocalizedString(language,"RightMenu","RightMenu_About")+"</a></li>")),!0}return e.preventDefault(),!1},onItem:function(e,t){var n=$(t.target).attr("tabindex");if(sview.IsUseModelContextMenu())if("0"===n){for(var i=d.view.GetSelector().GetAll(),a=0;a<i.length;a++){var l=i[a].GetID(),o=$.fn.zTree.getZTreeObj(assemblyTreeId);(s=o.getNodeByParam("id",l)).checked=!1,o.updateNode(s,!0),o.refresh()}d.HideCurrent()}else if("1"===n)$(t.target).click(function(){var e=$.fn.zTree.getZTreeObj(assemblyTreeId),t=e.getNodes(),n=e.transformToArray(t);if(0<n.length){for(var i=0;i<n.length;i++)n[i].checked=!1,e.updateNode(n[i],!0);e.refresh()}var a=d.view.GetSelector().GetAll();for(i=0;i<a.length;i++){var l=a[i].GetID(),o=$.fn.zTree.getZTreeObj(assemblyTreeId);(t=o.getNodeByParam("id",l)).checked=!0,o.updateNode(t,!0),M3D.Parameters.Instance().IsMulSelect?o.selectNode(t,!0):o.selectNode(t,!1)}d.OnlyDisplayCurrent()}());else if("2"===n)d.DisplayInCenter();else if("3"===n)d.ContinuousRotation(),option.isOpenCrot?option.isOpenCrot=!1:option.isOpenCrot=!0;else if("4"===n)$(t.target).click(void showAboutModal());else if("5"===n)$(t.target).click(void $("#setColorModal").modal("toggle"));else if("6"===n){if(!(sview.view.GetTouchHandler()instanceof M3D.WalkthroughHandler))return CreateInfoWindow(t,getLocalizedString(language,"Alert","Alert_Prompt"),getLocalizedString(language,"Alert","Alert_Context")),!0;option.isOpenJoystick?(DestoryJoystick(),$("#walking_joystick").prop("checked",!1),option.isOpenJoystick=!1):(CreateJoystick(),$("#walking_joystick").prop("checked",!0),option.isOpenJoystick=!0)}else"7"===n?($("#selectColor").modal("toggle"),$("#pickone").colpick({flat:!0,layout:"hex",submit:1,onSubmit:function(e,t,n,i){SetModelColor(n.r,n.g,n.b)}})):"8"===n&&RestoreSelectedModel();else if("0"===n){d.ExchangeHidden();var s=(r=$.fn.zTree.getZTreeObj(assemblyTreeId)).getNodes();if(0<(g=r.transformToArray(s)).length){for(a=0;a<g.length;a++)g[a].checked=!g[a].checked,r.updateNode(g[a]);r.refresh()}}else if("1"===n){d.DisplayAll();var r,g;s=(r=$.fn.zTree.getZTreeObj(assemblyTreeId)).getNodes();if(0<(g=r.transformToArray(s)).length){for(a=0;a<g.length;a++)g[a].checked=!0,r.updateNode(g[a],!0);r.refresh()}}else if("2"===n)0==sview.view.GetUsingTouchHandlerType()&&($("#walking_touch_handler").prop("checked",!1),$("#walking_joystick").prop("checked",!1),DestoryJoystick()),sview.SetUsingTouchHandlerType(3),p.find("#dagger_bar").show(),p.find(".dface").addClass(BACKCOLOR[0]),p.find("#bottomMenu").addClass("hide"),p.find(".pull-right").hide(),p.find(".rotation").hide();else if("3"===n)d.DisplayInCenter();else if("4"===n)d.ContinuousRotation(),option.isOpenCrot?option.isOpenCrot=!1:option.isOpenCrot=!0;else if("5"===n)$(t.target).click(void showAboutModal());else if("6"===n)$(t.target).click(void $("#setColorModal").modal("toggle"));else if("7"===n){if(!(sview.view.GetTouchHandler()instanceof M3D.WalkthroughHandler))return CreateInfoWindow(t,"<b langID='Alert.Alert_Prompt'>"+getLocalizedString(language,"Alert","Alert_Prompt")+"</b>","<b langID='Alert.Alert_Context'>"+getLocalizedString(language,"Alert","Alert_Context")+"</b>"),!0;option.isOpenJoystick?(DestoryJoystick(),$("#walking_joystick").prop("checked",!1),option.isOpenJoystick=!1):(CreateJoystick(),$("#walking_joystick").prop("checked",!0),option.isOpenJoystick=!0)}else"8"===n?$(t.target).click(void $("#settingModal").modal("toggle")):"9"===n&&$(t.target).click(("en"==M3D.CookieHelper.GetCookie("languageType")?$("#createMaterial").find(".modal-dialog").addClass("modal-lg"):$("#createMaterial").find(".modal-dialog").removeClass("modal-lg"),void $("#createMaterial").modal("toggle")))}})}function showAboutModal(){sview.GetLicenseInfo(function(e){$("#product").html(M3D.PRODUCTNAME+" v"+M3D.PRODUCTVERSION),"2"===e.GetLicenseType()[2]?($("#timeEndText").hide(),$("#endTime").html(getLocalizedString(language,"about","about_license_endtime"))):$("#endTime").html(e.GetEndDate()),$("#customer").html(e.GetCustomer()),$("#customerEmail").html(e.GetCustomerEmail()),$("#licenseID").html("NO."+e.GetID()),$("#modules").html(e.GetModules()),$("#creator").html(e.GetCreator()),$("#createDate").html(e.GetCreateDate()),$("#aboutModal").modal("toggle")})}
function setAnimation(){}var AnimationPlayListener=function(){this.selectStep=function(){}};function AnimationStateUpdate(e,t,i){}function initAnimatioTools(){sview_anima_step_panel=$("#sview_anima_step_panel"),sview_anima_step_panel_lite=$("#sview_anima_step_panel_lit"),sview_anima_step_toggle_btn=$("#hideBtnDiv");var e=$("#hideBtn");ani_step_lit=$("#sview_anima_step_panel_lit"),ani_step_all=$("#sview_anima_step_panel_all");$("#stepZtreePanel");var n,a,s,o="#sview_anima_step_panel_lit",t={},i=navigator.platform;t.win=0==i.indexOf("Win"),t.mac=0==i.indexOf("Mac"),t.x11="X11"==i||0==i.indexOf("Linux"),t.win||t.mac||t.xll?($(o).mousedown(function(e){s=!0,n=e.pageX-$(o).offset().left,a=e.pageY-$(o).offset().top,DragDiv("#sview_anima_step_panel_lit",e,n,a)}),$(o).mouseup(function(e){s=!1})):($(o).resize(function(e){var t=$(window).width()-$(o).width();$(o).css({left:t,top:0})}),document.getElementById("sview_anima_step_panel_lit").addEventListener("touchstart",function(e){e.preventDefault(),s=!0,n=e.touches[0].clientX-$(o).offset().left,a=e.touches[0].clientY-$(o).offset().top},!1),document.getElementById("sview_anima_step_panel_lit").addEventListener("touchmove",function(e){if(e.preventDefault(),s){var t=e.touches[0].clientX-n,i=e.touches[0].clientY-a;if(t>=$(window).width()-$(o).width()&&(t=$(window).width()-$(o).width()),i>=$(window).height()-$(o).height()&&(i=$(window).height()-$(o).height()),"none"!=$(sview_anima_step_panel).css("display"))parseInt($(sview_anima_step_panel).css("top")),parseInt($(sview_anima_step_panel).css("left")),parseInt($(sview_anima_step_panel).width()),parseInt($(sview_anima_step_panel).height()),parseInt($(o).css("top")),parseInt($(o).css("left")),parseInt($(o).width()),parseInt($(o).height());if(t<0&&(t=0),i<0&&(i=0),s)$(o).css({left:t,top:i})}},!1),document.getElementById("sview_anima_step_panel_lit").addEventListener("touchend",function(e){e.preventDefault(),s=!1},!1)),e.click(function(e){sview_anima_step_panel.toggle(),"none"==sview_anima_step_panel.css("display")?$("#hideBtnDiv img").attr("src",sviewBaseUrl+"Platform/Ctrls/SView/sview/css/images/sview_ani_anilist_open.png"):$("#hideBtnDiv img").attr("src",sviewBaseUrl+"Platform/Ctrls/SView/sview/css/images/sview_ani_anilist_close.png"),e.stopPropagation()})}var now,delta,fps1=40,then=Date.now(),interval=1e3/fps1;function animate(){if(M3D.Parameters.Instance().IsShowFPS&&showFPS(),requestAnimationFrame(animate),now=Date.now(),interval<(delta=now-then)){then=now-delta%interval;for(var e=0;e<sviewList.length;e++)sviewList[e].Draw(),AnimationStateUpdate(sviewList[e],frameDivList[e],options[e])}}function setStepInfo(i,n,a){$(function(){var e=$("#sview_anima_step_panel_lit_title"),t=$("#sview_anima_step_panel_lit_stepName");e.text(i),t.html("<p>"+n+"</p><p>"+a+"</p>")})}function AnimationStart(){sview.AnimationOpenFile(),sview.AnimationPlay()}function AnimationStop(){sview.exitAnimation()}function SetAnimationStatus(){option.animationStatus?($(".ani-pause").html("<img src='"+sviewBaseUrl+"Platform/Ctrls/SView/sview/css/images/button_ani.png' alt='开始' title='"+getLocalizedString(language,"AnimationMenuTitle","start")+"'>"),option.animationStatus=!1):($(".ani-pause").html("<img src='"+sviewBaseUrl+"Platform/Ctrls/SView/sview/css/images/button_pause.png' alt='暂停' title='"+getLocalizedString(language,"AnimationMenuTitle","pause")+"'>"),option.animationStatus=!0)}function PlayStepAnim(e){sview.animationPlayer.Play(e)}var steps_id=0;function setAni(e){for(var t=" ",i=0;i<e.length;i++){var n="";e[i].GetChildProcessList()&&(n=setAni(e[i].GetChildProcessList()));for(var a=e[i].GetStepList(),s=0;s<a.length;s++)2===a[s].GetType()?null!=n?n+='{ name:"'+a[s].GetName()+'",id:"processId_'+a[s].GetId()+'"},':n='{ name:"'+a[s].GetName()+'",id:"processId_'+a[s].GetId()+'" },':null!=n?n+='{ name:"'+a[s].GetName()+'",id:"stepId_'+a[s].GetId()+'",steps_id:"'+steps_id+'",step_info:"'+a[s].GetStepInfo()+'" },':n='{ name:"'+a[s].GetName()+'",id:"step_'+a[s].GetId()+'",steps_id:"'+steps_id+'",step_info:"'+a[s].GetStepInfo()+'" },',++steps_id;null!=t?t+='{name:"'+e[i].GetName()+'",id:"processId_'+e[i].GetId()+'",open:true,children:['+n+"]},":t='{name:"'+e[i].GetName()+'",id:"processId_'+e[i].GetId()+'",open:true,children:['+n+"]},"}return t}function setAniPercentage(){var e=sviewFrameDiv.find("#ani_percentage")[0].value;$("#ani_percentage").css("background-size","0% 100%"),0<=e&&e<=1&&sview.animationPlayer.SetPercent(100*e)}function setPlanePosition(){var e=sviewFrameDiv.find("#section_percentage")[0].value;0<=e&&e<=1&&SetClipValue(e)}
function settingAbout(){function o(){var e,o,t,i,r,l,a,n,c,d,u,s,m,k,C,p,g;e=M3D.CookieHelper.GetCookie("rotate"),o=M3D.CookieHelper.GetCookie("mergeface"),t=M3D.CookieHelper.GetCookie("watermark"),i=M3D.CookieHelper.GetCookie("watermarktext"),r=M3D.CookieHelper.GetCookie("catia"),l=M3D.CookieHelper.GetCookie("highPerformance"),a=M3D.CookieHelper.GetCookie("lod"),n=M3D.CookieHelper.GetCookie("pim"),c=M3D.CookieHelper.GetCookie("roamAutomatic"),d=M3D.CookieHelper.GetCookie("loopPlayback"),u=M3D.CookieHelper.GetCookie("removeSmallThing"),s=M3D.CookieHelper.GetCookie("removeSmallSize"),m=M3D.CookieHelper.GetCookie("measureUnit"),k=M3D.CookieHelper.GetCookie("languageType"),C=M3D.CookieHelper.GetCookie("selectType"),p=M3D.CookieHelper.GetCookie("selectedColor"),g=M3D.CookieHelper.GetCookie("upDirection"),observeMode=M3D.CookieHelper.GetCookie("observeMode");var v=document.getElementById("rotateswitch"),_=document.getElementById("mergefaceswitch"),D=document.getElementById("watermarkswitch"),f=document.getElementById("catiaswitch"),h=document.getElementById("highLightswitch"),M=document.getElementById("lodswitch"),S=document.getElementById("pimswitch"),y=document.getElementById("autoWalk"),x=document.getElementById("aniLoop"),H=(y=document.getElementById("autoWalk"),x=document.getElementById("aniLoop"),document.getElementById("removeSmallThing"),document.getElementById("removeSmallSize"),document.getElementById("measureUnit"),document.getElementById("upDirectionSet"),document.getElementById("observeSet"),document.getElementById("languageSet"),document.getElementById("selectType"),document.getElementById("selectedColor"));if(p){var w=p.split(" ");H.style.background="rgb("+String(255*parseFloat(w[0]))+","+String(255*parseFloat(w[1]))+","+String(255*parseFloat(w[2]))+")"}else H.style.background="rgb("+String(255)+","+String(0)+","+String(0)+")";C?$("#selectType").val(C):$("#selectType").val("1"),k?$("#languageSet").val(k):$("#languageSet").val("cn"),u?$("#removeSmallThing").val(u):$("#removeSmallThing").val("screen"),s?$("#removeSmallSize").val(s):$("#removeSmallSize").val("10"),m?$("#measureUnit ").val(m):$("#measureUnit ").val("1"),g?$("#upDirectionSet").val(g):$("#upDirectionSet").val(2),observeMode?$("#observeSet").val(observeMode):$("#observeSet").val(1),1==e&&"undefined"!=e?v&&(v.checked=!0):v&&(v.checked=!1),1==o&&"undefined"!=o||null==o?_&&(_.checked=!0):_&&(_.checked=!1),1==t&&"undefined"!=t?D&&(D.checked=!0,"undefined"!=i&&null!=i?($("#waterMark_input").val(i),sview.SetBackgroundWaterMark(i)):($("#waterMark_input").val(M3D.Parameters.Instance().waterMarkStr),sview.SetBackgroundWaterMark(M3D.Parameters.Instance().waterMarkStr))):D&&(D.checked=!1),1==r&&"undefined"!=r?f&&(f.checked=!0):f&&(f.checked=!1),1==l&&"undefined"!=l?h&&(h.checked=!0):h&&(h.checked=!1),1==a&&"undefined"!=a?M&&(M.checked=!0):M&&(M.checked=!1),1==n&&"undefined"!=n?S&&(S.checked=!0):S&&(S.checked=!1),y.checked=1==c||null==c,x.checked=1==d||null==d}$(document).ready(function(){$("#rotateswitch").on("click",function(){e()});var e=function(){var e=!0;e=$("#rotateswitch").is(":checked")?(M3D.CookieHelper.DeleteCookie("rotate"),M3D.CookieHelper.AddCookie("rotate","1","30"),!0):(M3D.CookieHelper.DeleteCookie("rotate"),M3D.CookieHelper.AddCookie("rotate","0","30"),!1),sview.view.SetConRotate(e)}}),$(document).ready(function(){$("#fpsswitch").on("click",function(){e()});var e=function(){var e=!0;$("#fpsswitch").is(":checked")?e=!0:(e=!1,$("#FPSShow").html("")),sview.SetParameter("IsShowFPS",e)}}),$(document).ready(function(){$("#catiaswitch").on("click",function(){e()});var e=function(){var e=!0;e=$("#catiaswitch").is(":checked")?(M3D.CookieHelper.DeleteCookie("catia"),M3D.CookieHelper.AddCookie("catia","1","30"),!0):(M3D.CookieHelper.DeleteCookie("catia"),M3D.CookieHelper.AddCookie("catia","0","30"),!1),sview.view.SetCatia(e)}}),$(document).ready(function(){$("#highLightswitch").on("click",function(){e()});var e=function(){var e=!0;e=$("#highLightswitch").is(":checked")?(M3D.CookieHelper.DeleteCookie("highPerformance"),M3D.CookieHelper.AddCookie("highPerformance","1","30"),!0):(M3D.CookieHelper.DeleteCookie("highPerformance"),M3D.CookieHelper.AddCookie("highPerformance","0","30"),!1),sview.view.SetHighPerformance(e)}}),$(document).ready(function(){$("#lodswitch").on("click",function(){e()});var e=function(){var e=!0;e=$("#lodswitch").is(":checked")?(M3D.CookieHelper.DeleteCookie("lod"),M3D.CookieHelper.AddCookie("lod","1","30"),!0):(M3D.CookieHelper.DeleteCookie("lod"),M3D.CookieHelper.AddCookie("lod","0","30"),!1),sview.view.SetUseLOD(e)}}),$(document).ready(function(){$("#pimswitch").on("click",function(){e()});var e=function(){var e=!0;e=$("#pimswitch").is(":checked")?(M3D.CookieHelper.DeleteCookie("pim"),M3D.CookieHelper.AddCookie("pim","1","30"),!0):(M3D.CookieHelper.DeleteCookie("pim"),M3D.CookieHelper.AddCookie("pim","0","30"),!1),sview.view.SetUsePMI(e)}}),$(document).ready(function(){$("#autoWalk").on("click",function(){e()});var e=function(e){var o=!0;o=$("#autoWalk").is(":checked")||1==e?(M3D.CookieHelper.DeleteCookie("roamAutomatic"),M3D.CookieHelper.AddCookie("roamAutomatic","1","30"),!0):(M3D.CookieHelper.DeleteCookie("roamAutomatic"),M3D.CookieHelper.AddCookie("roamAutomatic","0","30"),!1),sview.view.SetRoamAutomatic(o)}}),$(document).ready(function(){$("#aniLoop").on("click",function(){e()});var e=function(e){$("#aniLoop").is(":checked")||1==e?(M3D.CookieHelper.DeleteCookie("loopPlayback"),M3D.CookieHelper.AddCookie("loopPlayback","1","30")):(M3D.CookieHelper.DeleteCookie("loopPlayback"),M3D.CookieHelper.AddCookie("loopPlayback","0","30"))}}),$(document).ready(function(){o()}),$(document).ready(function(){$("input").bind("input",function(){"range"==$(this).attr("type")&&$(this).css("background-size",String(100*Number(this.value))+"% 100%")}),$("input").bind("change",function(){"range"==$(this).attr("type")&&$(this).css("background-size",String(100*Number(this.value))+"% 100%")})}),$(document).ready(function(){$("#playbackSpeed").on("change",function(){e()});var e=function(e){var o=document.getElementById("playbackSpeed").selectedIndex;0==o||"0.5"==e?(M3D.CookieHelper.DeleteCookie("playbackSpeed"),M3D.CookieHelper.AddCookie("playbackSpeed","0.5x","30")):1==o||"1"==e?(M3D.CookieHelper.DeleteCookie("playbackSpeed"),M3D.CookieHelper.AddCookie("playbackSpeed","1x","30")):2==o||"2"==e?(M3D.CookieHelper.DeleteCookie("playbackSpeed"),M3D.CookieHelper.AddCookie("playbackSpeed","2x","30")):3==o||"3"==e?(M3D.CookieHelper.DeleteCookie("playbackSpeed"),M3D.CookieHelper.AddCookie("playbackSpeed","4x","30")):(M3D.CookieHelper.DeleteCookie("playbackSpeed"),M3D.CookieHelper.AddCookie("playbackSpeed","8x","30"))}}),$(document).ready(function(){$("#selectedColor").on("click",function(){e()});var e=function(){$("#settingModal").modal("hide"),$("#edgeSelectColor").modal("toggle"),$("#picktwo").colpick({flat:!0,layout:"hex",submit:1,onSubmit:function(e,o,t,i){var r,l;r=t,l=new M3D.Color(r.r/255,r.g/255,r.b/255),M3D.CookieHelper.AddCookie(M3D.EDGECOLOR,l.Tostring(),30),sview.view.SetEdgeSelector(l),M3D.Color.selectColor=l,$("#edgeSelectColor").modal("hide"),document.getElementById("selectedColor").style.background="rgb("+r.r+","+r.g+","+r.b+")"}})}}),$(document).ready(function(){$("#removeSmallThing").on("change",function(){e()});var e=function(){var e=document.getElementById("removeSmallThing").selectedIndex;0==e?(M3D.CookieHelper.DeleteCookie("removeSmallThing"),M3D.CookieHelper.AddCookie("removeSmallThing","model","30")):(M3D.CookieHelper.DeleteCookie("removeSmallThing"),M3D.CookieHelper.AddCookie("removeSmallThing","screen","30")),sview.view.SetRemoveSmallThing(e)}}),$(document).ready(function(){$("#selectType").on("change",function(){e()});var e=function(){var e=document.getElementById("selectType").selectedIndex;0==e?(M3D.CookieHelper.DeleteCookie("selectType"),M3D.CookieHelper.AddCookie("selectType","1","30")):(M3D.CookieHelper.DeleteCookie("selectType"),M3D.CookieHelper.AddCookie("selectType","2","30")),sview.setSelectType(e+1)}}),$(document).ready(function(){$("#removeSmallSize").on("change",function(){e()});var e=function(){var e=document.getElementById("removeSmallSize").selectedIndex,o=0;0==e?(M3D.CookieHelper.DeleteCookie("removeSmallSize"),M3D.CookieHelper.AddCookie("removeSmallSize","0","30"),o=0):1==e?(M3D.CookieHelper.DeleteCookie("removeSmallSize"),M3D.CookieHelper.AddCookie("removeSmallSize","2","30"),o=2):2==e?(M3D.CookieHelper.DeleteCookie("removeSmallSize"),M3D.CookieHelper.AddCookie("removeSmallSize","4","30"),o=4):3==e?(M3D.CookieHelper.DeleteCookie("removeSmallSize"),M3D.CookieHelper.AddCookie("removeSmallSize","6","30"),o=6):4==e?(M3D.CookieHelper.DeleteCookie("removeSmallSize"),M3D.CookieHelper.AddCookie("removeSmallSize","8","30"),o=8):5==e?(M3D.CookieHelper.DeleteCookie("removeSmallSize"),M3D.CookieHelper.AddCookie("removeSmallSize","10","30"),o=10):6==e?(M3D.CookieHelper.DeleteCookie("removeSmallSize"),M3D.CookieHelper.AddCookie("removeSmallSize","12","30"),o=12):7==e?(M3D.CookieHelper.DeleteCookie("removeSmallSize"),M3D.CookieHelper.AddCookie("removeSmallSize","14","30"),o=14):8==e?(M3D.CookieHelper.DeleteCookie("removeSmallSize"),M3D.CookieHelper.AddCookie("removeSmallSize","16","30"),o=16):9==e?(M3D.CookieHelper.DeleteCookie("removeSmallSize"),M3D.CookieHelper.AddCookie("removeSmallSize","18","30"),o=18):10==e?(M3D.CookieHelper.DeleteCookie("removeSmallSize"),M3D.CookieHelper.AddCookie("removeSmallSize","20","30"),o=20):11==e?(M3D.CookieHelper.DeleteCookie("removeSmallSize"),M3D.CookieHelper.AddCookie("removeSmallSize","30","30"),o=30):12==e?(M3D.CookieHelper.DeleteCookie("removeSmallSize"),M3D.CookieHelper.AddCookie("removeSmallSize","40","30"),o=40):13==e&&(M3D.CookieHelper.DeleteCookie("removeSmallSize"),M3D.CookieHelper.AddCookie("removeSmallSize","50","30"),o=50),sview.view.SetRemoveSmallSize(o)}}),$(document).ready(function(){$("#measureUnit").on("change",function(){e()});var e=function(){var e=document.getElementById("measureUnit").selectedIndex;0==e?(M3D.CookieHelper.DeleteCookie("measureUnit"),M3D.CookieHelper.AddCookie("measureUnit","0","30")):1==e?(M3D.CookieHelper.DeleteCookie("measureUnit"),M3D.CookieHelper.AddCookie("measureUnit","1","30")):2==e?(M3D.CookieHelper.DeleteCookie("measureUnit"),M3D.CookieHelper.AddCookie("measureUnit","2","30")):3==e?(M3D.CookieHelper.DeleteCookie("measureUnit"),M3D.CookieHelper.AddCookie("measureUnit","3","30")):4==e?(M3D.CookieHelper.DeleteCookie("measureUnit"),M3D.CookieHelper.AddCookie("measureUnit","4","30")):5==e&&(M3D.CookieHelper.DeleteCookie("measureUnit"),M3D.CookieHelper.AddCookie("measureUnit","5","30")),sview.view.SetMeasureUnit(e)}}),$(document).ready(function(){$("#upDirectionSet").on("change",function(){e()});var e=function(){var e=document.getElementById("upDirectionSet").selectedIndex;0==e?(M3D.CookieHelper.DeleteCookie("upDirection"),M3D.CookieHelper.AddCookie("upDirection","0","30"),document.getElementById("walking_updirection")[0].selected=!0):1==e?(M3D.CookieHelper.DeleteCookie("upDirection"),M3D.CookieHelper.AddCookie("upDirection","1","30"),document.getElementById("walking_updirection")[1].selected=!0):2==e?(M3D.CookieHelper.DeleteCookie("upDirection"),M3D.CookieHelper.AddCookie("upDirection","2","30"),document.getElementById("walking_updirection")[2].selected=!0):3==e?(M3D.CookieHelper.DeleteCookie("upDirection"),M3D.CookieHelper.AddCookie("upDirection","3","30"),document.getElementById("walking_updirection")[3].selected=!0):4==e?(M3D.CookieHelper.DeleteCookie("upDirection"),M3D.CookieHelper.AddCookie("upDirection","4","30"),document.getElementById("walking_updirection")[4].selected=!0):5==e&&(M3D.CookieHelper.DeleteCookie("upDirection"),M3D.CookieHelper.AddCookie("upDirection","5","30"),document.getElementById("walking_updirection")[5].selected=!0),sview.SetUpdirection(e)}}),$(document).ready(function(){$("#observeSet").on("change",function(){e()});var e=function(){var e=document.getElementById("observeSet").selectedIndex;0==e?(M3D.CookieHelper.DeleteCookie("observeMode"),M3D.CookieHelper.AddCookie("observeMode","0","30"),document.getElementById("ObserveSelect")[0].selected=!0):1==e?(M3D.CookieHelper.DeleteCookie("observeMode"),M3D.CookieHelper.AddCookie("observeMode","1","30"),document.getElementById("ObserveSelect")[1].selected=!0):2==e&&(M3D.CookieHelper.DeleteCookie("observeMode"),M3D.CookieHelper.AddCookie("observeMode","2","30"),document.getElementById("ObserveSelect")[2].selected=!0),sview.SetObserveMode(e,!0)}}),$(document).ready(function(){var e,o,t,i,r,l;o=M3D.CookieHelper.GetCookie("removeSmallThing"),e=M3D.CookieHelper.GetCookie("removeSmallSize"),t=M3D.CookieHelper.GetCookie("measureUnit"),r=M3D.CookieHelper.GetCookie("upDirection"),l=M3D.CookieHelper.GetCookie("observeMode"),i=M3D.CookieHelper.GetCookie("playbackSpeed");var a=document.getElementById("removeSmallThing"),n=document.getElementById("removeSmallSize"),c=document.getElementById("measureUnit"),d=document.getElementById("upDirectionSet"),u=document.getElementById("observeSet"),s=document.getElementById("playbackSpeed");"0.5x"==i&&"undefined"!=i?s[0].selected=!0:"1x"==i&&"undefined"!=i?s[1].selected=!0:"2x"==i&&"undefined"!=i?s[2].selected=!0:"4x"==i&&"undefined"!=i?s[3].selected=!0:"8x"==i&&"undefined"!=i&&(s[4].selected=!0),"model"==o?a[0].selected=!0:"screen"==o&&"undefined"!=o&&(a[1].selected=!0),"0"==e?n[0].selected=!0:"2"==e&&"undefined"!=e?n[1].selected=!0:"4"==e&&"undefined"!=e?n[2].selected=!0:"6"==e&&"undefined"!=e?n[3].selected=!0:"8"==e&&"undefined"!=e?n[4].selected=!0:"10"==e&&"undefined"!=e?n[5].selected=!0:"12"==e&&"undefined"!=e?n[6].selected=!0:"14"==e&&"undefined"!=e?n[7].selected=!0:"16"==e&&"undefined"!=e?n[8].selected=!0:"18"==e&&"undefined"!=e?n[9].selected=!0:"20"==e&&"undefined"!=e?n[10].selected=!0:"30"==e&&"undefined"!=e?n[11].selected=!0:"40"==e&&"undefined"!=e?n[12].selected=!0:"50"==e&&"undefined"!=e&&(n[13].selected=!0),"0"==t?c[0].selected=!0:"1"==t&&"undefined"!=t?c[1].selected=!0:"2"==t&&"undefined"!=t?c[2].selected=!0:"3"==t&&"undefined"!=t?c[3].selected=!0:"4"==t&&"undefined"!=t?c[4].selected=!0:"5"==t&&"undefined"!=t&&(c[5].selected=!0),"0"==r?(d[0].selected=!0,document.getElementById("walking_updirection")[0].selected=!0):"1"==r&&"undefined"!=r?(d[1].selected=!0,document.getElementById("walking_updirection")[1].selected=!0):"2"==r&&"undefined"!=r?(d[2].selected=!0,document.getElementById("walking_updirection")[2].selected=!0):"3"==r&&"undefined"!=r?(d[3].selected=!0,document.getElementById("walking_updirection")[3].selected=!0):"4"==r&&"undefined"!=r?(d[4].selected=!0,document.getElementById("walking_updirection")[4].selected=!0):"5"==r&&"undefined"!=r&&(d[5].selected=!0,document.getElementById("walking_updirection")[5].selected=!0),"0"==l?(u[0].selected=!0,document.getElementById("ObserveSelect")[0].selected=!0):"1"==l&&"undefined"!=l?(u[1].selected=!0,document.getElementById("ObserveSelect").selected=!0):"2"==l&&"undefined"!=l&&(u[2].selected=!0,document.getElementById("ObserveSelect").selected=!0)}),$(document).ready(function(){$("#settingBack").on("click",function(){e()});var e=function(){$("#settingModal").modal("hide"),$("#setColorModal").modal("toggle")}}),$(document).ready(function(){$("#settingWaterMark").on("click",function(){e()});var e=function(){$("#settingModal").modal("hide"),$("#setWaterMarkModal").modal("toggle"),sview.GetWaterMarkText()&&$("#waterMark_input").val(sview.GetWaterMarkText())};$("#confirmWaterMark").on("click",function(e){$("#waterMark_input").val();$("#waterMark_input").val()?(sview.SetBackgroundWaterMark($("#waterMark_input").val()),M3D.CookieHelper.DeleteCookie("watermarktext"),M3D.CookieHelper.AddCookie("watermarktext",$("#waterMark_input").val(),"30"),M3D.CookieHelper.DeleteCookie("watermark"),M3D.CookieHelper.AddCookie("watermark","1","30"),document.getElementById("watermarkswitch").checked=!0):(sview.SetBackgroundWaterMark(null),M3D.CookieHelper.DeleteCookie("watermarktext"),M3D.CookieHelper.DeleteCookie("watermark"),M3D.CookieHelper.AddCookie("watermark","0","30"),document.getElementById("watermarkswitch").checked=!1)})}),$(document).ready(function(){$("#clearCache").on("click",function(){e(),sview.view.setCookie()});var e=function(){M3D.CookieHelper.DeleteCookie("rotate"),M3D.CookieHelper.DeleteCookie("mergeface"),M3D.CookieHelper.DeleteCookie("catia"),M3D.CookieHelper.DeleteCookie("highPerformance"),M3D.CookieHelper.DeleteCookie("lod"),M3D.CookieHelper.DeleteCookie("pim"),M3D.CookieHelper.DeleteCookie("removeSmallThing"),M3D.CookieHelper.DeleteCookie("removeSmallSize"),M3D.CookieHelper.DeleteCookie("measureUnit"),M3D.CookieHelper.DeleteCookie("roamAutomatic"),M3D.CookieHelper.DeleteCookie("loopPlayback"),M3D.CookieHelper.DeleteCookie("bottomColorKey"),M3D.CookieHelper.DeleteCookie("topColorKey"),M3D.CookieHelper.DeleteCookie("languageType"),M3D.CookieHelper.DeleteCookie("selectType"),M3D.CookieHelper.DeleteCookie("selectedColor"),o(),$("#settingModal").modal("hide"),$("#sucessClear").modal("show")}}),$(document).ready(function(){$("#userFeedback").on("click",function(){e()});var e=function(){$("#settingModal").modal("hide"),$("#feedback").modal("show")}}),$(document).ready(function(){$("#languageSet").on("change",function(e){!function(e){var o=document.getElementById("languageSet").selectedIndex;0==o?(M3D.CookieHelper.DeleteCookie("languageType"),M3D.CookieHelper.AddCookie("languageType","cn","30")):1==o&&(M3D.CookieHelper.DeleteCookie("languageType"),M3D.CookieHelper.AddCookie("languageType","en","30"));CreateInfoWindow(e,getLocalizedString(language,"Alert","Alert_Prompt"),getLocalizedString(language,"Alert","Alert_Reload"))}(e)})}),$(document).ready(function(){$("#mergefaceswitch").on("click",function(e){!function(e){var o=!0;o=$("#mergefaceswitch").is(":checked")?(M3D.CookieHelper.DeleteCookie("mergeface"),M3D.CookieHelper.AddCookie("mergeface","1","30"),!0):(M3D.CookieHelper.DeleteCookie("mergeface"),M3D.CookieHelper.AddCookie("mergeface","0","30"),!1);CreateInfoWindow(e,getLocalizedString(language,"Alert","Alert_Prompt"),o?getLocalizedString(language,"Alert","Alert_OpenMergeFace"):getLocalizedString(language,"Alert","Alert_CloseMergeFace"))}(e)})}),$(document).ready(function(){$("#watermarkswitch").on("click",function(e){!function(e){var o=!0;if($("#watermarkswitch").is(":checked")){M3D.CookieHelper.DeleteCookie("watermark"),M3D.CookieHelper.AddCookie("watermark","1","30");var t=M3D.CookieHelper.GetCookie("watermarktext");"undefined"!=t&&null!=t?($("#waterMark_input").val(t),sview.SetBackgroundWaterMark(t)):($("#waterMark_input").val(M3D.Parameters.Instance().waterMarkStr),sview.SetBackgroundWaterMark(M3D.Parameters.Instance().waterMarkStr)),o=!0}else M3D.CookieHelper.DeleteCookie("watermark"),M3D.CookieHelper.AddCookie("watermark","0","30"),o=!1,$("#waterMark_input").val("");sview.view.SetWaterMark(o)}()})}),$(document).ready(function(){$("#material_type_sel").on("change",function(){switch($(this).children("option:selected").attr("id")){case"phong_option":$(".material_attr").addClass("hide"),$(".phong_attr").removeClass("hide");break;case"pbr_option":$(".material_attr").addClass("hide"),$(".pbr_attr").removeClass("hide");break;case"matcap_option":$(".material_attr").addClass("hide"),$(".matcap_attr").removeClass("hide")}$("#difusseColor").css("background","rgb(231,231,231)"),$("#difusseColor_text").val("231,231,231"),$("#specularColor").css("background","rgb(73,73,73)"),$("#specularColor_text").val("73,73,73"),$("#brightness").val("30"),$("#transparency-span").html("1"),e.slider("setValue",1),$("#metallic-luster-span").html("0.04"),t.slider("setValue",.04),$("#roughness-span").html("0.5"),i.slider("setValue",.5),$("#is_remove_cover").removeAttr("checked"),$("#remove-cover-span").html("0.9"),a.slider("setValue",.9),$("#clear-rough-overlays-span").html("0.04"),n.slider("setValue",.04),$("#ambientColor").css("background","rgb(231,231,231)"),$("#ambientColor_text").val("231,231,231"),$("#emissiveColor").css("background","rgb(231,231,231)"),$("#emissiveColor_text").val("231,231,231"),$("#texture_coordinate_rotation").val("0"),$("#texture_coor_scaling_u").val("1"),$("#texture_coor_scaling_v").val("1"),$("#texture_coor_rollover_u").val("0"),$("#texture_coor_rollover_v").val("0"),$(".texture_img").addClass("hide"),$("#normal_texture_scaling_x").val("1"),$("#normal_texture_scaling_y").val("1")})});var r=0,l="",e="",t="",i="",a="",n="",c='<div class="col-sm-6 col-md-4 item"><div class="thumbnail"><img class="texture_img" style="width: 100px;height: 70px"/><div class="caption"><p class="texture_img_des"></p></div></div></div>';function d(){$("#texture_modal_items .item").unbind("mouseover mouseout click"),$("#texture_modal_confirm").unbind("click"),$("#texture_modal_items .item").bind("mouseover mouseout",function(e){"mouseover"==e.type?$(this).hasClass("item_check")||$(this).find(".thumbnail").css("background-color","#f1f5fa").css("cursor","pointer"):"mouseout"==e.type&&($(this).hasClass("item_check")||$(this).find(".thumbnail").css("background-color","#fff").css("cursor","auto"))}),$("#texture_modal_items .item").bind("click",function(e){$("#texture_modal_items .item").removeClass("item_check"),$("#texture_modal_items .item").find(".thumbnail").css("border","1px solid #ddd").css("background-color","#fff"),$(this).find(".thumbnail").css("border","1px solid #32dcfa").css("background-color","#f1f5fa"),$(this).addClass("item_check")}),$("#texture_modal_confirm").bind("click",function(){var e=$("#texture_modal_items").find(".item_check");if(0<e.length){var o=e.eq(0).find(".texture_img").attr("src");switch(r){case 1:$("#rough_metal_texture_img").attr("src",o).removeClass("hide");break;case 2:$("#diffuse_texture_img").attr("src",o).removeClass("hide");break;case 3:$("#specular_texture_img").attr("src",o).removeClass("hide");break;case 4:$("#radiation_texture_img").attr("src",o).removeClass("hide");break;case 5:$("#material_capture_texture_img").attr("src",o).removeClass("hide");break;case 6:$("#nomal_texture_img").attr("src",o).removeClass("hide")}}$("#texture_modal").modal("hide")})}function u(){$("#edgeSelectColor").modal("toggle"),$("#picktwo").colpick({flat:!0,layout:"hex",submit:1,onSubmit:function(e,o,t,i){!function(e){$("#edgeSelectColor").modal("hide"),document.getElementById(l).style.background="rgb("+e.r+","+e.g+","+e.b+")";var o=document.getElementById(l+"_text");$(o).val(e.r+","+e.g+","+e.b)}(t)}})}$(document).ready(function(){$("#diffuse_texture_btn").on("click",function(){var t,i;$("#texture_modal").modal("show"),i=$("#texture_modal_items"),$.ajax({url:"./Platform/Ctrls/SView/sview/css/images/texture/texture.json",type:"get",dataType:"json",success:function(e){i.html(""),$.each(e.list,function(e,o){(t=$(c)).find(".texture_img").attr("src",o.url),t.find(".texture_img_des").html(o.name),i.append(t)}),d()}}),r=2})}),$(document).ready(function(){$("#rough_metal_texture_btn").on("click",function(){var t,i;$("#texture_modal").modal("show"),i=$("#texture_modal_items"),$.ajax({url:"./Platform/Ctrls/SView/sview/css/images/texture/texture.json",type:"get",dataType:"json",success:function(e){i.html(""),$.each(e.list,function(e,o){(t=$(c)).find(".texture_img").attr("src",o.url),t.find(".texture_img_des").html(o.name),i.append(t)}),d()}}),r=1})}),$(document).ready(function(){$("#specular_texture_btn").on("click",function(){var t,i;$("#texture_modal").modal("show"),i=$("#texture_modal_items"),$.ajax({url:"./Platform/Ctrls/SView/sview/css/images/texture/texture.json",type:"get",dataType:"json",success:function(e){i.html(""),$.each(e.list,function(e,o){(t=$(c)).find(".texture_img").attr("src",o.url),t.find(".texture_img_des").html(o.name),i.append(t)}),d()}}),r=3})}),$(document).ready(function(){$("#radiation_texture_btn").on("click",function(){var t,i;$("#texture_modal").modal("show"),i=$("#texture_modal_items"),$.ajax({url:"./Platform/Ctrls/SView/sview/css/images/texture/texture.json",type:"get",dataType:"json",success:function(e){i.html(""),$.each(e.list,function(e,o){(t=$(c)).find(".texture_img").attr("src",o.url),t.find(".texture_img_des").html(o.name),i.append(t)}),d()}}),r=4})}),$(document).ready(function(){$("#material_capture_texture_btn").on("click",function(){var t,i;$("#texture_modal").modal("show"),i=$("#texture_modal_items"),$.ajax({url:"./Platform/Ctrls/SView/sview/css/images/texture/texture.json",type:"get",dataType:"json",success:function(e){i.html(""),$.each(e.list,function(e,o){(t=$(c)).find(".texture_img").attr("src",o.url),t.find(".texture_img_des").html(o.name),i.append(t)}),d()}}),r=5})}),$(document).ready(function(){$("#nomal_texture_btn").on("click",function(){var t,i;$("#texture_modal").modal("show"),i=$("#texture_modal_items"),$.ajax({url:"./Platform/Ctrls/SView/sview/css/images/texture/texture.json",type:"get",dataType:"json",success:function(e){i.html(""),$.each(e.list,function(e,o){(t=$(c)).find(".texture_img").attr("src",o.url),t.find(".texture_img_des").html(o.name),i.append(t)}),d()}}),r=6})}),$(document).ready(function(){(e=$("#transparency-slider").slider({min:0,max:1,step:.01,precision:2,value:1,tooltip:"hide"})).on("change",function(e){$("#transparency-span").html(e.value.newValue)}),(t=$("#metallic-luster-slider").slider({min:0,max:1,step:.01,precision:2,value:.04,tooltip:"hide"})).on("change",function(e){$("#metallic-luster-span").html(e.value.newValue)}),(i=$("#roughness-slider").slider({min:0,max:1,step:.01,precision:2,value:.5,tooltip:"hide"})).on("change",function(e){$("#roughness-span").html(e.value.newValue)}),(a=$("#remove-cover-slider").slider({min:0,max:1,step:.01,precision:2,value:.9,tooltip:"hide"})).on("change",function(e){$("#remove-cover-span").html(e.value.newValue)}),(n=$("#clear-rough-overlays-slider").slider({min:0,max:1,step:.01,precision:2,value:.04,tooltip:"hide"})).on("change",function(e){$("#clear-rough-overlays-span").html(e.value.newValue)})}),$(document).ready(function(){$("#difusseColor").on("click",function(){l="difusseColor",u()}),$("#specularColor").on("click",function(){l="specularColor",u()}),$("#ambientColor").on("click",function(){l="ambientColor",u()}),$("#emissiveColor").on("click",function(){l="emissiveColor",u()})}),$(document).ready(function(){$("#createMaterial_confirm").click(function(){var e={},o=$("#material_type_sel").val(),t=$("#material_name").val(),i=$("#difusseColor_text").val(),r=$("#transparency-span").html(),l="",a="",n="";switch($("#nomal_texture_img").hasClass("hide")||(l=$("#nomal_texture_img").attr("src"),a=$("#normal_texture_scaling_x").val(),n=$("#normal_texture_scaling_y").val()),o){case"1":var c=$("#specularColor_text").val(),d=$("#brightness").val(),u=$("#ambientColor_text").val(),s=$("#emissiveColor_text").val(),m=$("#texture_coordinate_rotation").val(),k=$("#texture_coor_scaling_u").val(),C=$("#texture_coor_scaling_v").val(),p=$("#texture_coor_rollover_u").val(),g=$("#texture_coor_rollover_v").val(),v="",_="",D="";$("#diffuse_texture_img").hasClass("hide")||(v=$("#diffuse_texture_img").attr("src")),$("#specular_texture_img").hasClass("hide")||(_=$("#specular_texture_img").attr("src")),$("#radiation_texture_img").hasClass("hide")||(D=$("#radiation_texture_img").attr("src")),e.specular_color=c,e.brightness=d,e.ambient_color=u,e.emissive_color=s,e.texture_coordinate_rotation=m,e.texture_coor_scaling_u=k,e.texture_coor_scaling_v=C,e.texture_coor_rollover_u=p,e.texture_coor_rollover_v=g,e.diffuse_texture_img=v,e.specular_texture_img=_,e.radiation_texture_img=D;break;case"2":var f=$("#metallic-luster-span").html(),h=$("#roughness-span").html(),M=$("#is_remove_cover").is(":checked"),S=$("#remove-cover-span").html(),y=$("#clear-rough-overlays-span").html(),x=(m=$("#texture_coordinate_rotation").val(),k=$("#texture_coor_scaling_u").val(),C=$("#texture_coor_scaling_v").val(),p=$("#texture_coor_rollover_u").val(),g=$("#texture_coor_rollover_v").val(),v="","");$("#diffuse_texture_img").hasClass("hide")||(v=$("#diffuse_texture_img").attr("src")),$("#rough_metal_texture_img").hasClass("hide")||(x=$("#rough_metal_texture_img").attr("src")),e.metallic_luster=f,e.roughness=h,e.is_remove_cover=M,e.remove_cover=S,e.clear_rough_overlays=y,e.texture_coordinate_rotation=m,e.texture_coor_scaling_u=k,e.texture_coor_scaling_v=C,e.texture_coor_rollover_u=p,e.texture_coor_rollover_v=g,e.diffuse_texture_img=v,e.rough_metal_texture_img=x;break;case"4":var H="";$("#material_capture_texture_img").hasClass("hide")||(H=$("#material_capture_texture_img").attr("src")),e.material_capture_texture_img=H}e.material_type=o,e.material_name=t,e.difusse_color=i,e.transparency=r,e.nomal_texture_img=l,e.normal_texture_scaling_x=a,e.normal_texture_scaling_y=n,console.log(e),sview.createMaterial(e),$("#createMaterial").modal("hide")})})}
function setTree(sviewFrameDiv){sviewFrameDiv.find("#top_assembly").click(function(){$("#assebmlyTreeDiv").toggle(),$("#top_viewDiv").hide()}),sviewFrameDiv.find("#top_view").click(function(){var viewTreeObj;$("#assebmlyTreeDiv").hide(),$("#top_viewDiv").toggle(),console.log(sview.view.GetModelViewsList());var modleViewList=sview.view.GetModelViewsList(),modle=sview.view.GetModel(),zTreeObj;modle.SetModleViewList(modleViewList),console.log(sview.view.GetModel());var setting={view:{showLine:!1,showIcon:!1,selectedMulti:!1,dblClickExpand:!1},data:{simpleData:{enable:!0}},callback:{onClick:view_tree_click}};function SetViewTree(modleViewList){for(var tempNode="",name,i=0;i<modleViewList.length;i++)tempNode=tempNode+'{name:"'+modleViewList[i].GetName()+'",view_id:'+modleViewList[i].GetID()+"},";var zNodes=eval("["+tempNode+"]");viewTreeObj=$.fn.zTree.init($("#sview_view_tree"),setting,zNodes)}function view_tree_click(e,i,t){sview.view.CloseSceneAnimation();var l=sview.view.GetModel().GetModleView(t.view_id);sview.view.SetCurrentModelView(l),sview.view.startLinkAni=!0,sview.view.ShowModelView(t.view_id,!0,!0),console.log($(this))}$("#top_viewDiv").show(),SetViewTree(modleViewList),$(function(){$("#addModleView,#removeModelView,#updateView").unbind("click"),$("#addModleView").click(function(){sview.view.AddModelView(),SetViewTree(sview.view.GetModelViewsList()),viewTreeObj.refresh(),console.log(viewTreeObj.getNodes())}),$("#removeModelView").click(function(){var e=$.fn.zTree.getZTreeObj("sview_view_tree").getSelectedNodes();if(!(e.length<1)){var i=e[0].view_id;sview.view.RemoveModelView(i),SetViewTree(sview.view.GetModelViewsList()),viewTreeObj.refresh(),console.log(viewTreeObj.getNodes())}}),$("#updateView").click(function(){console.log(sview.CreatModleViewByXMlStr(sview.GetXMLStrByMV(sview.view.GetModelViewsList()[3])))})})}),$(document).bind("contextmenu",function(e){return!1}),$("body").bind("mousedown",function(e){"rMenu"==e.target.id||0<$(e.target).parents("#rMenu").length||$("#rMenu").hide()})}function onCheck(e,i,t,l){var n=sview.GetShpae(t.id);null!=n&&n.SetVisible(t.checked)}function onClick(e,i,t,l){M3D.Parameters.Instance().IsMulSelect||sview.view.GetSelector().Clear();var n=sview.GetShpae(t.id);null!=n&&sview.view.GetSelector().Add(n)}function onRightClick(e,i,t){var l=$.fn.zTree.getZTreeObj(assemblyTreeId);l.cancelSelectedNode(),l.selectNode(t),sview.view.GetSelector().Clear();var n=sview.GetShpae(t.id);null!=n&&sview.view.GetSelector().Add(n),showRMenu(e.clientX,e.clientY)}function beforeRename(e,i,t){var l=!1;return 0<t.length&&(l=!0),l}function onRename(e,i,t,l){var n=sview.GetShpae(t.id);sview.AssemblyRename(n,t.name)}function beforeRemove(e,i){var t=!1,l=sview.GetShpae(i.id),n=sview.view.GetSceneManager().GetModel();return confirm(getLocalizedString(language,"Assembly","ConfirmDelete")+'"'+i.name+'"?')&&(l.GetID()!=n.GetID()?t=!0:(alert(getLocalizedString(language,"Assembly","TopNote_CannotDel")),CreateInfoWindow(null,getLocalizedString(language,"Alert","Alert_Prompt"),getLocalizedString(language,"Assembly","TopNote_CannotDel")))),t}function onRemove(e,i,t){var l=sview.GetShpae(t.id);null!==l&&sview.AssemblyDelete(l)}function showRMenu(e,i){var t=$("#assebmlyTreeDiv").width();t<(e=Number(e)+Number(7))+42&&(e=t-42),$("#rMenu ul").show(),$("#rMenu").css({top:i+"px",left:e+"px",display:"block"})}function hideRMenu(){$("#rMenu").hide()}var isOver=!0,asmFileInput=null;function addAsemble(){if($("#rMenu").hide(),isOver){var e=$.fn.zTree.getZTreeObj(assemblyTreeId).getSelectedNodes();0!=sview.GetShpae(e[0].id).GetSubModelCount()?asmFileInput.click():CreateInfoWindow(null,getLocalizedString(language,"Alert","Alert_Prompt"),getLocalizedString(language,"Assembly","SelectAssembly"))}else CreateInfoWindow(null,getLocalizedString(language,"Alert","Alert_Prompt"),getLocalizedString(language,"Assembly","Assembly_Wait"))}function delAsemble(){$("#rMenu").hide();var e=$.fn.zTree.getZTreeObj(assemblyTreeId),i=e.getSelectedNodes();e.removeNode(i[0],!0)}asmFileInput=document.createElement("input"),asmFileInput.type="file",asmFileInput.id="addAssemblyFile",asmFileInput.accept=".zip, .svp, .svlx, .zsvl",asmFileInput.multiple=!1,asmFileInput.addEventListener("change",function(){if(!(asmFileInput.files.length<1)){var e=asmFileInput.files[0].name.split(".").pop().toLowerCase();if("zsvl"==e||"svlx"==e||"svp"==e||"zip"==e)event.preventDefault(),event.stopPropagation(),isAssemlyOpen=!0,isOver=!1,"OK"!==sview.AssemblyAdd(asmFileInput.files)&&(CreateInfoWindow(null,getLocalizedString(language,"Alert","Alert_Prompt"),getLocalizedString(language,"OpenErorr","SelectBin")),asmFileInput.value="");else CreateInfoWindow(null,getLocalizedString(language,"Alert","Alert_Prompt"),getLocalizedString(language,"Assembly","Assembly_add_file_error")),asmFileInput.value=""}});var ztreeConfig={isCopy:!1,isCut:!1,node:""};function copyAsemble(){$("#rMenu").hide();var e=$.fn.zTree.getZTreeObj(assemblyTreeId).getSelectedNodes(),i=sview.GetShpae(e[0].id),t=sview.view.GetSceneManager().GetModel();i.GetID()!=t.GetID()?(ztreeConfig.isCopy=!0,ztreeConfig.isCut=!1,ztreeConfig.node=e[0]):CreateInfoWindow(null,getLocalizedString(language,"Alert","Alert_Prompt"),getLocalizedString(language,"Assembly","TopAssemblyCannotCopy"))}function cutAsemble(){$("#rMenu").hide();var e=$.fn.zTree.getZTreeObj(assemblyTreeId).getSelectedNodes(),i=sview.GetShpae(e[0].id),t=sview.view.GetSceneManager().GetModel();i.GetID()!=t.GetID()?(ztreeConfig.isCopy=!1,ztreeConfig.isCut=!0,ztreeConfig.node=e[0]):CreateInfoWindow(null,getLocalizedString(language,"Alert","Alert_Prompt"),getLocalizedString(language,"Assembly","TopAssemblyCannotCut"))}function pasteAsemble(){if($("#rMenu").hide(),ztreeConfig.isCopy||ztreeConfig.isCut){var e=$.fn.zTree.getZTreeObj(assemblyTreeId),i=e.getSelectedNodes(),t=sview.GetShpae(ztreeConfig.node.id),l=sview.GetShpae(i[0].id);if(0!=l.GetSubModelCount())if(t.GetID()!=l.GetID())if(isChildModel(t,l,isChild))CreateInfoWindow(null,getLocalizedString(language,"Alert","Alert_Prompt"),getLocalizedString(language,"Assembly","CelectOtherAssembly"));else{if(ztreeConfig.isCopy){sview.AssemblyCopyTo(t,l,null)}if(ztreeConfig.isCut){sview.AssemblyMoveTo(t,l);var n=new SView.JSONAssembly(t);e.addNodes(i[0],n),e.removeNode(ztreeConfig.node,!1),ztreeConfig.isCut=!1,ztreeConfig.node=""}}else CreateInfoWindow(null,getLocalizedString(language,"Alert","Alert_Prompt"),getLocalizedString(language,"Assembly","CelectOtherAssembly"));else CreateInfoWindow(null,getLocalizedString(language,"Alert","Alert_Prompt"),getLocalizedString(language,"Assembly","SelectAssembly"))}else CreateInfoWindow(null,getLocalizedString(language,"Alert","Alert_Prompt"),getLocalizedString(language,"Assembly","CopyCutFirst"))}function renameAsemble(){$("#rMenu").hide();var e=$.fn.zTree.getZTreeObj(assemblyTreeId),i=e.getSelectedNodes();e.editName(i[0])}var isChild=!1;function isChildModel(e,i,t){for(var l=0;l<e.GetSubModels().length;l++)i.GetID()==e.GetSubModels()[l].GetID()?t=!0:0==e.GetSubModels()[l].GetSubModelCount()?i.GetID()==e.GetSubModels()[l].GetID()&&(t=!0):isChildModel(e.GetSubModels()[l],i,t);return t}
function UIManager(){this.rightBarState=!0,this.buttomBarState=!1,this.viewPanelState=!1,this.assemblyPanelState=!1,this.walkThroughBarState=!1,this.propertyPanelState=!1,this.annotationBarState=!1,this.gestureBarState=!1,this.animationBarState=!1,this.animationTreePanelState=!1,this.animationDescriptionPanelState=!1,this.animationToolPanelState=!1,this.measureBarState=!1,this.sectionBarState=!1,this.explosiveBarState=!1,this.moveBarState=!1,this.settingModalState=!1,this.aboutModalState=!1,this.ShowToolbar=function(e,a){"RightBar"===e?this.rightBarState=a?($("#rightMenu").show(),!0):($("#rightMenu").hide(),!1):"BottomBar"===e?this.buttomBarState=a?($("#bottomMenu").removeClass("hide"),!0):($("#bottomMenu").addClass("hide"),!1):"NoteBar"===e?this.annotationBarState=a?($("#note_bar").removeClass("hide"),!0):($("#note_bar").addClass("hide"),!1):"ClipBar"===e?this.sectionBarState=a?($("#section_bar").removeClass("hide"),!0):($("#section_bar").addClass("hide"),!1):"ExplodeBar"===e?this.explosiveBarState=a?($("#explose_bar").removeClass("hide"),!0):($("#explose_bar").addClass("hide"),!1):"MeasureBar"===e?this.measureBarState=a?($("#measure_bar").removeClass("hide"),$("#measureDistance").show(),$("#measureProperty").hide(),$("#measureAngle").hide(),this.changeMeasureType(0),!0):($("#measure_bar").addClass("hide"),$("#measureDistance").hide(),$("#measureProperty").hide(),$("#measureAngle").hide(),!1):"AnimateBar"===e?this.animationBarState=a?($("#animation_bar").removeClass("hide"),$("#animation_bar").show(),!0):($("#animation_bar").addClass("hide"),$("#animation_bar").hide(),!1):"WalkThroughBar"===e&&(this.walkThroughBarState=a?($("#walking").children(".ul-dropmenu").addClass("show"),!0):($("#walking").children(".ul-dropmenu").removeClass("show"),!1))},this.showPanel=function(e,a){"AssemblyPanel"===e?this.assemblyPanelState=a?($(".leftbar").show(),!0):($(".leftbar").hide(),!1):"ViewPanel"===e?this.viewPanelState=a?($("#view").children(".ul-dropmenu").addClass("show"),!0):($("#view").children(".ul-dropmenu").removeClass("show"),!1):"PropertyPanel"===e?this.propertyPanelState=a?(this.ShowModelPropertiyDialog(),!0):($("#measurePorpertyList").addClass("hide"),!1):"AnimationToolsPanel"===e?this.animationToolPanelState=a?($("#setSpeed").addClass("show"),!0):($("#setSpeed").removeClass("show"),!1):"AnimationTreePanel"===e?this.animationTreePanelState=a?($("#sview_anima_step_panel").show(),!0):($("#sview_anima_step_panel").hide(),!1):"AnimationDescribePanel"===e&&(this.animationDescriptionPanelState=a?($("#sview_anima_step_content").show(),!0):($("#sview_anima_step_content").hide(),!1))},this.ShowMsgBox=function(e,a,i){this.CreateInfoWindow(null,a,i)},this.FullScreen=function(e){e?(sview0prewidth=$("#sview0").width(),sview0preheight=$("#sview0").height(),this.fullscreen.request()):this.fullscreen.exit()},this.fullscreen=new MAZEY_FULL_SCREEN,this.CreateInfoWindow=function(e,a,i){$("#infoModal").remove();var t=[' <div class="modal fade" id="infoModal" role="dialog" aria-hidden="true">','<div class="modal-dialog">','<div class="modal-content">','<div class="modal-header modal-header-about">','<button type="button" class="close" data-dismiss="modal" aria-hidden="true">',"&times;","</button>",'<h4 class="modal-title" id="myModalLabel" align="center">',a,"</h4>","</div>","<div class='modal-body' align='center' style='background-color: #f9f9f9;'>",i,"</div>",'<div class="modal-footer modal-footer-about">',"<div class='center-block'>"," <button type='button' class='btn btn-default' data-dismiss='modal'>"+getLocalizedString(language,"common","close")+"</button>","</div>","</div>","</div>","</div>","</div>"].join("\n");sviewFrameDiv.append(t),$("#infoModal").modal("show"),$("#closeInfoModal").click(void(document.getElementById("settingModal").style.overflowY="auto"))},this.ShowModelPropertiyDialog=function(){var e,a=sview.view.GetSceneManager().GetModel();0<(e=sview.view.GetSelector().GetAll()).length&&(a=e[0]);var i=a.GetProperties();null!=i&&0<i.length&&sview.MeasurePropertyStr(i)},this.changeMeasureType=function(e){this.hideMeasureBacrground(0),767<screenWidth?(sviewFrameDiv.find("#measureBar").width(0===e?"415px":"280px"),sviewFrameDiv.find("#commonEdit").width(0===e?"90px":1===e?"90px":"45px")):375<=screenWidth<=767?(sviewFrameDiv.find("#measureBar").width(0===e?"330px":"230px"),sviewFrameDiv.find("#commonEdit").width(0===e?"90px":1===e?"90px":"45px")):screenWidth<=375&&(sviewFrameDiv.find("#measureBar").width(0===e?"310px":"205px"),sviewFrameDiv.find("#commonEdit").width(0===e?"90px":1===e?"90px":"45px")),sviewFrameDiv.find("#measure_bar_third_type").removeClass("show")},this.hideMeasureBacrground=function(e){switch(e){case 1:sviewFrameDiv.find("#measure_PntToPnt").removeClass(BACKCOLOR[1]);break;case 2:sviewFrameDiv.find("#measure_PntToLine").removeClass(BACKCOLOR[1]);break;case 3:sviewFrameDiv.find("#measure_PntToFace").removeClass(BACKCOLOR[1]);break;case 4:sviewFrameDiv.find("#measure_LineToLine").removeClass(BACKCOLOR[1]);break;case 5:sviewFrameDiv.find("#measure_LineToFace").removeClass(BACKCOLOR[1]);break;case 6:sviewFrameDiv.find("#measure_FaceToFace").removeClass(BACKCOLOR[1]);break;case 11:sviewFrameDiv.find("#measure_LineWithLine").removeClass(BACKCOLOR[1]);break;case 12:sviewFrameDiv.find("#measure_LineWithFace").removeClass(BACKCOLOR[1]);break;case 13:sviewFrameDiv.find("#measure_FaceWithFace").removeClass(BACKCOLOR[1]);break;case 21:sviewFrameDiv.find("#measure_Point").removeClass(BACKCOLOR[1]);break;case 22:sviewFrameDiv.find("#measure_Line").removeClass(BACKCOLOR[1]);break;case 23:sviewFrameDiv.find("#measure_Face").removeClass(BACKCOLOR[1]);break;case 24:sviewFrameDiv.find("#measure_Model").removeClass(BACKCOLOR[1])}$("#measurePorpertyList").addClass("hide")}}MAZEY_FULL_SCREEN=function(){var a,i,t,s,n=["RequestFullscreen","RequestFullScreen"],r=["ExitFullscreen","CancelFullScreen"],o=function(i,e,t){var s,n;return e.map(function(e){return i+e}).forEach(function(e){var a;n||(0===i.length&&(e=(a=e).slice(0,1).toLowerCase()+a.slice(1)),e in t&&(s=e,n=!0))}),s};["","webkit","moz","ms"].forEach(function(e){a&&i||(t=o(e,n,document.documentElement),a=Boolean(t),s=o(e,r,document),i=Boolean(s))}),this.request=function(e){(document.querySelector(e)||document.documentElement)[t]()},this.exit=function(){document[s]()},this.isFullScreen=function(){return document.fullscreenElement||document.msFullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||!1}};
//23152 李金岳 解决平台文本无法选中问题，暂将onselectstart = null。Sview新版本发布后再处理。